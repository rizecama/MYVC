<?php

/**

 * @version		1.0.0 camassistant $

 * @package		camassistant

 * @copyright	Copyright Â© 2010 - All rights reserved.

 * @license		GNU/GPL

 * @author		

 * @author mail	nobody@nobody.com

 *

 *

 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com

 */



// no direct access

defined('_JEXEC') or die('Restricted access');

ini_set('upload_max_filesize', '5M');

jimport('joomla.application.component.controller');



class vendorsController extends JController

{

	function __construct()

	{

		parent::__construct();

	}



	function display()

	{

		parent::display();

	}

	function imageupload23()
	{
		$db =& JFactory::getDBO();
		//$Email=$_POST['queryString'];
                $post	= JRequest::get('post');
		$model = $this->getModel('vendors');
                $type	= JRequest::getVar('type');
                $type_id	= JRequest::getVar('type_id');
                $id	= JRequest::getVar('id');
                $user	= JFactory::getUser();
//echo '<pre>'; print_r($_REQUEST); print_r($user); exit;
		$db = JFactory::getDBO();

		$sql = "SELECT tax_id FROM #__cam_vendor_company   WHERE user_id=".$user->id;

		$db->setQuery($sql);

		$tax_id = $db->loadResult();

		$vendorname = $user->name.'_'.$user->lastname.'_'.$tax_id;

		$vendorname = str_replace(' ','_',$vendorname);

              if($type=='OLN'){
       $sql1 = "SELECT OLN_folder_id FROM #__cam_vendor_occupational_license  WHERE OLN_folder_id!=0 and id=".$type_id;
		$time = JRequest::getVar('time','');
			if($time == 'second'){
			$sql1 = "SELECT OLN_folder_id FROM #__cam_vendor_occupational_license  WHERE OLN_folder_id!=0 and OLN_status ='' and vendor_id=".$user->id;
			}
			
		$db->setQuery($sql1);

		$OLN_folder_id = $db->loadResult();

                $sql1 = "SELECT count(id) FROM #__cam_vendor_occupational_license  WHERE vendor_id=".$user->id;

		$db->setQuery($sql1);

		$count_id = $db->loadResult();

           	$OLN_files		= JRequest::getVar('uploadfile','','files','array' );
    //echo '<pre>'; print_r($_FILES); exit;
		//for($i=0; $i<count($post['old_line_task_OLN_ids']); $i++)
	//	{
				$OLN_data['id']				=$type_id;
                                $OLN_data['vendor_id']			= $user->id;
				if($OLN_files['name'] != '')

				{

				//code to update image filed in vendors table

				//code to move image to folderpath

				if($OLN_folder_id){
				$OLN_data['OLN_folder_id'] 		=	$OLN_folder_id;
                                $OLN_No 		=	$OLN_folder_id;
                                } else {
                                $OLN_data['OLN_folder_id'] 		=	$count_id+1;
                                $OLN_No 		=	$count_id+1;
                                }
 //echo '<pre>'; print_r($OLN_No);  exit;

		  		$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS.$vendorname.DS.'OLN_'.$OLN_No.DS;

				// Remove all the files in folder if they exist
				jimport('joomla.client.helper');
				if(is_dir($base_Dir))
					{
						$files = JFolder::files($base_Dir, '.', false, true, array());
						if (!empty($files)) {
								jimport('joomla.filesystem.file');
								if (JFile::delete($files) !== true) {
										// JFile::delete throws an error
										return false;
								}
						}
					}


			    JFolder::create( $base_Dir );

				$OLN_files['name'] = str_replace(" ", "_", $OLN_files['name']);
				$OLN_files['name'] = str_replace("&", "_", $OLN_files['name']);
				$OLN_files['name'] = str_replace("#", "_", $OLN_files['name']);
				$OLN_files['name'] = str_replace("%", "_", $OLN_files['name']);
				$OLN_files['name'] = str_replace(",", "_", $OLN_files['name']);
				$OLN_files['name'] = str_replace("`", "_", $OLN_files['name']);
				$OLN_files['name'] = str_replace("'", "_", $OLN_files['name']);
				$OLN_files['name'] = str_replace("\\", "_", $OLN_files['name']);
				$OLN_files['name'] = str_replace(":", "_", $OLN_files['name']);
				$OLN_files['name'] = str_replace("?", "_", $OLN_files['name']);
				$OLN_files['name'] = str_replace("<", "_", $OLN_files['name']);
				$OLN_files['name'] = str_replace(">", "_", $OLN_files['name']);
				$OLN_files['name'] = str_replace("/", "_", $OLN_files['name']);
				$OLN_files['name'] = str_replace("//", "_", $OLN_files['name']);
				$OLN_files['name'] = ereg_replace("/", "_", $OLN_files['name']);

				$OLN_data['OLN_upld_cert'] 		=	$OLN_files['name'];
                                $folderid= 'OLN_'.$OLN_No ;
                                $filename=$OLN_files['name'];
                                 $ext = end(explode('.', $OLN_files['name']));
				 $filepath = $base_Dir .$OLN_files['name'];

				move_uploaded_file($OLN_files['tmp_name'], $filepath);

				$OLN_arr[$o] = '<a href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&vndr='.$user->id.'&doc=OLN_'.$OLN_No.'&filename='.$OLN_files["name"] .'">'.$OLN_files["name"] .'</a>';

					$o++;

				}
			  $time = JRequest::getVar('time','');
			  $OLN_data['OLN_date_verified']	= '0000-00-00';
			  if($time == 'second'){
			  $update_time = "UPDATE #__cam_vendor_occupational_license SET OLN_upld_cert='".$OLN_files["name"]."', OLN_date_verified='0000-00-00' where OLN_status ='' "; 
			  $db->setQuery($update_time);
			  $updatetime=$db->query();
			  }
			  else{
			  $lastRowId=  $model->store_vendor_OLN_compliances_info($OLN_data);
			  }
			  
              // Send mail to support and vendor when uploads the document
			  	$db =& JFactory::getDBO();
			    $mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
				$msg = "SELECT introtext  FROM #__content where id='267'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
				$db->setQuery($vendor_company);
				$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                $data=  'Bus. Tax Receipt / Occupational License - '.$id.' has been updated by '.$vcompanyv.'. Please verify document and information submitted.';
                $data1=  'Bus. Tax Receipt / Occupational License - '.$id;
				$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('Bus. Tax Receipt / Occupational License - '.$id.'',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
					$listcc = $cclist[$c];
						if($listcc){
							$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
						}
				}
				if( $user->subscribe_type != 'free'){
				$subject = 'A Vendor`s Compliance Document has been updated';
				$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>MyVendorCenter.com';
				$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$msg = str_replace('{DOCUMENT}', 'Bus. Tax Receipt / Occupational License - '.$id.'', $msg);		
				$msg = str_replace('{VENDOR}', $vcompanyv, $msg);
				$to_support = "documents@myvendorcenter.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
				$to_sateesh = "sk4576@gmail.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
				}
			  //Completed



		//}
  }
		//exit;


		if($type=='UMB'){
            $sql1 = "SELECT UMB_folder_id FROM #__cam_vendor_umbrella_license  WHERE UMB_folder_id!=0 and id=".$type_id;
			$time = JRequest::getVar('time','');
			if($time == 'second'){
			$sql1 = "SELECT UMB_folder_id FROM #__cam_vendor_umbrella_license  WHERE UMB_folder_id!=0 and UMB_status ='' and vendor_id=".$user->id;
			}
			

		$db->setQuery($sql1);

		$UMB_folder_id = $db->loadResult();

        $sql1 = "SELECT count(id) FROM #__cam_vendor_umbrella_license  WHERE vendor_id=".$user->id;

		$db->setQuery($sql1);

		$count_id = $db->loadResult();

           	$UMB_files		= JRequest::getVar('uploadfile','','files','array' );
    //echo '<pre>'; print_r($_FILES); exit;
		//for($i=0; $i<count($post['old_line_task_OLN_ids']); $i++)
	//	{
				$UMB_data['id']				=$type_id;
                $UMB_data['vendor_id']			= $user->id;
				if($UMB_files['name'] != '')

				{

				//code to update image filed in vendors table

				//code to move image to folderpath

				if($UMB_folder_id){
				$UMB_data['UMB_folder_id'] 		=	$UMB_folder_id;
                                $UMB_No 		=	$UMB_folder_id;
                                } else {
                                $UMB_data['UMB_folder_id'] 		=	$count_id+1;
                                $UMB_No 		=	$count_id+1;
                                }
 //echo '<pre>'; print_r($OLN_No);  exit;

		  		$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS.$vendorname.DS.'UMB_'.$UMB_No.DS;

				// Remove all the files in folder if they exist
				jimport('joomla.client.helper');
				if(is_dir($base_Dir))
					{
						$files = JFolder::files($base_Dir, '.', false, true, array());
						if (!empty($files)) {
								jimport('joomla.filesystem.file');
								if (JFile::delete($files) !== true) {
										// JFile::delete throws an error
										return false;
								}
						}
					}


			    JFolder::create( $base_Dir );

				$UMB_files['name'] = str_replace(" ", "_", $UMB_files['name']);
				$UMB_files['name'] = str_replace("&", "_", $UMB_files['name']);
				$UMB_files['name'] = str_replace("#", "_", $UMB_files['name']);
				$UMB_files['name'] = str_replace("%", "_", $UMB_files['name']);
				$UMB_files['name'] = str_replace(",", "_", $UMB_files['name']);
				$UMB_files['name'] = str_replace("`", "_", $UMB_files['name']);
				$UMB_files['name'] = str_replace("'", "_", $UMB_files['name']);
				$UMB_files['name'] = str_replace("\\", "_", $UMB_files['name']);
				$UMB_files['name'] = str_replace(":", "_", $UMB_files['name']);
				$UMB_files['name'] = str_replace("?", "_", $UMB_files['name']);
				$UMB_files['name'] = str_replace("<", "_", $UMB_files['name']);
				$UMB_files['name'] = str_replace(">", "_", $UMB_files['name']);
				$UMB_files['name'] = str_replace("/", "_", $UMB_files['name']);
				$UMB_files['name'] = str_replace("//", "_", $UMB_files['name']);
				$UMB_files['name'] = ereg_replace("/", "_", $UMB_files['name']);

				$UMB_data['UMB_upld_cert'] 		=	$UMB_files['name'];
                                $folderid= 'UMB_'.$UMB_No ;
                                $filename=$UMB_files['name'];
                                 $ext = end(explode('.', $UMB_files['name']));
				 $filepath = $base_Dir .$UMB_files['name'];

				move_uploaded_file($UMB_files['tmp_name'], $filepath);

				$UMB_arr[$o] = '<a href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&vndr='.$user->id.'&doc=UMB_'.$UMB_No.'&filename='.$UMB_files["name"] .'">'.$UMB_files["name"] .'</a>';

					$o++;

				}
				$UMB_data['UMB_date_verified']	= '0000-00-00';
 			  $time = JRequest::getVar('time','');
			  if($time == 'second'){
			  $update_time = "UPDATE #__cam_vendor_umbrella_license SET UMB_upld_cert='".$UMB_files["name"]."', UMB_date_verified='0000-00-00' where UMB_status ='' "; 
			  $db->setQuery($update_time);
			  $updatetime=$db->query();
			  }
			  else{
			  $lastRowId=  $model->store_vendor_UMB_compliances_info($UMB_data);
			  }
			  
			  
			  // Send mail to support and vendor when uploads the document
			  	$db =& JFactory::getDBO();
			    $mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
				$msg = "SELECT introtext  FROM #__content where id='267'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
				$db->setQuery($vendor_company);
				$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                $data=  'Umbrella Liability Policy - '.$id.' has been updated by '.$vcompanyv.'. Please verify document and information submitted.';
                $data1= 'Umbrella Liability Policy - '.$id;
				$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('Umbrella Liability Policy - '.$id.'',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
					$listcc = $cclist[$c];
						if($listcc){
							$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
						}
				}
				if( $user->subscribe_type != 'free'){
				$subject = 'A Vendor`s Compliance Document has been updated';
				$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>MyVendorCenter.com';
				$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$msg = str_replace('{DOCUMENT}', 'Umbrella Liability Policy - '.$id.'', $msg);		
				$msg = str_replace('{VENDOR}', $vcompanyv, $msg);
				$to_support = "documents@myvendorcenter.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
				$to_ssateesh = "sk4576@gmail.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_ssateesh, $subject, $msg, $mode=1);
				}
			  //Completed
                              

		//}
  }

		/***************************************************************PLN CODE*********************************************************************/
      if($type=='PLN'){
             $sql1 = "SELECT PLN_folder_id FROM #__cam_vendor_professional_license  WHERE PLN_folder_id!=0 and id=".$type_id;
		$time = JRequest::getVar('time','');
			if($time == 'second'){
			$sql1 = "SELECT PLN_folder_id FROM #__cam_vendor_professional_license  WHERE PLN_folder_id!=0 and PLN_status ='' and vendor_id=".$user->id;
			}
			
		$db->setQuery($sql1);

		$PLN_folder_id = $db->loadResult();

                $sql1 = "SELECT count(id) FROM #__cam_vendor_professional_license  WHERE vendor_id=".$user->id;

		$db->setQuery($sql1);

		$count_id1 = $db->loadResult();

		$PLN_files		= JRequest::getVar('uploadfile','','files','array' );


				$PLN_data['id']				=$type_id;
                              $PLN_data['vendor_id']			= $user->id;


				if($PLN_files['name'] != '')

				{

				if($PLN_folder_id){
				$PLN_data['PLN_folder_id'] 		=	$PLN_folder_id;
                                $PLN_No 		=	$PLN_folder_id;
                                } else {
                                $PLN_data['PLN_folder_id'] 		=	$count_id1+1;
                                $PLN_No 		=	$count_id1+1;
                                }
					$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS.$vendorname.DS.'PLN_'.$PLN_No.DS;

					// Remove all the files in folder if they exist
					jimport('joomla.client.helper');
					if(is_dir($base_Dir))
					{
						$files = JFolder::files($base_Dir, '.', false, true, array());
						if (!empty($files)) {
								jimport('joomla.filesystem.file');
								if (JFile::delete($files) !== true) {
										// JFile::delete throws an error
										return false;
								}
						}
					}
					JFolder::create( $base_Dir );

					$PLN_files['name'] = str_replace(" ", "_", $PLN_files['name']);
					$PLN_files['name'] = str_replace("%", "_", $PLN_files['name']);
					$PLN_files['name'] = str_replace("#", "_", $PLN_files['name']);
					$PLN_files['name'] = str_replace("&", "_", $PLN_files['name']);
					$PLN_files['name'] = str_replace(",", "_", $PLN_files['name']);
					$PLN_files['name'] = str_replace("`", "_", $PLN_files['name']);
					$PLN_files['name'] = str_replace("'", "_", $PLN_files['name']);
					$PLN_files['name'] = str_replace("\\", "_", $PLN_files['name']);
					$PLN_files['name'] = str_replace(":", "_", $PLN_files['name']);
					$PLN_files['name'] = str_replace("?", "_", $PLN_files['name']);
					$PLN_files['name'] = str_replace("<", "_", $PLN_files['name']);
					$PLN_files['name'] = str_replace(">", "_", $PLN_files['name']);
					$PLN_files['name'] = str_replace("/", "_", $PLN_files['name']);
					$PLN_files['name'] = str_replace("//", "_", $PLN_files['name']);
					$PLN_files['name'] = ereg_replace("/", "_", $PLN_files['name']);

					$PLN_data['PLN_upld_cert'] = $PLN_files['name'];
                                $folderid= 'PLN_'.$PLN_No ;
                                $filename=$PLN_files['name'];
                                 $ext = end(explode('.', $PLN_files['name']));
					$filepath = $base_Dir .$PLN_files['name'];

					move_uploaded_file($PLN_files['tmp_name'], $filepath);

					$PLN_arr[$p] = '<a href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&vndr='.$user->id.'&doc=PLN_'.$PLN_No.'&filename='.$PLN_files["name"] .'">'.$PLN_files["name"] .'</a>';

						$p++;

				}
			$PLN_data['PLN_date_verified']  = '0000-00-00';
			$time = JRequest::getVar('time','');
			  if($time == 'second'){
			  $update_time = "UPDATE #__cam_vendor_professional_license SET PLN_upld_cert='".$PLN_files["name"]."', PLN_date_verified='0000-00-00' where PLN_status ='' "; 
			  $db->setQuery($update_time);
			  $updatetime=$db->query();
			  }
			  else{
			  $lastRowId= $model->store_vendor_PLN_compliances_info($PLN_data);
			  }

				
				// Send mail to support and vendor when uploads the document
			  	$db =& JFactory::getDBO();
			    $mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
				$msg = "SELECT introtext  FROM #__content where id='267'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
				$db->setQuery($vendor_company);
				$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                $data=  'Professional License - '.$id.' has been updated by '.$vcompanyv.'. Please verify document and information submitted.';
                $data1= 'Professional License - '.$id;
				$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('Professional License - '.$id.'',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
					$listcc = $cclist[$c];
						if($listcc){
							$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
						}
				}
				if( $user->subscribe_type != 'free'){
				$subject = 'A Vendor`s Compliance Document has been updated';
				$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>MyVendorCenter.com';
				$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$msg = str_replace('{DOCUMENT}', 'Professional License - '.$id.'', $msg);		
				$msg = str_replace('{VENDOR}', $vcompanyv, $msg);
				$to_support = "documents@myvendorcenter.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
				$to_sateesh = "sk4576@gmail.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
				}
			  //Completed
//exit;
      }

		/***************************************************************GLI CODE*********************************************************************/
if($type=='GLI'){
        $sql1 = "SELECT GLI_folder_id FROM #__cam_vendor_liability_insurence  WHERE GLI_folder_id!=0 and id=".$type_id;
		$time = JRequest::getVar('time','');
			if($time == 'second'){
			$sql1 = "SELECT GLI_folder_id FROM #__cam_vendor_liability_insurence  WHERE GLI_folder_id!=0 and GLI_status ='' and vendor_id=".$user->id;
			}
			
		$db->setQuery($sql1);

		$GLI_folder_id = $db->loadResult();

                $sql1 = "SELECT count(id) FROM #__cam_vendor_liability_insurence  WHERE vendor_id=".$user->id;

		$db->setQuery($sql1);

		$count_id1 = $db->loadResult();

		$GLI_files		= JRequest::getVar('uploadfile','','files','array' );
//echo '<pre>'; print_r($post); exit;

			//code to store GLI data
				$GLI_data['id']				=$type_id;
				$GLI_data['vendor_id'] 			=  $user->id;

				if($GLI_files['name'] != '')

				{


				if($GLI_folder_id){
				$GLI_data['GLI_folder_id'] 		=	$GLI_folder_id;
                                $GLI_No 		=	$GLI_folder_id;
                                } else {
                                $GLI_data['GLI_folder_id'] 		=	$count_id1+1;
                                $GLI_No 		=	$count_id1+1;
                                }

		  			$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS.$vendorname.DS.'GLI_'.$GLI_No.DS;

					jimport('joomla.client.helper');
					if(is_dir($base_Dir))
					{
						$files = JFolder::files($base_Dir, '.', false, true, array());
						if (!empty($files)) {
								jimport('joomla.filesystem.file');
								if (JFile::delete($files) !== true) {
										// JFile::delete throws an error
										return false;
								}
						}
					}

			   		JFolder::create( $base_Dir );

					$GLI_files['name'] = str_replace(" ", "_", $GLI_files['name']);
					$GLI_files['name'] = str_replace("%", "_", $GLI_files['name']);
					$GLI_files['name'] = str_replace("#", "_", $GLI_files['name']);
					$GLI_files['name'] = str_replace("&", "_", $GLI_files['name']);
					$GLI_files['name'] = str_replace(",", "_", $GLI_files['name']);
					$GLI_files['name'] = str_replace("`", "_", $GLI_files['name']);
					$GLI_files['name'] = str_replace("'", "_", $GLI_files['name']);
					$GLI_files['name'] = str_replace("\\", "_", $GLI_files['name']);
					$GLI_files['name'] = str_replace(":", "_", $GLI_files['name']);
					$GLI_files['name'] = str_replace("?", "_", $GLI_files['name']);
					$GLI_files['name'] = str_replace("<", "_", $GLI_files['name']);
					$GLI_files['name'] = str_replace(">", "_", $GLI_files['name']);
					$GLI_files['name'] = str_replace("/", "_", $GLI_files['name']);
					$GLI_files['name'] = str_replace("//", "_", $GLI_files['name']);
					$GLI_files['name'] = ereg_replace("/", "_", $GLI_files['name']);

					$GLI_data['GLI_upld_cert'] 			= $GLI_files['name'];
                                $folderid= 'GLI_'.$GLI_No ;
                                $filename=$GLI_files['name'];
                                 $ext = end(explode('.', $GLI_files['name']));
					$filepath = $base_Dir .$GLI_files['name'];

					move_uploaded_file($GLI_files['tmp_name'], $filepath);

					$GLI_arr[$g] = '<a href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&vndr='.$user->id.'&doc=GLI_'.$GLI_No.'&filename='.$GLI_files["name"] .'">'.$GLI_files["name"] .'</a>';

					$g++;

				}


				$time = JRequest::getVar('time','');
				$GLI_data['GLI_date_verified'] = '0000-00-00';
			  if($time == 'second'){
			  $update_time = "UPDATE #__cam_vendor_liability_insurence SET GLI_upld_cert='".$GLI_files["name"]."', GLI_date_verified='0000-00-00' where GLI_status ='' "; 
			  $db->setQuery($update_time);
			  $updatetime=$db->query();
			  }
			  else{
			  $lastRowId=$model->store_vendor_GLI_compliances_info($GLI_data);
			  }
				
				
				// Send mail to support and vendor when uploads the document
			  	$db =& JFactory::getDBO();
			    $mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
				$msg = "SELECT introtext  FROM #__content where id='267'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
				$db->setQuery($vendor_company);
				$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                $data=  'General Liability Policy - '.$id.' has been updated by '.$vcompanyv.'. Please verify document and information submitted.';
                $data1= 'General Liability Policy - '.$id;
				$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('General Liability Policy - '.$id.'',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
					$listcc = $cclist[$c];
						if($listcc){
							$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
						}
				}
				
				if( $user->subscribe_type != 'free'){
				$subject = 'A Vendor`s Compliance Document has been updated';
				$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>MyVendorCenter.com';
				$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$msg = str_replace('{DOCUMENT}', 'General Liability Policy - '.$id.'', $msg);		
				$msg = str_replace('{VENDOR}', $vcompanyv, $msg);
				$to_support = "documents@myvendorcenter.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
				$to_sateesh = "sk4576@gmail.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
				}
			  //Completed

}
		/***************************************************************WCI CODE*********************************************************************/
if($type=='wc'){
	$time = JRequest::getVar('time','');
			if($time == 'second'){
			$sql1 = "SELECT wc_folder_id FROM #__cam_vendor_workers_compansation  WHERE wc_folder_id!=0 and wc_status ='' and vendor_id=".$user->id;
			}
            $sql1 = "SELECT wc_folder_id FROM #__cam_vendor_workers_compansation  WHERE wc_folder_id!=0 and id=".$type_id;

		$db->setQuery($sql1);

		$wc_folder_id = $db->loadResult();

                $sql1 = "SELECT count(id) FROM #__cam_vendor_workers_compansation  WHERE vendor_id=".$user->id;

		$db->setQuery($sql1);

		$count_id1 = $db->loadResult();

		$WC_files		= JRequest::getVar('uploadfile','','files','array' );


			//code to store WCI data
				$WC_data['id']                          = $type_id;
				$WC_data['vendor_id'] 			=$user->id;

				if($WC_files['name']!= '')

					{

						//code to update image filed in vendors table

						//code to move image to folderpath

						//$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS;

				if($wc_folder_id){
				$WC_data['wc_folder_id'] 		=	$wc_folder_id;
                                $WC_No 		=	$wc_folder_id;
                                } else {
                                $WC_data['wc_folder_id'] 		=	$count_id1+1;
                                $WC_No 		=	$count_id1+1;
                                }


		  				$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS.$vendorname.DS.'WC_'.$WC_No.DS;

						jimport('joomla.client.helper');
						if(is_dir($base_Dir))
						{
							$files = JFolder::files($base_Dir, '.', false, true, array());
							if (!empty($files)) {
									jimport('joomla.filesystem.file');
									if (JFile::delete($files) !== true) {
											// JFile::delete throws an error
											return false;
									}
							}
						}

			    		JFolder::create( $base_Dir );

						$WC_files['name'] = str_replace(" ", "_", $WC_files['name']);
						$WC_files['name'] = str_replace("%", "_", $WC_files['name']);
						$WC_files['name'] = str_replace("#", "_", $WC_files['name']);
						$WC_files['name'] = str_replace("&", "_", $WC_files['name']);
						$WC_files['name'] = str_replace(",", "_", $WC_files['name']);
						$WC_files['name'] = str_replace("`", "_", $WC_files['name']);
						$WC_files['name'] = str_replace("'", "_", $WC_files['name']);
						$WC_files['name'] = str_replace("\\", "_", $WC_files['name']);
						$WC_files['name'] = str_replace(":", "_", $WC_files['name']);
						$WC_files['name'] = str_replace("?", "_", $WC_files['name']);
						$WC_files['name'] = str_replace("<", "_", $WC_files['name']);
						$WC_files['name'] = str_replace(">", "_", $WC_files['name']);
						$WC_files['name'] = str_replace("/", "_", $WC_files['name']);
						$WC_files['name'] = ereg_replace("/", "_", $WC_files['name']);
						$WC_files['name'] = str_replace("//", "_", $WC_files['name']);

						$WC_data['wc_upld_cert'] 		= $WC_files['name'];
                                 $folderid= 'WC_'.$WC_No ;
                                $filename=$WC_files['name'];
                                 $ext = end(explode('.', $WC_files['name']));
					$filepath = $base_Dir .$WC_files['name'];

						move_uploaded_file($WC_files['tmp_name'], $filepath);

						$WC_arr[$w] = '<a href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&vndr='.$user->id.'&doc=WC_'.$WC_No.'&filename='.$WC_files["name"] .'">'.$WC_files["name"] .'</a>';

					$w++;

					}
$WC_data['wc_date_verified'] 		= '0000-00-00';
if($time == 'second'){
	  
	  $update_time = "UPDATE #__cam_vendor_workers_compansation SET wc_upld_cert='".$WC_files["name"]."', wc_date_verified='0000-00-00' where wc_status ='' "; 
	  $db->setQuery($update_time);
	  $updatetime=$db->query();
	  }
	  else{
        $lastRowId= $model->store_vendor_WC_compliances_info($WC_data);
		}

		
				// Send mail to support and vendor when uploads the document
			  	$db =& JFactory::getDBO();
			    $mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
				$msg = "SELECT introtext  FROM #__content where id='267'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
				$db->setQuery($vendor_company);
				$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                $data=  'Workers Comp Exemption Form - '.$id.' has been updated by '.$vcompanyv.'. Please verify document and information submitted.';
                $data1= 'Workers Comp Exemption Form - '.$id;
				$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('Workers Comp Exemption Form - '.$id.'',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
					$listcc = $cclist[$c];
						if($listcc){
							$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
						}
				}
				
				if( $user->subscribe_type != 'free'){
				$subject = 'A Vendor`s Compliance Document has been updated';
				$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>MyVendorCenter.com';
				$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$msg = str_replace('{DOCUMENT}', 'Workers Comp Exemption Form - '.$id.'', $msg);		
				$msg = str_replace('{VENDOR}', $vcompanyv, $msg);
				$to_support = "documents@myvendorcenter.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
				$to_sateesh = "sk4576@gmail.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
				}
			  //Completed
			  

} //exit;
if($type=='WCI'){

      $sql1 = "SELECT WCI_folder_id FROM #__cam_vendor_workers_companies_insurance  WHERE WCI_folder_id!=0 and id=".$type_id;
		$time = JRequest::getVar('time','');
			if($time == 'second'){
			$sql1 = "SELECT WCI_folder_id FROM #__cam_vendor_workers_companies_insurance  WHERE WCI_folder_id!=0 and WCI_status ='' and vendor_id=".$user->id;
			}
			
		$db->setQuery($sql1);

		$WCI_folder_id = $db->loadResult();

                $sql1 = "SELECT count(id) FROM #__cam_vendor_workers_companies_insurance  WHERE vendor_id=".$user->id;

		$db->setQuery($sql1);

		$count_id1 = $db->loadResult();

$WCI_files		= JRequest::getVar('uploadfile','','files','array' );


			//code to store WCI data

				$WCI_data['id']						= $type_id;

				$WCI_data['vendor_id'] 			= $user->id;

				if($WCI_files['name']!= '')

					{

				if($WCI_folder_id){
				$WCI_data['WCI_folder_id'] 		=	$WCI_folder_id;
                                $WCI_No 		=	$WCI_folder_id;
                                } else {
                                $WCI_data['WCI_folder_id'] 		=	$count_id1+1;
                                $WCI_No 		=	$count_id1+1;
                                }

		  				$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS.$vendorname.DS.'WCI_'.$WCI_No.DS;

						jimport('joomla.client.helper');
						if(is_dir($base_Dir))
						{
							$files = JFolder::files($base_Dir, '.', false, true, array());
							if (!empty($files)) {
									jimport('joomla.filesystem.file');
									if (JFile::delete($files) !== true) {
											// JFile::delete throws an error
											return false;
									}
							}
						}

			    		JFolder::create( $base_Dir );

						$WCI_files['name'] = str_replace(" ", "_", $WCI_files['name']);
						$WCI_files['name'] = str_replace("%", "_", $WCI_files['name']);
						$WCI_files['name'] = str_replace("#", "_", $WCI_files['name']);
						$WCI_files['name'] = str_replace("&", "_", $WCI_files['name']);
						$WCI_files['name'] = str_replace(",", "_", $WCI_files['name']);
						$WCI_files['name'] = str_replace("`", "_", $WCI_files['name']);
						$WCI_files['name'] = str_replace("'", "_", $WCI_files['name']);
						$WCI_files['name'] = str_replace("\\", "_", $WCI_files['name']);
						$WCI_files['name'] = str_replace(":", "_", $WCI_files['name']);
						$WCI_files['name'] = str_replace("?", "_", $WCI_files['name']);
						$WCI_files['name'] = str_replace("<", "_", $WCI_files['name']);
						$WCI_files['name'] = str_replace(">", "_", $WCI_files['name']);
						$WCI_files['name'] = str_replace("/", "_", $WCI_files['name']);
						$WCI_files['name'] = ereg_replace("/", "_", $WCI_files['name']);
						$WCI_files['name'] = str_replace("//", "_", $WCI_files['name']);

						$WCI_data['WCI_upld_cert'] 			= $WCI_files['name'];

						$filepath = $base_Dir .$WCI_files['name'];
                                $folderid= 'WCI_'.$WCI_No ;
                                $filename=$WCI_files['name'];
                                 $ext = end(explode('.', $WCI_files['name']));
						move_uploaded_file($WCI_files['tmp_name'], $filepath);

						$WCI_arr[$w] = '<a href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&vndr='.$user->id.'&doc=WCI_'.$WCI_No.'&filename='.$WCI_files["name"] .'">'.$WCI_files["name"] .'</a>';

					$w++;

					}
$WCI_data['WCI_date_verified'] 		= '0000-00-00';					
if($time == 'second'){
	 
	  $update_time = "UPDATE #__cam_vendor_workers_companies_insurance SET WCI_upld_cert='".$WCI_files["name"]."', WCI_date_verified='0000-00-00' where WCI_status ='' "; 
	  $db->setQuery($update_time);
	  $updatetime=$db->query();
	  }
	  else{
      $lastRowId= $model->store_vendor_WCI_compliances_info($WCI_data);
		}

				// Send mail to support and vendor when uploads the document
			  	$db =& JFactory::getDBO();
			    $mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
				$msg = "SELECT introtext  FROM #__content where id='267'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
				$db->setQuery($vendor_company);
				$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                $data=  'Workers Compensation / Employer`s Liabilty Policy - '.$id.' has been updated by '.$vcompanyv.'. Please verify document and information submitted.';
                $data1= 'Workers Compensation / Employer`s Liabilty Policy - '.$id;
				$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('Workers Compensation / Employer`s Liabilty Policy - '.$id.'',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
					$listcc = $cclist[$c];
						if($listcc){
							$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
						}
				}
				if( $user->subscribe_type != 'free'){
				$subject = 'A Vendor`s Compliance Document has been updated';
				$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>MyVendorCenter.com';
				$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$msg = str_replace('{DOCUMENT}', 'Workers Compensation / Employer`s Liabilty Policy - '.$id.'', $msg);		
				$msg = str_replace('{VENDOR}', $vcompanyv, $msg);
				$to_support = "documents@myvendorcenter.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
				$to_sateesh = "sk4576@gmail.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
				}
			  //Completed
}

if($type=='OMI'){

      $sql1 = "SELECT OMI_folder_id FROM #__cam_vendor_errors_omissions_insurance WHERE OMI_folder_id!=0 and id=".$type_id;
		$time = JRequest::getVar('time','');
			if($time == 'second'){
			$sql1 = "SELECT OMI_folder_id FROM #__cam_vendor_errors_omissions_insurance WHERE OMI_folder_id!=0 and OMI_status ='' and vendor_id=".$user->id;
			}
		$db->setQuery($sql1);
		$OMI_folder_id = $db->loadResult();
        $sql1 = "SELECT count(id) FROM #__cam_vendor_errors_omissions_insurance WHERE vendor_id=".$user->id;
		$db->setQuery($sql1);
		$count_id1 = $db->loadResult();
		$OMI_files		= JRequest::getVar('uploadfile','','files','array' );
			//code to store OMI data
				$OMI_data['id']						= $type_id;
				$OMI_data['vendor_id'] 			= $user->id;
				if($OMI_files['name']!= '')
					{
				if($OMI_folder_id){
				$OMI_data['OMI_folder_id'] 		=	$OMI_folder_id;
                $OMI_No 		=	$OMI_folder_id;
                           } else {
                                $OMI_data['OMI_folder_id'] 		=	$count_id1+1;
                                $OMI_No 		=	$count_id1+1;
                                }

		  				$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS.$vendorname.DS.'OMI_'.$OMI_No.DS;

						jimport('joomla.client.helper');
						if(is_dir($base_Dir))
						{
							$files = JFolder::files($base_Dir, '.', false, true, array());
							if (!empty($files)) {
									jimport('joomla.filesystem.file');
									if (JFile::delete($files) !== true) {
											// JFile::delete throws an error
											return false;
									}
							}
						}

			    		JFolder::create( $base_Dir );

						$OMI_files['name'] = str_replace(" ", "_", $OMI_files['name']);
						$OMI_files['name'] = str_replace("%", "_", $OMI_files['name']);
						$OMI_files['name'] = str_replace("#", "_", $OMI_files['name']);
						$OMI_files['name'] = str_replace("&", "_", $OMI_files['name']);
						$OMI_files['name'] = str_replace(",", "_", $OMI_files['name']);
						$OMI_files['name'] = str_replace("`", "_", $OMI_files['name']);
						$OMI_files['name'] = str_replace("'", "_", $OMI_files['name']);
						$OMI_files['name'] = str_replace("\\", "_",$OMI_files['name']);
						$OMI_files['name'] = str_replace(":", "_", $OMI_files['name']);
						$OMI_files['name'] = str_replace("?", "_", $OMI_files['name']);
						$OMI_files['name'] = str_replace("<", "_", $OMI_files['name']);
						$OMI_files['name'] = str_replace(">", "_", $OMI_files['name']);
						$OMI_files['name'] = str_replace("/", "_", $OMI_files['name']);
						$OMI_files['name'] = ereg_replace("/", "_",$OMI_files['name']);
						$OMI_files['name'] = str_replace("//", "_",$OMI_files['name']);

						$OMI_data['OMI_upld_cert'] 			= $OMI_files['name'];

						$filepath = $base_Dir .$OMI_files['name'];
                                $folderid= 'OMI_'.$OMI_No ;
                                $filename=$OMI_files['name'];
                                 $ext = end(explode('.', $OMI_files['name']));
						move_uploaded_file($OMI_files['tmp_name'], $filepath);

						$OMI_arr[$w] = '<a href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&vndr='.$user->id.'&doc=WCI_'.$OMI_No.'&filename='.$OMI_files["name"] .'">'.$OMI_files["name"] .'</a>';

					$w++;

					}
$OMI_data['OMI_date_verified'] 		= '0000-00-00';					
if($time == 'second'){
	 
	  $update_time = "UPDATE #__cam_vendor_errors_omissions_insurance SET OMI_upld_cert='".$OMI_files["name"]."', OMI_date_verified='0000-00-00' where OMI_status ='' "; 
	  $db->setQuery($update_time);
	  $updatetime=$db->query();
	  }
	  else{
      $lastRowId= $model->store_vendor_OMI_compliances_info($OMI_data);
		}

				// Send mail to support and vendor when uploads the document
			  	$db =& JFactory::getDBO();
			    $mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
				$msg = "SELECT introtext  FROM #__content where id='267'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
				$db->setQuery($vendor_company);
				$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                $data=  'ERRORS & OMISSIONS INSURANCE - '.$id.' has been updated by '.$vcompanyv.'. Please verify document and information submitted.';
                $data1= 'ERRORS & OMISSIONS INSURANCE - '.$id;
				$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('ERRORS & OMISSIONS INSURANCE - '.$id.'',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
					$listcc = $cclist[$c];
						if($listcc){
							$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
						}
				}
				if( $user->subscribe_type != 'free'){
				$subject = 'A Vendor`s Compliance Document has been updated';
				$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>MyVendorCenter.com';
				$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$msg = str_replace('{DOCUMENT}', 'ERRORS & OMISSIONS INSURANCE - '.$id.'', $msg);		
				$msg = str_replace('{VENDOR}', $vcompanyv, $msg);
				$to_support = "documents@myvendorcenter.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
				$to_sateesh = "sk4576@gmail.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
				}
			  //Completed
}



if($type=='aip'){
                    $sql7 = "SELECT aip_folder_id FROM #__cam_vendor_auto_insurance  WHERE aip_folder_id!=0 and id=".$type_id;
		$time = JRequest::getVar('time','');
			if($time == 'second'){
			$sql7 = "SELECT aip_folder_id FROM #__cam_vendor_auto_insurance  WHERE aip_folder_id!=0 and aip_status ='' and vendor_id=".$user->id;
			}
		$db->setQuery($sql7);

		$aip_folder_id = $db->loadResult();

                $sql8 = "SELECT count(id) FROM #__cam_vendor_auto_insurance  WHERE vendor_id=".$user->id;

		$db->setQuery($sql8);

		$count_id = $db->loadResult();

           	$aip_files		= JRequest::getVar('uploadfile','','files','array' );
    //echo '<pre>'; print_r($_FILES); exit;
		//for($i=0; $i<count($post['old_line_task_OLN_ids']); $i++)
	//	{
				$aip_data['id']				=$type_id;
                                $aip_data['vendor_id']			= $user->id;
				if($aip_files['name'] != '')

				{

				//code to update image filed in vendors table

				//code to move image to folderpath

				if($aip_folder_id){
				$aip_data['aip_folder_id'] 		=	$aip_folder_id;
                                $aip_No 		=	$aip_folder_id;
                                } else {
                                $aip_data['aip_folder_id'] 		=	$count_id+1;
                                $aip_No 		=	$count_id+1;
                                }
 //echo '<pre>'; print_r($OLN_No);  exit;

		  		 $base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS.$vendorname.DS.'aip_'.$aip_No.DS;

				// Remove all the files in folder if they exist
				jimport('joomla.client.helper');
				if(is_dir($base_Dir))
					{
						$files = JFolder::files($base_Dir, '.', false, true, array());
						if (!empty($files)) {
								jimport('joomla.filesystem.file');
								if (JFile::delete($files) !== true) {
										// JFile::delete throws an error
										return false;
								}
						}
					}


			    JFolder::create( $base_Dir );

				$aip_files['name'] = str_replace(" ", "_", $aip_files['name']);
				$aip_files['name'] = str_replace("&", "_", $aip_files['name']);
				$aip_files['name'] = str_replace("#", "_", $aip_files['name']);
				$aip_files['name'] = str_replace("%", "_", $aip_files['name']);
				$aip_files['name'] = str_replace(",", "_", $aip_files['name']);
				$aip_files['name'] = str_replace("`", "_", $aip_files['name']);
				$aip_files['name'] = str_replace("'", "_", $aip_files['name']);
				$aip_files['name'] = str_replace("\\", "_", $aip_files['name']);
				$aip_files['name'] = str_replace(":", "_", $aip_files['name']);
				$aip_files['name'] = str_replace("?", "_", $aip_files['name']);
				$aip_files['name'] = str_replace("<", "_", $aip_files['name']);
				$aip_files['name'] = str_replace(">", "_", $aip_files['name']);
				$aip_files['name'] = str_replace("/", "_", $aip_files['name']);
				$aip_files['name'] = str_replace("//", "_", $aip_files['name']);
				$aip_files['name'] = ereg_replace("/", "_", $aip_files['name']);

				$aip_data['aip_upld_cert'] 		=	$aip_files['name'];
                                $folderid= 'aip_'.$aip_No;
                                $filename=$aip_files['name'];
                                 $ext = end(explode('.', $aip_files['name']));
				 $filepath = $base_Dir .$aip_files['name'];

				move_uploaded_file($aip_files['tmp_name'], $filepath);

				$aip_arr[$o] = '<a href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&vndr='.$user->id.'&doc=aip_'.$aip_No.'&filename='.$aip_files["name"] .'">'.$aip_files["name"] .'</a>';

					$o++;

				}
				$aip_data['aip_date_verified'] 		= '0000-00-00';
				$time = JRequest::getVar('time','');
			  if($time == 'second'){
			  
			  $update_time = "UPDATE #__cam_vendor_auto_insurance SET aip_upld_cert='".$aip_files["name"]."', aip_date_verified='0000-00-00' where aip_status ='' "; 
			  $db->setQuery($update_time);
			  $updatetime=$db->query();
			  }
			  else{
               $lastRowId=  $model->store_vendor_aip_compliances_info($aip_data);
			   }

				// Send mail to support and vendor when uploads the document
			  	$db =& JFactory::getDBO();
			    $mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
				$msg = "SELECT introtext  FROM #__content where id='267'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
				$db->setQuery($vendor_company);
				$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                $data=  'Commercial Vehicle Policy - '.$id.' has been updated by '.$vcompanyv.'. Please verify document and information submitted.';
                $data1= 'Commercial Vehicle Policy - '.$id;
				$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('Commercial Vehicle Policy - '.$adda.'',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
					$listcc = $cclist[$c];
						if($listcc){
							$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
						}
				}
				
				if( $user->subscribe_type != 'free'){
				$subject = 'A Vendor`s Compliance Document has been updated';
				$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>MyVendorCenter.com';
				$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$msg = str_replace('{DOCUMENT}', 'Commercial Vehicle Policy - '.$id.'', $msg);		
				$msg = str_replace('{VENDOR}', $vcompanyv, $msg);
				$to_support = "documents@myvendorcenter.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
				$to_sateesh = "sk4576@gmail.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
				}
			  //Completed
		//}
  }
  
		/***************************************************************W9 CODE*********************************************************************/
if($type=='W9'){
		$W9files		= JRequest::getVar('uploadfile','','files','array' );
//echo "<pre>"; print_r($W9files);
		  		$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS.$vendorname.DS.'W9'.DS;

				jimport('joomla.client.helper');
				if(is_dir($base_Dir))
					{
						$files = JFolder::files($base_Dir, '.', false, true, array());
						if (!empty($files)) {
								jimport('joomla.filesystem.file');
								/*if (JFile::delete($files) !== true) {
										// JFile::delete throws an error
										return false;
								}*/
						}
					}

			    JFolder::create( $base_Dir );

				$W9files['name'] = str_replace(" ", "_", $W9files['name']);
				$W9files['name'] = str_replace("&", "_", $W9files['name']);
				$W9files['name'] = str_replace("#", "_", $W9files['name']);
				$W9files['name'] = str_replace("%", "_", $W9files['name']);

				$W9files['name'] = str_replace(",", "_", $W9files['name']);
				$W9files['name'] = str_replace("`", "_", $W9files['name']);
				$W9files['name'] = str_replace("'", "_", $W9files['name']);
				$W9files['name'] = str_replace("\\", "_", $W9files['name']);
				$W9files['name'] = str_replace(":", "_", $W9files['name']);
				$W9files['name'] = str_replace("?", "_", $W9files['name']);
				$W9files['name'] = str_replace("<", "_", $W9files['name']);
				$W9files['name'] = str_replace(">", "_", $W9files['name']);
				$W9files['name'] = str_replace("/", "_", $W9files['name']);
				$W9files['name'] = ereg_replace("/", "_", $W9files['name']);
				$W9files['name'] = str_replace("//", "_", $W9files['name']);



				$filepath = $base_Dir .$W9files['name'];
                                $folderid= 'W9';
                                $filename=$W9files['name'];
                                 $ext = end(explode('.', $W9files['name']));
				move_uploaded_file($W9files['tmp_name'], $filepath);

				$W9_link = '<a href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&vndr='.$user->id.'&doc=W9&filename='.$W9files['name'].'">'.$W9files['name'].'</a>';
				//$W9_data['w9_upld_cert'] 			= $post['W9_upld_cert1'];
				$W9_data['vendor_id'] 			= $user->id;
				$W9_data['id']					=  $type_id;
  				$W9_data['w9_upld_cert'] = $W9files['name'];
				$W9_data['w9_date_verified'] = '0000-00-00';

				//echo "<pre>"; print_r($W9_data); exit;
				$lastRowId=$model->store_vendor_compliance_w9docs_info($W9_data);
				//echo $lastRowId;

                  		$mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
		$msg = "SELECT introtext  FROM #__content where id='267'";
		$db->setQuery($msg);
		$msg = $db->loadResult();
		$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
		$db->setQuery($vendor_company);
		$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
		 		
                $data=  'W9 Document Updated has been updated by '.$vcompanyv.'. Please verify document and information submitted.';
                $data1=  'W9';
				$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('W9 Document',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				//code to send mail to camassistant admin
				/********************************************************************/
				
				//Sending emails to vendor cc persons
				$db = JFactory::getDBO();
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
				$listcc = $cclist[$c];
				if($listcc){
				$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
				}
				}
		//To send the mail to support team
		//echo "<pre>"; print_r($user); echo "</pre>"; exit;
		if( $user->subscribe_type != 'free'){
		$subject = 'A Vendor`s Compliance Document has been updated';
		$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>
MyVendorCenter.com';
		$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
		$msg = str_replace('{DOCUMENT}', 'W9 Document', $msg);		
		$msg = str_replace('{VENDOR}', $vcompanyv, $msg);		
		$to_sateesh = "sk4576@gmail.com";
		$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
		$to_support = "documents@myvendorcenter.com"; 
		$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
        }        
                }

//echo $lastRowId; exit;
            echo "<script language='javascript' type='text/javascript'>
		//window.parent.document.getElementById( 'sbox-window' ).close();
                parent.SqueezeBox.close();
                var id = '".$id."';
		var remove = 'remove".$id."';
		var upload = 'upload".$id."';
                var image = 'imagdisplay".$id."';
                var folderid = '".$folderid."';
                var filename='".$filename."';
               var lastrowid='".$lastRowId."';
                var type='".$type."';
                var ext='".$ext."';

                      //  var del_path = '<a href=\'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&doc=OLN_'+splreq+'&task=Remove_downloadfile&Alt_Prp='+AltPrp+'&Alt_bid='+AltPrp+'&vendor_id='+userid+'&rfp_id='+rfpid+'&task_id='+task+'&doc_id='+docid+'&act='+act+'&rebid='+rebid+'&prop_id='+Proposal_id+'&&Itemid=107\'><img src=\'templates/camassistant_left/images/remove.gif\' alt=\'Remove file\' align=\'absmiddle\' /></a><br/>';

               var image_exe='<a target=\'_blank\' href=\'index.php?option=com_camassistant&controller=vendors&task=openview_upld_cert&doc='+folderid+'&filename='+filename+'\'><img src=\'templates/camassistant_inner/images/doc_images/images_'+ext+'.png\'>';


//alert(image_exe);
                window.parent.document.getElementById('imagdisplay'+type+''+id).innerHTML = image_exe;
				window.parent.document.getElementById(type+'_upld_cert'+id).value = filename;
                 //window.parent.document.getElementById('upload'+type+''+id).style.display ='none';
				 // window.parent.document.getElementById('uploadnew'+type+''+id).style.display ='none';
                  //window.parent.document.getElementById('remove'+type+''+id).style.display ='';
                 if(lastrowid){
                   window.parent.document.getElementById('d'+type+''+id).value = lastrowid;
                   window.parent.document.getElementById('old_line_task_'+type+'_ids_'+id).value = lastrowid;
                  }

              </script>";
		 exit;

        //$link = 'index.php?option=com_camassistant&controller=vendors&task=vendor_compliance_docs&Itemid=191';

		//$this->setRedirect($link);
	}

	//function to save billing centre info

	function save_billing_centre()

	{

		$model = $this->getModel('vendors');

		$user = JFactory::getUser();

		$post	= JRequest::get('post');

		$data['id']	= $post['id'];

		$data['user_id']	= $user->id;

		$data['payment_preference']	= $post['checkbox'][0];

		$data['date']	= date('Y-m-d');

		$data['status']	= '';

		$db =& JFactory::getDBO();

		//$data['user_id']	= $user->id;

		//echo "<pre>"; print_r($data); exit;

		$mailfrom = 'support@myvendorcenter.com';

		$cc = 'support@myvendorcenter.com';

		$to = $user->email;

		if($data['payment_preference'] == 'PMR'){

		$subject = 'Your CAMassistant Payment Selection';

		$body_email="SELECT introtext  FROM #__content where id='171' ";

		}

		if($data['payment_preference'] == 'PBC'){

		$subject = 'Your CAMassistant Payment Selection';

		$body_email="SELECT introtext  FROM #__content where id='170' ";

		}

		$db->Setquery($body_email);

		$content = $db->loadResult();

		$res = JUtility::sendMail($mailfrom, '', $to, $subject, $content, $mode=1, $cc);

		$save_billing_centre = $model->save_billing_centre($data);

		parent::display();

	}

	

	//function to delete vendor compliance document

	function delete_upld_cert()

	{

		$model = $this->getModel('vendors');

		//$type = JRequest::getVar('type','');
//echo '<pre>'; print_r($_REQUEST); exit;
                $type= JRequest::getVar('suffix','');
                $type_id= JRequest::getVar('id','');
                $da_id= JRequest::getVar('daid','');
		$open = $model->get_delete_upld_cert();

		//$link = 'index.php?option=com_camassistant&controller=vendors&task=vendor_compliance_docs&Itemid='.$Itemid;

		$err_msg="Document Deleted Successfully";
		
		/*echo "<script language='javascript' type='text/javascript'>
		var type = '".$type."';
		var type_id = '".$type_id."';
		var da_id = '".$da_id."';
		alert('Document Deleted Successfully');
		window.parent.document.getElementById('imagdisplay'+type+''+da_id).innerHTML = '<img src=\'templates/camassistant_inner/images/doc_images/no-file-uploaded.png\' alt=\'Remove file\'/>';
		window.parent.document.getElementById('upload'+type+''+da_id).style.display ='';
		window.parent.document.getElementById('remove'+type+''+da_id).style.display ='none';
		</script>";
		exit;*/

		//$this->setRedirect( $link,$msg );

		//parent::display();
		if($type == 'GLI'){
			echo "<script language='javascript' type='text/javascript'>
			var type = '".$type."';
			var type_id = '".$type_id."';
			var da_id = '".$da_id."';
			alert('Document Deleted Successfully');
			window.parent.document.getElementById('imagdisplay'+type+''+da_id).innerHTML = '<img src=\'templates/camassistant_inner/images/doc_images/no-file-uploaded.png\' alt=\'Remove file\'/>';
			window.parent.document.getElementById('upload'+type+''+da_id).style.display ='';
			window.parent.document.getElementById('remove'+type+''+da_id).style.display ='none';
			window.parent.document.getElementById(''+type+'_end_date'+da_id).value ='00-00-0000';
			window.parent.document.getElementById(''+type+'_policy_aggregate'+da_id).value ='0.00';
			window.parent.document.getElementById(''+type+'_policy_occurence'+da_id).value ='0.00';
			</script>";
			}
			else if($type == 'WCI'){
			echo "<script language='javascript' type='text/javascript'>
			var type = '".$type."';
			var type_id = '".$type_id."';
			var da_id = '".$da_id."';
			alert('Document Deleted Successfully');
			window.parent.document.getElementById('imagdisplay'+type+''+da_id).innerHTML = '<img src=\'templates/camassistant_inner/images/doc_images/no-file-uploaded.png\' alt=\'Remove file\'/>';
			window.parent.document.getElementById('upload'+type+''+da_id).style.display ='';
			window.parent.document.getElementById('remove'+type+''+da_id).style.display ='none';
			window.parent.document.getElementById(''+type+'_end_date'+da_id).value ='00-00-0000';
			</script>";
			}
			else if($type == 'OLN'){
			echo "<script language='javascript' type='text/javascript'>
			var type = '".$type."';
			var type_id = '".$type_id."';
			var da_id = '".$da_id."';
			alert('Document Deleted Successfully');
			window.parent.document.getElementById('imagdisplay'+type+''+da_id).innerHTML = '<img src=\'templates/camassistant_inner/images/doc_images/no-file-uploaded.png\' alt=\'Remove file\'/>';
			window.parent.document.getElementById('upload'+type+''+da_id).style.display ='';
			window.parent.document.getElementById('remove'+type+''+da_id).style.display ='none';
			window.parent.document.getElementById(''+type+'_expdate'+da_id).value ='00-00-0000';
			</script>";
			}
			else if($type == 'PLN'){
			echo "<script language='javascript' type='text/javascript'>
			var type = '".$type."';
			var type_id = '".$type_id."';
			var da_id = '".$da_id."';
			alert('Document Deleted Successfully');
			window.parent.document.getElementById('imagdisplay'+type+''+da_id).innerHTML = '<img src=\'templates/camassistant_inner/images/doc_images/no-file-uploaded.png\' alt=\'Remove file\'/>';
			window.parent.document.getElementById('upload'+type+''+da_id).style.display ='';
			window.parent.document.getElementById('remove'+type+''+da_id).style.display ='none';
			window.parent.document.getElementById(''+type+'_expdate'+da_id).value ='00-00-0000';
			window.parent.document.getElementById(''+type+'_state'+da_id).value ='';
			window.parent.document.getElementById(''+type+'_type'+da_id).value ='';
			</script>";
			}
			else if($type == 'wc'){
			echo "<script language='javascript' type='text/javascript'>
			var type = '".$type."';
			var type_id = '".$type_id."';
			var da_id = '".$da_id."';
			alert('Document Deleted Successfully');
			window.parent.document.getElementById('imagdisplay'+type+''+da_id).innerHTML = '<img src=\'templates/camassistant_inner/images/doc_images/no-file-uploaded.png\' alt=\'Remove file\'/>';
			window.parent.document.getElementById('upload'+type+''+da_id).style.display ='';
			window.parent.document.getElementById('remove'+type+''+da_id).style.display ='none';
			window.parent.document.getElementById(''+type+'_end_date'+da_id).value ='00-00-0000';
			</script>";
			}
			else if($type == 'aip'){
			echo "<script language='javascript' type='text/javascript'>
			var type = '".$type."';
			var type_id = '".$type_id."';
			var da_id = '".$da_id."';
			alert('Document Deleted Successfully');
			window.parent.document.getElementById('imagdisplay'+type+''+da_id).innerHTML = '<img src=\'templates/camassistant_inner/images/doc_images/no-file-uploaded.png\' alt=\'Remove file\'/>';
			window.parent.document.getElementById('upload'+type+''+da_id).style.display ='';
			window.parent.document.getElementById('remove'+type+''+da_id).style.display ='none';
			window.parent.document.getElementById(''+type+'_end_date'+da_id).value ='00-00-0000';
			</script>";
			}
			else {
			echo "<script language='javascript' type='text/javascript'>
			var type = '".$type."';
			var type_id = '".$type_id."';
			var da_id = '".$da_id."';
			alert('Document Deleted Successfully');
			window.parent.document.getElementById('imagdisplay'+type+''+da_id).innerHTML = '<img src=\'templates/camassistant_inner/images/doc_images/no-file-uploaded.png\' alt=\'Remove file\'/>';
			window.parent.document.getElementById('upload'+type+''+da_id).style.display ='';
			window.parent.document.getElementById('remove'+type+''+da_id).style.display ='none';
			</script>";
			}
		exit;

	}

	

	//function to open document

	function view_upld_cert()

	{

		$model = $this->getModel('vendors');

		$open = $model->get_open_upld_cert();

		parent::display();

	}

	

	function pdf_view_upld_cert()

	{

	//echo 'contoler'; exit;

		$model = $this->getModel('vendors');

		$open = $model->get_pdf_open_upld_cert();

		parent::display();

	}

	

	//function to save uploaded certificates in compliance form

	function compliance_upld_cert_Save()

	{

		//session_destroy();

		session_start();

		$compliance = JRequest::getVar('compliance','');

		$compliance = $compliance + 1;

		$license_type = JRequest::getVar('license_type','');

		$name = $license_type.'_upld_cert'.$compliance; 

		$files		= JRequest::getVar( $name, '', 'files', 'array' );

		$filename = $files['name']; 

		if($files && $files['name'] != '')

		{

		//code to update image filed in vendors table

		//code to move image to folderpath

		$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS;

		$filepath = $base_Dir . $filename;  

		//print_r($filepath ); exit;

		move_uploaded_file($files['tmp_name'], $filepath); 

		}

		

		if($error != '')

		echo "<script language='javascript' type='text/javascript'>

			var err = '".$error."';

			alert(err); </script>";

		else

		{		

			echo "<script language='javascript' type='text/javascript'>

			var val = '".$filename."';

			var id = '".$name."';

			//alert(id);

			window.parent.document.getElementById(id).value = val;

			//alert(window.parent.document.getElementById(id).value);

			window.parent.document.getElementById( 'sbox-window' ).close();

			//window.parent.parent.location.reload();

			 </script>"; 

		}	 

	}



	function get_subcat()

	{

		JRequest::getVar('view','vendors');

	    parent::display();

	}

		

	function ajax_compliance_OLN_form()

	{

		JRequest::getVar('view','vendors');

	    parent::display();

	}

	

	function ajax_compliance_PLN_form()

	{

		JRequest::getVar('view','vendors');

	    parent::display();

	}

	

	function ajax_compliance_gli_form()

	{

		JRequest::getVar('view','vendors');

	    parent::display();

	}

	

	function ajax_compliance_wci_form()

	{

		JRequest::getVar('view','vendors');

	    parent::display();

	}
 function ajax_compliance_wc_form()

	{

		JRequest::getVar('view','vendors');

	    parent::display();

	}
function ajax_compliance_aip_form()

	{

		JRequest::getVar('view','vendors');

	    parent::display();

	}

function ajax_compliance_omi_form()
	{
		JRequest::getVar('view','vendors');
	    parent::display();
	}

	//function te delete compliance from db

	function del_vendorcompliance_fromtbl()

	{

		$tbl = JRequest::getVar('tbl','');

		$docid = JRequest::getVar('docid','');

		$user = JFactory::getUser();

		$db = JFactory::getDBO();

		$query = "DELETE FROM #__cam_vendor_".$tbl." WHERE id=".$docid;

		$db->setQuery($query); 

		if($db->query())

		{ echo 'Deleted'; }

		exit;

	}
	
	function del_vendorcompliance_fromtbl_omi()

	{
		$tbl = JRequest::getVar('tbl','');
		$docid = JRequest::getVar('docid','');
		$user = JFactory::getUser();
		$db = JFactory::getDBO();
		$query = "DELETE FROM #__cam_vendor_errors_omissions_insurance WHERE id=".$docid; 
		$db->setQuery($query); 
		if($db->query())
		{ echo 'Deleted'; }
		exit;
	}

	 

	//function to save vendor compliance docs

	function save_compliance()

	{

		$post	= JRequest::get('post');
    //echo '<pre>'; print_r($_REQUEST); exit;
		$Itemid	= JRequest::getVar('Itemid','');
		$saveddoc	= JRequest::getVar('document_type',''); 
		$user	= JFactory::getUser();

		$db = JFactory::getDBO();

		$sql = "SELECT tax_id FROM #__cam_vendor_company   WHERE user_id=".$user->id;

		$db->setQuery($sql);

		$tax_id = $db->loadResult();

		$vendorname = $user->name.'_'.$user->lastname.'_'.$tax_id;

		$vendorname = str_replace(' ','_',$vendorname);

		$model = $this->getModel('vendors');

		//echo "<pre>";  print_r($post['current_line_task_GLI_ids']); print_r($post['old_line_task_GLI_ids']); exit;

		/***************************************************************OLN_CODE*********************************************************************/
//echo "<pre>";  print_r($post); ; exit;
		$OLN_files		= JRequest::getVar('OLN_upld_cert','','files','array' );
   // echo '<pre>'; print_r($post); exit;
		for($i=0; $i<count($post['old_line_task_OLN_ids']); $i++)
		{
				$OLN_data['id']					= $post['old_line_task_OLN_ids'][$i];

				$OLN_data['vendor_id']			= $user->id;

				$OLN_data['OLN_license'] 		= $post['OLN_license'][$i];
				
				
				if (strpos($post['OLN_expdate'][$i], 'Does Not Expire') !== false){
				$OLN_data['OLN_expdate']		= 'Does Not Expire';
				}
				else{
				$date = explode('-',$post['OLN_expdate'][$i]);
				$OLN_data['OLN_expdate']		= $date[2].'-'.$date[0].'-'.$date[1];
				}

				$OLN_data['OLN_city_country'] 	= $post['OLN_city_country'][$i];

				//$OLN_data['OLN_upld_cert'] 		= $post['OLN_upld_cert'][$i];

				$OLN_data['OLN_state'] 			= $post['OLN_state'][$i];

				//$OLN_data['OLN_status'] 		= '1';
				if($post['OLN_status'][$i]=='-1'){
				$OLN_data['OLN_status']  = '1';
				} else {
				$OLN_data['OLN_status']  = '1';
				}

				/* if($OLN_files['name'][$i] != '')

				{

				//code to update image filed in vendors table

				//code to move image to folderpath

				$OLN_No = $i+1;
				$OLN_No = $post['current_line_task_OLN_ids'][$i];

		  		$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS.$vendorname.DS.'OLN_'.$OLN_No.DS;

				// Remove all the files in folder if they exist
				jimport('joomla.client.helper');
				if(is_dir($base_Dir))
					{
						$files = JFolder::files($base_Dir, '.', false, true, array());
						if (!empty($files)) {
								jimport('joomla.filesystem.file');
								if (JFile::delete($files) !== true) {
										// JFile::delete throws an error
										return false;
								}
						}
					}


			    JFolder::create( $base_Dir );

				$OLN_files['name'][$i] = str_replace(" ", "_", $OLN_files['name'][$i]);
				$OLN_files['name'][$i] = str_replace("&", "_", $OLN_files['name'][$i]);
				$OLN_files['name'][$i] = str_replace("#", "_", $OLN_files['name'][$i]);
				$OLN_files['name'][$i] = str_replace("%", "_", $OLN_files['name'][$i]);
				$OLN_files['name'][$i] = str_replace(",", "_", $OLN_files['name'][$i]);
				$OLN_files['name'][$i] = str_replace("`", "_", $OLN_files['name'][$i]);
				$OLN_files['name'][$i] = str_replace("'", "_", $OLN_files['name'][$i]);
				$OLN_files['name'][$i] = str_replace("\\", "_", $OLN_files['name'][$i]);
				$OLN_files['name'][$i] = str_replace(":", "_", $OLN_files['name'][$i]);
				$OLN_files['name'][$i] = str_replace("?", "_", $OLN_files['name'][$i]);
				$OLN_files['name'][$i] = str_replace("<", "_", $OLN_files['name'][$i]);
				$OLN_files['name'][$i] = str_replace(">", "_", $OLN_files['name'][$i]);
				$OLN_files['name'][$i] = str_replace("/", "_", $OLN_files['name'][$i]);
				$OLN_files['name'][$i] = str_replace("//", "_", $OLN_files['name'][$i]);
				$OLN_files['name'][$i] = ereg_replace("/", "_", $OLN_files['name'][$i]);

				$OLN_data['OLN_upld_cert'] 		=	$OLN_files['name'][$i];

				$OLN_data['OLN_folder_id'] 		=	$OLN_No;

				 $filepath = $base_Dir .$OLN_files['name'][$i];

				move_uploaded_file($OLN_files['tmp_name'][$i], $filepath);

				$OLN_arr[$o] = '<a href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&vndr='.$user->id.'&doc=OLN_'.$OLN_No.'&filename='.$OLN_files["name"][$i] .'">'.$OLN_files["name"][$i] .'</a>';

					$o++;

				}
                                 * */

                               // $date8 = date('Y-m-d');
				if($OLN_data['id']	== '')
				{
				$OLN_data['OLN_date_verified']	= '0000-00-00';
				//} else {
                               // $OLN_data['OLN_date_verified']	= $date8;
                                }

				//echo "<pre>"; print_r($OLN_data); exit;
				//if($OLN_data['OLN_expdate'] != '' )
				$addo = $i + 1 ;
				if($saveddoc == 'OLN'.$addo){
				$OLN_data['OLN_date_verified']	= '0000-00-00';
				$OLN_data['saveddate']    = date('Y-m-d');
                              //  $saveddoc1='OLN';
                                $mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
				$msg = "SELECT introtext  FROM #__content where id='267'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
				$db->setQuery($vendor_company);
				$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                
            
                 
                $data=  'Bus. Tax Receipt / Occupational License - '.$addo.' has been updated by '.$vcompanyv.'. Please verify document and information submitted.';
                $data1=  'Bus. Tax Receipt / Occupational License - '.$addo;
				$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('Bus. Tax Receipt / Occupational License - '.$addo.'',$vcompanyv);
				}
				
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				//code to send mail to camassistant admin
				/********************************************************************/
				
				//Sending emails to vendor cc persons
				$db = JFactory::getDBO();
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
				$listcc = $cclist[$c];
				if($listcc){
				$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
				}
				}
		//To send the mail to support team
		if( $user->subscribe_type != 'free'){
		$subject = 'A Vendor`s Compliance Document has been updated';
		$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>MyVendorCenter.com';
		$msg = "SELECT introtext  FROM #__content where id='274'";
		$db->setQuery($msg);
		$msg = $db->loadResult();
		$msg = str_replace('{DOCUMENT}', 'Bus. Tax Receipt / Occupational License - '.$addo.'', $msg);		
		$msg = str_replace('{VENDOR}', $vcompanyv, $msg);
		$to_sateesh = "sk4576@gmail.com";
		$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
		$to_support = "documents@myvendorcenter.com"; 
		$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
		}
                                }	
				else{
				$olddate ="select saveddate, OLN_date_verified from #__cam_vendor_occupational_license Where id =".$post['old_line_task_OLN_ids'][$i];
				$db->setQuery($olddate);
				$OLN_datadatasaved = $db->loadObject();
				$OLN_data['saveddate'] = $OLN_datadatasaved->saveddate ;
				$OLN_data['OLN_date_verified'] = $OLN_datadatasaved->OLN_date_verified ;
				}
				
				if($OLN_data['OLN_expdate']!='' && $OLN_data['OLN_expdate']!='--') {
				$model->store_vendor_OLN_compliances_info($OLN_data);
				}
                              //  $model->store_vendor_OLN_compliances_info($OLN_data);

		}

		//exit;


		/***************************************************************PLN CODE*********************************************************************/

		$PLN_files		= JRequest::getVar('PLN_upld_cert','','files','array' );

		for($i=0,$p=0; $i<count($post['old_line_task_PLN_ids']); $i++)

		{

				$PLN_data['id']					= $post['old_line_task_PLN_ids'][$i];

				$PLN_data['vendor_id']			= $user->id;

				$PLN_data['PLN_license'] 		= $post['PLN_license'][$i];

				$date = explode('-',$post['PLN_expdate'][$i]);

				$PLN_data['PLN_expdate']		= $date[2].'-'.$date[0].'-'.$date[1];

				$PLN_data['PLN_category'] 		= $post['PLN_category'][$i];

				$PLN_data['PLN_type']			= $post['PLN_type'][$i];

				$PLN_data['PLN_state'] 			= $post['PLN_state'][$i];

				//$PLN_data['PLN_upld_cert'] 		= $post['PLN_upld_cert'][$i];

				//$PLN_data['PLN_status'] 		= '1';
				if($post['PLN_status'][$i]=='-1'){
				$PLN_data['PLN_status']   = '1';
				} else {
				$PLN_data['PLN_status']  = '1';
				}
				/* if($PLN_files['name'][$i] != '')

				{

					$PLN_No = $i+1;
					$PLN_No	=	$post['current_line_task_PLN_ids'][$i];
					$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS.$vendorname.DS.'PLN_'.$PLN_No.DS;

					// Remove all the files in folder if they exist
					jimport('joomla.client.helper');
					if(is_dir($base_Dir))
					{
						$files = JFolder::files($base_Dir, '.', false, true, array());
						if (!empty($files)) {
								jimport('joomla.filesystem.file');
								if (JFile::delete($files) !== true) {
										// JFile::delete throws an error
										return false;
								}
						}
					}
					JFolder::create( $base_Dir );

					$PLN_files['name'][$i] = str_replace(" ", "_", $PLN_files['name'][$i]);
					$PLN_files['name'][$i] = str_replace("%", "_", $PLN_files['name'][$i]);
					$PLN_files['name'][$i] = str_replace("#", "_", $PLN_files['name'][$i]);
					$PLN_files['name'][$i] = str_replace("&", "_", $PLN_files['name'][$i]);
					$PLN_files['name'][$i] = str_replace(",", "_", $PLN_files['name'][$i]);
					$PLN_files['name'][$i] = str_replace("`", "_", $PLN_files['name'][$i]);
					$PLN_files['name'][$i] = str_replace("'", "_", $PLN_files['name'][$i]);
					$PLN_files['name'][$i] = str_replace("\\", "_", $PLN_files['name'][$i]);
					$PLN_files['name'][$i] = str_replace(":", "_", $PLN_files['name'][$i]);
					$PLN_files['name'][$i] = str_replace("?", "_", $PLN_files['name'][$i]);
					$PLN_files['name'][$i] = str_replace("<", "_", $PLN_files['name'][$i]);
					$PLN_files['name'][$i] = str_replace(">", "_", $PLN_files['name'][$i]);
					$PLN_files['name'][$i] = str_replace("/", "_", $PLN_files['name'][$i]);
					$PLN_files['name'][$i] = str_replace("//", "_", $PLN_files['name'][$i]);
					$PLN_files['name'][$i] = ereg_replace("/", "_", $PLN_files['name'][$i]);

					$PLN_data['PLN_upld_cert'] = $PLN_files['name'][$i];

					$PLN_data['PLN_folder_id'] 		=	$PLN_No;

					$filepath = $base_Dir .$PLN_files['name'][$i];

					move_uploaded_file($PLN_files['tmp_name'][$i], $filepath);

					$PLN_arr[$p] = '<a href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&vndr='.$user->id.'&doc=PLN_'.$PLN_No.'&filename='.$PLN_files["name"][$i] .'">'.$PLN_files["name"][$i] .'</a>';

						$p++;

				}
*/
				if($PLN_data['id']	== '')

				{

				$PLN_data['PLN_date_verified']  = '0000-00-00';

				}

				//echo "<pre>"; print_r($PLN_data);
				$addp = $i + 1 ;
				if($saveddoc == 'PLN'.$addp){
				$PLN_data['saveddate']    = date('Y-m-d');
				$PLN_data['PLN_date_verified']  = '0000-00-00';
                               // $saveddoc1='PLN';
                                 $mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
		$msg = "SELECT introtext  FROM #__content where id='267'";
		$db->setQuery($msg);
		$msg = $db->loadResult();
		$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
		$db->setQuery($vendor_company);
		$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                
            
                 
                     $data=  'Professional License - '.$addp.' has been updated by '.$vcompanyv.'. Please verify document and information submitted.';
                 $data1=  'Professional License - '.$addp;
                 
		$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('Professional License - '.$addp.'',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				//code to send mail to camassistant admin
				/********************************************************************/
				
				//Sending emails to vendor cc persons
				$db = JFactory::getDBO();
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
				$listcc = $cclist[$c];
				if($listcc){
				$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
				}
				}
		//To send the mail to support team
		if( $user->subscribe_type != 'free'){
		$subject = 'A Vendor`s Compliance Document has been updated';
		$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>
MyVendorCenter.com';
		$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
		$msg = str_replace('{DOCUMENT}', 'Professional License - '.$addp.'', $msg);		
		$msg = str_replace('{VENDOR}', $vcompanyv, $msg);
		$to_sateesh = "sk4576@gmail.com";
		$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
		$to_support = "documents@myvendorcenter.com";
		$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
        }        
				}	
				else{
				$olddate ="select saveddate, PLN_date_verified from #__cam_vendor_vendor_professional_license Where id =".$post['old_line_task_PLN_ids'][$i];
				$db->setQuery($olddate);
				$PLN_datasaved = $db->loadObject();
				$PLN_data['saveddate'] = $PLN_datasaved->saveddate;
				$PLN_data['PLN_date_verified'] = $PLN_datasaved->PLN_date_verified;
				}
				
		if(($PLN_data['PLN_expdate']!='' && $PLN_data['PLN_expdate']!='--') || $PLN_data['PLN_state'] != '' || $PLN_data['PLN_type'] != '' ) 
				{
				$model->store_vendor_PLN_compliances_info($PLN_data);
				}
		}
//exit;


		/***************************************************************GLI CODE*********************************************************************/

		$GLI_files		= JRequest::getVar('GLI_upld_cert','','files','array' );
//echo '<pre>'; print_r($post); 
		for($i=0,$g=0; $i<count($post['old_line_task_GLI_ids']); $i++)

		{

				//code to store GLI data

				$GLI_data['id']						= $post['old_line_task_GLI_ids'][$i];

				$GLI_data['vendor_id']				= $user->id;

				$GLI_data['GLI_name'] 				= $post['GLI_name'][$i];

				$GLI_data['GLI_policy'] 			= $post['GLI_policy'][$i];

				$date = explode('-',$post['GLI_start_date'][$i]);

				$GLI_data['GLI_start_date'] 		= $date[2].'-'.$date[0].'-'.$date[1];

				$date = explode('-',$post['GLI_end_date'][$i]);

				$GLI_data['GLI_end_date'] 			= $date[2].'-'.$date[0].'-'.$date[1];

				$GLI_data['GLI_agent_first_name'] 	= $post['GLI_agent_first_name'][$i];

				$GLI_data['GLI_agent_last_name'] 	= $post['GLI_agent_last_name'][$i];

				$GLI_data['GLI_phone_number'] 		= $post['GLI_phone1'][$i].'-'.$post['GLI_phone2'][$i].'-'.$post['GLI_phone3'][$i];

				$GLI_data['GLI_policy_aggregate'] 	= str_replace(",","",$post['GLI_policy_aggregate'][$i]);

				$GLI_data['GLI_policy_occurence']	= str_replace(",","",$post['GLI_policy_occurence'][$i]);

				//$GLI_data['GLI_upld_cert'] 			= $post['GLI_upld_cert'][$i];
				if($post['GLI_status'][$i]=='-1'){
				$GLI_data['GLI_status'] = '1';
				} else {
				$GLI_data['GLI_status'] = '1';
				}

				/* if($GLI_files['name'][$i] != '')

				{

					//code to update image filed in vendors table

					//code to move image to folderpath

					//$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS;

					$GLI_No = $i+1;

					$GLI_No	=	$post['current_line_task_GLI_ids'][$i];

		  			$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS.$vendorname.DS.'GLI_'.$GLI_No.DS;

					jimport('joomla.client.helper');
					if(is_dir($base_Dir))
					{
						$files = JFolder::files($base_Dir, '.', false, true, array());
						if (!empty($files)) {
								jimport('joomla.filesystem.file');
								if (JFile::delete($files) !== true) {
										// JFile::delete throws an error
										return false;
								}
						}
					}

			   		JFolder::create( $base_Dir );

					$GLI_files['name'][$i] = str_replace(" ", "_", $GLI_files['name'][$i]);
					$GLI_files['name'][$i] = str_replace("%", "_", $GLI_files['name'][$i]);
					$GLI_files['name'][$i] = str_replace("#", "_", $GLI_files['name'][$i]);
					$GLI_files['name'][$i] = str_replace("&", "_", $GLI_files['name'][$i]);
					$GLI_files['name'][$i] = str_replace(",", "_", $GLI_files['name'][$i]);
					$GLI_files['name'][$i] = str_replace("`", "_", $GLI_files['name'][$i]);
					$GLI_files['name'][$i] = str_replace("'", "_", $GLI_files['name'][$i]);
					$GLI_files['name'][$i] = str_replace("\\", "_", $GLI_files['name'][$i]);
					$GLI_files['name'][$i] = str_replace(":", "_", $GLI_files['name'][$i]);
					$GLI_files['name'][$i] = str_replace("?", "_", $GLI_files['name'][$i]);
					$GLI_files['name'][$i] = str_replace("<", "_", $GLI_files['name'][$i]);
					$GLI_files['name'][$i] = str_replace(">", "_", $GLI_files['name'][$i]);
					$GLI_files['name'][$i] = str_replace("/", "_", $GLI_files['name'][$i]);
					$GLI_files['name'][$i] = str_replace("//", "_", $GLI_files['name'][$i]);
					$GLI_files['name'][$i] = ereg_replace("/", "_", $GLI_files['name'][$i]);

					$GLI_data['GLI_upld_cert'] 			= $GLI_files['name'][$i];

					$GLI_data['GLI_folder_id'] 		=	$GLI_No;

					$filepath = $base_Dir .$GLI_files['name'][$i];

					move_uploaded_file($GLI_files['tmp_name'][$i], $filepath);

					$GLI_arr[$g] = '<a href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&vndr='.$user->id.'&doc=GLI_'.$GLI_No.'&filename='.$GLI_files["name"][$i] .'">'.$GLI_files["name"][$i] .'</a>';

					$g++;

				}
*/
				if($GLI_data['id']	== '')
				{
				$GLI_data['GLI_date_verified'] = '0000-00-00';
				}
				
				 $addg = $i + 1 ;
				if($saveddoc == 'GLI'.$addg){
                                   
				$GLI_data['saveddate']    = date('Y-m-d');
				$GLI_data['GLI_date_verified'] = '0000-00-00';
                               // $saveddoc1='GLI';
                                $mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
		$msg = "SELECT introtext  FROM #__content where id='267'";
		$db->setQuery($msg);
		$msg = $db->loadResult();
		$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
		$db->setQuery($vendor_company);
		$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                
            
                 
                      $data=  'General Liability Policy - '.$addg.' Document Updated has been updated by '.$vcompanyv.'. Please verify document and information submitted.';
               $data1=  'General Liability Policy - '.$addg;
               
		$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('General Liability Policy - '.$addg.'',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				//code to send mail to camassistant admin
				/********************************************************************/
				
				//Sending emails to vendor cc persons
				$db = JFactory::getDBO();
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
				$listcc = $cclist[$c];
				if($listcc){
				$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
				}
				}
		//To send the mail to support team
		if( $user->subscribe_type != 'free'){
		$subject = 'A Vendor`s Compliance Document has been updated';
		$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>
MyVendorCenter.com';
		$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
		$msg = str_replace('{DOCUMENT}', 'General Liability Policy - '.$addg.'', $msg);		
		$msg = str_replace('{VENDOR}', $vcompanyv, $msg);
		$to_sateesh = "sk4576@gmail.com";
		$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
		$to_support = "documents@myvendorcenter.com"; 
		$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
        }        
				}	
				else{
				$olddate ="select saveddate, GLI_date_verified from #__cam_vendor_liability_insurence Where id =".$post['old_line_task_GLI_ids'][$i];
				$db->setQuery($olddate);
				$GLI_datasaved = $db->loadObject();
				$GLI_data['saveddate'] = $GLI_datasaved->saveddate;
				$GLI_data['GLI_date_verified'] = $GLI_datasaved->GLI_date_verified;
				}
				
				//For master completed by sateesh
				$GLI_data['GLI_med']	= str_replace(",","",$post['GLI_med'][$i]);
				$GLI_data['GLI_injury']	= str_replace(",","",$post['GLI_injury'][$i]);
				$GLI_data['GLI_products']	= str_replace(",","",$post['GLI_products'][$i]);
				$GLI_applies = JRequest::getVar('GLI_applies'.$i);
				$GLI_data['GLI_applies']	= $GLI_applies;
				$GLI_data['GLI_damage']	= str_replace(",","",$post['GLI_damage'][$i]);
				$GLI_primary = JRequest::getVar('GLI_primary'.$i);
				
				if($GLI_primary)
				$GLI_primary = $GLI_primary ;
				else
				$GLI_primary = '';
				
				$GLI_data['GLI_primary']	= $GLI_primary;
				$GLI_waiver = JRequest::getVar('GLI_waiver'.$i);
				
				if($GLI_waiver)
				$GLI_waiver = $GLI_waiver ;
				else
				$GLI_waiver = '';
				
				$GLI_data['GLI_waiver']	= $GLI_waiver;
				$GLI_occur = JRequest::getVar('GLI_occur'.$i);
				
				if($GLI_occur)
				$GLI_occur = $GLI_occur ;
				else
				$GLI_occur = '';
				
				$GLI_data['GLI_occur']	= $GLI_occur;
				$GLI_certholder = JRequest::getVar('GLI_certholder'.$i);
				$GLI_data['GLI_certholder']	= $GLI_certholder;
				$GLI_additional = JRequest::getVar('GLI_additional'.$i);
				$GLI_data['GLI_additional']	= $GLI_additional;

				//Master completed by sateesh

if(($GLI_data['GLI_end_date']!='' && $GLI_data['GLI_end_date']!='--') || ($GLI_data['GLI_policy_aggregate'] != '' && $GLI_data['GLI_policy_aggregate'] != '0.00') || ($GLI_data['GLI_policy_occurence'] != '' && $GLI_data['GLI_policy_occurence'] != '0.00') ) 
				{
				$model->store_vendor_GLI_compliances_info($GLI_data);
				}

		} //exit;

		/***************************************************************WCI CODE*********************************************************************/

		$WC_files		= JRequest::getVar('wc_upld_cert','','files','array' );

		for($i=0,$wc=0; $i<count($post['old_line_task_wc_ids']); $i++)

		{

			//code to store WCI data

				$WC_data['id']						= $post['old_line_task_wc_ids'][$i];

				$WC_data['vendor_id']				= $user->id;


				$date = explode('-',$post['wc_end_date'][$i]);

				$WC_data['wc_end_date'] 			= $date[2].'-'.$date[0].'-'.$date[1];


				//$WC_data['wc_upld_cert'] 			= $post['wc_upld_cert'][$i];

				//$WC_data['wc_date_verified'] 		= $post['wc_date_verified'][$i];

				//$WC_data['wc_status'] 			= '1';
				if($post['wc_status'][$i]=='-1'){
				$WC_data['wc_status']   = '1';
				} else {
				$WC_data['wc_status']   = '1';
				}
			/*	if($WC_files['name'][$i]!= '')

					{

						//code to update image filed in vendors table

						//code to move image to folderpath

						//$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS;

						$WC_No = $i+1;

						$WC_No	=	$post['current_line_task_WC_ids'][$i];

		  				$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS.$vendorname.DS.'WC_'.$WC_No.DS;

						jimport('joomla.client.helper');
						if(is_dir($base_Dir))
						{
							$files = JFolder::files($base_Dir, '.', false, true, array());
							if (!empty($files)) {
									jimport('joomla.filesystem.file');
									if (JFile::delete($files) !== true) {
											// JFile::delete throws an error
											return false;
									}
							}
						}

			    		JFolder::create( $base_Dir );

						$WC_files['name'][$i] = str_replace(" ", "_", $WC_files['name'][$i]);
						$WC_files['name'][$i] = str_replace("%", "_", $WC_files['name'][$i]);
						$WC_files['name'][$i] = str_replace("#", "_", $WC_files['name'][$i]);
						$WC_files['name'][$i] = str_replace("&", "_", $WC_files['name'][$i]);
						$WC_files['name'][$i] = str_replace(",", "_", $WC_files['name'][$i]);
						$WC_files['name'][$i] = str_replace("`", "_", $WC_files['name'][$i]);
						$WC_files['name'][$i] = str_replace("'", "_", $WC_files['name'][$i]);
						$WC_files['name'][$i] = str_replace("\\", "_", $WC_files['name'][$i]);
						$WC_files['name'][$i] = str_replace(":", "_", $WC_files['name'][$i]);
						$WC_files['name'][$i] = str_replace("?", "_", $WC_files['name'][$i]);
						$WC_files['name'][$i] = str_replace("<", "_", $WC_files['name'][$i]);
						$WC_files['name'][$i] = str_replace(">", "_", $WC_files['name'][$i]);
						$WC_files['name'][$i] = str_replace("/", "_", $WC_files['name'][$i]);
						$WC_files['name'][$i] = ereg_replace("/", "_", $WC_files['name'][$i]);
						$WC_files['name'][$i] = str_replace("//", "_", $WC_files['name'][$i]);

						$WC_data['wc_upld_cert'] 		= $WC_files['name'][$i];

						$WC_data['wc_folder_id'] 		=	$WC_No;

						$filepath = $base_Dir .$WC_files['name'][$i];

						move_uploaded_file($WC_files['tmp_name'][$i], $filepath);

						$WC_arr[$w] = '<a href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&vndr='.$user->id.'&doc=WC_'.$WC_No.'&filename='.$WC_files["name"][$i] .'">'.$WC_files["name"][$i] .'</a>';

					$w++;

					} */

				if($WC_data['id']	== '')
				{
				$WC_data['wc_date_verified'] 		= '0000-00-00';
				}


				//echo '<pre>'; print_r($WC_data); //exit;
				//echo "<pre>"; print_r($WC_data);
				//if($WC_data['wc_end_date'] != '')
				//{ $model->store_vendor_WC_compliances_info($WC_data); }
				$addw = $i + 1 ;
				if($saveddoc == 'WC'.$addw){
				$WC_data['saveddate']    = date('Y-m-d');
				$WC_data['wc_date_verified'] 		= '0000-00-00';
                                //$saveddoc1='WC';
                                  $mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
		$msg = "SELECT introtext  FROM #__content where id='267'";
		$db->setQuery($msg);
		$msg = $db->loadResult();
		$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
		$db->setQuery($vendor_company);
		$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                
            
                 
                     $data=  'Workers Comp Exemption Form - '.$addw.' Document Updated has been updated by '.$vcompanyv.'. Please verify document and information submitted.';
                $data1=  'Workers Comp Exemption Form - '.$addw;
                
		$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('Workers Comp Exemption Form - '.$addw.'',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				//code to send mail to camassistant admin
				/********************************************************************/
				
				//Sending emails to vendor cc persons
				$db = JFactory::getDBO();
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
				$listcc = $cclist[$c];
				if($listcc){
				$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
				}
				}
		//To send the mail to support team
		if( $user->subscribe_type != 'free'){
		$subject = 'A Vendor`s Compliance Document has been updated';
		$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>
MyVendorCenter.com';
		$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
		$msg = str_replace('{DOCUMENT}', 'Workers Comp Exemption Form - '.$addw.'', $msg);		
		$msg = str_replace('{VENDOR}', $vcompanyv, $msg);
		$to_sateesh = "sk4576@gmail.com";
		$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
		$to_support = "documents@myvendorcenter.com"; 
		$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
         }       
				}	
				else{
				$olddate ="select saveddate, wc_date_verified from #__cam_vendor_workers_compansation Where id =".$post['old_line_task_wc_ids'][$i];
				$db->setQuery($olddate);
				$WC_datasaved = $db->loadObject();
				$WC_data['saveddate'] = $WC_datasaved->saveddate;
				$WC_data['wc_date_verified'] = $WC_datasaved->wc_date_verified;
				}
						if($WC_data['wc_end_date']!='' && $WC_data['wc_end_date']!='--')  
							{
                            $model->store_vendor_WC_compliances_info($WC_data);
							}

		 } //exit;

$WCI_files		= JRequest::getVar('WCI_upld_cert','','files','array' );

		for($i=0,$w=0; $i<count($post['old_line_task_WCI_ids']); $i++)


		{

			//code to store WCI data

				$WCI_data['id']						= $post['old_line_task_WCI_ids'][$i];

				$WCI_data['vendor_id']				= $user->id;

				$WCI_data['WCI_name'] 				= $post['WCI_name'][$i];

				$WCI_data['WCI_policy'] 			= $post['WCI_policy'][$i];
				
				$date = explode('-',$post['WCI_start_date'][$i]);
				$WCI_data['WCI_start_date'] 		= $date[2].'-'.$date[0].'-'.$date[1];
				if (strpos($post['WCI_end_date'][$i], 'Does Not Expire') !== false){
				$WCI_data['WCI_end_date'] 		= 'Does Not Expire';
				}
				else{
				$date = explode('-',$post['WCI_end_date'][$i]);
				$WCI_data['WCI_end_date'] 			= $date[2].'-'.$date[0].'-'.$date[1];
				}
				$WCI_data['WCI_agent_first_name'] 	= $post['WCI_agent_first_name'][$i];

				$WCI_data['WCI_agent_last_name'] 	= $post['WCI_agent_last_name'][$i];

				$WCI_data['WCI_phone_number'] 		= $post['WCI_phone1'][$i].'-'.$post['WCI_phone2'][$i].'-'.$post['WCI_phone3'][$i];

				//$WCI_data['WCI_upld_cert'] 			= $post['WCI_upld_cert'][$i];

				//$WCI_data['WCI_date_verified'] 		= $post['WCI_date_verified'][$i];

			//	$WCI_data['WCI_status'] 			= '1';
			if($post['WCI_status'][$i]=='-1'){
				$WCI_data['WCI_status']   = '1';
				} else {
				$WCI_data['WCI_status']   = '1';
				}
				if($post['excemption'][$i]){
				$WCI_data['excemption'] 			= $post['excemption'][$i];
				} else {
				$WCI_data['excemption'] ='0';
				}

				if($GLI_data['id']	== '')
				{
				$WCI_data['WCI_date_verified'] 		= '0000-00-00';
				}

				
				$add = $i + 1 ;
				if($saveddoc == 'WCI'.$add){
				$WCI_data['saveddate']    = date('Y-m-d');
				$WCI_data['WCI_date_verified'] 		= '0000-00-00';
                               // $saveddoc1='WCI';
                                 $mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
		$msg = "SELECT introtext  FROM #__content where id='267'";
		$db->setQuery($msg);
		$msg = $db->loadResult();
		$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
		$db->setQuery($vendor_company);
		$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                
            
                 
                     $data=  "Workers Compensation / Employer's Liabilty Policy - ".$add." Document Updated has been updated by ".$vcompanyv.". Please verify document and information submitted.";
                 $data1=  "Workers Compensation / Employer's Liabilty Policy - ".$add;
                 
		$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('Workers Compensation Policy - '.$add.'',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				//code to send mail to camassistant admin
				/********************************************************************/
				
				//Sending emails to vendor cc persons
				$db = JFactory::getDBO();
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
				$listcc = $cclist[$c];
				if($listcc){
				$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
				}
				}
		//To send the mail to support team
		if( $user->subscribe_type != 'free'){
		$subject = 'A Vendor`s Compliance Document has been updated';
		$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>
MyVendorCenter.com';
		$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
		$msg = str_replace('{DOCUMENT}', 'Workers Compensation Policy - '.$add.'', $msg);		
		$msg = str_replace('{VENDOR}', $vcompanyv, $msg);	
		$to_sateesh = "sk4576@gmail.com";
		$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
				$to_support = "documents@myvendorcenter.com"; 
                //$to_support = "vendoremails@myvendorcenter.com";
		$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
		}
				}	
				else{
				$olddate ="select saveddate, WCI_date_verified from #__cam_vendor_workers_companies_insurance Where id =".$post['old_line_task_WCI_ids'][$i];
				$db->setQuery($olddate);
				$WCI_datasaved = $db->loadObject();
				$WCI_data['saveddate'] = $WCI_datasaved->saveddate;
				$WCI_data['saveddate'] = $WCI_datasaved->WCI_date_verified;
				}
				
				//For master completed by sateesh
				$WCI_data['WCI_disease']	= str_replace(",","",$post['WCI_disease'][$i]);
				$WCI_data['WCI_disease_policy']	= str_replace(",","",$post['WCI_disease_policy'][$i]);
				$WCI_data['WCI_each_accident']	= str_replace(",","",$post['WCI_each_accident'][$i]);
				$WCI_waiver = JRequest::getVar('WCI_waiver'.$i);
				if($WCI_waiver)
				$WCI_waiver = $WCI_waiver ;
				else
				$WCI_waiver = '';
				$WCI_data['WCI_waiver']	= $WCI_waiver;
				$WCI_cert = JRequest::getVar('WCI_cert'.$i);
				$WCI_data['WCI_cert']	= $WCI_cert;
				//Master completed by sateesh
				
						if($WCI_data['WCI_end_date']!='' && $WCI_data['WCI_end_date']!='--')  
							{
                                $model->store_vendor_WCI_compliances_info($WCI_data);
							}

		 }


		$OMI_files		= JRequest::getVar('OMI_upld_cert','','files','array' );

		for($i=0,$w=0; $i<count($post['old_line_task_OMI_ids']); $i++)


		{

			//code to store WCI data

				$OMI_data['id']						= $post['old_line_task_OMI_ids'][$i];
				$OMI_data['vendor_id']				= $user->id;
				$date = explode('-',$post['OMI_start_date'][$i]);
				$OMI_data['OMI_start_date'] 		= $date[2].'-'.$date[0].'-'.$date[1];
				$date = explode('-',$post['OMI_end_date'][$i]);
				$OMI_data['OMI_end_date'] 			= $date[2].'-'.$date[0].'-'.$date[1];
				
				if($OMI_data['id']	== '')
				{
				$OMI_data['OMI_date_verified'] 		= '0000-00-00';
				}
				
			if($post['OMI_status'][$i]=='-1'){
				$OMI_data['OMI_status']   = '1';
				} else {
				$OMI_data['OMI_status']   = '1';
				}
				if($post['excemption'][$i]){
				$OMI_data['excemption'] 			= $post['excemption'][$i];
				} else {
				$OMI_data['excemption'] ='0';
				}

				

				
				$add = $i + 1 ;
				if($saveddoc == 'OMI'.$add){
				$OMI_data['saveddate']    = date('Y-m-d');
				$OMI_data['OMI_date_verified'] 		= '0000-00-00';
                               // $saveddoc1='WCI';
                $mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
		$msg = "SELECT introtext  FROM #__content where id='267'";
		$db->setQuery($msg);
		$msg = $db->loadResult();
		$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
		$db->setQuery($vendor_company);
		$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                
            
                 
                     $data=  "ERRORS & OMISSIONS INSURANCE - ".$add." Document Updated has been updated by ".$vcompanyv.". Please verify document and information submitted.";
                 $data1=  "ERRORS & OMISSIONS INSURANCE - ".$add;
                 
		$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('ERRORS & OMISSIONS INSURANCE - '.$add.'',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				//code to send mail to camassistant admin
				/********************************************************************/
				
				//Sending emails to vendor cc persons
				$db = JFactory::getDBO();
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
				$listcc = $cclist[$c];
				if($listcc){
				$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
				}
				}
		//To send the mail to support team
		if( $user->subscribe_type != 'free'){
		$subject = 'A Vendor`s Compliance Document has been updated';
		$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>
MyVendorCenter.com';
		$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
		$msg = str_replace('{DOCUMENT}', 'Workers Compensation Policy - '.$add.'', $msg);		
		$msg = str_replace('{VENDOR}', $vcompanyv, $msg);	
		$to_sateesh = "sk4576@gmail.com";
		$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
				$to_support = "documents@myvendorcenter.com"; 
                //$to_support = "vendoremails@myvendorcenter.com";
		$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
		}
				}	
				else{
				$olddate ="select saveddate, OMI_date_verified from #__cam_vendor_errors_omissions_insurance Where id =".$post['old_line_task_OMI_ids'][$i];
				$db->setQuery($olddate);
				$OMI_datasaved = $db->loadObject();
				$OMI_data['saveddate'] = $OMI_datasaved->saveddate;
				$OMI_data['saveddate'] = $OMI_datasaved->OMI_date_verified;
				}
				
				//For master completed by sateesh
				$OMI_data['OMI_aggregate']						= $post['OMI_aggregate'][$i];
				$OMI_data['OMI_aggregate']	= str_replace(",","",$post['OMI_aggregate'][$i]);
				$OMI_data['OMI_each_claim']						= $post['OMI_each_claim'][$i];
				$OMI_data['OMI_each_claim']	= str_replace(",","",$post['OMI_each_claim'][$i]);
				$OMI_cert = JRequest::getVar('OMI_cert'.$i);
				$OMI_data['OMI_cert']	= $OMI_cert;
				//Master completed by sateesh
				//echo "<pre>"; print_r($OMI_data); exit;
						if($OMI_data['OMI_end_date']!='' && $OMI_data['OMI_end_date']!='--')  
							{
                            	$model->store_vendor_OMI_compliances_info($OMI_data);
							}

		 }



		$aip_files		= JRequest::getVar('aip_upld_cert','','files','array' );
		
		for($i=0,$w=0; $i<count($post['old_line_task_aip_ids']); $i++)

		{

			//code to store WCI data

				$aip_data['id']						= $post['old_line_task_aip_ids'][$i];

				$aip_data['vendor_id']				= $user->id;

				$aip_data['aip_name'] 				= $post['aip_name'][$i];

				$aip_data['aip_policy'] 			= $post['aip_policy'][$i];

				$date = explode('-',$post['aip_start_date'][$i]);

				$aip_data['aip_start_date'] 		= $date[2].'-'.$date[0].'-'.$date[1];

				$date = explode('-',$post['aip_end_date'][$i]);

				$aip_data['aip_end_date'] 			= $date[2].'-'.$date[0].'-'.$date[1];

				$aip_data['aip_agent_first_name'] 	= $post['aip_agent_first_name'][$i];

				$aip_data['aip_agent_last_name'] 	= $post['aip_agent_last_name'][$i];

				$aip_data['aip_phone_number'] 		= $post['aip_phone1'][$i].'-'.$post['aip_phone2'][$i].'-'.$post['aip_phone3'][$i];

				//$WCI_data['WCI_upld_cert'] 			= $post['WCI_upld_cert'][$i];

				//$WCI_data['WCI_date_verified'] 		= $post['WCI_date_verified'][$i];

			//	$WCI_data['WCI_status'] 			= '1';
			if($post['aip_status'][$i]=='-1'){
				$aip_data['aip_status']   = '1';
				} else {
				$aip_data['aip_status']   = '1';
				}
				if($post['excemption'][$i]){
				$aip_data['excemption'] 			= $post['excemption'][$i];
				} else {
				$aip_data['excemption'] ='0';
				}
				//echo '<pre>'; print_r($aip_data); exit;
				$adda = $i + 1 ;
				if($saveddoc == 'AIP'.$adda){
				$aip_data['saveddate']    = date('Y-m-d');
				$aip_data['aip_date_verified'] 		= '0000-00-00';
                               // $saveddoc1='AIP';
                                 $mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
                                
		$msg = "SELECT introtext  FROM #__content where id='267'";
		$db->setQuery($msg);
		$msg = $db->loadResult();
		$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
		$db->setQuery($vendor_company);
		$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                
            
                 
                     $data=  'Commercial Vehicle Policy - '.$adda.' Document Updated has been updated by '.$vcompanyv.'. Please verify document and information submitted.';
                 $data1=  'Commercial Vehicle Policy - '.$adda;
		$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('Commercial Vehicle Policy - '.$adda.'',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				//code to send mail to camassistant admin
				/********************************************************************/
				
				//Sending emails to vendor cc persons
				$db = JFactory::getDBO();
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
				$listcc = $cclist[$c];
				if($listcc){
				$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
				}
				}
		//To send the mail to support team
		if( $user->subscribe_type != 'free'){
		$subject = 'A Vendor`s Compliance Document has been updated';
		$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>
MyVendorCenter.com';
		$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
		$msg = str_replace('{DOCUMENT}', 'Commercial Vehicle Policy - '.$adda.'', $msg);		
		$msg = str_replace('{VENDOR}', $vcompanyv, $msg);
		$to_sateesh = "sk4576@gmail.com";
		$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
		$to_support = "documents@myvendorcenter.com"; 
		$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
		}
				}	
				else{
				$olddate ="select saveddate, aip_date_verified from #__cam_vendor_auto_insurance Where id =".$post['old_line_task_aip_ids'][$i];
				$db->setQuery($olddate);
				$aip_datasaved = $db->loadObject();
				$aip_data['saveddate'] = $aip_datasaved->saveddate;
				$aip_data['aip_date_verified'] = $aip_datasaved->aip_date_verified;
				}
				
				//For master completed by sateesh
				$aip_data['aip_bodily']	= str_replace(",","",$post['aip_bodily'][$i]);
				$aip_data['aip_combined']	= str_replace(",","",$post['aip_combined'][$i]);
				$aip_data['aip_body_injury']	= str_replace(",","",$post['aip_body_injury'][$i]);
				$aip_data['aip_property']	= str_replace(",","",$post['aip_property'][$i]);
				$aip_cert = JRequest::getVar('aip_cert'.$i);
				$aip_data['aip_cert']	= $aip_cert;
				$aip_primary = JRequest::getVar('aip_primary'.$i);

				if($aip_primary)
				$aip_primary = $aip_primary ;
				else
				$aip_primary = '';
				
				$aip_data['aip_primary']	= $aip_primary;
				$aip_waiver = JRequest::getVar('aip_waiver'.$i);
				
				if($aip_waiver)
				$aip_waiver = $aip_waiver ;
				else
				$aip_waiver = '';
				
				$aip_data['aip_waiver']	= $aip_waiver;
				$aip_addition = JRequest::getVar('aip_addition'.$i);
				$aip_data['aip_addition']	= $aip_addition;
				
				
				$aip_applies_any = JRequest::getVar('aip_applies_any'.$i);
				$aip_data['aip_applies_any']	= $aip_applies_any;
				if($aip_data['aip_applies_any'])
				$aip_data['aip_applies_any'] = $aip_data['aip_applies_any'] ;
				else
				$aip_data['aip_applies_any'] = '';
				$aip_applies_owned = JRequest::getVar('aip_applies_owned'.$i);
				$aip_data['aip_applies_owned']	= $aip_applies_owned;
				if($aip_data['aip_applies_owned'])
				$aip_data['aip_applies_owned'] = $aip_data['aip_applies_owned'] ;
				else
				$aip_data['aip_applies_owned'] = '';
				$aip_applies_nonowned = JRequest::getVar('aip_applies_nonowned'.$i);
				$aip_data['aip_applies_nonowned']	= $aip_applies_nonowned;
				if($aip_data['aip_applies_nonowned'])
				$aip_data['aip_applies_nonowned'] = $aip_data['aip_applies_nonowned'] ;
				else
				$aip_data['aip_applies_nonowned'] = '';
				$aip_applies_hired = JRequest::getVar('aip_applies_hired'.$i);
				$aip_data['aip_applies_hired']	= $aip_applies_hired;
				if($aip_data['aip_applies_hired'])
				$aip_data['aip_applies_hired'] = $aip_data['aip_applies_hired'] ;
				else
				$aip_data['aip_applies_hired'] = '';
				$aip_applies_scheduled = JRequest::getVar('aip_applies_scheduled'.$i);
				$aip_data['aip_applies_scheduled']	= $aip_applies_scheduled;
				if($aip_data['aip_applies_scheduled'])
				$aip_data['aip_applies_scheduled'] = $aip_data['aip_applies_scheduled'] ;
				else
				$aip_data['aip_applies_scheduled'] = '';
				//Master completed by sateesh
				
				if($aip_data['aip_end_date']!='' && $aip_data['aip_end_date']!='--')  
					{
						$model->store_vendor_aip_compliances_info($aip_data);
					}
		}
		
			//Started saving Umbrella docs
		$UMB_files		= JRequest::getVar('UMB_upld_cert','','files','array' );
   // echo '<pre>'; print_r($post); exit;
		for($i=0; $i<count($post['old_line_task_UMB_ids']); $i++)
		{
				$UMB_data['id']					= $post['old_line_task_UMB_ids'][$i];
				$UMB_data['vendor_id']			= $user->id;
				$UMB_data['UMB_license'] 		= $post['UMB_license'][$i];
				$date = explode('-',$post['UMB_expdate'][$i]);
				$UMB_data['UMB_expdate']		= $date[2].'-'.$date[0].'-'.$date[1];
				$UMB_data['UMB_city_country'] 	= '';
				//$OLN_data['OLN_upld_cert'] 		= $post['OLN_upld_cert'][$i];
				$UMB_data['UMB_state'] 			= '';
				//$OLN_data['OLN_status'] 		= '1';
				if($post['UMB_status'][$i]=='-1'){
				$UMB_data['UMB_status']  = '1';
				} else {
				$UMB_data['UMB_status']  = '1';
				}
                              // $date8 = date('Y-m-d');
				if($UMB_data['id']	== '')
				{
				$UMB_data['UMB_date_verified']	= '0000-00-00';
				//} else {
                               // $OLN_data['OLN_date_verified']	= $date8;
                  }

				//echo "<pre>"; print_r($OLN_data); exit;
				//if($OLN_data['OLN_expdate'] != '' )
				$addo = $i + 1 ;
				if($saveddoc == 'UMB'.$addo){
				$UMB_data['saveddate']    = date('Y-m-d');
				$UMB_data['UMB_date_verified']	= '0000-00-00';
				$mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
				$msg = "SELECT introtext  FROM #__content where id='267'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
				$db->setQuery($vendor_company);
				$vcompanyv = $db->loadResult();
				$name=$user->name.' '.$user->lastname;
				$data=  'Umbrella Liability Policy - '.$addo.' Document Updated has been updated by '.$vcompanyv.'. Please verify document and information submitted.';
				$data1= 'Umbrella Liability Policy - '.$addo;
				$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data1, $msg);
				if( $user->subscribe_type == 'free'){
					$msg = $model->getmailbody_free('Umbrella Liability Policy - '.$addo.'',$vcompanyv);
				}
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				$support_to = 'vendoremails@myvendorcenter.com';
				$res = JUtility::sendMail($mailfrom, $from, $support_to, $subject, $msg, $mode=1);
				
				$db = JFactory::getDBO();
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
					$listcc = $cclist[$c];
						if($listcc){
							$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
						}
					}
				if( $user->subscribe_type != 'free'){
				$subject = 'A Vendor`s Compliance Document has been updated';
				$msg = "<p>Dear MyVendorCenter Support</p>".$data.'<br/><br/>At Your Service,<br/>
				MyVendorCenter.com';
				$msg = "SELECT introtext  FROM #__content where id='274'";
				$db->setQuery($msg);
				$msg = $db->loadResult();
				$msg = str_replace('{DOCUMENT}', 'Umbrella Liability Policy - '.$adda.'', $msg);		
				$msg = str_replace('{VENDOR}', $vcompanyv, $msg);
				$to_sateesh = "sk4576@gmail.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
				$to_support = "documents@myvendorcenter.com"; 
				$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);
				}
				}	
				else{
				$olddate ="select saveddate, UMB_date_verified from #__cam_vendor_umbrella_license Where id =".$post['old_line_task_UMB_ids'][$i];
				$db->setQuery($olddate);
				$UMB_datasaved = $db->loadObject();
				$UMB_data['saveddate'] = $UMB_datasaved->saveddate ;
				$UMB_data['UMB_date_verified'] = $UMB_datasaved->UMB_date_verified ;
				}

				//For master completed by sateesh
				$UMB_data['UMB_aggregate']	= str_replace(",","",$post['UMB_aggregate'][$i]);
				$UMB_data['UMB_occur']	= str_replace(",","",$post['UMB_occur'][$i]);
				$UMB_certholder = JRequest::getVar('umb_cert'.$i);
				$UMB_data['UMB_certholder']	= $UMB_certholder;

				//Master completed by sateesh
				
				if($UMB_data['UMB_expdate']!='' && $UMB_data['UMB_expdate']!='--') {
				$model->store_vendor_UMB_compliances_info($UMB_data);
				}
                              //  $model->store_vendor_OLN_compliances_info($OLN_data);

		}

		//Umbrella completed
		/***************************************************************W9 CODE*********************************************************************/

		$W9files		= JRequest::getVar('W9_upld_cert1','','files','array' );


		//if($W9files['name'] != '' || $post['ein_number'] != '')
			//{

				//code to update image filed in vendors table
				//code to move image to folderpath

				//$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS;

		  	/*	$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS.$vendorname.DS.'W9'.DS;

				jimport('joomla.client.helper');
				if(is_dir($base_Dir))
					{
						$files = JFolder::files($base_Dir, '.', false, true, array());
						if (!empty($files)) {
								jimport('joomla.filesystem.file');
								if (JFile::delete($files) !== true) {
										// JFile::delete throws an error
										return false;
								}
						}
					}

			    JFolder::create( $base_Dir );

				$W9files['name'] = str_replace(" ", "_", $W9files['name']);
				$W9files['name'] = str_replace("&", "_", $W9files['name']);
				$W9files['name'] = str_replace("#", "_", $W9files['name']);
				$W9files['name'] = str_replace("%", "_", $W9files['name']);
				$W9files['name'] = str_replace(",", "_", $W9files['name']);
				$W9files['name'] = str_replace("`", "_", $W9files['name']);
				$W9files['name'] = str_replace("'", "_", $W9files['name']);
				$W9files['name'] = str_replace("\\", "_", $W9files['name']);
				$W9files['name'] = str_replace(":", "_", $W9files['name']);
				$W9files['name'] = str_replace("?", "_", $W9files['name']);
				$W9files['name'] = str_replace("<", "_", $W9files['name']);
				$W9files['name'] = str_replace(">", "_", $W9files['name']);
				$W9files['name'] = str_replace("/", "_", $W9files['name']);
				$W9files['name'] = ereg_replace("/", "_", $W9files['name']);
				$W9files['name'] = str_replace("//", "_", $W9files['name']);



				$filepath = $base_Dir .$W9files['name'];

				move_uploaded_file($W9files['tmp_name'], $filepath);

				$W9_link = '<a href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&vndr='.$user->id.'&doc=W9&filename='.$W9files['name'].'">'.$W9files['name'].'</a>';
				//$W9_data['w9_upld_cert'] 			= $post['W9_upld_cert1'];
*/
				$W9_data['id']					= $post['W9_id'];
                                $W9_data['ein_number']				= $post['ein_number'];

				$W9_data['vendor_id']				= $user->id;
                                //$W9_data['w9_date_verified']			='0000-00-00';

				//$W9_data['w9_upld_cert'] = $W9files['name'];

				//$W9_data['w9_status'] 				= '1';
				if($post['w9_status']=='-1'){
				$W9_data['w9_status']    = '1';
				} else {
				$W9_data['w9_status']    = '1';
				}
				//echo "<pre>"; print_r($W9_data); exit;
				//if($W9_data['ein_number'] != ''){
				if($saveddoc == 'W9'){
				$W9_data['saveddate']    = date('Y-m-d');
				}	
				$model->store_vendor_compliance_w9docs_info($W9_data);
				//}

			//}

			//code to store W9 data



		// echo "<pre>"; print_r($W9_data); exit;


		/***************************************************************MAIL CODE*********************************************************************/
		if(count($OLN_arr)>0)

		$OLN_link = implode('<br/>',$OLN_arr);

		if(count($PLN_arr)>0)

		$PLN_link = implode('<br/>',$PLN_arr);

		if(count($WCI_arr)>0)

		$WCI_link = implode('<br/>',$WCI_arr);

		if(count($GLI_arr)>0)

		$GLI_link = implode('<br/>',$GLI_arr);
			//if($OLN_link != '' || $PLN_link != '' || $WCI_link != '' || $GLI_link !='' || $W9_link != '' )
			//{
				//code to send mail to vendor with uploaded docs
			/*	$mailfrom = 'support@myvendorcenter.com';
				$from  = 'MyVendorCenter.com';
				$to = $user->email;
				$subject = 'Your Compliance Document has been updated';
		$msg = "SELECT introtext  FROM #__content where id='267'";
		$db->setQuery($msg);
		$msg = $db->loadResult();
		$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
		$db->setQuery($vendor_company);
		$vcompanyv = $db->loadResult();
                $name=$user->name.' '.$user->lastname;
                
                if($saveddoc1=='GLI'){
                    $data=  'GENERAL LIABILITY POLICY Document Updated';
                } else if($saveddoc1=='AIP'){
                     $data=  'COMMERCIAL VEHICLE POLICY Document Updated';
                } else if($saveddoc1=='WCI'){
                     $data=  'WORKERS COMPENSATION POLICY Document Updated';
                } else if($saveddoc1=='OLN'){
                     $data=  'Bus. Tax Receipt / Occupational License Document Updated';
                } else if($saveddoc1=='PLN'){
                     $data=  'PROFESSIONAL LICENSE Document Updated';
                } else if($saveddoc1=='WC'){
                     $data=  'WORKERS COMP EXEMPTION FORM Document Updated';
                } 
		$msg = str_replace('[Company Name]', $vcompanyv, $msg);
                $msg = str_replace('[vendor name]', $name, $msg);
                $msg = str_replace('[document]', $data, $msg);
		
				$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $msg, $mode=1);
				//code to send mail to camassistant admin
				/********************************************************************
				
				//Sending emails to vendor cc persons
				$db = JFactory::getDBO();
				$query_cc ="select ccemail from #__users Where id =".$user->id;
				$db->setQuery($query_cc);
				$cc = $db->loadResult();
				$cclist = explode(';',$cc);
				for($c=0; $c<=count($cclist); $c++){
				$listcc = $cclist[$c];
				if($listcc){
				$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $msg, $mode=1);
				}
				}
		//To send the mail to support team
		$subject = 'A Vendor`s Compliance Document has been updated';
		$msg = "<p>Dear MyVendorCenter Support</p><p>A Compliance Documents has been updated by ".$vcompanyv.".  Please verify document and information submitted.</p><br/>".$name.'<br/>'.$data.'<br/><br/>At Your Service,<br/>
MyVendorCenter.com';
		//$to_sateesh = "sk4576@gmail.com";
		//$res = JUtility::sendMail($mailfrom, $from, $to_sateesh, $subject, $msg, $mode=1);
		$to_support = "support@myvendorcenter.com"; 
		$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $msg, $mode=1);*/
		//Completed		
		//	}
		$link = 'index.php?option=com_camassistant&controller=vendors&task=vendor_compliance_docs&Itemid='.$Itemid;
		$msg="Documents Saved Successfully";
		$this->setRedirect( $link,$msg );
	}

	

	//function to display all draft proposal

	function viewall_proposals()

	{

		JRequest::getVar('view','vendors');

	    parent::display();

	}

	

	//function to display vendor Dashboard

	function vendor_dashboard()

	{



		JRequest::getVar('view','vendors');

	    parent::display();

	}

	

	//function to display vendor_compliance_documents

	function vendor_compliance_docs()

	{

		JRequest::getVar('view','vendors');

	    parent::display();

	}

	

	//function to display vendor propsals

	function vendor_proposal_centre()

	{

	    $user	= JFactory::getUser();

		if($user->user_type == 11)

		{

		JRequest::setVar('view', 'vendors');

		parent::display();

		}

		else

		{

		JRequest::setVar('task', 'not_authorized');

		JRequest::setVar('view', 'vendors');

		parent::display();

		}

	   //JRequest::getVar('view','vendors');

	  // parent::display();

	}

	//function to redirection after mail is sent

  
	function mail_redirect_form()
	{
	
		$useractivation = JRequest::getVar("useractivation",'');
		$from = JRequest::getVar("from",'');
		$db =& JFactory::getDBO();
		$user =& JFactory::getUser();
		$status = "SELECT status FROM #__cam_vendor_company where activation ='".$useractivation."'";
		$db->setQuery($status);
		$status1 = $db->loadResult();
		$usertype = "SELECT user_type,id FROM #__users where activation ='".$useractivation."'";
		$db->setQuery($usertype);
		$usertype = $db->loadObject();
		if ($usertype->user_type == '16') 
		{
		 $activate_usertype = "UPDATE #__users SET block='0' where id ='".$usertype->id."'";
		$db->setQuery($activate_usertype);
		$db->query();
		
		}
		//echo $status1;
		if($status1=='approved'){
		$msg='Your account is already activated, you can login';
		$link= JURI::base()."index.php?option=com_user&view=login&Itemid=87";
		$this->setRedirect( $link,$msg );
		} else {
		$activate = "UPDATE #__cam_vendor_company SET status='approved' where activation ='".$useractivation."'";
		$db->setQuery($activate);
		$db->query();
		$userdetails1 = "SELECT user_id,company_address,company_name,tax_id FROM #__cam_vendor_company where activation ='".$useractivation."'";
		$db->setQuery( $userdetails1 );
		$cust_id = $db->loadObjectlist();
		//Update users table
		$activate_usetr = "UPDATE #__users SET block='0' where id ='".$cust_id[0]->user_id."'";
		$db->setQuery($activate_usetr);
		$db->query();
		//Completed
		$user_details = "SELECT name,email,lastname,phone FROM #__users where id ='".$cust_id[0]->user_id."'";
		$db->setQuery( $user_details );
		$user_details1 = $db->loadObjectlist();
		//echo "<pre>"; print_r($user_details1);
		//echo "<pre>"; print_r($cust_id);
		//To update the inviteinfo table
		$invitations = "SELECT managerid FROM #__cam_newvendorinvitations where vendoremailid ='".$user_details1[0]->email."'";
		$db->setQuery( $invitations );
		$invites = $db->loadObjectlist();
		//echo "<pre>"; print_r($invites); 
		$model = $this->getModel('vendors');
		for( $n=0; $n<count($invites); $n++ ){
		$taxid = $model->getcompanyid($invites[$n]->managerid);
		$email = $user_details1[0]->email; 
		$post['userid'] = $invites[$n]->managerid ;
		$post['v_id'] = $cust_id[0]->user_id;
		$post['taxid'] = $taxid;
		$post['licenseno'] = '';
		$post['vendortype'] = 'preferred';
		$post['fei'] = '';
		$post['inhousevendors'] = $email;
		$post['inhouse'] = $email;
		$post['subject'] = "Preferred invitation from camfirm";
		$post['inhousetext'] = "Preferred invitation from camfirm";
		$post['status'] = 1;
		$post['invitedate'] = date('Y-m-d h:i:m');;
		$post['exclude'] = '';
		//echo "<pre>"; print_r($post);
		$save = $model->store_add($post);
		}
		//exit;
		//Completed
		// To change the subscription
		if( $from != 'resend' ){
		//$save_subscription = $model->firstsubscription($cust_id[0]->user_id);
		}
		//Completed
		$username=$user_details1[0]->name.' '.$user_details1[0]->lastname;
		$email=$user_details1[0]->email;
		
		$mailfrom='support@myvendorcenter.com';
		$fromname='MyVendorCenter.com';
		//$assignuseremail='rize.test@gmail.com';
		//$username=$user_details1[0]->name.' '.$user_details1[0]->lastname;
		//$email=$user_details1[0]->email;
		$address=$cust_id[0]->company_address;
		$companyname=$cust_id[0]->company_name;
		$camfirm_license_no=$cust_id[0]->tax_id;
		$phone=$user_details1[0]->phone;

		//$assignuseremail='rize.test@gmail.com';
		$assignuseremail='support@myvendorcenter.com';
		$mailsubject='New Vendor Registered On MyVendorCenter';
		$notification = "SELECT introtext  FROM #__content where id='198'";
		$db->setQuery($notification);
		$body = $db->loadResult();
		
		$body = str_replace('{EMAIL}', $email, $body);
		$body = str_replace('{USERNAME}', $username, $body);
		$body = str_replace('{ADDRESS}', $address, $body);
		$body = str_replace('{COMPANY NAME}', $companyname, $body);
		$body = str_replace('{PHONE}', $phone, $body);
		$body = str_replace('{TAX ID}', $camfirm_license_no, $body);

		//JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
		$assignuseremail='rize.cama@gmail.com';
		
		if ($usertype->user_type != '16') 
		{
		
		JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
		}
		
		JRequest::getVar('view','vendors');
		parent::display();
		}
	}

	//function to edit vendor info

	function vendor_edit_form()
	{
		JRequest::getVar('view','vendors');

		parent::display();

	}

	

	//function to display vendor billing form

	function vendor_billing_form()

	{

		JRequest::getVar('view','vendors');

		parent::display();

	}

	

	//function to redirection if paypayl is success

	function vendor_billing_thankyou_form()

	{

		$model = $this->getModel('vendors');

		$model->update_payment_status('paid');

		JRequest::getVar('view','vendors');

		parent::display();

	}

	

	//function to redirection if paypay is failed

	function vendor_billing_failed_form()

	{

		$model = $this->getModel('vendors');

		$model->update_payment_status('failed');

		JRequest::getVar('view','vendors');

		parent::display();

	}

	//function to save vendor  info

	function save_billing_info()

	{

		$model = $this->getModel('vendors');

		$Itemid = JRequest::getVar('Itemid','');

		$post	= JRequest::get('post');

		$user	= JFactory::getUser();

		$db =& JFactory::getDBO();

		$query = "DELETE FROM  #__cam_vendor_billing WHERE user_id=".$user->id;

		$db->setQuery($query);

		$db->query();

		//echo "<pre>"; print_r($_REQUEST); print_r($post); exit;

		$data['user_id']		= $user->id;

		$data['CardType']		= $post['CardType'];

		$data['CardNumber'] 	= $post['CardNumber'];

		$data['name_on_card']	= $post['name_on_card'];

		$data['company_name'] 	= $post['company_name'];

		$data['ExpMon'] 		= $post['ExpMon'];

		$data['ExpYear'] 		= $post['ExpYear'];

		$data['pay_amount'] 	= $post['amnt_charged'];

		$data['promo_code'] 	= $post['promo_code'];

		$data['address'] 		= $post['address'];

		$data['city'] 			= $post['city'];

		$data['states'] 		= $post['states'];

		$data['zipcode']		= $post['zipcode'];

		$data['phone'] 			= $post['phone'];

		$data['date'] 			= date('Y-m-d');

		

		if($post['hid_payment_type'] == 'Paypal')

		{

		$Payment_type = $post['hid_payment_type'];

		$Paypal_email = $post['hid_pay_busness_email'];

		$Paypal_currency = $post['hid_pay_currency'];

		$Paypal_name = $post['hid_pay_name'];

		$link = 'index.php?option=com_camassistant&controller=vendors&task=paypal_form&payment_type='.$Payment_type.'&user_id='.$user->id.'&cost='.$data['pay_amount'].'&pay_currency='.$Paypal_currency.'&pay_name='.$Paypal_name.'&pay_email='.$Paypal_email.'&Itemid='.$Itemid; 

		}

		else if($post['hid_payment_type'] == 'Authorize')

		{

		//echo "<pre>"; print_r($post); 

		$Payment_type = $post['hid_payment_type'];

		$Authorize_key = $post['hid_auth_tx_key'];

		$Authorize_login_ID = $post['hid_auth_login_id'];

		$link = 'index.php?option=com_camassistant&controller=vendors&Cardnumber='.$post['CardNumber'].'&task=authorize_form&address='.$data['address'].'&city='.$data['city'].'&states='.$data['states'].'&zipcode='.$data['zipcode'].'&payment_type='.$Payment_type.'&user_id='.$user->id.'&cost='.$data['pay_amount'].'&Auth_key='.$Authorize_key.'&Auth_login_id='.$Authorize_login_ID.'&Itemid='.$Itemid;  

		}

		if($model->store_billing_info($data)) {

		$link = $link; 

		$msg="";

		$this->setRedirect( $link,$msg );

		}

		

	}

	//function to redirect vendor billing form to paypal url

	function paypal_form()

	{ 

		JRequest::getVar('view','vendors');

		parent::display();

	}

	//function to save industries selected in popup to a session

	function industries_Save()

	{

		//session_destroy();

		session_start();

		$ind_ary 				= JRequest::getVar('cid','','post','array',REQUEST_ALLOWRAW);

		$_SESSION['industries'] = $ind_ary;

		$ind = implode(',',$ind_ary); 

		

		echo "<script language='javascript' type='text/javascript'>

		var val = '".$ind."';

		window.parent.document.getElementById('industries').value = val;

		window.parent.document.getElementById( 'sbox-window' ).close();

		//window.parent.parent.location.reload();

		 </script>"; 

	}

	function state_save()

	{

		$post = JRequest::get('request');

		$db = & JFactory::getDBO();

		$query = "INSERT INTO #__state ( id , state_name , state_id ) VALUES (  '' , '".$post['statename']."', '' );";

		$db->setQuery($query);

		$db->query();

	?>

		<script type="text/javascript"> 

		window.parent.parent.location.reload();

		window.parent.document.getElementById( 'sbox-window' ).close();</script> 

	<?php

	}

	

	function county_save()

	{

		$post = JRequest::get('request');

		$db = & JFactory::getDBO();

		$query = "INSERT INTO #__county ( id , county_name , state_id ) VALUES (  '' , '".$post['countyname']."', '".$post['state']."' );";

		$db->setQuery($query);

		$db->query();

	?>

		<script type="text/javascript"> window.parent.parent.location.reload();

		window.parent.document.getElementById( 'sbox-window' ).close();</script> 

	<?php

	}

	//function to save vendor info,company info

	function thanks()

	{  
	//echo "<pre>"; print_r($_REQUEST); exit;
		jimport('joomla.filesystem.file');
		jimport('joomla.user.helper');
		$post		= JRequest::get('post');
		$user		=clone(JFactory::getUser(0));
		$db 		=& JFactory::getDBO();
		//$salutation	= $post['salutation'];
		//$lastname	= $post['lastname'];
		$phone		= $post['phone_1'].'-'.$post['phone_2'].'-'.$post['phone_3'];
		$extension	= $post['extension'];
		$cellphone	= JRequest::getVar('cellphone','');
		$user_id	= $post['user_id'];
		$username 	= JRequest::getVar('username','');
		$email 		= JRequest::getVar('email','');
		$ccemail	= JRequest::getVar('ccemail_1','');	
		$publicprofile	= JRequest::getVar('publicprofile','');	
		$sponserprofile	= JRequest::getVar('sponserprofile','');
		
		$fax_acc	= JRequest::getVar('fax_acc','');
		if( $fax_acc )
		$fax_acc = 'yes';
		else
		$fax_acc = 'no';
		
		if($publicprofile){
		$publicprofile = 'yes' ;
		}		
		else{
		$publicprofile = 'no' ;
		}
		if($sponserprofile){
		$sponserprofile = 'yes' ;
		}		
		else{
		$sponserprofile = 'no' ;
		}
		//$password	= JRequest::getVar('password', '', 'post', 'string', JREQUEST_ALLOWRAW);
		//$password2	= JRequest::getVar('password2', '', 'post', 'string', JREQUEST_ALLOWRAW);
		
		$password	= JRequest::getVar('password_p1', '', 'post', 'string', JREQUEST_ALLOWRAW);
		$password2	= JRequest::getVar('password_p2', '', 'post', 'string', JREQUEST_ALLOWRAW);
		$salt		= JUserHelper::genRandomPassword(32);
		$crypt		= JUserHelper::getCryptedPassword($password, $salt);
		$password1	= $crypt.':'.$salt;
		
		
		if($password=='')
		{
			$db =& JFactory::getDBO();
			$update = "UPDATE #__users SET phone='$phone',extension='$extension',cellphone='$cellphone',ccemail='$ccemail' where id =".$user_id; 
			$db->setQuery($update);
			$res12=$db->query();
		 }
		 else
		 {
			 $data['id']			= 	$post['user_id'];
			 $data['name']			= 	$post['name'];
			 $data['username']		= 	$username;
			 $data['password']		= 	$password;
			 $data['password2'] 	= 	$password2;
			 $data['salutation']	=	$post['salutation'];
			 $data['lastname'] 		= 	$post['lastname'];
			 $data['email'] 		= 	$email;
			 $data['ccemail'] 	= 	$ccemail;			 			 
			 $data['phone'] 		= 	$post['phone_1'].'-'.$post['phone_2'].'-'.$post['phone_3'];
			 $data['extension'] 	= 	$post['extension'];
			 $data['cellphone'] 	= 	$post['cellphone'];
			 
			 $data['usertype']		= 	'Registered';
			 $data['user_type'] 	= 	'11';
			 $data['gid']			= 	'18';
			 $data['block']			= 	'1';
			  $update = "UPDATE #__users SET phone='".$data['phone']."',extension='".$post['extension']."',cellphone='".$post['cellphone']."',ccemail='".$ccemail."',password='$password1'  where id =".$data['id'];  
			$db =& JFactory::getDBO();
			$db->setQuery($update);
			$res12=$db->query();
			
		}
		//code to update existing user record
		 $data['id'] = $post['user_id'];
		 $files	=  JRequest::getVar( 'hidden_image', '', 'files', 'array' );
		if($data['id'] != '')
		{
			
			$data['block']='0';
			/*$update = "UPDATE #__users SET phone='".$data['phone']."',extension='".$post['extension']."',cellphone='".$post['cellphone']."',password='$password1'  where id =".$data['id'];  
			$db =& JFactory::getDBO();
			$db->setQuery($update);
			$res12=$db->query();*/
			/*if(!$user->bind($data))
			{ 
				$user->getError(); 
			}
			else
			{
				if (!$user->save()){ 
			     $user->getError();
			    }
		     }*/
			//code to update image in vendor table
			/*if($files && $files['name'] != '')
			{
				//code to update image filed in vendors table
				$files1= str_replace(' ','_',$files['name']); 			
				$db = JFactory::getDBO();
				$sql = "SELECT image FROM  #__cam_vendor_company  where user_id='".$post['user_id']."'"; 
				$db->Setquery($sql);
				$prev_image = $db->loadResult();
				$filename =$post['user_id'].'_'.$files1;
				$sql = "UPDATE #__cam_vendor_company SET image='".$filename."' where user_id='".$post['user_id']."'"; 
				$db->Setquery($sql);
				$db->query();
				//code to move image to folderpath
				$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendors'.DS;
				$filepath = $base_Dir . $filename;  
				$post['image'] = $filename;
				if(file_exists($base_Dir . $prev_image))
					@unlink($base_Dir . $prev_image);
					 move_uploaded_file($files['tmp_name'], $filepath); 
			}*/

			$updateuser['id']				= $post['user_id'];
			$updateuser['company_address']	= $post['eaddress'];
			$updateuser['company_addresss']	= $post['eaddresss'];
			$updateuser['city']				= $post['city'];
			$updateuser['state']			= $post['state'];			
			$updateuser['zipcode'] 			= $post['zip'];
			$updateuser['company_phone'] 	= $post['phone_1'].'-'.$post['phone_2'].'-'.$post['phone_3'];
			$updateuser['phone_ext']		= $post['extension'];
			$updateuser['alt_phone'] 		= $post['cell_1'].'-'.$post['cell_2'].'-'.$post['cell_3'];
			$updateuser['alt_phone_ext'] 	= $post['alt_extension'];
			$updateuser['email']			= $post['email'];
			$updateuser['company_web_url']	= $post['company_web_url'];
			$updateuser['established_year'] = $post['yearestab'];
			$updateuser['in_house_vendor']  = $post['in_house_vendor'];
			$updateuser['in_house_parent_company'] = $post['name'];
			$updateuser['in_house_parent_company_FEIN'] = $post['tax_id1'].'-'.$post['tax_id2'].'-'.$post['tax_id3'];
			
			$updateuser['faxid'] 		= $post['fax_1'].'-'.$post['fax_2'].'-'.$post['fax_3'];
			$updateuser['fax_acc'] 		= $fax_acc;
			
			if($files['name'])
			{
						$files1= str_replace(' ','_',$files['name']); 		
					$files1= str_replace('&','_',$files1); 		
					$files1= str_replace('#','_',$files1); 		
					$files1= str_replace('%','_',$files1); 	
					$files1= str_replace(',','_',$files1); 	 	
					$updateuser['image']	= $post['user_id'].'_'.$files1;
					jimport('joomla.filesystem.file');
			 		$filename =$updateuser['image']; 
					$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendors'.DS;
					$filepath = $base_Dir . $filename;  
					$post['image'] = $filename;
					if(file_exists($base_Dir . $filename)){ //echo 'in unlink';
					@unlink($base_Dir . $filename); }
					move_uploaded_file($_FILES['hidden_image']['tmp_name'], $filepath); 
			}
			else
			{ 
				 $updateuser['image'] =  $_REQUEST['img_name'];
			}
			//code to resize image 
			$model = $this->getModel('vendors');
			if($filename!=''){
			$img = $filepath;
			$pdf_resized = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendors'.DS.'pdf_resized';
			$resized = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendors'.DS.'resized';
			$img1 =$resized;
			$img2 =$pdf_resized;
			$dimensions = $model->get_thumbnail_dimensions();
			if($dimensions[0]->vendor_logo_width == 0)
			$dimensions[0]->vendor_logo_width = 90;
			if($dimensions[0]->vendor_logo_height == 0)
			$dimensions[0]->vendor_logo_height = 90;
			if($img)
			{
			$apath=getimagesize($img);
			$height_orig=$apath[1];
			$width_orig=$apath[0];
			$aspect_ratio = (float) $height_orig / $width_orig;
			$width =$dimensions[0]->vendor_logo_width;
			$height = round($width * $aspect_ratio);
			$thumb = $model->image_resize_to_max($img,$width,$height,$img1,$filename);
			$pdf_thumb = $model->image_resize_to_max($img,$width_orig,$height_orig,$img2,$filename);
			}
			/********************************************* pdf image resize code*******************************/
			$ftmp = $filename;
            $oname = $filename;
            $fname = $pdf_resized.'/'.$filename;
            $sizes = getimagesize($fname);
            $width	=	$sizes[0];
            $height	=	$sizes[1];
            $extenssion = strstr($oname, ".");
            $prod_img		= $fname;	
            $prod_img_thumb =  $pdf_resized.'/'.$oname;
            move_uploaded_file($ftmp, $prod_img);
            $original_filesize = (filesize($prod_img)/1024);
            $sizes = getimagesize($prod_img);
            $expected_max_width		=	128;
            $expected_max_height	=	50;
            $originalw	=	$sizes[0];
            $originalh	=	$sizes[1];
               if ($originalh<$expected_max_height) {

                if ($originalw<$expected_max_width) {
                    $imgwidth	=	$originalw;
                    $imgheight	=	$originalh;
                } else {
                    $imgheight	=	($expected_max_width * $originalh)/ $originalw;
                    $imgwidth	=	$expected_max_width;
                }
            } else {
                 $new_height		=	$expected_max_height;
                 $new_width		=	($expected_max_height * $originalw)/ $originalh;
                if ($new_width>$expected_max_width) {
                    $new_height	=	($expected_max_width * $expected_max_height) / $new_width;
                    $new_width	=	$expected_max_width;
                }
                $imgwidth	=	$new_width;
                $imgheight	=	$new_height;
            }
            $new_h	=	$imgheight;
            $new_w	=	$imgwidth;
			$new_w_im='128'; 
			$new_h_im='50';
			$offsetwidth=$new_w_im-$new_w;
			$offsetw=$offsetwidth/2;
			$offsetheight=$new_h_im-$new_h;
			$offseth=$offsetheight/2;
           $dest = imagecreatetruecolor ($new_w_im,$new_h_im);
           $bg = imagecolorallocate ( $dest, 255, 255, 255 );
           imagefill ( $dest, 0, 0, $bg );
		   $extenssion= str_replace('.jpg.jpg','.jpg',$extenssion);
		 $extenssion= str_replace('.jpeg.jpeg','.jpeg',$extenssion);
		 $extenssion= str_replace('.gif.gif','.gif',$extenssion);
		 $extenssion= str_replace('.png.png','.png',$extenssion);
			if($extenssion=='.jpg' ||  $extenssion=='.JPG'){	
            	$src = imagecreatefromjpeg($prod_img)
                or die('Problem In opening Source JPG Image');
			}elseif($extenssion=='.jpeg' || $extenssion=='.JPEG'){
				 $src = imagecreatefromjpeg($prod_img)
                 or die('Problem In opening Source JPEG Image');
			}elseif($extenssion=='.gif' || $extenssion=='.GIF'){
				 $src = imagecreatefromgif($prod_img)
                 or die('Problem In opening Source GIF Image');
			}elseif($extenssion=='.png' || $extenssion=='.PNG'){
			   $src = imagecreatefrompng($prod_img)
                or die('Problem In opening Source PNG Image');
			}
            if(function_exists('imagecopyresampled'))
            {
                imagecopyresampled($dest,$src,$offsetw,$offseth,0,0,$new_w,$new_h,imagesx($src),imagesy($src))
                or die('Problem In resizing');
            }else{

                Imagecopyresized($dest,$src,$offsetw,$offseth,0,0,$new_w,$new_h,imagesx($src),imagesy($src))
                or die('Problem In resizing');
            }
            imagejpeg($dest,$prod_img_thumb,72)  or die('Problem In saving');
            imagedestroy($dest);
            @ob_flush();
            $new_filesize = (filesize($prod_img)/1024);
			}

         /*********************************************end of code to pdf image resize code*******************************/

			$db = JFactory::getDBO();
		 	$query = "UPDATE #__cam_vendor_company SET `company_address` ='$updateuser[company_address]',`company_addresss` ='$updateuser[company_addresss]', `city` = '$updateuser[city]',`state` = '$updateuser[state]',`zipcode` = '$updateuser[zipcode]',`company_phone` = '$updateuser[company_phone]',
`phone_ext` = '$updateuser[phone_ext]',`alt_phone` = '$updateuser[alt_phone]',`alt_phone_ext` = '$updateuser[alt_phone_ext]',`established_year` = '$updateuser[established_year]',`company_web_url` = '$updateuser[company_web_url]',`in_house_parent_company`='$updateuser[in_house_parent_company]',`in_house_parent_company_FEIN`='$updateuser[in_house_parent_company_FEIN]',`in_house_vendor`='$updateuser[in_house_vendor]',`image` = '$updateuser[image]', faxid='$updateuser[faxid]', fax_acc = '$fax_acc' WHERE `user_id` ='$updateuser[id]' "; 
			$db->setQuery($query);
			$result = $db->query();
			$link = 'index.php?option=com_camassistant&controller=vendors&task=vendor_edit_form&view=vendors&Itemid=114';
			$msg="Updated successfully";
		    $this->setRedirect( $link,$msg );
		}

		

	}

	

	function keypath(){
		$db = JFactory::getDBO();
		$rfp_id= $_POST[rfpid]; 
		global $mainframe;
		$newrfp_id = 'RFP'.$rfp_id;
		$property_id="SELECT property_id FROM #__cam_rfpinfo where id=".$rfp_id;
		$db->Setquery($property_id);
		$property_id = $db->loadResult();
		//echo '<pre>'; print_r($property_id);
		$property_name ="SELECT property_name FROM #__cam_property where id=".$property_id;
		$db->Setquery($property_name);
		$property_name = $db->loadResult();
		$property_name = str_replace(" ", "_", $property_name);
		echo $key = $property_name.DS.'ProposalReports'.DS.$newrfp_id.DS; 
		exit;
	}



	//function to display thankyou message after registration

	 function thanks_redirect()

	 {

		parent::display();

	  

	 }

		//function to open document from vendor profile page
	function view_upld_cert_vendorprofile()
	{
		$model = $this->getModel('vendors');
		$open = $model->get_open_upld_cert_vendorprofile();
		parent::display();
	}

// To upgrade and downgrade the paypal subscriptions
	function updatesubscribe(){
	$user	= JFactory::getUser();
	//echo "<pre>"; print_r($_REQUEST);
	$model = $this->getModel('vendors');
	$promo	= JRequest::getVar('promo_code');
	$discount	= JRequest::getVar('discount');
	$amount	= JRequest::getVar('pay_amount');
	$subscribe	= JRequest::getVar('subscribe');
	if($subscribe == 'public')
	$subscribe = 'MyVendorCenter Basic Membership + Public Profile:  Your Profile Page is visible to non-members and searchable via the web.';
	if($subscribe == 'all')
	$subscribe = "MyVendorCenter Basic Membership + Public Profile + Sponsored Vendor:  Includes all options to maximize your company's exposure.";
	$oldsubscribe	= JRequest::getVar('subscribe');
	// To check is there any existing subscribe or not
	$previous = $model->checksubscription();
	// To check the promocode type
	$promotype = $model->checkpromocode($promo);
	if($promotype == 'all'){
	$amount = $amount;
	$restamount = $amount;
	}
	else{
	$amount = $amount;
	$restamount = $amount + $discount;
	}
	
	//exit;
	setlocale(LC_MONETARY, 'en_US');
	$unit = "y";
	$returnurl = "index.php?option=com_camassistant&controller=vendors&task=subscriptionsave&subtype=".$oldsubscribe."&Itemid=213";
	$cancelurl = "index.php?option=com_camassistant&controller=vendors&task=subscriptions&Itemid=213";
	//$notifyurl = "index.php?option=com_camassistant&controller=vendors&task=savenotify&Itemid=213";
	$notifyurl = "index.php?option=com_camassistant&controller=vendors&task=savenotify&subtype=".$oldsubscribe."&vendorid=".$user->id."&Itemid=213";
	?>
	<head>
			<style>
				#dynamicDiv {
				    background-color: #000000;				   
				    height: 100%;
				    left: 0;				    
				    opacity: 0.7;    
				    padding: 0;
				    margin: auto 0;
				    position: absolute;    
				    visibility: visible;
				    width: 100%;
				    z-index: 99990;				    
				    font-size: 14px;
				    font-weight: bold;						   
				}
				#dynamicDiv2 p{
				    margin-top: 27px;
    			    text-align: center;
    			    color: #7AB800;
				}
			</style>
		</head>
		<body onLoad="document.getElementById('paymentForm').submit();">
			<div id="dynamicDiv2"><p>Please wait, we are redirecting you to paypal. Do not click on back button or refresh the page.<br/><br><img src="templates/camassistant_left/images/final_loading_big.gif"></p></div>
			<!--for testing https://www.sandbox.paypal.com/cgi-bin/webscr-->
			<form id="paymentForm" name="_xclick" action="https://www.paypal.com/cgi-bin/webscr" method="post">
				<input type="hidden" name="cmd" value="_xclick-subscriptions">
				<input type="hidden" name="business" value="accounting@camassistant.com"> <!-- for testing decorrev@local.com-->
				<input type="hidden" name="lc" value="US">
				<input type="hidden" name="currency_code" value="USD">
				<input type="hidden" name="no_shipping" value="1">
				<input type="hidden" name="rm" value="2">	
				<input type="hidden" name="item_name" value="<?php echo $subscribe; ?>">
				<input type="hidden" name="item_number" value="<?php echo $promo; ?>">						
				<input type="hidden" name="a1" value="<?php echo $amount; ?>">
				<input type="hidden" name="t1" value="Y">
				<input type="hidden" name="p1" value="1">

				<input type="hidden" name="a3" value="<?php echo $restamount; ?>">
				<input type="hidden" name="t3" value="Y">
				<input type="hidden" name="p3" value="1">
				
				<input type="hidden" name="src" value="1">
				<input type="hidden" name="custom" value="<?php echo $user->id; ?>">				
				<input type="hidden" name="sra" value="1">
				<input type="hidden" name="return" value="<?php echo JURI::root().$returnurl; ?>">
				<input type="hidden" name="cancel_return" value="<?php echo JURI::root().$cancelurl; ?>"> 
				<input type="hidden" name="notify_url" value="<?php echo JURI::root().$notifyurl; ?>" > 
			</form>
		</body>
	<?php
	//To remove the existing plan
	//$recurresponxe = $model->change_subscription_status( 'I-2KXNXBXT63WX', 'Reactivate' );
	//echo "<pre>"; print_r($recurresponxe);
	
	}
	//Completed	
	function subscriptionsave(){
	//echo "<pre>"; print_r($_REQUEST); exit;
	$subtype	= JRequest::getVar('subtype');
	$user	= JFactory::getUser();
	$db =& JFactory::getDBO();
	$date = date('Y-m-d'); 
	$nextdate = date('Y-m-d', strtotime('+1 year'));
	$model = $this->getModel('vendors');
	$currentstatus = $_REQUEST['payer_status'] ;
	$oldid ="SELECT subscribeid FROM #__cam_vendor_subscriptions where vendorid=".$user->id;
			$db->Setquery($oldid);
			$subscribeid = $db->loadResult();
	//echo "<pre>"; print_r($currentstatus); exit;
	if($currentstatus == 'unverified'){
		$previous = $model->checksubscription();
		if($previous == 'yes' && $subscribeid != "".$_REQUEST['subscr_id'].""){
			//To get the subscriber IDs
			$oldid ="SELECT subscribeid FROM #__cam_vendor_subscriptions where vendorid=".$user->id;
			$db->Setquery($oldid);
			$subscribeid = $db->loadResult();
			$recurresponxe = $model->change_subscription_status( $subscribeid, 'Cancel' );
			//To delete from our database
			$query = "DELETE FROM #__cam_vendor_subscriptions WHERE vendorid=".$user->id; 
			$db->setQuery($query); 
			$db->query() ;
		}
		$query = "insert into #__cam_vendor_subscriptions (`id`, `vendorid`, `coupon`, `paid`, `ctype`, `subscribeid`, `date`, `nextdate`) VALUES ('','".$user->id."','".$_REQUEST['item_number']."','".$_REQUEST['mc_amount3']."','".$subtype."','".$_REQUEST['subscr_id']."','".$date."','".$nextdate."')";
		$db->setQuery($query);
		$db->query();
		//Update users table
		if($subtype == 'all')
		$sub_sort = 1 ;
		if($subtype == 'public')
		$sub_sort = 3 ;
		
		$update = "UPDATE #__users SET subscribe='yes', subscribe_type='".$subtype."', subscribe_sort='".$sub_sort."', subscribe_admin='".$subtype."'  where id =".$user->id; 
		$db->setQuery($update);
		$db->query();
		//Completed
		
		}
	$user->subscribe_type = $subtype;	
	$link = 'index.php?option=com_camassistant&controller=vendors&task=vendor_dashboard&Itemid=112';
	$msg="";
	$this->setRedirect( $link,$msg );	
	}
	//Notify URL feature
	function savenotify(){
	$subtype	= JRequest::getVar('subtype');
	$date = date('Y-m-d');
	$nextdate = date('Y-m-d', strtotime('+1 year'));
	$db =& JFactory::getDBO();
	$to = 'sk4576@gmail.com';
	$subject = 'NOTIFY URL';
	$content = 'This is for sameple email';
	$cc = 'rize.cama@gmail.com';
	$mailfrom = 'From PAYPAL';
	$rdata = "<div style='padding-left:30px; font-weight: bold'>";
		foreach($_REQUEST as $key => $value)
		{
			$rdata .= $key."-".$value."<br>";
		}		
		$rdata .= "</div>";
		$content = $rdata ;
		$vendorid = $_REQUEST['custom'] ;
		$subscribe = $_REQUEST['transaction_subject'] ;
	$res = JUtility::sendMail($mailfrom, '', $to, $subject, $content, $mode=1, $cc);
		if($subtype == 'all')
		$sub_sort = 1 ;
		if($subtype == 'public')
		$sub_sort = 3 ;
		//Send the mail to vendors
		if( $_REQUEST['txn_type'] == 'subscr_payment' ){
		$model = $this->getModel('vendors');
		$email_status = $model->sendmailstatus($vendorid);
		}
	//Completed	
	if( $_REQUEST['txn_type'] == 'subscr_payment' || $_REQUEST['txn_type'] == 'subscr_signup' ){
	$update = "UPDATE #__users SET subscribe='yes', subscribe_type='".$subtype."', subscribe_sort=".$sub_sort.", subscribe_admin='".$subtype."' where id =".$vendorid; 
	$db->setQuery($update);
	$db->query();
	$query = "insert into #__cam_vendor_subscriptions (`id`, `vendorid`, `coupon`, `paid`, `ctype`, `subscribeid`, `date`, nextdate) VALUES ('','".$vendorid."','','','".$subtype."','".$_REQUEST['subscr_id']."','".$date."','".$nextdate."')";
		$db->setQuery($query);
		$db->query();
	}	
	else{
		// To check expiration date
		$yesterday = date('Y-m-d', strtotime(' -1 day')) ;
		$query_expired = "SELECT nextdate FROM #__cam_vendor_subscriptions where vendorid='".$vendorid."' and ctype!='free' order by nextdate DESC ";
		$db->Setquery($query_expired);
		$date_exp = $db->loadResult();
		if( $date_exp == $yesterday ){
		$sql_up = "UPDATE #__users SET subscribe='', subscribe_type='', subscribe_sort='', subscribe_admin='' WHERE id='".$vendorid."'";
		$db->Setquery($sql_up);
		$db->query();
		}
	}
	$txtype = $_REQUEST['txn_type'] ;
	
	// Sending mail to vendors when subscribe newly
	if( $txtype == 'subscr_signup' ){
		$model = $this->getModel('vendors');
		$email_status_first = $model->sendmailtovendor_first($vendorid,$subtype);	
	}
	//Completed
		
	if( $txtype == 'subscr_cancel' ){
	$notify_send = $this->cancel_paypal($vendorid);
	   if($notify_send){
			$newtx ="SELECT ctype FROM #__cam_vendor_subscriptions where subscribeid= 'A-AAAAAAAAAAAA' and vendorid=".$vendorid;
			$db->Setquery($newtx);
			$ctype = $db->loadResult();
			}
			if( $ctype == 'free' ){
				$sql_up = "UPDATE #__users SET subscribe='yes', subscribe_sort='4', subscribe_type='free', subscribe_admin='free' WHERE id='".$vendorid."'";
				$db->setQuery($sql_up);
				$res = $db->query();
			}
	}
		
	}
	
	
	function  cancel_paypal($vendorid)
	{
	$db = JFactory::getDBO();
	$user = JFactory::getUser();
	$query_cname = "SELECT company_name FROM #__cam_vendor_company WHERE user_id=".$vendorid." "; 
	$db->setQuery( $query_cname );
	$companyname = $db->loadResult();
	$redirect = '<a href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=subscriptions&Itemid=213">CLICK HERE </a>';
	//Completed
	$body_cc="SELECT introtext  FROM #__content where id='315'";
	$db->setQuery( $body_cc );
	$data = $db->loadResult();
	
	$body = str_replace('[Vendor Company Name]',$companyname,$data);
	$body = str_replace('CLICK HERE',$redirect,$body);
	
	$mailto = $user->email ;
	$mailfrom = 'support@myvendorcenter.com';
	$from  = 'MyVendorCenter.com';
    $subject = 'Important change to your MyVendorCenter account';
	//$to = 'rize.cama@gmail.com';
	//$res = JUtility::sendMail($mailfrom, $from, $mailto, $subject, $body, $mode=1);
	$to_support = 'vendoremails@myvendorcenter.com';
	//$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $body, $mode=1);
	$to_rize = 'rize.cama@gmail.com';
	$res = JUtility::sendMail($mailfrom, $from, $to_rize, $subject, $body, $mode=1);
	
	
	}
	//Completed
	//Function to upload the logo 
	function savelogofile(){
	$db = JFactory::getDBO();
	$user = JFactory::getUser();
	jimport('joomla.filesystem.file');
	jimport('joomla.user.helper');
	$files	=  JRequest::getVar( 'image', '', 'files', 'array' );
	$lastDot = strrpos($files['name'], ".");
	$files['name'] = str_replace(".", "", substr($files['name'], 0, $lastDot)) . substr($files['name'], $lastDot);
	//echo $files['name']; exit;
	
	if($files['name'])
			{
				$files1= str_replace(' ','_',$files['name']); 		
				$files1= str_replace('&','_',$files1); 		
				$files1= str_replace('#','_',$files1); 		
				$files1= str_replace('%','_',$files1); 	
				$files1= str_replace(',','_',$files1); 	 	
				$updateuser['image']	= $user->id.'_'.$files1;
				jimport('joomla.filesystem.file');
				$filename =$updateuser['image']; 
				$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendors'.DS;
				$filepath = $base_Dir . $filename;  
				$post['image'] = $filename;
				if(file_exists($base_Dir . $filename)){ //echo 'in unlink';
				@unlink($base_Dir . $filename); }
				move_uploaded_file($_FILES['image']['tmp_name'], $filepath); 
			}
			else
			{ 
				 $updateuser['image'] =  $_REQUEST['img_name'];
			}
	$model = $this->getModel('vendors');
	if($filename!=''){
			$img = $filepath;
			$pdf_resized = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendors'.DS.'pdf_resized';
			$resized = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendors'.DS.'resized';
			$img1 =$resized;
			$img2 =$pdf_resized;
			$dimensions = $model->get_thumbnail_dimensions();
			if($dimensions[0]->vendor_logo_width == 0)
			$dimensions[0]->vendor_logo_width = 90;
			if($dimensions[0]->vendor_logo_height == 0)
			$dimensions[0]->vendor_logo_height = 90;
			if($img)
			{
			$apath=getimagesize($img);
			$height_orig=$apath[1];
			$width_orig=$apath[0];
			$aspect_ratio = (float) $height_orig / $width_orig;
			$width =$dimensions[0]->vendor_logo_width;
			$height = round($width * $aspect_ratio);
			$thumb = $model->image_resize_to_max($img,$width,$height,$img1,$filename);
			$pdf_thumb = $model->image_resize_to_max($img,$width_orig,$height_orig,$img2,$filename);
			}
			/********************************************* pdf image resize code*******************************/
			$ftmp = $filename;
            $oname = $filename;
            $fname = $pdf_resized.'/'.$filename;
            $sizes = getimagesize($fname);
            $width	=	$sizes[0];
            $height	=	$sizes[1];
            $extenssion = strstr($oname, ".");
            $prod_img		= $fname;	
            $prod_img_thumb =  $pdf_resized.'/'.$oname;
            move_uploaded_file($ftmp, $prod_img);
            $original_filesize = (filesize($prod_img)/1024);
            $sizes = getimagesize($prod_img);
            $expected_max_width		=	128;
            $expected_max_height	=	50;
            $originalw	=	$sizes[0];
            $originalh	=	$sizes[1];
               if ($originalh<$expected_max_height) {

                if ($originalw<$expected_max_width) {
                    $imgwidth	=	$originalw;
                    $imgheight	=	$originalh;
                } else {
                    $imgheight	=	($expected_max_width * $originalh)/ $originalw;
                    $imgwidth	=	$expected_max_width;
                }
            } else {
                 $new_height		=	$expected_max_height;
                 $new_width		=	($expected_max_height * $originalw)/ $originalh;
                if ($new_width>$expected_max_width) {
                    $new_height	=	($expected_max_width * $expected_max_height) / $new_width;
                    $new_width	=	$expected_max_width;
                }
                $imgwidth	=	$new_width;
                $imgheight	=	$new_height;
            }
            $new_h	=	$imgheight;
            $new_w	=	$imgwidth;
			$new_w_im='128'; 
			$new_h_im='50';
			$offsetwidth=$new_w_im-$new_w;
			$offsetw=$offsetwidth/2;
			$offsetheight=$new_h_im-$new_h;
			$offseth=$offsetheight/2;
           $dest = imagecreatetruecolor ($new_w_im,$new_h_im);
           $bg = imagecolorallocate ( $dest, 255, 255, 255 );
           imagefill ( $dest, 0, 0, $bg );
		   $extenssion= str_replace('.jpg.jpg','.jpg',$extenssion);
		 $extenssion= str_replace('.jpeg.jpeg','.jpeg',$extenssion);
		 $extenssion= str_replace('.gif.gif','.gif',$extenssion);
		 $extenssion= str_replace('.png.png','.png',$extenssion);
			if($extenssion=='.jpg' ||  $extenssion=='.JPG'){	
            	$src = imagecreatefromjpeg($prod_img)
                or die('Problem In opening Source JPG Image');
			}elseif($extenssion=='.jpeg' || $extenssion=='.JPEG'){
				 $src = imagecreatefromjpeg($prod_img)
                 or die('Problem In opening Source JPEG Image');
			}elseif($extenssion=='.gif' || $extenssion=='.GIF'){
				 $src = imagecreatefromgif($prod_img)
                 or die('Problem In opening Source GIF Image');
			}elseif($extenssion=='.png' || $extenssion=='.PNG'){
			   $src = imagecreatefrompng($prod_img)
                or die('Problem In opening Source PNG Image');
			}
            if(function_exists('imagecopyresampled'))
            {
                imagecopyresampled($dest,$src,$offsetw,$offseth,0,0,$new_w,$new_h,imagesx($src),imagesy($src))
                or die('Problem In resizing');
            }else{

                Imagecopyresized($dest,$src,$offsetw,$offseth,0,0,$new_w,$new_h,imagesx($src),imagesy($src))
                or die('Problem In resizing');
            }
            imagejpeg($dest,$prod_img_thumb,72)  or die('Problem In saving');
            imagedestroy($dest);
            @ob_flush();
            $new_filesize = (filesize($prod_img)/1024);
			}
			$sql = "UPDATE #__cam_vendor_company SET image='".$updateuser['image']."' where user_id='".$user->id."'"; 
			$db->Setquery($sql);
			$db->query();
			echo "<script language='javascript' type='text/javascript'>
			 window.parent.location.reload();
			 window.parent.document.getElementById( 'sbox-window' ).close();
			 window.location = 'index.php?option=com_camassistant&controller=vendors&task=vendor_dashboard&logo=yes&Itemid=112';
			 </script>";
			exit;	
			
	}
	
	function uploadmarketfiles(){
	$db =& JFactory::getDBO();
	$user	= JFactory::getUser();
	$market		= JRequest::getVar('uploadfile','','files','array' );
	$market['name'] = str_replace(" ", "_", $market['name']);
	$market['name'] = str_replace("&", "_", $market['name']);
	$market['name'] = str_replace("#", "_", $market['name']);
	$market['name'] = str_replace("%", "_", $market['name']);
	$market['name'] = str_replace(",", "_", $market['name']);
	$market['name'] = str_replace("`", "_", $market['name']);
	$market['name'] = str_replace("'", "_", $market['name']);
	$market['name'] = str_replace("\\", "_", $market['name']);
	$market['name'] = str_replace(":", "_", $market['name']);
	$market['name'] = str_replace("?", "_", $market['name']);
	$market['name'] = str_replace("<", "_", $market['name']);
	$market['name'] = str_replace(">", "_", $market['name']);
	$market['name'] = str_replace("/", "_", $market['name']);
	$market['name'] = str_replace("//", "_", $market['name']);
	$market['name'] = ereg_replace("/", "_", $market['name']);

	$root_folder = 'components/com_camassistant/assets/images/market/';
	$base_market = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'market'.DS.$user->id.DS;
				// Remove all the files in folder if they exist
				jimport('joomla.client.helper');
				if(is_dir($base_market))
					{
					
					}
				else {
			    JFolder::create( $base_market );
				}
	$filepath = $base_market.$market['name'] ;			
	$success_upload = move_uploaded_file($market['tmp_name'], $filepath);
	if($success_upload){
	$date = date('Y-m-d H:i:s');
	$query = "insert into #__vendor_marketingdocs (`id`, `vendorid`, `filename`, `uploaddate`) VALUES ('','".$user->id."','".$market['name']."','".$date."')";
	$db->setQuery($query);
		if( $db->query() ) {
		//echo "<script language='javascript' type='text/javascript'> window.parent.document.getElementById( 'sbox-window' ).close(); 
		echo "<script language='javascript' type='text/javascript'>
			window.parent.document.getElementById( 'sbox-window' ).close();
			alert('New file uploaded successfully');
			window.parent.parent.location.reload();
			 </script>";
		//$url = "index.php?option=com_camassistant&controller=vendors&task=marketdocs&Itemid=221"; $msg = 'New file has been uploaded successfully.'; $this->setRedirect($url,$msg);
		}
	}
	else{
	$link = 'index.php?option=com_camassistant&controller=vendors&task=marketdocs&Itemid=221';
	$msg="Not able to upload the file. Please try again after some time.";
	$this->setRedirect( $link,$msg );
	}
	}
	
	function openmarketdocs(){
		$user	= JFactory::getUser();
		$db = JFactory::getDBO();
		$filename = JRequest::getVar('filename','');
		$folder_type = JRequest::getVar('folder_type','');
		$outerid = JRequest::getVar('vendorid');
		
		if(!$user->id) {
			if(!$outerid){
			$vendor_id = JRequest::getVar('id');
			}
			else{
			$vendor_id = $outerid ;
			}
		}
		else if($outerid){
			$vendor_id = $outerid ;
		}
		else{
			$vendor_id = $user->id ;
		}
	
	
		if($user->id == '0') {
		
		}
		$path = JURI::root().'components/com_camassistant/assets/images/market/'.$vendor_id;
		$doc_name = $path.'/'.$filename;
		header("content-type: application/octet-stream");
		header("Content-Disposition: attachment; filename=".$filename);
		readfile($doc_name);
		exit;	
	}
	//Function to remove the documents
	function deletemarketdoc(){
	$user	= JFactory::getUser();
	$db = JFactory::getDBO();
	$id = JRequest::getVar('id','');
	$filename = JRequest::getVar('filename','');
	$query = "DELETE FROM #__vendor_marketingdocs WHERE id=".$id." and filename='".$filename."' and vendorid=".$user->id; 
	$db->setQuery($query); 
	if($db->query()){
	echo "success";
	}
	else{
	echo "fail";
	}
	exit;		
	}
	//Completed
	//Function to get the total marketing documents into My Profile page
	function marketdocsprofile(){
	$db = JFactory::getDBO();
	$user = JFactory::getUser();
	$outerid = JRequest::getVar('id');
	if(!$user->id) {
		if(!$outerid){
		$vendor_id = JRequest::getVar('id');
		}
		else{
		$vendor_id = $outerid ;
		}
	}
	else if($outerid){
		$vendor_id = $outerid ;
	}
	else{
		$vendor_id = $user->id ;
	}
	
	$sub = "SELECT *  FROM #__vendor_marketingdocs where vendorid=".$vendor_id.""; 
	$db->Setquery($sub);
	$list = $db->loadObjectList();
	if($list){ 
 for($i=0; $i<count($list); $i++){ ?>
<?php 
if($i == '4' || $i == '8' || $i == '12' || $i == '16' || $i == '20' || $i == '24' || $i == '28' || $i == '32') {?>
<div class="clear"></div>
<div class="sepdashbutton"></div>
<br /><br />
<?php } ?>
<div class="nvnv" style="padding-right:8px; margin-left:5px; width:146px;">
<h6><?php 
$strlen = strlen($list[$i]->filename) ;

if($strlen > 18){
$result = substr($list[$i]->filename, 0, 18);
echo $result.'...' ;
}
else{
echo str_replace('_',' ',$list[$i]->filename) ;
}
?></h6>
<div class="dal-tie">
<?php $ext = end(explode('.', $list[$i]->filename)); ?>
<a target="_blank" href="index.php?option=com_camassistant&controller=vendors&task=viewmarketdocs&filename=<?php echo $list[$i]->filename; ?>&vendorid=<?php  echo $vendor_id; ?>"><img src="templates/camassistant_inner/images/doc_images/images_<?php echo $ext; ?>.png" /></a>
</div>
</div>

<?php 
} 
}
else {
	if($user->user_type == '13' || $user->user_type == '12' || $_REQUEST['from'] == 'public'){
	echo "<p align='center' style='color:gray; font-weight:bold; font-size:13px;'>This Vendor has not uploaded any Marketing Documents.</p>";
	}
	else{
	echo "<p align='center' style='color:gray; font-weight:bold; font-size:13px;'>You have not uploaded any marketing documents</p>";
	}
}
	exit;
	}


	//Function to vetrify email id
	function verfiryphonenumber()
	{
		$db =& JFactory::getDBO();
		$phone = JRequest::getVar('queryString','');
		if ($phone != "")
		{
		$query_phone = "SELECT user_id FROM #__cam_vendor_company WHERE company_phone = '".$phone."' "; 
		$db->setQuery( $query_phone );
		$id = $db->loadResult();
		
		//print_r($result_email);
		if(!$id){
		$data="valid";
		}
		else{ 
		$data="invalid";
		 }
		}
		echo $data;
		exit;
   }
   
   //Function to vetrify email id
	function verfiryphonenumberuseinfo()
	{
		$db =& JFactory::getDBO();
		$user = JFactory::getUser();
		$phone = JRequest::getVar('queryString','');
		if ($phone != "")
		{
		$query_phone = "SELECT user_id FROM #__cam_vendor_company WHERE company_phone = '".$phone."' and user_id!=".$user->id." "; 
		$db->setQuery( $query_phone );
		$id = $db->loadResult();
		
		//print_r($result_email);
		if(!$id){
		$data="valid";
		}
		else{ 
		$data="invalid";
		 }
		}
		echo $data;
		exit;
   }
   
    function saveaboutus(){
   $model = $this->getModel('vendors');
   $user	= JFactory::getUser();
   $aboutus = JRequest::getVar('aboutus','');
   $post['aboutus'] = $aboutus ;
   $post['vendorid'] = $user->id ;
   $post['update']	= date('Y-m-d');
   $post['id'] = JRequest::getVar('id','');
   $save = $model->store_addabout($post);
   if($save){
    $link = 'index.php?option=com_camassistant&controller=vendors&task=vendordetailslayout&Itemid=219';
	$this->setRedirect( $link,'' );
   }
   
   }
   
   function viewmarketdocs(){
		$user	= JFactory::getUser();
		$db = JFactory::getDBO();
		$vendorid = JRequest::getVar('vendorid','');
		if($vendorid){
		$vendor_id = $vendorid ;
		}
		else{
		$vendor_id = $user->id ;
		}
		$filename = JRequest::getVar('filename','');
		$path = 'components/com_camassistant/assets/images/market/'.$vendor_id;
		$doc_name = $path.'/'.$filename;
		$link = 'index.php?option=com_camassistant&controller=vendors&task=viewfile&Itemid=221&file='.$filename.'&doc='.$doc_name.'&vendorid='.$vendor_id.'';
		$this->setRedirect( $link,'' );
	}
	
	function openview_upld_cert(){
		$db = JFactory::getDBO();
		$filename = JRequest::getVar('filename','');
		$doc = JRequest::getVar('doc','');
		$link = 'index.php?option=com_camassistant&controller=vendors&task=viewfilecomp&Itemid=197&file='.$filename.'&doc='.$doc.'';
		$this->setRedirect( $link,'' );
	}
	
	function openview_upld_cert_vendorprofile(){
		$db = JFactory::getDBO();
		$filename = JRequest::getVar('filename','');
		$doc = JRequest::getVar('doc','');
//		$id = JRequest::getVar('id','');
		$user	= JFactory::getUser();
		$outerid = JRequest::getVar('id');
		if(!$user->id) {
			if(!$outerid){
			$vendor_id = JRequest::getVar('id');
			}
			else{
			$vendor_id = $outerid ;
			}
		}
		else if($outerid){
			$vendor_id = $outerid ;
		}
		else{
			$vendor_id = $user->id ;
		}
	
		/*if($id != '0'){
		$user->id = $id ;
		}
		else{
		$user->id = $user->id ;
		}*/
		$link = 'index.php?option=com_camassistant&controller=vendors&task=viewfilecomp&Itemid=197&file='.$filename.'&doc='.$doc.'&id='.$vendor_id.'';
		$this->setRedirect( $link,'' );
	}
	
	function senddocstovendor(){
	$vendorid = JRequest::getVar('id','');
	$user	= JFactory::getUser();
	$db = JFactory::getDBO();
	$query_cname = "SELECT company_name FROM #__cam_vendor_company WHERE user_id=".$vendorid." "; 
	$db->setQuery( $query_cname );
	$companyname = $db->loadResult();
	$emailid = "SELECT email, ccemail FROM #__users WHERE id=".$vendorid." "; 
	$db->setQuery( $emailid );
	$mails = $db->loadObject();
	$mailid = $mails->email ;
	// To get the manager name and company name
	$man_info = "SELECT name, lastname FROM #__users WHERE id=".$user->id." "; 
	$db->setQuery( $man_info );
	$mans = $db->loadObject();
	$man_name = $mans->name. '&nbsp;' . $mans->lastname ;

	$com_info = "SELECT comp_name FROM #__cam_customer_companyinfo WHERE cust_id=".$user->id." "; 
	$db->setQuery( $com_info );
	$companyname_user = $db->loadResult();
	//Completed
	$body_cc="SELECT introtext  FROM #__content where id='269' ";
	$db->setQuery( $body_cc );
	$data = $db->loadResult();
	$body = str_replace('[Vendor Company Name]',$companyname,$data);
	$body = str_replace('[manager_name]',$man_name,$body);
	$body = str_replace('[company_name]',$companyname_user,$body);
	//echo $body; exit;
	$mailfrom = $user->email ;
	$from  = 'MyVendorCenter.com';
	$to = $mailid;
	$subject = 'A request has been made to update your Compliance Documents';
	//$to = 'rize.cama@gmail.com';
	$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $body, $mode=1);
	
	//Sending emails to CC address
	$cc = $mails->ccemail ;
	$cclist = explode(';',$cc);
	for($c=0; $c<=count($cclist); $c++){
	$listcc = $cclist[$c];
	if($listcc){
	JUtility::sendMail($mailfrom, $from, $listcc, $subject, $body, $mode=1);
	}
	}
	//Completed
	
	$to_support = "vendoremails@myvendorcenter.com";
	$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $body, $mode=1);
	if($res) { 
	$success = 'yes';
	}
	else{
	$success = 'no';
	}
	
	echo $success ;
	exit;
//	return $success ;
	}
	function removedocuments(){
		$user	= JFactory::getUser();
		$db = JFactory::getDBO();	
		$type = JRequest::getVar('Type','');
		$documentid = JRequest::getVar('Documentid','');
			if($type == 'W9'){
				 $clear_w9 = "UPDATE #__cam_vendor_compliance_w9docs SET w9_upld_cert='', w9_date_verified='0000-00-00' where vendor_id=".$user->id." and id=".$documentid." "; 
			 	 $db->setQuery($clear_w9);
			  	 $updatetime = $db->query();
				 if($updatetime){
				 echo "success";
				 }
			}	
			if($type == 'GLI'){
				 $clear_w9 = "UPDATE #__cam_vendor_liability_insurence SET GLI_name='', GLI_policy='', GLI_start_date='', GLI_end_date='', GLI_agent_first_name='', GLI_agent_last_name='', GLI_phone_number='', GLI_policy_aggregate='', GLI_policy_occurence='', GLI_upld_cert='', GLI_date_verified='0000-00-00', GLI_med='', GLI_injury='', GLI_products='', GLI_applies='', GLI_damage='', GLI_primary='', GLI_waiver='', GLI_occur='', GLI_certholder='', GLI_additional=''  where vendor_id=".$user->id." and id=".$documentid." "; 
			 	 $db->setQuery($clear_w9);
			  	 $updatetime = $db->query();
				 if($updatetime){
				 echo "success";
				 }
			}
			if($type == 'aip'){
				 $clear_w9 = "UPDATE #__cam_vendor_auto_insurance SET aip_end_date='', aip_date_verified='0000-00-00', aip_upld_cert='', aip_bodily='', aip_combined='', aip_body_injury='', aip_property='', aip_primary='', aip_waiver='', aip_cert='', aip_addition='', aip_applies_any='', aip_applies_owned='', aip_applies_nonowned='', aip_applies_hired='', aip_applies_scheduled='' where vendor_id=".$user->id." and id=".$documentid." "; 
			 	 $db->setQuery($clear_w9);
			  	 $updatetime = $db->query();
				 if($updatetime){
				 echo "success";
				 }
			}
			if($type == 'WCI'){
				 $clear_w9 = "UPDATE #__cam_vendor_workers_companies_insurance SET WCI_name='', WCI_policy='', WCI_start_date='', WCI_end_date='', WCI_agent_first_name='', WCI_agent_last_name='', WCI_phone_number='', WCI_upld_cert='', excemption='', WCI_disease='', WCI_disease_policy='', WCI_waiver='', WCI_each_accident='', WCI_cert='', WCI_date_verified='0000-00-00' where vendor_id=".$user->id." and id=".$documentid." "; 
			 	 $db->setQuery($clear_w9);
			  	 $updatetime = $db->query();
				 if($updatetime){
				 echo "success";
				 }
			}
			if($type == 'wc'){
				 $clear_w9 = "UPDATE #__cam_vendor_workers_compansation SET wc_end_date='', wc_date_verified='0000-00-00', wc_upld_cert='' where vendor_id=".$user->id." and id=".$documentid." "; 
			 	 $db->setQuery($clear_w9);
			  	 $updatetime = $db->query();
				 if($updatetime){
				 echo "success";
				 }
			}
			if($type == 'UMB'){
				 $clear_w9 = "UPDATE #__cam_vendor_umbrella_license SET UMB_license='', UMB_expdate='', UMB_city_country='', UMB_state='', UMB_upld_cert='', UMB_date_verified='0000-00-00', UMB_aggregate='', UMB_occur='', UMB_certholder='' where vendor_id=".$user->id." and id=".$documentid." "; 
			 	 $db->setQuery($clear_w9);
			  	 $updatetime = $db->query();
				 if($updatetime){
				 echo "success";
				 }
			}
			if($type == 'OLN'){
				 $clear_w9 = "UPDATE #__cam_vendor_occupational_license SET OLN_license='', OLN_expdate='', OLN_city_country='', OLN_state='', OLN_upld_cert='', OLN_date_verified='0000-00-00' where vendor_id=".$user->id." and id=".$documentid." "; 
			 	 $db->setQuery($clear_w9);
			  	 $updatetime = $db->query();
				 if($updatetime){
				 echo "success";
				 }
			}
			if($type == 'PLN'){
				 $clear_w9 = "UPDATE #__cam_vendor_professional_license SET PLN_license='', PLN_category='', PLN_type='', PLN_expdate='', PLN_state='', PLN_upld_cert='', PLN_date_verified='0000-00-00' where vendor_id=".$user->id." and id=".$documentid." "; 
			 	 $db->setQuery($clear_w9);
			  	 $updatetime = $db->query();
				 if($updatetime){
				 echo "success";
				 }
			}
			if($type == 'OMI'){
				 $clear_w9 = "UPDATE #__cam_vendor_errors_omissions_insurance SET OMI_end_date='0000-00-00', OMI_upld_cert='', OMI_date_verified='', OMI_aggregate='', OMI_each_claim='', OMI_cert='' where vendor_id=".$user->id." and id=".$documentid." "; 
			 	 $db->setQuery($clear_w9);
			  	 $updatetime = $db->query();
				 if($updatetime){
				 echo "success";
				 }
			}	
			
		exit;
	}
	
	function uploadcompanyfiles(){
	$db =& JFactory::getDBO();
	$user	= JFactory::getUser();
	$market		= JRequest::getVar('uploadfile','','files','array' );
	$market['name'] = str_replace(" ", "_", $market['name']);
	$market['name'] = str_replace("&", "_", $market['name']);
	$market['name'] = str_replace("#", "_", $market['name']);
	$market['name'] = str_replace("%", "_", $market['name']);
	$market['name'] = str_replace(",", "_", $market['name']);
	$market['name'] = str_replace("`", "_", $market['name']);
	$market['name'] = str_replace("'", "_", $market['name']);
	$market['name'] = str_replace("\\", "_", $market['name']);
	$market['name'] = str_replace(":", "_", $market['name']);
	$market['name'] = str_replace("?", "_", $market['name']);
	$market['name'] = str_replace("<", "_", $market['name']);
	$market['name'] = str_replace(">", "_", $market['name']);
	$market['name'] = str_replace("/", "_", $market['name']);
	$market['name'] = str_replace("//", "_", $market['name']);
	$market['name'] = ereg_replace("/", "_", $market['name']);

	$root_folder = 'components/com_camassistant/assets/images/companyrefs/';
	$base_market = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'companyrefs'.DS.$user->id.DS;
				// Remove all the files in folder if they exist
				jimport('joomla.client.helper');
				if(is_dir($base_market))
					{
					
					}
				else {
			    JFolder::create( $base_market );
				}
	$filepath = $base_market.$market['name'] ;			
	$success_upload = move_uploaded_file($market['tmp_name'], $filepath);
	if($success_upload){
	$date = date('Y-m-d H:i:s');
	$query = "insert into #__vendor_companyrefs (`id`, `vendorid`, `filename`, `uploaddate`) VALUES ('','".$user->id."','".$market['name']."','".$date."')";
	$db->setQuery($query);
		if( $db->query() ) {
		//echo "<script language='javascript' type='text/javascript'> window.parent.document.getElementById( 'sbox-window' ).close(); 
		echo "<script language='javascript' type='text/javascript'>
			window.parent.document.getElementById( 'sbox-window' ).close();
			alert('New file uploaded successfully');
			window.parent.parent.location.reload();
			 </script>";
		//$url = "index.php?option=com_camassistant&controller=vendors&task=marketdocs&Itemid=221"; $msg = 'New file has been uploaded successfully.'; $this->setRedirect($url,$msg);
		}
	}
	else{
	$link = 'index.php?option=com_camassistant&controller=vendors&task=companyrefs&Itemid=255';
	$msg="Not able to upload the file. Please try again after some time.";
	$this->setRedirect( $link,$msg );
	}
	}
	function openrefdocs(){
		$user	= JFactory::getUser();
		$db = JFactory::getDBO();
		$filename = JRequest::getVar('filename','');
		$folder_type = JRequest::getVar('folder_type','');
		$outerid = JRequest::getVar('vendorid');
		
		if(!$user->id) {
			if(!$outerid){
			$vendor_id = JRequest::getVar('id');
			}
			else{
			$vendor_id = $outerid ;
			}
		}
		else if($outerid){
			$vendor_id = $outerid ;
		}
		else{
			$vendor_id = $user->id ;
		}
	
	
		if($user->id == '0') {
		
		}
		$path = JURI::root().'components/com_camassistant/assets/images/companyrefs/'.$vendor_id;
		$doc_name = $path.'/'.$filename;
		header("content-type: application/octet-stream");
		header("Content-Disposition: attachment; filename=".$filename);
		readfile($doc_name);
		exit;	
	}
	
	function deletcrefs(){
	$user	= JFactory::getUser();
	$db = JFactory::getDBO();
	$id = JRequest::getVar('id','');
	$filename = JRequest::getVar('filename','');
	$query = "DELETE FROM #__vendor_companyrefs WHERE id=".$id." and vendorid=".$user->id; 
	$db->setQuery($query); 
	if($db->query()){
	echo "success";
	}
	else{
	echo "fail";
	}
	exit;		
	}
	//Completed
	
	//Function to get the total marketing documents into My Profile page
	function crefsprofile(){
	$db = JFactory::getDBO();
	$user = JFactory::getUser();
	$outerid = JRequest::getVar('id');
	if(!$user->id) {
		if(!$outerid){
		$vendor_id = JRequest::getVar('id');
		}
		else{
		$vendor_id = $outerid ;
		}
	}
	else if($outerid){
		$vendor_id = $outerid ;
	}
	else{
		$vendor_id = $user->id ;
	}
	
	$sub = "SELECT *  FROM #__vendor_companyrefs where vendorid=".$vendor_id.""; 
	$db->Setquery($sub);
	$list = $db->loadObjectList();
	if($list){ 
 for($i=0; $i<count($list); $i++){ ?>
<?php 
if($i == '4' || $i == '8' || $i == '12' || $i == '16' || $i == '20' || $i == '24' || $i == '28' || $i == '32') {?>
<div class="clear"></div>
<div class="sepdashbutton"></div>
<br /><br />
<?php } ?>
<div class="nvnv" style="padding-right:8px; margin-left:5px; width:146px;">
<h6><?php 
$strlen = strlen($list[$i]->filename) ;

if($strlen > 18){
$result = substr($list[$i]->filename, 0, 18);
echo $result.'...' ;
}
else{
echo str_replace('_',' ',$list[$i]->filename) ;
}
?></h6>
<div class="dal-tie">
<?php $ext = end(explode('.', $list[$i]->filename)); ?>
<a target="_blank" href="index.php?option=com_camassistant&controller=vendors&task=viewcrefdocs&filename=<?php echo $list[$i]->filename; ?>&vendorid=<?php  echo $vendor_id; ?>"><img src="templates/camassistant_inner/images/doc_images/images_<?php echo $ext; ?>.png" /></a>
</div>
</div>

<?php 
} 
}
else {
	if($user->user_type == '13' || $user->user_type == '12' || $_REQUEST['from'] == 'public'){
	echo "<p align='center' style='color:gray; font-weight:bold; font-size:13px;'>This Vendor has not uploaded any Company References.<br /><br /></p>";
	}
	else{
	echo "<p align='center' style='color:gray; font-weight:bold; font-size:13px;'>You have not uploaded any Company References<br /><br /></p>";
	}
}
	exit;
	}

function viewcrefdocs(){
		$user	= JFactory::getUser();
		$db = JFactory::getDBO();
		$vendorid = JRequest::getVar('vendorid','');
		if($vendorid){
		$vendor_id = $vendorid ;
		}
		else{
		$vendor_id = $user->id ;
		}
		$filename = JRequest::getVar('filename','');
		$path = 'components/com_camassistant/assets/images/companyrefs/'.$vendor_id;
		$doc_name = $path.'/'.$filename;
		$link = 'index.php?option=com_camassistant&controller=vendors&task=viewreffile&Itemid=221&file='.$filename.'&doc='.$doc_name.'&vendorid='.$vendor_id.'';
		$this->setRedirect( $link,'' );
	}

	
	// Function to update the industry from My Profile [page
	function saveindustries(){
		$user = JFactory::getUser();
		$db = JFactory::getDBO();
		$industries = JRequest::getVar('cid');
		
		//Get vendor company id
		$vendorcid = "SELECT id FROM #__cam_vendor_company WHERE user_id=".$user->id." ";
		$db->Setquery($vendorcid);
		$vendorid = $db->loadResult();
		//Completed
		//Delete existing vendor industries
		$query = "DELETE FROM #__cam_vendor_industries WHERE user_id=".$user->id." and vendor_id=".$vendorid." "; 
		$db->setQuery($query); 
		$db->query() ;
			
		for($i=0; $i<count($industries); $i++){
		$query = "insert into #__cam_vendor_industries (`id`, `user_id`, `vendor_id`, `industry_id`) VALUES ('','".$user->id."','".$vendorid."','".$industries[$i]."')";
		$db->setQuery($query);
		$db->query();
		}
			$link = 'index.php?option=com_camassistant&controller=vendors&task=vendor_edit_form&view=vendors&Itemid=114';
			$msg="Updated successfully";
		    $this->setRedirect( $link,$msg );
	}
	// Function to update the areas from My Profile [page
	function saveareas(){
		$user = JFactory::getUser();
		$db = JFactory::getDBO();
		$counties = JRequest::getVar('cid');
		// Get state code of the vendor
		$sql_statecode = "SELECT v.code FROM #__cam_vendor_states as v, #__cam_vendor_company as u WHERE u.user_id=".$user->id." and u.state=v.id ";
		$db->Setquery($sql_statecode);
		$statecode = $db->loadResult();
		//Completed
		//Delete existing vendor industries
		$query = "DELETE FROM #__vendor_state_counties WHERE user_id=".$user->id." and state_id='".$statecode."' "; 
		$db->setQuery($query); 
		$db->query() ;
		
		for($i=0; $i<count($counties); $i++){
		 $query = "insert into #__vendor_state_counties (`id`, `user_id`, `state_id`, `county_id`) VALUES ('','".$user->id."','".$statecode."','".$counties[$i]."')";
		$db->setQuery($query);
		$db->query();
		}
		
		$link = 'index.php?option=com_camassistant&controller=vendors&task=vendor_edit_form&view=vendors&Itemid=114';
			$msg="Updated successfully";
		    $this->setRedirect( $link,$msg );
	}
	
	// Function to check the password
	function verifypassword(){
		
		$user = JFactory::getUser();
		$db = JFactory::getDBO();
		$password = JRequest::getVar('Password');
		$query = "SELECT id, password FROM #__users WHERE id=".$user->id." ";
		$db->setQuery($query);
		$result = $db->loadObject();
		
		$hashparts = explode (':' , $result->password);
		$userhash = md5($password.$hashparts[1]);
		if( $userhash == $hashparts[0] ){
			echo "Yes";
		}
		else{
			echo "No";
		}
			exit;
	}
	
	//Completed
	
	function savepassword(){
		jimport('joomla.filesystem.file');
		jimport('joomla.user.helper');
		$user = JFactory::getUser();
		$db = JFactory::getDBO();
		
		$password	= JRequest::getVar('new', '', 'post', 'string', JREQUEST_ALLOWRAW);
		$password2	= JRequest::getVar('renew', '', 'post', 'string', JREQUEST_ALLOWRAW);
		$salt		= JUserHelper::genRandomPassword(32);
		$crypt		= JUserHelper::getCryptedPassword($password, $salt);
		$password1	= $crypt.':'.$salt;
		
		 $update = "UPDATE #__users SET password='".$password1."'  where id =".$user->id;  
			$db =& JFactory::getDBO();
			$db->setQuery($update);
			$res12=$db->query();
		if( $db->query() )	 {
			echo "<script language='javascript' type='text/javascript'>
			 window.parent.location.reload();
			 window.parent.document.getElementById( 'sbox-window' ).close();
			 window.location = 'index.php?option=com_camassistant&controller=vendors&task=vendor_dashboard&logo=yes&Itemid=112';
			 </script>";
			exit;	
		}
		exit;
			
	}
	
	function updatesubscribe_free(){ 	// Function to get FREE subscription
	//echo "<pre>"; print_r($_REQUEST); exit;
		$user = JFactory::getUser();
		$db = JFactory::getDBO();
			$date = date('Y-m-d'); 
			$nextdate = date('Y-m-d', strtotime('+1 year'));
			//Delete Old information
			$model = $this->getModel('vendors');
			$oldid ="SELECT subscribeid FROM #__cam_vendor_subscriptions where subscribeid!= 'A-AAAAAAAAAAAA' and vendorid=".$user->id;
			$db->Setquery($oldid);
			$subscribeid = $db->loadResult();
			if( $subscribeid ){
			$recurresponxe = $model->change_subscription_status( $subscribeid, 'Cancel' );
			}
			$delete = $model->deletesubscription();
			//To send the mail to vendors after subscription is completed
		$notification = "SELECT introtext  FROM #__content where id='48'";
		$db->setQuery($notification);
		$body = $db->loadResult();
		//To get the vendor company
		$vendor_company = "SELECT company_name  FROM #__cam_vendor_company where user_id=".$user->id."";
		$db->setQuery($vendor_company);
		$vcompanyv = $db->loadResult();
		$body = str_replace('{Company Name}', $vcompanyv, $body);
		$body = str_replace('{membership}', 'Basic Membership', $body);
		
		$mailfrom = 'support@myvendorcenter.com';
		$from  = 'MyVendorCenter Support';
		$to = $user->email;
		$subject = 'Subscription Plan for MyVendorCenter ';
		$res = JUtility::sendMail($mailfrom, $from, $to, $subject, $body, $mode=1);
		
		$to_rize = 'sk4576@gmail.com';
		$res = JUtility::sendMail($mailfrom, $from, $to_rize, $subject, $body, $mode=1);
		
		$cc = $user->ccemail ;
		$cclist = explode(';',$cc);
		for($c=0; $c<=count($cclist); $c++){
			$listcc = $cclist[$c];
				if($listcc){
					$res = JUtility::sendMail($mailfrom, $from, $listcc, $subject, $body, $mode=1);
				}
		}
		
		
		$to_support = 'vendoremails@myvendorcenter.com';
		$res = JUtility::sendMail($mailfrom, $from, $to_support, $subject, $body, $mode=1);
		//Completed
		$sql_up = "UPDATE #__users SET subscribe='yes', subscribe_sort='4', subscribe_type='free', subscribe_admin='free' WHERE id='".$user->id."'";
		$db->setQuery($sql_up);
		$res = $db->query();
		
			$query = "insert into #__cam_vendor_subscriptions (`id`, `vendorid`, `coupon`, `paid`, `ctype`, `subscribeid`, `date`, `nextdate`) VALUES ('','".$user->id."','','0.00','free','A-AAAAAAAAAAAA','".$date."','".$nextdate."')";
		$db->setQuery($query);
		if( $db->query() ){
			$user->subscribe_type = 'free';
			$link = 'index.php?option=com_camassistant&controller=vendors&task=vendor_dashboard&Itemid=112';
			$msg="";
			$this->setRedirect( $link,$msg );
		}
						
		
		
	}
	
	//Functio delete the proposal
	function delete_proposal(){
		$db =& JFactory::getDBO();
		$user = JFactory::getUser();
		$rfpid = JRequest::getVar('rfpid');
		$pid = JRequest::getVar('pid');
		$alt = JRequest::getVar('alt');
		if( $alt == 'yes' )
			$altp = 'yes';
		else
			$altp = '';	
		$model = $this->getModel('vendors');
		$delete_proposals = $model->delete_proposals($rfpid,$pid,$altp);  // Deleting info from proposals table
		$delete_uploadfiles = $model->delete_uploadfiles($rfpid,$pid,$altp);  // Deleting info from uploadfiles table
		$delete_lineitems_prices = $model->delete_lineitems_prices($rfpid,$pid,$altp);	// Deleting info from lineitems_prices
		$delete_addnotes = $model->delete_addnotes($rfpid,$pid,$altp);	// Deleting info from addnotes table
		$delete_addexception = $model->delete_addexception($rfpid,$pid,$altp);	// Deleting info from addexception table
		$delete_generalfiles = $model->delete_generalfiles($rfpid,$pid,$altp);	// Deleting info from generalfiles table

		if( $altp == '' ){
		$update_proposals = $model->update_proposals($rfpid,$pid,$altp);  // Deleting info from proposals table
		$update_uploadfiles = $model->update_uploadfiles($rfpid,$pid,$altp);  // Deleting info from uploadfiles table
		$update_lineitems_prices = $model->update_lineitems_prices($rfpid,$pid,$altp);	// Deleting info from lineitems_prices
		$update_addnotes = $model->update_addnotes($rfpid,$pid,$altp);	// Deleting info from addnotes table
		$update_addexception = $model->update_addexception($rfpid,$pid,$altp);	// Deleting info from addexception table
		$update_generalfiles = $model->update_generalfiles($rfpid,$pid,$altp);	// Deleting info from addexception table
		}
		
		$link = 'index.php?option=com_camassistant&controller=vendors&task=vendor_dashboard&Itemid=112';
		$msg="";
		$this->setRedirect( $link,$msg );
	}
	//Completed
	//Function to get invitation details
	function getinvitationdetails(){
		$db =& JFactory::getDBO();
		$user = JFactory::getUser();
		$rfpid = JRequest::getVar('rfp');
		$proposalid = JRequest::getVar('proposalid');
		$propertyid = JRequest::getVar('propertyid');
		$type = JRequest::getVar('type');
		$model = $this->getModel('vendors');
		$p_data = $model->getproposalinfo($rfpid);
		
		$mgr_info = $model->getmanagerinfo($rfpid, $p_data->property_id, $p_data->cust_id);
		$powner_info = $model->getpropertyownerinfo($rfpid, $p_data->property_id, $p_data->cust_id);
		$property_info = $model->getpropsinfo($p_data->property_id);
		$uninvited = $model->proposaluninvited($rfpid);
		
		$draftsinfo = $model->proposaluninvited_drafts($rfpid,$proposalid);
		$count = $model->gettotalbids($rfpid);
		//Get total bids for create alternate proposal link
		$count_numbers = $model->gettotalbids_newlink($rfpid);
		//echo "<pre>"; print_r($mgr_info); echo "</pre>";
		?>
		<table width="100%" border="0" style="margin:0px 0px; border:1px solid #A3A3A3; background:#F7F7F7">
		<tbody>
		<tr>
		<?php if( $type == 'drafts' ) { ?>
		
		<td align="center">
		<ul class="addednum">
		<?php if( $draftsinfo->proposaltype != 'uninvited' ) { ?>
		<li>
		<a href="index.php?option=com_camassistant&controller=proposals&task=vendor_proposal_preview&Alt_Prp=<?PHP echo $draftsinfo->Alt_bid; ?>&Proposal_id=<?PHP echo $proposalid;?>&vendor_id=<?PHP echo $user->id;?>&rfp_id=<?PHP echo $rfpid;?>&jobtype=<?PHP echo $p_data->jobtype; ?>&pagefrom=draftstatus&action=view&Itemid=107">VIEW</a>
		</li>
		<?PHP if($p_data->rfp_type!= 'closed' && $p_data->rfp_type!= 'Unawarded' && $p_data->rfp_type!= 'Awarded') { ?><li><a href="index.php?option=com_camassistant&controller=proposals&Alt_Prp=<?PHP echo $draftsinfo->Alt_bid;?>&task=Proposal_edit&Proposal_id=<?PHP echo $proposalid;?>&vendor_id=<?PHP echo $user->id;?>&rfp_id=<?PHP echo $rfpid;?>&act=Draft&reject=<?PHP echo $draftsinfo->publish; ?>&jobtype=<?PHP echo $p_data->jobtype; ?>&Itemid=107&mailtype=second">SUBMIT PROPOSAL</a></li><?PHP }  ?>
		<?php if( $count == '2' ) { ?>
		<li><a href="javascript:void(0);" class="deleteproposal" onClick="deleteproposal('<?PHP echo $rfpid; ?>','<?php echo $proposalid; ?>','<?php echo $draftsinfo->Alt_bid; ?>');" >DELETE</a></li>
	<?php } ?>
		<?php } 
		else {
		echo '<li><a class="uninitetext_vendor" href="javascript:void(0);" onclick="getshowmessage('.$rfpid.');">UNINVITED</a></li>';
		}
		?>
		</ul>
		</td>
		
		<?php } 
		else if( $type == 'submitted' ){ ?>
		
		<td align="center">
		<ul class="addednum">
		<?php if( $draftsinfo->proposaltype != 'uninvited' ) { ?>
		<li>
		<a href="index.php?option=com_camassistant&controller=proposals&task=vendor_proposal_preview&Alt_Prp=<?PHP echo $draftsinfo->Alt_bid; ?>&Proposal_id=<?PHP echo $proposalid;?>&vendor_id=<?PHP echo $user->id;?>&jobtype=<?PHP echo $p_data->jobtype; ?>&rfp_id=<?PHP echo $rfpid;?>&action=view&Itemid=108">VIEW</a>
		</li>
		<?php if($p_data->rfp_type != 'closed'){ ?>
		<li><a href="index.php?option=com_camassistant&controller=proposals&Alt_Prp=<?PHP echo $draftsinfo->Alt_bid;?>&task=Proposal_edit&Proposal_id=<?PHP echo $proposalid;?>&vendor_id=<?PHP echo $user->id;?>&rfp_id=<?PHP echo $rfpid;?>&act=Submit&reject=<?PHP echo $draftsinfo->publish; ?>&jobtype=<?PHP echo $p_data->jobtype; ?>&Itemid=108">EDIT</a>
		</li><?PHP }  ?>
		<?php if( $p_data->rfp_type != 'closed' && $count == '2' ) { ?>
		<li><a href="javascript:void(0);" class="deleteproposal" onClick="deleteproposal('<?PHP echo $rfpid; ?>','<?php echo $proposalid; ?>','<?php echo $draftsinfo->Alt_bid; ?>');" >DELETE</a></li>
	<?php } ?>
		<?PHP if($p_data->rfp_type != 'closed' && $count_numbers == 1) { ?>
		<li><a href="index.php?option=com_camassistant&controller=proposals&task=copyproposal&Proposal_id=<?PHP echo $proposalid;?>&rfp_id=<?PHP echo $rfpid; ?>&jobtype=<?PHP echo $p_data->jobtype; ?>">Create Alternate Proposal</a></li>
	<?php } ?>
		<?php } 
		else {
		echo '<li><a class="uninitetext_vendor" href="javascript:void(0);" onclick="getshowmessage('.$rfpid.');">UNINVITED</a></li>';
		}
		?>
		</ul>
		</td>
		
		<?php }
		else if( $type == 'awarded' ){ ?>
		<td align="center">
		<ul class="addednum">
		<li>
		<a href="index.php?option=com_camassistant&controller=proposals&task=vendor_proposal_preview&Alt_Prp=<?PHP echo $draftsinfo->Alt_bid; ?>&Proposal_id=<?PHP echo $proposalid;?>&vendor_id=<?PHP echo $user->id;?>&rfp_id=<?PHP echo $rfpid;?>&jobtype=<?php echo $p_data->jobtype; ?>&action=view&Itemid=112">VIEW</a>
		</li>
		</ul>
		</td>
		<?php } 
		else if( $type == 'declined' ){  ?>
		<td align="center">
		<ul class="addednum">
		<li>
		<a href="index.php?option=com_camassistant&controller=proposals&task=vendor_proposal_form&view=proposals&Prp_id=<?PHP echo $propertyid;  ?>&rfp_id=<?PHP echo $rfpid;  ?>&mot_interested=2&type=invitation&id=<?PHP echo $proposalid; ?>&type=invitation&jobtype=<?php echo $p_data->jobtype; ?>&Itemid=112">View Job Details</a>
		</li>
		</ul>
		</td>
		<?php } 
		 else { ?>
		<td align="center">
		<ul class="addednum">
		<li>
		<?php if( $uninvited != 'uninvited' && $p_data->create_rfptype=='open') { ?>
		<a href="index.php?option=com_camassistant&controller=proposals&task=vendor_proposal_form&view=proposals&Prp_id=<?PHP echo $propertyid;  ?>&rfp_id=<?PHP echo $rfpid; ?>&mot_interested=0&type=invitation&id=<?PHP echo $p_data->id; ?>&jobtype=<?php echo $p_data->jobtype; ?>&reqtype=<?php echo $p_data->create_rfptype; ?>&Itemid=112">View Request</a>
		<?php } 
		else if($uninvited != 'uninvited' ){ ?>
		<a href="index.php?option=com_camassistant&controller=proposals&task=vendor_proposal_form&view=proposals&Prp_id=<?PHP echo $propertyid;  ?>&rfp_id=<?PHP echo $rfpid; ?>&mot_interested=0&type=invitation&id=<?PHP echo $p_data->id; ?>&jobtype=<?php echo $p_data->jobtype; ?>&Itemid=112">Respond to Invite</a>
		<?php } 
		else {
		echo '<a class="uninitetext_vendor" href="javascript:void(0);" onclick="getshowmessage('.$rfpid.');">UNINVITED</a>';
		}
		?>
		</li>
		</ul>
		</td>
		
		<?php } ?>
		</tr>
		<tr class="table_blue_rowdotsextend_gray">
		<td align="center" valign="middle" colspan="5"><strong>CONTACT INFO</strong></td>		
		</tr>
		<tr height="5"></tr>
		<?php if($powner_info->user_type == '16') { ?>
		<tr><td align="center"><?php echo $powner_info->name.'&nbsp;'.$powner_info->lastname; ?></td></tr>
		<?php  } else { ?>
		<tr><td align="center"><?php echo $mgr_info->name.'&nbsp;'.$mgr_info->lastname; ?></td></tr>
		<?php } ?>	
		<tr><td align="center"><?php echo $property_info->street.', '.$property_info->city.', '.$property_info->state.', '.$property_info->zip; ?></td></tr>
		<?php if($powner_info->user_type == '16') { ?>
		<tr><td align="center"><?php if(  $p_data->jobtype == 'yes' ) { echo $powner_info->phone; if( $powner_info->extension ) echo '&nbsp;('.$powner_info->extension.')'; } ?></td></tr>		
		<tr><td align="center"><?php if( $p_data->jobtype == 'yes' ) { echo $powner_info->cellphone; } ?></td></tr>		
		<tr><td align="center"><a class="mailto" href="mailto:<?php echo $powner_info->email; ?>">
		<?php if( $p_data->jobtype == 'yes' ) { echo $powner_info->email; } ?></a></td></tr>
		<?php } else { ?>
		<tr><td align="center"><?php if( $mgr_info->showphone == '0' || $p_data->jobtype == 'yes' ) { echo $mgr_info->comp_phno; if( $mgr_info->comp_extnno ) echo '&nbsp;('.$mgr_info->comp_extnno.')'; } ?></td></tr>		
		<tr><td align="center"><?php if( $mgr_info->showphone == '0' || $p_data->jobtype == 'yes' ) { echo $mgr_info->cellphone; } ?></td></tr>		
		<tr><td align="center"><a class="mailto" href="mailto:<?php echo $mgr_info->email; ?>">
		<?php if( $mgr_info->showemail == '0' || $p_data->jobtype == 'yes' ) { echo $mgr_info->email; } ?></a></td></tr>
		<?php } ?>
		<tr><td colspan="2" align="center">
                        <?php if(! $type == 'drafts' ) { ?>
		<a rel="<?php  echo $rfpid; ?>" href="javascript:void(0);" class="decline_rfpjob_home" id="declineinvitation"></a>
                        <a onClick="javascript: return ITB_save(<?php  echo $rfpid; ?>);" class="accept_rfpjob_home" href="javascript:void(0);"></a><?php }?></td></tr>
<tr><td>
<form method="post" id="proposal_form_<?PHP echo $rfpid; ?>" name="vendor_proposal_form_<?PHP echo $rfpid; ?>"  action="index.php?option=com_camassistant&controller=proposals&rfp_id=1">
<input type="hidden" name="rfp_id" value="<?PHP echo $rfpid; ?>" />
<input type="hidden" name="Prp_id" value="<?PHP echo $propertyid; ?>" />
<input type="hidden" name="Proposal_id" value="" />
<input type="hidden" name="Itemid" value="112" />
<input type="hidden" name="id" value="<?PHP echo $p_data->id; ?>" />
<input type="hidden" name="submit_type" id="submit_type" value="ITB" />
<input type="hidden" name="contact_name" id="contact_name_<?PHP echo $rfpid; ?>" value="" />
<input type="hidden" name="Alt_bid" id="Alt_bid" />
<input type="hidden" name="task" id="task" value="Proposal_save_as_ITB" />
<input type="hidden" value="yes" name="itb" />
<input type="hidden" value="<?php echo $p_data->jobtype; ?>" name="jobtype" />
</form>
</td></tr>
		<tr height="5"></tr>
		</tbody></table>
		<?php
		exit;
	}
	
}

?>
