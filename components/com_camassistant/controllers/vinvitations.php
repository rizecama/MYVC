<?php
/**
 * @version		1.0.0 camassistant $
 * @package		camassistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport('joomla.application.component.controller');

class vinvitationsController extends JController
{

	function __construct()
	{
		parent::__construct();
	}
	function display()
	{
	parent::display();
	}
	function sendinvitation(){
	$db= JFactory::getDBO();
	$user=JFactory::getUser();
	//To get the manager company name
	$companyname = "SELECT comp_name  FROM #__cam_customer_companyinfo where cust_id=".$user->id." ";
		$db->setQuery( $companyname );
		$c_name = $db->loadResult();
	//Completed
	$body ="SELECT introtext  FROM #__content where id='257' ";
		$db->setQuery( $body );
		$body = $db->loadResult();
		$body = str_replace('[Manager Name]',$user->name.' '. $user->lastname,$body);
		$body = str_replace('[Management Firm Name]',$c_name,$body);

		$mailfrom = $user->email;
		$fromname = $user->name.' '. $user->lastname;
		//$assignuseremail = 'rize.cama@gmail.com';
		$assignuseremail = 'support@myvendorcenter.com';
		$mailsubject = 'Vendor Invitation';
		$assignuseremail = JRequest::getVar('email','');
		$mailsubject = JRequest::getVar('subject','');
		$mailfrom = $user->email ;
		$res = JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
		//To send the mail to CC
		$cc = JRequest::getVar('ccemail','');
		$cclist = explode(';',$cc);
		for($c=0; $c<=count($cclist); $c++){
		$listcc = $cclist[$c];
		if($listcc){
		$res = JUtility::sendMail($mailfrom, $fromname, $listcc, $mailsubject, $body, $mode = 1);
		}
		}
		//To CC
		$ccemail = 'vendoremails@myvendorcenter.com';
		$res = JUtility::sendMail($mailfrom, $fromname, $ccemail, $mailsubject, $body, $mode = 1);
		//Completed
		//Completed
		$data['vendoremailid'] = JRequest::getVar('email','');
		$data['vendoremailid'] = str_replace(' ','',$data['vendoremailid']);
		$model = $this->getModel('vinvitations');
		$save = $model->getsavedetails($data);
		$newURL = "index.php?option=com_camassistant&controller=vinvitations&Itemid=".$_REQUEST['Itemid']."";
		header('Location: '.$newURL);
		//$msg="Vendor Invitation has been sent successfully.";
		//$this->setRedirect( $link,$msg );
	}	
	
	function hideinvitation(){
			$db =& JFactory::getDBO();
			$hideid = JRequest::getVar('hideid','');
			$user=JFactory::getUser();
			$hidemail = explode('-',$hideid);
			$update_hide = "UPDATE #__cam_newvendorinvitations SET publish='1' where managerid=".$user->id." and vendoremailid ='".$hidemail[1]."' ";
			$db->setQuery($update_hide);
			$hide = $db->query();
			if($hide)
			$msg="yes";
			else
			$msg="no";
			echo $msg; 
			exit;
	}
	
	
	function resendinvitation(){
	$db= JFactory::getDBO();
	$user=JFactory::getUser();
	//To get the manager company name
	$companyname = "SELECT comp_name  FROM #__cam_customer_companyinfo where cust_id=".$user->id." ";
		$db->setQuery( $companyname );
		$c_name = $db->loadResult();
	//Completed
	$body ="SELECT introtext  FROM #__content where id='257' ";
		$db->setQuery( $body );
		$body = $db->loadResult();
		$body = str_replace('[Manager Name]',$user->name.' '. $user->lastname,$body);
		$body = str_replace('[Management Firm Name]',$c_name,$body);

		$mailfrom = $user->email;
		$fromname = $user->name.' '. $user->lastname;
		//$assignuseremail = 'rize.cama@gmail.com';
		$assignuseremail = 'support@myvendorcenter.com';
		$mailsubject = 'Vendor Invitation';
		$assignuseremail = JRequest::getVar('email','');
		$mailsubject = $user->name.' '.$user->lastname.' would like you to join MyVendorCenter';
		$mailfrom = $user->email ;
		$res = JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
		$ccemail = 'vendoremails@myvendorcenter.com';
		$res = JUtility::sendMail($mailfrom, $fromname, $ccemail, $mailsubject, $body, $mode = 1);
		//Completed
		//Completed
		$update_hide = "UPDATE #__cam_newvendorinvitations SET date='".date('Y-m-d H:i')."' where vendoremailid ='".$assignuseremail."' and managerid=".$user->id." ";
		$db->setQuery($update_hide);
		$hide = $db->query();
		echo "success";
		exit;
		//$msg="Vendor Invitation has been sent successfully.";
		//$this->setRedirect( $link,$msg );
	}
}
?>