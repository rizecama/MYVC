<?php
/**
 * @version		1.0.0 camassistant $
 * @package		camassistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
// written by anand babu

defined('_JEXEC') or die('Restricted access');

jimport('joomla.application.component.controller');

class vendorscenterController extends JController
{

	function __construct()
	{
		parent::__construct();
	}

	function display()
	{
		
		parent::display();
	}
	
	//function to display vendor propsals
	function vendorscenter()
	{
		
	    $user	= JFactory::getUser();
		if($user->user_type == 13)
		{
		JRequest::setVar('view', 'vendorscenter');
		parent::display();
		}
		
		else if($user->user_type == 12)
		{
		JRequest::setVar('view', 'vendorscenter');
		parent::display();
		}
		else if($user->user_type == 16)
		{
		JRequest::setVar('view', 'vendorscenter');
		parent::display();
		}
		else
		{
		JRequest::setVar('task', 'not_authorized');
		JRequest::setVar('view', 'vendorscenter');
		parent::display();
		}
	   //JRequest::getVar('view','vendors');
	  // parent::display();
	}
	//function to redirection after mail is sent
	function mail_redirect_form()
	{
	   JRequest::getVar('view','vendors');
	   parent::display();
	}
	
	//function to edit vendor info
	function vendor_edit_form()
	{
		JRequest::getVar('view','vendors');
		parent::display();
	}
	
	//function to display vendor billing form
	function vendor_billing_form()
	{
		JRequest::getVar('view','vendors');
		parent::display();
	}
	
	//function to redirection if paypayl is success
	function vendor_billing_thankyou_form()
	{
		JRequest::getVar('view','vendors');
		parent::display();
	}
	
	//function to redirection if paypay is failed
	function vendor_billing_failed_form()
	{
		JRequest::getVar('view','vendors');
		parent::display();
	}
	
	//function to save vendor  info
	function save_billing_info()
	{
		$model = $this->getModel('vendors');
		$post	= JRequest::get('post');
		$user	= JFactory::getUser();
		$data['user_id']		= $user->id;
		$data['credit_card']	= $post['credit_card'];
		$data['card_number'] 	= $post['card_number'];
		$data['expired_date_day'] 	= $post['expired_date_day'];
		$data['expired_date_year'] = $post['expired_date_year'];
		$data['pay_amount'] 	= $post['pay_amount'];
		$data['address'] 		= $post['address'];
		$data['city'] 	= $post['city'];
		$data['state'] 	= $post['state'];
		$data['zipcode']	= $post['zipcode'];
		$data['nation'] 	= $post['nation'];
		if($model->store_billing_info($data)) {
		$link = 'index.php?option=com_camassistant&controller=vendors&task=paypal_form&cost='.$data['pay_amount'].'&Itemid=68';
		$msg="";
		$this->setRedirect( $link,$msg );
		}
	}
	//function to redirect vendor billing form to paypal url
	function paypal_form()
	{ 
		JRequest::getVar('view','vendors');
		parent::display();
	}
	//function to save industries selected in popup to a session
	function industries_Save()
	{
		//session_destroy();
		session_start();
		$ind_ary 				= JRequest::getVar('cid','','post','array',REQUEST_ALLOWRAW);
		$_SESSION['industries'] = $ind_ary;
		$ind = implode(',',$ind_ary); 
		
		echo "<script language='javascript' type='text/javascript'>
		var val = '".$ind."';
		window.parent.document.getElementById('industries').value = val;
		window.parent.document.getElementById( 'sbox-window' ).close();
		//window.parent.parent.location.reload();
		 </script>"; 
	}
	//function to save vendor info,company info
	function thanks()
	{
		jimport('joomla.user.helper');
		$post	= JRequest::get('post');
		$user=clone(JFactory::getUser(0));
		$data['id']			= $post['user_id'];
		$data['name']		= $post['name'];
		$data['username']	= $post['email'];
		$data['password'] 	= $post['password'];
		$data['password2'] 	= $post['password2'];
		$data['salutation'] = $post['salutation'];
		$data['lastname'] 	= $post['lastname'];
		$data['email'] 		= $post['email'];
		$data['phone'] 		= $post['phone_1'].'-'.$post['phone_2'].'-'.$post['phone_3'];
		$data['extension'] 	= $post['extension'];
		$data['cellphone'] 	= $post['cell_1'].'-'.$post['cell_2'].'-'.$post['cell_3'];
		$data['usertype']	= 'Registered';
		$data['user_type'] 	= '11';
		$data['gid']		= '18';
		$data['block']		= '1';
		
		//code to update existing user record
		if($post['user_id'] != '')
		{
		    jimport('joomla.filesystem.file');
			$files		= JRequest::getVar( 'image', '', 'files', 'array' );
			$data['block']		='0';
			if(!$user->bind($data)) {
			echo $user->getError();
			}else {
			if (!$user->save()){ 
			echo $user->getError();
			}
			} 
			//code to update image in vendor table
			if($files && $files['name'] != '')
			{
				//code to update image filed in vendors table
				$db = JFactory::getDBO();
				$sql = "SELECT image FROM  #__cam_vendor_company  where user_id='".$data['id']."'"; 
				$db->Setquery($sql);
				$prev_image = $db->loadResult();
				$sql = "UPDATE #__cam_vendor_company SET image='".$files['name']."' where user_id='".$data['id']."'"; 
				$db->Setquery($sql);
				$db->query();
				//code to move image to folderpath
				$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendors'.DS;
				$filename =$files['name'];
				$filepath = $base_Dir . $filename;  
				$post['image'] = $filename;
				if(file_exists($base_Dir . $prev_image))
							@unlink($base_Dir . $prev_image);
				move_uploaded_file($files['tmp_name'], $filepath); 
			}
			$link = 'index.php?option=com_camassistant&controller=vendors&task=vendor_edit_form&view=vendors&Itemid=72';
			$msg="Updated successfully";
		    $this->setRedirect( $link,$msg );
		}
		
		else if(!isset($post['user_id']) && $post['user_id'] == '')
		{
			//code to insert new user in users table
			if(!$user->bind($data)) {
			echo $user->getError();
			}else {
			if (!$user->save()){
			echo $user->getError();
			}
			}
			//code to update jos_cam_vendor_company table
			$vendor['user_id']						= $user->id;
			$vendor['company_name'] 				= $post['company_name'];
			$vendor['company_address']				= $post['company_address'];
			$vendor['tax_id'] 						= $post['tax_id'];
			$vendor['city'] 						= $post['city'];
			$vendor['state'] 						= $post['state'];
			$vendor['zipcode'] 						= $post['zipcode'];
			$vendor['in_house_vendor'] 				= $post['in_house_vendor'];
			$vendor['in_house_parent_company'] 		= $post['in_house_parent_company'];
			$vendor['in_house_parent_company_FEIN'] = $post['in_house_parent_company_FEIN'];
			$vendor['miles']						= $post['miles'];
			$vendor['company_phone'] 				= $post['company_phone'];
			$vendor['phone_ext'] 					= $post['phone_ext'];
			$vendor['alt_phone'] 					= $post['alt_phone'];
			$vendor['alt_phone_ext']				= $post['alt_phone'];
			$vendor['established_year'] 			= $post['established_year'];
			$vendor['not_interest_RFP']				= $post['not_interest_RFP'];
			$vendor['interest_RFP_alerts'] 			= $post['interest_RFP_alerts'];
			$vendor['authorized_business'] 			= $post['authorized_business'];
			$vendor['preferred_vendors'] 			= $post['preferred_vendors'];
			$vendor['company_web_url'] 				= $post['company_web_url'];
			$vendor['status'] 						= '0';
			$vendor['created'] 						= date('Y-m-d');
			$vendor['published']					= '0';
			$userid = $user->id;
			//echo "<pre>"; print_r($vendor); exit;
			//code to update vendor_industries table
			
			if($user->id)
			{
				//image upload code
				jimport('joomla.filesystem.file');
				$files		= JRequest::getVar( 'image', '', 'files', 'array' );
				$vendor['image'] 						= $files['name'];
				$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendors'.DS; 
				if($files && $files['name'] != '')
				{
					$filename =$files['name'];
					$filepath = $base_Dir . $filename;  
					$post['image'] = $filename;
					if(file_exists($base_Dir . $filename))
								@unlink($base_Dir . $filename);
					move_uploaded_file($files['tmp_name'], $filepath); 
				}
				
				$model = $this->getModel('vendors');
				if($model->store($vendor)) {
				$msg = JText::_( 'Vendor Saved' );
				} else {
				$msg = JText::_( 'Error Saving Vendor' );
				}
				//end of image upload code
			   $model = $this->getModel('vendors');
			   $ind_arr = $_SESSION['industries']; //getting vendor's industries from session variable
				unset($_SESSION['industries']);		//unsetting session variablehmm
				
				//session_destroy();
				foreach($ind_arr as $arr)
				{
					$db = JFactory::getDBO();
					$checked    = JHTML::_( 'grid.id', $i, $row->id );
					$sql = "SELECT id FROM #__cam_industries where industry_name='".$arr."'";
					$db->Setquery($sql);
					$arr = $db->loadResult();
					$ind_data['industry_id'] = $arr; 
					$sql = "SELECT max(id) FROM #__cam_vendor_company";
					$db->Setquery($sql);
					$ven_id = $db->loadResult(); 
					$ind_data['vendor_id'] = $ven_id;
					$model->store_industries($ind_data);
				}
				//code to send mail to user
				$mailfrom = 'support@myvendorcenter.com';
				$fromname = 'MyVendorCenter.com';
				$assignuseremail = $post['email'];
				$mailsubject = 'Approved Registration';
				$siteURL		= JURI::base();
				$body = "Congratulations ".$data['name']."! <br/>
	Your CAMassistant.com Vendor application is
	now approved. Please <a href=".$siteURL."index.php?option=com_camassistant&controller=vendors&Itemid=66&task=mail_redirect_form&view=vendors'>CLICK HERE</a> to log into your
	account and complete the registration process.<br/><br/>
	At Your Service,<br/><br/>
	CAMassistant.com";
				JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body,$mode = 1);
				//JUtility::sendMail($from, $fromname, $recipient, $subject, $body, $mode, $cc, $bcc, $attachment, $replyto, $replytoname );
			}
			$app = &JFactory::getApplication();
			$link = 'index.php?option=com_camassistant&controller=vendors&view=vendors&task=thanks_redirect&Itemid=66';	
			$app->redirect($link);
		}// end if(isset($post['user_id']) && $post['user_id'] == '')
		
		
	}
	//function to display thankyou message after registration
	 function thanks_redirect()
	 {
		parent::display();
	 }

	// function for deleting the records from front end
	 function vendordelete()
	 {
		//echo '<pre>'; print_r($_REQUEST[vendorid]);  exit;
		$post = JRequest::get('request');
		$model = $this->getModel('vendorscenter');
		$items = $model->getvendor_center_delete();
		$msg="Assigned Vendor Status Removed";
		$url="index.php?option=com_camassistant&controller=vendorscenter&task=vendorscenter&view=vendorscenter&Itemid=".$post['Itemid'];
		$this->setRedirect($url,$msg);
		//$this->assignRef('items',		$items); 
	 }

	//function to update phone number column 
	function updatephone()
	{
		$post = JRequest::get('get');
		$model = $this->getModel('vendorscenter');
		$items = $model->updatephonenumber();
		$msg="Phone Filed is Updated";
		$url="index.php?option=com_camassistant&controller=vendorscenter&task=vendorscenter&view=vendorscenter&Itemid=".$post['Itemid'];
		$this->setRedirect($url,$msg);
	}
	
	function updateexten()
	{
		$post = JRequest::get('GET');
		$model = $this->getModel('vendorscenter');
		$items = $model->updateextension();
		$msg="Phone Filed is Updated";
		$url="index.php?option=com_camassistant&controller=vendorscenter&task=vendorscenter&view=vendorscenter&Itemid=".$post['Itemid'];
		$this->setRedirect($url,$msg);
	}
	
	function updatemailid()
	{
		$post = JRequest::get('get');
		$model = $this->getModel('vendorscenter');
		$items = $model->updatemailid();
		$msg="Phone Filed is Updated";
		$url="index.php?option=com_camassistant&controller=vendorscenter&task=vendorscenter&view=vendorscenter&Itemid=".$post['Itemid'];
		$this->setRedirect($url,$msg);
	}
	
	
	function vendorscenter_edit()
	{	
		$post = JRequest::get('request');
		JRequest::getVar('view','vendorscenter');
		parent::display();
		/*$model = $this->getModel('vendorscenter');
		$items = $model->vendor_edit();*/
		//echo '<pre>'; print_r($items); exit;
	}
	function vendorscenter_update()
	{
		$post = JRequest::get('request');
		$db = & JFactory::getDBO();
		echo $query = "UPDATE #__users SET name = '".$post[vendorname]."', username = '".$post[firstname]."',email = '".$post[email]."',salutation = '".$post[salutation]."',phone = '".$post[phone]."',extension = '".$post[extention]."' WHERE id ='".$post[userid]."'"; 
		$db->setQuery($query);
		if($db->query())
		{
			$msg= 'Sucess fully updated';
		}
		else 
		{
			$msg= 'Failed To Update';
		}
		$url="index.php?option=com_camassistant&controller=vendorscenter&task=vendorscenter&view=vendorscenter&Itemid=".$post['Itemid'];
		$this->setRedirect($url,$msg);

	}
	//function for sorting the vendors by type
	function specific()
	{
		$model = $this->getModel('vendorscenter');
		$items = $model->getinhouse();
		parent::display();

	}
	//Sorting the vendors list by the alphabet
	function alphabet()
	{

		$model = $this->getModel('vendorscenter');
		$items = $model->getinhouse();
		parent::display();

	}


	// Invite as inhouse vendors //
function inhousevendors()
	{

	$db =& JFactory::getDBO();
	$user	= JFactory::getUser();
	$model = $this->getModel('vendorscenter');
	$post = JRequest::get('get');
	$tax1 = JRequest::getVar( 'tax1','');
	$send = JRequest::getVar( 'send','');
	$tax2 = JRequest::getVar( 'tax2','');
	$tax = $tax1.'-'.$tax2;
	$userid = JRequest::getVar( 'camid','');
	$vendortype = JRequest::getVar( 'vendortype','' );
	$inviters = JRequest::getVar( 'inhouse','' );
	$inviters = str_replace(' ','',$inviters);
	$inhouse = explode(',',$inviters);

	$firmname = "SELECT comp_name FROM #__cam_camfirminfo where cust_id =".$user->id."";
	 $db->setQuery($firmname);
	 $firm_name=$db->loadResult();
	
	//for loop for multiple vendors invitations...
	for($i=0; $i<count($inhouse); $i++){
	$to = $inhouse[$i];
	
	$from_email = $user->email;
	$from_name = $user->name.'&nbsp;'.$user->lastname;
	$from_name = str_replace('&nbsp;',' ',$from_name);

	if($vendortype =='preferred'){
	$subject = 'Preferred Vendor Invitation from '.$firm_name.''; 
	$text = 'Preferred invitation from camfirm'; }
	if($vendortype =='inhouse'){
	$subject = 'In-House Vendor Invitation from '.$firm_name.'';  $text = 'In house invitation from camfirm'; }
	$fei=$model->getfei($to,$userid);
	$post['userid'] = $userid;
	
	$to_id = "SELECT id FROM #__users where email ='".$to."'";
	$db->setQuery($to_id);
	$v_id=$db->loadResult();
	if($v_id){
	$post['v_id'] = $v_id;
	$post['status'] = '1';
	}
	else {
	$post['v_id']=0;
	$post['status'] = '1';
	}
	$post['vendortype'] = $vendortype;
	
	$post['fei'] = $fei;
	$post['inhousevendors'] = $to;
	$post['inhouse'] = $to;
	$post['subject'] = $subject;
	$post['inhousetext'] = $text;
	//$post['status'] = 0;
	$body = $model->getbody($fei,$vendortype,$to,$userid,$subject); 
	//echo '<pre>'; print_r($post); exit;//echo $body; exit;
	$model = $this->getModel('vendorscenter');
	$check = $model->getcheck($to,$userid);
	$successMail =JUtility::sendMail($from_email, $from_name, $to, $subject, $body,$mode = 1);

	$body = $body.'<br><br><font color="red">The invitation sent to this email id</font>&nbsp;&nbsp;'.$to;
	$support_to = 'invitations@myvendorcenter.com';
	//$support_to = 'rize.cama@gmail.com';
	$successMail =JUtility::sendMail($from_email, $from_name, $support_to, $subject, $body,$mode = 1);
	if(!$check){
	$save = $model->store($post); 
		}
	 }//////for loop competed 
	 ?>
	<script type="text/javascript">
//	window.parent.document.getElementById( 'sbox-window' ).close();
	alert("Vendor invited successfully.");
	window.location.href = 'index.php?option=com_camassistant&controller=vendorscenter&task=vendorscenter&view=vendorscenter&Itemid=120';
	</script>
	<?php 
	
	}
	
//Function to check the vendor company name
	function checkcompany()
	{
	$db =& JFactory::getDBO();
	$user =& JFactory::getUser();	
	$companyname = JRequest::getVar( 'cname','');
	
	$list_companies  = "SELECT u.company_name, u.company_address, u.company_phone, u.phone_ext, v.name, v.lastname, v.email, v.id, u.city, u.state, u.status, v.block, v.subscribe, v.subscribe_type, v.subscribe_sort FROM  #__cam_vendor_company as u, #__users as v where u.user_id=v.id and (LOWER(company_name) LIKE '%".$companyname."%' ) and v.search='' and v.block=0  " ;
		
		$sort = JRequest::getVar('sort','');
		if( $sort == '' ){
			$sorting = " order by v.subscribe_type='', v.subscribe_type='free', v.subscribe_type='public', v.subscribe_type='all'  ";
		}
		else if( $sort == 'asc' ){
			$sorting = ' order by u.company_name ASC ';
		}
		else{
			$sorting = ' order by u.company_name DESC ';
		}
		
	$list_companies = $list_companies . ' '.$sorting.'  ' ;
	//echo $list_companies;
	$db->setQuery($list_companies);
	$totalcompanies = $db->loadObjectList();  
	
	$model = $this->getModel('vendorscenter');
	// To get all corporate vendors
	$corporate_vendors = $model->corporatevendors_star();

		$star_vendors = $corporate_vendors ;
		if($star_vendors){
			foreach($star_vendors as $star){
				$stars[] = $star->v_id;
			}
		}
	
	//Completed
			for( $p=0; $p<count($totalcompanies); $p++ ){
			$c_status =	$model->checkcompliancestatus($totalcompanies[$p]->id);
			$totalcompanies[$p]->cstatus = $c_status ;
			}
		
		for( $s=0; $s<count($totalcompanies); $s++ ){
		$only_state = $totalcompanies[$s]->cstatus ;
					if($only_state){
						foreach($only_state as $statues){
							$final_state[] = $statues->status;
							$med_fina_state = '';
							$med_fina_state = array_unique($final_state);
								if( count($med_fina_state) == 2 ) {
									$totalcompanies[$s]->final_status = 'medium' ;
								}
								if( count($med_fina_state) == 1 &&  $med_fina_state[0] == 'fail') {
									$totalcompanies[$s]->final_status = 'fail' ;
								}
								if( count($med_fina_state) == 1 &&  $med_fina_state[0] == 'success' ){
									$totalcompanies[$s]->final_status = 'success' ;
									
									$masteraccount = $model->getmasterfirmaccount($user->id);
									$sql_terms = "SELECT termsconditions FROM #__cam_vendor_aboutus WHERE vendorid=".$masteraccount." "; 
									$db->setQuery($sql_terms);
									$terms_exist = $db->loadResult();
									if($terms_exist == '1'){
									$sql = "SELECT accepted FROM #__cam_vendor_terms WHERE vendorid=".$totalcompanies[$s]->id." and masterid=".$masteraccount." "; 
									$db->setQuery($sql);
									$terms = $db->loadResult();
										if($terms == '1'){
										$totalcompanies[$s]->final_status = 'success' ;
										}
										else{
										$totalcompanies[$s]->final_status = 'fail' ;
										}
									}
									
								}
						} 
						$final_state = '';
						$med_fina_state = '';
					}
		// Adding block unverified vendor rule
		$user =& JFactory::getUser();
		$masterid = $model->getmasterfirmaccount($user->id);
		$block_per = "SELECT block, block_complinace FROM #__cam_master_block_users where masterid ='".$masterid."' ";
		$db->setQuery($block_per);
		$blockid = $db->loadObject();
		if( $blockid->block == '1' )
			$totalcompanies[$s]->unverified = 'hide' ;
		else	
			$totalcompanies[$s]->unverified = 'show' ;
		
		if( $blockid->block_complinace == '1' )
			$totalcompanies[$s]->block_nonc = 'hide' ;
		else	
			$totalcompanies[$s]->block_nonc = 'show' ;
				
		//Completed
		$masterid = $model->getmasterfirmaccount($user->id);
		$act_type = "SELECT acount_type FROM #__cam_master_compliancereport where masterid ='".$masterid."' ";
		$db->setQuery($act_type);
		$act_type = $db->loadResult();
		$subscribe_type = "SELECT subscribe_type FROM #__users where id ='".$totalcompanies[$s]->id."'";
		$db->setQuery($subscribe_type);
		$subscribe_type = $db->loadResult();
		if( $act_type == '1' && ( $subscribe_type == 'free' || $subscribe_type == '' ) )
			$totalcompanies[$s]->acount_type = 'show' ;
		else	
			$totalcompanies[$s]->acount_type = 'hide' ;
		
		
		
		}
		
	
	
	?>
	
	<?php 
	$sort = JRequest::getVar('sort','');
	if( $sort == '' ) {
	$anvhor_tag = '<a id="compliant_nosort" class="sortelement" data="asc" href="javascript:void(0);">COMPANY</a>';
	}
	else if( $sort == 'asc' ){
	$anvhor_tag = '<a id="compliant_desc" class="sortelement" data="desc" href="javascript:void(0);">COMPANY</a>';
	}
	else{
	$anvhor_tag = '<a id="compliant_asc" class="sortelement" data="asc" href="javascript:void(0);">COMPANY</a>';
	}
	?>
	
	
	
	
	<div id="heading_vendors_search">
<div class="checkbox_vendor_search"><input type="checkbox" value="" name="selectall" id="selectall_preferredvendors" />ADD</div> 
<div class="company_vendor_search"><?php echo $anvhor_tag; ?></div>
<div class="apple_vendor_search">APPLE RATING</div>
<div class="compliant_vendor_search">COMPLIANCE STATUS</div>
</div>
<div class="totalvendorspre">
	<?php
	
	if($totalcompanies){
	for($t=0; $t<count($totalcompanies); $t++){
	
	if($totalcompanies[$t]->subscribe == 'yes' && $totalcompanies[$t]->subscribe_type == 'all')
	$background = '#EBF5DA';
	else
	$background = '';
	

	
	
?>

<?php
//echo "<pre>"; print_r($totalcompanies); echo "</pre>";
	$args = '';
	$checkbox = '';
	if( $totalcompanies[$t]->unverified == 'hide' && $totalcompanies[$t]->block_nonc == 'hide' )
		{
			if( $totalcompanies[$t]->subscribe_type == 'free' && ( $totalcompanies[$t]->final_status == 'fail' || $totalcompanies[$t]->final_status == 'medium') ){
			$args = 'both';
			}
			else if( $totalcompanies[$t]->subscribe_type == 'free' && $totalcompanies[$t]->final_status == 'success' ){
			$args = 'un';
			}
			else if( $totalcompanies[$t]->subscribe_type != 'free' && ( $totalcompanies[$t]->final_status == 'fail' || $totalcompanies[$t]->final_status == 'medium') ){
			$args = 'nonc';
			}
			
			else{
			$checkbox = 'show';
			}
			
		}
	else if( $totalcompanies[$t]->unverified == 'hide' )
		{
			if( $totalcompanies[$t]->subscribe_type == 'free' ){
			$args = 'un';
			}
			else{
			$checkbox = 'show';
			}
		}
	else if( $totalcompanies[$t]->block_nonc == 'hide' )
		{
			if( $totalcompanies[$t]->final_status == 'fail' || $totalcompanies[$t]->final_status == 'medium' ){
			$args = 'nonc';
			}	
			else {
			$checkbox = 'show';	
			}
		}	
	else {
		$args = '';
		$checkbox = 'show';	
	}	
?>	

	<div id="preferredvendorsinvitations" style="background:<?php echo $background; ?>">
	<?php if( $totalcompanies[$t]->subscribe == 'yes'){ ?>
	<div class="search-panel-middlepre checkbox_vendor_search">
	<?php } else { ?>
	<div class="search-panel-middlepre checkbox_vendor_search" style="margin-top:15px;">
	<?php } ?>
	<?php 
	if( $totalcompanies[$t]->status == 'rejected' ) 
		{ 
		echo "<strong><font color='red'>REJECTED</font></strong>";
		}
		  
	 elseif( $totalcompanies[$t]->block == '1' ){
	 	echo "<strong><p style='color:red;'>REJECTED</p></strong>";
	 }
	 else {  
	 	$user =& JFactory::getUser();
		$model = $this->getModel('vendorscenter');
		$masterid = $model->getmasterfirmaccount($user->id);
	 	$vendor_id = "SELECT exclude, search FROM #__vendor_inviteinfo where v_id ='".$totalcompanies[$t]->id."' and userid=".$masterid." ";
		$db->setQuery($vendor_id);
		$v_id_exist = $db->loadObject();
	 	if($v_id_exist->exclude == 'yes' || $v_id_exist->search == 'yes'){
		 ?>
		 <a href="javascript:senderrormsg();"><img src="templates/camassistant_left/images/Block2.png" /></a>
		<?php } 
		else if( $checkbox != 'show' ) {?>
		<a href="javascript:void(0);" onclick="unverified(<?php echo $totalcompanies[$t]->id; ?>,'<?php echo $args; ?>');"><img src="templates/camassistant_left/images/Block2.png" /></a>
		<?php }
		else { ?>
		<input type="checkbox" class="coworkers" name="coworkers" value="<?php echo $totalcompanies[$t]->id; ?>-<?php echo $totalcompanies[$t]->id; ?>">
		<?php } 
		 } ?>
	<br />
	<span id="companyid<?php echo $totalcompanies[$t]->id; ?>" style="color:green; font-weight:bold; display:block; padding-top:6px; margin-right:2px;"></span>
    </div>
	
	
	<div class="search-panel-left_rfp company_vendor_search">
	<ul>
	<li><strong>
	<?php 
	if($stars){
		if (in_array($totalcompanies[$t]->id, $stars)){ ?>
		<img src="templates/camassistant_left/images/star-icon.png" title="Corporate Preferred Vendor" />
		<?php }
		else{
		}
	}	
		?>
		
	<?php /*if( $totalcompanies[$t]->status == 'rejected' ||  $totalcompanies[$t]->block == '1' ||  $totalcompanies[$t]->subscribe == '' || $totalcompanies[$t]->subscribe == 'no' )  { 
	echo "<a href='javascript:unsubscribevendor();'>".stripslashes($totalcompanies[$t]->company_name)."</a>"; 
	 } else {*/ ?>
	<a href="index.php?option=com_camassistant&controller=vendors&task=vendordetailslayout&id=<?php echo $totalcompanies[$t]->id; ?>" target="_blank"><?php echo stripslashes($totalcompanies[$t]->company_name); ?></a>
	<?php //} ?>
	</strong></li>
            <?php //if( $totalcompanies[$t]->subscribe == 'yes'){ ?>
	<li><?php echo $totalcompanies[$t]->name.' '.$totalcompanies[$t]->lastname; ?> <?php echo $totalcompanies[$t]->company_phone; ?> <?php if($totalcompanies[$t]->phone_ext){ echo "&nbsp;Ext.&nbsp;".$totalcompanies[$t]->phone_ext; } else{ echo ""; } ?></li>
	<?php
	$statecode  = "SELECT code from #__cam_vendor_states where id=".$totalcompanies[$t]->state." " ; 
	$db->setQuery($statecode);
	$statea = $db->loadResult(); 
	?>
	<li><?php echo $totalcompanies[$t]->city; ?>,&nbsp;<?php echo strtoupper($statea); ?></li>
	<li><a style="font-weight:normal; color:gray;" class="miniemails" href="mailto:<?php echo $totalcompanies[$t]->email; ?>">Email</a></li><?php 
	 /*?>} else { ?>
	<li>This Vendor's contact information is unavailable due to an expired account. <strong><a href="javascript:sendupdateemail('<?php  echo $totalcompanies[$t]->email; ?>','<?php echo $totalcompanies[$t]->company_name; ?>','<?php echo $totalcompanies[$t]->id; ?>')" class='notsubscribedvebndors'>CLICK HERE</a></strong> to request an update.<?php */?>


</li>
	<?php //} ?>
	</ul>
	</div>
	<div class="search-panel-right_rfp apple_vendor_search">
	<?php
	$ratecount = "SELECT V.apple FROM `#__cam_vendor_proposals` as U, `#__cam_rfpinfo` as V where U.proposedvendorid=".$totalcompanies[$t]->id." and V.apple!=0 and V.apple_publish=0 and U.proposaltype='Awarded' and U.rfpno = V.id ";
	$db->setQuery($ratecount);
	$count_vs=$db->loadObjectList();
	
	$camratingf = "SELECT camrating FROM `#__users` where id=".$totalcompanies[$t]->id."  ";
		$db->setQuery($camratingf);
		$cam_ratingf = $db->loadResult();
		
	if($count_vs){
		for($c=0; $c<count($count_vs); $c++){
		$total = $total + $count_vs[$c]->apple ;
		}
		$camrating = "SELECT camrating FROM `#__users` where id=".$totalcompanies[$t]->id."  ";
		$db->setQuery($camrating);
		$cam_rating = $db->loadResult();
		
		if($cam_rating) {
		$total = $total + $cam_rating ;
		$count = count($count_vs) + 1;
		$avgrating = $total  / $count;	
		$rating =  round($avgrating, 1); 
		}
		else {
		$avgrating = $total  / count($count_vs);	
		$rating =  round($avgrating, 1); 
		}
	}
	else if($cam_ratingf){
	$rating = round($cam_ratingf, 1); 
	}
	else{
	$rating = 4 ;
	} 

	if ($rating > 0 && $rating <= 0.50)
			{ $rate_image = $rateimage.'5.png';  $rating='0.5'; }
			elseif ($rating > 0.50 && $rating <= 1.00)
			{ $rate_image = $rateimage.'10.png'; $rating='1'; }
			elseif ($rating > 1.00 && $rating <= 1.50)
			{ $rate_image = $rateimage.'15.png'; $rating='1.5';}
			elseif ($rating > 1.50 && $rating <= 2.00)
			{ $rate_image = $rateimage.'20.png'; $rating='2';}
			elseif ($rating > 2.00 && $rating <= 2.50)
			{ $rate_image = $rateimage.'25.png'; $rating='2.5';}
			elseif ($rating > 2.50 && $rating <= 3.00)
			{ $rate_image = $rateimage.'30.png'; $rating='3';}
			elseif ($rating > 3.00 && $rating <= 3.50)
			{ $rate_image = $rateimage.'35.png'; $rating='3.5';}
			elseif ($rating > 3.50 && $rating <= 4.00)
			{ $rate_image = $rateimage.'40.png'; $rating='4';}
			elseif ($rating > 4.00 && $rating <= 4.50)
			{ $rate_image = $rateimage.'45.png'; $rating='4.5';}
			elseif ($rating > 4.50 && $rating <= 5.00)
			{ $rate_image = $rateimage.'50.png'; $rating='5';}
			else
			{ $rate_image = $rateimage.'40.png'; $rating='4';}
			$total = 0;
			
	 ?>
	 		
			<img width="130" src="templates/camassistant_left/images/vendorrating/<?php echo $rate_image; ?>" />
			
	</div>
	<?php
				// Get permission
				$permission = $model->getpermission($masterid);
				$set_globals = $model->getmasterglobals($masterid);
				if($permission == 'yes' || $set_globals == 'fail'){
					$text = "N/A";
					$id = 'nostandards';
				}
				else{
					if($totalcompanies[$t]->final_status == 'fail' ||  $totalcompanies[$t]->acount_type == 'show' ) {
					//$text = "NON-COMPLIANT";
					$id = 'noncompliant';
					$title = 'Non-Compliant';
					}
					else if($totalcompanies[$t]->final_status == 'success'){
					//$text = "COMPLIANT";
					$id = 'compliant';
					$title = 'Compliant';
					}
					else if($totalcompanies[$t]->final_status == 'medium'){
					//$text = "COMPLIANT & NON-COMPLIANT";
					$id = 'mediumcompliant';
					$title = 'Compliant & Non-Compliant';
					}
				}	
			?>
			
	<div class="search-panel-image_rfp compliant_vendor_search" style="width:117px;">
	  	  <p align="center" style="color:; display:block; margin-bottom:7px; font-weight:bold;">
		 <?php  if($globe != 'fail'){ ?>
			<a onclick="javascript:getcompstatus(<?php echo $totalcompanies[$t]->id; ?>,'<?php echo $set_globals; ?>','<?php echo $title; ?>');" href="javascript:void(0);" id="<?php echo $id; ?>" title="<?php echo $title; ?>"><?php echo $text; ?></a>
			<?php } else {
			echo "N/A";
			}?>			
			 </p>

<?php
if( $totalcompanies[$t]->subscribe_type == 'free' || $totalcompanies[$t]->subscribe_type == '') { ?>
<div class="unverifiedvendor"><a href="javascript:void(0);" onclick="unverified(<?php echo $totalcompanies[$t]->id; ?>,'unverified');" title="Click for more info">UNVERIFIED</a></div>
<?php } else {  ?>
<div class="verifiedvendor"><a href="javascript:void(0);" onclick="unverified(<?php echo $totalcompanies[$t]->id; ?>,'verified');" title="Click for more info">VERIFIED</a></div>
<?php } ?>
			 
	  </div>
	  
	  <div class="clear"></div>
	  
	</div>
<?php } 
} 
else{ 
	$user =& JFactory::getUser(); 
	if($user->user_type == '13'){
	$item = '216';
	}
	else {
	$item = '217';
	}


?>
<p style='font-weight:bold; padding-top:20px;'>Your search has produced no matches.  <a href="index.php?option=com_camassistant&controller=vinvitations&Itemid=<?php echo $item; ?>" class="invitevendor" style="color:#6DAA00">CLICK HERE</a> to invite this Vendor</p>
<br /><br />
<?php }
?>
</div>
<?php 
if($user->user_type == '13' && $user->accounttype  == 'master' )
$pre_vendor = '';
else
$pre_vendor = 'none';
	
	
$listbasicjobs = $model->getallbasicjobs();
if( count($listbasicjobs) > '0' )
	$basics = 'yes';
	else
	$basics = 'no';
	
if($totalcompanies){ ?>
	<div align="center" style="margin-top:17px; display:<?php echo $disp;?>" >
	
	<a title="Add to My Vendors" class="addicon" href="javascript:sendinvitationcorporate('add');"></a>
	<a href="javascript:vendor_mails();" class="vendor_mails" title="Email Vendor(s)"></a>
	<a title="Create a new Basic Request" class="basicrequest" href="javascript:basicrequest('pre');"></a>
	<a title="Invite Vendor(s) to existing Basic Request" class="basicrequest_invite" href="javascript:inviteto_basicrequest('pre','<?php echo $basics; ?>');"></a>
	<a style = "display:<?php echo $pre_vendor; ?>" title="Add to Corporate Preferred Vendors" class="addpreferredvendoricon" href="javascript:sendpreferredvendor_invitation();"></a>
	<a title="Recommend to Co-Workers" class="vendor_recommend" href="javascript:vendor_recommend();"></a>
	<?php 
	$user =& JFactory::getUser();
	if($user->accounttype  == 'master'){ ?>
	<a title="Block this Vendor from participating in your Managers' projects" class="exclude" href="javascript:sendinvitationcorporate('exclude');"></a>
	<?php } ?>
	
	</div>
<?php 	} ?>

	<?php 
	exit;
	}
	
	//Function to add vendor under the manager
	function addvendor(){
	$model = $this->getModel('vendorscenter');	
	$db =& JFactory::getDBO();
	$vendorid = JRequest::getVar( 'vendorid','');
	$action_type = JRequest::getVar( 'actype','');
	$user	= JFactory::getUser();
	$vendors = explode(',',$vendorid);
	
	for( $i=0; $i<count($vendors); $i++ ){
	// To check if is there any pre invitations to same user
	$checkvendor = "SELECT vid FROM #__vendor_inviteinfo where userid =".$user->id." and v_id=".$vendors[$i]." ";
	$db->setQuery($checkvendor);
	$exist = $db->loadResult();

	if($exist){
		$query1 = "UPDATE #__vendor_inviteinfo SET myvendors = 'yes' WHERE vid ='".$exist."'"; 
		$db->setQuery($query1);
		$db->query();
		
		if($action_type == 'exclude'){
			$query = "UPDATE #__vendor_inviteinfo SET search = 'yes' WHERE vid ='".$exist."'"; 
			$db->setQuery($query);
			$db->query();
		}
	echo "already";
	
	}	
	
	else {
		// To get the company id
		$taxid = $model->getcompanyid($user->id,$user->user_type);
		//Completed
		//$email = JRequest::getVar( 'emailid',''); 
		$checkvendor_email = "SELECT email FROM #__users where id =".$vendors[$i]." ";
		$db->setQuery($checkvendor_email);
		$email = $db->loadResult();
	
		$from_email = $user->email;
		$post['userid'] = $user->id ;
		$post['v_id'] = $vendors[$i];
		$post['taxid'] = $taxid;
		$post['licenseno'] = '';
		$post['vendortype'] = 'preferred';
		$post['fei'] = '';
		$post['inhousevendors'] = $email;
		$post['inhouse'] = $email;
		$post['subject'] = "Preferred invitation from camfirm";
		$post['inhousetext'] = "Preferred invitation from camfirm";
		$post['status'] = 1;
		$post['invitedate'] = date('Y-m-d h:i:m');;
		if($action_type == 'exclude') {
		$post['search'] = 'yes';
		$post['exclude'] = 'yes';
		}
		else {
		$post['search'] = '';
		$post['exclude'] = '';
		}
		$save = $model->store_add($post);
			
		if($save){
		echo "added" ;
		}
		else{
		echo "fail";
		}
		
		}
		}
		exit;
	}
	
	//function to remove vendor
	function removevendor(){
	$user	= JFactory::getUser();
	$db =& JFactory::getDBO();
	$vendorid = JRequest::getVar( 'vendorid','');
	$query_delete = "DELETE FROM #__vendor_inviteinfo WHERE vid IN (".$vendorid.") and userid=".$user->id." " ;
	$db->setquery($query_delete);
	$del = $db->query();
	if($del) {
	echo "1";
	}
	else{
	echo "0";
	}		
	exit;
	}
	
	//function to exclude vendor
	function excludevendor(){
	$user	= JFactory::getUser();
	$db =& JFactory::getDBO();
	$vendorid = JRequest::getVar( 'vendorid','');
	$query_exclude = "UPDATE #__vendor_inviteinfo SET exclude = 'yes' WHERE vid IN (".$vendorid.") and userid=".$user->id." "; 
	$db->setquery($query_exclude);
	if($db->query()) {
	echo "1";
	}
	else{
	echo "0";
	}		
	exit;
	}
	
	//function to exclude vendor
	function excludecovendor(){
	$user	= JFactory::getUser();
	$db =& JFactory::getDBO();
	$vendorid = JRequest::getVar( 'vendorid','');
	$query_exclude = "UPDATE #__vendor_inviteinfo SET exclude = 'yes', userid=".$user->id." WHERE vid IN (".$vendorid.") "; 
	$db->setquery($query_exclude);
	if($db->query()) {
	echo "removed";
	}
	else{
	echo "notremoved";
	}		
	exit;
	}
	
	//function to include vendor
	function includevendor(){
	$db =& JFactory::getDBO();
	$vendorid = JRequest::getVar( 'vendorid','');
	$query_exclude = "DELETE FROM #__vendor_inviteinfo WHERE vid IN ( ".$vendorid." ) "; 
	$db->setquery($query_exclude);
	if($db->query()) {
	echo "removed";
	}
	else{
	echo "notremoved";
	}		
	exit;
	}
	
	//Function to new search
	function checknewsearch()
	{
	$db =& JFactory::getDBO();
	$user	= JFactory::getUser();
	$state = JRequest::getVar( 'state','');
	$county = JRequest::getVar( 'county','');
	$industrytype = JRequest::getVar( 'ind','');
	
	$query  = "SELECT u.company_name, u.company_address, u.company_phone, u.phone_ext, v.name, v.lastname, v.email, v.id, u.city, u.state, u.status, v.block, v.subscribe, v.subscribe_type, v.subscribe_sort FROM  #__cam_vendor_company as u, #__users as v where u.user_id=v.id and v.block=0 and v.search='' " ; 
	
	$sort = JRequest::getVar('sort','');
		if( $sort == '' ){
			$sorting = " order by v.subscribe_type='', v.subscribe_type='free', v.subscribe_type='public', v.subscribe_type='all'  ";
		}
		else if( $sort == 'asc' ){
			$sorting = ' order by u.company_name ASC ';
		}
		else{
			$sorting = ' order by u.company_name DESC ';
		}
		
	$db->setQuery($query);
	$totalprefers = $db->loadObjectList();  
	//echo "<pre>"; print_r($totalprefers); echo "</pre>";
	if($industrytype){
			$checkvendors = "SELECT distinct(user_id) FROM #__cam_vendor_industries where industry_id=".$industrytype." ";
			$db->setQuery($checkvendors);
			$accpetvendor = $db->loadObjectList();
			
			if($totalprefers){
				foreach($totalprefers as $vid){
				$existing[] = $vid->id;
				}
			}	
			if($accpetvendor){
				foreach($accpetvendor as $inids){
				$indusids[] = $inids->user_id;
				}
			}
			if($indusids != '' && $existing!= ''){
			$common = array_intersect($indusids, $existing) ;
			}
			if($common){
			$indus_condition = implode(',',$common) ;
			}
			if($indus_condition)
			$query = $query . "AND v.id IN ("  . $indus_condition . ")" ;
			else
			$query = $query . "AND v.id IN ('')" ;
			}	
			
			// Search with County
			if($county){
			$checkvendors1 = "SELECT distinct(user_id) FROM #__vendor_state_counties where county_id=".$county." ";
			$db->setQuery($checkvendors1);
			$accpetvendor1 = $db->loadObjectList();
			
			if($totalprefers){
				foreach($totalprefers as $vid){
				$existing[] = $vid->v_id;
				}
			}	
			if($accpetvendor1){
				foreach($accpetvendor1 as $county){
				$countys[] = $county->user_id;
				}
			}
			
			
			if($countys && $existing){
			$common = array_intersect($countys, $existing) ;
			
				if($common){
				$county_condition = implode(',',$common) ;
				}
					if($county_condition)	{
					$query = $query . " AND v.id IN ("  . $county_condition . ")" ;
					}
					else {
					$query = $query . " AND v.id IN ('')" ;
					}
			}	
				else {
				$query = $query . " AND v.id IN ('')" ;
				}
			}
			
			//Completed
			
			$query = $query . ' '.$sorting.'  ' ;
			$db->setQuery($query);
			$totalcompanies = $db->loadObjectList();
			
			$model = $this->getModel('vendorscenter');
			for( $p=0; $p<count($totalcompanies); $p++ ){
			$c_status =	$model->checkcompliancestatus($totalcompanies[$p]->id);
			$totalcompanies[$p]->cstatus = $c_status ;
			}
		
		for( $s=0; $s<count($totalcompanies); $s++ ){
		$only_state = $totalcompanies[$s]->cstatus ;
					if($only_state){
						foreach($only_state as $statues){
							$final_state[] = $statues->status;
							$med_fina_state = '';
							$med_fina_state = array_unique($final_state);
							
								if( count($med_fina_state) == 2 ) {
									$totalcompanies[$s]->final_status = 'medium' ;
								}
								if( count($med_fina_state) == 1 &&  $med_fina_state[0] == 'fail') {
									$totalcompanies[$s]->final_status = 'fail' ;
								}
								if( count($med_fina_state) == 1 &&  $med_fina_state[0] == 'success' ){
									$totalcompanies[$s]->final_status = 'success' ;
									
										$masteraccount = $model->getmasterfirmaccount($user->id);
										$sql_terms = "SELECT termsconditions FROM #__cam_vendor_aboutus WHERE vendorid=".$masteraccount." "; 
										$db->setQuery($sql_terms);
										$terms_exist = $db->loadResult();
										if($terms_exist == '1'){
										$sql = "SELECT accepted FROM #__cam_vendor_terms WHERE vendorid=".$totalcompanies[$s]->id." and masterid=".$masteraccount." "; 
										$db->setQuery($sql);
										$terms = $db->loadResult();
											if($terms == '1'){
											$totalcompanies[$s]->final_status = 'success' ;
											}
											else{
											$totalcompanies[$s]->final_status = 'fail' ;
											}
										}
									
								}
						} 
						$final_state = '';
						$med_fina_state = '';
					}
// Adding block unverified vendor rule
	$user =& JFactory::getUser();
	$masterid = $model->getmasterfirmaccount($user->id);
	$block_per = "SELECT block, block_complinace FROM #__cam_master_block_users where masterid ='".$masterid."' ";
	$db->setQuery($block_per);
	$blockid = $db->loadObject();
	if( $blockid->block == '1' )
		$totalcompanies[$s]->unverified = 'hide' ;
	else	
		$totalcompanies[$s]->unverified = 'show' ;
		
	if( $blockid->block_complinace == '1' )
		$totalcompanies[$s]->block_nonc = 'hide' ;
	else	
		$totalcompanies[$s]->block_nonc = 'show' ;	
//Completed	
			
	$masterid = $model->getmasterfirmaccount($user->id);
		$act_type = "SELECT acount_type FROM #__cam_master_compliancereport where masterid ='".$masterid."' ";
		$db->setQuery($act_type);
		$act_type = $db->loadResult();
		$subscribe_type = "SELECT subscribe_type FROM #__users where id ='".$totalcompanies[$s]->id."'";
		$db->setQuery($subscribe_type);
		$subscribe_type = $db->loadResult();
		if( $act_type == '1' && ( $subscribe_type == 'free' || $subscribe_type == '' ) )
			$totalcompanies[$s]->acount_type = 'show' ;
		else	
			$totalcompanies[$s]->acount_type = 'hide' ;	
		
		
		}
		
		
			?>
<?php 
// To get all corporate vendors
		$model = $this->getModel('vendorscenter');
		$corporate_vendors = $model->corporatevendors_star();
		
		$star_vendors = $corporate_vendors ;
		if($star_vendors){
			foreach($star_vendors as $star){
				$stars[] = $star->v_id;
			}
		}
	
	//Completed
?>			
	<?php 
	$sort = JRequest::getVar('sort','');
	if( $sort == '' ) {
	$anvhor_tag = '<a id="compliant_nosort" class="sortelementnewsearch" data="asc" href="javascript:void(0);">COMPANY</a>';
	}
	else if( $sort == 'asc' ){
	$anvhor_tag = '<a id="compliant_desc" class="sortelementnewsearch" data="desc" href="javascript:void(0);">COMPANY</a>';
	}
	else{
	$anvhor_tag = '<a id="compliant_asc" class="sortelementnewsearch" data="asc" href="javascript:void(0);">COMPANY</a>';
	}
	?>
	
<div id="heading_vendors_search">
<div class="checkbox_vendor_search"><input type="checkbox" value="" name="selectall" id="selectall_preferredvendors" />ADD</div> 
<div class="company_vendor_search"><?php echo $anvhor_tag; ?></div>
<div class="apple_vendor_search">APPLE RATING</div>
<div class="compliant_vendor_search">COMPLIANCE STATUS</div>
</div>
<div class="totalvendorspre">
			<?php
			if($totalcompanies){
			
	for($t=0; $t<count($totalcompanies); $t++){
	
	if($totalcompanies[$t]->subscribe == 'yes' && $totalcompanies[$t]->subscribe_type == 'all')
	$background = '#EBF5DA';
	else
	$background = '';
	
	
	
?>

<?php
//echo "<pre>"; print_r($totalcompanies); echo "</pre>";
	$args = '';
	$checkbox = '';
	if( $totalcompanies[$t]->unverified == 'hide' && $totalcompanies[$t]->block_nonc == 'hide' )
		{
			if( $totalcompanies[$t]->subscribe_type == 'free' && ( $totalcompanies[$t]->final_status == 'fail' || $totalcompanies[$t]->final_status == 'medium') ){
			$args = 'both';
			}
			else if( $totalcompanies[$t]->subscribe_type == 'free' && $totalcompanies[$t]->final_status == 'success' ){
			$args = 'un';
			}
			else if( $totalcompanies[$t]->subscribe_type != 'free' && ( $totalcompanies[$t]->final_status == 'fail' || $totalcompanies[$t]->final_status == 'medium') ){
			$args = 'nonc';
			}
			
			else{
			$checkbox = 'show';
			}
			
		}
	else if( $totalcompanies[$t]->unverified == 'hide' )
		{
			if( $totalcompanies[$t]->subscribe_type == 'free' ){
			$args = 'un';
			}
			else{
			$checkbox = 'show';
			}
		}
	else if( $totalcompanies[$t]->block_nonc == 'hide' )
		{
			if( $totalcompanies[$t]->final_status == 'fail' || $totalcompanies[$t]->final_status == 'medium' ){
			$args = 'nonc';
			}	
			else {
			$checkbox = 'show';	
			}
		}	
	else {
		$args = '';
		$checkbox = 'show';	
	}	
?>


	<div id="preferredvendorsinvitations" class="search-panel<?php echo $totalcompanies[$t]->id; ?>" style="background:<?php echo $background; ?>">
	<div class="search-panel-middlepre checkbox_vendor_search">
	<?php 
	if( $totalcompanies[$t]->status == 'rejected' ) 
		{ 
		echo "<strong><font color='red'>REJECTED</font></strong>";
		}  
	 elseif( $totalcompanies[$t]->block == '1' ){
	 	echo "<strong><p style='color:red;'>REJECTED</p></strong>";
	 }
	 else {  
	 $user =& JFactory::getUser();
	 	$model = $this->getModel('vendorscenter');
		$masterid = $model->getmasterfirmaccount($user->id);
	 	$vendor_id = "SELECT exclude, search FROM #__vendor_inviteinfo where v_id ='".$totalcompanies[$t]->id."' and userid=".$masterid." ";
		$db->setQuery($vendor_id);
		$v_id_exist = $db->loadObject();
	 	if($v_id_exist->exclude == 'yes' || $v_id_exist->search == 'yes'){
			
		 ?>
		 <a href="javascript:senderrormsg();"><img src="templates/camassistant_left/images/Block2.png" /></a>
		<?php } 
		else if( $checkbox != 'show' ) {?>
			<a href="javascript:void(0);" onclick="unverified(<?php echo $totalcompanies[$t]->id; ?>,'<?php echo $args; ?>');"><img src="templates/camassistant_left/images/Block2.png" /></a>
		<?php }
		else { ?>
	 <input type="checkbox" class="coworkers" name="coworkers" value="<?php echo $totalcompanies[$t]->id; ?>-<?php echo $totalcompanies[$t]->id; ?>">
	 <?php } ?>
	<?php } ?>
	<br />
	<span id="companyid<?php echo $totalcompanies[$t]->id; ?>" style="color:green; font-weight:bold; display:block; padding-top:6px; margin-right:2px;"></span>
    </div>
	<div class="search-panel-left_rfp company_vendor_search">
	<ul>
	<li><strong>
		<?php 
		if($stars) {
		if (in_array($totalcompanies[$t]->id, $stars)){ ?>
		<img src="templates/camassistant_left/images/star-icon.png" title="Corporate Preferred Vendor" />
		<?php }
		else{
		}
		}
		?>
		
		
	<?php /*if( $totalcompanies[$t]->status == 'rejected' ||  $totalcompanies[$t]->block == '1' || $totalcompanies[$t]->subscribe == '' || $totalcompanies[$t]->subscribe == 'no' )  { 
	echo "<a href='javascript:unsubscribevendor();'>".stripslashes($totalcompanies[$t]->company_name)."</a>"; 
	 } else { */?>
	<a href="index.php?option=com_camassistant&controller=vendors&task=vendordetailslayout&id=<?php echo $totalcompanies[$t]->id; ?>" target="_blank"><?php echo stripslashes($totalcompanies[$t]->company_name); ?></a>
	<?php //} ?>
	</strong></li><?php //if( $totalcompanies[$t]->subscribe == 'yes'){ ?>
	<li><?php echo $totalcompanies[$t]->name.' '.$totalcompanies[$t]->lastname; ?> <?php echo $totalcompanies[$t]->company_phone; ?> <?php if($totalcompanies[$t]->phone_ext){ echo "&nbsp;Ext.&nbsp;".$totalcompanies[$t]->phone_ext; } else{ echo ""; } ?></li>
	<?php
	$statecode  = "SELECT code from #__cam_vendor_states where id=".$totalcompanies[$t]->state." " ; 
	$db->setQuery($statecode);
	$statea = $db->loadResult(); 
	?>
	<li><?php echo $totalcompanies[$t]->city; ?>,&nbsp;<?php echo strtoupper($statea); ?></li>
	<li><a style="font-weight:normal; color:gray;" href="mailto:<?php echo $totalcompanies[$t]->email; ?>"><?php echo $totalcompanies[$t]->email; ?></a></li><?php 
	/*}  else { ?>
	<li>This Vendor's contact information is unavailable due to an expired account. <strong><a href="javascript:sendupdateemail('<?php  echo $totalcompanies[$t]->email; ?>','<?php echo $totalcompanies[$t]->company_name; ?>','<?php echo $totalcompanies[$t]->id; ?>')" class='notsubscribedvebndors'>CLICK HERE</a></strong> to request an update.</li>
	<?php }*/ ?>
	</ul>
	</div>
	<div class="search-panel-right_rfp apple_vendor_search">
	<?php
	$ratecount = "SELECT V.apple FROM `#__cam_vendor_proposals` as U, `#__cam_rfpinfo` as V where U.proposedvendorid=".$totalcompanies[$t]->id." and V.apple!=0 and V.apple_publish=0 and U.proposaltype='Awarded' and U.rfpno = V.id ";
	$db->setQuery($ratecount);
	$count_vs=$db->loadObjectList();
	
	$camratingf = "SELECT camrating FROM `#__users` where id=".$totalcompanies[$t]->id."  ";
		$db->setQuery($camratingf);
		$cam_ratingf = $db->loadResult();
		
	if($count_vs){
		for($c=0; $c<count($count_vs); $c++){
		$total = $total + $count_vs[$c]->apple ;
		}
		$camrating = "SELECT camrating FROM `#__users` where id=".$totalcompanies[$t]->id."  ";
		$db->setQuery($camrating);
		$cam_rating = $db->loadResult();
		
		if($cam_rating) {
		$total = $total + $cam_rating ;
		$count = count($count_vs) + 1;
		$avgrating = $total  / $count;	
		$rating =  round($avgrating, 1); 
		}
		else {
		$avgrating = $total  / count($count_vs);	
		$rating =  round($avgrating, 1); 
		}
	}
	else if($cam_ratingf){
	$rating = round($cam_ratingf, 1); 
	}
	else{
	$rating = 4 ;
	} 

	if ($rating > 0 && $rating <= 0.50)
			{ $rate_image = $rateimage.'5.png';  $rating='0.5'; }
			elseif ($rating > 0.50 && $rating <= 1.00)
			{ $rate_image = $rateimage.'10.png'; $rating='1'; }
			elseif ($rating > 1.00 && $rating <= 1.50)
			{ $rate_image = $rateimage.'15.png'; $rating='1.5';}
			elseif ($rating > 1.50 && $rating <= 2.00)
			{ $rate_image = $rateimage.'20.png'; $rating='2';}
			elseif ($rating > 2.00 && $rating <= 2.50)
			{ $rate_image = $rateimage.'25.png'; $rating='2.5';}
			elseif ($rating > 2.50 && $rating <= 3.00)
			{ $rate_image = $rateimage.'30.png'; $rating='3';}
			elseif ($rating > 3.00 && $rating <= 3.50)
			{ $rate_image = $rateimage.'35.png'; $rating='3.5';}
			elseif ($rating > 3.50 && $rating <= 4.00)
			{ $rate_image = $rateimage.'40.png'; $rating='4';}
			elseif ($rating > 4.00 && $rating <= 4.50)
			{ $rate_image = $rateimage.'45.png'; $rating='4.5';}
			elseif ($rating > 4.50 && $rating <= 5.00)
			{ $rate_image = $rateimage.'50.png'; $rating='5';}
			else
			{ $rate_image = $rateimage.'40.png'; $rating='4';}
			$total = 0;
			
	 ?>
	 		
			<img width="130" src="templates/camassistant_left/images/vendorrating/<?php echo $rate_image; ?>" />
			
	</div>
	
	<?php
				$master = $model->getmasterfirmaccount($user->id);
				$permission = $model->getpermission($master);
				$set_globals = $model->getmasterglobals($master);
				if($permission == 'yes' || $set_globals == 'fail'){
					$text = "N/A";
					$id = 'nostandards';
				}
				else{
					if($totalcompanies[$t]->final_status == 'fail' || $totalcompanies[$t]->acount_type == 'show'  ) {
					//$text = "NON-COMPLIANT";
					$id = 'noncompliant';
					$title = 'Non-Compliant';
					}
					else if($totalcompanies[$t]->final_status == 'success'){
					//$text = "COMPLIANT";
					$id = 'compliant';
					$title = 'Compliant';
					}
					else if($totalcompanies[$t]->final_status == 'medium'){
					//$text = "COMPLIANT & NON-COMPLIANT";
					$id = 'mediumcompliant';
					$title = 'Compliant & Non-Compliant';
					}
				}				
			?>
		
			
	<div class="search-panel-image_rfp compliant_vendor_search" style="width:117px;">
	  	  <p align="center" style="color:; display:block; margin-bottom:7px; font-weight:bold;">  
		 <?php  if($globe != 'fail'){ ?>
			<a onclick="javascript:getcompstatus(<?php echo $totalcompanies[$t]->id; ?>,'<?php echo $set_globals; ?>','<?php echo $title; ?>');" href="javascript:void(0);" id="<?php echo $id; ?>" title="<?php echo $title; ?>"><?php echo $text; ?></a>
			<?php } else {
			echo "N/A";
			}?>			
			 </p>

<?php
if( $totalcompanies[$t]->subscribe_type == 'free' || $totalcompanies[$t]->subscribe_type == '' ) { ?>
<div class="unverifiedvendor"><a href="javascript:void(0);" onclick="unverified(<?php echo $totalcompanies[$t]->id; ?>,'unverified');" title="Click for more info">UNVERIFIED</a></div>
<?php } else {  ?>
<div class="verifiedvendor"><a href="javascript:void(0);" onclick="unverified(<?php echo $totalcompanies[$t]->id; ?>,'verified');" title="Click for more info">VERIFIED</a></div>
<?php } ?>
			 
	  </div>
	  
	  <div class="clear"></div>
	  
	</div>
<?php } 

			}
	else{ 
$user =& JFactory::getUser(); 
if($user->user_type == '13'){
$item = '216';
}
else {
$item = '217';
}
?>
<p style='font-weight:bold; padding-top:20px;'>Your search has produced no matches.  <a href="index.php?option=com_camassistant&controller=vinvitations&Itemid=<?php echo $item; ?>" class="invitevendor" style="color:#6DAA00">CLICK HERE</a> to invite a Vendor</p>
<br /><br />
<?php }
?>
</div>
<?php 
if($user->user_type == '13' && $user->accounttype  == 'master' )
$pre_vendor = '';
else
$pre_vendor = 'none';	

$listbasicjobs = $model->getallbasicjobs();
if( count($listbasicjobs) > '0' )
	$basics = 'yes';
	else
	$basics = 'no';


	
if($totalcompanies){ ?>
	<div align="center" style="margin-top:17px; display:<?php echo $disp;?>">
	<a title="Add to My Vendors" class="addicon" href="javascript:sendinvitationcorporate('add');"></a>
	<a href="javascript:vendor_mails();" class="vendor_mails" title="Email Vendor(s)"></a>
	<a title="Create a new Basic Request" class="basicrequest" href="javascript:basicrequest('pre');"></a>
	<a title="Invite Vendor(s) to existing Basic Request" class="basicrequest_invite" href="javascript:inviteto_basicrequest('pre','<?php echo $basics; ?>');"></a>
	<a style= "display:<?php echo $pre_vendor;?>" title="Add to Corporate Preferred Vendors" class="addpreferredvendoricon" href="javascript:sendpreferredvendor_invitation();"></a>
	<a title="Recommend to Co-Workers" class="vendor_recommend" href="javascript:vendor_recommend();"></a>
	<?php 
	$user =& JFactory::getUser();
	if($user->accounttype  == 'master'){ ?>
	<a title="Block this Vendor from participating in your Managers' projects" class="exclude" href="javascript:sendinvitationcorporate('exclude');"></a>
	<?php } ?>
	
	</div>
<?php 	} ?>
	<?php 
	exit;
	}
	//To send the mail to request update
	function sendupdateemail(){
	$db = JFactory::getDBO();
	$sql12="SELECT introtext  FROM #__content where id='259' ";
	$db->Setquery($sql12);
	$mailbody = $db->loadResult();
	$to	= JRequest::getVar('Email','');
	$cname	= JRequest::getVar('cname','');
	$id	= JRequest::getVar('vendorid','');
	$ccemail = "SELECT ccemail  FROM #__users where id='".$id."' ";
	$db->Setquery($ccemail);
	$ccemails = $db->loadResult();
	
	//To get vendor company
	$getcname = "SELECT company_name FROM `#__cam_vendor_company`  where user_id=".$id." ";
	$db->setQuery($getcname);
	$cname = $db->loadResult();
	$body = str_replace('[Vendor]',$cname,$mailbody);
	$mailfrom = 'support@myvendorcenter.com';
	$fromname = 'MyVendorCenter.com';
	$mailsubject = 'A Request has been made to Activate Your Account';

	$result = JUtility::sendMail($mailfrom, $fromname, $to, $mailsubject, $body, $mode = 1);
	$to = 'vendoremails@myvendorcenter.com';
	$result = JUtility::sendMail($mailfrom, $fromname, $to, $mailsubject, $body, $mode = 1);
	//Send mail to CCEMAIL
	$cclist = explode(';',$ccemails);
		for($c=0; $c<=count($cclist); $c++){
		$listcc = $cclist[$c];
		if($listcc){
		$res = JUtility::sendMail($mailfrom, $fromname, $listcc, $mailsubject, $body, $mode = 1);
		}
		} 
	//Completed	
	if($result){
	echo "1";
	}		
	else {
	echo "0";
	}	
	exit;
	}
	
	function getinsurancestandards(){	
		$vendorid = $_REQUEST['vendorid'];
	    $status	= JRequest::getVar('status','');
		$user =& JFactory::getUser();
		global $mainframe;
		$db=&JFactory::getDBO();
		$user=&JFactory::getUser();
		$model = $this->getModel('vendorscenter');
		$allindustries = $model->vendorallindustries($vendorid);
		
	   $managerid =	$model->getmasterfirmaccount($user->id);
       
		$set_globals = $model->getmasterglobals($managerid);
		
		$vendor_subscribe =	$model->getvendorsubscribe($vendorid);
		
		$vendor_cname =	$model->getvendoremail($vendorid);
		
		if( $status == 'Non-Compliant' || $status == 'Compliant and Non-Compliant' )
		$background = 'red';
		else
		$background = '#77b800';
		
		?>
		
	
	<div id="i_bar_terms" style="margin-bottom:20px; position:fixed; width:100%; background:<?php echo $background; ?>">
<div id="i_bar_txt_terms">
<span> <font style="font-weight:bold; color:#FFF; font-size:14px;"><?php echo strtoupper($vendor_cname->company_name); ?></font></span>
</div></div>

	
		<?php
		for( $in=0; $in<count($allindustries); $in++ ){
			$industryid = $allindustries[$in]->value;
			
			$w9data = $model->getw9insdata($industryid,$managerid);

			$vendor_w9data = $model->getvendorw9insdata($vendorid);
			
			$generaldata = $model->getgeneralinsdata($industryid,$managerid);
			$vendor_generaldata = $model->getvendorgeneralinsdata($vendorid);
			
			$autodata = $model->getautoinsdata($industryid,$managerid);
			$vendor_autodata = $model->getvendorautoinsdata($vendorid);
			
			$workdata = $model->getworkinsdata($industryid,$managerid);
			$vendor_workdata = $model->getvendorworkinsdata($vendorid);

			$umbrelladata = $model->getumbrellainsdata($industryid,$managerid);
			$vendor_umbrelladata = $model->getvendorumbrellainsdata($vendorid);
			
			$licdata = $model->getlicinsdata($industryid,$managerid);
			$vendor_licdata = $model->getvendorlicinsdata($vendorid);
			
			$vendor_occdata = $model->getvendoroccinsdata($vendorid);
			$permission = $model->getpermission($managerid);
			
			$omidata = $model->getomiinsdata($industryid,$managerid);
			$vendor_omidata = $model->getvendoromiinsdata($vendorid);
			
			if($permission == 'yes' || $set_globals == 'fail'){
				if($in == '0'){
				echo "<p style='padding:0 20px; font-size:13px;'>No requirements have been set by the Master Account or within Step 1 of the request creation process. Please contact MyVendorCenter for more information on how to set Compliance Standards.</p>";
				}
			}
			
			else if( $w9data || $generaldata || $autodata || $workdata || $umbrelladata || $licdata || $omidata){
		?>
		<?php 
		if($in == 0) { 
		
			if( $status == 'Non-Compliant' || $status == 'Compliant & Non-Compliant' )
				$color_status = 'red';
			else
				$color_status = '#77b800';	
		?>
		<p class="terms_conditions_noborder_status">Compliance Status: <font color="<?php echo $color_status; ?>"><?php echo $status; ?></font></p>
		<?php } ?>	
		
		<?php 
		if($in == 0) {
			if( $vendor_subscribe == 'free' ) {
			?>
			
			<p class="terms_conditions_noborder_docs">Compliance Documents:<span style="color:red;">&nbsp;Unverified</span></p>
			<?php } else { ?>
			<p class="terms_conditions_noborder_docs">Compliance Documents:<span style="color:#77b800;">&nbsp;Verified</span></p>
			<?php } ?>
		
		<?php
		
		$managerid  = $user->id; 
		$masterid = $model->getmasterfirmaccount($managerid);
		
		$whers_cond = 'vendorid='.$masterid.'';
		
		$query_conditon = "SELECT termsconditions FROM #__cam_vendor_aboutus  WHERE ".$whers_cond." ";
		$db->setQuery( $query_conditon );
		$terms = $db->loadResult();

		
		if($terms == '1'){
			$result = $this->gettermsandconditions($masterid,$vendorid);
		}
		?>
		<p class="terms_conditions_noborder"><?php echo $result; ?></p>
		<?php } ?>
		<div id="industrydiv_<?php echo $industryid; ?>" class="lineitem_pan_row_standards" style="background:#fff;">
		<h1 id="industry_<?php echo $industryid; ?>"><?php echo $allindustries[$in]->industry_name; ?></h1>
	

<div class="lineitem_pan" style="border:none;">
	<div class="insurancedotline_preferred" style="border-bottom:none; margin-left:17px;">
	<table cellpadding="0" cellspacing="0" border="0" width="90%">
	<?php
	if($w9data) { $w9_main = 'checked="checked"'; $w9_class = 'styled active';  
	?>
	
	<tr><td width="10"><input type="checkbox" value="yes" id="w9liability" class="<?php echo $w9_class; ?>" name="w9standards" <?php echo $w9_main; ?> /></td><td><strong><label style="display:block; padding-top:3px;">W9</label></strong></td></tr>
	<?php } ?>
	<?php 
	$general_main = '';
	$gen_class = '';
	if($w9data) {
	?>
	<tr><td></td><td>
	<ul class="pre_general">
		<?php
			if(!$vendor_w9data[0]->w9_upld_cert){
				echo '<li><span style="color:red;">No Certificate Uploaded</span></li>';
				$redlabel = 'red';
			}
			if( $vendor_w9data[0]->w9_status == '-1' ){
				echo '<li><span style="color:red;">Rejected By MyVC</span></li>';
				$redlabel = 'red';
			}
		?>
	</ul>
	</td></tr>
	
	<?php } ?>
	
	<?php
	
	if($generaldata) { $general_main = 'checked="checked"'; $gen_class = 'styled active';  
	?>
	
	<tr><td width="10"><input type="checkbox" value="yes" id="generalliability" class="<?php echo $gen_class; ?>" name="generalliability" <?php echo $general_main; ?> /></td><td><strong><label style="display:block; padding-top:3px;">General Liability</label></strong></td></tr>
	<?php } ?>
	<?php 
	$general_main = '';
	$gen_class = '';
	if($generaldata) {
	?>
	<tr><td></td><td>
	<ul class="pre_general">
			<?php
			$success_gli_file = '';
			
			for( $file=0; $file<count($vendor_generaldata); $file++ ){
							if($vendor_generaldata[$file]->GLI_upld_cert){
							$success_gli_file[] = $vendor_generaldata[$file];
						}
					}
			if(!$success_gli_file) {
			$redlabel = 'red';
			 ?>
			<li><span style="color:red;">No Certificate Uploaded</span></li>
			<?php }
			?>
			
			<?php 
				if( count($success_gli_file) >= 1 && !empty($success_gli_file) )
				$success_arr_exp = $success_gli_file ;
				else
				$success_arr_exp = $vendor_generaldata ;
				$success_gli_exp = '';
				
			for( $exp=0; $exp<count($success_arr_exp); $exp++ ){
				if( $success_arr_exp[$exp]->GLI_end_date >= date('Y-m-d') ){
					$success_gli_exp[] = $success_arr_exp[$exp];
				}
			}
			if(!$success_gli_exp && $success_gli_file) {
			$redlabel = 'red';
			 ?>
			<li><span style="color:red;">Expired</span></li>
			<?php }
			?>
		 
		 	<?php 
				if( count($success_gli_exp) >= 1 && !empty($success_gli_exp) )
				$success_arr_rej = $success_gli_file ;
				else if( count($success_gli_file) >= 1 && !empty($success_gli_file) )
				$success_arr_rej = $success_gli_file ;
				else
				$success_arr_rej = $vendor_generaldata ;
				$success_gli_rej = '';
				
			for( $rej=0; $rej<count($success_arr_rej); $rej++ ){
				if( $success_arr_rej[$rej]->GLI_status == '-1' ){
					$success_gli_rej[] = $success_arr_rej[$rej];
				}
			}
			if($success_gli_rej) {
			$redlabel = 'red';
			 ?>
			<li><span style="color:red;">Rejected By MyVC</span></li>
			<?php }
			?>
			
			<?php 
			if( count($success_gli_rej) >= 1 && !empty($success_gli_rej) )
				$success_arr_rej = $success_gli_rej ;
				else if( count($success_gli_exp) >= 1 && !empty($success_gli_exp) )
				$success_arr_rej = $success_gli_exp ;
				else if( count($success_gli_file) >= 1 && !empty($success_gli_file) )
				$success_arr_rej = $success_gli_file ;
				else
				$success_arr_rej = $vendor_generaldata ;
				$success_gli_occ = '';	
			for( $occ=0; $occ<count($success_arr_rej); $occ++ ){
						if( $generaldata->occur == 'yes' ){
							if($success_arr_rej[$occ]->GLI_occur == 'occur'){
							$success_gli_occ[] = $success_arr_rej[$occ];
							}
						}
					}
			if($success_gli_occ)
			$class_occ = '';
			else
			$class_occ = 'red';
			
			if( $class_occ == 'red' && $generaldata->occur )
			$red_newlabel = 'red';
		 ?>
		<?php if($generaldata->occur){ $selected_occur = 'checked'; $class = 'styled active'; ?>
		<li><input type="checkbox" value="yes" name="occur" class="<?php echo $class; ?>" checked="<?php echo $selected_occur; ?>" /> <label><span style="color:<?php echo $class_occ; ?>">Occur</span></label></li>
		<?php } ?>
		<?php 
				if( count($success_gli_occ) >= 1 && !empty($success_gli_occ) )
				$success_arr_occ = $success_gli_occ ;
				else if( count($success_gli_rej) >= 1 && !empty($success_gli_rej) )
				$success_arr_occ = $success_gli_rej ;
				else if( count($success_gli_exp) >= 1 && !empty($success_gli_exp) )
				$success_arr_occ = $success_gli_exp ;
				else if( count($success_gli_file) >= 1 && !empty($success_gli_file) )
				$success_arr_occ = $success_gli_file ;
				else
				$success_arr_occ = $vendor_generaldata ;
				
				$success_gli_each = '';
			for( $vg=0; $vg<count($success_arr_occ); $vg++ ){
				if( $generaldata->each_occurrence <= $success_arr_occ[$vg]->GLI_policy_occurence ){
					$success_gli_each[] = $success_arr_occ[$vg];
				}
			}
			if($success_gli_each)
			$class_each = '';
			else
			$class_each = 'red';
			
			if( $class_each == 'red' && $generaldata->each_occurrence && $generaldata->each_occurrence != '0.00' )
			$red_newlabel = 'red';
		 ?>
		 <?php if($generaldata->each_occurrence && $generaldata->each_occurrence != '0.00'){ ?>
		<li><span style="color:<?php echo $class_each; ?>">Each Occurrence:&nbsp;<?php echo "$".number_format($generaldata->each_occurrence,2); ?></span></li>
		<?php } ?>
		<?php 
				if( count($success_gli_each) >= 1 && !empty($success_umb_agg) )
				$success_arr = $success_gli_each ;
				else if( count($success_gli_occ) >= 1 && !empty($success_gli_occ) )
				$success_arr = $success_gli_occ ;
				else if( count($success_gli_rej) >= 1 && !empty($success_gli_rej) )
				$success_arr = $success_gli_rej ;
				else if( count($success_gli_exp) >= 1 && !empty($success_gli_exp) )
				$success_arr = $success_gli_exp ;
				else if( count($success_gli_file) >= 1 && !empty($success_gli_file) )
				$success_arr = $success_gli_file ;
				else
				$success_arr = $vendor_generaldata ;
				$success_gli_damage = '';
					for( $dr=0; $dr<count($success_arr); $dr++ ){
						if( $generaldata->damage_retend <= $success_arr[$dr]->GLI_damage ){
							$success_gli_damage[] = $success_arr[$dr];
						}
					}
			if($success_gli_damage)
			$class_damage = '';
			else
			$class_damage = 'red';
			
			if( $class_damage == 'red' && $generaldata->damage_retend && $generaldata->damage_retend != '0.00' )
			$red_newlabel = 'red';
			?>
			<?php 
			if($generaldata->damage_retend && $generaldata->damage_retend != '0.00'){
		 ?>
		<li><span style="color:<?php echo $class_damage; ?>">Damage to Rented Premises:&nbsp;<?php echo "$".number_format($generaldata->damage_retend,2); ?></span></li>
		<?php } ?>
		
		<?php 
				if( count($success_gli_damage) >= 1 && !empty($success_gli_damage) )
				$success_arr_med = $success_gli_damage ;
				else if( count($success_gli_each) >= 1 && !empty($success_gli_each) )
				$success_arr_med = $success_gli_each ;
				else if( count($success_gli_occ) >= 1 && !empty($success_gli_occ) )
				$success_arr_med = $success_gli_occ ;
				else if( count($success_gli_rej) >= 1 && !empty($success_gli_rej) )
				$success_arr_med = $success_gli_rej ;
				else if( count($success_gli_exp) >= 1 && !empty($success_gli_exp) )
				$success_arr_med = $success_gli_exp ;
				else if( count($success_gli_file) >= 1 && !empty($success_gli_file) )
				$success_arr_med = $success_gli_file ;
				else
				$success_arr_med = $vendor_generaldata ;
				
				$success_gli_med = '';
					for( $dam=0; $dam<count($success_arr_med); $dam++ ){
						if( $generaldata->med_expenses <= $success_arr_med[$dam]->GLI_med ){
							$success_gli_med[] = $success_arr_med[$dam];
						}
					}
			if($success_gli_med)
			$class_med = '';
			else
			$class_med = 'red';
			
			if( $class_med == 'red' && $generaldata->med_expenses && $generaldata->med_expenses != '0.00' )
			$red_newlabel = 'red';
		 ?>
		 <?php if($generaldata->med_expenses && $generaldata->med_expenses != '0.00'){ ?>
		<li><span style="color:<?php echo $class_med; ?>">Med Expenses:&nbsp;<?php echo "$".number_format($generaldata->med_expenses,2); ?></span></li>
		<?php } ?>
		
		<?php 
				if( count($success_gli_med) >= 1 && !empty($success_gli_med) )
				$success_arr_inj = $success_gli_med ;
				else if( count($success_gli_damage) >= 1 && !empty($success_gli_damage) )
				$success_arr_inj = $success_gli_damage ;
				else if( count($success_gli_each) >= 1 && !empty($success_gli_each) )
				$success_arr_inj = $success_gli_each ;
				else if( count($success_gli_occ) >= 1 && !empty($success_gli_occ) )
				$success_arr_inj = $success_gli_occ ;
				else if( count($success_gli_rej) >= 1 && !empty($success_gli_rej) )
				$success_arr_inj = $success_gli_rej ;
				else if( count($success_gli_exp) >= 1 && !empty($success_gli_exp) )
				$success_arr_inj = $success_gli_exp ;
				else if( count($success_gli_file) >= 1 && !empty($success_gli_file) )
				$success_arr_inj = $success_gli_file ;
				else
				$success_arr_inj = $vendor_generaldata ;
				
				$success_gli_pi = '';
					for( $pi=0; $pi<count($success_arr_inj); $pi++ ){
						if( $generaldata->personal_inj <= $success_arr_inj[$pi]->GLI_injury ){
							$success_gli_pi[] = $success_arr_inj[$pi];
						}
					}
				
			if($success_gli_pi)
			$class_pi = '';
			else
			$class_pi = 'red';
			
			if( $class_pi == 'red' && $generaldata->personal_inj && $generaldata->personal_inj != '0.00' )
			$red_newlabel = 'red';
		 ?>
		 <?php if($generaldata->personal_inj && $generaldata->personal_inj != '0.00'){ ?>
		<li><span style="color:<?php echo $class_pi; ?>">Personal & Adv injury:&nbsp;<?php echo "$".number_format($generaldata->personal_inj,2); ?></span></li>
		<?php } ?>
		
		<?php 
				if( count($success_gli_pi) >= 1 && !empty($success_gli_pi) )
				$success_arr_aggr = $success_gli_pi ;
				else if( count($success_gli_med) >= 1 && !empty($success_gli_med) )
				$success_arr_aggr = $success_gli_med ;
				else if( count($success_gli_damage) >= 1 && !empty($success_gli_damage) )
				$success_arr_aggr = $success_gli_damage ;
				else if( count($success_gli_each) >= 1 && !empty($success_gli_each) )
				$success_arr_aggr = $success_gli_each ;
				else if( count($success_gli_occ) >= 1 && !empty($success_gli_occ) )
				$success_arr_aggr = $success_gli_occ ;
				else if( count($success_gli_rej) >= 1 && !empty($success_gli_rej) )
				$success_arr_aggr = $success_gli_rej ;
				else if( count($success_gli_exp) >= 1 && !empty($success_gli_exp) )
				$success_arr_aggr = $success_gli_exp ;
				else if( count($success_gli_file) >= 1 && !empty($success_gli_file) )
				$success_arr_aggr = $success_gli_file ;
				else
				$success_arr_aggr = $vendor_generaldata ;
					$success_gli_ga = '';
					for( $ga=0; $ga<count($success_arr_aggr); $ga++ ){
						if( $generaldata->general_aggr <= $success_arr_aggr[$ga]->GLI_policy_aggregate ){
							$success_gli_ga[] = $success_arr_aggr[$ga];
						}
					}
				
			if($success_gli_ga)
			$class_ga = '';
			else
			$class_ga = 'red';
			
			if( $class_ga == 'red' && $generaldata->general_aggr && $generaldata->general_aggr != '0.00' )
			$red_newlabel = 'red';
		?>
		<?php if($generaldata->general_aggr && $generaldata->general_aggr != '0.00'){ ?>
		<li><span style="color:<?php echo $class_ga; ?>">General Aggregate:&nbsp;<?php echo "$".number_format($generaldata->general_aggr,2); ?></span>
		<?php } ?>
				
				<?php 
				if( count($success_gli_ga) >= 1 && !empty($success_gli_ga) )
				$success_arr_app = $success_gli_ga ;
				else if( count($success_gli_pi) >= 1 && !empty($success_gli_pi) )
				$success_arr_app = $success_gli_pi ;
				else if( count($success_gli_med) >= 1 && !empty($success_gli_med) )
				$success_arr_app = $success_gli_med ;
				else if( count($success_gli_damage) >= 1 && !empty($success_gli_damage) )
				$success_arr_app = $success_gli_damage ;
				else if( count($success_gli_each) >= 1 && !empty($success_gli_each) )
				$success_arr_app = $success_gli_each ;
				else if( count($success_gli_occ) >= 1 && !empty($success_gli_occ) )
				$success_arr_app = $success_gli_occ ;
				else if( count($success_gli_rej) >= 1 && !empty($success_gli_rej) )
				$success_arr_app = $success_gli_rej ;
				else if( count($success_gli_exp) >= 1 && !empty($success_gli_exp) )
				$success_arr_app = $success_gli_exp ;
				else if( count($success_gli_file) >= 1 && !empty($success_gli_file) )
				$success_arr_app = $success_gli_file ;
				else
				$success_arr_app = $vendor_generaldata ;
				$success_gli_app = '';
					for( $app=0; $app<count($success_arr_app); $app++ ){
						if($generaldata->applies_to){
							if( $success_arr_app[$app]->GLI_applies == $generaldata->applies_to ){
								$success_gli_app[] = $success_arr_aggr[$app];
							}
						}
					}
				
			if($success_gli_app)
			$class_app = '';
			else
			$class_app = 'red';
			
			if( $class_app == 'red' && $generaldata->applies_to )
			$red_newlabel = 'red';
				?>
		<?php if($generaldata->applies_to){ ?>
		<?php if($generaldata->applies_to == 'pol') {
			  $pols = "checked='checked'";
			 // $class_app_opt1 = 'red';
			  }
		      else if($generaldata->applies_to == 'proj') {
			  $proj = "checked='checked'";
			 // $class_app_opt2 = 'red';
			  }
			  else if($generaldata->applies_to == 'loc') {
			 // $class_app_opt3 = 'red';
			  $loc = "checked='checked'";
			  }
			  
			  if($generaldata->applies_to == 'pol' && !$success_gli_app) {
			  	$class_app_opt1 = 'red';
			  }
			   else if($generaldata->applies_to == 'proj' && !$success_gli_app) {
			   $class_app_opt2 = 'red';
			   }
			    else if($generaldata->applies_to == 'loc' && !$success_gli_app) {
			   $class_app_opt3 = 'red';
			   }
		 ?>
		<span style="color:<?php echo $class_app; ?>">| Applies To: </span>
		<input type="radio" <?php echo $pols; ?> style="vertical-align:top; margin-top:2px;" /><span style="color:<?php echo $class_app_opt1; ?>">Pol</span>&nbsp;
		<input type="radio" <?php echo $proj; ?> style="vertical-align:top; margin-top:2px;" /><span style="color:<?php echo $class_app_opt2; ?>">Proj</span>&nbsp;
		<input type="radio" <?php echo $loc; ?> style="vertical-align:top; margin-top:2px;" /><span style="color:<?php echo $class_app_opt3; ?>">Loc</span>
		</li>
		<?php } ?>
		
		<?php 
				if( count($success_gli_app) >= 1 && !empty($success_gli_app) )
				$success_arr_pro = $success_gli_app ;
				else if( count($success_gli_ga) >= 1 && !empty($success_gli_ga) )
				$success_arr_pro = $success_gli_ga ;
				else if( count($success_gli_pi) >= 1 && !empty($success_gli_pi) )
				$success_arr_pro = $success_gli_pi ;
				else if( count($success_gli_med) >= 1 && !empty($success_gli_med) )
				$success_arr_pro = $success_gli_med ;
				else if( count($success_gli_damage) >= 1 && !empty($success_gli_damage) )
				$success_arr_pro = $success_gli_damage ;
				else if( count($success_gli_each) >= 1 && !empty($success_gli_each) )
				$success_arr_pro = $success_gli_each ;
				else if( count($success_gli_occ) >= 1 && !empty($success_gli_occ) )
				$success_arr_pro = $success_gli_occ ;
				else if( count($success_gli_rej) >= 1 && !empty($success_gli_rej) )
				$success_arr_pro = $success_gli_rej ;
				else if( count($success_gli_exp) >= 1 && !empty($success_gli_exp) )
				$success_arr_pro = $success_gli_exp ;
				else if( count($success_gli_file) >= 1 && !empty($success_gli_file) )
				$success_arr_pro = $success_gli_file ;
				else
				$success_arr_pro = $vendor_generaldata ;
				$success_gli_pro = '';
					for( $pro=0; $pro<count($success_arr_pro); $pro++ ){
						if( $generaldata->products_aggr <= $success_arr_pro[$pro]->GLI_products ){
							$success_gli_pro[] = $success_arr_pro[$pro];
						}
					}
				if($success_gli_pro)
				$class_pro = '';
				else
				$class_pro = 'red';	
				
				if( $class_pro == 'red' && $generaldata->products_aggr && $generaldata->products_aggr != '0.00' )
				$red_newlabel = 'red';
		?>
		<?php if($generaldata->products_aggr && $generaldata->products_aggr != '0.00'){ ?>
		<li><span style="color:<?php echo $class_pro; ?>">Products - COMP/OP Aggregate:&nbsp;<?php echo "$".number_format($generaldata->products_aggr,2); ?></span></li>
		<?php } ?>
		
		<?php 
				
				if( count($success_gli_pro) >= 1 && !empty($success_gli_pro) )
				$success_arr_waiver = $success_gli_pro ;
				else if( count($success_gli_app) >= 1 && !empty($success_gli_app) )
				$success_arr_waiver = $success_gli_app ;
				else if( count($success_gli_ga) >= 1 && !empty($success_gli_ga) )
				$success_arr_waiver = $success_gli_ga ;
				else if( count($success_gli_pi) >= 1 && !empty($success_gli_pi) )
				$success_arr_waiver = $success_gli_pi ;
				else if( count($success_gli_med) >= 1 && !empty($success_gli_med) )
				$success_arr_waiver = $success_gli_med ;
				else if( count($success_gli_damage) >= 1 && !empty($success_gli_damage) )
				$success_arr_waiver = $success_gli_damage ;
				else if( count($success_gli_each) >= 1 && !empty($success_gli_each) )
				$success_arr_waiver = $success_gli_each ;
				else if( count($success_gli_occ) >= 1 && !empty($success_gli_occ) )
				$success_arr_waiver = $success_gli_occ ;
				else if( count($success_gli_rej) >= 1 && !empty($success_gli_rej) )
				$success_arr_waiver = $success_gli_rej ;
				else if( count($success_gli_exp) >= 1 && !empty($success_gli_exp) )
				$success_arr_waiver = $success_gli_exp ;
				else if( count($success_gli_file) >= 1 && !empty($success_gli_file) )
				$success_arr_waiver = $success_gli_file ;
				else
				$success_arr_waiver = $vendor_generaldata ;
				
				$success_gli_wai = '';
					for( $wai=0; $wai<count($success_arr_waiver); $wai++ ){
						if( $generaldata->waiver_sub == 'yes' ){
							if($success_arr_waiver[$wai]->GLI_waiver == 'waiver'){
							$success_gli_wai[] = $success_arr_wai[$wai];
							}
						}
					}
				if($success_gli_wai)
				$class_wai = '';
				else
				$class_wai = 'red';	
				
				if( $class_wai == 'red' && $generaldata->waiver_sub == 'yes' )
				$red_newlabel = 'red';
		?>
		
		
		<?php if($generaldata->waiver_sub == 'yes'){ $waiv = 'checked'; $class_waiver_sub = 'styled'; ?>
		<li><input type="checkbox" value="yes" name="waiver_sub" checked="<?php echo $waiv; ?>" class="<?php echo $class_waiver_sub; ?>" /> <label><span style="color:<?php echo $class_wai; ?>">Waiver of Subrogation</span></label></li>
		<?php } ?>
		
		<?php 
				if( count($success_gli_wai) >= 1 && !empty($success_gli_wai) )
				$success_arr_primary = $success_gli_wai ;
				else if( count($success_gli_pro) >= 1 && !empty($success_gli_pro) )
				$success_arr_primary = $success_gli_pro ;
				if( count($success_gli_app) >= 1 && !empty($success_gli_app) )
				$success_arr_primary = $success_gli_app ;
				else if( count($success_gli_ga) >= 1 && !empty($success_gli_ga) )
				$success_arr_primary = $success_gli_ga ;
				else if( count($success_gli_pi) >= 1 && !empty($success_gli_pi) )
				$success_arr_primary = $success_gli_pi ;
				else if( count($success_gli_med) >= 1 && !empty($success_gli_med) )
				$success_arr_primary = $success_gli_med ;
				else if( count($success_gli_damage) >= 1 && !empty($success_gli_damage) )
				$success_arr_primary = $success_gli_damage ;
				else if( count($success_gli_each) >= 1 && !empty($success_gli_each) )
				$success_arr_primary = $success_gli_each ;
				else if( count($success_gli_occ) >= 1 && !empty($success_gli_occ) )
				$success_arr_primary = $success_gli_occ ;
				else if( count($success_gli_rej) >= 1 && !empty($success_gli_rej) )
				$success_arr_primary = $success_gli_rej ;
				else if( count($success_gli_exp) >= 1 && !empty($success_gli_exp) )
				$success_arr_primary = $success_gli_exp ;
				else if( count($success_gli_file) >= 1 && !empty($success_gli_file) )
				$success_arr_primary = $success_gli_file ;
				else
				$success_arr_primary = $vendor_generaldata ;
				
				$success_gli_primary = '';
					for( $pri=0; $pri<count($success_arr_primary); $pri++ ){
						if( $generaldata->primary_noncontr == 'yes' ){
							if($success_arr_primary[$pri]->GLI_primary == 'primary'){
							$success_gli_primary[] = $success_arr_primary[$pri];
							}
						}
					}
				if($success_gli_primary)
				$class_pri = '';
				else
				$class_pri = 'red';	
				
				if( $class_pri == 'red' && $generaldata->primary_noncontr )
				$red_newlabel = 'red';
		?>
		
		<?php if($generaldata->primary_noncontr == 'yes'){ $prim = 'checked'; $class_primary_noncontr = 'styled';?>
		<li><input type="checkbox" value="yes" name="primary_noncontr" checked="<?php echo $prim; ?>" class="<?php echo $class_primary_noncontr; ?>" /> <label><span style="color:<?php echo $class_pri; ?>">Primary Non-Contributory</span></label></li>
		<?php } ?>
		<?php 
				if( count($success_gli_primary) >= 1 && !empty($success_gli_primary) )
				$success_arr_add = $success_gli_primary ;
				else if( count($success_gli_wai) >= 1 && !empty($success_gli_wai) )
				$success_arr_add = $success_gli_wai ;
				else if( count($success_gli_pro) >= 1 && !empty($success_gli_pro) )
				$success_arr_add = $success_gli_pro ;
				if( count($success_gli_app) >= 1 && !empty($success_gli_app) )
				$success_arr_add = $success_gli_app ;
				else if( count($success_gli_ga) >= 1 && !empty($success_gli_ga) )
				$success_arr_add = $success_gli_ga ;
				else if( count($success_gli_pi) >= 1 && !empty($success_gli_pi) )
				$success_arr_add = $success_gli_pi ;
				else if( count($success_gli_med) >= 1 && !empty($success_gli_med) )
				$success_arr_add = $success_gli_med ;
				else if( count($success_gli_damage) >= 1 && !empty($success_gli_damage) )
				$success_arr_add = $success_gli_damage ;
				else if( count($success_gli_each) >= 1 && !empty($success_gli_each) )
				$success_arr_add = $success_gli_each ;
				else if( count($success_gli_occ) >= 1 && !empty($success_gli_occ) )
				$success_arr_add = $success_gli_occ ;
				else if( count($success_gli_rej) >= 1 && !empty($success_gli_rej) )
				$success_arr_add = $success_gli_rej ;
				else if( count($success_gli_exp) >= 1 && !empty($success_gli_exp) )
				$success_arr_add = $success_gli_exp ;
				else if( count($success_gli_file) >= 1 && !empty($success_gli_file) )
				$success_arr_add = $success_gli_file ;
				else
				$success_arr_add = $vendor_generaldata ;
				//echo "<pre>"; print_r($success_arr_add); echo "</pre>";
				//echo "<pre>"; print_r($generaldata); echo "</pre>";
				$success_gli_add = '';
					for( $add=0; $add<count($success_arr_add); $add++ ){
						if( $generaldata->additional_insured == 'yes' ){
							if($success_arr_add[$add]->GLI_additional){
							$success_gli_add[] = $success_arr_add[$add];
							}
						}
					}
					
				if($success_gli_add)
				$class_add = '';
				else
				$class_add = 'red';	
				
				if( $class_add == 'red' && $generaldata->additional_insured == 'yes' )
				$red_newlabel = 'red';
		?>
		<?php if($generaldata->additional_insured == 'yes'){ $add = 'checked'; $class_additional_insured = 'styled';?>
		<li><input type="checkbox" value="yes" name="additional_insured" checked="<?php echo $add; ?>" class="<?php echo $class_additional_insured; ?>" /><label> <span style="color:<?php echo $class_add; ?>">List my Company as as "Additional Insured"</span></label></li>
		<?php } ?>
		
		<?php 
				if( count($success_gli_add) >= 1 && !empty($success_gli_add) )
				$success_arr_cert = $success_gli_add ;
				else if( count($success_gli_primary) >= 1 && !empty($success_gli_primary) )
				$success_arr_cert = $success_gli_primary ;
				else if( count($success_gli_wai) >= 1 && !empty($success_gli_wai) )
				$success_arr_cert = $success_gli_wai ;
				else if( count($success_gli_pro) >= 1 && !empty($success_gli_pro) )
				$success_arr_cert = $success_gli_pro ;
				if( count($success_gli_app) >= 1 && !empty($success_gli_app) )
				$success_arr_cert = $success_gli_app ;
				else if( count($success_gli_ga) >= 1 && !empty($success_gli_ga) )
				$success_arr_cert = $success_gli_ga ;
				else if( count($success_gli_pi) >= 1 && !empty($success_gli_pi) )
				$success_arr_cert = $success_gli_pi ;
				else if( count($success_gli_med) >= 1 && !empty($success_gli_med) )
				$success_arr_cert = $success_gli_med ;
				else if( count($success_gli_damage) >= 1 && !empty($success_gli_damage) )
				$success_arr_cert = $success_gli_damage ;
				else if( count($success_gli_each) >= 1 && !empty($success_gli_each) )
				$success_arr_cert = $success_gli_each ;
				else if( count($success_gli_occ) >= 1 && !empty($success_gli_occ) )
				$success_arr_cert = $success_gli_occ ;
				else if( count($success_gli_rej) >= 1 && !empty($success_gli_rej) )
				$success_arr_cert = $success_gli_rej ;
				else if( count($success_gli_exp) >= 1 && !empty($success_gli_exp) )
				$success_arr_cert = $success_gli_exp ;
				else if( count($success_gli_file) >= 1 && !empty($success_gli_file) )
				$success_arr_cert = $success_gli_file ;
				else
				$success_arr_cert = $vendor_generaldata ;
				//echo "<pre>"; print_r($success_arr_cert); echo "</pre>";
				$success_gli_cert = '';
					for( $cert=0; $cert<count($success_arr_cert); $cert++ ){
						//if( $generaldata->cert_holder == 'yes' ){
							if( $generaldata->cert_holder == $success_arr_cert[$cert]->GLI_certholder ){
							$success_gli_cert[] = $success_arr_cert[$cert];
							}
						//}
					}
				if($success_gli_cert)
				$class_cert = '';
				else
				$class_cert = 'red';
				
				if( $class_cert == 'red' && $generaldata->cert_holder == 'yes' )
				$red_newlabel = 'red';	
		?>
		<?php if($generaldata->cert_holder == 'yes'){ $cert = 'checked'; $class_cert_holder = 'styled'; ?>
		<li><input type="checkbox" value="yes" name="cert_holder" checked="<?php echo $cert; ?>" class="<?php echo $class_cert_holder; ?>"  /><label> <span style="color:<?php echo $class_cert; ?>">MyVendorCenter listed as Cert. Holder</span></label></li>
		<?php } ?>
		</ul>		
		</td>
		</td></tr>
	<?php } ?>	
	<tr id="generalliability_sub"></tr>
	<?php
		if($autodata){ $auto_main = 'checked="checked"'; $class_auto="styled active"; 
	?>
	

	<tr><td width="10"><input type="checkbox" value="yes" id="autoliability" class="<?php echo $class_auto; ?>" name="autoliability" <?php echo $auto_main; ?> /></td><td><strong><label style="display:block; padding-top:3px;">Auto Liability</label></strong></td></tr>
	<?php } ?>
	<?php if($autodata){ ?>
	<tr><td></td><td>
	<ul class="pre_auto">
		<?php 
				$success_aip_file = '';
				for( $file=0; $file<count($vendor_autodata); $file++ ){
						if( $vendor_autodata[$file]->aip_upld_cert ){
							$success_aip_file[] = $vendor_autodata[$file];
						}
				}
				
			if(!$success_aip_file) {
			$redlabel = 'red';
			 ?>
			<li><span style="color:red;">No Certificate Uploaded</span></li>
			<?php }
			?>
				
				
			<?php 
				if( count($success_aip_file) >= 1 && !empty($success_aip_file) )
				$success_arr_exp = $success_aip_file ;
				else
				$success_arr_exp = $vendor_autodata ;
				
				$success_aip_exp = '';
				for( $exp=0; $exp<count($success_arr_exp); $exp++ ){
						if( $success_arr_exp[$exp]->aip_end_date >= date('Y-m-d' ) ){
							$success_aip_exp[] = $success_arr_exp[$exp];
						}
				}
				
			if(!$success_aip_exp && $success_aip_file ) {
			$redlabel = 'red';
			 ?>
			<li><span style="color:red;">Expired</span></li>
			<?php }
			?>
			
			<?php 
				if( count($success_aip_exp) >= 1 && !empty($success_aip_exp) )
				$success_arr_rej = $success_aip_exp ;
				else if( count($success_aip_file) >= 1 && !empty($success_aip_file) )
				$success_arr_rej = $success_aip_file ;
				else
				$success_arr_rej = $vendor_autodata ;
//				echo "<pre>"; print_r($success_arr_rej); echo "</pre>";
				$success_aip_rej = '';
				for( $rej=0; $rej<count($success_arr_rej); $rej++ ){
						if( $success_arr_rej[$rej]->aip_status == '-1' ){
							$success_aip_rej[] = $success_arr_rej[$rej];
						}
				}
				
				if($success_aip_rej) {
				$redlabel = 'red';
				 ?>
			<li><span style="color:red;">Rejected By MyVC</span></li>
			<?php }
			?>
			
		<?php 
				$auto_main = '';
				$class_auto = '';
			  if($autodata->applies_to_any == 'any') { 
			  $any = 'checked="checked"';
			  $class_cert_1 = 'styled';
			  }
		      if($autodata->applies_to_owned == 'owned') {
			  $owned = 'checked="checked"';
			  $class_cert_2 = 'styled';
			  }
			  if ($autodata->applies_to_nonowned == 'nonowned') {
			  $nonowned = 'checked="checked"';
			  $class_cert_3 = 'styled';
			  }
			  if ($autodata->applies_to_hired == 'hired') {
			  $hired = 'checked="checked"';
			  $class_cert_4 = 'styled';
			  }
			  if ($autodata->applies_to_scheduled == 'scheduled') {
			  $scheduled = 'checked="checked"';
			  $class_cert_5 = 'styled';
			  }
		?>
	
<?php if($autodata->applies_to_any || $autodata->applies_to_owned || $autodata->applies_to_nonowned || $autodata->applies_to_hired || $autodata->applies_to_scheduled){ ?>		
<li>
		<table cellpadding="0" cellspacing="0"><tr><td><span style="display:block; margin-top:2px;">Applies To:&nbsp;&nbsp;</span></td>
		<?php } ?>
			<?php 
				if( count($success_aip_rej) >= 1 && !empty($success_aip_rej) )
				$success_arr_any = $success_aip_file ;
				else if( count($success_aip_exp) >= 1 && !empty($success_aip_exp) )
				$success_arr_any = $success_aip_exp ;
				else if( count($success_aip_file) >= 1 && !empty($success_aip_file) )
				$success_arr_any = $success_aip_file ;
				else
				$success_arr_any = $vendor_autodata ;
				
				$success_aip_any = '';
				for( $aa=0; $aa<count($success_arr_any); $aa++ ){
					if($autodata->applies_to_any == 'any'){
						if( $autodata->applies_to_any == $success_arr_any[$aa]->aip_applies_any ){
							$success_aip_any[] = $success_arr_any[$aa];
						}
					}
				}
				if($success_aip_any)
					$class_any = '';
				else
					$class_any = 'red';
					
				if( $class_any == 'red' && $autodata->applies_to_any == 'any' )
				$red_newlabel = 'red';	
					
			?>
		<?php if($autodata->applies_to_any == 'any') { ?>
		<td><input type="checkbox" name="applies_to_any" class="<?php echo $class_cert_1; ?>" value="any" <?php echo $any; ?>   /></td><td> <label><span style="color:<?php echo $class_any; ?>">Any&nbsp;</span> </label></td>
		<?php } ?>
		<?php
				if( count($success_aip_any) >= 1 && !empty($success_aip_any) )
				$success_arr_owned = $success_aip_any ;
				else if( count($success_aip_rej) >= 1 && !empty($success_aip_rej) )
				$success_arr_owned = $success_aip_file ;
				else if( count($success_aip_exp) >= 1 && !empty($success_aip_exp) )
				$success_arr_owned = $success_aip_exp ;
				else if( count($success_aip_file) >= 1 && !empty($success_aip_file) )
				$success_arr_owned = $success_aip_file ;
				else
				$success_arr_owned = $vendor_autodata ;
				
				$success_aip_owned = '';
				for( $own=0; $own<count($success_arr_owned); $own++ ){
					if($autodata->applies_to_owned == 'owned'){
						if( $autodata->applies_to_owned == $success_arr_owned[$own]->aip_applies_owned ){
							$success_aip_owned[] = $success_arr_owned[$own];
						}
					}
				}
				
				if($success_aip_owned)
					$class_own = '';
				else
					$class_own = 'red';
				
				if( $class_own == 'red' && $autodata->applies_to_owned)
				$red_newlabel = 'red';	
		?>
		<?php if($autodata->applies_to_owned) {?>
		<td><input type="checkbox" name="applies_to_owned" class="<?php echo $class_cert_2; ?>" value="owned" <?php echo $owned; ?> /></td><td><label><span style="color:<?php echo $class_own; ?>"> Owned&nbsp;</span></label></td>
		<?php } ?>
		<?php	
				if( count($success_aip_owned) >= 1 && !empty($success_aip_owned) )
				$success_arr_nonowned = $success_aip_owned ;
				else if( count($success_aip_any) >= 1 && !empty($success_aip_any) )
				$success_arr_nonowned = $success_aip_any ;
				else if( count($success_aip_rej) >= 1 && !empty($success_aip_rej) )
				$success_arr_nonowned = $success_aip_file ;
				else if( count($success_aip_exp) >= 1 && !empty($success_aip_exp) )
				$success_arr_nonowned = $success_aip_exp ;
				else if( count($success_aip_file) >= 1 && !empty($success_aip_file) )
				$success_arr_nonowned = $success_aip_file ;
				else
				$success_arr_nonowned = $vendor_autodata ;

				$success_aip_nonowned = '';
				for( $nown=0; $nown<count($success_arr_nonowned); $nown++ ){
					if($autodata->applies_to_nonowned == 'nonowned'){
						if( $autodata->applies_to_nonowned == $success_arr_nonowned[$nown]->aip_applies_nonowned ){
							$success_aip_nonowned[] = $success_arr_nonowned[$nown];
						}
					}
				}
				
				if($success_aip_nonowned)
					$class_nown = '';
				else
					$class_nown = 'red';
				
				if( $class_nown == 'red' && $autodata->applies_to_nonowned)
				$red_newlabel = 'red';	
					
		?>
		<?php if($autodata->applies_to_nonowned) { ?>		
		<td><input type="checkbox" name="applies_to_nonowned" class="<?php echo $class_cert_3; ?>" value="nonowned" <?php echo $nonowned; ?> /></td><td><label><span style="color:<?php echo $class_nown; ?>">Non-Owned&nbsp;</span></label></td>
		<?php } ?>
		<?php	if( count($success_aip_nonowned) >= 1 && !empty($success_aip_nonowned) )
				$success_arr_hired = $success_aip_nonowned ;
				else if( count($success_aip_owned) >= 1 && !empty($success_aip_owned) )
				$success_arr_hired = $success_aip_owned ;
				else if( count($success_aip_any) >= 1 && !empty($success_aip_any) )
				$success_arr_hired = $success_aip_any ;
				else if( count($success_aip_rej) >= 1 && !empty($success_aip_rej) )
				$success_arr_hired = $success_aip_file ;
				else if( count($success_aip_exp) >= 1 && !empty($success_aip_exp) )
				$success_arr_hired = $success_aip_exp ;
				else if( count($success_aip_file) >= 1 && !empty($success_aip_file) )
				$success_arr_hired = $success_aip_file ;
				else
				$success_arr_hired = $vendor_autodata ;
				
				$success_aip_hired = '';	
				for( $hir=0; $hir<count($success_arr_hired); $hir++ ){
					if($autodata->applies_to_hired == 'hired'){
						if( $autodata->applies_to_hired == $success_arr_hired[$hir]->aip_applies_hired ){
							$success_aip_hired[] = $success_arr_hired[$hir];
						}
					}
				}
				
				if($success_aip_hired)
					$class_hire = '';
				else
					$class_hire = 'red';
				
				if( $class_hire == 'red' && $autodata->applies_to_hired )
				$red_newlabel = 'red';		
					
		?>
		<?php if($autodata->applies_to_hired) { ?>		
		<td><input type="checkbox" name="applies_to_hired" class="<?php echo $class_cert_4; ?>" value="hired" <?php echo $hired; ?> /></td> <td><label><span style="color:<?php echo $class_hire; ?>">Hired&nbsp;</span></label></td>
		<?php } ?>
		<?php	
				if( count($success_aip_hired) >= 1 && !empty($success_aip_hired) )
				$success_arr_sch = $success_aip_hired ;
				else if( count($success_aip_nonowned) >= 1 && !empty($success_aip_nonowned) )
				$success_arr_sch = $success_aip_nonowned ;
				else if( count($success_aip_owned) >= 1 && !empty($success_aip_owned) )
				$success_arr_sch = $success_aip_owned ;
				else if( count($success_aip_any) >= 1 && !empty($success_aip_any) )
				$success_arr_sch = $success_aip_any ;
				else if( count($success_aip_rej) >= 1 && !empty($success_aip_rej) )
				$success_arr_sch = $success_aip_file ;
				else if( count($success_aip_exp) >= 1 && !empty($success_aip_exp) )
				$success_arr_sch = $success_aip_exp ;
				else if( count($success_aip_file) >= 1 && !empty($success_aip_file) )
				$success_arr_sch = $success_aip_file ;
				else
				$success_arr_sch = $vendor_autodata ;
				
				$success_aip_sch = '';
				for( $sch=0; $sch<count($success_arr_sch); $sch++ ){
					if($autodata->applies_to_scheduled == 'scheduled'){
						if( $success_arr_sch[$sch]->aip_applies_scheduled == 'sch' ){
							$success_aip_sch[] = $success_arr_sch[$sch];
						}
					}
				}
				
				if($success_aip_sch)
					$class_sch = '';
				else
					$class_sch = 'red';
				
				if( $class_sch == 'red' && $autodata->applies_to_scheduled )
				$red_newlabel = 'red';		
		?>
		<?php if($autodata->applies_to_scheduled) { ?>		
		<td><input type="checkbox" name="applies_to_scheduled" class="<?php echo $class_cert_5; ?>" value="scheduled" <?php echo $scheduled; ?> /></td><td> <label>
		<span style="color:<?php echo $class_sch; ?>">Scheduled</span></label></td>
		<?php } ?>
		<?php if($autodata->applies_to_any || $autodata->applies_to_owned || $autodata->applies_to_nonowned || $autodata->applies_to_hired || $autodata->applies_to_scheduled){ ?>		
</tr></table></li>
		<?php } ?>
		
		<?php	
				if( count($success_aip_sch) >= 1 && !empty($success_aip_sch) )
				$success_arr_com = $success_aip_sch ;
				else if( count($success_aip_hired) >= 1 && !empty($success_aip_hired) )
				$success_arr_com = $success_aip_hired ;
				else if( count($success_aip_nonowned) >= 1 && !empty($success_aip_nonowned) )
				$success_arr_com = $success_aip_nonowned ;
				else if( count($success_aip_owned) >= 1 && !empty($success_aip_owned) )
				$success_arr_com = $success_aip_owned ;
				else if( count($success_aip_any) >= 1 && !empty($success_aip_any) )
				$success_arr_com = $success_aip_any ;
				else if( count($success_aip_rej) >= 1 && !empty($success_aip_rej) )
				$success_arr_com = $success_aip_file ;
				else if( count($success_aip_exp) >= 1 && !empty($success_aip_exp) )
				$success_arr_com = $success_aip_exp ;
				else if( count($success_aip_file) >= 1 && !empty($success_aip_file) )
				$success_arr_com = $success_aip_file ;
				else
				$success_arr_com = $vendor_autodata ;
				
				$success_aip_com = '';
				for( $com=0; $com<count($success_arr_com); $com++ ){
					if( $autodata->combined_single <= $success_arr_com[$com]->aip_combined ){
							$success_aip_com[] = $success_arr_com[$com];
						}
				}
				
				if($success_aip_com)
					$class_com = '';
				else
					$class_com = 'red';
				
				if( $class_com == 'red' && $autodata->combined_single  && $autodata->combined_single != '0.00' )
				$red_newlabel = 'red';	
		?>
		
		<?php if($autodata->combined_single  && $autodata->combined_single != '0.00'){ ?>
		<li><span style="color:<?php echo $class_com; ?>">Combined Single Limit: <?php echo "$".number_format($autodata->combined_single,2); ?></span></li>
		<?php } ?>		
		<?php	
				if( count($success_aip_com) >= 1 && !empty($success_aip_com) )
				$success_arr_body = $success_aip_com ;
				else if( count($success_aip_sch) >= 1 && !empty($success_aip_sch) )
				$success_arr_body = $success_aip_sch ;
				else if( count($success_aip_hired) >= 1 && !empty($success_aip_hired) )
				$success_arr_body = $success_aip_hired ;
				else if( count($success_aip_nonowned) >= 1 && !empty($success_aip_nonowned) )
				$success_arr_body = $success_aip_nonowned ;
				else if( count($success_aip_owned) >= 1 && !empty($success_aip_owned) )
				$success_arr_body = $success_aip_owned ;
				else if( count($success_aip_any) >= 1 && !empty($success_aip_any) )
				$success_arr_body = $success_aip_any ;
				else if( count($success_aip_rej) >= 1 && !empty($success_aip_rej) )
				$success_arr_body = $success_aip_file ;
				else if( count($success_aip_exp) >= 1 && !empty($success_aip_exp) )
				$success_arr_body = $success_aip_exp ;
				else if( count($success_aip_file) >= 1 && !empty($success_aip_file) )
				$success_arr_body = $success_aip_file ;
				else
				$success_arr_body = $vendor_autodata ;
				
				$success_aip_bod = '';
				for( $bod=0; $bod<count($success_arr_body); $bod++ ){
					if( $autodata->bodily_injusy_person <= $success_arr_body[$bod]->aip_bodily ){
							$success_aip_bod[] = $success_arr_body[$bod];
						}
				}
				if($success_aip_bod)
					$class_bod = '';
				else
					$class_bod = 'red';
				
				if( $class_bod == 'red' && $autodata->bodily_injusy_person && $autodata->bodily_injusy_person != '0.00' )
				$red_newlabel = 'red';		
		?>
		<?php if($autodata->bodily_injusy_person && $autodata->bodily_injusy_person != '0.00'){ ?>
		<li><span style="color:<?php echo $class_bod; ?>">Bodily Injury - Per Person: <?php echo "$".number_format($autodata->bodily_injusy_person,2); ?></span></li>
		<?php } ?>	
		<?php	
				if( count($success_aip_bod) >= 1 && !empty($success_aip_bod) )
				$success_arr_acc = $success_aip_bod ;
				else if( count($success_aip_com) >= 1 && !empty($success_aip_com) )
				$success_arr_acc = $success_aip_com ;
				else if( count($success_aip_sch) >= 1 && !empty($success_aip_sch) )
				$success_arr_acc = $success_aip_sch ;
				else if( count($success_aip_hired) >= 1 && !empty($success_aip_hired) )
				$success_arr_acc = $success_aip_hired ;
				else if( count($success_aip_nonowned) >= 1 && !empty($success_aip_nonowned) )
				$success_arr_acc = $success_aip_nonowned ;
				else if( count($success_aip_owned) >= 1 && !empty($success_aip_owned) )
				$success_arr_acc = $success_aip_owned ;
				else if( count($success_aip_any) >= 1 && !empty($success_aip_any) )
				$success_arr_acc = $success_aip_any ;
				else if( count($success_aip_rej) >= 1 && !empty($success_aip_rej) )
				$success_arr_acc = $success_aip_file ;
				else if( count($success_aip_exp) >= 1 && !empty($success_aip_exp) )
				$success_arr_acc = $success_aip_exp ;
				else if( count($success_aip_file) >= 1 && !empty($success_aip_file) )
				$success_arr_acc = $success_aip_file ;
				else
				$success_arr_acc = $vendor_autodata ;
				
				$success_aip_acc = '';
				for( $acc=0; $acc<count($success_arr_acc); $acc++ ){
					if( $autodata->bodily_injusy_accident <= $success_arr_acc[$acc]->aip_body_injury ){
							$success_aip_acc[] = $success_arr_acc[$acc];
						}
				}
				if($success_aip_acc)
					$class_acc = '';
				else
					$class_acc = 'red';
				
				if( $class_acc == 'red' && $autodata->bodily_injusy_accident && $autodata->bodily_injusy_accident != '0.00' )
				$red_newlabel = 'red';	
		?>	
		<?php if($autodata->bodily_injusy_accident && $autodata->bodily_injusy_accident != '0.00'){ ?>
		<li><span style="color:<?php echo $class_acc; ?>">Bodily Injury - Per Accident: <?php echo "$".number_format($autodata->bodily_injusy_accident,2); ?></span></li>
		<?php } ?>
		<?php	
				if( count($success_aip_acc) >= 1 && !empty($success_aip_acc) )
				$success_arr_pro = $success_aip_acc ;
				else if( count($success_aip_bod) >= 1 && !empty($success_aip_bod) )
				$success_arr_pro = $success_aip_bod ;
				else if( count($success_aip_com) >= 1 && !empty($success_aip_com) )
				$success_arr_pro = $success_aip_com ;
				else if( count($success_aip_sch) >= 1 && !empty($success_aip_sch) )
				$success_arr_pro = $success_aip_sch ;
				else if( count($success_aip_hired) >= 1 && !empty($success_aip_hired) )
				$success_arr_pro = $success_aip_hired ;
				else if( count($success_aip_nonowned) >= 1 && !empty($success_aip_nonowned) )
				$success_arr_pro = $success_aip_nonowned ;
				else if( count($success_aip_owned) >= 1 && !empty($success_aip_owned) )
				$success_arr_pro = $success_aip_owned ;
				else if( count($success_aip_any) >= 1 && !empty($success_aip_any) )
				$success_arr_pro = $success_aip_any ;
				else if( count($success_aip_rej) >= 1 && !empty($success_aip_rej) )
				$success_arr_pro = $success_aip_file ;
				else if( count($success_aip_exp) >= 1 && !empty($success_aip_exp) )
				$success_arr_pro = $success_aip_exp ;
				else if( count($success_aip_file) >= 1 && !empty($success_aip_file) )
				$success_arr_pro = $success_aip_file ;
				else
				$success_arr_pro = $vendor_autodata ;
				
				$success_aip_pro = '';
				for( $pro=0; $pro<count($success_arr_pro); $pro++ ){
					if( $autodata->property_damage <= $success_arr_pro[$pro]->aip_property ){
							$success_aip_pro[] = $success_arr_pro[$pro];
						}
				}
				if($success_aip_pro)
					$class_pro = '';
				else
					$class_pro = 'red';
				
				if( $class_pro == 'red' && $autodata->property_damage && $autodata->property_damage != '0.00' )
				$red_newlabel = 'red';		
		?>			
		<?php if($autodata->property_damage && $autodata->property_damage != '0.00'){ ?>
		<li><span style="color:<?php echo $class_pro; ?>">Property Damage - Per Accident: <?php echo "$".number_format($autodata->property_damage,2); ?></span></li>
		<?php } ?>
		<?php	
				if( count($success_aip_pro) >= 1 && !empty($success_aip_pro) )
				$success_arr_waiver = $success_aip_pro ;
				else if( count($success_aip_acc) >= 1 && !empty($success_aip_acc) )
				$success_arr_waiver = $success_aip_acc ;
				else if( count($success_aip_bod) >= 1 && !empty($success_aip_bod) )
				$success_arr_waiver = $success_aip_bod ;
				else if( count($success_aip_com) >= 1 && !empty($success_aip_com) )
				$success_arr_waiver = $success_aip_com ;
				else if( count($success_aip_sch) >= 1 && !empty($success_aip_sch) )
				$success_arr_waiver = $success_aip_sch ;
				else if( count($success_aip_hired) >= 1 && !empty($success_aip_hired) )
				$success_arr_waiver = $success_aip_hired ;
				else if( count($success_aip_nonowned) >= 1 && !empty($success_aip_nonowned) )
				$success_arr_waiver = $success_aip_nonowned ;
				else if( count($success_aip_owned) >= 1 && !empty($success_aip_owned) )
				$success_arr_waiver = $success_aip_owned ;
				else if( count($success_aip_any) >= 1 && !empty($success_aip_any) )
				$success_arr_waiver = $success_aip_any ;
				else if( count($success_aip_rej) >= 1 && !empty($success_aip_rej) )
				$success_arr_waiver = $success_aip_file ;
				else if( count($success_aip_exp) >= 1 && !empty($success_aip_exp) )
				$success_arr_waiver = $success_aip_exp ;
				else if( count($success_aip_file) >= 1 && !empty($success_aip_file) )
				$success_arr_waiver = $success_aip_file ;
				else
				$success_arr_waiver = $vendor_autodata ;

				$success_aip_wai = '';
				for( $wai=0; $wai<count($success_arr_waiver); $wai++ ){
					if( $autodata->waiver == 'yes' ){	
						if( $success_arr_waiver[$wai]->aip_waiver == 'waiver' ){
							$success_aip_wai[] = $success_arr_waiver[$wai];
						}
					}	
				}
				if($success_aip_wai)
					$class_wai = '';
				else
					$class_wai = 'red';
				
				if( $class_wai == 'red' && $autodata->waiver == 'yes' )
				$red_newlabel = 'red';	
		?>		
		<?php if($autodata->waiver){ ?>
		<?php if($autodata->waiver == 'yes'){ $waiv = 'checked="checked"'; $class_waiver = 'styled'; }?>
		<li><input type="checkbox" value="yes" name="waiver" <?php echo $waiv; ?> class="<?php echo $class_waiver; ?>" /> <label><span style="color:<?php echo $class_wai; ?>">Waiver of Subrogation</span></label></li>
		<?php } ?>
		<?php	
				if( count($success_aip_wai) >= 1 && !empty($success_aip_wai) )
				$success_arr_primary = $success_aip_wai ;
				else if( count($success_aip_pro) >= 1 && !empty($success_aip_pro) )
				$success_arr_primary = $success_aip_pro ;
				else if( count($success_aip_acc) >= 1 && !empty($success_aip_acc) )
				$success_arr_primary = $success_aip_acc ;
				else if( count($success_aip_bod) >= 1 && !empty($success_aip_bod) )
				$success_arr_primary = $success_aip_bod ;
				else if( count($success_aip_com) >= 1 && !empty($success_aip_com) )
				$success_arr_primary = $success_aip_com ;
				else if( count($success_aip_sch) >= 1 && !empty($success_aip_sch) )
				$success_arr_primary = $success_aip_sch ;
				else if( count($success_aip_hired) >= 1 && !empty($success_aip_hired) )
				$success_arr_primary = $success_aip_hired ;
				else if( count($success_aip_nonowned) >= 1 && !empty($success_aip_nonowned) )
				$success_arr_primary = $success_aip_nonowned ;
				else if( count($success_aip_owned) >= 1 && !empty($success_aip_owned) )
				$success_arr_primary = $success_aip_owned ;
				else if( count($success_aip_any) >= 1 && !empty($success_aip_any) )
				$success_arr_primary = $success_aip_any ;
				else if( count($success_aip_rej) >= 1 && !empty($success_aip_rej) )
				$success_arr_primary = $success_aip_file ;
				else if( count($success_aip_exp) >= 1 && !empty($success_aip_exp) )
				$success_arr_primary = $success_aip_exp ;
				else if( count($success_aip_file) >= 1 && !empty($success_aip_file) )
				$success_arr_primary = $success_aip_file ;
				else
				$success_arr_primary = $vendor_autodata ;
				
				$success_aip_pri = '';
				for( $pri=0; $pri<count($success_arr_primary); $pri++ ){
					if( $autodata->primary == 'yes' ){	
						if( $success_arr_primary[$pri]->aip_primary == 'primary' ){
							$success_aip_pri[] = $success_arr_primary[$pri];
						}
					}	
				}
				if($success_aip_pri)
					$class_pri = '';
				else
					$class_pri = 'red';
				
				if( $class_pri == 'red' && $autodata->primary == 'yes' )
				$red_newlabel = 'red';	
		?>		
		<?php if($autodata->primary){ ?>
		<?php if($autodata->primary == 'yes'){ $prim = 'checked="checked"'; $class_primary = 'styled';} ?>
		<li><input type="checkbox" value="yes" name="primary" <?php echo $prim; ?>  class="<?php echo $class_primary; ?>" /><label> <span style="color:<?php echo $class_pri; ?>">Primary Non-Contributory</span></label></li>
		<?php } ?>
		<?php	
				if( count($success_aip_pri) >= 1 && !empty($success_aip_pri) )
				$success_arr_addi = $success_aip_pri ;
				else if( count($success_aip_wai) >= 1 && !empty($success_aip_wai) )
				$success_arr_addi = $success_aip_wai ;
				else if( count($success_aip_pro) >= 1 && !empty($success_aip_pro) )
				$success_arr_addi = $success_aip_pro ;
				else if( count($success_aip_acc) >= 1 && !empty($success_aip_acc) )
				$success_arr_addi = $success_aip_acc ;
				else if( count($success_aip_bod) >= 1 && !empty($success_aip_bod) )
				$success_arr_addi = $success_aip_bod ;
				else if( count($success_aip_com) >= 1 && !empty($success_aip_com) )
				$success_arr_addi = $success_aip_com ;
				else if( count($success_aip_sch) >= 1 && !empty($success_aip_sch) )
				$success_arr_addi = $success_aip_sch ;
				else if( count($success_aip_hired) >= 1 && !empty($success_aip_hired) )
				$success_arr_addi = $success_aip_hired ;
				else if( count($success_aip_nonowned) >= 1 && !empty($success_aip_nonowned) )
				$success_arr_addi = $success_aip_nonowned ;
				else if( count($success_aip_owned) >= 1 && !empty($success_aip_owned) )
				$success_arr_addi = $success_aip_owned ;
				else if( count($success_aip_any) >= 1 && !empty($success_aip_any) )
				$success_arr_addi = $success_aip_any ;
				else if( count($success_aip_rej) >= 1 && !empty($success_aip_rej) )
				$success_arr_addi = $success_aip_file ;
				else if( count($success_aip_exp) >= 1 && !empty($success_aip_exp) )
				$success_arr_addi = $success_aip_exp ;
				else if( count($success_aip_file) >= 1 && !empty($success_aip_file) )
				$success_arr_addi = $success_aip_file ;
				else
				$success_arr_addi = $vendor_autodata ;
				
				$success_aip_addi = '';
				for( $add=0; $add<count($success_arr_addi); $add++ ){
					if( $autodata->additional_ins == 'yes' ){	
						if( $success_arr_addi[$add]->aip_addition ){
							$success_aip_addi[] = $success_arr_addi[$add];
						}
					}	
				}
				if($success_aip_addi)
					$class_addi = '';
				else
					$class_addi = 'red';
				
				if( $class_addi == 'red' && $autodata->additional_ins == 'yes' )
				$red_newlabel = 'red';		
		?>
		<?php if($autodata->additional_ins){ ?>
		<?php if($autodata->additional_ins == 'yes'){ $add = 'checked="checked"'; $class_additional_ins = 'styled';} ?>
		<li><input type="checkbox" value="yes" name="additional_ins" <?php echo $add; ?> class="<?php echo $class_additional_ins; ?>" /> <label><span style="color:<?php echo $class_addi; ?>">List my Company as as "Additional Insured"</span></label></li>
		<?php } ?>
		<?php	
				if( count($success_aip_addi) >= 1 && !empty($success_aip_addi) )
				$success_arr_cert = $success_aip_addi ;
				else if( count($success_aip_pri) >= 1 && !empty($success_aip_pri) )
				$success_arr_cert = $success_aip_pri ;
				else if( count($success_aip_wai) >= 1 && !empty($success_aip_wai) )
				$success_arr_cert = $success_aip_wai ;
				else if( count($success_aip_pro) >= 1 && !empty($success_aip_pro) )
				$success_arr_cert = $success_aip_pro ;
				else if( count($success_aip_acc) >= 1 && !empty($success_aip_acc) )
				$success_arr_cert = $success_aip_acc ;
				else if( count($success_aip_bod) >= 1 && !empty($success_aip_bod) )
				$success_arr_cert = $success_aip_bod ;
				else if( count($success_aip_com) >= 1 && !empty($success_aip_com) )
				$success_arr_cert = $success_aip_com ;
				else if( count($success_aip_sch) >= 1 && !empty($success_aip_sch) )
				$success_arr_cert = $success_aip_sch ;
				else if( count($success_aip_hired) >= 1 && !empty($success_aip_hired) )
				$success_arr_cert = $success_aip_hired ;
				else if( count($success_aip_nonowned) >= 1 && !empty($success_aip_nonowned) )
				$success_arr_cert = $success_aip_nonowned ;
				else if( count($success_aip_owned) >= 1 && !empty($success_aip_owned) )
				$success_arr_cert = $success_aip_owned ;
				else if( count($success_aip_any) >= 1 && !empty($success_aip_any) )
				$success_arr_cert = $success_aip_any ;
				else if( count($success_aip_rej) >= 1 && !empty($success_aip_rej) )
				$success_arr_cert = $success_aip_file ;
				else if( count($success_aip_exp) >= 1 && !empty($success_aip_exp) )
				$success_arr_cert = $success_aip_exp ;
				else if( count($success_aip_file) >= 1 && !empty($success_aip_file) )
				$success_arr_cert = $success_aip_file ;
				else
				$success_arr_cert = $vendor_autodata ;

				$success_aip_cert = '';
				for( $cert=0; $cert<count($success_arr_cert); $cert++ ){
					if( $autodata->cert_holder == 'yes' ){	
						if( $success_arr_cert[$cert]->aip_cert == 'yes' ){
							$success_aip_cert[] = $success_arr_cert[$cert];
						}
					}	
				}
				if($success_aip_cert)
					$class_cert = '';
				else
					$class_cert = 'red';
				
				if( $class_cert == 'red' && $autodata->cert_holder == 'yes' )
				$red_newlabel = 'red';		
		?>
		<?php if($autodata->cert_holder){ ?>
		<?php if($autodata->cert_holder == 'yes'){ $cert = 'checked="checked"'; $class_cert_holder2 = 'styled';} ?>
		<li><input type="checkbox" value="yes" name="cert_holder" <?php echo $cert; ?> class="<?php echo $class_cert_holder2; ?>"  /> <label><span style="color:<?php echo $class_cert; ?>">MyVendorCenter listed as Cert. Holder</span></label></li>
		<?php } ?>
		</ul>
	
	</td></tr>
	<?php } ?>
	<tr id="autoliability_sub"></tr>
	<?php
		if($workdata){ $work_main = 'checked="checked"'; $class_work="styled active";
	?>
	
	<tr><td width="10">
	<input type="checkbox" value="yes" id="workersliability" class="<?php echo $class_work; ?>" name="workersliability" <?php echo $work_main; ?> /></td><td><strong><label style="display:block; padding-top:3px;">Worker`s Comp Policy/Employer`s Liability</label></strong></td></tr>
	<?php } ?>
	<tr><td width="10"></td><td>
	<?php if($workdata){  ?>
	<ul class="pre_workers">
	<?php
			$success_wci_file = '';
			for( $file=0; $file<count($vendor_workdata); $file++ ){
							if($vendor_workdata[$file]->WCI_upld_cert){
							$success_wci_file[] = $vendor_workdata[$file];
						}
					}
			if(!$success_wci_file) {
			$redlabel = 'red';
			 ?>
			<li><span style="color:red;">No Certificate Uploaded</span></li>
			<?php }
			?>
			<?php 
				if( count($success_wci_file) >= 1 && !empty($success_wci_file) )
				$success_arr_exp = $success_wci_file ;
				else
				$success_arr_exp = $vendor_workdata ;
				$success_wci_exp = '';
				
			for( $exp=0; $exp<count($success_arr_exp); $exp++ ){
				if( $success_arr_exp[$exp]->WCI_end_date >= date('Y-m-d') || $success_arr_exp[$exp]->WCI_end_date == 'Does Not Expire' ){
					$success_wci_exp[] = $success_arr_exp[$exp];
				}
			}
			if(!$success_wci_exp && $success_wci_file ) { 
			$redlabel = 'red';
			?>
			<li><span style="color:red;">Expired</span></li>
			<?php }
			?>
			
			<?php 
				if( count($success_wci_exp) >= 1 && !empty($success_wci_exp) )
				$success_arr_rej = $success_wci_exp ;
				else if( count($success_wci_file) >= 1 && !empty($success_wci_file) )
				$success_arr_rej = $success_wci_file ;
				else
				$success_arr_rej = $vendor_workdata ;
				
				$success_wci_rej = '';
				
			for( $rej=0; $rej<count($success_arr_rej); $rej++ ){
				if( $success_arr_rej[$rej]->WCI_status == '-1' ){
					$success_wci_rej[] = $success_arr_rej[$rej];
				}
			}
			if($success_wci_rej) {
			$redlabel = 'red';
			 ?>
			<li><span style="color:red;">Rejected By MyVC</span></li>
			<?php }
			?>
			
		<?php 
		$work_main = '';
		$class_work = '';
		if($workdata->workers_not == 'not') {
		$not = 'checked="checked"';
		if($workdata->workers_not){ ?>
		<li><input type="radio" id="workers_not" <?php echo $not; ?> style="vertical-align:top;"  /> Worker`s Comp Exemptions NOT accepted</li>
		<?php } ?>	
		<li><ul class="notaccepted" style="list-style-type:none;"><li>
		
			<?php
				if( count($success_wci_rej) >= 1 && !empty($success_wci_rej) )
				$success_arr_eachacc = $success_wci_rej ;
				else if( count($success_wci_exp) >= 1 && !empty($success_wci_exp) )
				$success_arr_eachacc = $success_wci_exp ;
				else if( count($success_wci_file) >= 1 && !empty($success_wci_file) )
				$success_arr_eachacc = $success_wci_file ;
				else
				$success_arr_eachacc = $vendor_workdata ;
				
				for( $ea=0; $ea<count($success_arr_eachacc); $ea++ ){
					if( $workdata->each_accident <= $success_arr_eachacc[$ea]->WCI_each_accident ){
							$success_wci_each[] = $success_arr_eachacc[$ea];
						}
				}
				if($success_wci_each)
					$class_each = '';
				else
					$class_each = 'red';
				
				if( $class_each == 'red' && $workdata->each_accident && $workdata->each_accident !='0.00' )
				$red_newlabel = 'red';	
			?>	
		<?php if($workdata->each_accident && $workdata->each_accident !='0.00' ){ ?>
		<li><span style="color:<?php echo $class_each; ?>">Each Accident: <?php echo "$".number_format($workdata->each_accident,2); ?></span></li>
		<?php } ?>	
			<?php
				if( count($success_wci_each) >= 1 && !empty($success_wci_each) )
				$success_arr_desc = $success_wci_each ;
				else if( count($success_wci_rej) >= 1 && !empty($success_wci_rej) )
				$success_arr_desc = $success_wci_rej ;
				else if( count($success_wci_exp) >= 1 && !empty($success_wci_exp) )
				$success_arr_desc = $success_wci_exp ;
				else if( count($success_wci_file) >= 1 && !empty($success_wci_file) )
				$success_arr_desc = $success_wci_file ;
				else
				$success_arr_desc = $vendor_workdata ;
				$success_wci_des = '';
				for( $des=0; $des<count($success_arr_desc); $des++ ){
					if( $workdata->disease_policy <= $success_arr_desc[$des]->WCI_disease_policy ){
							$success_wci_des[] = $success_arr_desc[$des];
						}
				}
				if($success_wci_des)
					$class_des = '';
				else
					$class_des = 'red';
				
				if( $class_des == 'red' && $workdata->disease_policy && $workdata->disease_policy !='0.00' )
				$red_newlabel = 'red';	
			?>	
		<?php if($workdata->disease_policy && $workdata->disease_policy !='0.00' ){ ?>
		<li><span style="color:<?php echo $class_des; ?>">Disease - Policy Limit: <?php echo "$".number_format($workdata->disease_policy,2); ?></span></li>
		<?php } ?>	
		<?php
				if( count($success_wci_des) >= 1 && !empty($success_wci_des) )
				$success_arr_emp = $success_wci_des ;
				else if( count($success_wci_each) >= 1 && !empty($success_wci_each) )
				$success_arr_emp = $success_wci_each ;
				else if( count($success_wci_rej) >= 1 && !empty($success_wci_rej) )
				$success_arr_emp = $success_wci_rej ;
				else if( count($success_wci_exp) >= 1 && !empty($success_wci_exp) )
				$success_arr_emp = $success_wci_exp ;
				else if( count($success_wci_file) >= 1 && !empty($success_wci_file) )
				$success_arr_emp = $success_wci_file ;
				else
				$success_arr_emp = $vendor_workdata ;
				
				$success_wci_emp = '';
				for( $emp=0; $emp<count($success_arr_emp); $emp++ ){
					if( $workdata->disease_eachemp <= $success_arr_emp[$emp]->WCI_disease ){
							$success_wci_emp[] = $success_arr_emp[$emp];
						}
				}
				if($success_wci_emp)
					$class_emp = '';
				else
					$class_emp = 'red';
				
				if( $class_emp == 'red' && $workdata->disease_eachemp && $workdata->disease_eachemp !='0.00' )
				$red_newlabel = 'red';		
			?>		
		<?php if($workdata->disease_eachemp && $workdata->disease_eachemp !='0.00' ){ ?>
		<li><span style="color:<?php echo $class_emp; ?>">Disease - Each Employee: <?php echo "$".number_format($workdata->disease_eachemp,2); ?></span></li>
		<?php } ?>
		<?php
				if( count($success_wci_emp) >= 1 && !empty($success_wci_emp) )
				$success_arr_waiver = $success_wci_emp ;
				else if( count($success_wci_des) >= 1 && !empty($success_wci_des) )
				$success_arr_waiver = $success_wci_des ;
				else if( count($success_wci_each) >= 1 && !empty($success_wci_each) )
				$success_arr_waiver = $success_wci_each ;
				else if( count($success_wci_rej) >= 1 && !empty($success_wci_rej) )
				$success_arr_waiver = $success_wci_rej ;
				else if( count($success_wci_exp) >= 1 && !empty($success_wci_exp) )
				$success_arr_waiver = $success_wci_exp ;
				else if( count($success_wci_file) >= 1 && !empty($success_wci_file) )
				$success_arr_waiver = $success_wci_file ;
				else
				$success_arr_waiver = $vendor_workdata ;
				
				$success_wci_waiv = '';
				for( $waiv=0; $waiv<count($success_arr_waiver); $waiv++ ){
					if($workdata->waiver_work == 'yes'){
						if( $success_arr_waiver[$waiv]->WCI_waiver == 'waiver' ){
								$success_wci_waiv[] = $success_arr_waiver[$waiv];
							}
					}	
				}
				if($success_wci_waiv)
					$class_waiv = '';
				else
					$class_waiv = 'red';
				
				if( $class_waiv == 'red' && $workdata->waiver_work == 'yes' )
				$red_newlabel = 'red';	
			?>
		<?php if($workdata->waiver_work){ ?>
		<?php if($workdata->waiver_work == 'yes'){ $waiver_work = 'checked="checked"'; $class_waiver_work = 'styled';}?>
		<li><input type="checkbox" value="yes" name="waiver_work" <?php echo $waiver_work; ?> class="<?php echo $class_waiver_work; ?>" /> <label><span style="color:<?php echo $class_waiv; ?>">Waiver of Subrogation</span></label></li>
		<?php } ?>
		<?php
				if( count($success_wci_waiv) >= 1 && !empty($success_wci_waiv) )
				$success_arr_cert = $success_wci_waiv ;
				else if( count($success_wci_emp) >= 1 && !empty($success_wci_emp) )
				$success_arr_cert = $success_wci_emp ;
				else if( count($success_wci_des) >= 1 && !empty($success_wci_des) )
				$success_arr_cert = $success_wci_des ;
				else if( count($success_wci_each) >= 1 && !empty($success_wci_each) )
				$success_arr_cert = $success_wci_each ;
				else if( count($success_wci_rej) >= 1 && !empty($success_wci_rej) )
				$success_arr_cert = $success_wci_rej ;
				else if( count($success_wci_exp) >= 1 && !empty($success_wci_exp) )
				$success_arr_cert = $success_wci_exp ;
				else if( count($success_wci_file) >= 1 && !empty($success_wci_file) )
				$success_arr_cert = $success_wci_file ;
				else
				$success_arr_cert = $vendor_workdata ;
				
				$success_wci_cert = '';
				for( $cer=0; $cer<count($success_arr_cert); $cer++ ){
					if($workdata->certholder_work == 'yes'){
						if( $success_arr_cert[$cer]->WCI_cert == 'yes' ){
								$success_wci_cert[] = $success_arr_cert[$cer];
							}
					}	
				}
				if($success_wci_cert)
					$class_cert = '';
				else
					$class_cert = 'red';
				
				if( $class_cert == 'red' && $workdata->certholder_work == 'yes' )
				$red_newlabel = 'red';	
			?>
		<?php if($workdata->certholder_work){ ?>
		<?php if($workdata->certholder_work == 'yes'){ $certholder_work = 'checked="checked"'; $class_certholder_work = 'styled';} ?>
		<li><input type="checkbox" value="yes" name="certholder_work" <?php echo $certholder_work; ?> class="<?php echo $class_certholder_work; ?>" /> <label><span style="color:<?php echo $class_cert; ?>">MyVendorCenter listed as Cert. Holder</label></li>
		</li></ul></li>
		<?php } ?>
		<?php 
		}
		else if($workdata->workers_not == 'yes'){ 
		$workers_accepted = 'checked="checked"';
		?>
		<li><input type="radio" id="workers_yes" name="workers_not" value="yes" <?php echo $workers_accepted; ?> style="vertical-align:top;" /> Worker`s Comp Exemptions accepted
		<br />WARNING: Worker`s Comp. Exemption Certificates are commonly mistaken for a Worker`s Comp policy. Please be aware that this "exemption" does NOT offer the property manager/association/building owner any form of protection against liability for an injured worker`s loss of wages and/or medical expenses if an on-the-job injury occurs. Consult your legal advisor for your unique situation, as laws vary by jurisdiction.
		</li>
		<?php } ?>
		</ul>
	
	</td></tr>
	<?php } ?>
	<tr id="workersliability_sub"></tr>
	<?php
		if($umbrelladata){ $umb_main = 'checked="checked"'; $class_umb = 'styled active';  
	?>
	
	<tr><td width="10">
	<input type="checkbox" value="yes" id="umbrellaliability" class="<?php echo $class_umb; ?>" name="umbrellaliability" <?php echo $umb_main; ?> /></td><td><strong><label style="display:block; padding-top:3px;">Umbrella Liability</label></strong></td></tr>
	<?php } ?>
	<?php if($umbrelladata){ ?>
	<tr><td></td><td>
	<ul class="pre_umbrella">
	<?php
			$success_umb_file = '';
			for( $file=0; $file<count($vendor_umbrelladata); $file++ ){
							if($vendor_umbrelladata[$file]->UMB_upld_cert){
							$success_umb_file[] = $vendor_umbrelladata[$file];
						}
					}
			if(!$success_umb_file) {
			$redlabel = 'red'; 
			?>
			<li><span style="color:red;">No Certificate Uploaded</span></li>
			<?php }
			?>
			
			<?php 
				if( count($success_umb_file) >= 1 && !empty($success_umb_file) )
				$success_arr_exp = $success_umb_file ;
				else
				$success_arr_exp = $vendor_umbrelladata ;
				$success_umb_exp = '';
				
			for( $exp=0; $exp<count($success_arr_exp); $exp++ ){
				if( $success_arr_exp[$exp]->UMB_expdate >= date('Y-m-d') ){
					$success_umb_exp[] = $success_arr_exp[$exp];
				}
			}
			if(!$success_umb_exp && $success_umb_file ) {
			$redlabel = 'red';
			 ?>
			<li><span style="color:red;">Expired</span></li>
			<?php }
			?>
			
			<?php 
				if( count($success_umb_exp) >= 1 && !empty($success_umb_exp) )
				$success_arr_rej = $success_umb_exp ;
				else if( count($success_umb_file) >= 1 && !empty($success_umb_file) )
				$success_arr_rej = $success_umb_file ;
				else
				$success_arr_rej = $vendor_umbrelladata ;
				$success_umb_rej = '';
				
			for( $rej=0; $rej<count($success_arr_rej); $rej++ ){
				if( $success_arr_rej[$rej]->UMB_status == '-1' ){
					$success_umb_rej[] = $success_arr_rej[$rej];
				}
			}
			if($success_umb_rej) {
			$redlabel = 'red';
			?>
			<li><span style="color:red;">Rejected By MyVC</span></li>
			<?php }
			?>
			
		<?php
				if( count($success_umb_rej) >= 1 && !empty($success_umb_rej) )
				$success_arr_rej = $success_umb_rej ;	
				else if( count($success_umb_exp) >= 1 && !empty($success_umb_exp) )
				$success_arr_rej = $success_umb_exp ;
				else if( count($success_umb_file) >= 1 && !empty($success_umb_file) )
				$success_arr_rej = $success_umb_file ;
				else
				$success_arr_rej = $vendor_umbrelladata ;
				
				$success_umb_each = '';	
				
				for( $each=0; $each<count($success_arr_rej); $each++ ){
						if( $umbrelladata->each_occur <= $success_arr_rej[$each]->UMB_occur ){
								$success_umb_each[] = $success_arr_rej[$each];
							}
				}
				if($success_umb_each)
					$class_each = '';
				else
					$class_each = 'red';
				
				if( $class_each == 'red' && $umbrelladata->each_occur && $umbrelladata->each_occur !='0.00' )
				$red_newlabel = 'red';	
			?>
			
		<?php 
		$umb_main = '';
		$class_umb = '';
		if($umbrelladata->each_occur && $umbrelladata->each_occur !='0.00' ){ ?>
		<li><span style="color:<?php echo $class_each; ?>">Each Occurrence: <?php echo "$".number_format($umbrelladata->each_occur,2); ?></span></li>
		<?php } ?>		
		<?php
				if( count($success_umb_each) >= 1 && !empty($success_umb_each) )
				$success_arr_agg = $success_umb_each ;
				else if( count($success_umb_rej) >= 1 && !empty($success_umb_rej) )
				$success_arr_agg = $success_umb_rej ;	
				else if( count($success_umb_exp) >= 1 && !empty($success_umb_exp) )
				$success_arr_agg = $success_umb_exp ;
				else if( count($success_umb_file) >= 1 && !empty($success_umb_file) )
				$success_arr_agg = $success_umb_file ;
				else 
				$success_arr_agg = $vendor_umbrelladata ;
				$success_umb_agg = '';
				for( $agg=0; $agg<count($success_arr_agg); $agg++ ){
						if( $umbrelladata->aggregate <= $success_arr_agg[$agg]->UMB_aggregate ){
								$success_umb_agg[] = $success_arr_agg[$agg];
							}
				}
				if($success_umb_agg)
					$class_agg = '';
				else
					$class_agg = 'red';
				
				if( $class_agg == 'red' && $umbrelladata->aggregate && $umbrelladata->aggregate !='0.00' )
				$red_newlabel = 'red';	
				
			?>
		<?php if($umbrelladata->aggregate && $umbrelladata->aggregate !='0.00' ){ ?>
		<li><span style="color:<?php echo $class_agg; ?>">Aggregate: <?php echo "$".number_format($umbrelladata->aggregate,2); ?></span></li>
		<?php } ?>
		<?php
				if( count($success_umb_agg) >= 1 && !empty($success_umb_agg) )
				$success_arr_cert = $success_umb_agg ;
				else if( count($success_umb_each) >= 1 && !empty($success_umb_each) )
				$success_arr_cert = $success_umb_each ;
				else if( count($success_umb_rej) >= 1 && !empty($success_umb_rej) )
				$success_arr_cert = $success_umb_rej ;	
				else if( count($success_umb_exp) >= 1 && !empty($success_umb_exp) )
				$success_arr_cert = $success_umb_exp ;
				else if( count($success_umb_file) >= 1 && !empty($success_umb_file) )
				$success_arr_cert = $success_umb_file ;
				else 
				$success_arr_cert = $vendor_umbrelladata ;
				
				$success_umb_cert = '';	
				for( $cert=0; $cert<count($success_arr_cert); $cert++ ){
						if( $umbrelladata->certholder_umbrella == 'yes' ) {
							if( $success_arr_cert[$cert]->UMB_certholder == 'yes' ){
									$success_umb_cert[] = $success_arr_cert[$cert];
								}
						}	
				}
				if($success_umb_cert)
					$class_cert_umb = '';
				else
					$class_cert_umb = 'red';
				
				if( $class_cert_umb == 'red' && $umbrelladata->certholder_umbrella == 'yes' )
				$red_newlabel = 'red';	
			?>	
		<?php if($umbrelladata->certholder_umbrella){ ?>
		<?php if($umbrelladata->certholder_umbrella == 'yes'){ $waiver_umbrella = 'checked="checked"'; $class_certholder_umbrella = 'styled'; }?>
		<li><input type="checkbox" value="yes" name="certholder_umbrella" <?php echo $waiver_umbrella; ?> class="<?php echo $class_certholder_umbrella; ?>" /> <label><span style="color:<?php echo $class_cert_umb; ?>">MyVendorCenter listed as Cert. Holder</span></label></li>
		<?php } ?>	
		<?php 
//	$success_umb_agg = '';
//	$success_umb_each = '';
//	$success_arr_cert = '';
//	count($success_umb_agg) = '';
	?>
		</ul>
	</td></tr>
		<?php } ?>	
	<tr id="umbrellaliability_sub"></tr>
	
	<?php
		if($omidata){ $omi_main = 'checked="checked"'; $class_omi = 'styled active';  
	?>
	<tr><td width="10">
	<input type="checkbox" value="yes" id="errorsomissions" class="<?php echo $class_omi; ?>" name="errorsomissions" <?php echo $omi_main; ?> /></td><td><strong><label style="display:block; padding-top:3px;">Errors & Omissions</label></strong></td></tr>
	<?php } ?>
	<?php if($omidata){ ?>
	<tr><td></td><td>
	<ul class="pre_omi">
	<?php
			$success_omi_file = '';
			for( $file=0; $file<count($vendor_omidata); $file++ ){
							if($vendor_omidata[$file]->OMI_upld_cert){
							$success_omi_file[] = $vendor_omidata[$file];
						}
					}
			if(!$success_omi_file) {
			$redlabel = 'red';
			 ?>
			<li><span style="color:red;">No Certificate Uploaded</span></li>
			<?php }
			?>

			<?php 
				if( count($success_omi_file) >= 1 && !empty($success_omi_file) )
				$success_arr_exp = $success_omi_file ;
				else
				$success_arr_exp = $vendor_omidata ;
				$success_omi_exp = '';
				
			for( $exp=0; $exp<count($success_arr_exp); $exp++ ){
				if( $success_arr_exp[$exp]->OMI_end_date >= date('Y-m-d') ){
					$success_omi_exp[] = $success_arr_exp[$exp];
				}
			}
			if(!$success_omi_exp && $success_omi_file ) {
			$redlabel = 'red';
			 ?>
			<li><span style="color:red;">Expired</span></li>
			<?php }
			?>
			
			<?php 
				if( count($success_omi_exp) >= 1 && !empty($success_omi_exp) )
				$success_arr_rej = $success_omi_exp ;
				else if( count($success_omi_file) >= 1 && !empty($success_omi_file) )
				$success_arr_rej = $success_omi_file ;
				else
				$success_arr_rej = $vendor_omidata ;
				$success_omi_rej = '';
				
			for( $rej=0; $rej<count($success_arr_rej); $rej++ ){
				if( $success_arr_rej[$rej]->OMI_status == '-1' ){
					$success_omi_rej[] = $success_arr_rej[$rej];
				}
			}
			if($success_omi_rej) {
			$redlabel = 'red';
			 ?>
			<li><span style="color:red;">Rejected By MyVC</span></li>
			<?php }
			?>
			
		<?php
				if( count($success_omi_rej) >= 1 && !empty($success_omi_rej) )
				$success_arr_rej = $success_omi_rej ;	
				else if( count($success_omi_exp) >= 1 && !empty($success_omi_exp) )
				$success_arr_rej = $success_omi_exp ;
				else if( count($success_omi_file) >= 1 && !empty($success_omi_file) )
				$success_arr_rej = $success_omi_file ;
				else
				$success_arr_rej = $vendor_omidata ;
				
				$success_omi_each = '';	
				
				for( $each=0; $each<count($success_arr_rej); $each++ ){
						if( $omidata->each_claim <= $success_arr_rej[$each]->OMI_each_claim ){
								$success_omi_each[] = $success_arr_rej[$each];
							}
				}
				if($success_omi_each)
					$class_each = '';
				else
					$class_each = 'red';
				
				if( $class_each == 'red' && $omidata->each_claim && $omidata->each_claim !='0.00' )
				$red_newlabel = 'red';		
			?>
			
		<?php 
		$omi_main = '';
		$class_omi = '';
		if($omidata->each_claim && $omidata->each_claim !='0.00' ){ ?>
		<li><span style="color:<?php echo $class_each; ?>">Each Claim: <?php echo "$".number_format($omidata->each_claim,2); ?></span></li>
		<?php } ?>		
		<?php
				if( count($success_omi_each) >= 1 && !empty($success_omi_each) )
				$success_arr_agg = $success_omi_each ;
				else if( count($success_omi_rej) >= 1 && !empty($success_omi_rej) )
				$success_arr_agg = $success_omi_rej ;	
				else if( count($success_omi_exp) >= 1 && !empty($success_omi_exp) )
				$success_arr_agg = $success_omi_exp ;
				else if( count($success_omi_file) >= 1 && !empty($success_omi_file) )
				$success_arr_agg = $success_omi_file ;
				else 
				$success_arr_agg = $vendor_omidata ;
				$success_omi_agg = '';
				for( $agg=0; $agg<count($success_arr_agg); $agg++ ){
						if( $omidata->aggregate_omi <= $success_arr_agg[$agg]->OMI_aggregate ){
								$success_omi_agg[] = $success_arr_agg[$agg];
							}
				}
				if($success_omi_agg)
					$class_agg = '';
				else
					$class_agg = 'red';
				
				if( $class_agg == 'red' && $omidata->aggregate_omi && $omidata->aggregate_omi !='0.00' )
				$red_newlabel = 'red';	
				
			?>
		<?php if($omidata->aggregate_omi && $omidata->aggregate_omi !='0.00' ){ ?>
		<li><span style="color:<?php echo $class_agg; ?>">Aggregate: <?php echo "$".number_format($omidata->aggregate_omi,2); ?></span></li>
		<?php } ?>
		<?php
				if( count($success_omi_agg) >= 1 && !empty($success_omi_agg) )
				$success_arr_cert = $success_omi_agg ;
				else if( count($success_omi_each) >= 1 && !empty($success_omi_each) )
				$success_arr_cert = $success_omi_each ;
				else if( count($success_omi_rej) >= 1 && !empty($success_omi_rej) )
				$success_arr_cert = $success_omi_rej ;	
				else if( count($success_omi_exp) >= 1 && !empty($success_omi_exp) )
				$success_arr_cert = $success_omi_exp ;
				else if( count($success_omi_file) >= 1 && !empty($success_omi_file) )
				$success_arr_cert = $success_omi_file ;
				else 
				$success_arr_cert = $vendor_omidata ;
				
				$success_omi_cert = '';	
				for( $cert=0; $cert<count($success_arr_cert); $cert++ ){
						if( $omidata->certholder_omi == 'yes' ) {
							if( $success_arr_cert[$cert]->OMI_cert == 'yes' ){
									$success_omi_cert[] = $success_arr_cert[$cert];
								}
						}	
				}
				if($success_omi_cert)
					$class_cert_omi = '';
				else
					$class_cert_omi = 'red';
				
				if( $class_cert_omi == 'red' && $omidata->certholder_omi == 'yes' )
				$red_newlabel = 'red';	
			?>	
		<?php if($omidata->certholder_omi){ ?>
		<?php if($omidata->certholder_omi == 'yes'){ $waiver_omi = 'checked="checked"'; $class_certholder_omi = 'styled'; }?>
		<li><input type="checkbox" value="yes" name="certholder_omi" <?php echo $waiver_omi; ?> class="<?php echo $class_certholder_omi; ?>" /> <label><span style="color:<?php echo $class_cert_omi; ?>">MyVendorCenter listed as Cert. Holder</span></label></li>
		<?php } ?>	
		<?php 
//	$success_umb_agg = '';
//	$success_umb_each = '';
//	$success_arr_cert = '';
//	count($success_umb_agg) = '';
	?>
		</ul>
	</td></tr>
		<?php } ?>	
		
	<?php
		
		if($licdata){ $lic_main = 'checked="checked"'; $class_lic = 'styled active'; 
	?>
	
	<tr><td width="10">
	<input type="checkbox" value="yes" id="licensingliability" class="<?php echo $class_lic; ?>" name="licensingliability" <?php echo $lic_main; ?> /></td><td><strong><label style="display:block; padding-top:3px;">Licensing</label></strong></td></tr>
	<?php } ?>
	<?php if($licdata){ ?>
	<tr><td></td><td>
	<ul class="pre_lic">
			<?php
				$success_lic_pro = '';
				for( $pro=0; $pro<count($vendor_licdata); $pro++ ){
						if( $licdata->professional == 'yes' ) {
							if( $vendor_licdata[$pro]->PLN_expdate >= date('Y-m-d') && $vendor_licdata[$pro]->PLN_upld_cert && $vendor_licdata[$pro]->PLN_status == '1' ){
								$success_lic_pro[] = $vendor_licdata[$pro];
							}
						}	
				}
				if($success_lic_pro)
					$class_pro_lic = '';
				else
					$class_pro_lic = 'red';
					
					
				$success_occ_pro = '';
				for( $occ=0; $occ<count($vendor_occdata); $occ++ ){
						if( $licdata->occupational == 'yes' ) {
							if( ( $vendor_occdata[$occ]->OLN_expdate >= date('Y-m-d') || $vendor_occdata[$occ]->OLN_expdate == 'Does Not Expire')  && $vendor_occdata[$occ]->OLN_upld_cert && $vendor_occdata[$occ]->OLN_status == '1' ){
								$success_occ_pro[] = $vendor_occdata[$occ];
							}
						}	
				}
				if($success_occ_pro)
					$class_pro_occ = '';
				else
					$class_pro_occ = 'red';
						
			?>
			
		<?php 
		if( $class_pro_lic == 'red' && $licdata->professional )
			$red_newlabel = 'red';
		if( $class_pro_occ == 'red' && $licdata->occupational )
			$red_newlabel = 'red';
						
		$lic_main = '';
		$class_lic = '';
		if($licdata->professional){ ?>
		<?php if($licdata->professional == 'yes'){ $professional = 'checked="checked"'; $class_professional = 'styled';}?>
		<li><input type="checkbox" value="yes" name="professional" <?php echo $professional; ?> class="<?php echo $class_professional; ?>" /> <label><span style="color:<?php echo $class_pro_lic; ?>">Professional License</span></label></li>
		<?php } ?>		
		<?php if($licdata->occupational){ ?>
		<?php if($licdata->occupational == 'yes'){ $occupational = 'checked="checked"'; $class_occupational = 'styled';}?>
		<li><input type="checkbox" value="yes" name="occupational" <?php echo $occupational; ?> class="<?php echo $class_occupational; ?>" /> <label><span style="color:<?php echo $class_pro_occ; ?>">Occupational License</label></li>
		<?php } ?>	
		</ul>
	</td></tr>
		<?php } ?>	
	<tr id="licensingliability_sub"></tr>	
	
	</table>
		 </div>
</div>

<div class="clear"></div>
</div>
<?php } ?>
		<?php
$generaldata = ''; 
$autodata = ''; 
$workdata= ''; 
$umbrelladata = ''; 
$licdata = ''; 
//$success_umb_agg = '';
	//$success_umb_each = '';
	//$success_arr_cert = '';
	if( $redlabel == 'red' || $red_newlabel == 'red' ){ ?>
			<script type="text/javascript">
				G( "#industry_<?php echo $industryid; ?>" ).addClass( "redhighlight" );
				G( "#industrydiv_<?php echo $industryid; ?>" ).addClass( "redborderlight" );
			</script>
	<?php } else { ?>
				<script type="text/javascript">
				G( "#industry_<?php echo $industryid; ?>" ).addClass( "greenhighlight" );
				G( "#industrydiv_<?php echo $industryid; ?>" ).addClass( "greenborderlight" );
				</script>
	<?php } 
	
	$redlabel =	 '';
	$red_newlabel = '';
		}
		exit;
	  
		?>
		
		<?php 
	
	}
	
	function getvendorid(){
		$db = JFactory::getDBO();
		$id = JRequest::getVar( 'id','');
		$sql12_vendor = "SELECT v_id FROM #__vendor_inviteinfo where vid=".$id." ";
		$db->Setquery($sql12_vendor);
		$vendorid = $db->loadResult();
		echo $vendorid;
		exit;
	}
	
	function checkvendor_invites(){
		$db = JFactory::getDBO();
		$vendorid = JRequest::getVar('vendorid','');
		$rfpid = JRequest::getVar('rfpid','');
		$from = JRequest::getVar('from','');
		
		$vendors_b = explode(",", $vendorid);
		
			for( $v=0; $v<count($vendors_b); $v++ ){
								
				$sql12_vendor = "SELECT v_id FROM #__vendor_inviteinfo where vid=".$vendors_b[$v]." ";
				$db->Setquery($sql12_vendor);
				$vendor_id = $db->loadResult();
				if($from == 'search') {
					$vendor_id = $vendors_b[$v] ;
				}
				else{
					$vendor_id = $vendor_id ;
				}
				
				$sql12_invite = "SELECT id FROM #__cam_vendor_proposals where rfpno = ".$rfpid." and proposedvendorid = ".$vendor_id." and proposaltype != 'uninvited' ";
				$db->Setquery($sql12_invite);
				$invteid = $db->loadResult();
				
				if($invteid)
					$get = '';
				else
					$final_vendors .= $vendor_id.',';	
			}	
			
			echo $final_vendors;
		exit;	
	}
	
	//Function to sending recommendation to other managers
	function recommendvendors(){
	
		$db = JFactory::getDBO();
		$user	= JFactory::getUser();
		$vendors = JRequest::getVar('invitedvendors','');
		$selected_mans = JRequest::getVar('manager','');
		$vcenter = JRequest::getVar('vcenter','');
		$from = JRequest::getVar('from','');
		$model = $this->getModel('vendorscenter');
		$vendors_b = explode(",", $vendors);
	// Save all information
		for( $r=0; $r<count($selected_mans); $r++ ){
			for( $v=0; $v<count($vendors_b); $v++ ){
			if($from == 'search'){
			$vendoruserid = $vendors_b[$v];
			}
			else{
			$vendoruserid = $model->getvendorid($vendors_b[$v]);
			}
			
			$recs['sender'] = $user->id ;
			$recs['managerid'] = $selected_mans[$r] ;
			$recs['vendorid'] = $vendoruserid ;
			$recs['accept'] = '0' ;
			$recs['display'] = '0' ;
			$recs['senddate'] = date('Y-m-d H:i:s') ;
			
			// Check is there existing account or not ?
			$exist = $model->checkprevious($user->id, $selected_mans[$r], $recs['vendorid']);
				if( !$exist ){
					$save_rec = $model->save_rec($recs);
				}
				else{
					$recs['id'] = $exist ;
					$recs['display'] = '0' ;
					$recs['view'] = '0' ;
					$save_rec = $model->save_rec($recs);
				}
			}
		}
		echo "<script language='javascript' type='text/javascript'>
		window.parent.document.getElementById( 'sbox-window' ).close();
		window.parent.getpopupbox();
		//window.parent.location.reload();
		 </script>";
		 exit;
	}
	
		function propertyowner_recommendvendors(){
	
		$db = JFactory::getDBO();
		$user	= JFactory::getUser();
		$vendors = JRequest::getVar('invitedvendors','');
		$email = JRequest::getVar('email','');
		$managerid = "SELECT id FROM #__users where username ='".$email."'";
		$db->setQuery($managerid);
		$managerid_exist = $db->loadResult();
		$vcenter = JRequest::getVar('vcenter','');
		$from = JRequest::getVar('from','');
        $model = $this->getModel('vendorscenter');
		$vendors_b = explode(",", $vendors);
		
		// Save all information
		
			for( $v=0; $v<count($vendors_b); $v++ ){
			if($from == 'search'){
			$vendoruserid = $vendors_b[$v];
			}
			else{
			$vendoruserid = $model->getvendorid($vendors_b[$v]);
			}
			$vendor_company = "SELECT company_name FROM #__cam_vendor_company where user_id ='".$vendoruserid."'";
		    $db->setQuery($vendor_company);
		    $vendor_company = $db->loadResult();
			$body ="SELECT introtext  FROM #__content where id='320'";
			$db->setQuery( $body );
			$body = $db->loadResult();
			$body = str_replace('[Vendor Company Name]',$vendor_company,$body);
			$body = str_replace('[Property Owner Full Name]',$user->name. '&nbsp;' . $user->lastname,$body);
			$mailfrom = $user->email;
			$fromname = $user->name. ' ' . $user->lastname;
			$rizeemail = 'rize.cama@gmail.com';
			$support = 'propertyowneremails@myvendorcenter.com';
			$mailsubject = $user->name . ' ' . $user->lastname  . ' ' . 'has recommended a Vendor to you';
			$mailfrom = $user->email ;
			$res = JUtility::sendMail($mailfrom, $fromname, $email, $mailsubject, $body, $mode = 1);
			$res = JUtility::sendMail($mailfrom, $fromname, $rizeemail, $mailsubject, $body, $mode = 1);
			$res = JUtility::sendMail($mailfrom, $fromname, $mailfrom, $mailsubject, $body, $mode = 1);
			$res = JUtility::sendMail($mailfrom, $fromname, $support, $mailsubject, $body, $mode = 1);
			$recs['sender'] = $user->id ;
			$recs['managerid'] = $managerid_exist;
			$recs['vendorid'] = $vendoruserid ;
			$recs['accept'] = '0' ;
			$recs['display'] = '0' ;
			$recs['senddate'] = date('Y-m-d H:i:s') ;
			// Check is there existing account or not ?
			
			$exist = $model->checkprevious($user->id, $managerid_exist, $recs['vendorid']);
				if( !$exist ){
					$save_rec = $model->save_rec($recs);
				}
				else{
					$recs['id'] = $exist ;
					$recs['display'] = '0' ;
					$recs['view'] = '0' ;
					$save_rec = $model->save_rec($recs);
				}
			}
		
		echo "<script language='javascript' type='text/javascript'>
		window.parent.document.getElementById( 'sbox-window' ).close();
		window.parent.getpopupbox();
		//window.parent.location.reload();
		 </script>";
		 exit;
	}
	
	// Function to reject recommendation
	function rejectrecs(){
		$db = JFactory::getDBO();
		$recid = JRequest::getVar('Id','');
		$from = JRequest::getVar('from','');
		if( $from == 'accept' ){
		$sql = "UPDATE #__cam_manager_recommends SET display='1', accept='1' where id='".$recid."'"; 
		}
		else{
		$sql = "UPDATE #__cam_manager_recommends SET display='1', accept='2' where id='".$recid."'"; 
		}
		$db->Setquery($sql);
		if( $db->query() ){
			echo "yes";
		}
		else{
			echo 'no';
		}
		exit;
	}
	// Function to check the vendor is already in his list
	function checkiniteslist(){
		$db = JFactory::getDBO();
		$vendorid = JRequest::getVar('Id','');
		$user	= JFactory::getUser();
		$vendor_id = "SELECT vid FROM #__vendor_inviteinfo where v_id ='".$vendorid."' and userid=".$user->id." ";
		$db->setQuery($vendor_id);
		$v_id_exist = $db->loadResult();
		if($v_id_exist)
		$return = "yes";
		else
		$return = "no";
		echo $return;
		exit;
	}
	
	function blockvendors(){
		$db=&JFactory::getDBO();
		$user=JFactory::getUser();
		$check = JRequest::getVar('accept','');
		$blockusers = JRequest::getVar('block','');
		$query = "SELECT block, block_complinace FROM  #__cam_master_block_users WHERE masterid=".$user->id;
		$db->setQuery( $query );
		$data = $db->loadObject();
		
		if( $data ){
		if( $blockusers == 'unve' ) {
			if( $data->block == '0' )
				$block = '1';
			if( $data->block == '1' )
				$block = '0';
			$query = "UPDATE #__cam_master_block_users SET block=".$block." WHERE masterid =". $user->id;	
		}
		else{
			if( $data->block_complinace == '0' )
				$block = '1';
			if( $data->block_complinace == '1' )
				$block = '0';
			$query = "UPDATE #__cam_master_block_users SET block_complinace=".$block." WHERE masterid =". $user->id;	
		}	
				$db->setQuery( $query );
				$res=$db->query();
			}
			
			else{
				$sql = "insert into #__cam_master_block_users values ('','".$user->id."','1','0')";
				$db->SetQuery($sql);
				$db->query();
			}
		echo 'update'; exit;	
	}
	
	
	function sendmailto_vendors(){
		$db = JFactory::getDBO();
		$user	= JFactory::getUser();
		$vendors = JRequest::getVar('vendors','');
		$copymanager = JRequest::getVar('copymanager','');
		$from = JRequest::getVar('from','');
		$subject = JRequest::getVar('subject','');
		$custom_msg = JRequest::getVar('mailbody','');
		$model = $this->getModel('vendorscenter');
		$vendors_b = explode(",", $vendors);
		$vendor_info = '<ul>';
			for( $v=0; $v<count($vendors_b); $v++ ){
			if($from == 'search'){
			$vendoruserid = $vendors_b[$v];
			}
			else{
			$vendoruserid = $model->getvendorid($vendors_b[$v]);
			}
		// Send mail to vendor
				$mailbody = $model->getmailbody();
				$fullname = $user->name.' '.$user->lastname;
				$companyname = $model->getmanagercompanyname();
				$body = str_replace('[Mail Body]',$custom_msg,$mailbody);
				$body = str_replace('[Manager Full Name]',$fullname,$body);
				$body = str_replace('[Manager Company Name]',$companyname,$body);
				$vendordetails = $model->getvendoremail($vendoruserid);
				$body = str_replace('[Vendor Company Name]',$vendordetails->company_name,$body);
				$mailfrom = $user->email; 
				$fromname = $companyname;
				$assignuseremail = $vendordetails->email;
				$mailsubject = $subject;
				//$assignuseremail = 'rize.cama@gmail.com';
				JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body,$mode = 1);
				$to_support = 'vendoremails@myvendorcenter.com';
				JUtility::sendMail($mailfrom, $fromname, $to_support, $mailsubject, $body,$mode = 1);
				$ccemails = $vendordetails->ccemail ;
				$cclist = explode(';',$ccemails);
					for($c=0; $c<=count($cclist); $c++){
					$listcc = $cclist[$c];
					if($listcc){
					JUtility::sendMail($mailfrom, $fromname, $listcc, $mailsubject, $body,$mode = 1);
					}
					} 
		$vendor_info .= "<li>".$vendordetails->company_name."</li>";
		//Completed	
		}
		$vendor_info .= '</ul>';
		if( $copymanager == 'on' ){
			$mailbody_mgr = $model->getmanagermailbody();
			$body = str_replace('[Manager Name]',$fullname,$mailbody_mgr);
			$body = str_replace('[Vendor Company list]',$vendor_info,$body);
			$body = str_replace('[Manager Message]',$custom_msg,$body);
			$manageremail = $user->email ;
			JUtility::sendMail($mailfrom, $fromname, $manageremail, $mailsubject, $body,$mode = 1);
			$to_support = 'manageremails@myvendorcenter.com';
			JUtility::sendMail($mailfrom, $fromname, $to_support, $mailsubject, $body,$mode = 1);
		}
		echo "<script language='javascript' type='text/javascript'>
		window.parent.document.getElementById( 'sbox-window' ).close();
		window.parent.location.reload();
		 </script>";
		 exit;
	}
	
	//function to get vendor details in JSON array format.
	function getvendorinfo(){
		$db =& JFactory::getDBO();
		$state = JRequest::getVar( 'state','');
		$county = JRequest::getVar( 'county','');
		$industrytype = JRequest::getVar( 'industry','');
		// To implement a query for basic result
		$query  = "SELECT v.id, u.company_name as companyName, u.company_address as address, u.company_phone as companyPhone, u.phone_ext, u.alt_phone as alternatePhone, u.alt_phone_ext, v.cellphone, u.company_web_url as website, u.zipcode, v.name, v.lastname, v.email, u.city, u.state, u.status, v.block, v.subscribe, v.subscribe_type, u.image as company_logo FROM  #__cam_vendor_company as u, #__users as v where u.user_id=v.id and v.block=0 and v.search='' " ;
		$db->setQuery($query);
		$totalprefers = $db->loadObjectList();

	if($industrytype){
		$checkvendors = "SELECT distinct(user_id) FROM #__cam_vendor_industries where industry_id=".$industrytype." "; // Get all users who are worked for the industry
		$db->setQuery($checkvendors);
		$accpetvendor = $db->loadObjectList();
		
		if($totalprefers){
			foreach($totalprefers as $vid){
				$existing[] = $vid->id;
			}
		}	
		if($accpetvendor){
			foreach($accpetvendor as $inids){
				$indusids[] = $inids->user_id;
			}
		}
		if($indusids != '' && $existing!= ''){
			$common = array_intersect($indusids, $existing) ;
		}
		if($common){
			$indus_condition = implode(',',$common) ;
		}
		if($indus_condition)
			$query = $query . "AND v.id IN ("  . $indus_condition . ")" ;
		else
			$query = $query . "AND v.id IN ('')" ;
	}
			
	if($county){
		$checkvendors1 = "SELECT distinct(user_id) FROM #__vendor_state_counties where county_id=".$county." "; // Get all users who are worked in this county.
		$db->setQuery($checkvendors1);
		$accpetvendor1 = $db->loadObjectList();
	
		if($totalprefers){
			foreach($totalprefers as $vid){
				$existing[] = $vid->v_id;
			}
		}	
		if($accpetvendor1){
			foreach($accpetvendor1 as $county){
				$countys[] = $county->user_id;
			}
		}
		if($countys && $existing){
			$common = array_intersect($countys, $existing) ;
			
			if($common){
				$county_condition = implode(',',$common) ;
			}
			if($county_condition)	{
				$query = $query . " AND v.id IN ("  . $county_condition . ")" ;
			}
			else {
				$query = $query . " AND v.id IN ('')" ;
			}
		}	
		else {
			$query = $query . " AND v.id IN ('')" ;
		}
	}
	$db->setQuery($query);
	$totalcompanies = $db->loadObjectList();
	// Get compliance status and vendor rating
	$model = $this->getModel('vendorscenter');
	for( $p=0; $p<count($totalcompanies); $p++ ){
		$c_status =	$model->checkcompliancestatus($totalcompanies[$p]->id);
		$totalcompanies[$p]->cstatus = $c_status ;
	}
	for( $s=0; $s<count($totalcompanies); $s++ ){
		$only_state = $totalcompanies[$s]->cstatus ;
					if($only_state){
						foreach($only_state as $statues){
							$final_state[] = $statues->status;
							$med_fina_state = '';
							$med_fina_state = array_unique($final_state);
							
								if( count($med_fina_state) == 2 ) {
									$totalcompanies[$s]->compliance = 'Compliant & Noncompliant' ;
								}
								if( count($med_fina_state) == 1 &&  $med_fina_state[0] == 'fail') {
									$totalcompanies[$s]->compliance = 'Noncompliant' ;
								}
								if( count($med_fina_state) == 1 &&  $med_fina_state[0] == 'success' ){
									$totalcompanies[$s]->compliance = 'Compliant' ;
									
										$masteraccount = $model->getmasterfirmaccount($user->id);
										$sql_terms = "SELECT termsconditions FROM #__cam_vendor_aboutus WHERE vendorid=".$masteraccount." "; 
										$db->setQuery($sql_terms);
										$terms_exist = $db->loadResult();
										if($terms_exist == '1'){
										$sql = "SELECT accepted FROM #__cam_vendor_terms WHERE vendorid=".$totalcompanies[$s]->id." and masterid=".$masteraccount." "; 
										$db->setQuery($sql);
										$terms = $db->loadResult();
											if($terms == '1'){
											$totalcompanies[$s]->compliance = 'Compliant' ;
											}
											else{
											$totalcompanies[$s]->compliance = 'Noncompliant' ;
											}
										}
									
								}
						} 
						$final_state = '';
						$med_fina_state = '';
					}
	// Checking vendor is subscribed or not
	if( $totalcompanies[$s]->subscribe == 'yes' && $totalcompanies[$s]->subscribe_type == 'free' )
		$totalcompanies[$s]->verified = 'Unverified' ;
	else if( $totalcompanies[$s]->subscribe == 'yes' && $totalcompanies[$s]->subscribe_type != 'free' )	
		$totalcompanies[$s]->verified = 'Verified' ;
	else
		$totalcompanies[$s]->verified = 'Not subscribed' ;	
	// To get the vendor industries
	$vendor_indus = $model->getvendorindustries($totalcompanies[$s]->id);	
	$totalcompanies[$s]->industriesServed = $vendor_indus ;
	//Adding vendor rating, states
	$vendor_cinfo = $model->getvendorinformation($totalcompanies[$s]->id);
	$data_com = explode('----',$vendor_cinfo);
	$totalcompanies[$s]->rating = $data_com[0] ;	
	$totalcompanies[$s]->state = $data_com[1] ;	
	if( $totalcompanies[$s]->company_logo )
	$totalcompanies[$s]->company_logo = JURI::base().'components/com_camassistant/assets/images/vendors/'.$totalcompanies[$s]->company_logo ;	
	else
	$totalcompanies[$s]->company_logo = '' ;	
		}
	$results_json = json_encode($totalcompanies); // Convert the data into JSON array
	echo $results_json; exit;

	}
	
	function getmyvendorlist()
	{
		$db = & JFactory::getDBO();	
		$user =& JFactory::getUser();		
		$model = $this->getModel('vendorscenter');
		$post = JRequest::get('request');
		$usercreator = $user->id;
	 	$query = "SELECT W.id, V.company_name as companyName, V.company_address as address, V.company_phone as companyPhone, V.phone_ext, V.alt_phone as alternatePhone, V.alt_phone_ext, W.cellphone, V.city, V.state, V.fax_id, V.tax_id, U.vid, W.name, W.lastname, W.email, W.subscribe, W.subscribe_type, V.image as company_logo from #__vendor_inviteinfo as U, #__cam_vendor_company as V, #__users as W where LOWER(U.inhousevendors) = (W.email) and V.user_id=W.id and W.block='0' AND U.exclude!='yes' and U.search!='yes'and W.search='' and U.userid=".$usercreator." ";
		$db->setQuery($query);
		$result = $db->loadObjectList();
		
		for( $p=0; $p<count($result); $p++ ){
			$c_status =	$model->checkcompliancestatus($result[$p]->id);
			$result[$p]->cstatus = $c_status ;
		}
	
		for( $s=0; $s<count($result); $s++ ){
		$only_state = $result[$s]->cstatus ;
					if($only_state){
						foreach($only_state as $statues){
							$final_state[] = $statues->status;
							$med_fina_state = '';
							$med_fina_state = array_unique($final_state);
								if( count($med_fina_state) == 2 ) {
									$result[$s]->compliance = 'Compliant & Noncompliant' ;
								}
								if( count($med_fina_state) == 1 &&  $med_fina_state[0] == 'fail') {
									$result[$s]->compliance = 'Noncompliant' ;
								}
								if( count($med_fina_state) == 1 &&  $med_fina_state[0] == 'success' ){
									$result[$s]->compliance = 'Compliant' ;
									
									$masteraccount = $model->getmasterfirmaccount($user->id);
										$sql_terms = "SELECT termsconditions FROM #__cam_vendor_aboutus WHERE vendorid=".$masteraccount." "; 
										$db->setQuery($sql_terms);
										$terms_exist = $db->loadResult();
										
										if($terms_exist == '1'){
										$sql = "SELECT accepted FROM #__cam_vendor_terms WHERE vendorid=".$result[$s]->id." and masterid=".$masteraccount." "; 
										$db->setQuery($sql);
										$terms = $db->loadResult();
											if($terms == '1'){
											$result[$s]->compliance = 'Compliant' ;
											}
											else{
											$result[$s]->compliance = 'Noncompliant' ;
											}
										}
										else{
										
										}
										
										
								}
						} 
						$final_state = '';
						$med_fina_state = '';
					}
		// Adding block unverified vendor rule
		$user =& JFactory::getUser();
		$masterid = $model->getmasterfirmaccount($user->id);
		$block_per = "SELECT id FROM #__cam_master_block_users where masterid ='".$masterid."' ";
		$db->setQuery($block_per);
		$blockid = $db->loadResult();
		if( $blockid )
			$result[$s]->block_unverified = 'hide' ;
		else	
			$result[$s]->block_unverified = 'show' ;
		//Completed
		
	// Checking vendor is subscribed or not
	if( $result[$s]->subscribe == 'yes' && $result[$s]->subscribe_type == 'free' )
		$totalcompanies[$s]->verified = 'Unverified' ;
	else if( $result[$s]->subscribe == 'yes' && $result[$s]->subscribe_type != 'free' )	
		$result[$s]->verified = 'Verified' ;
	else
		$result[$s]->verified = 'Not subscribed' ;	
	// To get the vendor industries
	$vendor_indus = $model->getvendorindustries($result[$s]->id);	
	$result[$s]->industriesServed = $vendor_indus ;
	//Adding vendor rating, states
	$vendor_cinfo = $model->getvendorinformation($result[$s]->id);
	$data_com = explode('----',$vendor_cinfo);
	$result[$s]->rating = $data_com[0] ;	
	$result[$s]->state = $data_com[1] ;	
	
	if( $result[$s]->company_logo )
	$result[$s]->company_logo = JURI::base().'components/com_camassistant/assets/images/vendors/'.$result[$s]->company_logo ;	
	else
	$result[$s]->company_logo = '' ;
	
		}
	$vendors[0]['listName'] = 'My Vendors' ;
	$vendors[0]['vendors'] = $result ;
	// To get Corporate vendors
	$vendors[1]['listName'] = 'Corporate Preferred' ;
	$result_corporate = $model->getcorporate_json();
	$vendors[1]['vendors'] = $result_corporate ;
	// To get Co-Worker vendors
	$vendors[2]['listName'] = 'Co-workers' ;
	$result_coworkers = $model->getcoworkers_json();
	$vendors[2]['vendors'] = $result_coworkers ;
	$myvendors_json = json_encode($vendors); // Convert the data into JSON array	
	//echo '<pre>'; print_r($vendors);  echo "</pre>"; exit;
	echo $myvendors_json; exit;
	}
		
		
	//function to get vendor details in JSON array format.
	function results_searchcompany(){
		$db =& JFactory::getDBO();
		$companyname = JRequest::getVar( 'cname','');
		// To implement a query for basic result
		$query  = "SELECT v.id, u.company_name as companyName, u.company_address as address, u.company_phone as companyPhone, u.phone_ext, u.alt_phone as alternatePhone, u.alt_phone_ext, v.cellphone, u.company_web_url as website, u.zipcode, v.name, v.lastname, v.email, u.city, u.state, u.status, v.block, v.subscribe, v.subscribe_type, u.image as company_logo FROM  #__cam_vendor_company as u, #__users as v where u.user_id=v.id and (LOWER(company_name) LIKE '%".$companyname."%' ) and v.search='' and v.block=0  " ;
	$db->setQuery($query);
	$totalcompanies = $db->loadObjectList();
	// Get compliance status and vendor rating
	$model = $this->getModel('vendorscenter');
	for( $p=0; $p<count($totalcompanies); $p++ ){
		$c_status =	$model->checkcompliancestatus($totalcompanies[$p]->id);
		$totalcompanies[$p]->cstatus = $c_status ;
	}
	for( $s=0; $s<count($totalcompanies); $s++ ){
		$only_state = $totalcompanies[$s]->cstatus ;
					if($only_state){
						foreach($only_state as $statues){
							$final_state[] = $statues->status;
							$med_fina_state = '';
							$med_fina_state = array_unique($final_state);
							
								if( count($med_fina_state) == 2 ) {
									$totalcompanies[$s]->compliance = 'Compliant & Noncompliant' ;
								}
								if( count($med_fina_state) == 1 &&  $med_fina_state[0] == 'fail') {
									$totalcompanies[$s]->compliance = 'Noncompliant' ;
								}
								if( count($med_fina_state) == 1 &&  $med_fina_state[0] == 'success' ){
									$totalcompanies[$s]->compliance = 'Compliant' ;
									
										$masteraccount = $model->getmasterfirmaccount($user->id);
										$sql_terms = "SELECT termsconditions FROM #__cam_vendor_aboutus WHERE vendorid=".$masteraccount." "; 
										$db->setQuery($sql_terms);
										$terms_exist = $db->loadResult();
										if($terms_exist == '1'){
										$sql = "SELECT accepted FROM #__cam_vendor_terms WHERE vendorid=".$totalcompanies[$s]->id." and masterid=".$masteraccount." "; 
										$db->setQuery($sql);
										$terms = $db->loadResult();
											if($terms == '1'){
											$totalcompanies[$s]->compliance = 'Compliant' ;
											}
											else{
											$totalcompanies[$s]->compliance = 'Noncompliant' ;
											}
										}
									
								}
						} 
						$final_state = '';
						$med_fina_state = '';
					}
	// Checking vendor is subscribed or not
	if( $totalcompanies[$s]->subscribe == 'yes' && $totalcompanies[$s]->subscribe_type == 'free' )
		$totalcompanies[$s]->verified = 'Unverified' ;
	else if( $totalcompanies[$s]->subscribe == 'yes' && $totalcompanies[$s]->subscribe_type != 'free' )	
		$totalcompanies[$s]->verified = 'Verified' ;
	else
		$totalcompanies[$s]->verified = 'Not subscribed' ;	
	// To get the vendor industries
	$vendor_indus = $model->getvendorindustries($totalcompanies[$s]->id);	
	$totalcompanies[$s]->industriesServed = $vendor_indus ;
	//Adding vendor rating, states
	$vendor_cinfo = $model->getvendorinformation($totalcompanies[$s]->id);
	$data_com = explode('----',$vendor_cinfo);
	$totalcompanies[$s]->rating = $data_com[0] ;	
	$totalcompanies[$s]->state = $data_com[1] ;	
	if( $totalcompanies[$s]->company_logo )
	$totalcompanies[$s]->company_logo = JURI::base().'components/com_camassistant/assets/images/vendors/'.$totalcompanies[$s]->company_logo ;	
	else
	$totalcompanies[$s]->company_logo = '' ;	
		}
	//echo "<pre>";	print_r($totalcompanies); exit;
	$results_json = json_encode($totalcompanies); // Convert the data into JSON array 
	echo $results_json; exit;

	}	
	
	//Function to check existing codes with new code
	function checkcode(){
		$db =& JFactory::getDBO();
		$user =& JFactory::getUser();
		$code = JRequest::getVar( 'newcode','');
		$sql_code = "SELECT id FROM #__cam_master_vendorcodes WHERE code='".$code."' and publish='1'  "; 
		$db->setQuery($sql_code);
		$existid = $db->loadResult();
			if($existid)
				$res = "yes";
			else
				$res = "no";	
		echo trim($res);		
		exit;		
	}
	//Function to check existing codes with new code
	function checkeditcode(){
		$db =& JFactory::getDBO();
		$user =& JFactory::getUser();
		$code = JRequest::getVar( 'newcode','');
		$codeid = JRequest::getVar( 'codeid','');
		$sql_code = "SELECT id FROM #__cam_master_vendorcodes WHERE code='".$code."' and id != ".$codeid." "; 
		$db->setQuery($sql_code);
		$existid = $db->loadResult();
			if($existid)
				$res = "yes";
			else
				$res = "no";	
		echo trim($res);		
		exit;		
	}
	//Function to save code information
	function savecodeinfo(){
		
		$db =& JFactory::getDBO();
		$user =& JFactory::getUser();
		$price = JRequest::getVar( 'cost','');
		$action = JRequest::getVar( 'action','');
		$cost = str_replace(',','',$price);
		$code['masterid'] = $user->id;
		$code['code'] = JRequest::getVar( 'code','');
		$code['cost'] = $cost;
		$code['renewtype'] = JRequest::getVar( 'renewtype','');
		$code['created_date'] = date('Y-m-d');
		$code['updated_date'] = date('Y-m-d');
		$code['publish'] = '1';
		$code['purchase_reqs'] = JRequest::getVar( 'reqs','');
		$model = $this->getModel('vendorscenter');
		
		if( $action == 'update' ){
			$code['id'] = JRequest::getVar( 'codeid','');
			$code['created_date'] = JRequest::getVar( 'createdate','');
			$code['publish'] = '1';	
		}
		
		$savecode_data = $model->storecodedata($code);
		if( $savecode_data ) {
			echo "<script language='javascript' type='text/javascript'>
		window.parent.document.getElementById( 'sbox-window' ).close();
		window.parent.parent.location.reload();
		 </script>"; 
		}
	}
	//Function to shoe code information
	function getpreferredcode(){
		$db =& JFactory::getDBO();
		$user =& JFactory::getUser();
		$code = JRequest::getVar( 'code','');
		$codestatus = JRequest::getVar( 'type','');
		
		$model = $this->getModel('vendorscenter');
		$sql = "SELECT V.company_name, U.id, U.name, U.lastname, U.email, VP.purchase_date, VP.renewal_date, VP.publish, MV.cost, MV.renewtype FROM #__cam_vendor_purchasedcodes as VP 
		INNER JOIN #__cam_master_vendorcodes as MV ON VP.codeid = MV.id 
		INNER JOIN #__cam_vendor_company as V ON VP.vendorid = V.user_id 
		INNER JOIN #__users as U ON U.id = V.user_id 
		where VP.masterid=".$user->id." and VP.codeid=".$code." GROUP BY VP.vendorid order by VP.id desc";
		
		$db->setQuery($sql);
		$codes_purchased = $db->loadObjectList();
		// To get the balance money to request
		$paidtodate = $model->getbalancemoney($code);
		$paidinfo = explode('---',$paidtodate);
			
		?>
		<div class="total_box_price">
		<table width="100%" border="0" style="margin:0px 0px;" cellpadding="0" cellspacing="0">
		<tr class="table_blue_rowdotsextend_normal">
				<td colspan="6" align="center">
				<ul class="codeoptionsedit">
				<li><a href="javascript:void(0);" onclick="editcode(<?php echo $code; ?>);">EDIT</a></li>
				<li><a href="javascript:void(0);" onclick="request_money(<?php echo $code; ?>,'<?php echo $paidinfo[0]; ?>','<?php echo $paidinfo[1].'.00'; ?>');">REQUEST MONEY</a></li>
				<li><a class="cancelcode_exist" href="javascript:void(0);" onclick="cancelcode(<?php echo $code; ?>);">CANCEL</a></li>
				</ul>
				</td>
				</tr>
				<?php if( $codestatus == 'cancel' ) {?>
				<tr height="10"></tr>
				<?php } ?>
				<tr class="table_blue_rowdotsextend_gray">
				<td valign="middle" align="left" valign="middle" width="400" style="padding-left:8px;">VENDOR</td>		
				<td valign="middle" align="center" width="150">STATUS</td>
				<td valign="middle" align="center"  width="150">LAST PURCHASE</td>
				<td valign="middle" align="center" width="150">RENEWAL</td>
				<td valign="middle" align="center" width="150">UNIT COST</td>
				<td valign="middle" align="center" width="170">PAID TO DATE</td>
				</tr>
		<?php if(count($codes_purchased) > 0){ 
				for($i=0; $i<count($codes_purchased); $i++){ ?>
				<tr class="table_blue_rowdotsextend">
				<td valign="middle" align="left" valign="middle" width="400">
				<a target="_blank" href="index.php?option=com_camassistant&controller=vendors&task=vendordetailslayout&id=<?php echo $codes_purchased[$i]->id; ?>"><?php echo $codes_purchased[$i]->company_name ; ?></a><br />
				<?php echo $codes_purchased[$i]->name.'&nbsp;'.$codes_purchased[$i]->lastname ; ?><br />
				<a class="miniemails" href="mailto:<?php echo $codes_purchased[$i]->email; ?>">Email</a>
				</td>	
				<td valign="middle" align="center" width="150">
				<?php
				if(  $codestatus == 'cancel' && $codes_purchased[$i]->renewtype == 'none' ){ 
					echo "<font color='red'>Inactive</fotn>";
				}
				else if( $codestatus == 'open' && $codes_purchased[$i]->renewtype == 'none' ) {
					if( $codes_purchased[$i]->publish == '0' ) 
					echo "<font color='red'>Inactive</fotn>";
					else 
					echo "<font color='green'>Active</fotn>";
				}
				else if( $codestatus == 'open' && $codes_purchased[$i]->renewtype == 'annual' ){
					$expired_date = $model->getexpireddate($code,$codes_purchased[$i]->id);
					if( $codes_purchased[$i]->publish == '0' || $expired_date < date('Y-m-d')) 
					echo "<font color='red'>Inactive</fotn>";
					else 
					echo "<font color='green'>Active</fotn>";
				}
				else if( $codestatus == 'cancel' && $codes_purchased[$i]->renewtype == 'annual' ){
					$expired_date = $model->getexpireddate($code,$codes_purchased[$i]->id);
					//echo $expired_date;
					if( $expired_date > date('Y-m-d') )
					echo "<font color='green'>Active</fotn>";	
					else
					echo "<font color='red'>Inactive</fotn>";
				}
				?>
				</td>	
				<td valign="middle" align="center" width="150">
				<?php 
				$pdate = explode(' ',$codes_purchased[$i]->purchase_date) ;
				$final_pdate = explode('-',$pdate[0]);
				echo $final_pdate[1].'-'.$final_pdate[2].'-'.$final_pdate[0];
				 ?>
				</td>				<td valign="middle" align="center" width="150">
				<?php if($codes_purchased[$i]->renewtype  == 'none') echo 'None' ; 
				else{
					$renpdate = explode(' ',$codes_purchased[$i]->renewal_date) ;
					$final_rendate = explode('-',$renpdate[0]);

					echo $final_rendate[1].'-'.$final_rendate[2].'-'.$final_rendate[0];
				}
				?></td>
				<td valign="middle" align="center" width="150"><?php echo "$".number_format($codes_purchased[$i]->cost,2) ; ?></td>
				<td valign="middle" align="right" width="170"><span><?php 
				$paidtodate = $model->gettotalprice($code,$codes_purchased[$i]->renewal_date,$codes_purchased[$i]->cost,$codes_purchased[$i]->id);
				echo "$".number_format($paidtodate,2) ; ?></span></td>
				</tr>
				<?php }
		 } else { ?>
		<tr><td colspan="6" align="center"><p style="padding:16px;">No Vendors have purchased this code</p></td>
		<?php } ?>
		</table>
		<?php if(count($codes_purchased) > 0){  ?>
			<div class="price_elements">
				<div class="total_earned_label">Total Earned:</div>
				<div class="total_earned_price"><span>
				<?php
				$paidtodate = $model->gettotalearned($code);
				echo "$".number_format($paidtodate,2) ;
				?>
				</span></div>
			</div>
			<div class="clr"></div>
			<div class="price_elements">
				<div class="total_earned_label">Refunded:</div>
				<div class="total_earned_price"><span><?php 
				if( $paidinfo[2] )
				echo "$".number_format($paidinfo[2],2);
				else
				echo "$0.00";
				 ?></span></div>
			</div>
			<div class="clr"></div>
			<div class="price_elements">
				<div class="total_earned_label">Balance:</div>
				<div class="total_earned_price"><span><?php 
				if( $paidinfo[1] )
				echo "$".number_format($paidinfo[1],2);
				else
				echo "$0.00";
				 ?></span></div>
			</div>
			<div class="clr"></div>
		<?php }
		?>
		</div>
		<?php
		//echo "<pre>"; print_r($codes_purchased); echo "</pre>";
		exit;
	}
	
	//Function to send the mail when master requested money
	function send_requestmoney(){
		$amount = JRequest::getVar( 'amount','');
		$codeid = JRequest::getVar( 'codeid','');
		$saveamount = JRequest::getVar( 'saveamount','');
		$model = $this->getModel('vendorscenter');	
		$db =& JFactory::getDBO();
		$user =& JFactory::getUser();
		$sql12 = "SELECT introtext  FROM #__content where id='303' ";
		$db->Setquery($sql12);
		$mailbody = $db->loadResult();
		$body = str_replace('[Vendor]',$cname,$mailbody);
		$mailfrom = $user->email;
		$fromname = $user->name.''.$user->lastname;
		$mailsubject = 'A Request for Money has been made';
		$to = 'accounting@myvendorcenter.com';
		//$to = 'rize.cama@gmail.com';
		// To get the company name
		$sql12_cname = "SELECT comp_name  FROM #__cam_camfirminfo where cust_id=".$user->id." ";
		$db->Setquery($sql12_cname);
		$companyname = $db->loadResult();
		// To get the code name
		$sql12_codename = "SELECT code  FROM #__cam_master_vendorcodes where id=".$codeid." ";
		$db->Setquery($sql12_codename);
		$code_name = $db->loadResult();
		
		$body = str_replace('[Manager Full Name]',$fromname,$mailbody);
		$body = str_replace('[Company Name]',$companyname,$body);
		$body = str_replace('[Code Name]',$code_name,$body);
		$body = str_replace('[amount]',"$".number_format($amount,2),$body);
		$body = str_replace('[Balance]',"$".number_format($saveamount,2),$body);
		$body = str_replace('[Master Account Company Name]',$companyname,$body);
		$result = JUtility::sendMail($mailfrom, $fromname, $to, $mailsubject, $body, $mode = 1);
		//Save the request info
		$req['codeid'] = $codeid ;
		$req['masterid'] = $user->id ;
		$req['requested_money'] = $saveamount ;
		$req['requested_date'] = date('Y-m-d') ;
		$save_info = $model->saverequest($req);
		
		echo "<script language='javascript' type='text/javascript'>
		window.parent.document.getElementById( 'sbox-window' ).close();
		window.parent.parent.location.reload();
		 </script>";
		
	}
	//Function to delete preferred code added
	function deletepcode(){
		$code = JRequest::getVar( 'code','');
		$db =& JFactory::getDBO();
		$user =& JFactory::getUser();
		$date = date('Y-m-d');
		$query_delete = "UPDATE #__cam_master_vendorcodes SET publish='0', canceldate='".$date."' WHERE id=".$code." and masterid=".$user->id." " ;
		$db->setquery($query_delete);
		if($db->query()) {
		echo "removed";
		}
		else{
		echo "notremoved";
		}	
		// To cancel all the recussring payments
		/*$sql_ctype = "SELECT renewtype FROM #__cam_master_vendorcodes where id=".$code." and masterid=".$user->id." " ;
		$db->Setquery($sql_ctype);
		$codetype = $db->loadResult();
			if( $codetype == 'annual' ) {
				$model = $this->getModel('vendorscenter');
				$payments_cancel = $model->recurrings_cancel($code);	
			}*/
		//Completed
		exit;
	
	}
	//Function to ceck vendor before deletes him
	function checkvendorpre(){
		$vendor = JRequest::getVar( 'vendorid','');
		$db =& JFactory::getDBO();
		$user =& JFactory::getUser();
		// To get the vendor id
		$lists = explode(',',$vendor);
		for( $l=0; $l<count($lists); $l++ ){
		$sql_vid = "SELECT v_id FROM #__vendor_inviteinfo where vid=".$lists[$l]." ";
		$db->Setquery($sql_vid);
		$vendorids = $db->loadResult();
		//Completed
		//$sql12_codename = "SELECT VP.renewal_date, MV.renewtype FROM #__cam_vendor_purchasedcodes as VP, #__cam_master_vendorcodes as MV where VP.vendorid=".$vendorids." and VP.masterid=".$user->id." and VP.codeid=MV.id and MV.cost!='0.00' order by renewal_date DESC ";
		$model = $this->getModel('vendors');
		$sql12_codename = "SELECT VP.renewal_date, MV.renewtype, MV.publish FROM #__cam_vendor_purchasedcodes as VP, #__cam_master_vendorcodes as MV where VP.vendorid=".$vendorids." and VP.masterid=".$user->id." and VP.codeid=MV.id order by renewal_date DESC ";
		$db->Setquery($sql12_codename);
		$vendorcodedata = $db->loadObjectList();
		
		if( count($vendorcodedata) == '1' ) {
			if( $vendorcodedata[0]->publish == '0' && $vendorcodedata[0]->renewtype == 'none')	
				echo "can";
			else if( $vendorcodedata[0]->publish == '0' && $vendorcodedata[0]->renewal_date < date('Y-m-d') )	
				echo "can";
			else if( $vendorcodedata[0]->publish == '0' && $vendorcodedata[0]->renewal_date > date('Y-m-d') ){
				echo "cannot";
				exit;
				}
			else if( $vendorcodedata[0]->publish == '1' && $vendorcodedata[0]->renewal_date > date('Y-m-d') ){
				echo "cannot";
				exit;
			}	
			else if( $vendorcodedata[0]->publish == '1' && $vendorcodedata[0]->renewal_date < date('Y-m-d') ){
				echo "can";
			}	
			else
				echo "can";
			}
		else{
			$model = $this->getModel('vendorscenter');
			$v_status = $this->getvendorcodestatus($vendorcodedata);
			if( $v_status == 'cannot'  ) {
				echo $v_status; exit;
			}
			else{
				echo $v_status;
			}
		}	
		}	
		exit;		
	}
	
		function getvendorcodestatus($vendorcodeinfo){
			$db =& JFactory::getDBO();
//			echo "<pre>"; print_r($vendorcodeinfo); echo "</pre>";
			for( $v=0; $v<count($vendorcodeinfo); $v++ ){
				if( $vendorcodeinfo[$v]->publish == '1' && $vendorcodeinfo[$v]->renewal_date > date('Y-m-d') ){
					$activecodes = 'cannot';
					return $activecodes;
				}
				else{
					$activecodes = 'can';
					//return $activecodes;
				}
			}
		}
		
		function gettermsdata(){
			$db =& JFactory::getDBO();
			$vendorid = JRequest::getVar( 'vendorid','');
			$masterid = JRequest::getVar( 'masterid','');
			$type = JRequest::getVar( 'type','');
			if( $type != 'notread' ){
			$sql_terms = "SELECT * FROM #__cam_vendor_terms where vendorid=".$vendorid." and masterid=".$masterid." ";
			$db->Setquery($sql_terms);
			$terms_data = $db->loadObject();
			if( !$terms_data->firstname || !$terms_data->lastname || !$terms_data->update_date ){
				$sql_unme = "SELECT name, lastname FROM #__users where id=".$vendorid." ";
				$db->Setquery($sql_unme);
				$name_vendor = $db->loadObject();
				$firstname = $name_vendor->name ;
				$lastname = $name_vendor->lastname ;
				$datef = '2015-06-22 13:00:00';
			}
			else{
				$firstname = $terms_data->firstname ;
				$lastname = $terms_data->lastname ;
				$datef = $terms_data->update_date;
			}
			
			$date = explode(' ',$datef);
			$date_mdy = explode('-',$date[0]);
			$time = date("h:i A", strtotime($date[1]));
			
			if( $terms_data->accepted == '1' )
			$result = "Accepted on <strong>".$date_mdy[1]."/".$date_mdy[2]."/".$date_mdy[0]." </strong> at <strong>".$time."</strong> by <strong>".$firstname."&nbsp;".$lastname."</strong>";
			else
			$result = "Declined on <strong>".$date_mdy[1]."/".$date_mdy[2]."/".$date_mdy[0]." </strong> at <strong> ".$time."</strong> by <strong>".$firstname."&nbsp;".$lastname."</strong>";
			echo $result; exit;
			}
			else{
				$user	= JFactory::getUser();
				if( $user->user_type != '11' )
				$result = "This Vendor has not read your Terms & Conditions";
				else
				$result = "You have not read Terms & Conditions";
			echo $result; exit;
			}
		}
		
		function gettermsandconditions($masterid,$vendorid){
			$db =& JFactory::getDBO();
			$sql_terms = "SELECT * FROM #__cam_vendor_terms where vendorid=".$vendorid." and masterid=".$masterid." ";
			$db->Setquery($sql_terms);
			$terms_data = $db->loadObject();
			
			if( $terms_data->accepted == '1' || $terms_data->accepted == '0' ){
			if( !$terms_data->firstname || !$terms_data->lastname || !$terms_data->update_date ){
				$sql_unme = "SELECT name, lastname FROM #__users where id=".$vendorid." ";
				$db->Setquery($sql_unme);
				$name_vendor = $db->loadObject();
				$firstname = $name_vendor->name ;
				$lastname = $name_vendor->lastname ;
				$datef = '2015-06-22 13:00:00';
			}
			else{
				$firstname = $terms_data->firstname ;
				$lastname = $terms_data->lastname ;
				$datef = $terms_data->update_date;
			}
			
			$date = explode(' ',$datef);
			$date_mdy = explode('-',$date[0]);
			$time = date("h:i A", strtotime($date[1]));
			
			if( $terms_data->accepted == '1' )
			$result = "Terms & Conditions: <font color='#77b800'>Accepted</font> on ".$date_mdy[1]."/".$date_mdy[2]."/".$date_mdy[0]." at ".$time." by ".$firstname."&nbsp;".$lastname."";
			else
			$result = "Terms & Conditions: <font color='red'>Declined</font> on ".$date_mdy[1]."/".$date_mdy[2]."/".$date_mdy[0]." at ".$time." by ".$firstname."&nbsp;".$lastname."";
			}
			else{
				$user	= JFactory::getUser();
				if( $user->user_type == '11' )
				$result = "You have not read Terms & Conditions";
				else
				$result = "Terms & Conditions: <font color='red'>Unread</font>";
			
			}
			
			return $result;
		}
//sreenu
	
	function sendinvitation(){
	$accept = JRequest::getVar('accept');
	$db  = JFactory::getDBO();
	$user = JFactory::getUser();
	$today = date('Y-m-d');
	$subject = JRequest::getVar('subject','');
    $data['vendoremailid'] = JRequest::getVar('email','');
	$data['accept'] = JRequest::getVar('accept');
	$data['propertyid'] = JRequest::getVar('property_name');
	$chceckclient = "SELECT id FROM #__cam_board_mem where email='".$data['vendoremailid']."' AND property_name='".$data['propertyid']."' AND user_id='".$user->id."'";
	$db->setQuery( $chceckclient );
	$chceckclient = $db->loadResult();
	if( $chceckclient)
	{
		$query = "UPDATE #__cam_board_mem SET date = '".$today."' WHERE id ='".$data['boardmemeberid']."'"; 
		$db->setQuery($query);
		$db->query();
	}
	else
	{
		$model = $this->getModel('vendorscenter');
		$save = $model->getsavedetails($data);
    
	}
	$redirect = '<a href="'.JURI::root().'index.php">CLICK HERE </a>';
	//To get the manager company name
	$companyname = "SELECT comp_name  FROM #__cam_customer_companyinfo where cust_id=".$user->id."";
	$db->setQuery( $companyname );
	$c_name = $db->loadResult();
	//Completed
	    $managerid ="SELECT managerid FROM #__cam_manager_emailtext where managerid=".$user->id."";
		$db->setQuery( $managerid );
		$managerid = $db->loadResult();
		if($managerid)
		$body ="SELECT email_text FROM #__cam_manager_emailtext where managerid=".$user->id."";
		else
	    $body ="SELECT introtext  FROM #__content where id='316'";
		$db->setQuery( $body );
		$body = $db->loadResult();
		$body = html_entity_decode($body);
		$body = str_replace("[Manager's Full Name]",$user->name.' '.$user->lastname,$body);
		$body = str_replace("[Manager's Primary Phone Number]",$user->phone,$body);
		$body = str_replace('[Management Company]',$c_name,$body);
		$body = str_replace('CLICK HERE',$redirect,$body);
		$mailfrom = $user->email;
		$fromname = $user->name.' '. $user->lastname;
		$rizeemail = 'rize.cama@gmail.com';
		//$assignuseremail = 'support@myvendorcenter.com';
		//$mailsubject = 'Property Owner Invitation';
		$assignuseremail = JRequest::getVar('email','');
		
		$mailsubject = JRequest::getVar('subject','');
		$mailfrom = $user->email ;
		$res = JUtility::sendMail($mailfrom, $fromname, $rizeemail, $mailsubject, $body, $mode = 1);
		$res = JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
		
		//To send the mail to CC
		$cc = JRequest::getVar('ccemail','');
		$cclist = explode(';',$cc);
		for($c=0; $c<=count($cclist); $c++){
		$listcc = $cclist[$c];
		if($listcc){
		$res = JUtility::sendMail($mailfrom, $fromname, $listcc, $mailsubject, $body, $mode = 1);
		}
		}
		//To CC
		$ccemail = 'vendoremails@myvendorcenter.com';
		//$res = JUtility::sendMail($mailfrom, $fromname, $ccemail, $mailsubject, $body, $mode = 1);
		$link = "index.php?option=com_camassistant&controller=boardmembers&task=listboardmembers&Itemid=151";
		$msg="Property Owner Invitation has been sent successfully.";
		$this->setRedirect( $link,$msg );
	}
	
	

	function usercheck()
	{
	$db =& JFactory::getDBO();
	$mail = JRequest::getVar('mailid','');
	$query_email = "SELECT username FROM #__users WHERE  username='".$mail."'";
	$db->setQuery( $query_email );
	$result_email = $db->loadResult();
	if($result_email)
	$msg=1;
	else
	$msg=0;
	echo $msg; 
	exit;
	
	}
	
function checktoallemails()
	{
	$db =& JFactory::getDBO();
	$mail = JRequest::getVar('mailid','');
	$query_email = "SELECT username FROM #__users WHERE  username='".$mail."' AND ( user_type='11' OR user_type='12' OR user_type='13' )";
	$db->setQuery( $query_email );
	$result_email = $db->loadResult();
	if($result_email)
	$msg=1;
	else
	$msg=0;
	
	echo $msg; 
	exit;
	
	}
	
	function checkpropertyowneraccount()
	{
	$db =& JFactory::getDBO();
	$mail = JRequest::getVar('mailid','');
	$query_email="SELECT id FROM #__users WHERE username='".$mail."' AND user_type='16'";
	$db->setQuery( $query_email );
	$result_email = $db->loadResult();
	if($result_email)
	$msg = 1;
	else
	$msg=0;
	
	echo $msg; 
	exit;
	
	}

	
	function property_check()
	{
	$db =& JFactory::getDBO();
	$pid = JRequest::getVar('property_id','');
	$getpid = "SELECT property_name FROM #__cam_property WHERE id='".$pid."' AND property_link = '1'";
	$db->setQuery( $getpid );
	$result = $db->loadResult();
	if($result)
	$msg=1;
	else
	$msg=0;
	
	echo $msg; 
	exit;
	
	}
	
	
	function hideinvitation(){
	
			$db =& JFactory::getDBO();
			$hideid = JRequest::getVar('hideid','');
			$user=JFactory::getUser();
			$hidemail = explode('-',$hideid);
			$update_hide = "UPDATE #__cam_board_mem  SET  published='1' where user_id=".$user->id." and email ='".$hidemail[1]."' ";
			$db->setQuery($update_hide);
			$hide = $db->query();
			if($hide)
			$msg="yes";
			else
			$msg="no";
			echo $msg; 
			exit;
	}
	
		
	function resendinvitation()
	{
		$db= JFactory::getDBO();
		$user=JFactory::getUser();
		$assignuseremail = JRequest::getVar('email','');
		$redirect = '<a href="'.JURI::root().'index.php">CLICK HERE </a>';
			//To get the manager company name
			$companyname = "SELECT comp_name  FROM #__cam_customer_companyinfo where cust_id=".$user->id." ";
			$db->setQuery( $companyname );
			$c_name = $db->loadResult();
			//Completed
			$managerid ="SELECT managerid FROM #__cam_manager_emailtext where managerid=".$user->id."";
			$db->setQuery( $managerid );
			$managerid = $db->loadResult();
			if($managerid)
			$body ="SELECT email_text FROM #__cam_manager_emailtext where managerid=".$user->id."";
			else
			$body ="SELECT introtext  FROM #__content where id='316'";
			$db->setQuery( $body );
			$body = $db->loadResult();
			$body = html_entity_decode($body);
			$body = str_replace("[Manager's Full Name]",$user->name.' '.$user->lastname,$body);
			$body = str_replace("[Manager's Primary Phone Number]",$user->phone,$body);
			$body = str_replace('[Management Company]',$c_name,$body);
			$body = str_replace('CLICK HERE',$redirect,$body);
			$fromname = $user->name.' '. $user->lastname;
			$rizeemail = 'rize.cama@gmail.com';
			//$assignuseremail = 'support@myvendorcenter.com';
			$mailsubject = 'Registration Invitation From Manager';
			$mailfrom = $user->email ;
			$res = JUtility::sendMail($mailfrom, $fromname, $rizeemail, $mailsubject, $body, $mode = 1);
			$res = JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
			//To send the mail to CC
			$cc = JRequest::getVar('ccemail','');
			$cclist = explode(';',$cc);
			for($c=0; $c<=count($cclist); $c++){
			$listcc = $cclist[$c];
			if($listcc){
			$res = JUtility::sendMail($mailfrom, $fromname, $listcc, $mailsubject, $body, $mode = 1);
			}
			}
			//To CC
			$ccemail = 'vendoremails@myvendorcenter.com';
			//$res = JUtility::sendMail($mailfrom, $fromname, $ccemail, $mailsubject, $body, $mode = 1);
			$link = "index.php?option=com_camassistant&controller=boardmembers&task=listboardmembers&Itemid=151";
			
			$update_hide = "UPDATE #__cam_board_mem SET date='".date('Y-m-d H:i')."' where email ='".$assignuseremail."' and user_id=".$user->id." ";
			$db->setQuery($update_hide);
			$hide = $db->query();
			echo "success";
			exit;
	 }
	function save_permissions()
	{
	$db = JFactory::getDBO();
	$user = JFactory::getUser();
	$proposals_p = JRequest::getVar('vendor_proposals','');
	$vendors_p = JRequest::getVar('myvendor_list','');
	$invite_p = JRequest::getVar('invite_vendors','');
	$approval_p = JRequest::getVar('approval_request','');
	$awarding_p = JRequest::getVar('approval_awarding','');
    $board_position = JRequest::getVar('board_position','');
    $property_id = JRequest::getVar('pid','');
	$bid = JRequest::getVar('bid','');
	$per['user_id'] = $user->id;
	$per['propertyowner_id']= JRequest::getVar('propertyowner_id','');	
   $query = "UPDATE #__cam_propertyowner_link SET proposals_p = '".$proposals_p."',vendors_p = '".$vendors_p."',invite_p = '".$invite_p."' ,approval_p = '".       $approval_p."', awarding_p = '".$awarding_p."' WHERE boardmem_id ='".$bid."'"; 
	$db->setQuery($query);
	$db->query();
	$query1 = "UPDATE #__cam_board_mem SET enablemail='yes',board_position='".$board_position."' where id ='".$bid."'"; 
	$db->setQuery($query1);
	$db->query();
	$msg= 'Client information has updated successfully';
	$url="index.php?option=com_camassistant&controller=boardmembers&task=listboardmembers&Itemid=151";;
	$this->setRedirect($url,$msg);
	
	}
	function useremail()
	{
	$db =& JFactory::getDBO();
	$mail = JRequest::getVar('mailid','');
	$query_email="SELECT username FROM #__users WHERE username='".$mail."' AND user_type = '16' ";
	$db->setQuery( $query_email );
	$result_email = $db->loadResult();
	if($result_email)
	$msg=1;
	else
	$msg=0;
	
	echo $msg; 
	exit;
	
	}
	function unlink_property()
	{
	$db =& JFactory::getDBO();
	$user = & JFactory::getUser();
	$pid = JRequest::getVar('propertyid1','');
	$bid = JRequest::getVar('bid','');
	$link = "UPDATE #__cam_propertyowner_link SET link_value = '2',vendors_p = '0',proposals_p='0',invite_p='0',approval_p='0',awarding_p='0' WHERE property_id ='".$pid."' AND boardmem_id='".$bid."'"; 
	$db->setQuery($link);
	$db->query();
	$link = 'index.php?option=com_camassistant&controller=boardmembers&task=listboardmembers&Itemid=151';
	$msg="Property unlinked sucessfully";
	$this->setRedirect( $link,$msg );
	}
	function editpropertyinfo()
	{
	    $db= JFactory::getDBO();
	    $user=JFactory::getUser();	
		$id = JRequest::getVar('bid','');
		$post = JRequest::get('post');
		$post['phone'] = $post['phone_1'].'-'.$post['phone_2'].'-'.$post['phone_3'];
		$post['altphone'] = $post['altphone_1'].'-'.$post['altphone_2'].'-'.$post['altphone_3'];
		$post['fax'] = $post['fax_1'].'-'.$post['fax_2'].'-'.$post['fax_3'];
		$db = JFactory::getDBO();
		$update = "UPDATE #__cam_board_mem SET board_position='".$post['board_position']."',salutation='".$post['salutation']."',firstname='".$post['firstname']."',lastname='".$post['lastname']."',altphone='".$post['altphone']."',altextension='".$post['altextension']."',streeaddress='".$post['streeaddress']."',state='".$post['state']."',altemail='".$post['altemail']."',email ='".$post['email']."',zipcode='".$post['zipcode']."',phone='".$post['phone']."',extension='".$post['extension']."', fax = '".$post['fax']."' where id ='".$id."'";
		$db->setQuery($update);
		$res=$db->query();
		if($res){
          $msg ="";
		  $link = 'index.php?option=com_camassistant&controller=boardmembers&task=listboardmembers&Itemid=151';
		  $this->setRedirect( $link,$msg );
         } 
	
	}
    function checkpropertylink()
	{
	    $db= JFactory::getDBO();
	    $user=JFactory::getUser();	
		$pid = JRequest::getVar('property_id','');
		$query_email="SELECT property_name FROM #__cam_property WHERE id='".$pid."' AND property_link='1'";
		$db->setQuery( $query_email );
		$result_email = $db->loadResult();
		if($result_email)
		$msg=1;
		else
		$msg=0;
		
		echo $msg; 
		exit;
	}
	function save_awardedemail(){
		$db =&JFactory::getDBO();
		$user = &JFactory::getUser();
		$mailtext['managerid'] = $user->id;
		$emailtest = JRequest::getVar('mailtext','');
		$emailtest = htmlentities($_REQUEST['mailtext'], ENT_QUOTES);
		$emailtest = str_replace('\&quot','&quot',$emailtest);
		$emailtest = str_replace('\\','',$emailtest);
		$mailbody = $emailtest;
		$mailtext['email_text'] = $mailbody;
		$model = $this->getModel('vendorscenter');
		$preid = $model->getexistingid($mailtext['managerid']);
		if($preid->id)
		$mailtext['id'] = $preid->id;
		else
		$mailtext['id'] = '';
		$model->store_mailtext($mailtext);
		$url ='index.php?option=com_camassistant&controller=vendorscenter&task=promanagerinvitation&Itemid=151&accept=yes';
		$this->setRedirect($url);
		
		//echo "<pre>"; print_r($_REQUEST); exit;
	}
	
	function sendinvitationtoclient()
	{
	    $db =&JFactory::getDBO();
		$user = &JFactory::getUser();
		$propertyid = JRequest::getVar('pid','');
        $boardmemeberid = JRequest::getVar('bid','');
        $propertyname = JRequest::getVar('propertyname','');
        $clientemail = JRequest::getVar('email','');
		$title1 = JRequest::getVar('title','');
        $propertyownerid = JRequest::getVar('propertyownerid','');
		$pinfo['user_id']=$user->id;
		$pinfo['property_name']=$propertyname;
		$pinfo['email']= $clientemail;
		$pinfo['link_value']='';
		$pinfo['property_id']=$propertyid;
		$pinfo['propertyowner_id']=$propertyownerid;
		$pinfo['propertyinvitation']='2';
		if($title1)
		$title = $title1;
		else
		{
		$title2 = "SELECT board_position FROM #__cam_board_mem where id=".$boardmemeberid."";
		$db->setQuery( $title2 );
		$title = $db->loadResult();
		}	
		$model	=& $this->getModel('vendorscenter');
		$checkstatus = $model->checkclientavailable($propertyid,$propertyownerid);
		if($checkstatus)
		{
		$updateclient = "UPDATE #__cam_propertyowner_link SET propertydecline='0' WHERE property_id ='".$propertyid."' AND propertyowner_id='".$propertyownerid."'"; 
	    $db->setQuery($updateclient);
	    $db->query();
		}
		else
		{
        $query = "insert into #__cam_board_mem (id,user_id,email,property_name,link_invite,board_position) VALUES ('','".$user->id."','".$clientemail."','".$propertyid."','2','".$title."')";
	    $db->setQuery($query);
	    $savedata = $db->query();	
		$pinfo['boardmem_id']  = $db->insertid();
		$model->updatepropertyinfo($pinfo);
		
	     }
		$companyname = "SELECT comp_name FROM #__cam_customer_companyinfo where cust_id=".$user->id." ";
		$db->setQuery( $companyname );
		$c_name = $db->loadResult();
		$body ="SELECT introtext FROM #__content where id='317'";
		$db->setQuery( $body );
		$body = $db->loadResult();
		$body = str_replace('[Manager Full Name]',$user->name.' '.$user->lastname,$body);
		$body = str_replace("[Manager's Company Name]",$c_name,$body);
		$body = str_replace('[Property Name]',str_replace('_',' ',$propertyname),$body);
		
		$mailfrom = $user->email;
		$fromname = $user->name.' '. $user->lastname;
		$assignuseremail = 'rize.cama@gmail.com';
		$assignuseremail = 'support@myvendorcenter.com';
		$mailsubject = 'Property Invitation From Manager';
		$res = JUtility::sendMail($mailfrom, $fromname, $clientemail, $mailsubject, $body, $mode = 1);
		$rize_mail = 'rize.cama@gmail.com';
		$res = JUtility::sendMail($mailfrom, $fromname, $rize_mail, $mailsubject, $body, $mode = 1);
		echo "<script language='javascript' type='text/javascript'>
		window.parent.document.getElementById( 'sbox-window' ).close();
		window.parent.parent.location.reload();</script>";
		
		}
		
		
   function sendregisterinvitation(){
	   
		$accept = JRequest::getVar('accept');
		$db  = JFactory::getDBO();
		$user = JFactory::getUser();
		$today = date('Y-m-d');
		$data['email'] = JRequest::getVar('email','');
		$data['propertyid'] = JRequest::getVar('propertyid','');
		$data['boardmemeberid'] = JRequest::getVar('bid','');
		$subject = JRequest::getVar('subject','');
		$model = $this->getModel('vendorscenter');
	    $chceckid = "SELECT id FROM #__cam_propertyowner_link where boardmem_id='".$data['boardmemeberid']."'";
		$db->setQuery(  $chceckid );
		$chceckid = $db->loadResult();
	
		if( $chceckid )
        { 
			$query = "UPDATE #__cam_board_mem SET date = '".$today."' WHERE id ='".$data['boardmemeberid']."'"; 
			$db->setQuery($query);
			$db->query();
		}
		else
		{
		  $save = $model->saveinvitationdetails($data);
        }
		
		$upadte = "UPDATE #__cam_board_mem SET accept = 'yes' WHERE id ='".$data['boardmemeberid']."'"; 
		$db->setQuery($upadte);
		$db->query();
		$redirect = '<a href="'.JURI::root().'index.php">CLICK HERE </a>';
		//To get the manager company name
		$companyname = "SELECT comp_name  FROM #__cam_customer_companyinfo where cust_id=".$user->id." ";
		$db->setQuery( $companyname );
		$c_name = $db->loadResult();
		//Completed
	    $managerid ="SELECT managerid FROM #__cam_manager_emailtext where managerid=".$user->id."";
		$db->setQuery( $managerid );
		$managerid = $db->loadResult();
		if($managerid)
		$body ="SELECT email_text FROM #__cam_manager_emailtext where managerid=".$user->id."";
		else
	    $body ="SELECT introtext  FROM #__content where id='316'";
		$db->setQuery( $body );
		$body = $db->loadResult();
		$body = html_entity_decode($body);
		$body = str_replace("[Manager's Full Name]",$user->name.' '.$user->lastname,$body);
		$body = str_replace("[Manager's Primary Phone Number]",$user->phone,$body);
		$body = str_replace('[Management Company]',$c_name,$body);
		$body = str_replace('CLICK HERE',$redirect,$body);
		$fromname = $user->name.' '. $user->lastname;
		$rizeemail = 'rize.cama@gmail.com';
		//$assignuseremail = 'support@myvendorcenter.com';
		$mailsubject = 'Property Owner Invitation';
		$assignuseremail = $data['email'];
        $mailsubject = JRequest::getVar('subject','');
		$mailfrom = $user->email ;
		$res = JUtility::sendMail($mailfrom, $fromname, $rizeemail, $mailsubject, $body, $mode = 1);
		$res = JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
		//To send the mail to CC
		$cc = JRequest::getVar('ccemail','');
		$cclist = explode(';',$cc);
		for($c=0; $c<=count($cclist); $c++){
		$listcc = $cclist[$c];
		if($listcc){
		$res = JUtility::sendMail($mailfrom, $fromname, $listcc, $mailsubject, $body, $mode = 1);
		}
		}
		//To CC
		$ccemail = 'vendoremails@myvendorcenter.com';
		//$res = JUtility::sendMail($mailfrom, $fromname, $ccemail, $mailsubject, $body, $mode = 1);
		$link = "index.php?option=com_camassistant&controller=boardmembers&task=listboardmembers&Itemid=151";
		$msg="Client Invitation has been sent successfully.";
		$this->setRedirect( $link,$msg );
	}
	
	function saveboardposition()
	{
		$db  = JFactory::getDBO();
		$board_position = JRequest::getVar('board_position','');
		$id = JRequest::getVar('bid','');
		 $query = "UPDATE #__cam_board_mem SET board_position = '".$board_position."' WHERE id ='".$id."'"; 
		$db->setQuery($query);
		$db->query();
		$link = "index.php?option=com_camassistant&controller=addproperty&Itemid=75";
		$msg="";
		$this->setRedirect( $link,$msg );
	}
	
	function addpreferredvendor(){
	$model = $this->getModel('vendorscenter');	
	$db =& JFactory::getDBO();
	$vendorid = JRequest::getVar( 'vendorid','');
	
	$action_type = JRequest::getVar( 'actype','');
	$prevendor = JRequest::getVar( 'prevendor','');
	$user	= JFactory::getUser();
	$vendors = explode(',',$vendorid);
	
	for( $i=0; $i<count($vendors); $i++ ){
	// To check if is there any pre invitations to same user
	$checkvendor = "SELECT vid FROM #__vendor_inviteinfo where userid =".$user->id." and v_id=".$vendors[$i]." ";
	$db->setQuery($checkvendor);
	$exist = $db->loadResult();
    if($exist){
	if( $prevendor == 1 ){
	   $query1 = "UPDATE #__vendor_inviteinfo SET invitation_type  = 'pre' where userid =".$user->id." and v_id=".$vendors[$i].""; 
			$db->setQuery($query1);
			$db->query();
	 if( $user->user_type == '13' && $user->accounttype == 'master'){
				$sendmail = $model->sendmailtovendor($vendors[$i]);
			}
	 
	 }
		if($action_type == 'exclude'){
			$query = "UPDATE #__vendor_inviteinfo SET search = 'yes' WHERE vid ='".$exist."'"; 
			$db->setQuery($query);
			$db->query();
		}
	echo "already";
	
	}	
	
	else {
		// To get the company id
		$taxid = $model->getcompanyid($user->id,$user->user_type);
		//Completed
		//$email = JRequest::getVar( 'emailid',''); 
		$checkvendor_email = "SELECT email FROM #__users where id =".$vendors[$i]." ";
		$db->setQuery($checkvendor_email);
		$email = $db->loadResult();
		
		
		$from_email = $user->email;
		$post['userid'] = $user->id ;
		$post['v_id'] = $vendors[$i];
		$post['taxid'] = $taxid;
		$post['licenseno'] = '';
		$post['vendortype'] = 'preferred';
		$post['fei'] = '';
		$post['inhousevendors'] = $email;
		$post['inhouse'] = $email;
		$post['subject'] = "Preferred invitation from camfirm";
		$post['inhousetext'] = "Preferred invitation from camfirm";
		$post['status'] = 1;
		$post['invitation_type'] = 'pre';
		$post['invitedate'] = date('Y-m-d h:i:m');;
		if($action_type == 'exclude') {
		$post['search'] = 'yes';
		$post['exclude'] = 'yes';
		}
		else {
		$post['search'] = '';
		$post['exclude'] = '';
		}
		$save = $model->store_newadd($post);
			if( $user->user_type == '13' && $user->accounttype == 'master'){
				$sendmail = $model->sendmailtovendor($post['v_id']);
			}
		if($save){
		echo "added" ;
		}
		else{
		echo "fail";
		}
		
		}
		}
		exit;
	}
	
	
	function addmyvendortopreferredvendor(){
	$model = $this->getModel('vendorscenter');	
	$db =& JFactory::getDBO();
	$vendorid = JRequest::getVar( 'vendorid','');
	
	$action_type = JRequest::getVar( 'actype','');
	$prevendor = JRequest::getVar( 'prevendor','');
	$user	= JFactory::getUser();
	$vendors = explode(',',$vendorid);
	
	for( $i=0; $i<count($vendors); $i++ ){
	// To check if is there any pre invitations to same user
	$checkvendor = "SELECT vid FROM #__vendor_inviteinfo where userid =".$user->id." and v_id=".$vendors[$i]." ";
	$db->setQuery($checkvendor);
	$exist = $db->loadResult();
    if($exist){
	if( $prevendor == 1 ){
	   $query1 = "UPDATE #__vendor_inviteinfo SET invitation_type  = 'pre' where userid =".$user->id." and v_id=".$vendors[$i].""; 
	   $db->setQuery($query1);
	   $db->query();
	   $query2 = "UPDATE #__vendor_inviteinfo SET myvendors = 'yes' WHERE vid ='".$exist."'"; 
	   $db->setQuery($query2);
	   $db->query();		
			
	 if( $user->user_type == '13' && $user->accounttype == 'master'){
				$sendmail = $model->sendmailtovendor($vendors[$i]);
			}
	 
	 }
		if($action_type == 'exclude'){
			$query = "UPDATE #__vendor_inviteinfo SET search = 'yes' WHERE vid ='".$exist."'"; 
			$db->setQuery($query);
			$db->query();
		}
	echo "already";
	
	}	
	
	else {
		// To get the company id
		$taxid = $model->getcompanyid($user->id,$user->user_type);
		//Completed
		//$email = JRequest::getVar( 'emailid',''); 
		$checkvendor_email = "SELECT email FROM #__users where id =".$vendors[$i]." ";
		$db->setQuery($checkvendor_email);
		$email = $db->loadResult();
		
		
		$from_email = $user->email;
		$post['userid'] = $user->id ;
		$post['v_id'] = $vendors[$i];
		$post['taxid'] = $taxid;
		$post['licenseno'] = '';
		$post['vendortype'] = 'preferred';
		$post['fei'] = '';
		$post['inhousevendors'] = $email;
		$post['inhouse'] = $email;
		$post['subject'] = "Preferred invitation from camfirm";
		$post['inhousetext'] = "Preferred invitation from camfirm";
		$post['status'] = 1;
		$post['invitation_type'] = 'pre';
		$post['invitedate'] = date('Y-m-d h:i:m');;
		if($action_type == 'exclude') {
		$post['search'] = 'yes';
		$post['exclude'] = 'yes';
		}
		else {
		$post['search'] = '';
		$post['exclude'] = '';
		}
		$save = $model->store_newadd($post);
			if( $user->user_type == '13' && $user->accounttype == 'master'){
				$sendmail = $model->sendmailtovendor($post['v_id']);
			}
		if($save){
		echo "added" ;
		}
		else{
		echo "fail";
		}
		
		}
		}
		exit;
	}
	
	
	function removevendor_list(){
	$user	= JFactory::getUser();
	$db =& JFactory::getDBO();
	$vendorid = JRequest::getVar( 'vendorid','');
	$vendors = explode(',',$vendorid);
	for( $i=0; $i<count($vendors); $i++ ){
	// To check if is there any pre invitations to same user
	$checkvendor = "SELECT vid FROM #__vendor_inviteinfo where userid =".$user->id." and v_id=".$vendors[$i]."  and invitation_type='pre'";
	$db->setQuery($checkvendor);
	$exist = $db->loadResult();
	
	$per_vendor = "SELECT id FROM #__cam_vendor_purchasedcodes where masterid ='".$user->id."' and vendorid =".$vendors[$i]." and publish=1";
	$db->setQuery($per_vendor);
	$per_vendor = $db->loadResult();
   
    if($exist || $per_vendor ){
	
	   $query2 = "UPDATE #__vendor_inviteinfo SET myvendors = 'no' WHERE userid =".$user->id." and v_id=".$vendors[$i]." "; 
	   $db->setQuery($query2);
	   $db->query();		
	}
	else {
	$query_delete = "DELETE FROM #__vendor_inviteinfo WHERE  v_id=".$vendors[$i]."  and userid=".$user->id." " ;
	$db->setquery($query_delete);
	$del = $db->query();
	}	
	if($del) {
	echo "1";
	}
	else{
	echo "0";
	}
 }		
	exit;
	}
	
function removevendor_preferredlist(){
	$user	= JFactory::getUser();
	$db =& JFactory::getDBO();
	$vendorid = JRequest::getVar( 'vendorid','');
	$vendors = explode(',',$vendorid);
	for( $i=0; $i<count($vendors); $i++ ){
	// To check if is there any pre invitations to same user
	$checkvendor = "SELECT v_id FROM #__vendor_inviteinfo where userid =".$user->id." and vid=".$vendors[$i]."  and myvendors='yes'";
	$db->setQuery($checkvendor);
	$exist = $db->loadResult();
	
    if($exist ){
	   $query2 = "UPDATE #__vendor_inviteinfo SET invitation_type = '' WHERE userid =".$user->id." and v_id=".$exist.""; 
	   $db->setQuery($query2);
	   $db->query();		
	}
	else {
	$query_delete = "DELETE FROM #__vendor_inviteinfo WHERE  vid=".$vendors[$i]."" ;
	$db->setquery($query_delete);
	$del = $db->query();
	}	
	if($del) {
	echo "1";
	}
	else{
	echo "0";
	}
 }		
	exit;
	}	
	
	
function addtomyvendor(){
	$user	= JFactory::getUser();
	$db =& JFactory::getDBO();
	$vendorid = JRequest::getVar( 'vendorid','');
	$update = "UPDATE #__vendor_inviteinfo SET myvendors='yes' WHERE vid IN (".$vendorid.") and userid=".$user->id."" ;
	$db->setquery($update);
	$upd = $db->query();
	if($upd) {
	echo "1";
	}
	else{
	echo "0";
	}
 	
	exit;
	}	
	
	
	function check_preferredvendor(){
	$model = $this->getModel('vendorscenter');	
	$db =& JFactory::getDBO();
	$vendorid = JRequest::getVar( 'vendorid','');
	$user	= JFactory::getUser();
	$vendors = explode(',',$vendorid);
	for( $i=0; $i<count($vendors); $i++ ){
	// To check if is there any pre invitations to same user
	$checkvendor = "SELECT vid FROM #__vendor_inviteinfo where userid =".$user->id." and v_id=".$vendors[$i]." and invitation_type='pre'";
	$db->setQuery($checkvendor);
	$exist = $db->loadResult();
	if($exist){
	$exist_array [] = $exist;
	}
	$per_vendor = "SELECT id FROM #__cam_vendor_purchasedcodes where masterid ='".$user->id."' and vendorid =".$vendors[$i]." and publish=1";
	$db->setQuery($per_vendor);
	$per_vendor = $db->loadResult();
	if($per_vendor){
	$per_vendor_array[] = $per_vendor;
	}
	}	
    if(count($exist_array) >0 || count($per_vendor)>0 ){
	echo '1';
	}
	else{
	echo '0';
	}
	
 exit;
}	
function check_myvendorlist(){
	$model = $this->getModel('vendorscenter');	
	$db =& JFactory::getDBO();
	$vendorid = JRequest::getVar( 'vendorid','');
	$user	= JFactory::getUser();
	$vendors = explode(',',$vendorid);
	for( $i=0; $i<count($vendors); $i++ ){
	// To check if is there any pre invitations to same user
	$checkvendor = "SELECT v_id FROM #__vendor_inviteinfo where userid =".$user->id." and vid=".$vendors[$i]." and myvendors='yes'";
	$db->setQuery($checkvendor);
	$exist = $db->loadResult();
	if($exist){
	$exist_array [] = $exist;
	}
	}
	if( count($exist_array) >0 ){
	echo '1';
	}
	else{
	echo '0';
	}
 exit;
}	
	
}
?> 
