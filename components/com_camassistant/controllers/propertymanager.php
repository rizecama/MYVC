<?php
/**
 * @version		1.0.0 camassistant $
 * @package		camassistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport('joomla.application.component.controller');

class propertymanagerController extends JController
{

 	function __construct()
	{
		parent::__construct();
	}

 	function display()
	{
		//echo "5454";exit;
		JRequest::getVar('view','propertymanager');
		parent::display();
	}
	function invitemanager() {
	
	 JRequest::getVar('view','propertymanager');
	   parent::display();
	}
 	/*function submit_licid()
	{
	//echo "<pre>";print_r($_REQUEST);exit;
	JRequest::getVar('view','propertymanager');
	parent::display();
	}
 	function submit_companyinfo()
	{
	
	JRequest::getVar('view','propertymanager');
	parent::display();
	}
	*/
	function customer_edit_form()
	{
	   JRequest::getVar('view','propertymanager');
	   parent::display();
	}
	
	function verfiryuser()
	{
		$db =& JFactory::getDBO();
		$Email=$_POST['queryString'];
		
		if ($Email != "")
		{
		$query_email="SELECT username FROM #__users WHERE username='".$Email."' or email='".$Email."' ";
		$db->setQuery( $query_email );
		$result_email = $db->loadResult();
		//print_r($result_email);
		if ($result_email){ $data="invalid"; }}
		echo $data;
		exit;
   }
	function verfirytaxid1()
	{

		$db =& JFactory::getDBO();
		$Taxid=$_POST['queryString'];
		
		if ($Taxid != "")
		{
		$query_Taxid="SELECT tax_id FROM #__cam_vendor_company  WHERE tax_id='".$Taxid."'";
		$db->setQuery( $query_Taxid );
		$result_tax = $db->loadResult();
		
//Checking for exclude or  not
		$query_exclude="SELECT licenseno FROM #__vendor_inviteinfo  WHERE taxid='".$Taxid."' AND vendortype = 'exclude'";
		$db->setQuery($query_exclude);
		$result_exclude = $db->loadResult();
//Checking for exclude or  not		
		//print_r($result_email);
		if($result_exclude && $result_tax ){
		 $data="excluded"; 
		 }
		 else if($result_tax ){
		 $data="invalid"; 
		 }
		 }
		echo $data;
		exit;
   }
	//Verify taxid
	function verfirytaxid()
	{

		$db =& JFactory::getDBO();
		$Taxid=$_POST['queryString'];
		
		if ($Taxid != "")
		{
		$query_Taxid="SELECT tax_id FROM #__cam_vendor_company  WHERE tax_id='".$Taxid."'";
		$db->setQuery( $query_Taxid );
		$result_tax = $db->loadResult();
		$license_id="SELECT camfirm_license_no FROM #__cam_camfirminfo WHERE camfirm_license_no='".$Taxid."'";
		$db->setQuery($license_id);
		$license_id = $db->loadResult();
//Checking for exclude or  not
		$query_exclude="SELECT licenseno FROM #__vendor_inviteinfo  WHERE taxid='".$Taxid."' AND vendortype = 'exclude'";
		$db->setQuery($query_exclude);
		$result_exclude = $db->loadResult();
//Checking for exclude or  not		
		//print_r($result_email);
		if($result_exclude && ($result_tax || $license_id)){
		 $data="excluded"; 
		 }
		 else if($result_tax || $license_id){
		 $data="invalid"; 
		 }
		 }
		echo $data;
		exit;
   }
	//Completed
	/*function company_edit_form()
	{
	   JRequest::getVar('view','propertymanager');
	   parent::display();
	}*/
	function invitesubmit () {
//	echo "<pre>"; print_r($_REQUEST); exit;
		$task = JRequest::getVar("task",'');
		$assignuseremail = JRequest::getVar("to",'');
	    
		//$userid = JRequest::getVar("user_id",'');
		$userid = JRequest::getVar("firmid",'');
		$user =& JFactory::getUser();
		$db =& JFactory::getDBO();
		if($user->user_type == 12 && $user->dmanager == 'yes'){
		$fcompid = "SELECT comp_id  FROM #__cam_customer_companyinfo  where cust_id=".$user->id." "; 
		$db->Setquery($fcompid);
		$cmnyid = $db->loadResult();

		$scompid = "SELECT cust_id  FROM #__cam_camfirminfo  where id=".$cmnyid." "; 
		$db->Setquery($scompid);
		$user_id = $db->loadResult();
		$dmanager = $user->id;
		}
		else{
		//$user_id = JRequest::getVar("user_id",'');
		$user_id = JRequest::getVar("firmid",'');
		$dmanager = '';
		}
		
		$cc1 = JRequest::getVar("cc",'');
		$bcc = JRequest::getVar("bcc",'');
		$note = JRequest::getVar("note",'');
		$mailsubject = JRequest::getVar("subject",'');
		$body1 =JRequest::getVar( 'body', '', 'post', 'string', JREQUEST_ALLOWHTML );
	  // $body_content = str_replace('{Property Manager Name}',$mailfrom,$body1) ;
		$db =& JFactory::getDBO();
		
		//To get the camfirm id
		if($user->user_type == 13){
		$userid = $userid;
		}
		else if($user->user_type == 12 && $user->dmanager == 'yes'){
		$fcompid = "SELECT comp_id  FROM #__cam_customer_companyinfo  where cust_id=".$user->id." "; 
		$db->Setquery($fcompid);
		$cmnyid = $db->loadResult();

		$scompid = "SELECT cust_id  FROM #__cam_camfirminfo  where id=".$cmnyid." "; 
		$db->Setquery($scompid);
		$userid = $db->loadResult();
		
		}
		else{
		
		}	
		//Completed
		
		$query = "SELECT C.tax_id,C.camfirm_license_no,C.comp_name,U.email,U.name,U.lastname FROM #__cam_camfirminfo as C LEFT JOIN #__users as U ON U.id=C.cust_id where C.cust_id ='$userid'"; 
		$db->setQuery($query);
		$pfiles=$db->loadObjectlist();
		if($pfiles[0]->camfirm_license_no==''){
		$tax_id = $pfiles[0]->tax_id;
		$link = 'index.php?option=com_camassistant&controller=propertymanager&view=propertymanager&tax_id='.$tax_id.'&from=invitation&Itemid=57';
		} 
		else {
		$camfirm_license_no = $pfiles[0]->camfirm_license_no;
		$link = 'index.php?option=com_camassistant&controller=propertymanager&view=propertymanager&camfirm_license_no='.$camfirm_license_no.'&from=invitation&Itemid=57';
		}
		$sitename =JURI::base();
		$link1=$sitename.$link;
		$manage = $pfiles[0]->comp_name;
		$name=$pfiles[0]->name;
		$lastname=$pfiles[0]->lastname;
		$fromname = $name.' '.$lastname; 
		$mailfrom = $pfiles[0]->email;
		$body_content = str_replace('{MANAGER INVITATION LINK}',$link1,$body1) ;
		$body_content = str_replace('{Management Firm}',$manage,$body_content) ;
		$body_content = str_replace('{Property Manager Name}',$fromname,$body_content) ;
		$body=  $body_content;
		$body = $body."NOTE:&nbsp;&nbsp;".$note;
		
		JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
		if( $cc1 ){
			JUtility::sendMail($mailfrom, $fromname, $cc1, $mailsubject, $body, $mode = 1);	
		}
		if($bcc!=''){
			JUtility::sendMail($mailfrom, $fromname, $bcc, $mailsubject, $body, $mode = 1);
		}
		$supportmail = 'manageremails@myvendorcenter.com';
		$body = $body."<br><br><font color='red'>The manager invitation sent to :</font>".$assignuseremail;
		JUtility::sendMail($mailfrom, $fromname, $supportmail, $mailsubject, $body, $mode = 1);
		
		$post['sender'] = $user_id;
		$post['reciever'] = $assignuseremail;
		$post['dmanager'] = $dmanager;
		$post['licence'] = $camfirm_license_no;
		$model = $this->getModel('propertymanager');
		// To check is there any existing old invitation or not
		$existing = "SELECT id  FROM #__cam_invitemanagers  where reciever='".$assignuseremail."' and sender=".$user_id." "; 
		$db->Setquery($existing);
		$email_exist = $db->loadResult();

		if(!$email_exist){
		$success = $model->invitestore($post);
		}
		else{
		}
		//Compleetd
		$link2= JURI::base()."index.php?option=com_camassistant&controller=propertymanager&task=manage_properties&Itemid=119";
		$msg="Manager invited successfully!";
		$this->setRedirect( $link2,$msg );
		}
	function save_edit_form()
	{
	   //echo "<pre>"; print_r($_REQUEST); exit;
	  // JRequest::getVar('view','propertymanager');
	  	 parent::display();
	 	$db =& JFactory::getDBO();
		$task = JRequest::getVar("task",'');
		$user_type =JRequest::getVar('user_type','');
		$email = JRequest::getVar('email','');
		$username = JRequest::getVar('username','');
		$id = JRequest::getVar('id','');
		$pagefrom = JRequest::getVar('pagefrom','');
		
		$salutation = JRequest::getVar('salutation','');
		$fname = JRequest::getVar('fname','');
		$question = JRequest::getVar('question','');
		$answer = JRequest::getVar('answer','');
		$hear = JRequest::getVar('hear','');
		$lname = JRequest::getVar('lname','');
		$phone1 = JRequest::getVar('phone1','');
		$phone2 = JRequest::getVar('phone2','');
		$phone3 = JRequest::getVar('phone3','');
		$phone = $phone1.'-'.$phone2.'-'.$phone3;
		$ext = JRequest::getVar('ext','');
		$cphone1 = JRequest::getVar('cphone1','');
		$cphone2 = JRequest::getVar('cphone2','');
		$cphone3 = JRequest::getVar('cphone3','');
		$cphone = $cphone1.'-'.$cphone2.'-'.$cphone3; 
		$password	= JRequest::getVar('password', '', 'post', 'string', JREQUEST_ALLOWRAW);
		$password2	= JRequest::getVar('password2', '', 'post', 'string', JREQUEST_ALLOWRAW);
		
		
		
		if($password==''){
		$db =& JFactory::getDBO();
		 $update = "UPDATE #__users SET salutation='$salutation',name='$fname',lastname='$lname',phone='$phone',extension='$ext',cellphone='$cphone',email='$email',question='$question',answer='$answer',hear='$hear'  where id =".$id;
		
		$db->setQuery($update);
		$res12=$db->query();
		if($res12){
		$msg="Updated successfully";
		}
		} else {
		
		jimport('joomla.user.helper');
		$post	= JRequest::getVar("task",'');
		$user=clone(JFactory::getUser(0));
		$salt		= JUserHelper::genRandomPassword(32);
		$crypt		= JUserHelper::getCryptedPassword($password, $salt);
		$password1	= $crypt.':'.$salt;
	
	     $update = "UPDATE #__users SET salutation='$salutation',name='$fname',lastname='$lname',phone='$phone',extension='$ext',cellphone='$cphone',password='$password1',email='$email'  ,question='$question',answer='$answer',hear='$hear' where id =".$id;
		
		$db->setQuery($update);
		$res12=$db->query();
		if($res12){
		$msg="Updated successfully";
		
		}
		//code to update users table
	//code to update existing user record
		/*if($data['id'] != '')
		{
			$data['block']		='0';
			if(!$user->bind($data)) { 
			echo "<pre>"; print_r($data); exit;
			$user->getError(); 
			}else {
			if (!$user->save()){ 
			echo $user->getError();
			}
			} 
			}
			
			}*/
			
			}
			//To update the districtmanager	
		$exist_man = "SELECT id FROM #__cam_invitemanagers where managerid ='".$id."'";
		$db->setQuery($exist_man);
		$existid = $db->loadResult();
		if($existid) {
			$dmanager =JRequest::getVar('dmanager','');
			$sql_update="UPDATE #__cam_invitemanagers  SET dmanager=".$dmanager." where managerid=".$id." ";
			$db->Setquery($sql_update);
			$db->query();
		}
		else{
			$user=JFactory::getUser(); 
			$today = date('Y-m-d H:i:s');
			$dmanager =JRequest::getVar('dmanager','');
			$exist_lic = "SELECT camfirm_license_no FROM #__cam_customer_companyinfo where cust_id ='".$id."'";
			$db->setQuery($exist_lic);
			$licence = $db->loadResult();
			$insert_sql = "insert into #__cam_invitemanagers values ('','".$user->id."','".$email."','".$id."','".$dmanager."','".$today."','".$licence."','1','0')";

			$db->SetQuery($insert_sql);
			$db->query();
		}
		//Completed
			$Itemid = JRequest::getVar('Itemid');
			//echo $Itemid; exit;
			$comp_id = JRequest::getVar("comp_id",0);
			if($comp_id)
			//$link = 'index.php?option=com_camassistant&controller=propertymanager&task=manage_properties&Itemid='.$Itemid;
			$link = 'index.php?option=com_camassistant&controller=rfpcenter&task=dashboard&Itemid='.$Itemid;
			else
			//$link = 'index.php?option=com_camassistant&controller=propertymanager&task=customer_edit_form&pmanager_id='.$id.'&comp_id='.$comp_id.'&Itemid='.$Itemid;
			$link = 'index.php?option=com_camassistant&controller=rfpcenter&task=dashboard&Itemid='.$Itemid;
			$user=JFactory::getUser(); 
			if($user->user_type == '12'){
			//$link = 'index.php?option=com_camassistant&controller=propertymanager&task=customer_edit_form&Itemid='.$Itemid;
			$link = 'index.php?option=com_camassistant&controller=rfpcenter&task=dashboard&Itemid='.$Itemid;
			}
			else{
			$link = $link ;
			}
			
			if( $pagefrom == 'adminside' )
			$link = 'index.php?option=com_camassistant&controller=propertymanager&task=company_edit_form&Itemid=239';
			$msg="Updated successfully";
		    $this->setRedirect( $link,$msg );
				
	}
	
      function useractivation()
	    {
		$useractivation = JRequest::getVar("useractivation",'');
		$db =& JFactory::getDBO();
		
		$status = "SELECT status FROM #__cam_customer_companyinfo where activation ='".$useractivation."'";
		$db->setQuery($status);
		$status1= $db->loadResult();
		if($status1=='approved'){
		$msg='Your account is already activated, you can login';
		$link= JURI::base()."index.php?option=com_user&view=login&Itemid=87";
		$this->setRedirect( $link,$msg );
		} else {
		$activate = "UPDATE #__cam_customer_companyinfo SET status='active' where activation ='".$useractivation."'";
		$db->setQuery($activate);
		$res=$db->query();
		$userdetails1 = "SELECT cust_id,mailaddress,comp_name,camfirm_license_no FROM #__cam_customer_companyinfo where activation ='".$useractivation."'";
		$db->setQuery( $userdetails1 );
		$cust_id = $db->loadObjectlist();
		$user_details = "SELECT name,email,lastname,phone FROM #__users where id ='".$cust_id[0]->cust_id."'";
		$db->setQuery( $user_details );
		$user_details1 = $db->loadObjectlist();
		
		$update_manager = "UPDATE #__cam_invitemanagers SET managerid=".$cust_id[0]->cust_id.",status='1' where reciever ='".$user_details1[0]->email."'";
		$db->setQuery($update_manager);
		$db->query();

		$username=$user_details1[0]->name.' '.$user_details1[0]->lastname;
		$email=$user_details1[0]->email;
		$address=$cust_id[0]->mailaddress;
		$companyname=$cust_id[0]->comp_name;
		$camfirm_license_no=$cust_id[0]->camfirm_license_no;
		$phone=$user_details1[0]->phone;
		
		$mailfrom='support@myvendorcenter.com';
		//$fromname='Camassistant Team';
		//$assignuseremail='rize.test@gmail.com';
		$assignuseremail='support@myvendorcenter.com';
		$mailsubject='New Camfirm/Customer Registered On MyVendorCenter';
		$notification = "SELECT introtext  FROM #__content where id='191'";
		$db->setQuery($notification);
		$body = $db->loadResult();
		$body = str_replace('{EMAIL}', $email, $body);
		$body = str_replace('{USERNAME}', $username, $body);
		$body = str_replace('{ADDRESS}', $address, $body);
		$body = str_replace('{COMPANY NAME}', $companyname, $body);
		$body = str_replace('{PHONE}', $phone, $body);
		$body = str_replace('{TAX ID}', $camfirm_license_no, $body);
		
		if($cust_id[0]->cust_id){
			JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
			$assignuseremail_sateesh = 'rize.cama@gmail.com';
			JUtility::sendMail($mailfrom, $fromname, $assignuseremail_sateesh, $mailsubject, $body, $mode = 1);
		}
		}
		if($res){
		echo "<br/>";
			//echo "<br/><br/>Your Account Has Been Activated Successfully";
			}
		//$this->setLayout('property_active');
		parent::display();
		
		
	}	
	
	
	function save_edit_companyinfo()
	{
		JRequest::getVar('view','propertymanager');
		parent::display();
		$user=JFactory::getUser(); 
		$task = JRequest::getVar("task",'');
		$mailaddress = JRequest::getVar('mailaddress','');
		$city = JRequest::getVar('city','');
		$state = JRequest::getVar('state_name','');
		$zipcode = JRequest::getVar('zipcode','');
		$cphone1 = JRequest::getVar('cphone1','');
		$cphone2 = JRequest::getVar('cphone2','');
		$cphone3 = JRequest::getVar('cphone3','');
		$cphone = $cphone1.'-'.$cphone2.'-'.$cphone3;
		$cext = JRequest::getVar('cext','');
		$caphone1 = JRequest::getVar('caphone1','');
		$caphone2 = JRequest::getVar('caphone2','');
		$caphone3 = JRequest::getVar('caphone3','');
		$caphone = $caphone1.'-'.$caphone2.'-'.$caphone3;
		$caext = JRequest::getVar('caext','');
		$website = JRequest::getVar('website','');
		$hidden_image = JRequest::getVar('hidden_image','');
		$image = JRequest::getVar('image','');
		$id = JRequest::getVar('id','');

		 //image upload code
		jimport('joomla.filesystem.file');
		$files		= JRequest::getVar( 'image', '', 'files', 'array' );
	    $base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'properymanager'.DS; 
		if($files && $files['name'] != '')
		{
			$db =& JFactory::getDBO();
			$files1= str_replace(' ','_',$files['name']); 		
					$files1= str_replace('&','_',$files1); 		
					$files1= str_replace('#','_',$files1); 		
					$files1= str_replace('%','_',$files1); 
			$filename =$user->id.'_'.$files1;
			$sql = "UPDATE #__cam_customer_companyinfo SET comp_logopath='".$filename."' where cust_id='".$user->id."'";
			$db->Setquery($sql);
			$db->query();
			//$filename =$user->id.'_'.$files['name'];
						$filepath = $base_Dir . $filename;  
						$post['image'] = $filename;
						if(file_exists($base_Dir . $filename))
						@unlink($base_Dir . $filename);
						move_uploaded_file($files['tmp_name'], $filepath); 
						
			
						
						
    //code to move image to folderpath
			$model = $this->getModel('propertymanager');
			$pdf_resized = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'properymanager'.DS.'pdf_resized';
			$resized = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'properymanager'.DS.'resized';
			$img = $filepath;
			$dimensions = $model->get_thumbnail_dimensions();
			$img1=$resized;
			$img2 =$pdf_resized;
						if($dimensions[0]->vendor_logo_width == 0)
						$dimensions[0]->vendor_logo_width = 90;
						if($dimensions[0]->vendor_logo_height == 0)
						$dimensions[0]->vendor_logo_height = 90;
						//$thumb = $model->image_resize_to_max($img,$dimensions[0]->vendor_logo_width,$dimensions[0]->vendor_logo_height,$img1,$filename);
						$apath=getimagesize($img);
					 	$height_orig=$apath[1]; 
						$width_orig=$apath[0]; 
						$aspect_ratio = (float) $height_orig / $width_orig;
						$width =$dimensions[0]->vendor_logo_width; 
					    $height = round($width * $aspect_ratio); 
						

						$thumb = $model->image_resize_to_max($img,$width,$height,$img1,$filename);
						$pdf_thumb = $model->image_resize_to_max($img,$width_orig,$height_orig,$img2,$filename);
				
            $ftmp = $filename;
            $oname = $filename;
            $fname = $pdf_resized.'/'.$filename;
					
            $sizes = getimagesize($fname);
			//print_r( $files); exit;
            $width	=	$sizes[0];
            $height	=	$sizes[1];
    
            $extenssion = strstr($oname, ".");
        
            $prod_img		= $fname;	
            $prod_img_thumb =  $pdf_resized.'/'.$oname;
             move_uploaded_file($ftmp, $prod_img);
             $original_filesize = (filesize($prod_img)/1024);
             $sizes = getimagesize($prod_img);
             
            $expected_max_width		=	136;
            $expected_max_height	=	68;
            $originalw	=	$sizes[0];
            $originalh	=	$sizes[1];
    
            if ($originalh<$expected_max_height) {
                if ($originalw<$expected_max_width) {
                    $imgwidth	=	$originalw;
                    $imgheight	=	$originalh;
                } else {
                    $imgheight	=	($expected_max_width * $originalh)/ $originalw;
                    $imgwidth	=	$expected_max_width;
                }
            } else {
                 $new_height		=	$expected_max_height;
                 $new_width		=	($expected_max_height * $originalw)/ $originalh;
    
                if ($new_width>$expected_max_width) {
                    $new_height	=	($expected_max_width * $expected_max_height) / $new_width;
                    $new_width	=	$expected_max_width;
                }
    
                $imgwidth	=	$new_width;
                $imgheight	=	$new_height;
            }
			
            $new_h	=	$imgheight;
            $new_w	=	$imgwidth;
			$new_w_im='136'; 
			$new_h_im='68';
			$offsetwidth=$new_w_im-$new_w;
			$offsetw=$offsetwidth/2;
			$offsetheight=$new_h_im-$new_h;
			$offseth=$offsetheight/2;
  //  echo $extenssion;
           $dest = imagecreatetruecolor ($new_w_im,$new_h_im);
         //  $bg = imagecolorallocate ( $dest, 255, 255, 255 );
		//   print_r( $dest); echo "<br>"; print_r( $imgheight); exit;
        //   imagefill ( $dest, 0, 0, $bg );
		   $extenssion= str_replace('.jpg.jpg','.jpg',$extenssion);
		 $extenssion= str_replace('.jpeg.jpeg','.jpeg',$extenssion);
		 $extenssion= str_replace('.gif.gif','.gif',$extenssion);
		 $extenssion= str_replace('.png.png','.png',$extenssion);
			if($extenssion=='.jpg'){	
            	$src = imagecreatefromjpeg($prod_img)
                or die('Problem In opening Source JPG Image');
			}elseif($extenssion=='.jpeg'){
				 $src = imagecreatefromjpeg($prod_img)
                 or die('Problem In opening Source JPEG Image');
			}elseif($extenssion=='.gif'){
				 $src = imagecreatefromgif($prod_img)
                 or die('Problem In opening Source GIF Image');
			}elseif($extenssion=='.png'){
			   $src = imagecreatefrompng($prod_img)
                or die('Problem In opening Source PNG Image');
			}
				
            if(function_exists('imagecopyresampled'))
            {
                imagecopyresampled($dest,$src,0,0,0,0,$new_w,$new_h,imagesx($src),imagesy($src))
                or die('Problem In resizing');
            }else{
                Imagecopyresized($dest,$src,0,0,0,0,$new_w,$new_h,imagesx($src),imagesy($src))
                or die('Problem In resizing');
            }
			
            imagejpeg($dest,$prod_img_thumb,72)
                or die('Problem In saving');
            imagedestroy($dest);
            @ob_flush();
            $new_filesize = (filesize($prod_img)/1024);
       
		}
			if($filename == ''){
			$filename = $hidden_image;
			}	
			$propertymanager['id'] = $id;
			$propertymanager['mailaddress'] = $mailaddress;
			$propertymanager['comp_city'] = $city;
			$propertymanager['comp_state'] = $state;
			$propertymanager['comp_zip'] = $zipcode;
			$propertymanager['comp_phno'] = $cphone;
			$propertymanager['comp_extnno'] = $cext;
			$propertymanager['comp_alt_phno'] = $caphone;
			$propertymanager['comp_alt_extnno'] = $caext;
			$propertymanager['comp_website'] = $website;
			$propertymanager['comp_logopath'] = $filename;
			$db =& JFactory::getDBO();

			$query = "UPDATE #__cam_customer_companyinfo SET mailaddress='$mailaddress',comp_city='$city',comp_state='$state',comp_zip='$zipcode',comp_phno='$cphone',comp_extnno='$cext',comp_alt_phno='$caphone',comp_alt_extnno='$caext',comp_website='$website',comp_logopath='$filename' WHERE id=".$id;
	$db->setQuery($query);
	$Itemid = JRequest::getVar('Itemid');
		//echo $Itemid; exit;
		if (!$db->query()) {
		
		$link = 'index.php?option=com_camassistant&controller=propertymanager&task=company_edit_form&Itemid='.$Itemid;
		//$link = 'index.php?option=com_camassistant&controller=propertymanager&task=company_edit_form&Itemid=72';
		$msg="Not Updated Your Company Details";
		$this->setRedirect( $link,$msg );
		}
		$link = 'index.php?option=com_camassistant&controller=propertymanager&task=company_edit_form&Itemid='.$Itemid;
		//$link = 'index.php?option=com_camassistant&controller=propertymanager&task=company_edit_form&Itemid=72';
		$msg="Updated successfully";
		$this->setRedirect( $link,$msg );

	}
 	/*function submit_customerinfo()
	{
	
	JRequest::getVar('view','propertymanager');
	parent::display();
	}*/
	
	function thanks()
	{
		//$post	= JRequest::get('post');
		//global $mainframe;
		//$model = $this->getModel('propertymanager');
		
		//if ($model->store($post)) {
		//$msg = JText::_( 'Propertymanager Saved' );
		//} else {
		//$msg = JText::_( 'Error Saving Property' );
		//}
		//JRequest::setVar('view', 'propertymanager');
		
		$this->setLayout('property_thanks');
		parent::display();
	}
	
	//fun. to get properties and  their managers
	/*function manage_properties()
	{
		JRequest::getVar('view','propertymanager');
		parent::display();
	}
	//fun. to get properties and  their managers
	function edit_vendor_mails()
	{
		JRequest::getVar('view','propertymanager');
		parent::display();
	}*/
	//Fun. to submit vendor emails information for camfirm admin to send
	function update_camfirmadmin_emailsinfo()
	{
		global $mainframe;
		$basepath=JURI::root(); 
		$model	=& $this->getModel();
		$itemid=JRequest::getVar('Itemid',0);
		$post = JRequest::get( 'post', JREQUEST_ALLOWHTML );
		//echo "<pre>"; print_r($post); exit;
		
		if($model->CAMMails_store($post)) {
			$mesg = "<font color='red' size='3'><b>Invitation Mails Information Updated successfully<b></font>";	
		} else {
			$mesg = "Could not submitted Mails Information";
		}
		$this->setRedirect( 'index.php?option=com_camassistant&controller=propertymanager&task=edit_vendor_mails&Itemid='.$itemid,$mesg );
	} 
	//
	function submit_property()
	{
		global $mainframe;
		$model = $this->getModel();
		$itemid=JRequest::getVar('Itemid',0);
		$post	= JRequest::get('post');
		if(!$post['share'])
		$post['share']=2;
		/*echo "123456<pre>";
		print_r($post); exit;*/

		$user=JFactory::getUser();  //For $my
		$taxids=$model->getProperty_TaxIDs();
		$tax_ids=array();
		$cnt=0;
		for($i=0;$i<count($taxids);$i++)
		{
			if($post['tax_id']==$taxids[$i]->tax_id)
			$cnt++;
		}
		if($cnt>1)
		{
			$err_msg="This Property is already registered with our system. Please contact your board/Management Company to determine your Property's Administrator on MyVendorCenter.com. <br>If you have any  additional questions, please email us at <b>properties@MyVendorCenter.com</b>";
			$mainframe->Redirect('index.php?option=com_camassistant&controller=propertymanager&task=property_edit_form&property_id='.$post['id'].'&Itemid='.$itemid,$err_msg );
		}
		if($user->id)
		{
			if ($model->property_store($post)) {
				$err_msg="<font color='red'>Property updated successfully</font>";
			} else {
				$err_msg="<font color='red'>Error Saving Property (ie. Property Name or Tax-Id entry might be duplicated )</font>";
			}
			$mainframe->Redirect('index.php?option=com_camassistant&controller=propertymanager&task=property_edit_form&property_id='.$post['id'].'&Itemid='.$itemid,$err_msg );
		} else {
			$err_msg="<font color='red'>Your session has been expired.Please login again</font>";
			$mainframe->Redirect('index.php?option=com_user&view=login',$err_msg );
		}
	}
	
//	by anandbabu for deleting the properties from jos_cam_property
	function delproperty()
	{	
		$post = JRequest::getvar('cid');
		$pmanager_id = JRequest::getvar('pmanager_id');
		$id = JRequest::getvar('id');
		$Itemid = JRequest::getvar('Itemid');
		$url = "index.php?option=com_camassistant&controller=propertymanager&task=customer_edit_form&pmanager_id=".$pmanager_id."&comp_id=".$id."&Itemid=".$Itemid;			        $model =& $this->getModel();
		$items = $model->getdelproperty();
		if($items){ $msg = "Record Deleted Sucessfully";}
		else { $msg = "Record has beend delted"; }
		$this->setRedirect($url,$msg);
	}
// by anandbabu for reassigning the property 
	function reassign_prop()
	{
		$post = JRequest::getvar('task');
		JRequest::getVar('view','propertymanager');
		parent::display();
	}
	function update_prop()
	{
		$post = JRequest::getvar('admins');
		$pid = JRequest::getvar('pmanager_id');
		$compid = JRequest::getvar('comp_id');
		$model =& $this->getModel();
		$res = $model->update_rec();
		if($res) { 	$msg = 'success';  }
		else { $msg = 'failed'; } 
//		index.php?option=com_camassistant&controller=propertymanager&task=customer_edit_form&pmanager_id=206&comp_id=12&Itemid=89

		$url = "index.php?option=com_camassistant&controller=propertymanager&task=customer_edit_form&&pmanager_id=".$pid."&comp_id=".$compid."&Itemid=89";
		$this->setRedirect($url,$msg);
	}
	
	//fun. to get properties and  their managers
	/*function cam_managers_viewall()
	{
		JRequest::getVar('view','propertymanager');
		parent::display();
	}*/
/*	function rfpform()
	{
		JRequest::setVar('view', 'rfp');
		parent::display();
	}
	function addproperty()
	{
		JRequest::setVar('view', 'rfp');
		parent::display();
	}
	function submit_property()
	{
		$post	= JRequest::get('post');
		//echo "123456<pre>";	print_r($post); exit;
		global $mainframe;
		$model = $this->getModel('property');
		
		if ($model->store($post)) {
			$msg = JText::_( 'Property Saved' );
		} else {
			$msg = JText::_( 'Error Saving Property' );
		}
		exit;
		JRequest::setVar('view', 'rfp');
		parent::display();
	}*/
		//Function to check the emial id status on 02-08-11 by sateesh
		function verfiryemailid(){
		$db =& JFactory::getDBO();
		$emailid=$_POST['queryString'];
		if ($emailid != "")
		{
		$query_emailid="SELECT id,user_type FROM #__users  WHERE username='".$emailid."' or email='".$emailid."'";
		$db->setQuery( $query_emailid );
		$result_email = $db->loadObjectList();
		//echo "<pre>"; print_r($result_email); exit;
		if($result_email[0]->id){
		$data="invalid"; 
		 }
		if($result_email[0]->id && $result_email[0]->user_type == 11){
		$data="notdefined"; 
		 }
		 
		}
		echo $data;
		exit;
   }
   //Function to change the status to District manager
function changestatus(){
		$db =& JFactory::getDBO();
		$userid=$_POST['User'];
		$email=$_REQUEST['email'];
		$user = JFactory::getUser();
		
		$sql_update="UPDATE #__users  SET dmanager='yes' where id=".$userid." and user_type=12";
		$db->Setquery($sql_update);
		if($db->query()){
		echo "success";
		$query_cname="SELECT comp_name FROM #__cam_camfirminfo  WHERE cust_id='".$user->id."'";
		$db->setQuery( $query_cname );
		$cname = $db->loadResult();
		
		//To get the company name of customer if distirct manager
		if($cname == ''){
		$fcompid = "SELECT comp_id  FROM #__cam_customer_companyinfo  where cust_id=".$userid." "; 
		$db->Setquery($fcompid);
		$cmnyid = $db->loadResult();

		$scompid = "SELECT cust_id  FROM #__cam_camfirminfo  where id=".$cmnyid." "; 
		$db->Setquery($scompid);
		$usercreator = $db->loadResult();
		
		$query_cname="SELECT comp_name FROM #__cam_camfirminfo  WHERE cust_id='".$user->id."'";
		$db->setQuery( $query_cname );
		$cname = $db->loadResult();
		}
		//Completed
		
		$query_email="SELECT email FROM #__users  WHERE id='".$userid."'";
		$db->setQuery( $query_email );
		$vendoremail = $db->loadResult();
		
		$mailfrom = $user->email; 
		$fromname = $user->name.' '.$user->lastname; 
 		$mailsubject = 'Your position changed to District Manager for '.$cname.' company'; 
		$body = 'Your position changed to District Manager for '.$cname.' company<br><br>Thank you<br>'.$fromname.'';
		

		JUtility::sendMail($mailfrom, $fromname, $vendoremail, $mailsubject, $body, $mode = 1);
		$support = 'support@myvendorcenter.com';
		JUtility::sendMail($mailfrom, $fromname, $support, $mailsubject, $body, $mode = 1);
		}
		else{
		echo "fail";
		}
		exit;		
}
	//Function to check the emial id status on 02-08-11 by sateesh

function changestatustom(){
		$db =& JFactory::getDBO();
		$userid=$_POST['User'];
		$email=$_REQUEST['email'];
		$user = JFactory::getUser();
		
		//delete the records
		$query = "DELETE FROM #__vendor_districtmanagers WHERE dmanager=".$userid; 
		$db->setQuery($query);
		$db->query();
		//Completed
		$sql_update="UPDATE #__cam_invitemanagers  SET dmanager=0 where dmanager=".$userid."";
		$db->Setquery($sql_update);
		$db->query();
		
		$sql_update="UPDATE #__users  SET dmanager='',invitation=0 where id=".$userid." and user_type=12";
		$db->Setquery($sql_update);
		if($db->query()){
		echo "success";
		$query_cname="SELECT comp_name FROM #__cam_camfirminfo  WHERE cust_id='".$user->id."'";
		$db->setQuery( $query_cname );
		$cname = $db->loadResult();
		
		//To get the company name of customer if distirct manager
		if($cname == ''){
		$fcompid = "SELECT comp_id  FROM #__cam_customer_companyinfo  where cust_id=".$userid." "; 
		$db->Setquery($fcompid);
		$cmnyid = $db->loadResult();

		$scompid = "SELECT cust_id  FROM #__cam_camfirminfo  where id=".$cmnyid." "; 
		$db->Setquery($scompid);
		$usercreator = $db->loadResult();
		
		$query_cname="SELECT comp_name FROM #__cam_camfirminfo  WHERE cust_id='".$user->id."'";
		$db->setQuery( $query_cname );
		$cname = $db->loadResult();
		}
		//Completed
		
		$query_email="SELECT email, name, lastname FROM #__users  WHERE id='".$userid."'";
		$db->setQuery( $query_email );
		$ddate = $db->loadObject();
		$vendoremail = $ddate->email ;
		$managername_new = $ddate->name.'&nbsp;'.$ddate->lastname ;
		
		$mailfrom = $user->email; 
		$fromname = $user->name.' '.$user->lastname; 
 		$mailsubject = 'Your account on MyVendorCenter has changed from District Manager to Standard Manager';
		// Get the article
		$notification_down = "SELECT introtext  FROM #__content where id='279'";
		$db->setQuery($notification_down);
		$body = $db->loadResult();
		$body = str_replace('[Manager_User_who_made_change]', $fromname, $body);
		$body = str_replace('[Manager_Full_Name]', $managername_new, $body);
		//Completed
		 
//		$body = 'Your position changed from District Manager to Manager for '.$cname.' company<br><br>Thank you<br>'.$fromname.'';
		

		JUtility::sendMail($mailfrom, $fromname, $vendoremail, $mailsubject, $body, $mode = 1);
		$support = 'manageremails@myvendorcenter.com';
		JUtility::sendMail($mailfrom, $fromname, $support, $mailsubject, $body, $mode = 1);
		}
		else{
		echo "fail";
		}
		exit;		
}
		function chagetodm(){
				JRequest::getVar('view','propertymanager');
				parent::display();
		}
		function managers_save(){
			$db =& JFactory::getDBO();
            $dmanager=$_POST['dmanager'];
			$managername=$_POST['managername'];
			$standardmanagers=$_POST['standardmanagers'];
			$invite=$_POST['invite'];
			//$dmanager=JRequest::getVar('dmanager','');
			//$managername=JRequest::getVar('managername','');
			
			//$standardmanagers=JRequest::getVar('standardmanagers','');
			//$invite=JRequest::getVar('invite','');
			$user = JFactory::getUser();
			//Get camfirm id
		$query_comp = "SELECT comp_id FROM #__cam_customer_companyinfo WHERE cust_id=".$dmanager;
		$db->setQuery($query_comp);
		$comp_id = $db->loadResult();
		
		$query_firm = "SELECT cust_id FROM #__cam_camfirminfo WHERE id=".$comp_id;
		$db->setQuery($query_firm);
		$firmid_ori = $db->loadResult();
		
			//Completed
			$insert_sql = "insert into #__vendor_districtmanagers values ('','".$dmanager."','".$firmid_ori."')";
			$db->SetQuery($insert_sql);
			$db->query();
			
			$sql_update="UPDATE #__users  SET dmanager='yes',invitation=".$invite." where id=".$dmanager."";
			$db->Setquery($sql_update);
			$db->query();
                         if($db->query()){
						 	// Get firm admin
							$fcompid = "SELECT comp_id  FROM #__cam_customer_companyinfo  where cust_id=".$dmanager." "; 
							$db->Setquery($fcompid);
							$cmnyid = $db->loadResult();
					
							$scompid = "SELECT cust_id  FROM #__cam_camfirminfo  where id=".$cmnyid." "; 
							$db->Setquery($scompid);
							$camfirmadmin = $db->loadResult();
							//Completed
						    $sql_update="UPDATE #__cam_invitemanagers SET dmanager='".$camfirmadmin."' where managerid=".$dmanager."";
							$db->Setquery($sql_update);
							$db->query();
			
			// Get the article
		$query_email="SELECT email, name, lastname FROM #__users  WHERE id='".$dmanager."'";
		$db->setQuery( $query_email );
		$dddatra = $db->loadObject();
		$vendoremail = $dddatra->email ;
		$manager_nanenew = $dddatra->name.'&nbsp;'.$dddatra->lastname ;
			
		$query_cname="SELECT comp_name FROM #__cam_camfirminfo  WHERE cust_id='".$user->id."'";
		$db->setQuery( $query_cname );
		$cname = $db->loadResult();
		
		$mailfrom = $user->email; 
		$fromname = $user->name.' '.$user->lastname; 
 		$mailsubject = 'Your account on MyVendorCenter has changed from Standard Manager to District Manager';
			
		$notification_up = "SELECT introtext  FROM #__content where id='280'";
		$db->setQuery($notification_up);
		$body = $db->loadResult();
		$body = str_replace('[Manager_Full_Name]', $manager_nanenew, $body);
		$body = str_replace('[Manager_User_who_made_change]', $fromname, $body);
		JUtility::sendMail($mailfrom, $fromname, $vendoremail, $mailsubject, $body, $mode = 1);
		$support = 'manageremails@myvendorcenter.com' ;
		JUtility::sendMail($mailfrom, $fromname, $support, $mailsubject, $body, $mode = 1);
		//Completed
		
                        echo "success";
                        } else{
                        echo "fail";
                        }
		
                        exit;
			/* ?>
            <script type="text/javascript">	
			window.parent.document.getElementById( 'sbox-window' ).close(); 
			alert("<?php echo $managername; ?> has been upgraded to District Manager permissions successfully.");
//			history.go(0);
			window.parent.location.reload();
			</script>
            <?php */
		}
			function changemanager(){
		$db =& JFactory::getDBO();
		$userid=$_POST['User'];
		$managerid=$_REQUEST['manager'];
 		$sql_update="UPDATE #__cam_invitemanagers  SET dmanager=".$userid." where managerid=".$managerid." ";

		$db->Setquery($sql_update);
		if($db->query()){
		echo "success";
		} else{
		echo "fail";
		}
		
		exit;
		}
		function deletemanager(){
		$db =& JFactory::getDBO();
		$userid=$_POST['User'];
		$user = JFactory::getUser();
//Update the properties manager id from manager to cam firm id
 		$sql_update="UPDATE #__cam_property  SET property_manager_id=".$user->id.", camfirmid=0 where property_manager_id=".$userid." ";
		$db->Setquery($sql_update);
		$db->query();
//Update the properties manager id from manager to cam firm id completed
//Update the properties manager id for the property documents
 		$sql_docs="UPDATE #__cam_propertydocs SET property_manager_id=".$user->id." where property_manager_id=".$userid." ";
		$db->Setquery($sql_docs);
		$db->query();
//Update the properties manager id from manager to cam firm id completed
	
//delete the manager account from users table
		$query = "DELETE FROM #__users WHERE id=".$userid; 
		$db->setQuery($query);
		$db->query();
//Completed
//delete the manager account from users table
		$query_company = "DELETE FROM #__cam_customer_companyinfo  WHERE cust_id=".$userid; 
		$db->setQuery($query_company);
		if($db->query()){
		echo 'success';
		}
		else{
		echo 'fail';
		}
		exit;
//Completed
		}
		//function to get the properties list
		function propertieslist(){
		JRequest::getVar( 'view','propertymanager');
		parent::display();
		}
		//Completed
		
		
		//Function to upload the logo 
		function savelogofile(){
		$db =& JFactory::getDBO();
		$user = JFactory::getUser();
		$model = $this->getModel('propertymanager');
		$hidden_image = '';
		$image = JRequest::getVar('image','');
		if($user->user_type == 13){
		$id = $user->id ;
		}
		else{
		$getcid = "SELECT comp_id FROM `#__cam_customer_companyinfo`  where cust_id=".$user->id." ";
		$db->setQuery($getcid);
		$cid = $db->loadResult();
		$firmid = "SELECT cust_id FROM `#__cam_camfirminfo`  where id=".$cid." ";
		$db->setQuery($firmid);
		$firm_id = $db->loadResult();
		$id = $firm_id ;
		}
       
		 //image upload code
		jimport('joomla.filesystem.file');
		$files		= JRequest::getVar( 'image', '', 'files', 'array' );
	    $base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'properymanager'.DS; 
		if($files && $files['name'] != '')
		{
			$db =& JFactory::getDBO();
			$files1= str_replace(' ','_',$files['name']); 		
					$files1= str_replace('&','_',$files1); 		
					$files1= str_replace('#','_',$files1); 		
					$files1= str_replace('%','_',$files1); 
			$filename =$id.'_'.$files1;
		
			 if($user->user_type == 16){
		      $id1 = $user->id ;
		      $filename =$id1.'_'.$files1;
			$user_val = $model->property_check($id1);
			
			if($user_val)
			{
			$sql = "UPDATE #__cam_propertyowner_image SET propertyowner_image='".$filename."' where user_id='".$id1."'";
			$db->Setquery($sql);
			$db->query();
             }
			 else
			 {
			 $insert_sql = "insert into #__cam_propertyowner_image values ('','".$user->id."','".$filename."')";

			$db->SetQuery($insert_sql);
			$db->query();
			 }
			}
			$sql = "UPDATE #__cam_customer_companyinfo SET comp_logopath='".$filename."' where cust_id='".$id."'";
			$db->Setquery($sql);
			$db->query();
			//$filename =$user->id.'_'.$files['name'];
						$filepath = $base_Dir . $filename;
						
						$post['image'] = $filename;
						if(file_exists($base_Dir . $filename))
						@unlink($base_Dir . $filename);
						move_uploaded_file($files['tmp_name'], $filepath); 
						
			
						
						
    //code to move image to folderpath
			$model = $this->getModel('propertymanager');
			$pdf_resized = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'properymanager'.DS.'pdf_resized';
			$resized = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'properymanager'.DS.'resized';
			$img = $filepath;
			$dimensions = $model->get_thumbnail_dimensions();
			$img1=$resized;
			$img2 =$pdf_resized;
						if($dimensions[0]->vendor_logo_width == 0)
						$dimensions[0]->vendor_logo_width = 90;
						if($dimensions[0]->vendor_logo_height == 0)
						$dimensions[0]->vendor_logo_height = 90;
						//$thumb = $model->image_resize_to_max($img,$dimensions[0]->vendor_logo_width,$dimensions[0]->vendor_logo_height,$img1,$filename);
						$apath=getimagesize($img);
					 	$height_orig=$apath[1]; 
						$width_orig=$apath[0]; 
						$aspect_ratio = (float) $height_orig / $width_orig;
						$width =$dimensions[0]->vendor_logo_width; 
					    $height = round($width * $aspect_ratio); 
						
						$thumb = $model->image_resize_to_max($img,$width,$height,$img1,$filename);
						$pdf_thumb = $model->image_resize_to_max($img,$width_orig,$height_orig,$img2,$filename);
				
            $ftmp = $filename;
            $oname = $filename;
            $fname = $pdf_resized.'/'.$filename;
					
            $sizes = getimagesize($fname);
			//print_r( $files); exit;
            $width	=	$sizes[0];
            $height	=	$sizes[1];
    
            $extenssion = strstr($oname, ".");
        
            $prod_img		= $fname;	
            $prod_img_thumb =  $pdf_resized.'/'.$oname;
             move_uploaded_file($ftmp, $prod_img);
             $original_filesize = (filesize($prod_img)/1024);
             $sizes = getimagesize($prod_img);
             
            $expected_max_width		=	136;
            $expected_max_height	=	68;
            $originalw	=	$sizes[0];
            $originalh	=	$sizes[1];
    
            if ($originalh<$expected_max_height) {
                if ($originalw<$expected_max_width) {
                    $imgwidth	=	$originalw;
                    $imgheight	=	$originalh;
                } else {
                    $imgheight	=	($expected_max_width * $originalh)/ $originalw;
                    $imgwidth	=	$expected_max_width;
                }
            } else {
                 $new_height		=	$expected_max_height;
                 $new_width		=	($expected_max_height * $originalw)/ $originalh;
    
                if ($new_width>$expected_max_width) {
                    $new_height	=	($expected_max_width * $expected_max_height) / $new_width;
                    $new_width	=	$expected_max_width;
                }
    
                $imgwidth	=	$new_width;
                $imgheight	=	$new_height;
            }
			
            $new_h	=	$imgheight;
            $new_w	=	$imgwidth;
			$new_w_im='136'; 
			$new_h_im='68';
			$offsetwidth=$new_w_im-$new_w;
			$offsetw=$offsetwidth/2;
			$offsetheight=$new_h_im-$new_h;
			$offseth=$offsetheight/2;
  //  echo $extenssion;
           $dest = imagecreatetruecolor ($new_w_im,$new_h_im);
         //  $bg = imagecolorallocate ( $dest, 255, 255, 255 );
		//   print_r( $dest); echo "<br>"; print_r( $imgheight); exit;
        //   imagefill ( $dest, 0, 0, $bg );
		   $extenssion= str_replace('.jpg.jpg','.jpg',$extenssion);
		 $extenssion= str_replace('.jpeg.jpeg','.jpeg',$extenssion);
		 $extenssion= str_replace('.gif.gif','.gif',$extenssion);
		 $extenssion= str_replace('.png.png','.png',$extenssion);
			if($extenssion=='.jpg'){	
            	$src = imagecreatefromjpeg($prod_img)
                or die('Problem In opening Source JPG Image');
			}elseif($extenssion=='.jpeg'){
				 $src = imagecreatefromjpeg($prod_img)
                 or die('Problem In opening Source JPEG Image');
			}elseif($extenssion=='.gif'){
				 $src = imagecreatefromgif($prod_img)
                 or die('Problem In opening Source GIF Image');
			}elseif($extenssion=='.png'){
			   $src = imagecreatefrompng($prod_img)
                or die('Problem In opening Source PNG Image');
			}
				
            if(function_exists('imagecopyresampled'))
            {
                imagecopyresampled($dest,$src,0,0,0,0,$new_w,$new_h,imagesx($src),imagesy($src))
                or die('Problem In resizing');
            }else{
                Imagecopyresized($dest,$src,0,0,0,0,$new_w,$new_h,imagesx($src),imagesy($src))
                or die('Problem In resizing');
            }
			
            imagejpeg($dest,$prod_img_thumb,72)
                or die('Problem In saving');
            imagedestroy($dest);
            @ob_flush();
            $new_filesize = (filesize($prod_img)/1024);
       
		}
			if($filename == ''){
			$filename = $hidden_image;
			}
		echo "<script language='javascript' type='text/javascript'>
			 window.parent.location.reload();
			 window.parent.document.getElementById( 'sbox-window' ).close();
			 window.location = 'index.php?option=com_camassistant&controller=rfpcenter&task=dashboard&Itemid=128';
			 </script>";
		$this->setRedirect($url,$msg);
			
		}
		//Completed
		
		function hideinvitation(){
			$db =& JFactory::getDBO();
			$hideid = JRequest::getVar('hideid','');
			$update_hide = "UPDATE #__cam_invitemanagers SET publish='1' where id =".$hideid;
			$db->setQuery($update_hide);
			$hide = $db->query();
			if($hide)
			$msg="yes";
			else
			$msg="no";
			echo $msg; 
			exit;
			
		}	
		function reassignmanager(){
			$db = JFactory::getDBO();
			$deletedid = JRequest::getVar('deletedid','');
			$newid = JRequest::getVar('managerid','');
			$model = $this->getModel('propertymanager');
			$properties = $model->reassigningpropertis($newid,$deletedid);
			$del =& JFactory::getUser($deletedid);
			if($del->user_type == '12' &&  $del->dmanager == 'yes'){
				$managers_assign = $model->managers_assign($newid,$deletedid);
				$managers = $model->deletemanager($deletedid);
			}
			if($del->user_type == '13'){
				$managers_assign = $model->managers_reassign_to_admin($newid,$deletedid);
				$managers_assign = $model->deletecamfirm($deletedid);
				$managers = $model->deletemanager($deletedid);
			}
			if($del->user_type == '12'  &&  $del->dmanager != 'yes'){
				$managers = $model->deletemanager($deletedid);
			}
			echo "<script language='javascript' type='text/javascript'>
			 window.parent.location.reload();
			 window.parent.document.getElementById( 'sbox-window' ).close();
			 window.location = 'index.php?option=com_camassistant&controller=propertymanager&task=manage_properties&Itemid=240';
			 </script>";
			$this->setRedirect($url,$msg);
		}
		
		function reassignmanager_direct(){
			$db = JFactory::getDBO();
			$deletedid = JRequest::getVar('deletedid','');
			$model = $this->getModel('propertymanager');
			$del =& JFactory::getUser($deletedid);
			if($del->user_type == '12' &&  $del->dmanager == 'yes'){
				$managers = $model->deletemanager($deletedid);
			}
			if($del->user_type == '13'){
				$managers_assign = $model->deletecamfirm($deletedid);
				$managers = $model->deletemanager($deletedid);
			}
			if($del->user_type == '12'  &&  $del->dmanager != 'yes'){
				$managers = $model->deletemanager($deletedid);
			}
			echo "<script language='javascript' type='text/javascript'>
			 window.location = 'index.php?option=com_camassistant&controller=propertymanager&task=manage_properties&Itemid=240';
			 </script>";
			$this->setRedirect($url,$msg);
		}
		
		//Function to change reports to user
		function reportsto(){
		$db =& JFactory::getDBO();
		$user_type =JRequest::getVar('user_type','');
		$id = JRequest::getVar('id','');
			
		$exist_man = "SELECT id FROM #__cam_invitemanagers where managerid ='".$id."'";
		$db->setQuery($exist_man);
		$existid = $db->loadResult();
		if($existid) {
			$dmanager =JRequest::getVar('dmanager','');
			$sql_update="UPDATE #__cam_invitemanagers  SET dmanager=".$dmanager." where managerid=".$id." ";
			$db->Setquery($sql_update);
			$db->query();
		}
		else{
			$user=JFactory::getUser(); 
			$today = date('Y-m-d H:i:s');
			$dmanager =JRequest::getVar('dmanager','');
			$exist_lic = "SELECT camfirm_license_no FROM #__cam_customer_companyinfo where cust_id ='".$id."'";
			$db->setQuery($exist_lic);
			$licence = $db->loadResult();
			$insert_sql = "insert into #__cam_invitemanagers values ('','".$user->id."','".$email."','".$id."','".$dmanager."','".$today."','".$licence."','1','0')";

			$db->SetQuery($insert_sql);
			$db->query();
		}
		echo "<script language='javascript' type='text/javascript'>
			 window.parent.document.getElementById( 'sbox-window' ).close();
			 window.parent.location.reload();
			 </script>";
			 
		}
		//sreenu
		function save_propertyowner_info()
		{
		
		jimport('joomla.user.helper');
		$post = JRequest::get('post');
		$db = JFactory::getDBO();
	    $model = $this->getModel('propertymanager');
		$email =JRequest::getVar('email','');
		$streeaddress1 = $post['streeaddress1'];
		$streeaddress2= $post['streeaddress2'];
		$steetaddress =$streeaddress1.','.$streeaddress2;
        $city= $post['city'];
		$sate= $post['state'];
		$zipcode = $post['zipcode'];
		$altemail = $post['p_altemail'];
		$altphone_ext = $post['altphone_ext'];
		$fax1 =JRequest::getVar('fax_1','');
		$fax2 =JRequest::getVar('fax_2','');
		$fax3 =JRequest::getVar('fax_3','');
		$fax = $fax1.'-'.$fax2.'-'.$fax3;
		$ein1 =JRequest::getVar('ein_1','');
		$ein2 =JRequest::getVar('ein_2','');
		$ein_number = $ein1.'-'.$ein2;
		$accept =JRequest::getVar('accept','');
        $phone1 =JRequest::getVar('phone1','');
		$phone2 =JRequest::getVar('phone2','');
		$phone3 =JRequest::getVar('phone3','');
		$altphone1 =JRequest::getVar('altphone1','');
		$altphone2 =JRequest::getVar('altphone2','');
		$altphone3 =JRequest::getVar('altphone3','');
		$phone = $phone1.'-'.$phone2.'-'.$phone3;
		$altphone = $altphone1.'-'.$altphone2.'-'.$altphone3;
		$fax1 =JRequest::getVar('fax_1','');
		$fax2 =JRequest::getVar('fax_2','');
		$fax3 =JRequest::getVar('fax_3','');
		$fax = $fax1.'-'.$fax2.'-'.$fax3;
		$altemail =JRequest::getVar('p_altemail','');
		$user=clone(JFactory::getUser(0));
		$registerdate= date('Y-m-d H:i:s');
		$data['name'] = $post['fname'];
		$data['username'] = $post['email'];
		$data['password'] = $post['password'];
		$data['password2'] = $post['password2'];
		$data['salutation'] = $post['salutation'];
		$data['lastname'] = $post['lname'];
		$data['email'] = $post['email'];
		$data['phone'] = $phone;
		$data['extension'] = $post['phone_ext'];
		$data['cellphone'] = $altphone;
		$data['question'] = $post['question'];
		$data['answer'] = $post['answer'];
		$data['hear'] = $post['hear'];
		$data['activation'] = JUtility::getHash( JUserHelper::genRandomPassword() );
		$data['registerDate'] = $registerdate;
		$usertype = 'Registered';
		$data['usertype'] = $usertype;
		$data['user_type'] = '16';
		$data['gid']='18';
		$data['block'] = 1;
		if(!$user->bind($data)) {

		echo $user->getError();
		
		}else {
		if (!$user->save()){
		echo $user->getError();
		
		}
		}
		$property_owner['user_id'] = $user->id;
		$property_owner['steetaddress'] = $steetaddress;
		$property_owner['city'] = $city;
		$property_owner['state'] = $sate;
		$property_owner['zipcode'] = $zipcode;
		$property_owner['altemail'] = $altemail;
		$property_owner['altphone_ext'] = $altphone_ext;
		$property_owner['fax'] = $fax;
		$model = $this->getModel('propertymanager');  
	    $data = $model->propertyowner_details($property_owner);
		
		
		/*if($accept == 'yes')
		{
		$fname = $post['fname'];
		//$property['property_image']    =$filename;
		$link_value = '1';
		$lname = $post['lname'];
		$property['boardposition'] = $post['property_state1'];
		$property['property_name'] = JRequest::getVar('property_name','');
		$salutation      =             $post['salutation'];
	    $property['manages']				= $user->id;
		$property['property_manager_id']    = $post['property_manager_id'];
        //$property['propertyowner_manage'] = $user->id;
		$property['street'] = $post['property_street'];
		$property['tax_id'] = $ein_number;
		$property['city'] = $post['property_city'];
		$property['state'] = $post['property_state'];
		$property['divcounty'] = $post['divcounty'];
		$property['zip'] = $post['property_zip'];
		$property['accept'] = $accept;
		$property['timezone'] = $post['timezone'];
		$property['location'] = $post['location'];
        $property['units'] = $post['units'];
		$property['createtime'] = $registerdate;
		$property['property_link'] = '1';
		$db= JFactory::getDBO();
		
		 $property['property_id'] = JRequest::getVar('property_id','');
		 $query_manager = "SELECT user_id FROM #__cam_board_mem WHERE property_name = '".$property['property_id']."' ";
		 $db->setQuery( $query_manager );
		 $managerid = $db->loadResult();
		  $sql_update = "UPDATE #__cam_property SET propertyowner_manage='".$user->id."', boardposition='".$property['boardposition']."', property_manager ='".$managerid."',property_link='1' where id='".$property['property_id']."'";
		$db->Setquery($sql_update);
		$db->query();
	  	$updatelink="UPDATE #__cam_board_mem SET firstname='".$fname."',board_position='".$property['boardposition']."' ,link_value='".$link_value."',lastname ='".$lname."', phone= '".$phone."', link_status='1', linkvalue='2' where email='".$email."' AND property_name = '".$property['property_id']."' AND user_id='".$managerid."'";
		$db->Setquery($updatelink);
		$db->query();
		$model = $this->getModel('propertymanager');  
	    $data = $model->property_details($property);
		
		}
		else if($accept == 'no')
		{
	    $property['property_id'] = JRequest::getVar('property_id','');
		$property['property_name'] = JRequest::getVar('property_name','');
		$property['manages']				= $user->id;
		$property['property_manager_id']    = $post['property_manager_id'];
		$property['location']    = $post['location'];
        $property['tax_id'] = $ein_number;
		$property['boardposition'] = JRequest::getVar('boardposition','');
		$property['street'] = $post['property_street'];
		$property['city'] = $post['property_city'];
		$property['state'] = $post['property_state'];
		$property['divcounty'] = $post['divcounty'];
		$property['zip'] = $post['property_zip'];
		$property['timezone'] = $post['timezone'];
		$property['location'] = $post['location'];
		$property['accept'] = $accept;
		$property['property_image'] ='';
		$property['units'] = $post['units'];
		$property['createtime'] = $registerdate;
		$db= JFactory::getDBO();
	    $query_manager = "SELECT user_id FROM #__cam_board_mem WHERE property_name = '".$property['property_id']."'";
		$db->setQuery( $query_manager );
		$managerid = $db->loadResult();
		$sql_update = "UPDATE #__cam_property SET propertyowner_manage='".$user->id."', property_manager ='".$managerid."',property_link='1' where id='".$property['property_id']."'";
		$db->Setquery($sql_update);
		$db->query();
		$updatelink="UPDATE #__cam_board_mem SET link_status='1' where email='".$email."' AND property_name='".$property['property_id']."' AND user_id='".$managerid."'";
		$db->Setquery($updatelink);
		$db->query();
		$model = $this->getModel('propertymanager');  
	    $data = $model->property_details($property);
		
		}
		else
		{*/
		//echo '<pre>';print_r($post);exit;
		$board_position = $post['property_state1'];
		$property['property_image']    ='';
		$property['property_name'] = str_replace(' ','_', $post['property_name1']);
		$property['property_manager_id']				= $user->id;
		$property['propertyowner_manage'] = $user->id;
		$property['manages']				= $user->id;
		$property['tax_id'] = $ein_number;
		$property['street'] = $post['property_street'];
		$property['city'] = $post['property_city'];
		$property['state'] = $post['property_state'];
		$property['divcounty'] = $post['divcounty'];
		$property['zip'] = $post['property_zip'];
		$property['timezone'] = $post['timezone'];
		$property['location'] = $post['location'];
		$property['units'] = $post['units'];
		$property['createtime'] = $registerdate;
		$property['activation'] = $registerdate;
		$property['boardposition'] = $post['property_state1'];
		$model = $this->getModel('propertymanager');  
	    $data = $model->property_stores($property);
		$query_id = "SELECT id FROM #__cam_property WHERE property_manager_id = '".$user->id."'";
		$db->setQuery( $query_id );
		$propertyid = $db->loadResult();
		
		$update_invitation = "SELECT boardmem_id FROM #__cam_propertyowner_link WHERE email = '".$email."'";
		$db->setQuery( $update_invitation );
		$linkid = $db->loadResult();
	    if($linkid)
		{
		$sql_update = "UPDATE #__cam_propertyowner_link SET propertyowner_id='".$user->id."' where email='".$email."'";
		$db->Setquery($sql_update);
		$db->query();
		$sql_update = "UPDATE #__cam_board_mem SET board_position='".$property['boardposition']."' where email='".$email."'";
		$db->Setquery($sql_update);
		$db->query();
		}	
		
		$property['property_id'] = $propertyid;
		$data1 = $model->property_ownerdetailstored($property);
		if($user->id)
			{
		        $link = "SELECT activation FROM #__users WHERE id = '".$user->id."'";
		        $db->setQuery( $link );
		        $link = $db->loadResult();
 		        $mailfrom= 'support@myvendorcenter.com';
				$fromname = 'MyVendorCenter Team';
			    $to = 'rizecama@gmail.com';
				$siteURL		= JURI::base();
				$useractivation = $siteURL."index.php?option=com_camassistant&controller=vendors&Itemid=158&task=mail_redirect_form&useractivation=".$link."&view=vendors'";
				$link = "<a href=".$siteURL."=".$vendor['activation']."&view=vendors'>CLICK HERE</a>"; 
				$mailsubject = 'Registration Verification';
				$mail_sending= "SELECT introtext FROM #__content where id='148' ";
				$db->Setquery($mail_sending);
				$content = $db->loadResult();
				$link = '<a href="'.$useractivation.'">CLICK HERE</a>';
				$customer_name = $post['fname'].' '.$post['lname'] ;
			    $body = str_replace('{customer name}',$customer_name,$content) ;
				$body = str_replace('{CLICK HERE}',$link,$body) ;
				$body = str_replace('{LINK}',$useractivation,$body);
				$assignuseremail = $post['email'];
				$mail_send = JUtility::sendMail($mailfrom, $fromname, $to, $mailsubject, $body, $mode = 1);
				JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
			    $this->setRedirect( 'index.php?option=com_camassistant&controller=propertymanager&view=propertymanager&task=propertyowner_last&Itemid=57' );	
		        }
	           }
	function usercheck()
	{
	$db =& JFactory::getDBO();
	$mail = JRequest::getVar('mailid','');
	$query_email="SELECT username FROM #__users WHERE username='".$mail."' or email='".$mail."'";
	$db->setQuery( $query_email );
	$result_email = $db->loadResult();
	if($result_email)
	$msg=1;
	else
	$msg=0;
	
	echo $msg; 
	exit;
	
	}
    function ajaxcounty(){
		$state = $_REQUEST['State'];
		$db=JFactory::getDBO();
        $countie = "SELECT * FROM #__cam_counties WHERE State='".$state."' ORDER BY County ";
		$db->setQuery($countie);
		$db->Query();
		$counties = $db->loadObjectList(); ?>
<option value="" >Please Select County</option>
			
		 	<?php
			foreach($counties as $county)
			{
			echo"<option value=".$county->id.">".$county->County."</option>";
			
			} 
		exit; 
		}

}
?>
