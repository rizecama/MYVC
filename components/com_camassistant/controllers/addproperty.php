<?php
error_reporting(0);
/**
 * @version		1.0.0 camassistant $
 * @package		camassistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport('joomla.application.component.controller');
	
class addpropertyController extends JController
{

	function __construct()
	{
		parent::__construct();
	}
	function display()
	{
	parent::display();

	}
	
	function properties(){
	$model = $this->getModel('addproperty');
	$result = $model->getData();
	parent::display();

	}
	 
	 function addproperty(){
	 
		JRequest::getVar( 'view','addproperty');
		parent::display();
	}
	 function saveproperty(){
	 
	$model = $this->getModel('addproperty');
	$post = JRequest::get('post');
	//$units= JRequest::getVar('units');
	//$units2= str_replace(",","",$units);
	
        if($_REQUEST['pro_type']=='single'){
            $tax_id = $_REQUEST['tax_id3s'];
            $property=$post['property_names'];
			$property_origin=$post['property_names'];
            $street=$post['streets'];
            $city=$post['citys'];
            $state=$post['states'];
            $divcounty=$post['divcountys'];
            $zip=$post['zips'];
			$timezone=$post['timezones'];
			$location=$post['locations'];
			$copyvendor=$post['copyvendors'];
            $units=str_replace(",","",$post['unitss']);
            $files2	=  JRequest::getVar( 'property_images', '', 'files', 'array' );
           $post_image= $post['property_images'];
        } else {
            $tax_id= $_REQUEST['tax_id1']."-".$_REQUEST['tax_id2'];
            $property=$post['property_name'];
			$property_origin=$post['property_name'];
            $street=$post['street'];
            $city=$post['city'];
            $state=$post['state'];
            $divcounty=$post['divcounty'];
            $zip=$post['zip'];
			$timezone=$post['timezone'];
			$location=$post['location'];
			$copyvendor=$post['copyvendor'];
            $units=str_replace(",","",$post['units']);
            $files2	=  JRequest::getVar( 'property_image', '', 'files', 'array' );
             $post_image= $post['property_image'];
        }
	//$post['units'] =$units2;
	$db=&JFactory::getDBO();
	$userid = JRequest::getVar('userid','');
	$check = "SELECT property_name FROM #__cam_property WHERE property_name='".$property."' AND property_manager_id=".$userid." " ;

	$db->setQuery($check);
	$check = $db->loadResult();
	if($check){

	$msg="This property already added by you";
		$url="index.php?option=com_camassistant&controller=addproperty&Itemid=".$_REQUEST['Itemid'];
		$this->setRedirect($url,$msg);

	parent::display();
	}
//	echo "<pre>"; print_r($check); exit;
	else {
	$usertype = $_REQUEST['usertype'];
	$db=&JFactory::getDBO();
	if($usertype == 13)
	{
		$query = "SELECT id FROM #__cam_camfirminfo WHERE cust_id=".$_REQUEST['userid'];
		$db->setQuery($query);
		$comp_id = $db->loadResult();
		$post['property_manager_id'] = JRequest::getVar('userid');
		$post['camfirmid'] = 0;
	}
	else if($usertype == '12'){
		$query = "SELECT comp_id FROM #__cam_customer_companyinfo WHERE cust_id=".$_REQUEST['userid'];
		$db->setQuery($query);
		$comp_id = $db->loadResult();
		
		$query = "SELECT cust_id FROM #__cam_camfirminfo WHERE id=".$comp_id;
		$db->setQuery($query);
		$creator = $db->loadResult();
	
		$post['property_manager_id'] = JRequest::getVar('userid');
		$post['camfirmid'] = $creator;
		
	}
	else if($usertype == '16'){
		
		$post['propertyowner_manage'] = JRequest::getVar('userid');
	
	}
	
	$post['company_id'] = $comp_id;
	$property = preg_replace("/[&:;=`{}'!@#$%^*(?)-+|]/","_",$property);
	$property = str_replace('\\','_',$property);
	$property = str_replace('/','_',$property);
	$property = ereg_replace('/','_',$property);
	$property = str_replace('.','_',$property);	
	$property = str_replace(',','_',$property);	
	$property = str_replace('[','_',$property);	
	$property = str_replace(']','_',$property);	
	$property = ereg_replace('-','_',$property);	
	$property = ereg_replace('"','_',$property);	
	$property = str_replace('\\','_',$property);		
	$property = str_replace(' ','_',$property);			
        $post['property_name'] = $property;
        $post['tax_id'] = $tax_id;
        $post['street'] = $street;
        $post['city'] = $city;
        $post['state'] = $state;
        $post['divcounty'] = $divcounty;
        $post['zip'] = $zip;
		$post['timezone'] = $timezone;
		if( !$location )
		$location = 'no';
		else
		$location = $location;
		
		if( !$copyvendor )
		$copyvendor = '0';
		else
		$copyvendor = '1';
		$post['copyvendor'] = $copyvendor;
		$post['location'] = $location;
        $post['units'] = $units;
        $post['pro_type'] = $_REQUEST['pro_type'];
		$post['property_name_origin'] = $property_origin;
			if($_REQUEST['pro_type']=='single'){
				$post['copy'] = $_REQUEST['board'];
				$post['manages'] = $_REQUEST['userid'];				
				$post['ccemails'] = $_REQUEST['ccemails'];
				$post['property_manager_id'] = $_REQUEST['managerid'];
				
			}
			else{
				$post['copy'] = $_REQUEST['boards'];
				$post['manages'] = $_REQUEST['userid'];
				$post['ccemails'] = $_REQUEST['ccemailsass'];
				$post['property_manager_id'] = $_REQUEST['manageridass'];
				$post['propertyowner_manage'] = JRequest::getVar('userid');
			}
		
	
	// To upload the file 
	jimport('joomla.filesystem.file');
	jimport('joomla.user.helper');
	$files	=  $files2;
	$lastDot = strrpos($files['name'], ".");
	$files['name'] = str_replace(".", "", substr($files['name'], 0, $lastDot)) . substr($files['name'], $lastDot);
    $model = $this->getModel('addproperty');  
	$data = $model->store($post);
      
	$insert_id = $db->insertid();
	
	if($files['name'])
			{
				$files1= str_replace(' ','_',$files['name']); 		
				$files1= str_replace('&','_',$files1); 		
				$files1= str_replace('#','_',$files1); 		
				$files1= str_replace('%','_',$files1); 	
				$files1= str_replace(',','_',$files1);
				
				$filename  = $files1;
				$extension = end(explode('.', $filename));
				$new       = $insert_id.'.'.$extension;
				
				$post_image = $new;				
				$updateuser['image']	= $new;
				jimport('joomla.filesystem.file');
				$filename =$updateuser['image']; 
				$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'property_pictures'.DS.'original'.DS;
				$filepath = $base_Dir . $filename;
				$post['image'] = $filename;
				if(file_exists($base_Dir . $filename)){ //echo 'in unlink';
				@unlink($base_Dir . $filename); }
				move_uploaded_file($files['tmp_name'], $filepath); 
				$resize_pimage = $model->resize_pimage($files,$filepath,$filename);
				$update_rfpinfo="UPDATE #__cam_property  SET property_image='".$post_image."' where id=".$insert_id."";
				$db->setQuery($update_rfpinfo);
				$res=$db->query();
				
			}
	//Completyed

	
	
	
	$cc = $_REQUEST['cc'];
	if($cc != '')
	{
		$ccmails = array();
		$ccmails = explode(",",$cc);
		 if(count($ccmails)>0){
				for($i=0; $i<count($ccmails); $i++){
				$db = JFactory::getDBO();
				$user = JFactory::getUser();
				$useremail = $user->email;
				$username = $user->name;
				$ccseperate = $ccmails[$i]; 
				$fromname = $username; 
				$fromemail = $useremail;
				$subject = 'New Property Created';
				
 		$bmember = "SELECT introtext  FROM #__content where id='161' ";
		$db->setQuery($bmember);
		$bmember = $db->loadResult();
		//echo $bmember;

				$msg = $bmember;
				$msg = str_replace('{Customer Name}', $username, $msg);
				$res = JUtility::sendMail($fromemail, $fromname, $ccseperate, $subject, $msg, $mode=1);
				}
			}
	}	
		$msg="Property added successfully";
		$url="index.php?option=com_camassistant&controller=addproperty&Itemid=".$_REQUEST['Itemid'];
		$this->setRedirect($url,$msg);
	//parent::display();
}
	 }

function view(){
	$model = $this->getModel('addproperty');
	$result = $model->getpdetails();
	parent::display();
}
function specific(){
	/*$model = $this->getModel('addproperty');
	$result = $model->getData();*/
	JRequest::getVar( 'view','addproperty');
	parent::display();
}
//
function reasign(){
JRequest::getVar( 'view','addproperty');
	parent::display();
}
//To save/update the reassign manager for a Property
function save_reassign()
{
	$db=JFactory::getDBO();
	$post=JRequest::get('post');
	$popup = JRequest::getVar('pop','');

	$query_type = "SELECT user_type,accounttype FROM #__users WHERE id=".$post['custid'];
	$db->setQuery($query_type);
	$cust_type = $db->loadObject();
	$type = $cust_type->user_type ;
	$accounttype = $cust_type->accounttype ;
	
	if($type==13 && $accounttype != 'master'){
			$camfirmid = 0;
	//To update the rfps to  new manager
	//$update_rfpinfo="UPDATE #__cam_rfpinfo  SET cust_id='".$post['custid']."' where property_id=".$post['pid']."";
	//$db->setQuery($update_rfpinfo);
	//$res=$db->query(); 
	
			$query_coid = "SELECT id FROM #__cam_camfirminfo WHERE cust_id=".$post['custid'];
			$db->setQuery($query_coid);
			$companyid = $db->loadResult();
			
	
	//COmpleted
	
	$sql="UPDATE #__cam_property  SET property_manager_id='".$post['custid']."',camfirmid=".$camfirmid.",company_id=".$companyid." where id=".$post['pid'];
	}
	else if($type==13 && $accounttype == 'master'){
			//To update the rfps to  new manager
			//$update_rfpinfo="UPDATE #__cam_rfpinfo  SET cust_id='".$post['custid']."' where property_id=".$post['pid']."";
			//$db->setQuery($update_rfpinfo);
			//$res=$db->query(); 
	
			$query_coid = "SELECT id FROM #__cam_camfirminfo WHERE cust_id=".$post['custid'];
			$db->setQuery($query_coid);
			$companyid = $db->loadResult();
			
			$sql="UPDATE #__cam_property  SET property_manager_id='".$post['custid']."',company_id=".$companyid." where id=".$post['pid'];
	}
	else{	
		$query_comp = "SELECT comp_id FROM #__cam_customer_companyinfo WHERE cust_id=".$post['custid'];
		$db->setQuery($query_comp);
		$comp_id = $db->loadResult();
		
		$query_firm = "SELECT cust_id FROM #__cam_camfirminfo WHERE id=".$comp_id;
		$db->setQuery($query_firm);
		$firm = $db->loadResult();
		//To update the rfps to  new manager
	//$update_rfpinfo="UPDATE #__cam_rfpinfo  SET cust_id='".$post['custid']."' where property_id=".$post['pid']." ";
	//$db->setQuery($update_rfpinfo);
	//$res=$db->query(); 
	
	//COmpleted
		$sql="UPDATE #__cam_property  SET property_manager_id='".$post['custid']."',camfirmid=".$firm." where id=".$post['pid'];
	}
	$db->setQuery($sql);
	$res=$db->query(); 

		if($popup == 'popup'){ 
			echo "<script language='javascript' type='text/javascript'>
			 window.parent.document.getElementById( 'sbox-window' ).close();
			 window.parent.location.reload();
			 </script>";
			 exit;
		}	
	else{	 
	$return = 'index.php?option=com_camassistant&controller=addproperty&task=specific&Itemid=75&cid='.$post['custid'];
	$msg = 'Property reassigned successfully';
	$this->setRedirect( $return, $msg );
	}

}
///Delete proprty
function remove(){
		$post = JRequest::get('request');
		$model = $this->getModel('addproperty');
		$items = $model->getproperty_delete();
		$msg="Property deleted successfully";
		$url="index.php?option=com_camassistant&controller=addproperty&task=property&view=addproperty&Itemid=".$post['Itemid'];
		$this->setRedirect($url,$msg);

}
 function deletepropertyownerproperty()
	 {   
	    $db = JFactory::getDBO();
		$user = JFactory::getUser();
		$post = JRequest::get('request');
		$model = $this->getModel('addproperty');
		$pid = JRequest::getVar('pid','');
		$query_email = "DELETE  FROM #__cam_propertydetails WHERE property_id='".$pid."' and manages=".$user->id."";
		$db->setQuery($query_email);
		$res = $db->Query();
		$msg="Property deleted successfully";
		$url="index.php?option=com_camassistant&controller=addproperty&task=property&view=addproperty&Itemid=".$post['Itemid'];
		$this->setRedirect($url,$msg);
	
		}
//Completed
function bmembers_Save()
	{

		//session_destroy();
		//session_start();
		print_r($_REQUEST);
		$ind_ary = $_REQUEST['id'];
		echo "<pre>"; print_r($ind_ary); exit;
		$_SESSION['industries'] = $ind_ary;
		$ind = implode(',',$ind_ary); 
		
		echo "<script language='javascript' type='text/javascript'>
		var val = '".$ind."';
		window.parent.document.getElementById('industries').value = val;
		window.parent.document.getElementById( 'sbox-window' ).close();
		//window.parent.parent.location.reload();
		 </script>"; 
	}
		function save_boardmember()
	{
		$model	=& $this->getModel('addproperty');
		$Itemid = JRequest::getVar('Itemid','');
		$id = JRequest::getVar('id','');
		$post = JRequest::get('post');
		$user = JFactory::getUser();
		$post['user_id'] = $user->id;
		$post['phone'] = $post['phone_1'].'-'.$post['phone_2'].'-'.$post['phone_3'];
		
		if($model->store_boardmember($post)) {
			$msg = "<font color='red' size='3'><b>Board member saved successfully<b></font>";	
		} else {
			$msg = "Could not add board member";
		}
	
		$link = 'index.php?option=com_camassistant&controller=addproperty&task=boardmemberslist';
		$this->setRedirect( $link,$msg );
	}
function editproperty(){

		$db=JFactory::getDBO();
		$post=JRequest::get('post');
		//$units= JRequest::getVar('units');
		//$units2= str_replace(",","",$units);
	if($_REQUEST['pro_type']=='single'){
            $tax_id = $_REQUEST['tax_id3s'];
            $property=$post['property_names'];
			$property_origin=$post['property_names'];
            $street=$post['streets'];
            $city=$post['citys'];
            $state=$post['states'];
            $divcounty=$post['divcountys'];
            $zip=$post['zips'];
			$timezone=$post['timezones'];
			$location=$post['locations'];
			$copyvendor=$post['copyvendors'];
			if($location)
			$location = 'loc';
			else
			$location = 'no';
			if($copyvendor)
			$copyvendor = '1';
			else
			$copyvendor = '0';
            $units=str_replace(",","",$post['unitss']);
            $files2	=  JRequest::getVar( 'property_images', '', 'files', 'array' );
           $post_image= $post['property_images'];
        } else {
            $tax_id= $_REQUEST['tax_id1']."-".$_REQUEST['tax_id2'];
            $property=$post['property_name'];
			$property_origin=$post['property_name'];
            $street=$post['street'];
            $city=$post['city'];
            $state=$post['state'];
            $divcounty=$post['divcounty'];
            $zip=$post['zip'];
			$timezone=$post['timezone'];
			$location=$post['location'];
			$copyvendor=$post['copyvendor'];
			if($location)
			$location = 'loc';
			else
			$location = 'no';
			if($copyvendor)
			$copyvendor = '1';
			else
			$copyvendor = '0';
            $units=str_replace(",","",$post['units']);
            $files2	=  JRequest::getVar( 'property_image', '', 'files', 'array' );
             $post_image= $post['property_image'];
        }
		$share = JRequest::getVar('share','');
		//$newproperty = JRequest::getVar('property_name','');
		$pid = JRequest::getVar('id','');
		$user_id = JRequest::getVar('userid','');
		
		$property = preg_replace("/[&:;=`{}'!@#$%^*(?)-+|]/","_",$property);
		$property = str_replace('\\','_',$property);
		$property = str_replace('/','_',$property);
		$property = ereg_replace('/','_',$property);
		$property = str_replace('.','_',$property);	
		$property = str_replace(',','_',$property);	
		$property = str_replace('[','_',$property);	
		$property = str_replace(']','_',$property);	
		$property = ereg_replace('-','_',$property);	
		$property = ereg_replace('"','_',$property);	
		$property = str_replace('\\','_',$property);		
		$property = str_replace(' ','_',$property);
                
		$post['property_name'] = $property;
                $post['tax_id'] = $tax_id;
                $post['street'] = $street;
                $post['city'] = $city;
                $post['state'] = $state;
                $post['divcounty'] = $divcounty;
                $post['zip'] = $zip;
				$post['timezone'] = $timezone;
				$post['location'] = $location;
				$post['copyvendor'] = $copyvendor;
                $post['units'] = $units;
                $post['pro_type'] = $_REQUEST['pro_type'];
				
				if($_REQUEST['pro_type']=='single'){
				$post['copy'] = $_REQUEST['board'];
				$post['manages'] = $user_id;				
				$post['ccemails'] = $_REQUEST['ccemails'];
				$post['property_manager_id'] = $_REQUEST['managerid'];
			}
			else{
				$post['copy'] = $_REQUEST['boards'];
				$post['manages'] = $user_id;
				$post['ccemails'] = $_REQUEST['ccemailsass'];
				$post['property_manager_id'] = $_REQUEST['manageridass'];
			}
		$post['property_name_origin'] = $property_origin;
		//$tax_id1 = JRequest::getVar('tax_id1','');
		//$tax_id2 = JRequest::getVar('tax_id2','');
		//$post['tax_id'] = $tax_id1.'-'.$tax_id2;
		$newtaxid = $tax_id;
		$model = $this->getModel('addproperty');
		//$post['units'] =$units2;
		$post['share'] =$share;
		//to change the folder name
		$default = 'components/com_camassistant/doc/';
		$before_details = "SELECT property_name,tax_id FROM #__cam_property WHERE  id='".$pid."'  ";
		$db->setQuery($before_details);
		$beforefiles = $db->loadObject();
		$before_pname = $beforefiles->property_name;

		
		$before_pname = preg_replace("/[&:;=`{}'!@#$%^*(?)-+|]/","_",$before_pname);
		$before_pname = str_replace('\\','_',$before_pname);
		$before_pname = str_replace('/','_',$before_pname);
		$before_pname = ereg_replace('/','_',$before_pname);
		$before_pname = str_replace('.','_',$before_pname);	
		$before_pname = str_replace(',','_',$before_pname);	
		$before_pname = str_replace('[','_',$before_pname);	
		$before_pname = str_replace(']','_',$before_pname);	
		$before_pname = ereg_replace('-','_',$before_pname);	
		$before_pname = ereg_replace('"','_',$before_pname);	
		$before_pname = str_replace('\\','_',$before_pname);		
		$before_pname = str_replace(' ','_',$before_pname);
		
		
		$oldpath = $default.$before_pname.'_'.$beforefiles->tax_id; echo "<br>";
		$newpath = $default.$property.'_'.$newtaxid; 
		if($newpath && $oldpath && $newpath != $oldpath)
		rename($oldpath,$newpath);
		//completed
		
		// To upload the file 
	jimport('joomla.filesystem.file');
	jimport('joomla.user.helper');
	$files	=  $files2;
      
	$lastDot = strrpos($files['name'], ".");
	$files['name'] = str_replace(".", "", substr($files['name'], 0, $lastDot)) . substr($files['name'], $lastDot);
	if($files['name'])
			{
				$files1= str_replace(' ','_',$files['name']); 		
				$files1= str_replace('&','_',$files1); 		
				$files1= str_replace('#','_',$files1); 		
				$files1= str_replace('%','_',$files1); 	
				$files1= str_replace(',','_',$files1);
				
				$filename  = $files1;
				$extension = end(explode('.', $filename));
				$new       = $pid.'.'.$extension;
				
				$post['property_image'] = $new;				
				$updateuser['image']	= $new;
				jimport('joomla.filesystem.file');
				$filename =$updateuser['image']; 
				$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'property_pictures'.DS.'original'.DS;
				$filepath = $base_Dir . $filename;  
				$post['image'] = $filename;
				if(file_exists($base_Dir . $filename)){ //echo 'in unlink';
				@unlink($base_Dir . $filename); }
				move_uploaded_file($files['tmp_name'], $filepath);
				// To resize the image
				$resize_pimage = $model->resize_pimage($files,$filepath,$filename);
				//Completed
			}
		else{
		$post['property_image'] = $_REQUEST['first_image'];	
		}	
	//Completyed

		$sql="UPDATE #__cam_property  SET share='".$post['share']."' where id=".$pid;
		$res = $db->setQuery($sql);
		if($model->store($post)) {
		
		$paths = "SELECT * FROM #__cam_propertydocs WHERE  property_id='".$pid."' ";
		$db->setQuery($paths);
		$docpaths = $db->loadObjectList();

		for($p=0;$p<count($docpaths); $p++){
		$docpath = $default.$property.'_'.$newtaxid;
		$docpath = str_replace(' ','_',$docpath);
		$docpath = str_replace($oldpath,$newpath,$docpaths[$p]->docPath);
		$sql_path="UPDATE #__cam_propertydocs  SET docPath='".$docpath."' where id=".$docpaths[$p]->id." and property_id=".$pid." ";
		$db->Setquery($sql_path);
		$db->query();
		}
		$mesg = "<b>Property updated successfully<b>";	
		$link = 'index.php?option=com_camassistant&controller=addproperty&Itemid=75';
		$this->setRedirect( $link,$mesg );
		} else {
		$mesg = "NOt updated";
		}
}
function ajaxcounty(){
$state = $_REQUEST['State'];
$db=JFactory::getDBO();
 $countie = "SELECT * FROM #__cam_counties WHERE State='".$state."' ORDER BY County ";
		$db->setQuery($countie);
		$db->Query();
		$counties = $db->loadObjectList(); ?>
		
<option value="" >Please Select County</option>
			
		 	<?php
			foreach($counties as $county)
			{
			echo"<option value=".$county->id.">".$county->County."</option>";
			
			} 
		exit; 
		}

//Verify taxid
	function verfirytaxid()
	{

		$db =& JFactory::getDBO();
		$user=& JFactory::getUser();
		$Taxid=$_POST['queryString'];
		$type=$_POST['type'];
		
		if ($Taxid != "")
		{
		$query_Taxid="SELECT P.tax_id FROM #__cam_property as P, #__users as U WHERE P.tax_id='".$Taxid."' and P.property_manager_id='".$user->id."' and U.user_type!='16'";
		$db->setQuery( $query_Taxid );
		$result_tax = $db->loadResult();
		if($result_tax){
		$data="invalid"; 
		 }
		}
		echo $data;
		exit;
   }
	//Completed
	//Verify taxid
	function verfirytaxid_edit()
	{
		$db =& JFactory::getDBO();
		$Taxid=$_POST['queryString'];
		$pid=$_POST['pid'];
		if ($Taxid != "")
		{
		$query_Taxid="SELECT tax_id FROM #__cam_property where tax_id='".$Taxid."' AND id!=".$pid." ";
		$db->setQuery( $query_Taxid );
		$result_tax = $db->loadObjectList();
		if($result_tax){
		$data="invalid"; 
		 }
		}
		echo $data;
		exit;
   }
	//Completed
	//Function to delete the property image
	function removeproperty(){
		$db =& JFactory::getDBO();
		$pid = JRequest::getVar('Pid','');
		$query = "UPDATE #__cam_property SET property_image='' WHERE id=".$pid;
		$db->setQuery($query);
		$db->Query();
		echo "can";
		exit;
		
	}
	
	function ajaxcounty_sorting(){
	$state = $_REQUEST['State'];
	$county = JRequest::getVar('county','');
	$db=JFactory::getDBO();
	$countie = "SELECT * FROM #__cam_counties WHERE State='".$state."' ORDER BY County ";
		$db->setQuery($countie);
		$db->Query();
		$counties = $db->loadObjectList(); ?>
			<option value="" >Please Select County</option>
		 	<?php
			for($c=0; $c<count($counties); $c++)
			{ ?>
			<option value="<?php echo $counties[$c]->id ; ?>" <?php if($county == $counties[$c]->id){ echo "selected='selected'"; } ?> ><?php echo $counties[$c]->County; ?></option>
			<?php 
			} 
		exit; 
	}
	
	function getpropertmanagerdetails()
	{
	
     $db =& JFactory::getDBO();
	 $pid = $_REQUEST['pid'];
     $plink = $_REQUEST['plink'];
	 $accept = $_REQUEST['accept'];
	 $Itemid = JRequest::getVar('Itemid','');
	 $model = $this->getModel('addproperty');
	 $managerpropertyinfo = $model->manager_propertydetails($pid);
	 $propertyinfo = $model->propertyowner_property($pid);
	 //echo '<pre>';print_r($propertyinfo);exit;
	 $states = $model->getStates();
	 $county = $model->county1($pid);
	 $county1 = $model->county2($pid);
     $linkedpropertymanager_info= $model->linkedpropertymanager_info($pid);
	 $permisisions = $model->get_propertypermisisions($pid);
	 $proerty = "SELECT property_name from #__cam_property where id='".$pid."'";
	 $db->Setquery($proerty);
	 $proerty = $db->loadResult();
	 $proerty = str_replace('_',' ',$proerty);
     $gettitle = $model->get_position($pid);	
     ?>
	  <table class="my_properties" width="100%" border="0" style="margin:0px 0px; border:1px solid #A3A3A3; background:#F7F7F7">
    <tbody>
    <tr>
    <td align="center">
   <ul style="padding-bottom:26px; padding-top:38px;" class="addednum">
	<?php if ($plink == 'Yes') {?>
	<li><a href="index.php?option=com_camassistant&controller=addproperty&task=editpropertyowner&pid=<?PHP echo $pid; ?>&Itemid=75" >EDIT</a>
	
	</li>
<li class="red_unlink"><a  href="javascript:property_unlink(<?php echo $pid ?>);" >UNLINK</a></li>
	<?php } else {?>
	<li><a href="index.php?option=com_camassistant&controller=addproperty&task=editpropertymanager&pid=<?PHP echo $pid; ?>&Itemid=75" >EDIT</a>
	
	</li>
<li class="linkbarnew"><a  href="javascript:sendinvitation(<?php echo $pid ;?>);" >LINK WITH YOUR MANAGER</a></li>
<li><a href="javascript:deleteownproperty(<?php echo $pid ;?>);" style="color:red" >DELETE</a></li>
	
	<?php }?>
	</ul>
</td></tr>
<tr><td align="center">
 <tr>
    <td>
    <table width="100%" cellspacing="0" cellpadding="0" border="0" style="padding:0px 0px; border:">
  <tbody> <tr>
    <td width="42%" height="20" bgcolor="#707070" style="color:#fff; padding-left:15px;"></td>
	
  </tr>
</tr>
</tbody></table>
<div class="client_info">
<div class="propertyowner_module">
<div class= "property_logo">
<?php if( $plink == 'Yes' && $managerpropertyinfo->property_image !='' ) {?>
<div class="property_logo-img"> 
<img src="components/com_camassistant/assets/images/property_pictures/<?php echo $managerpropertyinfo->property_image; ?>" /></div>
<?php } else if( $plink == 'No' && $propertyinfo->property_image !='' ) { ?>
<div class="property_logo-img">
<a href="javascript:void(0);" id = "uploadedimage" onclick="getpopuppics(<?php echo $pid;?>)"><img src="components/com_camassistant/assets/images/property_pictures/<?php echo $propertyinfo->property_image; ?>" /></a></div>
<?php } else if( $plink == 'No' && $propertyinfo->property_image =='' ) { ?>
<div id="property_logo-img">
<a href="javascript:void(0);" id = "uploadedimage" onclick="getpopuppics(<?php echo $pid;?>)"><img src="components/com_camassistant/assets/images/properymanager/load-img.png" /></a></div>
<?php } else { ?>
<div class="property_logo-img">
<img src="components/com_camassistant/assets/images/properymanager/no-property-image.jpg" /></div>
</div>
<?php } ?>
<div class="manage_section">
     <div class="linkedproperty_management">
	 <?php if ($plink == 'Yes'){?>
          <img src="templates/camassistant_left/images/download.png" >
         <?php } else { ?>
		 <img src="templates/camassistant_left/images/property_unlink.png" alt="#" style="border-bottom: 2px solid #f9c300;">
		 <?php }?>
     </div>
     <div class="linkedproperty_details">
      <?php if($plink == 'Yes' ){ ?>
    <p>Linked with:</p>
    
    <p style="text-transform:capitalize; color:#FFF; font-size:15px"><strong><?php echo $linkedpropertymanager_info->name. '&nbsp;'.$linkedpropertymanager_info->lastname;?></strong></p>
    <p style="margin-bottom:13px;"><strong><a class = "removetagss" href="mailto:<?php echo $linkedpropertymanager_info->email ;?>" ><?php echo $linkedpropertymanager_info->email ;?></strong></a></p>
	<p>Ph: <strong><?php echo $linkedpropertymanager_info->phone; ?></strong>  ext: <strong><?php echo $linkedpropertymanager_info->extension ?></strong></p>
    <?php if($linkedpropertymanager_info->cellphone && $linkedpropertymanager_info->cellphone != '--') { ?>
	<p>Alt.Ph: <strong><?php echo $linkedpropertymanager_info->cellphone; ?></strong></p>
	<?php } ?>
    <p style="margin-bottom:13px;">Fax: <strong><?php echo 'N/A';?></strong></p> 
	<p>Management Firm:</p>
	<p style="color:#fff"> <strong><?php echo $linkedpropertymanager_info->comp_name; ?></strong></p>
	<?php } else {?> 
	 <p style="color:#3b3b3b;margin-bottom: 34px;margin-top: -10px; padding: 0 50px;">This Property is not Linked with a Manager.</p>
    <p style="color:#FFF; font-size:13px;  line-height: 15px; padding: 0 32px;">If you'd like to improve collabration with your property manager to share vendor and project information, please click below</p>
    <p style="margin-bottom:27px; margin-top:28px;"><a  class ="invitemanager_new" href="javascript:sendinvitation(<?php echo $pid ?>);" >INVITE YOUR MANAGER</a></p>
	
	<?php }?>   
    </div>
 </div>
   </div>
 </div>
</div>

<?php if($plink == 'Yes'){ 


?>
<div class="client_information">
<h3>Property information</h3>
<p class="title_position">EIN: <?php echo $managerpropertyinfo->tax_id ;?></p>
<p class="title_position">Title:<span style="color:#77b800;"><strong> <?php echo ucfirst($gettitle) ;?></strong></span></p>
<h2 class="inner_ttl"> <?php echo str_replace('_',' ',$managerpropertyinfo->property_name);?></h2>
<p><?php echo $managerpropertyinfo-> street;?></p>
<p style="margin-bottom:-5px;"> <?php echo  $managerpropertyinfo->city ;?>, <?php echo  $managerpropertyinfo->zip ;?></p>&nbsp;&nbsp;
<p class="title_position">County:<strong> <?php 
for ( $i=0; $i<count($county); $i++ ){
$detail = $county[$i];
if( $detail->divcounty == $detail->cid )
echo  $detail->County;
} ?></strong></span></p>
<p class="title_position">Time Zone:<strong> <?php echo strtoupper($managerpropertyinfo-> timezone) ;?></strong></span></p>
<p class="title_position">No. of Units:<strong> <?php echo  $managerpropertyinfo->units ;?></strong></span></p>
<?php } 
?>
</div>
<?php if( $plink == 'No' )
{?>
<div class="client_information">
<h3 style="margin-top:10px;">Property information</h3>
<p class="title_position">Title:<span style="color:#77b800;"><strong> <?php echo ucfirst($propertyinfo->boardposition) ;?></strong></span></p>
<h2 class="inner_ttl"> <?php echo str_replace('_',' ',$propertyinfo->property_name);?></h2>
<p> <?php echo $propertyinfo->street ;?></p>
<p> <?php 
for ($i=0; $i<count($states); $i++){
    $state = $states[$i];
    if($state->state_id == $propertyinfo->state)
	$satename = $state->state_id;
	} ?>
 <?php echo  $propertyinfo->city;?>, <?php echo $satename ; ?> <?php echo  $propertyinfo->zip ;?></p>&nbsp;&nbsp;
<p class="title_position">County:<strong> 
<?php for ($i=0; $i<count($county1); $i++){
$detail = $county1[$i];
if( $detail->divcounty == $detail->cid )
echo $detail->County;
 } ?> </strong></span></p>
<p class="title_position">Time Zone:<strong> <?php echo strtoupper($propertyinfo->timezone) ;?></strong></span></p>
<p class="title_position">No. of Units:<strong> <?php echo $propertyinfo->units ;?></strong></span></p>
</div>
<div class="client_information border-p">
<p class="title_position1">Note: If your Property is linked with a Manager, your account permissions will appear here. To request your Manager join MyVendorCenter or to link your accounts, please click INVITE YOUR MANAGER on the left or LINK WITH YOUR MANAGER above.</p>
<?php }?>
</div>
<div class="client_information border-p">
<?php if ($plink == 'Yes'){?>
<h3>Your Permissions</h3>
<p style="margin-top:-10px; font-size:12px;"> Note: When your Property is linked, permissions are controlled by the Manager. Please contact your Manager directly to request any revisions.</p>
<ul class="permissions_yes">
<li><?php if($permisisions->proposals_p=='1'){?> <img src="templates/camassistant_left/images/premissions_check.png" alt="#"><?php } else {?>  <img src="templates/camassistant_left/images/permission_uncheck.png" alt="#"><?php } ?>Copied on Vendor proposals</li> 
<li> <?php if($permisisions->vendors_p=='1'){?> <img src="templates/camassistant_left/images/premissions_check.png" alt="#"><?php } else {?>  <img src="templates/camassistant_left/images/permission_uncheck.png" alt="#"><?php } ?>Access to "My Vendors" list</li>
 <li><?php if($permisisions->invite_p=='1'){?> <img src="templates/camassistant_left/images/premissions_check.png" alt="#"><?php } else {?>  <img src="templates/camassistant_left/images/permission_uncheck.png" alt="#"><?php } ?>Ability to invite Vendors to requests</li>
 <li><?php if($permisisions->approval_p=='1'){?> <img src="templates/camassistant_left/images/premissions_check.png" alt="#"><?php } else {?>  <img src="templates/camassistant_left/images/permission_uncheck.png" alt="#"><?php } ?>Requires approval before submitting requests </li>
 <li class="permissions_no"><?php if($permisisions->awarding_p=='1'){?> <img src="templates/camassistant_left/images/premissions_check.png" alt="#"><?php } else {?>  <img src="templates/camassistant_left/images/permission_uncheck.png" alt="#"><?php } ?>Requires approval before awarding requests</li>
</ul>

<?php } ?>
 
</div>
</div>
</div>
<?php
	exit; }
      function propertyowner_editform()
              {
			   $db = Jfactory::getDBO();
			   $user = Jfactory::getUser();
			   $pid = JRequest::getVar('pid','');
			   $post = JRequest::get('post');
			   $location = $post['location'];
				if($location)
			      $location = 'loc';
			    else
			      $location = 'no';
				 
			   $property_name = $post['property_name'];
			   $ein1 = $post['ein1'];
			   $ein2 = $post['ein2'];
			   $ein = $ein1.'-'.$ein2;
			   $board_position = $post['board_position'];
			   $divcounty = $post['divcounty'];
			   $streetaddress = $post['streeaddress'];
			   $city = $post['city'];
			   $extension = $post['extension'];
			   $state = $post['state'];
			   $units = $post['units'];
			   $zipcode = $post['zipcode'];
			   $altextension = $post['altextension'];
			   $phone = $post['phone_1'].'-'.$post['phone_2'].'-'.$post['phone_3'];
			   $altphone = $post['altphone_1'].'-'.$post['altphone_2'].'-'.$post['altphone_3'];
			   $fax =   $post['fax_1'].'-'.$post['fax_2'].'-'.$post['fax_3'];
	         $update_pinfo = "UPDATE #__cam_property SET property_name='".$property_name."',location='".$location."',street = '".$streetaddress."', state= '".$state."', zip ='".$zipcode."',tax_id = '".$ein."', divcounty='".$divcounty."', phone='".$phone."', altphone='".$altphone."',pext='".$extension."',fax='".$fax."', altext='".$altextension."',boardposition='".$board_position."',units='".$units."',city='".$city."' where id=".$pid."";
				$db->setQuery($update_pinfo);
				$res=$db->query();
				$mesg = "<b>Property updated successfully<b>";	
		        $link = 'index.php?option=com_camassistant&controller=addproperty&Itemid=75';
		        $this->setRedirect( $link,$mesg );	

            }	 
	
	function sendmanger_link()
	{
		$db = Jfactory::getDBO();
		$user = Jfactory::getUser();
		$post = JRequest::get('post');
		$pid = JRequest::getVar('propertyid','');
		$email = JRequest::getVar('email','');
		$property = JRequest::getVar('property','');
		$model = $this->getModel('addproperty');
		$redirect = '<a href="'.JURI::root().'index.php">CLICK HERE</a>';
		$clientemail ="SELECT introtext FROM #__content where id='319'";
		$db->setQuery( $clientemail );
		$body = $db->loadResult();
		$property_name ="SELECT property_name FROM #__cam_property where id='".$pid."'";
		$db->setQuery( $property_name );
		$pname = $db->loadResult();
		$mailfrom = $user->email;
		$userinfo ="SELECT steetaddress,city,zipcode FROM #__cam_propertyowner_info where user_id='".$user->id."'";
		$db->setQuery( $userinfo );
		$userinfo = $db->loadObject();
		$address1 = $userinfo->steetaddress;
		$address2 =$userinfo->city;
		$address3 =$userinfo->zipcode;
		$address = $address1.'<br>'.$address2.'<br>'.$address3;
		$mailfrom = $user->email;
		$fromname = $user->name.' '. $user->lastname;
		$mailsubject = 'Property Manager Invitation';
		$body = str_replace("[Property Owner's Full Name]",$fromname,$body);
		$body = str_replace('[Property Name]',str_replace('_',' ',$pname),$body);
		$body = str_replace('[Full Address]',$address,$body);
		$body = str_replace('[Phone Number]',$user->phone,$body);
		$body = str_replace('CLICK HERE',$redirect,$body);
		$body = str_replace('[PROPERTY]',$property,$body);
		
		JUtility::sendMail($mailfrom, $fromname, $email, $mailsubject, $body, $mode = 1);
		$clientemail = 'rize.cama@gmail.com';
		JUtility::sendMail($mailfrom, $fromname, $clientemail, $mailsubject, $body, $mode = 1);
		$mesg = "<b>Manager invitation sent succesfully<b>";	
		$link = 'index.php?option=com_camassistant&controller=addproperty&Itemid=75';
		$this->setRedirect( $link,$mesg );		
	}
	
	function unlink_propertymanager()
	{
	
	   $db = Jfactory::getDBO();
	   $user = Jfactory::getUser();
	   $pid = JRequest::getVar("propertyid1",'');
	   $property_name = "SELECT property_name FROM #__cam_property where id='".$pid."'";
	   $db->Setquery($property_name);
	   $property_name = $db->loadResult();
	   $property_name = str_replace('_',' ',$property_name);
	   $model = $this->getModel('addproperty');
	   $managerid = "SELECT user_id FROM #__cam_propertyowner_link where property_id='".$pid."' AND propertyowner_id='".$user->id."'";
	   $db->Setquery($managerid);
	   $managerid = $db->loadResult();
	   $manager = "SELECT name,lastname,username from #__users where id='".$managerid."'";
	   $db->Setquery($manager);
	   $manager = $db->loadObject();
	   $managename = $manager->name.' '.$manager->lastname;
	   $mailfrom = $user->username;
	   $propertyownername = $user->name.' '.$user->lastname;
	   $mangeremail = $manager->username;
	   $userinfo ="SELECT steetaddress,city,state,zipcode FROM #__cam_propertyowner_info where user_id='".$user->id."'";
	   $db->setQuery( $userinfo );
	   $userinfo = $db->loadObject();
	  $address1 = $userinfo->steetaddress;
      $address2 =$userinfo->city;
      $address3 =$userinfo->zipcode;
	  $address4 =$userinfo->state;
      $address = $address1.'<br>'.$address2.',' .'&nbsp;'.$address4 .'&nbsp;' .$address3;
	  $phone = 'Ph:' .'&nbsp;'.$user->phone;
	  $assignuseremail='support@myvendorcenter.com';
	   $mailsubject='Property Unlink Request From Client';
	   $notification = "SELECT introtext  FROM #__content where id='318'";
	   $db->setQuery($notification);
	   $body = $db->loadResult();
	   $body = str_replace("[Manager's Full Name]", $managename, $body);
	   $body = str_replace("[Property Owner's Full Name]", $propertyownername, $body);
	   $body = str_replace('[Full Address]', $address, $body);
	   $body = str_replace('[Phone Number]',  $phone, $body);
	   $body = str_replace('[Property Name]', $property_name, $body);
	   JUtility::sendMail($mailfrom, $propertyownername, $mangeremail, $mailsubject, $body, $mode = 1);
		$assignuseremail = 'rize.cama@gmail.com';
		JUtility::sendMail($mailfrom, $propertyownername, $assignuseremail, $mailsubject, $body, $mode = 1);
	    $mesg = "<b>UNLINK REQUEST SENT TO YOUR MANAGER<b>";	
		$link = 'index.php?option=com_camassistant&controller=addproperty&Itemid=75';
		$this->setRedirect( $link,$mesg );	
	}
	
	
	
		function saveeditpropertfile()
		{
				$pid = JRequest::getVar('pid','');
				$db=JFactory::getDBO();
				jimport('joomla.filesystem.file');
				jimport('joomla.user.helper');
				$files	=  JRequest::getVar( 'property_image', '', 'files', 'array' );
				$lastDot = strrpos($files['name'], ".");
				$files['name'] = str_replace(".", "", substr($files['name'], 0, $lastDot)) . substr($files['name'], $lastDot);
				$files1= str_replace(' ','_',$files['name']); 		
				$files1= str_replace('&','_',$files1); 		
				$files1= str_replace('#','_',$files1); 		
				$files1= str_replace('%','_',$files1); 	
				$files1= str_replace(',','_',$files1);
				$filename  = $files1;
				$extension = end(explode('.', $filename));
				$new       = $pid.'.'.$extension;
				$updateuser['image']	= $new;
				jimport('joomla.filesystem.file');
				$filename =$updateuser['image'];
				$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'property_pictures'.DS.'original'.DS;
				$filepath = $base_Dir . $filename; 
				$post['image'] = $filename;
				if(file_exists($base_Dir . $filename)){ //echo 'in unlink';
				@unlink($base_Dir . $filename); }
				move_uploaded_file($_FILES['property_image']['tmp_name'], $filepath); 
				$model	=& $this->getModel('addproperty');
				$resize_pimage = $model->resize_pimage($files,$filepath,$filename);
				$path2 = $siteURL."components/com_camassistant/assets/images/property_pictures/";
				$path1 = $filename;
				$image = $path2.$path1;	
				$image = str_replace(' ','%20',$image);
				$apath= getimagesize($image);
				$height_orig=$apath[1];
				$width_orig=$apath[0];
				$aspect_ratio = (float) $height_orig / $width_orig;
				$thumb_width =423;
				$thumb_height = round($thumb_width * $aspect_ratio) ;
				if($thumb_height == 0){
				$thumb_height = '300';
				}
				$update_image="UPDATE #__cam_property  SET property_image='".$path1."' where id=".$pid."";
				$db->setQuery($update_image);
				$res=$db->query();
					
				echo "<script language='javascript' type='text/javascript'>
				var filename = '".$filename."';
				window.parent.document.getElementById('uploadimagetextes').innerHTML = '<img src=\'components/com_camassistant/assets/images/property_pictures/".$filename."\' />';
				window.parent.document.getElementById('image_name').value = filename;
				window.parent.document.getElementById( 'sbox-window' ).close();
				 window.parent.location.reload();
				</script>";
				exit;	
		}	
		
		function addpropertyfile()
		{
		
			$db=JFactory::getDBO();
			$pid = JRequest::getVar('pid','');
			jimport('joomla.filesystem.file');
			jimport('joomla.user.helper');
			$files	=  JRequest::getVar( 'property_image', '', 'files', 'array' );
			$lastDot = strrpos($files['name'], ".");
			$files['name'] = str_replace(".", "", substr($files['name'], 0, $lastDot)) . substr($files['name'], $lastDot);
			$files1= str_replace(' ','_',$files['name']); 		
			$files1= str_replace('&','_',$files1); 		
			$files1= str_replace('#','_',$files1); 		
			$files1= str_replace('%','_',$files1); 	
			$files1= str_replace(',','_',$files1);
			$filename  = $files1;
			$extension = end(explode('.', $filename));
			$new       = $pid.'.'.$extension;
			$updateuser['image']	= $new;
			jimport('joomla.filesystem.file');
			$filename =$updateuser['image'];
			$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'property_pictures'.DS.'original'.DS;
			$filepath = $base_Dir . $filename; 
			$post['image'] = $filename;
			if(file_exists($base_Dir . $filename)){ //echo 'in unlink';
			@unlink($base_Dir . $filename); }
			move_uploaded_file($_FILES['property_image']['tmp_name'], $filepath); 
			$model	=& $this->getModel('addproperty');
			$resize_pimage = $model->resize_pimage($files,$filepath,$filename);
			$path2 = $siteURL."components/com_camassistant/assets/images/property_pictures/";
			$path1 = $filename;
			$image = $path2.$path1;	
			$image = str_replace(' ','%20',$image);
			$apath= getimagesize($image);
			$height_orig=$apath[1];
			$width_orig=$apath[0];
			$aspect_ratio = (float) $height_orig / $width_orig;
			$thumb_width =423;
			$thumb_height = round($thumb_width * $aspect_ratio) ;
			if($thumb_height == 0){
			$thumb_height = '300';
			}
			$propertypic="UPDATE #__cam_property SET property_image='".$path1."' where id=".$pid."";
			$db->setQuery($propertypic);
			$db->query();
			echo "<script language='javascript' type='text/javascript'>
			var filename = '".$filename."';
			window.parent.document.getElementById('uploadedimage').innerHTML = '<img width=".$thumb_width."  src=\'components/com_camassistant/assets/images/property_pictures/".$filename."\' />';
			
			 window.parent.document.getElementById( 'sbox-window' ).close();
			 window.parent.location.reload();
			 </script>";
			exit;	
		}
	
	

	function savepropertyfile(){
		$db=JFactory::getDBO();
		jimport('joomla.filesystem.file');
		jimport('joomla.user.helper');
		$files	=  JRequest::getVar( 'property_image', '', 'files', 'array' );
		$lastDot = strrpos($files['name'], ".");
		$files['name'] = str_replace(".", "", substr($files['name'], 0, $lastDot)) . substr($files['name'], $lastDot);
		$files1= str_replace(' ','_',$files['name']); 		
		$files1= str_replace('&','_',$files1); 		
		$files1= str_replace('#','_',$files1); 		
		$files1= str_replace('%','_',$files1); 	
		$files1= str_replace(',','_',$files1);
		$filename  = $files1;
		
		jimport('joomla.filesystem.file');
		$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'property_pictures'.DS.'original'.DS;
		$filepath = $base_Dir . $filename;
		$post['image'] = $filename;
		if(file_exists($base_Dir . $filename)){ //echo 'in unlink';
		@unlink($base_Dir . $filename); }
		move_uploaded_file($_FILES['property_image']['tmp_name'], $filepath); 
		$model	=& $this->getModel('addproperty');
		$resize_pimage = $model->resize_pimage($files,$filepath,$filename);
		$path2 = $siteURL."components/com_camassistant/assets/images/property_pictures/";
		$path1 = $filename;
		$image = $path2.$path1;	
		$image = str_replace(' ','%20',$image);
		$apath= getimagesize($image);
		$height_orig=$apath[1];
		$width_orig=$apath[0];
		$aspect_ratio = (float) $height_orig / $width_orig;
		$thumb_width =226;
		$thumb_height = round($thumb_width * $aspect_ratio) ;
		if($thumb_height == 0){
		$thumb_height = '226';
		}
	
			echo "<script language='javascript' type='text/javascript'>
			var filename = '".$filename."';
		
window.parent.document.getElementById('uplaod_pimage').innerHTML = '<img width=".$thumb_width." height=".$thumb_height." src=\'components/com_camassistant/assets/images/property_pictures/".$filename."\' />';
window.parent.document.getElementById('image_name').value = filename;

			 window.parent.document.getElementById( 'sbox-window' ).close();
			 </script>";
			exit;	
	}
	
		
	
		function savepropertydetails()
		{
				$db = Jfactory::getDBO();
				$user = Jfactory::getUser();
				$post = JRequest::get('post');
				$files	=  JRequest::getVar( 'property_image', '', 'files', 'array' );
				
				$propertyimage = JRequest::getVar('image_name','');
				$location = $post['location'];
				 if( !$location )
		          $location = 'no';
		           else
		           $location = $location;
				$property = $post['property_name'];
				$pinfo['boardposition'] = $post['board_position']; 
				$pinfo['street'] = $post['streeaddress'];
				$pinfo['city'] = $post['city'];
				$pinfo['divcounty']= $post['divcounty'];
				$pinfo['state'] = $post['state'];
				$pinfo['timezone'] = $post['timezone'];
				$pinfo['zip']= $post['zipcode'];
				$pinfo['units'] = $post['units'];
				$pinfo['location'] = $location;
				$pinfo['pext'] = $post['extension'];
				$pinfo['altext'] = $post['altextension'];
				$pinfo['phone'] =      $post['phone_1'].'-'.$post['phone_2'].'-'.$post['phone_3'];
				$pinfo['altphone'] =   $post['altphone_1'].'-'.$post['altphone_2'].'-'.$post['altphone_3'];
				$pinfo['fax'] =   $post['fax_1'].'-'.$post['fax_2'].'-'.$post['fax_3'];
				$pinfo['manages'] =   $user->id;
				$pinfo['property_image'] = $propertyimage;
				$pinfo['property_manager_id'] = $user->id;
				$pinfo['propertyowner_manage'] = $user->id;
				$check = "SELECT property_name FROM #__cam_property WHERE property_name='".$property ."' AND property_manager_id=".$userid." " ;
				$db->setQuery($check);
				$check = $db->loadResult();
				if($check){
						$msg="This property already added by you";
						$url="index.php?option=com_camassistant&controller=addproperty&Itemid=".$_REQUEST['Itemid'];
						$this->setRedirect($url,$msg);
				        }
				       else
				        {
				
							$property = preg_replace("/[&:;=`{}'!@#$%^*(?)-+|]/","_",$property);
							$property = str_replace('\\','_',$property);
							$property = str_replace('/','_',$property);
							$property = ereg_replace('/','_',$property);
							$property = str_replace('.','_',$property);	
							$property = str_replace(',','_',$property);	
							$property = str_replace('[','_',$property);	
							$property = str_replace(']','_',$property);	
							$property = ereg_replace('-','_',$property);	
							$property = ereg_replace('"','_',$property);	
							$property = str_replace('\\','_',$property);		
							$property = str_replace(' ','_',$property);	
							$pinfo['property_name'] = $property;
							$model = $this->getModel('addproperty');
							$model->savenewpropertyinfo($pinfo);
							$sql = "SELECT id FROM #__cam_property where property_name ='".$pinfo['property_name']."' and property_manager_id ='".$user->id."'";
							$db->Setquery($sql);
							$p_id = $db->loadResult();
							
							jimport('joomla.filesystem.file');
							jimport('joomla.user.helper');
							$files	=  $files2;
							$lastDot = strrpos($files['name'], ".");
							$files['name'] = str_replace(".", "", substr($files['name'], 0, $lastDot)) . substr($files['name'], $lastDot);
							if($files['name'])
							{
							$files1= str_replace(' ','_',$files['name']); 		
							$files1= str_replace('&','_',$files1); 		
							$files1= str_replace('#','_',$files1); 		
							$files1= str_replace('%','_',$files1); 	
							$files1= str_replace(',','_',$files1);
							
							$filename  = $files1;
							$extension = end(explode('.', $filename));
							$new       = $p_id.'.'.$extension;
							$post_image = $new;				
							$updateuser['image']	= $new;
							jimport('joomla.filesystem.file');
							$filename =$updateuser['image']; 
							$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'property_pictures'.DS.'original'.DS;
							$filepath = $base_Dir . $filename;
							$post['image'] = $filename;
							if(file_exists($base_Dir . $filename)){ //echo 'in unlink';
							@unlink($base_Dir . $filename); }
							move_uploaded_file($files['tmp_name'], $filepath); 
							$resize_pimage = $model->resize_pimage($files,$filepath,$filename);
							$update_image="UPDATE #__cam_property  SET property_image='".$post_image."' where id=".$p_id."";
							$db->setQuery($update_image);
							$res=$db->query();
							
							}
				}
				$msg="Property added successfully";
				$link = 'index.php?option=com_camassistant&controller=addproperty&Itemid=75';
				$this->setRedirect( $link,$mesg );	
		}
		
		function checkexsitngmanager()
		{   
				$db= JFactory::getDBO();
				$user=JFactory::getUser();	
				$email = JRequest::getVar('email','');
				$query_email = "SELECT id FROM #__users WHERE username='".$email."'";
				$db->setQuery( $query_email );
				$result_email = $db->loadResult();
				if($result_email)
				$msg=1;
				else
				$msg=0;
				
				echo $msg; 
				exit;
		}
	function checkopenrfps()
		{
			$db= JFactory::getDBO();
			$user=JFactory::getUser();	
			$property_id = JRequest::getVar('pid','');
			$p_id = "SELECT count(id) FROM #__cam_rfpinfo WHERE property_id='".$property_id."' AND rfp_type='rfp'";
			$db->setQuery( $p_id );
			$count = $db->loadResult();
			if($count>=1)
			$msg=1;
			else
			$msg=0;
			echo $msg; 
			exit;
		}
	}
?>
