<?php
/**
 * @version		1.0.0 camassistant $
 * @package		camassistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		
 * @author		
 * @author mail	info@camassistant.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport('joomla.application.component.controller');

class camassistantController extends JController
{
	/**
	 * Custom Constructor
	 */

	function __construct()
	{
		parent::__construct();
	}

	function display()
	{
		parent::display();
	}

// Invite as inhouse vendors //
function inhousevendors()
	{

	//echo "<pre>"; print_r($_REQUEST); exit;
	$post = JRequest::get('get');
	$vendortype = JRequest::getVar( 'vendortype','' );
	$userid = JRequest::getVar( 'userid','');
	$camid = JRequest::getVar( 'camid','');
	$mailfrom = JRequest::getVar( 'email','');
	/*$user = JFactory::getUser();
	echo "<pre>"; print_r($user); exit;*/
			$shareproperty = array(); 
			$db =& JFactory::getDBO();
			$query = "SELECT tax_id,camfirm_license_no FROM #__cam_camfirminfo where cust_id =".$userid;
			$db->setQuery($query);
			$tax=$db->loadObject();
	
	if($tax->tax_id == '')
	{
		$licenseno 	= $tax->camfirm_license_no; 
	}
	else 
	{
		$licenseno = $tax->tax_id; 
	}
	
	$vendor = JRequest::getVar( 'inhousevendors','');
	$vendors = JRequest::getVar( 'inhouse','' );
	$subject = JRequest::getVar( 'subject','' );
	$post['inhousetext'] = JRequest::getVar( 'inhousetext', '', 'get', 'string', JREQUEST_ALLOWRAW );
	$vendortype = JRequest::getVar( 'vendortype','' );
	
	$body = $post['inhousetext'];
	//code to send mail to admin
	$admin = 'support@camassistant.com';
		$siteURL		= "http://vps54914.vps.ovh.ca/";
	$link = '<a href= "'.$siteURL.'index.php?option=com_camassistant&controller=vendors">CAMassistant.com</a>'; 
	//$link = "<a href='camassistant.com/cms/index.php?option=com_camassistant&controller=vendors'>CAMassistant.com</a>"; 
	$body = str_replace('{CAMassistant.com}',$link,$body) ;

	$res = JUtility::sendMail($mailfrom, '', $admin, $subject, $body, $mode=1);

	
	//code to send invitaion mail to vendors list
	$body = $post['inhousetext'];
	$vendors1 = array();
	$vendors1 = explode(",",$vendors);
	$j=0;
	$model = $this->getModel('inviteasinhouse');
	if(count($vendors1)>0){
	for($i=0; $i<count($vendors1); $i++){
	$vendor = $vendors1[$i];
	
	//Generate random number //
	srand ((double) microtime( )*1000000);
	$fei = rand();
	
$db = JFactory::getDBO();
$user	= JFactory::getUser();
$firmid = $user->id;
$query = "SELECT inhousevendors,userid  FROM #__vendor_inviteinfo where inhousevendors='".$vendor."' "; 
$db->setQuery($query);
$email = $db->loadObjectList();
//echo "<pre>"; print_r($email[0]->inhousevendors); print_r($email[0]->userid); exit;

	if($_REQUEST['remail']) {
	$query = "SELECT fei FROM #__vendor_inviteinfo where inhousevendors ='".$_REQUEST['remail']."'";
	$db->setQuery($query);
	$fei=$db->loadObject();
	$invc =  $fei->fei;
	}
	else if($email[0]->inhousevendors == $vendor && $email[0]->userid == $firmid){

 	$query = "SELECT fei FROM #__vendor_inviteinfo where userid=".$firmid." inhousevendors ='".$vendor."'";
	$db->setQuery($query);
	$fei=$db->loadObject();
	$invc =  $fei->fei;

	}
	else {

	srand ((double) microtime( )*1000000);
	$invc = rand();

	
	}
	
	$db =& JFactory::getDBO();
//	$query = "SELECT id FROM #__cam_vendor_company where company_address ='$vendor'";
	 $query = "SELECT id FROM #__users where email ='$vendor'"; 
	$db->setQuery($query);
	$pfiles=$db->loadResult();
//	print_r($pfiles); exit;
	if($tax->tax_id == '')
	{
	$licenseno1 = $licenseno;
	//echo $pfiles->id;
	if($pfiles){
//	echo "In if";
	$siteURL		= JURI::base();
	$licenseno = '<a href="'.$siteURL.'index.php?option=com_camassistant&controller=vendorsaccept&task=vendorsaccept&view=vendorsaccept&liscenseno='.$licenseno1.'&inv_code='.$invc.'">$licenseno</a>';
	} else {
	//echo "<br>";
	//echo "In not if";
	$siteURL		= JURI::base();
	$licenseno = '<a href="'.$siteURL.'index.php?option=com_camassistant&controller=vendorsignup&task=vendorsignup_p1&Itemid=66">$licenseno</a';
	}

	$msg = $body;
	}

	else 
	{
	$licenseno1 = $licenseno;
	if($pfiles){
	$siteURL		= JURI::base();
	$licenseno = '<a href="'.$siteURL.'index.php?option=com_camassistant&controller=vendorsaccept&task=vendorsaccept&view=vendorsaccept&liscenseno='.$licenseno1.'&inv_code='.$invc.'">$licenseno</a>';
	} else {
	$siteURL		= JURI::base();
	$licenseno = '<a href="'.$siteURL.'index.php?option=com_camassistant&controller=vendorsignup&task=vendorsignup_p1&Itemid=66">$licenseno</a>';
	}
	//$licenseno = "<a href='camassistant.com/cms/index.php?option=com_camassistant&controller=vendorsaccept&task=vendorsaccept&view=vendorsaccept'>$licenseno</a>";

//echo $licenseno; exit;
$msg = $body;
	}
	$invc1 = $invc;
	if($pfiles){
	$siteURL		= JURI::base();
	$invc = '<a href="'.$siteURL.'index.php?option=com_camassistant&controller=vendorsaccept&task=vendorsaccept&view=vendorsaccept&liscenseno='.$licenseno1.'&inv_code='.$invc1.'">$invc</a>';
	}else {
	$siteURL		= JURI::base();
	$invc = '<a href="'.$siteURL.'index.php?option=com_camassistant&controller=vendorsignup&task=vendorsignup_p1&Itemid=66">$invc</a>';
	}
	//echo $invc; exit;
//	$msg = $msg);
	
	
	//echo $pfiles;
if($pfiles){
	$siteURL		= JURI::base();
	 $link = '<a href="'.$siteURL.'index.php?option=com_camassistant&controller=vendorsaccept&task=vendorsaccept&vendor_type='.$vendortype.'&view=vendorsaccept&Itemid=153&liscenseno='.strip_tags($licenseno1).'&inv_code='.$invc1.'&mailid='.$vendor.'&camid='.$_REQUEST['camid'].'&Itemid=153">'.$siteURL.'index.php?option=com_camassistant&controller=vendorsaccept&task=vendorsaccept&vendor_type='.$vendortype.'&view=vendorsaccept&Itemid=153&liscenseno='.strip_tags($licenseno1).'&inv_code='.strip_tags($invc1).'&camid='.$_REQUEST['camid'].'&Itemid=153</a>'; 
$msg = $msg.$link;

}else {

//$firs_par = explode( '</p>', $msg );
//$firs_par_output = strip_tags( $firs_par[0] );

//$link =  $msg;
$link = $link."<br><br>";
$db = JFactory::getDBO();
$user	= JFactory::getUser();
if($_REQUEST['vendortype'] == 'preferred'){
$query1 = "SELECT introtext  FROM #__content where id='159' "; 
}else {
$query1 = "SELECT introtext  FROM #__content where id='160' "; 
}

$db->setQuery($query1);
$message = $db->loadResult();
$message = str_replace('{CAM Firm}',$user->name,$message);
$link = $link.$message;
$db = JFactory::getDBO();
$user = JFactory::getUser();
$link =$link."Sincerely,<br><br>".$user->name."<br><br>";
$link = $link."<font color='8FD800'>This is for registration</font>"."<br>";
$siteURL		= JURI::base();
$link = $link.'<a href="'.$siteURL.'index.php?option=com_camassistant&controller=vendorsignup&task=vendorsignup_p1&Itemid=66">'.$siteURL.'index.php?option=com_camassistant&controller=vendorsignup&task=vendorsignup_p1&Itemid=66</a>'; 
$link = $link."<br><br>";
$link = $link."<font color='8FD800'>This is for accepting invitation</font>"."<br>";


$link = $link.'<a href="'.$siteURL.'index.php?option=com_camassistant&controller=vendorsaccept&task=vendorsaccept&vendor_type='.$vendortype.'&view=vendorsaccept&liscenseno='.strip_tags($licenseno1).'&inv_code='.strip_tags($invc1).'&mailid='.$vendor.'&camid='.$_REQUEST['camid'].'&Itemid=153">'
.$siteURL.'index.php?option=com_camassistant&controller=vendorsaccept&task=vendorsaccept&view=vendorsaccept&vendor_type='.$vendortype.'&liscenseno='.strip_tags($licenseno1).'&amp;inv_code='.strip_tags($invc1).'&camid='.$_REQUEST['camid'].'&Itemid=153
</a>';

$msg = $link;

}
//echo $link;
//exit;
//$msg = $msg.$link;

	//$msg = str_replace('{CAMassistant.com}',$link,$msg) ;
	
$msg = str_replace('{CAMassistant.com}',$link,$msg) ;
	$res = JUtility::sendMail($mailfrom, '', $vendor, $subject, $msg, $mode=1);
	//end of code to send invitaion mail to vendors list
	
	//code to save info to db
	$post['inhousetext'] = $msg;
	$post['fei'] = strip_tags($invc1);
	$post['inhousevendors'] = $vendor;
	$post['vendortype'] = $vendortype;
	$post['v_id'] = $pfiles;
	//echo "<pre>"; print_r($post); exit;
	if($tax->tax_id == '')
	{
		$post['licenseno'] = strip_tags($licenseno1);
		$post['taxid'] = '';
	}
	else 
	{
		$post['licenseno'] = '';
		$post['taxid'] = $tax->tax_id;
	}
	
$db = JFactory::getDBO();
$user	= JFactory::getUser();
$query = "SELECT inhouse  FROM #__vendor_inviteinfo where userid = ".$firmid." and inhousevendors='".$post['inhousevendors']."' "; 
$db->setQuery($query);
$email = $db->loadResult();

	
	if(!$_REQUEST['remail'] && $email != $post['inhousevendors']) {
	$success = $model->store($post);
	}
	else {
	$success = 'success';
	}
	}
	if($success)
	{
		$msg = 'Your invitation has been sent successfully';
	
	}  
	else 
	{
		$msg = 'Your invitation sending was failed';
	}
	
	}//end - if(count($vendors1)>0)
	 else {
	$return = JURI::base();
	$msg = 'Your invitation sending was failed';
	}//end - if(count($vendors1)>0)
	$url = "index.php?option=com_camassistant&controller=vendorscenter&task=vendorscenter&view=vendorscenter&Itemid=".$_REQUEST['Itemid'];
	$this->setRedirect( $url, $msg );
}
//invite inhouse vendors completed//
function exclude(){
		$post = JRequest::get('post');
		$db = JFactory::getDBO();
		$user	= JFactory::getUser();
		$id = $user->id;
		$from = $user->email;
		$tax = JRequest::getVar('tax','');
		$email = "SELECT U.email FROM #__users as U, #__cam_vendor_company as V   where V.tax_id ='".$tax."' and V.user_id =U.id ";
		$db->setQuery($email);
		$taxmail=$db->loadResult();
		
		if($taxmail){
		$exvemail = $taxmail;
		} else{
		$exvemail = '';
		}

		$query = "SELECT vid FROM #__vendor_inviteinfo where inhouse ='".$exvemail."' and taxid =".$tax."and userid =".$id." ";
		$db->setQuery($query);
		$vid=$db->loadObject();
	 	$vid =  $vid->vid;

		
		if(!$vid) {
		$db = JFactory::getDBO();
		$camid = JRequest::getVar('camid','');
		$tax = JRequest::getVar('tax','');
		$exculdetext = JRequest::getVar('exculdetext','');
		$vendortype = JRequest::getVar('vendortype','');
		$exculdetext = JRequest::getVar('exculdetext','');
		$subject = 'Excluded';
		$status = 'Excluded';
		$exclude = 1;
		
		$email = "SELECT U.email,U.id FROM #__users as U, #__cam_vendor_company as V where V.tax_id ='".$tax."' and V.user_id =U.id ";
		$db->setQuery($email);
		$taxmail=$db->loadObjectList();
		if($taxmail[0]->email){
		$taxmail[0]->email = $taxmail[0]->email;
		} else{
		$taxmail[0]->email = '';
		}
		
		$query_new = "INSERT INTO #__vendor_inviteinfo (userid,v_id,taxid,vendortype,inhousevendors,inhouse,subject,inhousetext,status,exclude) VALUES(".$camid.",'".$taxmail[0]->id."','".$tax."','".$vendortype."','".$taxmail[0]->email."','".$taxmail[0]->email."','".$vendortype."','".addslashes($exculdetext)."','".$status."','".$exclude."')";

		$db->setQuery($query_new);
		if($db->query($query_new)){
		$msg = 'The vendor with this TAX ID has successfully been excluded.';
		$link = 'index.php?option=com_camassistant&controller=vendorscenter&task=vendorscenter&view=vendorscenter&Itemid=120';
		$this->setRedirect( $link,$msg );
		}
		}
		else {
		$tax_id="SELECT V.tax_id FROM #__cam_vendor_company as V, #__users as U where U.id=V.user_id and 	 U.email='".$exvemail."'";
		$db->setQuery( $tax_id );
		$tax = $db->loadResult();
		
		$email = JRequest::getVar('inhouse',''); 
		$body = JRequest::getVar('exculdetext','');		
		$body = str_replace('Hi','Hi<br>',$body) ;
		$body = str_replace('list','list<br>Venodr TAX ID:'.$tax,$body) ;
		$body = str_replace('Thank you','<br>Thank you',$body) ;
		$body = str_replace('Thank you','Thank you<br>',$body) ;
	
		$subject = JRequest::getVar('subject','');	
		$subject = 'Excluding vendor';
		$from = $from;	
		$res = JUtility::sendMail($from, '', $exvemail, $subject, $body, $mode=1);
		$query = "SELECT id FROM #__users where email ='".$exvemail."' ";
		$db->setQuery($query);
		$vendorid=$db->loadObject();
		$vendorid =  $vendorid->id;
		$sql = "UPDATE #__vendor_inviteinfo SET exclude=1, vendortype = 'exclude', v_id = '".$vendorid."', taxid='".$tax."' where vid=".$vid.""; 

				$db->Setquery($sql);
				$db->query();

		$msg = 'The vendor with this TAX ID has successfully been excluded.';
		$link = 'index.php?option=com_camassistant&controller=vendorscenter&task=vendorscenter&view=vendorscenter&Itemid=120';
		$this->setRedirect( $link,$msg );
		}
	

}
}
?>
