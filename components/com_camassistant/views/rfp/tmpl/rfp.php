<?php error_reporting(0);
/**
 * @version		1.0.0 camassistant $
 * @package		camassistant
 * @copyright	Copyright © 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport('joomla.application.component.controller');

class rfpController extends JController
{

	function __construct()
	{
		parent::__construct();
	}

	function display()
	{
		parent::display();
	}
	function rfpform()
	{
	
	   JRequest::setVar('view', 'rfp');
		parent::display();
		
	}
 function editrfp()
	{
	
	   JRequest::setVar('view', 'rfp');
		parent::display();
		
	}
	
	 function reviewrfp()
	{
	
	   JRequest::setVar('view', 'rfp');
		parent::display();
		
	}
	/* ---Presonal Hired---- */
	
	function prohired() {
	
				$sql12="SELECT introtext  FROM #__content where id='154' ";
				$db->Setquery($sql12);
				$data12 = $db->loadResult(); 
				$bodytext = str_replace('{CUSTOMER NAME}',$data['name'],$data12);
				$bodytext = str_replace('{PROPERTY}',$data['name'],$bodytext);
				$bodytext = str_replace('{PROPERTY ADDRESS}',$data['name'],$bodytext); 
				$bodytext = str_replace('{INDUSTRY}',$data['name'],$bodytext); 
				$bodytext = str_replace('{GENERAL PROJECT INFORMATION}',$data['name'],$bodytext); 
				$mailfrom = 'support@camassistant.com';
				$fromname = 'Camassistant Team';
				$assignuseremail = $post['email'];
				$mailsubject = 'Approved Registration';
				$body = $bodytext;
				JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body,$mode = 1);
	}
function shareinfo() {
if($_POST[load]=='save'){
$db = JFactory::getDBO();
$user = JFactory::getUSer();
$sql = "UPDATE #__users SET showphone='".$_POST['phone']."',showfax='".$_POST['fax']."',	showaddress='".$_POST['address']."',	showcompany='".$_POST['company']."',showemail='".$_POST['email']."' where id='".$user->id."'"; 
$db->Setquery($sql);
$db->query();
}
JRequest::setVar('view', 'rfp');
parent::display();
	}
	/* ---End Presonal Hired----*/
	
	
	/* ---Sow Hired----*/
	function sowhired() {
		$sql12="SELECT vendors_meet_myproject FROM #__emails where id='1'";
		$db->Setquery($sql12);
		$data12 = $db->loadResult(); 
		$bodytext = str_replace('{CUSTOMER NAME}',$data['name'],$data12);
		$bodytext = str_replace('{PROPERTY}',$data['name'],$bodytext);
		$bodytext = str_replace('{PROPERTY ADDRESS}',$data['name'],$bodytext); 
		$bodytext = str_replace('{INDUSTRY}',$data['name'],$bodytext); 
		$bodytext = str_replace('{GENERAL PROJECT INFORMATION}',$data['name'],$bodytext); 
		//code to send mail to user
		$config = JFactory::getConfig();
		$mailuser = JFactory::getUser();
		$mailfrom = $config->getValue('config.mailfrom');
		$fromname = $config->getValue('config.fromname');
		$useremail = $mailuser->email;
		$mailsubject = 'Approved Registration';
		$body = $bodytext;
		JUtility::sendMail($mailfrom, $fromname, $useremail, $mailsubject, $body,$mode = 1);
	}
	
	/* ---End Of Sow Hired----*/
	
	/* ---End Of Camassitant  Hired----*/
	function hirecamassitant() {
			JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body,$mode = 1);
	
	}
	/* ---End Of CamAssitant Hired----*/
	
	
	/* ---Delete Line Task----*/
	function deletelinetask() {
	
	$db = JFactory::getDBO();
$sql='DELETE FROM `#__cam_rfpsow_linetask` WHERE `task_id` = '.$_POST[queryString].'';
$db->setquery($sql);
$db->query();
	}
	/* ---End Of Line task----*/
	
	
	function linetaskupload()
	{
	   JRequest::setVar('view', 'rfp');
		parent::display();
		}
	
	 function pro_hired()
	{
	
	
		     
	   JRequest::setVar('view', 'rfp');
		parent::display();
		}
function pro_hired_camassitant()
	{
	
	   JRequest::setVar('view', 'rfp');
		parent::display();
		}
		
  function sow_hired()
	{
	
	   JRequest::setVar('view', 'rfp');
		parent::display();
		}
	
	function update_rfp () {
		//echo "<pre>"; print_r($_REQUEST); exit;
		$user=JFactory::getUser();  //For $my
		$basepath=JURI::root(); 
		$db = &JFactory::getDbo();
		$model	=& $this->getModel('rfp');
		$itemid=JRequest::getVar('Itemid',0);
		$show=JRequest::getVar('show','');
		$post	= JRequest::getVar("task",'');
		//echo "<pre>"; print_r($post); exit;
		$proposalDueDate= JRequest::getVar('proposalDueDate');
		$proposaldate=explode(' ',$proposalDueDate);
		$data['proposalDueDate']=$proposaldate[0];
		if($proposaldate[1] == '')
		$proposaldate[1] = '12:00';
		if($proposaldate[2] == '') 
		$proposaldate[2] = 'pm' ;
		$data['proposalDueTime']=$proposaldate[1].strtoupper($proposaldate[2]);
		$work_perform =  JRequest::getVar('work_perform',array()); 
		//print_r(count($work_perform)); exit;
		$site_visit =  JRequest::getVar('site_visit',array());
		if (count($work_perform)>1) {
		$data['work_perform']=implode(',',$work_perform);
		} else {
		$data['work_perform']=$work_perform[0];
		}
		if (count($site_visit)>1) {
		$data['site_visit']=implode(',',$site_visit);
		} else {
		$data['site_visit']=$site_visit[0];
		}
		$bidders_info =  JRequest::getVar('bidders_info',array());
		if($site_visit[0]=='Required prior to bidding')
		$data['bidders_info']=$bidders_info[0];
		else if($site_visit[0]=='Recommended')
		$data['bidders_info']=$bidders_info[1];
		else 
		$data['bidders_info']=$bidders_info[2];
		
		if($data['rfp_type']=='rfp'){
		$data['publish']=1;
	    }else{
    	$data['publish']=0;
        }
		$data['cust_id']=$user->id;
		$createdDate=date('m-d-Y');
		$data['createdDate']=$createdDate;
		$property_id= JRequest::getVar('property_id');
		$industry_id= JRequest::getVar('industry_id');
		$data['property_id']=$property_id;
		$data['industry_id']=$industry_id;
		$projectName= JRequest::getVar('projectName');
		$work_perform_other= JRequest::getVar('work_perform_other');
		$frequency= JRequest::getVar('frequency');
		$startDate= JRequest::getVar('startDate');
		$endDate= JRequest::getVar('endDate');
		$maxProposals= JRequest::getVar('maxProposals');
		$data['maxProposals']=$maxProposals;
		$rfp_type= JRequest::getVar('rfp_type');
		if($rfp_type=='closed'){
		$rfp_type='rfp';
		}
		$terms= JRequest::getVar('terms');
		if($rfp_type=='review'){
		$data['rfp_type']='draft';
		} else if($rfp_type=='closed'){
		$data['rfp_type']='rfp';
		} else {
		$data['rfp_type']=$rfp_type;
		}
		//echo "<pre>"; print_r($data); echo "anand"; print_r($rfp_type); exit;
		//$data['rfp_type']=$rfp_type;
		$data['startDate']=$startDate;
		$data['terms']=$terms;
		$data['update_rfp']='1';
		$data['endDate']=$endDate;
		$data['frequency']=$frequency;
		$data['maxProposals']=$maxProposals;
		$data['projectName']=$projectName;
		if($work_perform_other!='Please Specify')
		$data['work_perform_other']=$work_perform_other;
		$rfpid= JRequest::getVar('rfpid');
		//echo "<pre>"; print_r($data); exit;
		//
		$TempLineItems=$model->get_tempLineTasks($rfpid);
		$data['id']= $rfpid;
		//$link ='index.php?option=com_camassistant&controller=rfp&rfp_type='.$data['rfp_type'].'&task=reviewrfp&rfpid='.$rfpid.'&Itemid='.$itemid;
		
		$rfp_id = $rfpid;
		$line_tasks['rfp_id']=$rfp_id;
		
		
		/*echo "<pre>";
		print_r($data);exit;*/
	if($model->store_update($data)) {
			//$mesg = "<b>RFP submitted successfully<b>";	
			$link = 'index.php?option=com_camassistant&controller=rfpcenter&task=submitedrfp&Itemid=87';
			$this->setRedirect( $link,$mesg );
		} else {
			$mesg = "Could not added RFP";
		}
		$post['rfp_indus_data']=$_SESSION['rfp']['industry'];
		
		$rfp_id = $rfpid;
		$line_tasks['rfp_id']=$rfp_id;
		
		$task_desc =  JRequest::getVar('task_desc',array()); 
		$linetaskname =  JRequest::getVar('linetaskname',array()); 
		$rfpreference =  JRequest::getVar('rfpreference',array()); 
		$linetask_uploads =  JRequest::getVar('linetask_uploads',array()); 
		//echo "<pre>"; print_r($TempLineItems); print_r($task_desc); exit;
		$is_req_taskvendors =  JRequest::getVar('is_req_taskvendors',array());
	
		//code to delete previous tasks
		$query = "DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id; 
		$db->setQuery($query);
		$db->query();
		//end of code
		$updateditems=array();
		$cnt=count($TempLineItems);
		if(count($linetaskname)>0)
		{
			for($i=0;$i<count($task_desc);$i++)
			{
				$line_tasks['task_desc']=$task_desc[$i];
				$line_tasks['linetaskname']=$linetaskname[$i];
				$line_tasks['rfpreference']=$rfpreference[$i];
				$line_tasks['is_req_taskvendors']=$is_req_taskvendors[$i];
				$line_tasks['taskuploads']=$linetask_uploads[$i];
				if($is_req_taskvendors[$i+1] == ''){
				$line_tasks['is_req_taskvendors'] = 0;
				} else {
				$line_tasks['is_req_taskvendors'] = $is_req_taskvendors[$i+1];
				}
				
				//echo "<pre>"; print_r($line_tasks['is_req_taskvendors']);
				/*if($line_tasks['is_req_taskvendors'] == 'on')
				$line_tasks['is_req_taskvendors'] = 1;
				else
				$line_tasks['is_req_taskvendors'] = 0;*/
				$line_tasks['rfp_id']=$rfp_id;
				//
				$lastinsid=$db->insertid();
				$tag1=0; $tag2=0; $tag3=0;
				if($i<$cnt)
				{
					$tag1=strcmp($TempLineItems[$i]->linetaskname,$linetaskname[$i]);
					$tag2=strcmp($TempLineItems[$i]->task_desc,$task_desc[$i]);
					$tag3=strcmp($TempLineItems[$i]->rfpreference,$rfpreference[$i]);
					if($tag1!=0 || $tag2!=0 || $tag3!=0)
					$line_tasks['is_modified'] = 1;
					else
					$line_tasks['is_modified'] = 0;
					//$updateditems[]=$lastinsid;
				} 
				else
				$line_tasks['is_modified'] = 0;
				if($model->tasks_store($line_tasks)) 
				{
					$mesg = "Tasks stored successfully";	
				} else {
					$mesg = "Error saved";
				}
				
				
			}//exit;
		}
		$updateditms=implode(',',$updateditems);
		$sql = "UPDATE #__cam_rfpinfo SET modified_lineitems='".$updateditms."' WHERE id='".$rfp_id."'"; 
		$db->Setquery($sql);
		$db->query();///////
		
		$req_docprice =  JRequest::getVar('require_docprice',array()); 
		$attachmnent =  JRequest::getVar('attachmnent',array()); 
		//print_r($attachmnent); 
		$query = "DELETE FROM #__cam_rfpsow_docs WHERE rfp_id=".$rfp_id; 
		$db->setQuery($query);
		$db->query();
		//if(count($_FILES['attachmnent'])>0)
		//{
			for($i=0;$i<count($attachmnent);$i++)
			{
				//$file=$this->checkImage($_FILES['attachmnent']['name'][$i],$_FILES['attachmnent']['tmp_name'][$i]);
				//if($file)
				//{
					$req_docsow['is_req_docvendors']=$req_docprice[$i];
					//$req_docsow['doc_path']='components/com_camassistant/assets/images/rfp/'.$file;
					//if($attachmnent[$i] == '0'){
					if($attachmnent[$i] == '0'){
					//echo "anand";
					$req_docsow['doc_path']=$attachmnent[$i+1];
					} else {
					//echo "anand123";
					$req_docsow['doc_path']=$attachmnent[$i];	
					}
					//} else {
					//$req_docsow['doc_path']=$attachmnent[$i];	
					//}
					$req_docsow['rfp_id']=$rfp_id;
				//	echo "<pre>"; print_r($req_docsow); exit;
					if($model->reqdocs_store($req_docsow)) {
					$mesg = "Documents stored successfully";	
					} else {
						$mesg = "Error saved";
					}
				//}		
			} //exit;
		//}
		//For Inserting Spl reqs
		$req_parentid =  JRequest::getVar('req_parentid',array());
		$sub_req_id =  JRequest::getVar('sub_req_id',array());
		 $req_id =  JRequest::getVar('req_id',array()); 
		$otherValue1 =  JRequest::getVar('otherValue1');
		$otherValue2 =  JRequest::getVar('otherValue2');
		$otherValue3 =  JRequest::getVar('otherValue3');
		$otherValue =  $otherValue1.'/'.$otherValue2.'/'.$otherValue3;
		$liabilityInsuranceAmount =  JRequest::getVar('liabilityInsuranceAmount');
		//code to delete previous special requirements
		$db = JFactory::getDBO();
		$query = "DELETE FROM #__cam_rfpreq_info WHERE rfp_id=".$rfp_id; 
		$db->setQuery($query);
		$db->query();
		//For Inserting Special Requirement categories in database for RFP 
		if(count($req_parentid)>0)
		{
			for($i=0;$i<count($req_parentid);$i++)
			{
				if(count($sub_req_id[$req_parentid[$i]])>0)
				{
					for($j=0;$j<count($sub_req_id[$req_parentid[$i]]);$j++)
					{ 
						
						if(count($req_id[$sub_req_id[$req_parentid[$i]][$j]])>0)
						{
							for($k=0;$k<count($req_id[$sub_req_id[$req_parentid[$i]][$j]]);$k++)
							{
								$splreq_rfp['rfp_id']=$rfp_id;
								$splreq_rfp['req_parentid']=$req_parentid[$i];
								$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
								$splreq_rfp['req_id']=$req_id[$sub_req_id[$req_parentid[$i]][$j]][$k];
								//
								if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
								$splreq_rfp['price']= $otherValue;
								//
								if($sub_req_id[$req_parentid[$i]][$j]=='12')
								$splreq_rfp['price']=$liabilityInsuranceAmount;
								//
								if($model->rfpsplreqs_store($splreq_rfp)) {
			
								}
							}
						} else {
						
							$splreq_rfp['rfp_id']=$rfp_id;
							$splreq_rfp['req_parentid']=$req_parentid[$i];
							$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
							$splreq_rfp['req_id']=0;
							//
							if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
							$splreq_rfp['price']= $otherValue;
							//
							if($sub_req_id[$req_parentid[$i]][$j]=='12')
							$splreq_rfp['price']=$liabilityInsuranceAmount;
							//
							if($model->rfpsplreqs_store($splreq_rfp)) {
			
							}
						}
					}
				} else {
					$splreq_rfp['rfp_id']=$rfp_id;
					$splreq_rfp['req_parentid']=$req_parentid[$i];
					$splreq_rfp['req_subparentid']=0;
					$splreq_rfp['req_id']=0;
					if($model->rfpsplreqs_store($splreq_rfp)) {
			
					}
				}
				//
			}
		}
		
		
		$property_id =  JRequest::getVar('property_id'); 
		$industry_id =  JRequest::getVar('industry_id'); 
		$userid =  $user->id; 
		//updating mail process
		
	
		//if($_REQUEST['rfp_type']=='rfp'){
		
			//$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&rfp_type='.$data['rfp_type'].'&task=reviewrfp&rfpid='.$rfpid.'&Itemid='.$itemid );
			//$this->setRedirect( 'index.php?option=com_camassistant&controller=rfpcenter&task=submitedrfp&Itemid='.$itemid );
			  // $this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&industry_id='.$industry_id.'&property_id='.$property_id.'&show='.$show.'&rfp_type='.$_REQUEST['rfp_type'].'&task=reviewrfp&rfpid='.$rfp_id.'&Itemid='.$itemid );
		
		//}else 
		if (($_REQUEST['rfp_type']=='review')||($rfp_type=='rfp')){
		        $this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&industry_id='.$industry_id.'&property_id='.$property_id.'&show='.$show.'&rfp_type='.$_REQUEST['rfp_type'].'&task=reviewrfp&rfpid='.$rfp_id.'&Itemid='.$itemid ); 
				
			//} //else if($rfp_type=='closed'){
			// $msg='RFP Submitted Successfully';
	 		// $this->setRedirect( 'index.php?option=com_camassistant&controller=rfpcenter&task=submitedrfp&Itemid=87',$msg );
			 } else {
			  $msg='RFP Unsubmitted(draft) Successfully';
			 $this->setRedirect( 'index.php?option=com_camassistant&controller=rfpcenter&task=unsubmittedrfp&Itemid=88',$msg);
		}
	
	}
	function submit_rfp()
	{
		global $mainframe;
		
		$user=JFactory::getUser();  //For $my
		$basepath=JURI::root(); 
		$db = &JFactory::getDbo();
		$model	=& $this->getModel('rfp');
		$itemid=JRequest::getVar('Itemid',0);
		$show=JRequest::getVar('show','');
		$post = JRequest::get('post');
		
		$proposaldate=explode(' ',$post['proposalDueDate']);
		$post['proposalDueDate']=$proposaldate[0];
		if($proposaldate[1] == '')
		$proposaldate[1] = '12:00';
		if($proposaldate[2] == '') 
		$proposaldate[2] = 'pm' ;
		$post['proposalDueTime']=$proposaldate[1].strtoupper($proposaldate[2]);
		$work_perform =  JRequest::getVar('work_perform',array()); 
		$work_perform_other= JRequest::getVar('work_perform_other');
		if($work_perform_other!='Please Specify')
		$post['work_perform_other']=$work_perform_other;
		//print_r(count($work_perform)); exit;
		//
		$site_visit =  JRequest::getVar('site_visit',array());
		$bidders_info =  JRequest::getVar('bidders_info',array());
		if($site_visit[0]=='Required prior to bidding')
		$post['bidders_info']=$bidders_info[0];
		else if($site_visit[0]=='Recommended')
		$post['bidders_info']=$bidders_info[1];
		else 
		$post['bidders_info']=$bidders_info[2];
		//$post['work_perform']=$work_perform[0];
		//echo "<pre>"; print_r($post); exit;
		if (count($work_perform)>1) {
		$post['work_perform']=implode(',',$work_perform);
		} else {
		$post['work_perform']=$work_perform[0];
		}
		/*if (count($site_visit)>1) {
		$post['site_visit']=implode(',',$site_visit);
		} else {
		$post['site_visit']=$site_visit[0];
		}*/
		$post['site_visit']=$site_visit[0];
		if($post['rfp_type']=='review'){
		$post['publish']=0;
	    }else{
    	$post['publish']=1;
        }
		$post['cust_id']=$user->id;
		$createdDate=date('m-d-Y');
		$post['createdDate']=$createdDate;
		$property_id=JRequest::getVar('property_id');
		$industry_id=JRequest::getVar('industry_id');
		$choose_tasks=JRequest::getVar('choose_tasks');
		if($post['choose_tasks2'])
		$choose_tasks=$post['choose_tasks2'];
		if($post['choose_tasks3'])
		$choose_tasks=$post['choose_tasks3'];
		$amount=$post['liabilityInsuranceAmount'];
		//echo "<pre>"; print_r($choose_tasks); exit;
		$rfpid= JRequest::getVar('rfpid');
		$post['id']= $rfpid;
		$post['rfp_indus_data']=$_SESSION['rfp']['industry'];
		$post['update_rfp']='0';
		// echo "<pre>"; print_r($post); exit;
		$from_name=$user->name;
		$from_email=$user->email;
		$rfp_type =  JRequest::getVar('rfp_type');
		if($rfp_type=='review'){
		$post['rfp_type']= 'draft';
		} else {
		$post['rfp_type']= $rfp_type;
		}
		$post['choose_tasks']= $choose_tasks;
		//echo "<pre>"; print_r($post); exit;
		/*if($post['id'] == '')
		$post['id'] = str_pad(mt_rand(0, 999999), 6, '0', STR_PAD_LEFT); */
		
		if($model->store($post)) {
		
			$mesg = "<font color='red' size='3'><b>RFP stored successfully<b></font>";	
		} else {
			$mesg = "Could not added RFP";
		}
		//added by lalitha
		if(!$rfpid)
		{
			/*$db = JFactory::getDBO();
			$sql = "SELECT max(id) FROM #__cam_rfpinfo ";
			$db->Setquery($sql);
			$rfpinfo_id = $db->loadResult();*/ 
			$rfpinfo_id = $db->insertid();
			$random_id 	 = str_pad(mt_rand(1, 999999), 6, '0', STR_PAD_LEFT);
			$upd_sql = 'UPDATE #__cam_rfpinfo set id='.$random_id.' WHERE id ='.$rfpinfo_id;
			$db->Setquery($upd_sql);
			$db->query();
			
			
		}
		$rfpinfo_id1 = $db->insertid();
		//print_r($rfpinfo_id1); exit;
		//added by lalitha
		if(!$rfpid)
		$rfp_id = $random_id;
		else
		$rfp_id = $rfpid;
		$line_tasks['rfp_id']=$rfp_id;
		$task_desc =  JRequest::getVar('task_desc',array()); 
		$linetaskname =  JRequest::getVar('linetaskname',array()); 
		$rfpreference =  JRequest::getVar('rfpreference',array()); 
		$is_req_taskvendors =  JRequest::getVar('is_req_taskvendors',array());
		$linetask_uploads =  JRequest::getVar('linetask_uploads',array());
		//print_r($is_req_taskvendors);
		//code to delete previous tasks
		$query = "DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id; 
		$db->setQuery($query);
		$db->query();
		//print_r($rfp_id); exit;
		//end of code
		if(count($task_desc)>0)
		{
			for($i=0;$i<count($task_desc);$i++)
			{
				//print_r($is_req_taskvendors); 
				$task_desc1=html_entity_decode($task_desc[$i]);
				$line_tasks['task_desc']=$task_desc1;
				$line_tasks['linetaskname']=$linetaskname[$i];
				$line_tasks['rfpreference']=$rfpreference[$i];
				$line_tasks['is_req_taskvendors']=$is_req_taskvendors[$i];
				$line_tasks['taskuploads']=$linetask_uploads[$i];
				$line_tasks['rfp_id']=$rfp_id;
				//print_r($is_req_taskvendors[$i]);
				if($is_req_taskvendors[$i+1] == ''){
				
				$line_tasks['is_req_taskvendors'] = 0;
				}  else {
				$line_tasks['is_req_taskvendors'] = $is_req_taskvendors[$i+1];
				}
				
				if($model->tasks_store($line_tasks)) {
				$mesg = "Tasks stored successfully";	
				} else {
					$mesg = "Error saved";
				}
			} //exit;
		}
		//print_r($_REQUEST);
		$require_docprice =  JRequest::getVar('require_docprice',array()); 
		$attachmnent =  JRequest::getVar('attachmnent',array()); 
		
		$query = "DELETE FROM #__cam_rfpsow_docs WHERE rfp_id=".$rfp_id; 
		$db->setQuery($query);
		$db->query();
		
			for($i=0;$i<count($attachmnent);$i++)
			{
				
				if($require_docprice[$i+1] == ''){
				
				$req_docsow['is_req_docvendors']=0;
				}  else {
				$req_docsow['is_req_docvendors']= $require_docprice[$i+1];
				}
					
					
					$req_docsow['doc_path']=$attachmnent[$i];	
					//}
					$req_docsow['rfp_id']=$rfp_id;
				//echo "<pre>"; print_r($req_docsow);
					if($model->reqdocs_store($req_docsow)) {
					$mesg = "Documents stored successfully";	
					} else {
						$mesg = "Error saved";
					}
				//}		
			}// exit;
		//For Inserting Spl reqs
		$req_parentid =  JRequest::getVar('req_parentid',array());
		$sub_req_id =  JRequest::getVar('sub_req_id',array());
		$req_id =  JRequest::getVar('req_id',array()); 
		$otherValue1 =  JRequest::getVar('otherValue1');
		$otherValue2 =  JRequest::getVar('otherValue2');
		$otherValue3 =  JRequest::getVar('otherValue3');
		$otherValue =  $otherValue1.'/'.$otherValue2.'/'.$otherValue3;
		$liabilityInsuranceAmount =  JRequest::getVar('liabilityInsuranceAmount');
		
		//code to delete previous special requirements
		$db = JFactory::getDBO();
		$query = "DELETE FROM #__cam_rfpreq_info WHERE rfp_id=".$rfp_id; 
		$db->setQuery($query);
		$db->query();
	
		if(count($req_parentid)>0)
		{
		
			for($i=0;$i<count($req_parentid);$i++)
			{
				if(count($sub_req_id[$req_parentid[$i]])>0)
				{
					for($j=0;$j<count($sub_req_id[$req_parentid[$i]]);$j++)
					{ 
						
						if(count($req_id[$sub_req_id[$req_parentid[$i]][$j]])>0)
						{
							for($k=0;$k<count($req_id[$sub_req_id[$req_parentid[$i]][$j]]);$k++)
							{
								$splreq_rfp['rfp_id']=$rfp_id;
								$splreq_rfp['req_parentid']=$req_parentid[$i];
								$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
								$splreq_rfp['req_id']=$req_id[$sub_req_id[$req_parentid[$i]][$j]][$k];
								//
								if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
								$splreq_rfp['price']= $otherValue;
								//
								if($sub_req_id[$req_parentid[$i]][$j]=='12')
								$splreq_rfp['price']=$liabilityInsuranceAmount;
								//
								if($model->rfpsplreqs_store($splreq_rfp)) {
			
								}
							}
						} else {
						
							$splreq_rfp['rfp_id']=$rfp_id;
							$splreq_rfp['req_parentid']=$req_parentid[$i];
							$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
							$splreq_rfp['req_id']=0;
							//
							if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
							$splreq_rfp['price']= $otherValue;
							//
							if($sub_req_id[$req_parentid[$i]][$j]=='12')
							$splreq_rfp['price']=$liabilityInsuranceAmount;
							//
							if($model->rfpsplreqs_store($splreq_rfp)) {
			
							}
						}
						/*if($model->rfpsplreqs_store($splreq_rfp)) {
			
						}*/
					}
				} else {
					$splreq_rfp['rfp_id']=$rfp_id;
					$splreq_rfp['req_parentid']=$req_parentid[$i];
					$splreq_rfp['req_subparentid']=0;
					$splreq_rfp['req_id']=0;
					if($model->rfpsplreqs_store($splreq_rfp)) {
			
					}
				}
			
			}
	
		}
		if($_REQUEST['rfp_type']=='review'){
			 $this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&industry_id='.$industry_id.'&property_id='.$property_id.'&show='.$show.'&rfp_type='.$post['rfp_type'].'&choose_tasks='.$choose_tasks.'&amount='.$amount.'&task=reviewrfp&rfpid='.$rfp_id.'&Itemid='.$itemid ); 
		
		}else{
	 		 $this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&rfp_type='.$post['rfp_type'].'&task=saverfpmsg&Itemid='.$itemid );
		}
	
	}
	function saverfpmsg()
	{
			global $mainframe;
			
			$user=JFactory::getUser();  //For $my
			$userid = $user->id;
			$basepath=JURI::root(); 
			$db = &JFactory::getDbo();
			$model	=& $this->getModel('rfp');
			$itemid=JRequest::getVar('Itemid',0);
			$show=JRequest::getVar('show','');
			$post = JRequest::get('post');
			$rfpid= JRequest::getVar('rfpid');
			$select="SELECT property_id,cust_id,industry_id,choose_tasks FROM #__cam_rfpinfo WHERE id='".$rfpid."'";
			$db->Setquery($select);
			$result = $db->loadObjectlist();
			
			$property_id=$result[0]->property_id;
			$industry_id=$result[0]->industry_id;
			$userid=$result[0]->cust_id;
			$choose_tasks=$result[0]->choose_tasks;
			//$choose_tasks=$post['choose_tasks'];
			$amount= $post['amount'];
			//echo "<pre>"; print_r($_REQUEST); exit;	
			$rfpid= JRequest::getVar('rfpid');
			$db = JFactory::getDBO();
			$sql = "UPDATE #__cam_rfpinfo SET rfp_type='rfp' WHERE id='".$rfpid."'";  
			$db->Setquery($sql);
			$db->query();
			$updaterfp="SELECT update_rfp FROM #__cam_rfpinfo WHERE id='".$rfpid."'";
			$db->Setquery($updaterfp);
			$status12 = $db->loadResult(); 
			
			//Code for sending Email to Property Manager for this related property 
			$pmdetails=$model->getPManagers($property_id);
			$pr_name=$model->getPropertyName($property_id);
		//echo "<pre>"; print_r($status); 
			//$from_name=$user->name;
			if($status12!='0'){
		//	echo "<pre>"; print_r($post);
			//print_r($industry_id); echo '<br>';print_r($property_id); echo '<br>';print_r($userid);
			$vendorsinfo=$model->getVendors($industry_id,$userid,$property_id); 
			//echo "<pre>"; print_r($vendorsinfo);
		$rfpinvite = "SELECT introtext  FROM #__content where id='162'";
		$db->setQuery($rfpinvite);
		$inviterfp = $db->loadResult();
		
		$updaterfp = "SELECT introtext  FROM #__content where id='163'";
		$db->setQuery($updaterfp);
		$update_rfp = $db->loadResult();
		  if(count($vendorsinfo)>0)
			 {
			  for($i=0;$i<count($vendorsinfo);$i++)
			  {
				$vendoremail=$vendorsinfo[$i][0]->email;
				//echo "<pre>"; print_r($vendoremail);
				$vendorname=$vendorsinfo[$i][0]->name;
				$vendoreid=$vendorsinfo[$i][0]->id;	
				//echo "<pre>"; print_r($vendorsinfo[$i]);
				 $vendorid= "SELECT U.email,U.name,U.id FROM #__users as U LEFT JOIN #__cam_vendor_proposals as P ON P.proposedvendorid=U.id WHERE rfpno=".$rfpid." AND P.proposedvendorid=".$vendoreid; 
				$db->setQuery($vendorid);
				$vendor_email = $db->loadObjectList(); 
				//code to get Mangaername, Camfirmname
				$Managername = $user->name.'&nbsp;'.$user->lastname;
				$camfirmid_sql = "SELECT comp_name FROM #__cam_customer_companyinfo WHERE cust_id=".$user->id;
				$db->SetQuery($camfirmid_sql);
				$camfirmid_res = $db->loadResult();
				$Camfirmname = $camfirmid_res;
				/*if($camfirmid_res == 0)
				$Camfirmname = '';
				else
				{
				  $camfirmid_sql = "SELECT cust_id FROM #__cam_camfirminfo  WHERE id=".$camfirmid_res;
				  $db->SetQuery($camfirmid_sql);
				  $camfirmid_res = $db->loadResult();
				  $camfirmuser = JFactory::getUser($camfirmid_res);
				  $Camfirmname = $camfirmuser->name.'&nbsp;'.$camfirmuser->lastname;
				}*/
								//end of code to get Mangaername, Camfirmname
			//echo '<pre>'; print_r($vendor_email);  
					if(count($vendor_email)>0) // code to send updated rfp mails
					{
							//print_r($vendor_email[$i]->email); exit;
							$vendorid = $vendor_email[0]->id;
							$vendoremail = $vendor_email[0]->email;
							
							//$to = $vendoremail;
							$vendor_name= $vendor_email[0]->name;
							$user=JFactory::getUser();
							$from_name='CAMassistant';
							$from_email='Support@CAMassistant.com';
							$sub='Addendum to RFP '.sprintf('%06d', $rfpid);
							$siteURL		= JURI::base();
							$sql = "SELECT id FROM #__cam_vendor_availablejobs  where rfp_id = ".$rfpid." AND user_id = ".$vendorid;	 
							$db->Setquery($sql);
							$result = $db->loadResult(); 
						//	print_r($result); exit;
							if(count($result)>0)
							{
								$sql = "SELECT id,Alt_bid,proposedvendorid,rfpno FROM #__cam_vendor_proposals  where rfpno = ".$rfpid." AND proposedvendorid= ".$vendorid;	
								$db->Setquery($sql);
								$prp_cnt = $db->loadObjectList(); 
								for($k=0;$k<count($prp_cnt);$k++)
								{
									$link = $siteURL.'index.php?option=com_camassistant&controller=proposals&Alt_Prp='.$prp_cnt[$k]->Alt_bid.'&task=Proposal_edit&Proposal_id='.$prp_cnt[$k]->id.'&vendor_id='.$prp_cnt[$k]->proposedvendorid.'&rfp_id='.$prp_cnt[$k]->rfpno.'&act=Draft&Itemid=107';
									$body = $update_rfp;
									$body = str_replace('{RFP NUMBER}', sprintf('%06d', $rfpid), $body);
									$body = str_replace('{vendor Name}', $vendor_name, $body);
									$body = str_replace('{link}', '<a href="'.$link.'">CLICK HERE</a>', $body);
									$body = str_replace('{camName}', 'CAMassitant', $body);
									$body = str_replace('{Managername}', $Managername, $body);
									$body = str_replace('{Camfirmname}', $Camfirmname, $body);
									//$sub='Invitation to RFP '.sprintf('%06d', $rfpid).' from CAMassistant';
									$sub='Addendum to RFP '.sprintf('%06d', $rfpid);
									$from_name='CAMassistant';
									$from_email='Support@CAMassistant.com';
									$successMail =JUtility::sendMail($from_email, $from_name, $vendoremail, $sub, $body,$mode = 1);
								}
					$sql = "UPDATE #__cam_vendor_proposals SET proposaltype='Draft' where rfpno = ".$rfpid." AND proposedvendorid= ".$vendorid;
					$db->SetQuery($sql);
					$db->query();
							}
						}						
					 
					  else // code to send New invitations
						{
								//echo "anand"; print_r($vendoremail); 
								$db = &JFactory::getDbo();
								$sql = "insert into #__cam_vendor_availablejobs values ('','".$rfpid."','".$user->id."','".$property_id."','0')";  
								$db->SetQuery($sql);
								$db->query();
								$id= $db->insertid(); 
								$siteURL		= JURI::base();
								$link = $siteURL.'index.php?option=com_camassistant&controller=proposals&Itemid=148&task=vendor_proposal_form&view=proposals&amp;Prp_id='.$property_id.'&id='.$id.'&rfp_id='.$rfpid.'';
								$body = $inviterfp;
								$body = str_replace('{RFP NUMBER}',sprintf('%06d', $rfpid), $body);
								$body = str_replace('{vendor Name}', $vendorname, $body);
								$body = str_replace('{link}', '<a href="'.$link.'">CLICK HERE</a>', $body);
								$body = str_replace('{camName}', 'CAMassitant', $body);
								$body = str_replace('{Managername}', $Managername, $body);
								$body = str_replace('{Camfirmname}', $Camfirmname, $body);
								//end - code to get Mangaername, Camfirmname
								 $sub='RFP Invitation from CAMassistant';
								$from_name='CAMassistant';
								$from_email='Support@CAMassistant.com';
								$successMail =JUtility::sendMail($from_email, $from_name, $vendoremail, $sub, $body,$mode = 1);
						}
					 } //exit;//for($i=0;$i<count($vendorsinfo);$i++)
				 }
			}  
			//End if send mails to vendors
		//exit;
		$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&rfp_type='.$post['rfp_type'].'&task=saverfpmsg1&Itemid='.$itemid );
		JRequest::setVar('view', 'rfp');
		parent::display();
	}
	//
	function checkImage($fname,$tempname , $folder = 'com_camassistant') {
		//echo "hi iam here";exit;
		/*Uploading Image*/
		ini_set('upload_max_filesize','20');
		  if($fname != '')
		  {
			  $pos = strrpos($fname,'.');
			  $fileExt = substr($fname,($pos+1),4);
			  $fileName = substr($fname,0,($pos));
			  $aryFileExt = array('jpeg','JPEG','JPG','jpg','GIF','gif','PNG','png','pdf','xls','docs','txt','php');
			  if(in_array($fileExt,$aryFileExt) )
			  {
				   $file = $fileName.time().".".$fileExt;
				   $file = str_replace(' ','_',$file);
				   copy($tempname, 'components/com_camassistant/assets/images/rfp/'.$file);
				   return $file;
			  }
			  else
			  {
				$msg="File format was not supported";
				$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&task=rfp',$msg );
			  }
		 }
	 }

	function addproperty()
	{
		JRequest::setVar('view', 'rfp');
		parent::display();
	}

    function saveindustry() 
	{
		$db = JFactory::getDBO();
		echo 'Select * FROM #__rsform_properties as a, #__rsform_forms as b,#__rsform_components as c  WHERE c.ComponentTypeId=a.ComponentId and b.FormId=a.ComponentId and  a.PropertyName="NAME"  and b.camindustry="'.$_POST[formid].'"';
		
$db->setQuery('Select * FROM #__rsform_properties as a, #__rsform_forms as b,#__rsform_components as c  WHERE c.ComponentTypeId=a.ComponentId and b.FormId=a.ComponentId and  a.PropertyName="NAME"  and b.camindustry="'.$_POST[formid].'"');
$db->query();
$cam=$db->loadobjectlist();

    }



function showindustryform() 
{

require_once(''.JPATH_BASE.'/components/com_rsform/controller/adapter.php');
require_once(''.JPATH_BASE.'/components/com_rsform/controller/functions.php');
require_once(''.JPATH_BASE.'/components/com_rsform/controller/validation.php');

$RSadapter = new RSadapter();
$GLOBALS['RSadapter'] = $RSadapter;

$GLOBALS['ismodule'] = 'local';
$db = JFactory::getDBO();
//require backend language file
require_once(_RSFORM_FRONTEND_ABS_PATH.'/languages/'._RSFORM_FRONTEND_LANGUAGE.'.php');
$db->setQuery("Select `FormId`,`line_item_price` FROM #__rsform_forms  WHERE  camindustry='".$_GET[formid]."'");
$db->query();
$cam=$db->loadobject();
$formId=$cam->FormId;
//If Formid exists
if($_GET['direct']=='form'){
$formId=$_GET['formid'];
}
echo '<div class="rsform">';
	$output = '';
	$RSadapter = $GLOBALS['RSadapter'];
	
	if(isset($_SESSION['form'][$formId]['thankYouMessage']) && !empty($_SESSION['form'][$formId]['thankYouMessage']))
	{
	
		$output .= RSshowThankyouMessage($formId);
	}
	else
	{
		if(!empty($_POST['form']['formId']))
		{	


			$invalid = RSprocessForm($formId);	

$output .='<script type="text/javascript">';
for($i=2; $i<=$_GET[lcnt]; $i++){
$output .=" parent.removeEventedit('2'); ";
}
$output .=" </script>";
			
if($_GET[task]=='editrfp'){
for($i=1; $i<='7'; $i++){
$output .='<script type="text/javascript"> parent.removeEvent_edit('.$i.'); </script>';
}
}
$db->setQuery("Select * from #__rsform_submission_values where SubmissionId='".$_SESSION[rfp][industry]."' AND FieldValue!=''");
$industrys = $db->loadobjectlist();
$os = array("Submit", "formId");
$i=0;
$j=1;
foreach($industrys as $industry){
if (!in_array($industry->FieldName, $os)) {
if($industry->FieldValue && $industry->FieldValue!='PLEASE SELECT' && $industry->FieldValue!='Select')
$linetask.=$industry->FieldName.':'.$industry->FieldValue.' , ';


if($industry->FieldName==$lit&&$industry->FieldValue=='True'){
$linetask=eregi_replace('Linetask','',$linetask);
$linetask=eregi_replace('True','',$linetask);
$linetask=eregi_replace('Select','',$linetask);
$linetask1=RScleanVar($linetask);
$linetask1=str_replace(',','\n',$linetask1);
$linetask1=str_replace('<br>','\n',$linetask1);
$linetask1=str_replace('PLEASE SELECT','',$linetask1);
$linetask=str_replace('submit:','',$linetask1);
if($linetask){
$output .= '<script type="text/javascript">';
$output .= 'parent.addEvent1();';
$output .= 'window.parent.document.getElementById("title_task'.$i.'").value ="'.$industry->FieldValue.'";';
$output .= 'window.parent.document.getElementById("line_taskdesc'.$i.'").value ="'.$linetask.'";	</script>';
$i++;
$j++;
}
unset($linetask);
}
}
}
$linetask1=RScleanVar($linetask);

$linetask1=str_replace(',','\n',$linetask1);
$linetask1=str_replace('<br>','\n',$linetask1);
$linetask1=str_replace('PLEASE SELECT','',$linetask1);
$linetask=str_replace('submit:','',$linetask1);
if($linetask){
$output .= '<script type="text/javascript">';
$output .= 'parent.addEvent1();';
$output .= 'window.parent.document.getElementById("title_task'.$i.'").value ="'.$industry->FieldValue.'";';
$output .= 'window.parent.document.getElementById("line_taskdesc'.$i.'").value ="'.$linetask.'";	</script>';
}

	$output .= '<script type="text/javascript">	
window.parent.document.getElementById( "sbox-window" ).close(); 
		</script>';



						
			if($invalid)
			{
				//the invalid variable is returned
				$output .= RSshowForm($formId, $_POST['form'], $invalid);
			}
		}
		else
		{
		
		
			if(isset($_SESSION['form'][$formId]['thankYouMessage']) && empty($_SESSION['form'][$formId]['thankYouMessage']))
			{
				unset($_SESSION['form'][$formId]['thankYouMessage']);
				
				//is there a return url?
				$db = JFactory::getDBO();
				$db->setQuery("SELECT ReturnUrl FROM #__rsform_forms WHERE `formId`='".$formId."'");
				$returnUrl = $db->loadResult();
				if(!empty($returnUrl))
				{
					if(!isset($_SESSION['form'][$formId]['submissionId']))$_SESSION['form'][$formId]['submissionId'] = '';
					$returnUrl = RSprocessField($returnUrl,$_SESSION['form'][$formId]['submissionId']);
					unset($_SESSION['form'][$formId]['submissionId']);
					
					$RSadapter->redirect($returnUrl);
				}
								
				$output .= _RSFORM_FRONTEND_THANKYOU;
if($_GET[lcnt]){
$output .='<script type="text/javascript"> ';
for($i=2; $i<=$_GET[lcnt]; $i++){
$output .=" parent.removeEventedit('2'); ";
}
$output .=" </script>";
}

$db->setQuery("Select * from #__rsform_submission_values where SubmissionId='".$_SESSION[rfp][industry]."'");
$industrys = $db->loadobjectlist();
$i=1;
$output .= '<script type="text/javascript">';
foreach($industrys as $industry){
if($i>1){
$output .= 'parent.addEvent1();';
}
if($industry->required_vendor){
$output .= 'window.parent.document.getElementById("price'.$i.'").checked ="checked";';
}




$lineitem_value=explode(',',$industry->FieldValue);
foreach($lineitem_value as $lineitem){
if(!strstr($lineitem,'{')){
$line_desc.= $lineitem.'\n\n';
}
}

if(strstr($line_desc,'Frequency')){
$freq="Frequency: ".$industry->Frequency.'\n\n';
$line_desc=$freq.$line_desc;
$frequency='See below';
}
if($frequency){
$output .= 'window.parent.document.getElementById("frequency'.$i.'").value ="'.$frequency.'";';
}elseif($industry->Frequency){
$output .= 'window.parent.document.getElementById("frequency'.$i.'").value ="'.$industry->Frequency.'";';
}else{
$output .= 'window.parent.document.getElementById("frequency'.$i.'").value ="N/A";';
}

//$line_desc=str_replace(',','\n\n',$industry->FieldValue);
//$line_desc='Fertilization,Shade Trees Flowering Trees Palm Trees Accent Trees,';
$output .= 'window.parent.document.getElementById("title_task'.$i.'").value ="'.$industry->line_title.'";';
$output .= 'window.parent.document.getElementById("line_taskdesc'.$i.'").value ="'.$line_desc.'";';
//$output .=' parent.autogrow();';
unset($line_desc);
unset($frequency);
$i++;
}

$output .= '
window.parent.document.getElementById( "sbox-window" ).close(); 

		</script>';



				
			}
			$output .= RSshowForm($formId);
		}
	}
	


echo $output;
echo '</div>';
   }
	//
	function submit_property()
	{
	//echo "<pre>"; print_r($_REQUEST); exit;
		global $mainframe;
		$db = JFactory::getDBO();
		$model = $this->getModel('property');
		$post	= JRequest::get('post');
		$user=JFactory::getUser();  //For $my
		$taxids=$model->getProperty_TaxIDs();
		$tax_ids=array();
		for($i=0;$i<count($taxids);$i++)
		$tax_ids[$i]=$taxids[$i]->tax_id;
		/*echo "<pre>";
		print_r($post); exit;*/
		$post['tax_id'] = $post['tax_id1']."-".$post['tax_id2'];
		if(in_array($post['tax_id'],$tax_ids))
		{
			$err_msg="<span style='text-align:justify;font-size:11px;'>This Property is already registered with our system. Please contact your board/Management Company to determine your Property's Administrator on CAMassistant.com. If you have any  additional questions, please email us at properties@CAMassistant.com</span>";
			$mainframe->Redirect('index.php?option=com_camassistant&controller=rfp&task=addproperty&err_msg='.$err_msg );
		}
		/*echo "123456<pre>";
		print_r($rows); exit;*/
		$post['id']='';
		$post['property_manager_id']=$user->id;
		
		if($user->id)
		{
		//echo "<pre>"; print_r($post); exit;
			if ($model->store($post)) { 
				$pid=$db->insertid();
				$propertyList=$model->getProperties();
				$row1[0]->value = "";
				$row1[0]->text = "-Select Propety-";
				$row1[1]->value = 'addp';
				$row1[1]->text = "Add Propety";
				$propertyList=array_merge($row1,$propertyList);
				//sleep(5);
				$plist=JHTML::_('select.genericlist', $propertyList, 'property_id', 'size="1" class="inputbox "    onchange="addproperty(this.value);""', 'value', 'text', $pid);
				?>
				<script type="text/javascript">	
				window.parent.document.getElementById("prop_list").innerHTML ='<?php echo $plist; ?>';
				window.parent.document.getElementById( 'sbox-window' ).close(); 
				</script>

				<?php
				echo '<script language="javascript">window.parent.document.getElementById( "sbox-window" ).close(); window.parent.location.reload();</script>';
				exit(0);
				/*echo '<script language="javascript">window.parent.location.reload();</script>';
				exit(0);*/
			} else {
				echo "<font color='red'>Error Saving Property (ie. Property Name or Tax-Id entry might be duplicated )</font>";
				echo '<script language="javascript">window.parent.location.reload();</script>';exit(0);
			}
		//$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&amp;task=addproperty&msg='.$msg );
		} else { 
			echo "<font color='red'>Your session has been expired.Please login again</font>";
			echo '<script language="javascript">window.parent.document.getElementById( "sbox-window" ).close();</script>';
			exit(0);
		}
	
	}
	//For pop up line tasks check list
	function pop_linetasks()
	{
	 	JRequest::setVar('view', 'rfp');
		parent::display();
	}
	//
	function cancelrfp()
	{
		JRequest::setVar('view', 'rfp');
		parent::display();
	}
	//
	//
	function updatestatus_rfp()
	{
		$db = JFactory::getDBO();
		$user=JFactory::getUser();
		 $userid = $user->id;
		$email=$user->email;
		$rfpno= JRequest::getVar("rfpid",'');
		$jobs = "SELECT id FROM  #__cam_vendor_availablejobs WHERE rfp_id=".$rfpno; 
	//	$query = "UPDATE #__cam_vendor_proposals SET proposaltype='Awarded' WHERE id=".$id;
		$db->setQuery( $jobs );
		$id = $db->loadResult();
		
		$user=JFactory::getUser();  
		$pro_id = "SELECT property_id FROM #__cam_rfpinfo where id=".$rfpno;
		$db->setQuery( $pro_id );
		$property_id = $db->loadResult();
		
		if(!$id){
		$db = JFactory::getDBO();
		$sql = "insert into #__cam_vendor_availablejobs values ('','".$rfpno."','".$user->id."','".$property_id."','0')"; 
					$db->SetQuery($sql);
					$db->query();
					$id= $db->insertid();
		}
		if($id){
		$db = JFactory::getDBO();
		 $sql = "UPDATE #__cam_vendor_availablejobs SET status='0' WHERE id=".$id;  
		$db->Setquery($sql);
		$db->query();
		
		}
	//print_r($id); exit;
			
		//print_r($_REQUEST); exit;
		//if($_REQUEST['rfp_type']=='closed')
		//{
			//$rfp_type='Unawarded';
			$link="index.php?option=com_camassistant&controller=rfpcenter&task=submitedrfp&Itemid=87&msg=msg";
			//$link='index.php?option=com_camassistant&controller=rfpcenter&task=unawardrfp&Itemid='.$_REQUEST['Itemid'];
		//} else {
			//$rfp_type='draft';
			
			//$link="index.php?option=com_camassistant&controller=rfpcenter&task=unsubmittedrfp&Itemid=88&msg=msg";
			//$link='index.php?option=com_camassistant&controller=rfpcenter&task=unsubmittedrfp&Itemid='.$_REQUEST['Itemid'];
		//}
		$today = date('m-d-Y');
		$link1 = $siteURL.'index.php?option=com_camassistant&controller=proposals&Itemid=148&task=vendor_proposal_form&view=proposals&amp;Prp_id='.$property_id.'&id='.$id.'&rfp_id='.$rfpno.'';
		 $sql = "UPDATE #__cam_rfpinfo SET rfp_type='Unawarded',unawardeddate='$today' WHERE id=".$rfpno;  
		$db->Setquery($sql);
		$db->query();
			
		 $query6 = "SELECT U.email FROM  #__cam_vendor_proposals as C LEFT JOIN #__users as U ON U.id=C.proposedvendorid WHERE C.rfpno=".$rfpno; 
	//	$query = "UPDATE #__cam_vendor_proposals SET proposaltype='Awarded' WHERE id=".$id;
		$db->setQuery( $query6 );
		$data6 = $db->loadObjectlist();
		for ($i=0, $n=count( $data6); $i < $n; $i++)
	{
	if ($data6[$i]->email== ''){
	//echo "anand";
	} else {
	$mails = $data6[$i]->email;
	//echo "<pre>"; print_r($data1[$i]);  
				$mailfrom = 'support@camassistant.com';
				$fromname = 'Camassistant Team';
				$assignuseremail = $mails; 	
				$mailsubject = 'Camassistant Team';
				 $message="SELECT cancel_rfp FROM #__emails where id='1'";
					$db->Setquery($message);
					$rmessage = $db->loadResult();
					$bodytext = str_replace('{VENDOR EMAIL}',$assignuseremail,$rmessage);
					$bodytext = str_replace('{RFP NUMBER}',$rfpno,$bodytext);
					$bodytext = str_replace('{CLICK HERE}','<a href="'.$link1.'">CLICK HERE</a>',$bodytext); 
					$bodytext = str_replace('{CAM Firm}',$email,$bodytext); 
					//$bodytext = str_replace('{GENERAL PROJECT INFORMATION}',$data['name'],$bodytext); 
					$body=$bodytext;
				/*$body ='<p> Dear '.$assignuseremail.',</p>
<p>There has been an addendum to RFP '.$rfpno.' </p>
<p>Please <a href="'.$link1.'">CLICK HERE</a> to view/resubmit your now outdated proposal.</p>
<p>IMPORTANT: Your previously submitted proposal has been automatically marked as a "Draft/Unsubmitted" proposal. Please review the changes made by the Property Manager and update & resubmit your proposal accordingly. If you do not review and resubmit your proposal, it will not be considered (as it may be outdated). If the changes to the RFP are no longer of interest to your company, you may withdraw your Intent To Bid without penalty within 2 business days by calling 561-246-3830. Failure to submit a proposal before the new deadline will be penalized if an ITB is not withdrawn in time.</p>
<p>Thanks,</p>
<p>'.$email.'</p>';*/
//$body = html_entity_decode($body1);

//print_r($body);

				//$body = "the RFP has been withdrawn
	//<br/><br/>At Your Service,<br/><br/>
	//CAMassistant.com";
			JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, html_entity_decode($body),$mode = 1);
				//JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $useractivation,$mode = 1);
		}
	}	 //exit;
		$msg='<span style="color:#FF0000;font-weight:bold;padding-left:15px;">RFP has been saved as '.strtoupper($rfp_type).' Successfully</span>';?>
		<script type="text/javascript">	
		window.parent.location.href = '<?php echo $link;?>';  
		window.parent.document.getElementById( 'sbox-window' ).close(); 
		</script>
		<?php
		exit;		
	}
	
	function ajaxcounty(){
$state = $_REQUEST['State'];
$db=JFactory::getDBO();
 $countie = "SELECT * FROM #__cam_counties WHERE State='".$state."' ORDER BY County ";
		$db->setQuery($countie);
		$db->Query();
		$counties = $db->loadObjectList(); ?>
<option value="" >Please Select County</option>
			
		 	<?php
			foreach($counties as $county)
			{
			echo"<option value=".$county->id.">".$county->County."</option>";
			
			} 
		exit; }
	
	
	/*function industries_Save()
	{
		//echo "5454554";exit;
		//session_destroy();
		session_start();
		$_SESSION['line_industries']='';
		$ind_ary = JRequest::getVar('cid','','post','array',REQUEST_ALLOWRAW);
		$ind = implode(',',$ind_ary); 
		$_SESSION['line_industries'] = $ind;
		echo "<script language='javascript' type='text/javascript'>
		window.parent.location.reload();
		self.close();
		 </script>"; 
		 $_SESSION['line_industries'] = $ind;
		//$link = 'index.php?option=com_camassistant&controller=vendors&task=vendor_info';	
		//$this->setRedirect( $link,$msg );
		exit;
	}*/
}
?>