<?php
/**
 * @version		1.0.0 camassistant $
 * @package		camassistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport('joomla.application.component.controller');
error_reporting(0);
class documentsController extends JController
{

	function __construct()
	{
		parent::__construct();
	}
	function display()
	{
	parent::display();

	}
	///for normal documents
	function pdocs(){
	$model = $this->getModel('documents');
	$result = $model->get('Data1');
	parent::display();
}

//Completed
///For shared properties
	function sdocs(){

	$model = $this->getModel('documents');
	$sdocs = $model->get('Data');
	parent::display();

	}
	//completed
/// Files when open the property	
	function pfiles(){
//print_r($_REQUEST['pid']); exit;
	$model = $this->getModel('documents');
	$pfiles = $model->getpfiles();
	parent::display();
	}
	
	function documents(){
	JRequest::getVar( 'view','documents');
	$model = $this->getModel('documents');
	parent::display();
	}
///Funtion to add new folder	
	function addfolder(){
	JRequest::getVar( 'view','documents');
	$model = $this->getModel('documents');
	$categoriess = $model->getcategories();
	parent::display();
	}
	//Completed
///Function to save the new folder	
	function savefolder(){
	//echo "<pre>"; print_r($_REQUEST); 
	$post = JRequest::get('post');
	$cat_id = JRequest::getVar( 'cat_id','' );
	$docTitle = JRequest::getVar( 'docTitle','' );
	$docTitle = preg_replace("/[&'!@#$%^*(?)><-+|]/"," ",$docTitle);	
	$docTitle = ereg_replace('/',' ',$docTitle);	
	$docTitle = ereg_replace('-',' ',$docTitle);	
	$docTitle = ereg_replace('"',' ',$docTitle);	
	$docTitle = ereg_replace(' ','_',$docTitle);
	
	$docpath = JRequest::getVar( 'path','' );
	$mid = JRequest::getVar( 'mid','' );
	$pid = JRequest::getVar( 'pid','' ); 
	if($pid == ''){
	$pid ='0';
	}
	$parentid = JRequest::getVar( 'parentid','' );	
	$propertyname = JRequest::getVar( 'propertyname','' );	

	//print_r($_REQUEST['path']);  echo "<br><br>";
	if($docpath=='components/com_camassistant/doc/'){
//	echo "In if"; 
	$path1 = "components/com_camassistant/doc/".$docFoldername;
	$path = "components/com_camassistant/doc/".$docFoldername.$docTitle;
	}
	else {
	$path1 = $docpath;
	$path = $docpath."/".$docTitle;
	}
	
	if(!is_dir($path1))
	mkdir($path1,0777);
	
//echo $path; exit;
	$db =& JFactory::getDBO();
	$query_path = "SELECT property_id FROM #__cam_propertydocs  where docPath ='".$path."'";
	$db->setQuery($query_path);
    $docpath=$db->loadResult();
	if($docpath == $pid){

	if(is_dir($path))
	{
	$post['docPath'] = $path1;
	echo "This folder name is already existing please try again";
	}
	}
	else {
	mkdir($path,0777);
	$post['docPath'] = $path;
	$user = JFactory::getUser();
	if(isset($_REQUEST['mid']) && $_REQUEST['mid'] != '')
	$post['property_manager_id'] = $mid;
	else
	$post['property_manager_id'] = $user->id;
	$post['property_id'] = $pid;
	$post['parent'] = $parentid;
	$post['docTitle'] = preg_replace("/[&'!@#$%^*(?<>)-+|]/","_",$post['docTitle']);
	$post['docTitle'] = ereg_replace('/',' ',$post['docTitle']);
	$post['docTitle'] = ereg_replace('"',' ',$post['docTitle']);
	$post['docTitle'] = ereg_replace('-',' ',$post['docTitle']);
	$post['docTitle'] = ereg_replace(' ','_',$post['docTitle']);
	//echo "<pre>"; print_r($post); exit;
	$model = $this->getModel('documents');
	$success = $model->store($post);
	$db =& JFactory::getDBO();
	$query = "SELECT property_name FROM #__cam_property where id =".$cat_id;
	$db->setQuery($query);
    $catname=$db->loadResult();
	$post['cat_name'] = $catname; 
	$success = $model->store1($post);
	if($success){
	?>
	<script type="text/javascript">	
				window.parent.location.reload();
				//window.parent.document.getElementById( 'sbox-window' ).close(); 
				</script>

<?php
	//echo "New folder created successfully";
	}
	else{
	echo "The folder is not created please try again";
	}
}
exit;
	}
	
	function openfiles(){
	
	JRequest::getVar('view','documents');
	parent::display();

	}
	function addfile(){
	//echo "can"; exit;
	JRequest::getVar( 'view','documents');
 	parent::display();
	}
///Funvtion to upload the new filw
	function savefile(){
	$post = JRequest::get('post');
	$dest = JRequest::getVar( 'path','');
	$mid = JRequest::getVar( 'mid','');
	$pid = JRequest::getVar( 'pid','');
	$parentid = JRequest::getVar( 'parentid','');
	$path = JRequest::getVar( 'path','');
//for adding image for firsrt time
	if(!is_dir($dest))
	mkdir($dest,0777);
//for adding image for firsrt time
	jimport('joomla.filesystem.file');
////For checking file extension/////////////
	$model = $this->getModel('documents');
	$check = $model->getcheck();
////For checking file extension/////////////	
if($check==1){

$ext = end(explode('.', $_FILES['file']['name']));
$ext1 = strtolower($ext);
$_FILES['file']['name'] = str_replace($ext,$ext1,$_FILES['file']['name']);

	$_FILES['file']['name'] = ereg_replace(' ','_',$_FILES['file']['name']);
	$dest = $dest."/";
	
	$copied = copy($_FILES["file"]["tmp_name"],$dest.$_FILES['file']['name']);
	if($copied){
 	$post['property_manager_id'] = $mid;
 	$post['property_id'] = $pid;
	//$post['docPath'] = $_REQUEST['path']."/".$_FILES['file']['name'];
	$post['docPath'] = $path.$_FILES['file']['name']; //modified by lalitha
 	$post['docTitle'] = $_FILES['file']['name'];
	$post['docTitle'] = ereg_replace(' ','_',$post['docTitle']);

	$post['parent'] = $parentid;	
	$model = $this->getModel('documents');
	//echo "<pre>"; print_r($post); exit;
	$res = $model->store3($post);
	}
	else{
	}
	?>
	<script type="text/javascript">	
				window.parent.location.reload();
				//window.parent.document.getElementById( 'sbox-window' ).close(); 
				</script>

<?php
	/*echo "<script language='javascript' type='text/javascript'>
			window.parent.document.getElementById( 'sbox-window' ).close();
			alert('New file uploaded successfully');
			window.parent.parent.location.reload();
			 </script>"; */
	//echo "New file uploaded successfully";
	} else{
	
	}
exit;
}
/////Completed
////////////////////////////////////////Shared docs////////////////////////////////////
	function sfiles(){
//echo "<pre>";print_r($_REQUEST); exit;
	$model = $this->getModel('documents');
	$sfiles = $model->getsfiles();
	parent::display();
	}


	function saddfolder(){

	JRequest::getVar( 'view','documents');
	$model = $this->getModel('documents');
	$scategoriess = $model->getscategories();
 	parent::display();
	}
	
	
	function ssavefolder(){
	
	$post = JRequest::get('post');
	$cat_id = JRequest::getVar( 'cat_id','' );
	$sdocTitle = JRequest::getVar( 'sdocTitle','' );	
	$sdocTitle = preg_replace("/[&'!@#$%^*<>()-+|]/"," ",$sdocTitle);
	$sdocTitle = ereg_replace('/',' ',$sdocTitle);
	$sdocTitle = ereg_replace('"',' ',$sdocTitle);
	$sdocTitle = ereg_replace('-',' ',$sdocTitle);
	$sdocTitle = ereg_replace(' ','_',$sdocTitle);
	$spath = JRequest::getVar( 'spath','' );
	$spid = JRequest::getVar( 'spid','' );	
	$smid = JRequest::getVar( 'smid','' );	
//	print_r($_REQUEST['spath']);  echo "<br><br>"; 
	if($spath=='components/com_camassistant/doc/'){
	//echo "In if"; 
	$path1 = "components/com_camassistant/doc/".$docFoldername;	
	$path = "components/com_camassistant/doc/".$docFoldername.$sdocTitle;
	}
	else {
	$path1 = $spath;	
	$path = $spath."/".$sdocTitle;
	}
//print_r($path1);echo "<br>";print_r($path); exit;
	if(!is_dir($path1))
	mkdir($path1,0777);
	if(is_dir($path))
	{
	$post['docPath'] = $path1;
	echo "This folder name is already existing please try again";
	exit;
	}
	else {
	mkdir($path,0777);
	$post['docPath'] = $path;
	$post['property_manager_id'] = $smid;
	$post['property_id'] = $spid;
	$post['sdocTitle'] = preg_replace("/[&'!@#$%^*<>()-+|]/"," ",$post['sdocTitle']);
	$post['sdocTitle'] = ereg_replace('/',' ',$post['sdocTitle']);
	$post['sdocTitle'] = ereg_replace('"',' ',$post['sdocTitle']);
	$post['sdocTitle'] = ereg_replace('-',' ',$post['sdocTitle']);
	$post['sdocTitle'] = ereg_replace(' ','_',$post['sdocTitle']);
	$model = $this->getModel('documents');
	$success = $model->sstore($post);
	$db =& JFactory::getDBO();
	$query = "SELECT property_name FROM #__cam_property where id =".$cat_id;
	$db->setQuery($query);
    $catname=$db->loadResult();
	$post['cat_name'] = $catname; 
	$success = $model->store1($post);
	if($success){
	
	?>
	<script type="text/javascript">	
				window.parent.location.reload();
				//window.parent.document.getElementById( 'sbox-window' ).close(); 
				</script>

<?php 
	
	}
	else{
	echo "Please add one more time";
	}
exit;
}
}
	function saddfile(){
	JRequest::getVar( 'view','documents');
 	parent::display();
	}

	
	function ssavefile(){

	$post = JRequest::get('post');
	$dest = JRequest::getVar( 'spath','');
	$parentid = JRequest::getVar( 'parentid','');
	$spid = JRequest::getVar( 'spid','');
	$smid = JRequest::getVar( 'smid','');
	$spath = JRequest::getVar( 'spath','');
	//for adding image for firsrt time
	if(!is_dir($dest))
	mkdir($dest,0777);
//for adding image for firsrt time

	jimport('joomla.filesystem.file');
	$model = $this->getModel('documents');
	$check = $model->getcheck();
// For checking extension...///	
if($check==1){
$_FILES['file']['name'] = ereg_replace(' ','_',$_FILES['file']['name']);
	$dest = $dest."/";
	$copied = copy($_FILES["file"]["tmp_name"],$dest.$_FILES['file']['name']);
	if($copied){
 	$post['property_manager_id'] = $smid;
 	$post['property_id'] = $spid;
	$post['docPath'] = $spath."/".$_FILES['file']['name'];
 	$post['sdocTitle'] = $_FILES['file']['name'];	
	$post['sdocTitle'] = ereg_replace(' ','_',$post['sdocTitle']);	
	$post['parent'] = $parentid;	
	$model = $this->getModel('documents');
	$res = $model->store3($post);
	} else{}
	?>
	<script type="text/javascript">	
				window.parent.location.reload();
				//window.parent.document.getElementById( 'sbox-window' ).close(); 
				</script>

<?php
	?>
	<?php  } else{
	echo "<font color='red'>Sorry!  The file type you attempted to upload is not allowed.  Please try again and note the allowed file types and extensions.<br>
If you continue to have problems or need help, please contact the CAMassistant Customer Support Team at 561-246-3830.</font>";
	}
	exit(0);
}

	function sopenfiles(){

	JRequest::getVar('view','documents');
	parent::display();
	}

	function delete(){
	$post = JRequest::get('post');
	//echo "This is delete function"; exit;
	$model = $this->getModel('documents');
	$res = $model->getdelete($post);
	$task = JRequest::getVar( 'task','');
	$smid = JRequest::getVar( 'smid','');
	$spid = JRequest::getVar( 'spid','');
	$backurl = JRequest::getVar( 'backurl','');
	$link = $backurl;
	$msg="Deleted Successfully";
	$this->setRedirect( $link,$msg );
	parent::display();
	}
	
	//function to delete file 
	function deletefile(){

	$model = $this->getModel('documents');
	$Itemid = JRequest::getVar('Itemid','');
	$smid = JRequest::getVar('smid','');
	$spid = JRequest::getVar('spid','');
	$backurl = JRequest::getVar('backurl','');	
	$res = $model->getdeletefile($post);
	$link = $backurl;
	$msg="Deleted Successfully";
	$this->setRedirect( $link,$msg );
	parent::display();
	}
	//Completed
	//code added by lalitha on April 08th
	function vendor_delete(){
	$model = $this->getModel('documents');
	$Itemid = JRequest::getVar('Itemid','');
	$res = $model->getvendor_delete($post);
	$link = 'index.php?option=com_camassistant&controller=documents&task=vendor_docs&Itemid=115';
	$msg="Deleted Successfully";
	$this->setRedirect( $link,$msg );
	//parent::display();
	}
	
	
	// Vendor 08-04-11
	function vendor_deletefile(){
	$model = $this->getModel('documents');
	$Itemid = JRequest::getVar('Itemid','');
	$res = $model->getvendor_deletefile($post);
	$link = 'index.php?option=com_camassistant&controller=documents&task=vendor_docs&Itemid=115';
	$msg="Deleted Successfully";
	$this->setRedirect( $link,$msg );
	//parent::display();
	}
	
		//  Vendor 08-04-11 completed
		
		
		
	/*	function deletefile(){
//	echo "This is delete function"; exit;
	$model = $this->getModel('documents');
	$res = $model->getdeletefile($post);
	parent::display();
	}*/

	
	function open(){
	$model = $this->getModel('documents');
	$open = $model->getopen($post);
	parent::display();
	
	}
//Modified function to upload the shared file by sateesh on 25-07-11
function sharedfiles(){

	$post = JRequest::get('post');
	$sdocTitle = JRequest::getVar( 'sdocTitle','' );	
	$sdocTitle = preg_replace("/[&'!@#$%^*<>(?)-+|]/"," ",$sdocTitle);
	$sdocTitle = ereg_replace('/',' ',$sdocTitle);
	$sdocTitle = ereg_replace('"',' ',$sdocTitle);
	$sdocTitle = ereg_replace('-',' ',$sdocTitle);
	$sdocTitle = ereg_replace(' ','_',$sdocTitle);
	
	
	$spath = JRequest::getVar( 'spath','' );
	$smid = JRequest::getVar( 'smid','' );	
	$type = JRequest::getVar( 'type','' );	
	if($spath=='components/com_camassistant/doc/sharedfiles/'){
	//echo "In if"; 
	$path1 = "components/com_camassistant/doc/sharedfiles/".$docFoldername;	
	$path = "components/com_camassistant/doc/sharedfiles/".$docFoldername.$sdocTitle;
	}
	else {
	$path1 = $spath;	
	$path = $spath."/".$sdocTitle;
	}
	$user = JFactory::getUser();  
 	$usertype = $user->user_type;
	if($usertype == 13){
	$post['parent_manager'] = '0';
	}
	else{
	$db =& JFactory::getDBO();
	$query = "SELECT comp_id FROM #__cam_customer_companyinfo WHERE cust_id=".$user->id;
	$db->setQuery($query);
	$comp_id = $db->loadResult();
		
	$query = "SELECT U.id FROM #__users as U, #__cam_camfirminfo as V  where V.id  =".$comp_id." and U.id= V.cust_id"  ;
	$db->setQuery($query);
    $camfirmid=$db->loadResult();
	$post['parent_manager'] = $camfirmid;
	}
//	echo $path1; exit;
	if(!is_dir($path1))
	mkdir($path1,0777);
	if(is_dir($path))
	{
	$post['docPath'] = $path1;
	echo "This folder name is already existing please try again";
	exit;
	}
	else {
	mkdir($path,0777);
	$post['docPath'] = $path;
	$post['property_manager_id'] = $smid;
	$post['property_id'] = $spid;
	$post['type'] = $type;
	$post['sdocTitle'] = preg_replace("/[&'!@#$%^*<>(?)-+|]/"," ",$post['sdocTitle']);
	$post['sdocTitle'] = ereg_replace('/',' ',$post['sdocTitle']);
	$post['sdocTitle'] = ereg_replace('-',' ',$post['sdocTitle']);
	$post['sdocTitle'] = ereg_replace('"',' ',$post['sdocTitle']);
	$post['sdocTitle'] = ereg_replace(' ','_',$post['sdocTitle']);
	$model = $this->getModel('documents');
	$success = $model->sstore($post);
	$db =& JFactory::getDBO();
	$query = "SELECT property_name FROM #__cam_property where id =".$cat_id;
	$db->setQuery($query);
    $catname=$db->loadResult();
	$post['cat_name'] = $catname; 

	$success = $model->store1($post);
	if($success){
	?>
	<script type="text/javascript">	
    window.parent.location.reload();
    //window.parent.document.getElementById( 'sbox-window' ).close(); 
    </script>
	<?php 	}	else{
	echo "Please add one more time";
	}
	exit;
	}
	}
	//Function to upload the sharing files sateesh on 25-07-11
	function sharingfiles(){
	$post = JRequest::get('post');
	$dest = JRequest::getVar( 'spath','');
	$parentid = JRequest::getVar( 'parentid','');
	$spid = JRequest::getVar( 'spid','');
	$smid = JRequest::getVar( 'smid','');
	$spath = JRequest::getVar( 'spath','');
	jimport('joomla.filesystem.file');
	$model = $this->getModel('documents');
	$check = $model->getcheck();
	// For checking extension...///	
	$_FILES['file']['name'] = ereg_replace(' ','_',$_FILES['file']['name']);
	$dest = $dest."/";
	if(!is_dir($dest))
	mkdir($dest,0777);
	$copied = copy($_FILES["file"]["tmp_name"],$dest.$_FILES['file']['name']);
	if($copied){
 	$post['property_manager_id'] = $smid;
 	$post['property_id'] = $spid;
	$post['docPath'] = $spath."/".$_FILES['file']['name'];
 	$post['sdocTitle'] = $_FILES['file']['name'];
	$post['sdocTitle'] = ereg_replace(' ','_',$post['sdocTitle']);	
	$post['parent'] = $parentid;	
	$model = $this->getModel('documents');
	$res = $model->store3($post);
	?>
	<script type="text/javascript">	
    window.parent.location.reload();
    </script>
	<?php  } else{
	echo "<font color='red'>File uploading has failed</font>";
	}
	exit(0);
}
//Function to upload the sharing files by sateesh on 25-07-11 completed
////////////////////////////////////////Shared docs Completed////////////////////////////////////
}
?>