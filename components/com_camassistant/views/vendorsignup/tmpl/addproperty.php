<?php
/**
 * @version		1.0.0 cam assistant $
 * @package		cam_assistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

defined('_JEXEC') or die('Restricted access');

jimport( 'joomla.application.component.model' );
class addpropertyModelAddproperty extends Jmodel
{
	function __construct(){
		parent::__construct();
 
        global $mainframe, $option;
		
        $count='10';
		$limit=$count;
		$limitstart = JRequest::getVar('limitstart', 0, '', 'int');
		$limitstart = ($limit != 0 ? (floor($limitstart / $limit) * $limit) : 0);
		
		$this->setState('limit', $limit);
		$this->setState('limitstart', $limitstart);
		
	}
	//To get property information
	function getpropertyinfo()
	{
	 	/*echo "<pre>";
		print_r($_REQUEST);exit;*/
		$db=&JFactory::getDBO();
		$query = "SELECT property_name,property_manager_id FROM #__cam_property WHERE id=".$_REQUEST['pid'];
		$db->setQuery($query);
		$pinfo = $db->loadObjectList();
		return $pinfo;
	}
	function _buildQuery()
	{
	$user =& JFactory::getUser();
	$user_id = $user->get('id');
	$db=&JFactory::getDBO();
	$cid = $_REQUEST['cid'];
	if($cid){
//	echo $cid; echo "In if"; exit;
	$user_id = $cid;
	}
	else {
	$user_id = $user_id;
	}
	$query = "SELECT id FROM #__cam_camfirminfo WHERE cust_id=".$user_id;
	$db->setQuery($query);
	$comp_id = $db->loadResult();
	if(!$comp_id)
	{
		$query = "SELECT comp_id FROM #__cam_customer_companyinfo WHERE cust_id=".$user_id;
		$db->setQuery($query);
		$comp_id = $db->loadResult();
	}
	$usertype = $user->get('user_type');
	$query = "SELECT U.*, V.salutation,V.name,V.lastname FROM #__cam_property as U, #__users as V where  U.`property_manager_id` = V.`id` AND company_id=".$comp_id;
	if($usertype != '13' || $cid)
	$query .= " AND U.`property_manager_id` =".$user_id;
	$query .= " ORDER BY U.id DESC";
	//echo $query;
	/*$query = "SELECT U.*, V.salutation,V.name,V.lastname FROM #__cam_property as U, #__users as V where U.`property_manager_id` =".$user_id." and U.`property_manager_id` = V.`id`";*/
	return $query;
	}

//completed
function getPagination()
	{
		// Lets load the content if it doesn't already exist
		if (empty($this->_pagination))
		{
			jimport('joomla.html.pagination');
$this->_pagination = new JPagination( $this->getTotal(), $this->getState('limitstart'), $this->getState('limit') );
}

		return $this->_pagination;
	}
  
	function getTotal()
	{
		//DEVNOTE: Lets load the content if it doesn't already exist
		if (empty($this->_total))
		{
			$query = $this->_buildQuery();
			$this->_total = $this->_getListCount($query);
		}
		return $this->_total;
	}
function getData()
	{

		//DEVNOTE: Lets load the content if it doesn't already exist
		if (empty($this->_data))
		{
			$query = $this->_buildQuery();
			//$query = $this->_buildQuery1();
			$this->_data = $this->_getList($query, $this->getState('limitstart'), $this->getState('limit'));
		}
		return $this->_data;
}
//Getting states list
function getStates(){
		$db =& JFactory::getDBO();
		$query = "SELECT state FROM #__cam_vendor_states ";
		$db->setQuery($query);
        $states=$db->loadObjectList();
		return $states;

}
//Completed
//Getting Board members list
function getboardmembers(){
		$db =& JFactory::getDBO();
		$user =& JFactory::getUser();
        $user_id = $user->get('id');

		$query = "SELECT id,firstname,lastname,email,board_position FROM #__cam_board_mem where user_id= ".$user_id." ";
		$db->setQuery($query);
        $bmembers=$db->loadObjectList();

		return $bmembers;


}
//Completed

////Save the property
function store($data){
        // get the table
//	echo "<pre>"; print_r($data); exit;
JTable::addIncludePath(JPATH_COMPONENT.DS.'tables');
$row =& $this->getTable('addproperty');
//$row = JTable::getInstance('addproperty','Table');
        if (!$row->bind($data)) {
                $this->setError($this->_db->getErrorMsg());
                return false;
        }
        if (!$row->check()) {
                $this->setError($this->_db->getErrorMsg());
                return false;
        }
        if (!$row->store()) {
                $this->setError($this->_db->getErrorMsg());
                return false;
        }
        return true;         
}
//get customers
function getcustmers(){
		$user =& JFactory::getUser();
		$user_id = $user->get('id');
		$db=&JFactory::getDBO();
		$query = "SELECT id FROM #__cam_camfirminfo WHERE cust_id=".$user_id;
		$db->setQuery($query);
		$comp_id = $db->loadResult();
		$query = "SELECT U.name, U.id from #__users as U, #__cam_customer_companyinfo as V where V.comp_id = ".$comp_id." and U.id=V.cust_id ";
		$db->setQuery($query);
        $custmers=$db->loadObjectList();
		return $custmers;

}
//Completed
//Completed
//For getting the deials for edit property
function getpdetails(){
		$db =& JFactory::getDBO();
		$query = "SELECT * FROM #__cam_property where id=".$_REQUEST['pid']." ";
		$db->setQuery($query);
        $details=$db->loadObjectList();
		return $details;

}
//Completed
//Function to delete property
	function getproperty_delete($cid = array())
	{
		$db = & JFactory::getDBO();
		$query = "DELETE FROM #__cam_property WHERE id=".$_REQUEST['pid']; 
		$this->_db->setQuery( $query );
		if(!$this->_db->query()) {
		$this->setError($this->_db->getErrorMsg());
		return false;
		} 
}
//Completed
function getbmembers()
	{
	    /*****************code to send to fnd**************************/
	    JHTML::_('behavior.modal');
        $uri	=& JURI::getInstance();
		$base	= $uri->toString( array('scheme', 'host', 'port'));
		$link	= $base;
		$url	= 'index.php?option=com_camassistant&controller=addproperty&task=boardmemberslist';
		$status = 'width=400,height=350,menubar=yes,resizable=yes';
		$text = '<img src="templates/camassistant_left/images/select-my-bmembers.gif" alt="select industry"   />';
        $attribs['rel']	= "{handler: 'iframe', size: {x: 660, y: 350}}";  
		$attribs['class']	= 'modal';  
		$attribs['title']	= JText::_( 'Board Members' );
		//$attribs['onclick'] = "window.open(this.href,'win2','".$status."'); return false;";
		$output = JHTML::_('link', JRoute::_($url), $text, $attribs);
//		echo $output; exit;
		return $output;
		/*****************end of code to send to fnd**************************/	
	}
}
class camassistantModelAddproperty extends Jmodel
{
function __construct(){
		parent::__construct();
}	
}
?>