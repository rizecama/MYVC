<?php
/**
 * @version		1.0.0 camassistant $
 * @package		camassistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');
error_reporting(0);
jimport('joomla.application.component.controller');

class vendorsignupController extends JController
{

	function __construct()
	{
			parent::__construct();
	}
	function display()
	{
			parent::display();
	}
	
	//vendor signup process one
	function vendorsignup_p1()
	{
			parent::display();
	}
	
	//vendor signup process two
	function vendorsignup_p2()
	{
			$model = $this->getModel('vendorsignup');
			$model->getquestions();

			$post = JRequest::get('post');
			parent::display();
	}

	//function to save vendor  info
	function save_billing_info()
	{
		
		$Itemid = JRequest::getVar('Itemid','');
		$post	= JRequest::get('post');
		$post['name'];
		$email=  $post['email'];
		/*foreach($post  $key=>$value){
		$_SESSION[vendor][$key]=$value;
		
		}*/
		
				$_SESSION['vsignup']['email']= $_REQUEST['email']; 
				$_SESSION['vsignup']['vemail']= $_REQUEST['vemail']; 
				$_SESSION['vsignup']['bill_companyname']= $_REQUEST['bill_companyname']; 
				$_SESSION['vsignup']['company_phone']= $_REQUEST['company_phone']; 
				$_SESSION['vsignup']['company_represents']= $_REQUEST['company_represents']; 
				$_SESSION['vsignup']['phone_ext']= $_REQUEST['phone_ext']; 
				$_SESSION['vsignup']['is_checked']= $_REQUEST['is_checked']; 
				$_SESSION['vsignup']['name_on_card']= $_REQUEST['name_on_card']; 
				$_SESSION['vsignup']['CardType']= $_REQUEST['CardType']; 
				$_SESSION['vsignup']['CardNumber']= $_REQUEST['CardNumber']; 
				$_SESSION['vsignup']['ExpMon']= $_REQUEST['ExpMon']; 
				$_SESSION['vsignup']['ExpYear']= $_REQUEST['ExpYear']; 
				$_SESSION['vsignup']['verify_code']= $_REQUEST['verify_code']; 
				$_SESSION['vsignup']['pay_amount']= $_REQUEST['pay_amount']; 
				$_SESSION['vsignup']['promo_code']= $_REQUEST['promo_code']; 
				$_SESSION['vsignup']['invitecode']= $_REQUEST['invitecode'];
				$_SESSION['vsignup']['company_name']= $_REQUEST['company_name']; 
				$_SESSION['vsignup']['salutation']= $_REQUEST['salutation']; 
				$_SESSION['vsignup']['lastname']= $_REQUEST['lastname']; 
				$_SESSION['vsignup']['name']= $_REQUEST['name']; 
				$_SESSION['vsignup']['company_address']= $_REQUEST['company_address']; 
				$_SESSION['vsignup']['company_addresss']= $_REQUEST['company_addresss']; 
				$_SESSION['vsignup']['city']= $_REQUEST['city']; 
				$_SESSION['vsignup']['states']= $_REQUEST['states']; 
				$_SESSION['vsignup']['zipcode']= $_REQUEST['zipcode']; 
				$_SESSION['vsignup']['address']= $_REQUEST['address']; 
				$_SESSION['vsignup']['address2']= $_REQUEST['address2']; 
				$_SESSION['vsignup']['bill_city']= $_REQUEST['bill_city']; 
				$_SESSION['vsignup']['bill_zipcode']= $_REQUEST['bill_zipcode']; 
				$_SESSION['vsignup']['checkbox']= $_REQUEST['checkbox']; 
				$_SESSION['vsignup']['checkbox2']= $_REQUEST['checkbox2']; 
				$_SESSION['vsignup']['not_interest_RFP']= $_REQUEST['not_interest_RFP']; 
				$_SESSION['vsignup']['interest_RFP_alerts']= $_REQUEST['interest_RFP_alerts']; 
				$_SESSION['vsignup']['question']= $_REQUEST['question']; 
				$_SESSION['vsignup']['answer']= $_REQUEST['answer']; 
				$_SESSION['vsignup']['hear']= $_REQUEST['hear']; 
 
	
		$db =& JFactory::getDBO();
		      //$Email=$_POST['queryString'];
		
		$query_email="SELECT username FROM #__users WHERE username='".$email."'";
		$db->setQuery( $query_email );
		$result_email = $db->loadResult();
		
		if ($result_email!=''){
		$query_user="SELECT user_type FROM #__users WHERE username='".$email."'";
		$db->setQuery( $query_user );
		$query_user = $db->loadResult();
		if($query_user==12 || $query_user == 13) {
		$link ='index.php?option=com_camassistant&controller=vendorsignup&task=vendorsignup_p2&email=exits&Itemid='.$_REQUEST['Itemid']; 
		$msg="Email Already Exists";
		$msg = $msg."<br>"."You have already registered as a Manager in this site";
		$this->setRedirect( $link,$msg );
		}
		else {
		$link ='index.php?option=com_camassistant&controller=vendorsignup&task=vendorsignup_p2&email=exits&Itemid='.$_REQUEST['Itemid']; 
		$msg="Email Already Exists";
		$this->setRedirect( $link,$msg );
		}
		} 
		
		
		else {
		$model = $this->getModel('vendorsignup');
		$Itemid = JRequest::getVar('Itemid','');
		$post	= JRequest::get('post');
		//echo "<pre>";  print_r($post); 
		//echo $post['company_phone'];
		//exit;
		$a = explode('(',$post['company_phone']); 
		$b = explode(')',$a[1]);
		$post['company_phone'] = $b[0].'-'.trim($b[1]);
		session_start();
		//vendor company info
		$_SESSION['vendor']['company_name']					= $post['company_name'];
		$_SESSION['vendor']['company_address']				= $post['company_address'];
		$_SESSION['vendor']['company_addresss']				= $post['company_addresss'];
		$_SESSION['vendor']['company_phone']				= $post['company_phone'];
		$_SESSION['vendor']['phone_ext'] 					= $post['phone_ext'];
		$_SESSION['vendor']['city'] 						= $post['city'];
		$_SESSION['vendor']['states'] 						= $post['states'];
		$_SESSION['vendor']['zipcode'] 						= $post['zipcode'];
		$_SESSION['vendor']['company_represents'] 			= $post['company_represents'];
		$_SESSION['vendor']['not_interest_RFP'] 			= $post['not_interest_RFP'];
		$_SESSION['vendor']['interest_RFP_alerts'] 			= $post['interest_RFP_alerts'];
		$_SESSION['vendor']['question'] 			= $post['question'];
		$_SESSION['vendor']['answer'] 			= $post['answer'];
		$_SESSION['vendor']['hear'] 			= $post['hear'];
		
		//vendor user info
		$_SESSION['user']['name'] 				= $post['name'];
		$_SESSION['user']['lastname'] 			= $post['lastname'];
		$_SESSION['user']['email'] 				= $post['email'];
		$_SESSION['user']['promo_code'] 		= $post['promo_code'];
		$_SESSION['user']['invitecode'] 		= $post['invitecode'];
		//vendor billing info
		$_SESSION['bill']['CardType'] 			= $post['CardType'];
		$_SESSION['bill']['CardNumber'] 		= $post['CardNumber'];
		$_SESSION['bill']['name_on_card']		= $post['name_on_card'];
		$_SESSION['bill']['company_name'] 		= $post['bill_companyname'];
		$_SESSION['bill']['ExpMon'] 			= $post['ExpMon'];
		$_SESSION['bill']['ExpYear'] 			= $post['ExpYear'];
		$_SESSION['bill']['pay_amount'] 		= $post['pay_amount'];
		$_SESSION['bill']['promo_code'] 		= $post['promo_code'];
		$_SESSION['bill']['invitecode'] 		= $post['invitecode'];
		$_SESSION['bill']['address'] 			= $post['bill_address'];
		$_SESSION['bill']['adress2'] 			= $post['bill_address2'];
		$_SESSION['bill']['city'] 				= $post['bill_city'];
		$_SESSION['bill']['states'] 			= $post['bill_states'];
		
		if($post['invitecode'] != ''){
		$link = "index.php?option=com_camassistant&controller=vendorsignup&task=vendorsignup_p3&user_id=".$user->id."&Itemid=144&pack_cost=0";
		}
		else {
		if($post['hid_payment_type'] == 'Paypal')
		{
		$Payment_type = $post['hid_payment_type'];
		$Paypal_email = $post['hid_pay_busness_email'];
		$Paypal_currency = $post['hid_pay_currency'];
		$Paypal_name = $post['hid_pay_name'];
		$cardno = $post['CardNumber'];
		$money = $_SESSION['vsignup']['pay_amount'];
		if($money == '0'){
		$link = "index.php?option=com_camassistant&controller=vendorsignup&task=vendorsignup_p3&user_id=".$user->id."&Itemid=144&pack_cost=0";
		$msg = '';
		$this->setRedirect( $link,$msg );
		}
		else {
		$money = str_replace('$','',$money);
		//New Code for Paypal Subscriptions
		setlocale(LC_MONETARY, 'en_US');
		$unit = "y";
		$returnurl = "index.php?option=com_camassistant&controller=vendorsignup&task=vendorsignup_p3&user_id=".$user->id."&Itemid=144&pack_cost=0";
		$cancelurl = JURI::root();
		$notifyurl = "index.php?option=com_camassistant&controller=vendorsignup&task=notiifyurl&user_id=".$user->id."&Itemid=144&pack_cost=0";
		?>
		<head>
			<style>
				#dynamicDiv {
				    background-color: #000000;				   
				    height: 100%;
				    left: 0;				    
				    opacity: 0.7;    
				    padding: 0;
				    margin: auto 0;
				    position: absolute;    
				    visibility: visible;
				    width: 100%;
				    z-index: 99990;				    
				    font-size: 14px;
				    font-weight: bold;						   
				}
				#dynamicDiv2 p{
				    margin-top: 27px;
    			    text-align: center;
    			    color: #7AB800;
				}
			</style>
		</head>
		<body onLoad="document.getElementById('paymentForm').submit();">
			<div id="dynamicDiv2"><p>Please wait, we are redirecting you to paypal. Do not click on back button or refresh the page.<br/><br><img src="templates/camassistant_left/images/final_loading_big.gif"></p></div>
			<!--for testing https://www.sandbox.paypal.com/cgi-bin/webscr-->
			<form id="paymentForm" name="_xclick" action="https://www.sandbox.paypal.com/cgi-bin/webscr" method="post">
				<input type="hidden" name="cmd" value="_xclick-subscriptions">
				<input type="hidden" name="business" value="decorrev@local.com"> <!-- for testing will@assurancepower.com-->
				<input type="hidden" name="lc" value="US">
				<input type="hidden" name="currency_code" value="USD">
				<input type="hidden" name="no_shipping" value="1">
				<input type="hidden" name="rm" value="2">							
				<input type="hidden" name="a3" value="<?php echo $money; ?>">
				<input type="hidden" name="t3" value="Y">
				<input type="hidden" name="p3" value="1">
				<input type="hidden" name="src" value="1">
				<input type="hidden" name="custom" value="<?php echo $post['email']; ?>">				
				<input type="hidden" name="sra" value="1">
				<input type="hidden" name="return" value="<?php echo JURI::root().$returnurl; ?>">
				<input type="hidden" name="cancel_return" value="<?php echo JURI::root().$cancelurl; ?>"> 
				<input type="hidden" name="notify_url" value="<?php echo JURI::root().$notifyurl; ?>" > 
			</form>
		</body>
		<?php 
		 
		 //Completed 
		}
		
		}
		
		$link = $link; 
		$msg="";
		$this->setRedirect( $link,$msg );
	}	
}
}
	 function paymentcanceled()
	{
		$session = JFactory::getSession();
		$tid = $session->get("lasttid");
						
		$model = $this->getModel();		
		
		$data['tid'] = $tid;
		$data['completed'] = 'canceled';
		$data['txid'] = $_REQUEST['PNREF'];
		
		$approve = $_REQUEST['RESPMSG'];
		
		$model->storeTempReg($data);		
		$model->delTempReg($tid);		
		
		$msg = "Your registration is canceled.";		
		$session->clear("lasttid");			
		$session->set("message", $msg);
		$session->clear("renew");
		$session->clear("planid");		
		
		echo "<script>window.parent.location.href='".JURI::root()."index.php?option=com_regaps&view=regaps&layout=message';</script>";
		exit;
	}
	
	function paymentnotify()
	{
		
		$session = JFactory::getSession();
		$tid = $session->get("lasttid");
		$planid = $session->get("planid");
				
		$model = $this->getModel();		
				
		$approve = $_REQUEST['RESPMSG'];
		
		if($approve == "Approved")
		{
			$data['tid'] = $tid;
			$data['completed'] = 'yes';
			$data['txid'] = $_REQUEST['PNREF'];
			$data['active'] = 1;
			$data['scount'] = 0;
			$data['pcount'] = 0;
			$data['planid'] = $planid;			
			$msg = "Your payment is processed successfully.";
			$model->storeTempReg($data);
			$this->savereg();										
			$session->clear("lasttid");		
			$session->set("message", $msg);
			$session->clear("renew");
		
			echo "<script>window.parent.location.href='".JURI::root()."index.php?option=com_regaps&view=regaps&layout=message';</script>";
			exit;	
		}
		else{			
			$data['tid'] = $tid;
			$data['completed'] = 'error';
			$data['txid'] = $_REQUEST['PNREF'];
			$msg = "Sorry! your payment could not be processed right now.";	
			$model->delTempReg($tid);
			$model->storeTempReg($data);										
			$session->clear("lasttid");		
			$session->set("message", $msg);
			$session->clear("renew");
		
			echo "<script>window.parent.location.href='".JURI::root()."index.php?option=com_regaps&view=regaps&layout=message';</script>";
			exit;			
		}
		
		
	}

	
	//function to redirect vendor billing form to paypal url
	function paypal_form()
	{ 
		JRequest::getVar('view','vendorsignup');
		parent::display();
	}	
	
	function ajax_appyly_promocode()
	{
		$promocode = $_REQUEST['promocode'];
		$amount = $_REQUEST['amount'];
		$db =& JFactory::getDBO();
		$query = "SELECT amount FROM #__cam_promocode WHERE promocode = '".$promocode."'";
		$db->setQuery($query);
		$dis_amnt = $db->loadResult();
		if(!$dis_amnt) $dis_amnt = 0;
		$dis_excluded = $amount - $dis_amnt;
		$dis_excluded =  round($dis_excluded,2);
		echo $dis_excluded.'AND'.$dis_amnt;
		exit;
		//JRequest::getVar('view','vendorsignup');
	    //parent::display();
	}
	
	function vendorsignup_p3()
	{
		//echo "<pre>"; print_r($_REQUEST); exit;
		$model = $this->getModel('vendorsignup');
		JRequest::getVar('view','vendorsignup');
		parent::display();
	}
	
	//function to redirection if paypay is failed
	function vendor_billing_failed_form()
	{
		$model = $this->getModel('vendorsignup');
		//$model->update_payment_status('failed');
		JRequest::getVar('view','vendorsignup');
		parent::display();
	}
	
	//function to save industries selected in popup to a session
	function industries_Save()
	{
		//session_destroy();
		session_start();
		$ind_ary 				= JRequest::getVar('cid','','post','array',REQUEST_ALLOWRAW);
		$_SESSION['industries'] = $ind_ary;
		$ind = implode('<br>',$ind_ary); 
		$coma_ind = implode(',',$ind_ary); 
		echo "<script language='javascript' type='text/javascript'>
		var val = '".$ind."'; 
		var coma_val = '".$coma_ind."';
		//window.parent.document.getElementById('display_industries').style.display = 'block';		
		//window.parent.document.getElementById('display_industries').style.background = 'none';		
		//window.parent.document.getElementById('display_industries').style.border = 0;	
		//window.parent.document.getElementById('display_industries').style.overflow = 'hidden';		
				
		window.parent.document.getElementById('industries').value = coma_val;
		window.parent.document.getElementById('display_industries').innerHTML = val;
		window.parent.document.getElementById( 'sbox-window' ).close();
		//window.parent.parent.location.reload();
		 </script>"; 
	}
	
	//function to redirection after mail is sent
	function mail_redirect_form()
	{
		$useractivation = JRequest::getVar("useractivation",'');
		$db =& JFactory::getDBO();
		//exit;
		$activate = "UPDATE #__cam_vendor_company SET status='active' where activation ='".$useractivation."'";
		$db->setQuery($activate);
		$db->query();
		
		$userdetails1 = "SELECT user_id,company_address,company_name,tax_id FROM #__cam_vendor_company where activation ='".$useractivation."'";
		$db->setQuery( $userdetails1 );
		$cust_id = $db->loadObjectlist();
		$user_details = "SELECT name,email,lastname,phone FROM #__users where id ='".$cust_id[0]->cust_id."'";
		$db->setQuery( $user_details );
		$user_details1 = $db->loadObjectlist();
		
		$username=$user_details1[0]->name.' '.$user_details1[0]->lastname;
		$email=$user_details1[0]->email;
		
		$mailfrom='support@camassistant.com';
		$fromname='Camassistant Team';
		//$assignuseremail='rize.test@gmail.com';
		$username=$user_details1[0]->name.' '.$user_details1[0]->lastname;
		$email=$user_details1[0]->email;
		$address=$cust_id[0]->company_address;
		$companyname=$cust_id[0]->company_name;
		$camfirm_license_no=$cust_id[0]->tax_id;
		$phone=$user_details1[0]->phone;

		$assignuseremail='rize.test@gmail.com';
		//$assignuseremail='support@camassistant.com';
		$mailsubject='New Vendor Registered On CAMAssistant';
		$notification = "SELECT introtext  FROM #__content where id='198'";
		$db->setQuery($notification);
		$body = $db->loadResult();
		
		$body = str_replace('{EMAIL}', $email, $body);
		$body = str_replace('{USERNAME}', $username, $body);
		$body = str_replace('{ADDRESS}', $address, $body);
		$body = str_replace('{COMPANY NAME}', $companyname, $body);
		$body = str_replace('{PHONE}', $phone, $body);
		$body = str_replace('{TAX ID}', $camfirm_license_no, $body);
		//print_r($body); exit;
		
		JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
		
		//JRequest::getVar('view','vendorsignup');
		//parent::display();
	}
	
	//function to save vendor info,company info
	function save_signup()
	{
	
		//Checking tax ids
		$_SESSION['vendorthird'] = $_POST;
		$db =& JFactory::getDBO();
		$taxid = $_REQUEST['tax_id2']."-".$_REQUEST['tax_id3'];
		$tax_id="SELECT tax_id FROM #__cam_vendor_company WHERE tax_id='".$taxid."'";
		$db->setQuery( $tax_id );
		$tax = $db->loadResult();

		$lis_id="SELECT camfirm_license_no FROM #__cam_camfirminfo WHERE camfirm_license_no='".$taxid."'";
		$db->setQuery( $lis_id );
		$lis = $db->loadResult();

/*		$itaxid="SELECT taxid FROM #__vendor_inviteinfo WHERE exclude=1 and taxid='".$taxid."'";
		$db->setQuery($itaxid);
		$itax = $db->loadResult();
*/
		//echo $tax; exit;
		if($tax || $lis)
		{
			$msg = $msg.'Already a user exists with this TAX ID';
			$link = 'index.php?option=com_camassistant&controller=vendorsignup&task=vendorsignup_p3&user_id=&Itemid=144&pack_cost=99';
			$this->setRedirect( $link,$msg );
		}
		else 
		{
				jimport('joomla.user.helper');
				$post	= JRequest::get('post');
				$company = $_SESSION['vendor'];
				$user = $_SESSION['user'];
				$bill = $_SESSION['bill'];
				unset($_SESSION['vendor']);
				unset($_SESSION['user']);
				unset($_SESSION['bill']);
				unset($_SESSION['vendorthird']);
			//echo "<pre>"; print_r($post); print_r($user); print_r($company); print_r($bill); exit;
				$clone_user=clone(JFactory::getUser(0));
				$data['id']			= $post['user_id'];
				$data['name']		= $user['name'];
				$data['username']	= $user['email'];
				$data['password'] 	= $post['password'];
				$data['password2'] 	= $post['password2'];
				$data['salutation'] = $post['salutation'];
				$data['lastname'] 	= $user['lastname'];
				$data['email'] 		= $user['email'];
				$data['promo_code'] = $user['promo_code'];
				$data['invitecode'] = $user['invitecode'];				
				$data['phone'] 		= $company['company_phone'];
				$data['extension'] 	= $company['phone_ex'];
				$data['cellphone'] 	= $post['phone1'].'-'.$post['phone2'].'-'.$post['phone3'];
				$data['fax_id'] 	= $post['fax_id'].'-'.$post['fax_id1'].'-'.$post['fax_id2'];
				$data['usertype']	= 'Registered';
				$data['user_type'] 	= '11';
				$data['gid']		= '18';
				$data['block']		= '1';
				$data['state']		= $post['stateid'];
				$data['county']		= $post['county'];
				$data['question']		= $company['question'];
				$data['answer']		= $company['answer'];
				$data['hear']		= $company['hear'];
				$date =& JFactory::getDate();
				$data['registerDate']	= $date->toMySQL();
		
		
				//Completed
			jimport('joomla.filesystem.file');
			$files	=  JRequest::getVar( 'hidden_image', '', 'files', 'array' );
				//code to update existing user record
				if($post['user_id'] != '')
				{
					$data['block']		='0';
					
					if(!$clone_user->bind($data)) {
					echo $clone_user->getError();
					}else { 
					if (!$clone_user->save()){ 
					echo $clone_user->getError();
					}
					} 
					//exit;
					//code to update image in vendor table
					if($files && $files['name'] != '')
					{
						//code to update image filed in vendors table
						$files1= str_replace(' ','_',$files['name']); 		
						$files1= str_replace('&','_',$files1); 		
						$files1= str_replace('#','_',$files1); 		
						$files1= str_replace('%','_',$files1); 	
						$files2= $data['id'].'_'.$files1;
						$db = JFactory::getDBO();
						$sql = "SELECT image FROM  #__cam_vendor_company  where user_id='".$data['id']."'"; 
						$db->Setquery($sql);
						$prev_image = $db->loadResult();
						$sql = "UPDATE #__cam_vendor_company SET image='".$files2."' where user_id='".$data['id']."'"; 
						$db->Setquery($sql);
						$db->query();
						//code to move image to folderpath
						$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendors'.DS;
						$filename =$files2;
						$filepath = $base_Dir . $filename;  
						$post['image'] = $filename;
						if(file_exists($base_Dir . $prev_image))
						@unlink($base_Dir . $prev_image);
						move_uploaded_file($files['tmp_name'], $filepath);
						//code to resize image 
						$model = $this->getModel('vendorsignup');
						//$img = $mosConfig_live_site."/components/com_virtuemart/shop_image/product/".($product_full_image)." ";
						$img = $filepath;
						$resized = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendors'.DS.'resized'.DS;
						$img1 =$resized;
						$dimensions = $model->get_thumbnail_dimensions();
						if($dimensions[0]->vendor_logo_width == 0)
						$dimensions[0]->vendor_logo_width = 90;
						if($dimensions[0]->vendor_logo_height == 0)
						$dimensions[0]->vendor_logo_height = 90;
						//$thumb = $model->image_resize_to_max($img,$dimensions[0]->vendor_logo_width,$dimensions[0]->vendor_logo_height,$img1,$filename);
						$apath=getimagesize($img);
						$height_orig=$apath[1];
						$width_orig=$apath[0];
						$aspect_ratio = (float) $height_orig / $width_orig;
						$width =$dimensions[0]->vendor_logo_width;
						$height = round($width * $aspect_ratio);
						$thumb = $model->image_resize_to_max($img,$width,$height,$img1,$filename);
						
						//pdf resized 
						$width =132;
						$height = round($width * $aspect_ratio);
						$pdf_resized = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendors'.DS.'pdf_resized';
						$pdf_thumb = $model->image_resize_to_max($img,$width,$height,$pdf_resized,$filename);
		
						
						//end of code to reizeing 
					}
					
					$link = 'index.php?option=com_camassistant&controller=vendors&task=vendor_edit_form&view=vendors&Itemid=72';
					$msg="Updated successfully";
					$this->setRedirect( $link,$msg );
				}
				else if(!isset($post['user_id']) && $post['user_id'] == '')
				{
					//echo "<pre>"; print_r($data); 		 	//code to insert new user in users table
					if(!$clone_user->bind($data)) {
					
					echo $clone_user->getError();
					}else {
					if (!$clone_user->save()){
					echo $clone_user->getError();
					}
					}
					//echo "In else"; echo"<pre>"; print_r($clone_user); exit;
					//code to update jos_cam_vendor_company table
					$vendor['user_id']						= $clone_user->id;
					$vendor['company_name'] 				= $company['company_name'];
					$vendor['company_address']				= $company['company_address'];
					$vendor['company_addresss']				= $company['company_addresss'];
					$vendor['tax_id'] 						= $post['tax_id2'].'-'.$post['tax_id3'];
					$vendor['city'] 						= $company['city'];
					$vendor['state'] 						= $company['states'];
					$vendor['zipcode'] 						= $company['zipcode'];
					$vendor['in_house_vendor'] 				= $post['in_house_vendor'];
					$vendor['in_house_parent_company']		= $post['in_house_parent_company'];
					$post['in_house_parent_company_FEIN']	= $post['IH_FED2'].'-'.$post['IH_FED3'];
					$vendor['in_house_parent_company_FEIN']	= $post['in_house_parent_company_FEIN'];
					$vendor['miles']						= '';
					$vendor['company_represents'] 			= $company['company_represents'];
					$vendor['company_phone'] 				= $company['company_phone'];
					$vendor['phone_ext'] 					= $company['phone_ext'];
					$vendor['alt_phone'] 					= $post['alt_phone1'].'-'.$post['alt_phone2'].'-'.$post['alt_phone3'];
					$vendor['fax_id'] 						= $post['fax_id'].'-'.$post['fax_id1'].'-'.$post['fax_id2'];
					$vendor['alt_phone_ext']				= $post['alt_phone_ext'];
					$vendor['established_year'] 			= $post['established_year'];
					$vendor['not_interest_RFP']				= $company['not_interest_RFP'];
					$vendor['interest_RFP_alerts'] 			= $company['interest_RFP_alerts'];
					$vendor['authorized_business'] 			= '';
					$vendor['preferred_vendors'] 			= '';
					$vendor['company_web_url'] 				= $post['company_web_url'];
					$vendor['status'] 						= 'inactive';
					$vendor['created'] 						= date('Y-m-d');
					$vendor['published']					= '0';
					$vendor['activation'] = JUtility::getHash( JUserHelper::genRandomPassword() ); 
					$userid = $clone_user->id;
					//echo "<pre>"; print_r($vendor); exit;
					//code to update vendor_industries table
					if($clone_user->id)
					{
						//image upload code
						jimport('joomla.filesystem.file');
						$files		= JRequest::getVar( 'hidden_image', '', 'files', 'array' );	
						$files1= str_replace(' ','_',$files['name']); 		
						$files1= str_replace('&','_',$files1); 		
						$files1= str_replace('#','_',$files1); 		
						$files1= str_replace('%','_',$files1); 
					//	$vendor['image'] 						= $clone_user->id.'_'.$files1;
						$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendors'.DS; 
						if($files && $files['name'] != '')
						{
						$filename =$clone_user->id.'_'.$files1;
						$filepath = $base_Dir . $filename;  
						$post['image'] = $filename;
						$vendor['image'] = $filename;
						if(file_exists($base_Dir . $filename))
						@unlink($base_Dir . $filename);
						move_uploaded_file($files['tmp_name'], $filepath); 
						//code to resize image 
						$model = $this->getModel('vendorsignup');
						//$img = $mosConfig_live_site."/components/com_virtuemart/shop_image/product/".($product_full_image)." ";
						$img = $filepath;
						$pdf_resized = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendors'.DS.'pdf_resized';
						$resized = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendors'.DS.'resized';
						$img1 =$resized;
						$img2 =$pdf_resized;
						$dimensions = $model->get_thumbnail_dimensions();
					//$apath=getimagesize($img);
					//$height_orig=$apath[1];
					//$width_orig=$apath[0];
					if($dimensions[0]->vendor_logo_width == 0)
						$dimensions[0]->vendor_logo_width = 90;
						if($dimensions[0]->vendor_logo_height == 0)
						$dimensions[0]->vendor_logo_height = 90;
						//$thumb = $model->image_resize_to_max($img,$dimensions[0]->vendor_logo_width,$dimensions[0]->vendor_logo_height,$img1,$filename);
						if($img)
						{
							$apath=getimagesize($img);
							$height_orig=$apath[1];
							$width_orig=$apath[0];
							$aspect_ratio = (float) $height_orig / $width_orig;
							$width =$dimensions[0]->vendor_logo_width;
							$height = round($width * $aspect_ratio);
							$thumb = $model->image_resize_to_max($img,$width,$height,$img1,$filename);
							$pdf_thumb = $model->image_resize_to_max($img,$width_orig,$height_orig,$img2,$filename);
						}	
			$ftmp = $filename;
            $oname = $filename;
            $fname = $pdf_resized.'/'.$filename;
					
            $sizes = getimagesize($fname);
			//print_r( $files); exit;
            $width	=	$sizes[0];
            $height	=	$sizes[1];
    
            $extenssion = strstr($oname, ".");
        
            $prod_img		= $fname;	
            $prod_img_thumb =  $pdf_resized.'/'.$oname;
             move_uploaded_file($ftmp, $prod_img);
             $original_filesize = (filesize($prod_img)/1024);
             $sizes = getimagesize($prod_img);
             
            $expected_max_width		=	128;
            $expected_max_height	=	50;
            $originalw	=	$sizes[0];
            $originalh	=	$sizes[1];
    
            if ($originalh<$expected_max_height) {
                if ($originalw<$expected_max_width) {
                    $imgwidth	=	$originalw;
                    $imgheight	=	$originalh;
                } else {
                    $imgheight	=	($expected_max_width * $originalh)/ $originalw;
                    $imgwidth	=	$expected_max_width;
                }
            } else {
                 $new_height		=	$expected_max_height;
                 $new_width		=	($expected_max_height * $originalw)/ $originalh;
    
                if ($new_width>$expected_max_width) {
                    $new_height	=	($expected_max_width * $expected_max_height) / $new_width;
                    $new_width	=	$expected_max_width;
                }
    
                $imgwidth	=	$new_width;
                $imgheight	=	$new_height;
            }
			
            $new_h	=	$imgheight;
            $new_w	=	$imgwidth;
			$new_w_im='128'; 
			$new_h_im='50';
			$offsetwidth=$new_w_im-$new_w;
			$offsetw=$offsetwidth/2;
			$offsetheight=$new_h_im-$new_h;
			$offseth=$offsetheight/2;
  //  echo $extenssion;
           $dest = imagecreatetruecolor ($new_w_im,$new_h_im);
           $bg = imagecolorallocate ( $dest, 255, 255, 255 );
		//   print_r( $dest); echo "<br>"; print_r( $imgheight); exit;
           imagefill ( $dest, 0, 0, $bg );
		   $extenssion= str_replace('.jpg.jpg','.jpg',$extenssion);
		 $extenssion= str_replace('.jpeg.jpeg','.jpeg',$extenssion);
		 $extenssion= str_replace('.gif.gif','.gif',$extenssion);
		 $extenssion= str_replace('.png.png','.png',$extenssion);
			if($extenssion=='.jpg'){	
            	$src = imagecreatefromjpeg($prod_img)
                or die('Problem In opening Source JPG Image');
			}
			elseif($extenssion=='.JPG'){
				 $src = imagecreatefromjpeg($prod_img)
                 or die('Problem In opening Source JPEG Image');
			}
			elseif($extenssion=='.jpeg'){
				 $src = imagecreatefromjpeg($prod_img)
                 or die('Problem In opening Source JPEG Image');
			}
						elseif($extenssion=='.JPEG'){
				 $src = imagecreatefromjpeg($prod_img)
                 or die('Problem In opening Source JPEG Image');
			}
			elseif($extenssion=='.gif'){
				 $src = imagecreatefromgif($prod_img)
                 or die('Problem In opening Source GIF Image');
			}
			elseif($extenssion=='.png'){
			   $src = imagecreatefrompng($prod_img)
                or die('Problem In opening Source PNG Image');
			}
				
            if(function_exists('imagecopyresampled'))
            {
				$firstx = imagesx($src)	;
				$secondy = imagesy($src) ;
                imagecopyresampled($dest,$src,$offsetw,$offseth,0,0,$new_w,$new_h,$firstx,$secondy)
				
                or die('Problem In resizing');
            }else{
                Imagecopyresized($dest,$src,$offsetw,$offseth,0,0,$new_w,$new_h,imagesx($src),imagesy($src))
                or die('Problem In resizing');
            }
			
            imagejpeg($dest,$prod_img_thumb,72)
                or die('Problem In saving');
            imagedestroy($dest);
            @ob_flush();
            $new_filesize = (filesize($prod_img)/1024);
       
					/*if($width_orig <= $height_orig ){
					if($width_orig < '100'){
					$aspect_ratio = (float) $height_orig / $width_orig;
					$width = $width_orig;
					$height = $height = round($width * $aspect_ratio);
					$height_user = $height;
					} 
					else {
							$aspect_ratio = (float) $width_orig / $height_orig;
							$height = '54';
							$width = round($height * $aspect_ratio);
							$height_user = $height;
							}
					}
					else if($height_orig < $width_orig ){
					if( height_orig <= '54'){
					$aspect_ratio = (float) $width_orig / $height_orig;
					$width = round($height * $aspect_ratio);
					$height = $height_orig;
					$height_user = $height_orig;
					} 
					else {
							//echo "anil"; exit;
							$aspect_ratio = (float) $height_orig / $width_orig;
							$width = '100';
							$height = round($width * $aspect_ratio);
							$height_user = $height;
							} 
					}
					// anil_19-08-2011
					else{
					$width = 54;
					$height = 54;
					$aspect_ratio = (float) $height_orig / $width_orig;
					$height_user = round($width * $aspect_ratio);
					}*/
						
						//$thumb = $model->image_resize_to_max($img,$width,$height_user,$img1,$filename);
						//$pdf_thumb = $model->image_resize_to_max($img,$width,$height,$img2,$filename);
				}
						$model = $this->getModel('vendorsignup');
						if($model->store($vendor)) {
						$msg = JText::_( 'Vendor Saved' );
						} 
						else {
						$msg = JText::_( 'Error Saving Vendor' );
						}
		
						//end of image upload code
					   $model = $this->getModel('vendorsignup');
					   $ind_arr = $_REQUEST['cid'];; //getting vendor's industries from session variable
						//unset($_SESSION['industries']);		//unsetting session variablehmm
						
						//session_destroy();
						foreach($ind_arr as $arr)
						{
							$db = JFactory::getDBO();
							$model = $this->getModel('vendorsignup');
							$checked    = JHTML::_( 'grid.id', $i, $row->id );
							$sql = "SELECT id FROM #__cam_industries where industry_name='".$arr."'";
							$db->Setquery($sql);
							$arr = $db->loadResult();
							$ind_data['industry_id'] = $arr; 
							$sql = "SELECT max(id) FROM #__cam_vendor_company";
							$db->Setquery($sql);
							$ven_id = $db->loadResult(); 
							$ind_data['vendor_id'] = $ven_id;
							$query = "SELECT user_id FROM jos_cam_vendor_company WHERE id = ".$ven_id;
							$db->setQuery($query);
							$result = $db->loadObjectList();
							$ind_data['user_id'] = $result[0]->user_id;
							//echo "<pre>"; print_r($ind_data); exit;
							$model->store_industries($ind_data);
						}
						//code to save billing info
							$vendor_bill['user_id']				= $clone_user->id;
							$vendor_bill['CardType']			= $bill['CardType'];
							$vendor_bill['CardNumber'] 			= $bill['CardNumber'];
							$vendor_bill['name_on_card']		= $bill['name_on_card'];
							$vendor_bill['company_name'] 		= $bill['company_name'];
							$vendor_bill['ExpMon'] 				= $bill['ExpMon'];
							$vendor_bill['ExpYear'] 			= $bill['ExpYear'];
							$vendor_bill['pay_amount'] 			= $bill['pay_amount'];
							$vendor_bill['promo_code'] 			= $bill['promo_code'];
							$vendor_bill['address'] 			= $bill['address'].'-'.$bill['address2'];
							$vendor_bill['city'] 				= $bill['city'];
							$vendor_bill['states'] 				= $bill['states'];
							$vendor_bill['zipcode']				= $bill['zipcode'];
							$vendor_bill['phone'] 				= '';
							$vendor_bill['date'] 				= date('Y-m-d');
							$model->store_billing_info($vendor_bill);
						if($vendor['in_house_vendor'] == 'Yes')
						{
							$model = $this->getModel('vendorsignup');
							$vendor_In_House['vendor_type'] = 'I';
							$vendor_In_House['user_id']		= $result[0]->user_id;
							$vendor_In_House['vendor_id']	= $ven_id;
							$vendor_In_House['comp_name']	= $post['in_house_parent_company'];
							//$post['in_house_parent_company_FEIN'] = $post['IH_FED1'].'-'.$post['IH_FED2'].'-'.$post['IH_FED3'];
							$post['in_house_parent_company_FEIN'] = $post['IH_FED2'].'-'.$post['IH_FED3'];
							$vendor_In_House['Tax_id'] 		= $post['in_house_parent_company_FEIN'];
							$vendor_In_House['reg_date'] 	= date('Y-m-d');
							$model->store_Inhouse_vendors($vendor_In_House);
						}
						/*echo 'in else<pre>'.$ind_data['vendor_id']; 
						print_r($getid); echo '<br/>';print_r($data); echo $ind_data['vendor_id'];print_r($data);	
						exit;*/
						//echo '<br/>';
						
						$db =& JFactory::getDBO();
						for($j=0;$j<count($data['county']);$j++) 
						{
							$stateandcounty = explode("_",$data['county'][$j]);
							
							$state_id = $stateandcounty[0];
							$county_id = $stateandcounty[1];
					
							$query = "insert into #__vendor_state_counties (`id` ,`user_id` , `state_id` ,`county_id`) VALUES ('','".$ind_data['user_id']."','".$state_id."','".$county_id."')";
							$db->setQuery($query);
							$db->query();
						}
					//code to send approve vendor email
					//Update the vendor_invite_infi table as TAX ID modified by sateesh on 30-07-11
					$tax_id="SELECT vid FROM #__vendor_inviteinfo where taxid='".$vendor['tax_id']."'";
					$db->Setquery($tax_id);
					$tax = $db->loadResult();
					if($tax){
					$sql_update = "UPDATE #__vendor_inviteinfo SET v_id='".$ind_data['user_id']."',inhousevendors='".$data['email']."'  where taxid='".$vendor['tax_id']."'"; 
					$db->Setquery($sql_update);
					$db->query();
					}
					//Update the vendor_invite_infi table as TAX ID modified by sateesh on 30-07-11	
		
					$mail_content_sql="SELECT introtext  FROM #__content where id='150' ";
					$db->Setquery($mail_content_sql);
					$content = $db->loadResult();
					$siteURL		= JURI::base();
					$link = '<a href="'.$siteURL.'index.php">CLICK HERE</a>'; 
					//$link = "<a href='camassistant.com/cms/index.php'>CLICK HERE</a>"; 
					$body_content = str_replace('{VENDOR COMPANY NAME}',$company['company_name'],$content) ;
					$body_content = str_replace('{CLICK HERE}',$link,$body_content) ;
					//code to send mail to user
		//			$mailfrom = 'cam@company.com';
					$mailfrom = 'support@camassistant.com';
					$fromname = 'Camassistant Team';
					$assignuseremail = $user['email'];
					$mailsubject = 'Email Verification';
					$cc = 'support@camassistant.com';
					//$cc = 'vipin3485@gmail.com';
					//$body = $body_content; 
					//$vendorlinks = "SELECT introtext  FROM #__content where id=104";
					//$db->Setquery($vendorlinks);
					//$vendormsg = $db->loadResult();
					//$body = $vendormsg ;
					$siteURL		= JURI::base();
					$link = "<a href=".$siteURL."index.php?option=com_camassistant&controller=vendors&Itemid=158&task=mail_redirect_form&useractivation=".$vendor['activation']."&view=vendors'>CLICK HERE</a>"; 
					$link1 = $siteURL."index.php?option=com_camassistant&controller=vendors&Itemid=158&task=mail_redirect_form&useractivation=".$vendor['activation']."&view=vendors"; 
					
					$mail_content_sql="SELECT introtext  FROM #__content where id='166' ";
					$db->Setquery($mail_content_sql);
					$content = $db->loadResult();
					$body = str_replace('{VENDOR NAME}',$user['name'],$content) ;
					$body = str_replace('{CLICK HERE}',$link,$body) ;
					$body = str_replace('{ACTIVATION LINK}',$link1,$body) ;
					
					//$body = str_replace('{vendorname}',$user['name'],$body) ;
					//$body = str_replace("<a>Click here</a>","<a href=".$siteURL."index.php?option=com_camassistant&controller=vendors&Itemid=158&task=mail_redirect_form&useractivation=".$vendor['activation']."&view=vendors'>CLICK HERE</a>",$body) ;
					//$body = str_replace("{CAMASSISTANT.COM}","<a href=".$siteURL.">CAMassistant.com </a>",$body) ;
		//$body = "Hi ".$user['name'].'&nbsp;'.$user['lastname']."! <br/>Please <a href=".$siteURL."index.php?option=com_camassistant&controller=vendors&Itemid=158&task=mail_redirect_form&useractivation=".$vendor['activation']."&view=vendors'>CLICK HERE</a> to complete your Vendor Registration.<br/><br/>At Your Service,<br/>The<a href=".$siteURL.">CAMassistant.com </a>Team";
				JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body,$mode = 1,$cc);
				///Get state
			 $state="SELECT state FROM #__cam_vendor_states where code='".$post['stateid'][0]."'";
					$db->Setquery($state);
					$statename = $db->loadResult();
			//Completed
			//Get counties
			$i=0;
			//echo count($post['county']);
			while($i<count($post['county'])){
		$counties = substr($post['county'][$i], 3);
		
			 $county="SELECT County FROM #__cam_counties  where id='".$counties."'";
					$db->Setquery($county);
					$countyname = $db->loadResult();
					$i++;
					$maincounty .= $countyname.",";
			}
		//Completed	
					//echo $statename; exit;
				$mailfrom = 'support@camassistant.com';
				//$to = 'vipin3485@gmail.com';
				$to = 'support@camassistant.com';
				$subject = 'Vendor Information';
				$msg = '<table cellpadding="0" cellspacing="0">
				<tr><td>VENDOR DETAILS</td></tr>
				<tr><td><strong>USER INFO</strong></td></tr>
				<tr>
				<td>Vendor First Name:</td>
				<td>'.$user['name'].'</td>
				</tr>
				<tr>
				<td>Vendor Latst Name:</td>
				<td>'.$user['lastname'].'</td>
				</tr>
				<tr>
				<td>Vendor EMail:</td>
				<td>'.$user['email'].'</td>
				</tr>
				<tr><td><strong>VENDOR COMPANY INFO</strong></td></tr>		
				<tr>
				<td>Vendor Company Name:</td>
				<td>'.$company['company_name'].'</td>
				</tr>
				<tr>
				<td>Vendor Company Address:</td>
				<td>'.$company['company_address'].'</td>
				</tr>
				<tr>
				<td>Vendor Company Phone Number :</td>
				<td>'.$company['company_phone'].'</td>
				</tr>
				<tr>
				<td>Vendor Company Phone Extension :</td>
				<td>'.$company['phone_ext'].'</td>
				</tr>
				<tr>
				<td>Vendor Company City :</td>
				<td>'.$company['city'].'</td>
				</tr>
				<tr>
				<td>State:</td>
				<td>'.$statename.'</td>
				</tr>
				<tr>
				<td>Zip Code:</td>
				<td>'.$company['zipcode'].'</td>
				</tr>
				<tr>
				<td>Industries:</td>
				<td>'.$post['industries'].'</td>
				</tr>
				<tr>
				<td>Tax ID:</td>
				<td>'.$post['tax_id2'].'-'.$post['tax_id3'].'</td>
				</tr>
				<tr>
				<td>Established Year:</td>
				<td>'.$post['established_year'].'</td>
				</tr>
				<tr>
				<td>Fax ID :</td>
				<td>'.$post['fax_id'].'-'.$post['fax_id1'].'-'.$post['fax_id2'].'</td>
				</tr>
				<tr>
				<td>Alternative Phone number:</td>
				<td>'.$post['alt_phone1'].'-'.$post['alt_phone2'].'-'.$post['alt_phone3'].'</td>
				</tr>
				<tr>
				<td>Company Website:</td>
				<td>'.$post['company_web_url'].'</td>
				</tr>
				<tr>
				<td>Counties:</td>
				<td>'.$maincounty.'</td>
				</tr>
				</table>';
				
				$msg = $msg."<br><br>"."Thanks<br>CAMassistant.com";
				//echo $msg;
				//	exit;
				$res = JUtility::sendMail($mailfrom, '', $to, $subject, $msg, $mode=1);
		
		
					}
					$Itemid=JRequest::getVar('Itemid','');
					$app = &JFactory::getApplication();
					$link = 'index.php?option=com_camassistant&controller=vendorsignup&view=vendorsignup&task=thanks_redirect&Itemid=145';	
					$app->redirect($link);
				}// end if(isset($post['user_id']) && $post['user_id'] == '')
				
				}
	
	}
	//function to display thankyou message after registration
	 function thanks_redirect()
	 {
		parent::display();
	 }
	  //Function to activate link from the backend 
	 function reactivate(){
	 $id=JRequest::getVar('id','');
	 $activatecode=JRequest::getVar('useractivation','');
	 $db = JFactory::getDBO();
	 $query_activate = 'UPDATE #__users'. ' SET block = 0  WHERE id ='.$id.' AND activation="'.$activatecode.'"';
	 $db->setQuery($query_activate);
	 //JRequest::getVar('view','vendorsignup');
	 if($db->query())
	 {
		parent::display();
	 }
	 else{
	 $link='index.php?option=com_camassistant&controller=vendorsignup&Itemid=158';
	 $msg = 'Not activated succesfully.';
	 $this->setRedirect( $link,$msg );
	 }
}
//Completed
function verfiryinvitecode(){
	$db = JFactory::getDBO();
	$invite = $_REQUEST['invitecodegiven'] ;
	$codes="SELECT id, used FROM #__cam_invitecode where invitecode='".$invite."'";
	$db->Setquery($codes);
	$code_details = $db->loadObject();
	if($code_details->used == '1'){
	echo "used";
	}
	if($code_details->used == '0'){
	echo "notused";
	}
	if(!$code_details->id){
	echo "notindb";
	}
	exit;
	}
	
	
}
?>