<?php
/**
 * @version		1.0.0 camassistant $
 * @package		camassistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport('joomla.application.component.controller');

class propertymanagerController extends JController
{

 	function __construct()
	{
		parent::__construct();
	}

 	function display()
	{
		//echo "5454";exit;
		JRequest::getVar('view','propertymanager');
		parent::display();
	}
 	/*function submit_licid()
	{
	//echo "<pre>";print_r($_REQUEST);exit;
	JRequest::getVar('view','propertymanager');
	parent::display();
	}
 	function submit_companyinfo()
	{
	
	JRequest::getVar('view','propertymanager');
	parent::display();
	}
	*/
	function customer_edit_form()
	{
	   JRequest::getVar('view','propertymanager');
	   parent::display();
	}
	
	function verfiryuser()
	{
		$db =& JFactory::getDBO();
		$Email=$_POST['queryString'];
		
		if ($Email != "")
		{
		$query_email="SELECT username FROM #__users WHERE username='".$Email."'";
		$db->setQuery( $query_email );
		$result_email = $db->loadResult();
		//print_r($result_email);
		if ($result_email){ $data="invalid"; }}
		echo $data;
		exit;
   }
	
	/*function company_edit_form()
	{
	   JRequest::getVar('view','propertymanager');
	   parent::display();
	}*/
	function save_edit_form()
	{
	  //echo "<pre>"; print_r($_REQUEST); exit;
	   JRequest::getVar('view','propertymanager');
	   parent::display();
		$task = JRequest::getVar("task",'');
		$user_type =JRequest::getVar('user_type','');
		$email = JRequest::getVar('email','');
		$salutation = JRequest::getVar('salutation','');
		$fname = JRequest::getVar('fname','');
		$lname = JRequest::getVar('lname','');
		$phone1 = JRequest::getVar('phone1','');
		$phone2 = JRequest::getVar('phone2','');
		$phone3 = JRequest::getVar('phone3','');
		$phone = $phone1.'-'.$phone2.'-'.$phone3;
		$ext = JRequest::getVar('ext','');
		$cphone1 = JRequest::getVar('cphone1','');
		$cphone2 = JRequest::getVar('cphone2','');
		$cphone3 = JRequest::getVar('cphone3','');
		$cphone = $cphone1.'-'.$cphone2.'-'.$cphone3; 
		$password1 = JRequest::getVar('password',''); 
		if ($password1!=''){
		$password = $password1;
		}
		$id = JRequest::getVar('id','');
		jimport('joomla.user.helper');
		$post	= JRequest::getVar("task",'');
		$user=clone(JFactory::getUser(0));
		
		$data['name']	=	$fname;
		$data['username']	=	$email;
		$data['password'] = $password;
		//$data['password2'] = $password2 ;
		$data['salutation'] = $salutation;
		$data['lastname'] = $lname ;
		$data['email'] = $email;
		$data['phone'] = $phone;
		$data['extension'] = $ext;
		$data['cellphone'] = $cphone;
		$data['usertype'] = 'Registered';
		$data['user_type'] = $user_type;
		$data['gid']='18';
		$data['id']=$id;
	
		//code to update users table
	//code to update existing user record
		if($data['id'] != '')
		{
		   
			$data['block']		='0';
			if(!$user->bind($data)) {
			echo $user->getError();
			}else {
			if (!$user->save()){ 
			echo $user->getError();
			}
			} 
			}
			$Itemid = JRequest::getVar('Itemid');
			//echo $Itemid; exit;
			$comp_id = JRequest::getVar("comp_id",0);
			if($comp_id)
			$link = 'index.php?option=com_camassistant&controller=propertymanager&task=customer_edit_form&pmanager_id='.$id.'&comp_id='.$comp_id.'&Itemid='.$Itemid;
			else
			$link = 'index.php?option=com_camassistant&controller=propertymanager&task=customer_edit_form&Itemid='.$Itemid;
//			$link = 'index.php?option=com_camassistant&controller=propertymanager&task=customer_edit_form&Itemid=72';
			$msg="Updated successfully";
		    $this->setRedirect( $link,$msg );
				
	}
	function useractivation()
	{
		$useractivation = JRequest::getVar("useractivation",'');
		$db =& JFactory::getDBO();
		$activate = "UPDATE #__cam_customer_companyinfo SET status='active' where activation ='".$useractivation."'";
		$db->setQuery($activate);
		$res=$db->query();
	
		if($res){
			echo "<br/><br/>Your Account Has Been Activated Successfully";
			}
		//$this->setLayout('property_active');
		parent::display();
		
	}	
	
	
	function save_edit_companyinfo()
	{
		JRequest::getVar('view','propertymanager');
		parent::display();
		$task = JRequest::getVar("task",'');
		$mailaddress = JRequest::getVar('mailaddress','');
		$city = JRequest::getVar('city','');
		$state = JRequest::getVar('state','');
		$zipcode = JRequest::getVar('zipcode','');
		$cphone1 = JRequest::getVar('cphone1','');
		$cphone1 = JRequest::getVar('cphone1','');
		$cphone3 = JRequest::getVar('cphone3','');
		$cphone = $cphone1.'-'.$cphone1.'-'.$cphone3;
		$cext = JRequest::getVar('cext','');
		$caphone1 = JRequest::getVar('caphone1','');
		$caphone2 = JRequest::getVar('caphone2','');
		$caphone3 = JRequest::getVar('caphone3','');
		$caphone = $caphone1.'-'.$caphone2.'-'.$caphone3;
		$caext = JRequest::getVar('caext','');
		$website = JRequest::getVar('website','');
		$image = JRequest::getVar('image','');
		$id = JRequest::getVar('id','');
		
		 //image upload code
		jimport('joomla.filesystem.file');
		$files		= JRequest::getVar( 'image', '', 'files', 'array' );
	    $base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'properymanager'.DS; 
		if($files && $files['name'] != '')
		{
			$filename =$files['name'];
			$filepath = $base_Dir . $filename;  
			$post['image'] = $filename;
			//print_r($filepath); exit;
			if(file_exists($base_Dir . $filename))
						@unlink($base_Dir . $filename);
			move_uploaded_file($files['tmp_name'], $filepath); 
		}
				
			$propertymanager['id'] = $id;
			$propertymanager['mailaddress'] = $mailaddress;
			$propertymanager['comp_city'] = $city;
			$propertymanager['comp_state'] = $state;
			$propertymanager['comp_zip'] = $zipcode;
			$propertymanager['comp_phno'] = $cphone;
			$propertymanager['comp_extnno'] = $cext;
			$propertymanager['comp_alt_phno'] = $caphone;
			$propertymanager['comp_alt_extnno'] = $caext;
			$propertymanager['comp_website'] = $website;
			$propertymanager['comp_logopath'] = $filename;
			
		
		$db =& JFactory::getDBO();
		$query = "UPDATE #__cam_customer_companyinfo SET mailaddress='$mailaddress',comp_city='$city',comp_state='$state',comp_zip='$zipcode',comp_phno='$cphone',comp_extnno='$cext',comp_alt_phno='$caphone',comp_alt_extnno='$caext',comp_website='$website',comp_logopath='$filename' WHERE id=".$id;
	$db->setQuery($query);
	$Itemid = JRequest::getVar('Itemid');
		//echo $Itemid; exit;
		if (!$db->query()) {
		
		$link = 'index.php?option=com_camassistant&controller=propertymanager&task=company_edit_form&Itemid='.$Itemid;
		//$link = 'index.php?option=com_camassistant&controller=propertymanager&task=company_edit_form&Itemid=72';
		$msg="Not Updated Your Company Details";
		$this->setRedirect( $link,$msg );
		}
		$link = 'index.php?option=com_camassistant&controller=propertymanager&task=company_edit_form&Itemid='.$Itemid;
		//$link = 'index.php?option=com_camassistant&controller=propertymanager&task=company_edit_form&Itemid=72';
		$msg="Updated successfully";
		$this->setRedirect( $link,$msg );

	}
 	/*function submit_customerinfo()
	{
	
	JRequest::getVar('view','propertymanager');
	parent::display();
	}*/
	
	function thanks()
	{
		//$post	= JRequest::get('post');
		//global $mainframe;
		//$model = $this->getModel('propertymanager');
		
		//if ($model->store($post)) {
		//$msg = JText::_( 'Propertymanager Saved' );
		//} else {
		//$msg = JText::_( 'Error Saving Property' );
		//}
		//JRequest::setVar('view', 'propertymanager');
		
		$this->setLayout('property_thanks');
		parent::display();
	}
	
	//fun. to get properties and  their managers
	/*function manage_properties()
	{
		JRequest::getVar('view','propertymanager');
		parent::display();
	}
	//fun. to get properties and  their managers
	function edit_vendor_mails()
	{
		JRequest::getVar('view','propertymanager');
		parent::display();
	}*/
	//Fun. to submit vendor emails information for camfirm admin to send
	function update_camfirmadmin_emailsinfo()
	{
		global $mainframe;
		$basepath=JURI::root(); 
		$model	=& $this->getModel();
		$itemid=JRequest::getVar('Itemid',0);
		$post = JRequest::get( 'post', JREQUEST_ALLOWHTML );
		//echo "<pre>"; print_r($post); exit;
		
		if($model->CAMMails_store($post)) {
			$mesg = "<font color='red' size='3'><b>Invitation Mails Information Updated successfully<b></font>";	
		} else {
			$mesg = "Could not submitted Mails Information";
		}
		$this->setRedirect( 'index.php?option=com_camassistant&controller=propertymanager&task=edit_vendor_mails&Itemid='.$itemid,$mesg );
	} 
	//
	function submit_property()
	{
		global $mainframe;
		$model = $this->getModel();
		$itemid=JRequest::getVar('Itemid',0);
		$post	= JRequest::get('post');
		if(!$post['share'])
		$post['share']=2;
		/*echo "123456<pre>";
		print_r($post); exit;*/

		$user=JFactory::getUser();  //For $my
		$taxids=$model->getProperty_TaxIDs();
		$tax_ids=array();
		$cnt=0;
		for($i=0;$i<count($taxids);$i++)
		{
			if($post['tax_id']==$taxids[$i]->tax_id)
			$cnt++;
		}
		if($cnt>1)
		{
			$err_msg="This Property is already registered with our system. Please contact your board/Management Company to determine your Property's Administrator on CAMassistant.com. <br>If you have any  additional questions, please email us at <b>properties@CAMassistant.com</b>";
			$mainframe->Redirect('index.php?option=com_camassistant&controller=propertymanager&task=property_edit_form&property_id='.$post['id'].'&Itemid='.$itemid,$err_msg );
		}
		if($user->id)
		{
			if ($model->property_store($post)) {
				$err_msg="<font color='red'>Property updated successfully</font>";
			} else {
				$err_msg="<font color='red'>Error Saving Property (ie. Property Name or Tax-Id entry might be duplicated )</font>";
			}
			$mainframe->Redirect('index.php?option=com_camassistant&controller=propertymanager&task=property_edit_form&property_id='.$post['id'].'&Itemid='.$itemid,$err_msg );
		} else {
			$err_msg="<font color='red'>Your session has been expired.Please login again</font>";
			$mainframe->Redirect('index.php?option=com_user&view=login',$err_msg );
		}
	}
	
//	by anandbabu for deleting the properties from jos_cam_property
	function delproperty()
	{	
		$post = JRequest::getvar('cid');
		$pmanager_id = JRequest::getvar('pmanager_id');
		$id = JRequest::getvar('id');
		$Itemid = JRequest::getvar('Itemid');
		$url = "index.php?option=com_camassistant&controller=propertymanager&task=customer_edit_form&pmanager_id=".$pmanager_id."&comp_id=".$id."&Itemid=".$Itemid;			        $model =& $this->getModel();
		$items = $model->getdelproperty();
		if($items){ $msg = "Record Deleted Sucessfully";}
		else { $msg = "Record has beend delted"; }
		$this->setRedirect($url,$msg);
	}
// by anandbabu for reassigning the property 
	function reassign_prop()
	{
		$post = JRequest::getvar('task');
		JRequest::getVar('view','propertymanager');
		parent::display();
	}
	function update_prop()
	{
		$post = JRequest::getvar('admins');
		$pid = JRequest::getvar('pmanager_id');
		$compid = JRequest::getvar('comp_id');
		$model =& $this->getModel();
		$res = $model->update_rec();
		if($res) { 	$msg = 'success';  }
		else { $msg = 'failed'; } 
//		index.php?option=com_camassistant&controller=propertymanager&task=customer_edit_form&pmanager_id=206&comp_id=12&Itemid=89

		$url = "index.php?option=com_camassistant&controller=propertymanager&task=customer_edit_form&&pmanager_id=".$pid."&comp_id=".$compid."&Itemid=89";
		$this->setRedirect($url,$msg);
	}
	
	//fun. to get properties and  their managers
	/*function cam_managers_viewall()
	{
		JRequest::getVar('view','propertymanager');
		parent::display();
	}*/
/*	function rfpform()
	{
		JRequest::setVar('view', 'rfp');
		parent::display();
	}
	function addproperty()
	{
		JRequest::setVar('view', 'rfp');
		parent::display();
	}
	function submit_property()
	{
		$post	= JRequest::get('post');
		//echo "123456<pre>";	print_r($post); exit;
		global $mainframe;
		$model = $this->getModel('property');
		
		if ($model->store($post)) {
			$msg = JText::_( 'Property Saved' );
		} else {
			$msg = JText::_( 'Error Saving Property' );
		}
		exit;
		JRequest::setVar('view', 'rfp');
		parent::display();
	}*/
}
?>