<?php
/**
 * @version		1.0.0 camassistant $
 * @package		camassistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport('joomla.application.component.controller');

class rfpcenterController extends JController
{

	function __construct()
	{
		parent::__construct();
	}

	function display()
	{
		parent::display();
	}

	function submitedrfp()
	{
	   JRequest::getVar('view','rfpcenter');
	   parent::display();
	}

	function unsubmittedrfp()
	{

	   JRequest::getVar('view','rfpcenter');
	   parent::display();
	}

// by ananad babu
// function is for updating the  cam_rfpinfo  rft_type from drafts to Submitted
	function updateunsubmited()
	{

			$rfpid = JRequest::getVar('id','');
		$db =& JFactory::getDBO();
		$query = "UPDATE #__cam_rfpinfo SET rfp_type='rfp' WHERE id=".$rfpid;
		$db->setQuery( $query );
		$res=$db->query();
		if($res){
		echo "Sucessfully Submitted the RFP";
		}
		//$itemid= $_REQUEST['Itemid'];
		$msg= "Sucessfully Submitted the RFP";
		$url ='index.php?option=com_camassistant&controller=rfpcenter&task=unsubmittedrfp&Itemid='.$_REQUEST['Itemid'];
		$this->setRedirect($url,$msg);
	}

	function closedrfp()
	{
	   JRequest::getVar('view','rfpcenter');
	   parent::display();
	}
	function awardrfp()
	{
	   JRequest::getVar('view','rfpcenter');
	   parent::display();
	}
	function unawardrfp()
	{
	   JRequest::getVar('view','rfpcenter');
	   parent::display();
	}
	function dashboard()
	{
	   JRequest::getVar('view','rfpcenter');
	   parent::display();
	}
	function awardjob()
	{
	   $model = $this->getModel('rfpcenter');
	   JRequest::getVar('view','rfpcenter');
	   parent::display();
	}
	function outsidevendor()
	{

	 // echo "<pre>"; print_r($_REQUEST);
	   $model = $this->getModel('rfpcenter');
	   JRequest::getVar('view','rfpcenter');
	   parent::display();
	}

	function requote()
	{
	JRequest::getVar('view','rfpcenter');
     parent::display();
	}

	function requotesuccess()
	{
	  // print_r($_REQUEST); exit;
	   	$rid = JRequest::getVar('rid','');
		//*** Rfp Info **//
   		$db =& JFactory::getDBO();
		$query2="INSERT INTO #__cam_rfpinfo( `cust_id` , `property_id` , `rfp_indus_data` , `industry_id` , `projectName` , `startDate` , `endDate` , `frequency` , `proposalDueDate` , `proposalDueTime` , `maxProposals` , `createdDate` , `rfp_type` , `defsow_who` , `choose_tasks` , `work_perform` , `site_visit` , `bidders_info` , `publish` )
		SELECT `cust_id` , `property_id` , `rfp_indus_data` , `industry_id` , `projectName` , `startDate` , `endDate` , `frequency` , `proposalDueDate` , `proposalDueTime` , `maxProposals` , `createdDate` , `rfp_type` , `defsow_who` , `choose_tasks` , `work_perform` , `site_visit` , `bidders_info` , `publish`
		FROM #__cam_rfpinfo
		WHERE id =".$rid;

		$db->setQuery( $query2 );
		$res1=$db->query();

///*** Line task  ****//

	$insert_id = $db->insertid();
	$query3 ="INSERT INTO #__cam_rfpreq_info (`rfp_id`, `req_parentid`, `req_subparentid`, `req_id`, `price`) SELECT  '$insert_id', `req_parentid`, `req_subparentid`, `req_id`, `price` FROM #__cam_rfpreq_info WHERE rfp_id =".$rid;
	$db->setQuery( $query3 );
	$res2=$db->query();


		$query4 ="INSERT INTO #__cam_rfpsow_linetask (`rfp_id`, `linetaskname`, `rfpreference`, `taskuploads`, `task_desc`, `is_req_taskvendors`, `task_price`) SELECT  '$insert_id', `linetaskname`, `rfpreference`, `taskuploads`, `task_desc`, `is_req_taskvendors`, `task_price` FROM #__cam_rfpsow_linetask WHERE rfp_id =".$rid;
	$db->setQuery( $query4 );
	$res4=$db->query();


	 $query5 ="INSERT INTO #__cam_rfpsow_docs (`rfp_id`, `doc_path`, `is_req_docvendors`) SELECT  '$insert_id', `doc_path`, `is_req_docvendors` FROM #__cam_rfpsow_docs WHERE rfp_id =".$rid;
	$db->setQuery( $query5 );
	$res5=$db->query();
	//echo "<pre>"; print_r($res5); exit;
		$query7 = "UPDATE #__cam_vendor_proposals SET proposaltype='Unawarded' WHERE proposaltype!='draft' and proposaltype!='Draft' and proposaltype!='ITB' and rfpno=".$rid;
		$db->setQuery( $query7 );
		$res12=$db->query();

		$query16 = "UPDATE #__cam_rfpinfo SET rfp_type='draft' WHERE id=".$insert_id;
		$db->setQuery( $query16);
		$res16=$db->query();

		$today = date('m-d-Y');
		$query9 = "UPDATE #__cam_rfpinfo SET rfp_type='Unawarded',unawardeddate='$today' WHERE id=".$rid;
		$db->setQuery( $query9 );
		$res9=$db->query();
	$query6 = "SELECT U.email FROM  #__cam_vendor_proposals as C LEFT JOIN #__users as U ON U.id=C.proposedvendorid WHERE C.rfpno=".$insert_id;
	//	$query = "UPDATE #__cam_vendor_proposals SET proposaltype='Awarded' WHERE id=".$id;
		$db->setQuery( $query6 );
		$data6 = $db->loadObjectlist();
		for ($i=0, $n=count( $data6); $i < $n; $i++)
	{
	if ($data6[$i]->email== ''){
	//echo "anand";
	} else {
	$mails = $data6[$i]->email;
	//echo "<pre>"; print_r($data1[$i]);
				$mailfrom = 'support@myvendorcenter.com';
				$fromname = 'MyVendorCenter Team';
				$assignuseremail = $mails;

				$mailsubject = 'MyVendorCenter Team';
				$body = "The proposals have all been rejected and the Property Manager will be re-bidding the job
	<br/><br/>At Your Service,<br/><br/>
	MyVendorCenter.com";
				JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $useractivation,$mode = 1);

	}
	}
	if($res5){
	$msg="Your RFP Requoted Successfully";
	 }
	$link='index.php?option=com_camassistant&controller=rfpcenter&view=rfpcenter&task=requote&rfpid='.$insert_id.'&Itemid=56';
	$this->setRedirect( $link,$msg );
	}
	function proposalawarding()
	{
	   $model = $this->getModel('rfpcenter');
	   JRequest::getVar('view','rfpcenter');
	   parent::display();
	}

	function verfiryaward()
	{

		$db =& JFactory::getDBO();
		$type=$_POST[queryString];
		//print_r($type); exit;
		if ( $type != "")
		{
		$query_email="SELECT * FROM #__cam_vendor_proposals WHERE proposaltype='$type'";
		$db->setQuery( $query_email );
		$result_email = $db->loadObjectlist();
	//	print_r($result_email);
		if ( $result_email){ $data="invalid"; }}
		echo $data;
		exit;
		return  $data;
   }
   function price()
	{

		$db =& JFactory::getDBO();
		$type=$_POST[queryString];
	//	print_r($type); exit;
		if ( $type != "")
		{
		$query_email="SELECT proposal_total_price FROM #__cam_vendor_proposals WHERE id='$type'";
		$db->setQuery( $query_email );
		$data = $db->loadResult();
		}
	//	print_r($result_email);
		//if ( $result_email){ $data="invalid"; }}
		echo $data;
		exit;
		return  $data;
   }



	function awardedsuccess()
	{
		$rfpno = JRequest::getVar('rfpno','');
		$radioid = JRequest::getVar('radioid',array());
		$comission = JRequest::getVar('comission','');
		//$comission = str_replace(',', '', $comission1);
		//$comission1 = doubleval(str_replace(",","",$comission2));
	 	//$comission = number_format($comission1,2,'.','');

		$email = JRequest::getVar('email','');
		$radioid = JRequest::getVar('radioid','');
		$name = JRequest::getVar('name','');
		$price1 = JRequest::getVar('v_price','');
		//echo $price2 = CAST( $price1 AS UNSIGNED );
		$price2 = doubleval(str_replace(",","",$price1));
	 	$price = number_format($price2,2,'.','');
		 //echo '<pre>'; print_r($_REQUEST); exit;
		 //$email1 = $email[$radioid];
		 $db =& JFactory::getDBO();
		 $award = "SELECT U.id,U.email,U.name,U.lastname,C.rfpno FROM  #__cam_vendor_proposals as C LEFT JOIN #__users as U ON U.id=C.proposedvendorid WHERE C.id=".$radioid[0]." and C.rfpno=".$rfpno;
		//$query = "UPDATE #__cam_vendor_proposals SET proposaltype='Awarded' WHERE id=".$id;
		$db->setQuery( $award );
		$award_data = $db->loadObjectlist();
		$lname = $award_data[0]->lastname;
		$username = $award_data[0]->name;
        $fullname= $username.' '.$lname;
		$email1=$award_data[0]->email;
		//To get the winning amount to the awarded vendor
		/*$win_amt = "SELECT proposal_total_price FROM  #__cam_vendor_proposals  WHERE id=".$radioid[0]." and rfpno=".$rfpno;
		$db->setQuery( $win_amt );
		$winningamt = $db->loadResult();*/

		//Completed
		$query = "SELECT DISTINCT U.id,U.email,U.name,U.lastname,C.rfpno FROM  #__cam_vendor_proposals as C LEFT JOIN #__users as U ON U.id=C.proposedvendorid WHERE C.id!=".$radioid[0]." and C.proposedvendorid!=".$award_data[0]->id." and C.rfpno=".$rfpno;
		//$query = "UPDATE #__cam_vendor_proposals SET proposaltype='Awarded' WHERE id=".$id;
		$db->setQuery( $query );
		$data1 = $db->loadObjectlist();
		//echo "<pre>"; print_r($data1); exit;
		$query2 = "UPDATE #__cam_vendor_proposals SET proposaltype='Awarded',proposal_total_price='$price',commission = '$comission'  WHERE id=".$radioid[0];
		$db->setQuery( $query2 );
		$res=$db->query();
		//To get the winning amount to the awarded vendor
		$win_amt = "SELECT proposal_total_price FROM  #__cam_vendor_proposals  WHERE id=".$radioid[0]." and rfpno=".$rfpno;
		$db->setQuery( $win_amt );
		$winningamt = $db->loadResult();
		$price2 = doubleval(str_replace(",","",$winningamt));
	 	$price = number_format($price2,2,'.','');
		$winamts = "$".number_format($price,2);

		if($res){
		echo "Job Awarded Successfully";
		}
		$today = date('m-d-Y');
		$query6 = "UPDATE #__cam_rfpinfo SET rfp_type='Awarded',awardeddate='$today' WHERE id=".$rfpno;
		$db->setQuery( $query6 );
		$res4=$db->query();
		if($res4){
		echo "Job Awarded Successfully";
		}
		$query3 = "UPDATE #__cam_vendor_proposals SET proposaltype='Unawarded' WHERE id!=".$radioid[0]." and proposaltype!='draft' and proposaltype!='Draft' and proposaltype!='ITB' and rfpno=".$rfpno;
		$db->setQuery( $query3 );
		$res1=$db->query();

		if($res1){
		echo "Unaward remaining proposals Successfully";
		}
		$query4 ="SELECT proposedvendorid FROM #__cam_vendor_proposals WHERE rfpno=".$rfpno." and proposaltype='Awarded'";
		$db->setQuery( $query4 );
		$data4 = $db->loadResult();
		$query5 = "INSERT INTO #__cam_awardlist ( id , rfpid , proposal_id, user_id ) VALUES (  '' , '".$rfpno."','".$radioid[0]."', '".$data4."' );";
		$db->setQuery( $query5 );
		$res5=$db->query();

		if($res1){
		echo "Your Proposal Awarded Successfully";
		}
		for ($i=0, $n=count( $data1); $i < $n; $i++)
		{
		if ($data1[$i]->email== ''){
		//echo "anand";
		} else {
		//echo "<pre>"; print_r($data1[$i]);

		$mails = $data1[$i]->email;
		$name = $data1[$i]->name;
		$lname = $data1[$i]->lastname;
		$rfpno = $data1[$i]->rfpno;
		//echo "<pre>"; print_r($data1[$i]);
		$mailfrom = 'support@myvendorcenter.com';
		$fromname = 'MyVendorCenter Team';
		$assignuseremail = $mails;
		$username=$name.' '.$lname;
		$mailsubject = 'Job update from MyVendorCenter';
		//For getting the rejected emil
		$query_rejectedemail ="SELECT introtext  FROM #__content where id='157' ";
		$db->setQuery( $query_rejectedemail );
		$body = $db->loadResult();
		//
		//$body = $rej_email;
			//echo "<pre>"; echo "regect"; print_r($assignuseremail);
		$user=JFactory::getUser();
		$db = & JFactory::getDBO();
		$property_name = "SELECT P.property_name FROM #__cam_rfpinfo as C LEFT JOIN #__cam_property as P ON P.id=C.property_id WHERE C.id=".$rfpno;
		$db->setQuery( $property_name );
		$propertyname1 = $db->loadResult();
		$propertyname = str_replace('_',' ',$propertyname1);
		$company_name = "SELECT comp_name FROM #__cam_customer_companyinfo  WHERE cust_id=".$user->id;
		$db->setQuery( $company_name );
		$companyname = $db->loadResult();


		$Bid_sql = "SELECT  (select count(*)  from jos_cam_vendor_proposals where rfpno=".$rfpno." AND proposaltype = 'Submit') as Submitted, (select count(*)  from jos_cam_vendor_proposals where rfpno=".$rfpno." AND proposaltype = 'Reject') as Rejected, MAX(CAST( proposal_total_price AS UNSIGNED )) as Max_Bid, MIN(CAST( proposal_total_price AS UNSIGNED )) as Min_Bid FROM #__cam_vendor_proposals  WHERE publish!=2 and proposal_total_price != '0.00' and proposal_total_price != '' and rfpno = ".$rfpno;
		$db->setQuery($Bid_sql);
		$Bid_info = $db->loadObjectList();
		//echo "<pre>"; print_r($Bid_info[0]); exit;
		$Min_Bid1 = doubleval(str_replace(",","",$Bid_info[0]->Min_Bid));
	 	$Min_Bid = number_format($Min_Bid1,2,'.','');
		$Max_Bid1 = doubleval(str_replace(",","",$Bid_info[0]->Max_Bid));
	 	$Max_Bid = number_format($Max_Bid1,2,'.','');
                if($price > $Max_Bid){
                   $Max_Bid=  $price;
                }
                if ($price < $Min_Bid) {
                    $Min_Bid =$price;
                }
		$Min_Bid = doubleval(str_replace(",","",$Min_Bid));
	 	$Min_Bid = number_format($Min_Bid,2,'.','');
		$Min_Bid = "$".number_format($Min_Bid,2);

		$Max_Bid = doubleval(str_replace(",","",$Max_Bid));
	 	$Max_Bid = number_format($Max_Bid,2,'.','');
		$Max_Bid = "$".number_format($Max_Bid,2);

		//completd
		$body = str_replace('{Vendor Name}',$username,$body) ;
		$body = str_replace('{RFP NUMBER}',$rfpno,$body) ;
		$body = str_replace('{Property Name}',$propertyname,$body);
		$body = str_replace('{CAM Firm}',$companyname,$body);
		$body = str_replace('{winning Bid}',$winamts,$body);
		$body = str_replace('{Low Bid}',$Min_Bid,$body);
		$body = str_replace('{High Bid}',$Max_Bid,$body);
		//echo "<pre>"; print_r($body); exit;
		//echo "<pre>";  echo "reject"; print_r($body);
		//CAMassistant.com";
		JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);

//To send the BCC
/*	$body = $body.'<br><font color="red">Manager rejected this vendor:  '.$assignuseremail.'</font>';
	$camaemail = 'RFP@myvendorcenter.com';
	JUtility::sendMail($mailfrom, $fromname, $camaemail, $mailsubject, $body, $mode = 1);
*///Completed

		//To send the email to cc emails of the vendors
		$query_cc ="select ccemail from #__users Where id =".$data1[$i]->id;
		$db->setQuery($query_cc);
		$cc = $db->loadResult();
		$cclist = explode(';',$cc);
		for($c=0; $c<count($cclist); $c++){
		$listcc = $cclist[$c];
		if($listcc != ''){
		$res = JUtility::sendMail($mailfrom, $fromname, $listcc, $mailsubject, $body, $mode=1);
		}
		}
		//Completed


		// parent::display();
		}
		}

		//To send the unawarded email only once
		$rejectedmails = '';
		for ($ua=0, $cv=count( $data1); $ua < $cv; $ua++) {
		$rejectedmails .= $data1[$ua]->name.' '.$data1[$ua]->lastname.',';
		}
		$ericemail = 'support@myvendorcenter.com';
		$mailfrom = 'support@myvendorcenter.com';
		$fromname = 'MyVendorCenter Team';
		$mailsubject = 'Job update from MyVendorCenter';
		$body = $body.'<br><font color="red">Manager rejected these vendors:  '.$rejectedmails.'</font>';
		JUtility::sendMail($mailfrom, $fromname, $ericemail, $mailsubject, $body, $mode = 1);
		$rejectedmails = '';
		//Completed

		$mailfrom = 'support@myvendorcenter.com';
		$fromname = 'MyVendorCenter Team';
		$assignuseremail = $email1;
		$query_acceceptemail ="SELECT introtext  FROM #__content where id='156' ";
		$db->setQuery( $query_acceceptemail );
		$body = $db->loadResult();

		$property_name = "SELECT P.property_name FROM #__cam_rfpinfo as C LEFT JOIN #__cam_property as P ON P.id=C.property_id WHERE C.id=".$rfpno;
		$db->setQuery( $property_name );
		$propertyname1 = $db->loadResult();
		$propertyname = str_replace('_',' ',$propertyname1);
		$user=JFactory::getUser();
		//print_r($user->user_type);
		 $customer_name = $user->name.' '.$user->lastname;
	 $camfirm_id = "SELECT P.cust_id FROM #__cam_customer_companyinfo as C LEFT JOIN #__cam_camfirminfo as P ON P.id=C.comp_id WHERE C.cust_id=".$user->id;
		$db->setQuery( $camfirm_id );
		$camfirmid = $db->loadResult();
		 $camfirm_name = "SELECT name,lastname FROM #__users WHERE id=".$camfirmid;
		$db->setQuery( $camfirm_name );
		$camfirmname = $db->loadObjectlist();
		$camfirm_admin= $camfirmname[0]->name.'&nbsp;'.$camfirmname[0]->lastname;
		//print_r($camfirm_admin);
		$company_name = "SELECT comp_name FROM #__cam_customer_companyinfo  WHERE cust_id=".$user->id;
		$db->setQuery( $company_name );
		$cname = $db->loadResult();

		if($user->user_type=='13'){
		$camadmin = $customer_name;
		} else {
		$camadmin = $camfirm_admin;
		}
		//echo "accept"; print_r($assignuseremail);

		$body = str_replace('{Vendor Name}',$fullname,$body) ;
		$body = str_replace('{RFP NUMBER}',$rfpno,$body);
		$body = str_replace('{Property Name}',$propertyname,$body);
		//$body = str_replace('{Customer}',$customer_name,$body);
		if($user->user_type=='13'){
		//$body = str_replace('to {CAM Firm}',' ',$body);
		//$body = str_replace('of {CAM Firm}',' ',$body);
		$body = str_replace('{Customer}',$customer_name,$body);
		$body = str_replace('{CAM Firm}',$cname,$body);
		//$body = str_replace('{CAM Firm}',$customer_name,$body);
		} else {
		//$body = str_replace('{CAM Firm}',$camadmin,$body);
		$body = str_replace('{Customer}',$customer_name,$body);
		$body = str_replace('{CAM Firm}',$cname,$body);
		}
		//$winamts = "$".number_format($winningamt,2);
		$body = str_replace('{winning Bid}',$winamts,$body);
		$mailsubject = 'Project awarded to you through MyVendorCenter';
		$bcc='awardedjob@myvendorcenter.com';
		/*$body = "Hi ".$username."!<br/>congratulations on being awarded the job #".$rfpno." to you
		<br/><br/>At Your Service,<br/><br/>
		CAMassistant.com";*/
			//exit;
		JUtility::sendMail($mailfrom, $fromname, $assignuseremail,$mailsubject, $body, $mode = 1,$bcc);

		//Mail to the manager
		$vendor_cname = "SELECT U.company_name FROM  #__cam_vendor_proposals as C LEFT JOIN #__cam_vendor_company as U ON U.user_id=C.proposedvendorid WHERE C.id=".$radioid[0];
		$db->setQuery( $vendor_cname );
		$vendor_company_name = $db->loadResult();
		$manageremail_body ="SELECT introtext  FROM #__content where id='241' ";
		$db->setQuery( $manageremail_body );
		$managerbody = $db->loadResult();
		$managerbody = str_replace('{Vendor Name}',$fullname,$managerbody) ;
		$managerbody = str_replace('{Vendor Company Name}',$vendor_company_name,$managerbody) ;
		$managerbody = str_replace('{RFP NUMBER}',$rfpno,$managerbody);
		$managerbody = str_replace('{Property Name}',$propertyname,$managerbody);
		if($user->user_type=='13'){
		$managerbody = str_replace('{Customer}',$customer_name,$managerbody);
		$managerbody = str_replace('{CAM Firm}',$cname,$managerbody);
		} else {
		$managerbody = str_replace('{Customer}',$customer_name,$managerbody);
		$managerbody = str_replace('{CAM Firm}',$cname,$managerbody);
		}
		$managerbody = str_replace('{winning Bid}',$winamts,$managerbody);
		$manageremail = $user->email ;
		JUtility::sendMail($mailfrom, $fromname, $manageremail,$mailsubject, $managerbody, $mode = 1);
		//$manageremail_support = 'vipin@rizecorp.net';
		$manageremail_support = 'support@myvendorcenter.com';
		JUtility::sendMail($mailfrom, $fromname, $manageremail_support,$mailsubject, $managerbody, $mode = 1);
		//Completed

		//JUtility::sendMail($mailfrom, $fromname, $bcc, $mailsubject, $body, $mode = 1);

		//To send the email to cc emails of the vendors
		$query_cc ="select ccemail from #__users Where id =".$award_data[0]->id;
		$db->setQuery($query_cc);
		$cc = $db->loadResult();
		$cclist = explode(';',$cc);
		for($c=0; $c<count($cclist); $c++){
		$listcc = $cclist[$c];
		if($listcc != ''){
		$res = JUtility::sendMail($mailfrom, $fromname, $listcc, $mailsubject, $body, $mode=1);
		}
		}
		//Completed


		// parent::display();

		$user = JFactory::getUser();
		if($user->user_type == '12'){
		$link = 'index.php?option=com_camassistant&controller=rfpcenter&task=awardrfp&Itemid=130';
		}
		if($user->user_type == '13'){
		$link = 'index.php?option=com_camassistant&controller=rfpcenter&task=awardrfp&Itemid=123';
		}

		$msg="Job Awarded Successfully";
		$this->setRedirect( $link,$msg );
		//modifying end by anand kumar on 21-7-11

	}
	function unawardingjob()
	{
	   $model = $this->getModel('rfpcenter');
	   $unawardingjob = $model->getunawardingjob();
	   //print_r($unawardingjob);
	   JRequest::getVar('view','rfpcenter');
	   parent::display();
	}
	function copydraft()
	{
	  $user = JFactory::getUser();
	 	$rid = JRequest::getVar('rfpid','');
		//*** Rfp Info **//
   		$db =& JFactory::getDBO();
		$query2="INSERT INTO #__cam_rfpinfo( `cust_id` , `rfp_indus_data` , `industry_id` , `projectName` , `startDate` , `endDate` , `frequency` , `proposalDueDate` , `proposalDueTime` , `maxProposals` , `createdDate` , `rfp_type` , `defsow_who` , `choose_tasks` , `work_perform` , `site_visit` , `bidders_info` , `publish` )
		SELECT `cust_id` , `rfp_indus_data` , `industry_id` , `projectName` , `startDate` , `endDate` , `frequency` , `proposalDueDate` , `proposalDueTime` , `maxProposals` , `createdDate` , `rfp_type` , `defsow_who` , `choose_tasks` , `work_perform` , `site_visit` , `bidders_info` , `publish`
		FROM #__cam_rfpinfo
		WHERE id =".$rid;

		$db->setQuery( $query2 );
		$res1=$db->query();

///*** Line task  ****//

	 $insert_id = $db->insertid();
	 $query3 ="INSERT INTO #__cam_rfpreq_info (`rfp_id`, `req_parentid`, `req_subparentid`, `req_id`, `price`) SELECT  '$insert_id', `req_parentid`, `req_subparentid`, `req_id`, `price` FROM #__cam_rfpreq_info WHERE rfp_id =".$rid;
	$db->setQuery( $query3 );
	$res2=$db->query();
	 $query4 ="INSERT INTO #__cam_rfpsow_linetask (`rfp_id`, `linetaskname`, `rfpreference`, `taskuploads`, `task_desc`, `is_req_taskvendors`, `task_price`) SELECT  '$insert_id', `linetaskname`, `rfpreference`, `taskuploads`, `task_desc`, `is_req_taskvendors`, `task_price` FROM #__cam_rfpsow_linetask WHERE rfp_id =".$rid;
	$db->setQuery( $query4 );
	$res4=$db->query();


	 $query5 ="INSERT INTO #__cam_rfpsow_docs (`rfp_id`, `doc_path`, `is_req_docvendors`) SELECT  '$insert_id', `doc_path`, `is_req_docvendors` FROM #__cam_rfpsow_docs WHERE rfp_id =".$rid;
	$db->setQuery( $query5 );
	$res5=$db->query();
	
	$property ="SELECT property_id  FROM #__cam_rfpinfo where id=".$rid." ";
		$db->setQuery( $property );
		$propertyid = $db->loadResult();


    $copy ="INSERT INTO #__cam_copyrfp ( `new_rfpid`, `old_rfpid`, `old_propertyid`) VALUES ( '".$insert_id."','".$rid."', '".$propertyid."' );";
	$db->setQuery( $copy );
	$copy_rfp =$db->query();

	//echo "<pre>"; print_r($res5); exit;
		$query7 = "UPDATE #__cam_rfpinfo SET rfp_type='draft' WHERE id=".$insert_id;
		$db->setQuery( $query7 );
		$res12=$db->query();
		$query8 = "UPDATE #__cam_rfpinfo SET cust_id=".$user->id." WHERE id=".$insert_id;
		$db->setQuery( $query8 );
		$res13=$db->query();

		//$query9 = "UPDATE #__cam_rfpinfo SET rfp_type='Unawarded' WHERE id=".$rid;
		//$db->setQuery( $query9 );
		//$res9=$db->query();
		//Insertign rfp industries

		$industries ="SELECT rfpid,industry_id  FROM #__cam_rfpindustries where rfpid=".$rid." ";
		$db->setQuery( $industries );
		$industrieslist = $db->loadObjectList();
//		echo "<pre>"; print_r($industrieslist); exit;
		for($ind=0; $ind<count($industrieslist); $ind++){
			$insert_indus = "insert into #__cam_rfpindustries values ('','".$insert_id."','".$industrieslist[$ind]->industry_id."')";
			$db->SetQuery($insert_indus);
			$db->query();
		}

		//Completed

		if($res5){
	$msg='Copy as "A New (Draft) RFP" successful';
	 }
	$link='index.php?option=com_camassistant&controller=rfp&task=editrfp&var=copy&rfpid='.$insert_id.'&Itemid='.$_REQUEST['Itemid'];
	$this->setRedirect( $link,$msg );

	}

	function unawardingsuccess()
	{
	//print_r($_REQUEST); exit;
		$model = $this->getModel('rfpcenter');
	 //  $unawardingjob = $model->getunawardingjob();


		$rejection_letter = JRequest::getVar('box','');
		$other = JRequest::getVar('other','');
		$rfpno = JRequest::getVar('rid','');


		$unawarding['id']= $id;
		$unawarding['rfpno']= $rfpno;
    	$unawarding['rejection_letter']= $rejection_letter;
		$unawarding['other']= $other;

		$model = $this->getModel('rfpcenter');
		//print_r($model); exit;
	 	 if($model->store_unaward($unawarding)) {
		$db =& JFactory::getDBO();
		$query2 = "SELECT U.email,U.name,U.lastname,C.id,C.proposedvendorid FROM  #__cam_vendor_proposals as C LEFT JOIN #__users as U ON U.id=C.proposedvendorid WHERE C.rfpno=".$rfpno;
	//	$query = "UPDATE #__cam_vendor_proposals SET proposaltype='Awarded' WHERE id=".$id;
		$db->setQuery( $query2 );
		$data2 = $db->loadObjectlist();

		$today = date('m-d-Y');
		$query9 = "UPDATE #__cam_rfpinfo SET rfp_type='Unawarded',unawardeddate='$today' WHERE id=".$rfpno;
		$db->setQuery( $query9 );
		$res9=$db->query();

		$query3 = "UPDATE #__cam_vendor_proposals SET proposaltype='Unawarded' WHERE proposaltype!='draft' and proposaltype!='Draft' and proposaltype!='ITB' and rfpno=".$rfpno;
		$db->setQuery( $query3 );
		$res=$db->query();

	if($res){
		echo "all proposals are rejected Successfully";
		}
	for ($i=0, $n=count( $data2); $i < $n; $i++)
	{
	if ($data2[$i]->email== ''){
	//echo "anand";
	} else {
	$mails = $data2[$i]->email;
	$name=$data2[$i]->name;
	$proposalid=$data2[$i]->id;
	$lastname=$data2[$i]->lastname;
	$vendorid=$data2[$i]->proposedvendorid;
	$fullname=$name.' '.$lastname;
	//To get the property name
	$pr_manager ="SELECT u.property_name, v.projectName FROM #__cam_property as u, #__cam_rfpinfo as v where u.id = v.property_id and v.id='".$rfpno."' ";
	$db->setQuery( $pr_manager );
	$rfp_details = $db->loadObject();
	$pm = $rfp_details->property_name ;
	$projectName = $rfp_details->projectName ;

	$vendor_cname ="SELECT company_name FROM #__cam_vendor_company where user_id='".$vendorid."' ";
	$db->setQuery( $vendor_cname );
	$vendorcname = $db->loadResult();
	//Completed
	//echo "<pre>"; print_r($data1[$i]);
	$mailfrom = 'support@myvendorcenter.com';
	$fromname = 'MyVendorCenter Team';
	$assignuseremail = $mails;
	$mailsubject = 'Job update from MyVendorCenter';
	$rejectedemail ="SELECT introtext  FROM #__content where id='176' ";
	$db->setQuery( $rejectedemail );
	$body = $db->loadResult();
	$user = JFactory::getUser();
	$managername = $user->name.' '.$user->lastname ;
		$body = str_replace('{VENDOR NAME}',$vendorcname,$body) ;
		$body = str_replace('{PROPOSAL NUMBER}',$proposalid,$body) ;
		$body = str_replace('{RFP NUMBER}',$rfpno,$body);
		$body = str_replace('{Property Name}',str_replace('_',' ',$pm),$body);
		$body = str_replace('{Reference Name}',$projectName,$body);
		$body = str_replace('{Manager Name}',$managername,$body);
		//echo "<pre>"; print_r($body); exit;
	/*$body = "Your proposal was not accepted
	<br/><br/>At Your Service,<br/><br/>
	CAMassistant.com";*/
	JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
//To send the email to cc emails of the vendors
		$query_cc ="select ccemail from #__users Where id =".$vendorid;
		$db->setQuery($query_cc);
		$cc = $db->loadResult();
		$cclist = explode(';',$cc);

		for($c=0; $c<count($cclist); $c++){
		$listcc = $cclist[$c];
		if($listcc != ''){
		$res = JUtility::sendMail($mailfrom, $fromname, $listcc, $mailsubject, $body, $mode=1);
		}
		}
		//Completed
	$assignuseremail = 'rfp@myvendorcenter.com';
	$body = "<font color='red'>This is for Support team</font><br><br>".$body;
	JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);

	 // parent::display();
		}
		//echo "<pre>"; print_r($data2);
		//echo '<div style="color:red; font-size:20px; padding-top:150px; padding-left:10px;">Your Request Has Been Submited Successfully We Will Get Back To You Shortly</div>';
		 //parent::display($tpl);
		}

	}
		 $user = JFactory::getUser();
		 if($user->user_type == '12'){

			$link = 'index.php?option=com_camassistant&controller=rfpcenter&task=dashboard&Itemid=128';

			}
			if($user->user_type == '13'){
			$link = 'index.php?option=com_camassistant&controller=rfpcenter&task=dashboard&Itemid=125';
			}
			$doc =& JFactory::getDocument();
			echo '<script>parent.location="'.$link.'";</script>';
			exit;
		// $msg="Thank";
	//	$this->setRedirect( $link,$msg );
	}

function outsidevendorsuccess()
	{
	    $rfpno = JRequest::getVar('rfpid','');
		 $awardedvendor = JRequest::getVar('awardedvendor','');
		$amount2 = JRequest::getVar('amount','');
		  $amount1 = doubleval(str_replace(",","",$amount2));
	      $amount = number_format($amount1,2,'.','');
		 $today = date('m-d-Y');
		 $user=JFactory::getUser();
		//print_r($_REQUEST); exit;
		$outsidevendor['id']= '';
		$outsidevendor['rfpid']= JRequest::getVar('rfpid','');
    	$outsidevendor['awarded_vendor']= JRequest::getVar('awardedvendor','');
		$outsidevendor['criteria']= JRequest::getVar('criteria','');
	    $outsidevendor['addendum']= JRequest::getVar('addendum','');
		$outsidevendor['amount']=  $amount;
		$outsidevendor['award_date']= $today;
		$outsidevendor['cust_id']= $user->id;
		$model = $this->getModel('rfpcenter');

		//print_r($outsidevendor); exit;
	 	if($model->store_outsidevendor($outsidevendor)) {
		//echo '<div style="padding-top:50px; padding-left:10px; font-size:15px; font-weight:bold;">Successfully Awarded To The Outside Vendor</div>';
		$db =& JFactory::getDBO();
		$query5 = "UPDATE #__cam_vendor_proposals SET proposaltype='Unawarded' WHERE proposaltype!='draft' and proposaltype!='Draft' and proposaltype!='ITB' and rfpno=".$rfpno;
		$db->setQuery( $query5 );
		$res5=$db->query();
		if($res5){
		//echo "all proposals are Unawarded Successfully";
		echo "Job Awarded Successfully";
		}
	}
		 $query = "SELECT DISTINCT U.email,U.name,U.lastname,U.id,C.rfpno FROM  #__cam_vendor_proposals as C LEFT JOIN #__users as U ON U.id=C.proposedvendorid WHERE C.rfpno=".$rfpno;
		//$query = "UPDATE #__cam_vendor_proposals SET proposaltype='Awarded' WHERE id=".$id;
		$db->setQuery( $query );
		$data1 = $db->loadObjectlist();
		$query9 = "UPDATE #__cam_rfpinfo SET rfp_type='Awarded',awardeddate ='$today',apple='out' WHERE id=".$rfpno;
		$db->setQuery( $query9 );
		$res9=$db->query();
		for ($i=0, $n=count( $data1); $i < $n; $i++)
		{
		if ($data1[$i]->email== ''){
		//echo "anand";
		} else {
		//echo "<pre>"; print_r($data1[$i]);

		$mails = $data1[$i]->email;
		$name = $data1[$i]->name;
		$lname = $data1[$i]->lastname;
		$rfpno = $data1[$i]->rfpno;
		$vendorid = $data1[$i]->id;
		//echo "<pre>"; print_r($data1[$i]);
		$mailfrom = 'support@myvendorcenter.com';
		$fromname = 'MyVendorCenter Team';
		$assignuseremail = $mails;
		$username=$name.' '.$lname;
		$mailsubject = 'Job update from MyVendorCenter';
		$query_rejectedemail ="SELECT introtext  FROM #__content where id='157' ";
		$db->setQuery( $query_rejectedemail );
		$body = $db->loadResult();
		//
		//$body = $rej_email;
			//echo "<pre>"; echo "regect"; print_r($assignuseremail);
		$user=JFactory::getUser();
		$db = & JFactory::getDBO();
		$property_name = "SELECT P.property_name FROM #__cam_rfpinfo as C LEFT JOIN #__cam_property as P ON P.id=C.property_id WHERE C.id=".$rfpno;
		$db->setQuery( $property_name );
		$propertyname1 = $db->loadResult();
		$propertyname = str_replace('_',' ',$propertyname1);
		$company_name = "SELECT comp_name FROM #__cam_customer_companyinfo  WHERE cust_id=".$user->id;
		$db->setQuery( $company_name );
		$companyname = $db->loadResult();


		$Bid_sql = "SELECT  (select count(*)  from jos_cam_vendor_proposals where rfpno=".$rfpno." AND proposaltype = 'Submit') as Submitted, (select count(*)  from jos_cam_vendor_proposals where rfpno=".$rfpno." AND proposaltype = 'Reject') as Rejected, MAX(CAST( proposal_total_price AS UNSIGNED )) as Max_Bid, MIN(CAST( proposal_total_price AS UNSIGNED )) as Min_Bid FROM #__cam_vendor_proposals  WHERE  proposal_total_price != '0.00' and proposal_total_price != '' and publish!=2  and rfpno = ".$rfpno;
		$db->setQuery($Bid_sql);
		$Bid_info = $db->loadObjectList();
		//echo "<pre>"; print_r($Bid_info[0]); exit;
                $Min_Bid1 = doubleval(str_replace(",","",$Bid_info[0]->Min_Bid));
	 	$Min_Bid = number_format($Min_Bid1,2,'.','');
		$Max_Bid1 = doubleval(str_replace(",","",$Bid_info[0]->Max_Bid));
	 	$Max_Bid = number_format($Max_Bid1,2,'.','');
		 if($amount > $Max_Bid){
                   $Max_Bid=  $amount;
                }
                if ($amount < $Min_Bid) {
                    $Min_Bid =$amount;
                }
				$amount_win = "$".number_format($amount,2);
				$Min_Bid = "$".number_format($Min_Bid,2);
				$Max_Bid = "$".number_format($Max_Bid,2);
		//completd
		$body = str_replace('{Vendor Name}',$username,$body) ;
		$body = str_replace('{RFP NUMBER}',$rfpno,$body) ;
		$body = str_replace('{Property Name}',$propertyname,$body);
		$body = str_replace('{CAM Firm}',$companyname,$body);
		$body = str_replace('{winning Bid}',$amount_win,$body);
		$body = str_replace('{Low Bid}',$Min_Bid,$body);
		$body = str_replace('{High Bid}',$Max_Bid,$body);
		//echo "<pre>"; print_r($body);
		//echo "<pre>";  echo "reject"; print_r($body);
		//CAMassistant.com";
		JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
		//To send the email to cc emails of the vendors
		$query_cc ="select ccemail from #__users Where id =".$vendorid;
		$db->setQuery($query_cc);
		$cc = $db->loadResult();
		$cclist = explode(';',$cc);

		for($c=0; $c<count($cclist); $c++){
		$listcc = $cclist[$c];
		if($listcc != ''){
		$res = JUtility::sendMail($mailfrom, $fromname, $listcc, $mailsubject, $body, $mode=1);
		}
		}
		//Completed
/*		$assignuseremail = 'support@myvendorcenter.com';
//		$assignuseremail = 'rize.cama@gmail.com';
		$body = $body . "<br><br><font color='red'>This email went out to vendor ".$username."</font>";
		JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
*/
		}
		}//exit

		//To send the unawarded email only once
		$outerrejectedmails = '';
		for ($oa=0, $cv1=count( $data1); $oa < $cv1; $oa++) {
		$outerrejectedmails .= $data1[$oa]->name.' '.$data1[$oa]->lastname.',';
		}
		$ericemail = 'support@myvendorcenter.com';
		$mailfrom = 'support@myvendorcenter.com';
		$fromname = 'MyVendorCenter Team';
		$mailsubject = 'Job update from MyVendorCenter';
		$body = $body.'<br><font color="red">Manager rejected these vendors:  '.$outerrejectedmails.'</font>';
		JUtility::sendMail($mailfrom, $fromname, $ericemail, $mailsubject, $body, $mode = 1);
		$outerrejectedmails = '';
		//Completed


		$mailfrom = 'support@myvendorcenter.com';
		$fromname = 'MyVendorCenter Team';
		$mailsubject = 'Project awarded to you through MyVendorCenter';
		//$assignuseremail = $email1;
		$query_acceceptemail ="SELECT introtext  FROM #__content where id='156' ";
		$db->setQuery( $query_acceceptemail );
		$body = $db->loadResult();

		$property_name = "SELECT P.property_name FROM #__cam_rfpinfo as C LEFT JOIN #__cam_property as P ON P.id=C.property_id WHERE C.id=".$rfpno;
		$db->setQuery( $property_name );
		$propertyname1 = $db->loadResult();
		$propertyname = str_replace('_',' ',$propertyname1);
		$fullname= $awardedvendor;

		//print_r($user->user_type);
		 $customer_name = $user->name.' '.$user->lastname;
		 $camfirm_id = "SELECT P.cust_id FROM #__cam_customer_companyinfo as C LEFT JOIN #__cam_camfirminfo as P ON P.id=C.comp_id WHERE C.cust_id=".$user->id;
		$db->setQuery( $camfirm_id );
		$camfirmid = $db->loadResult();
		 $camfirm_name = "SELECT name,lastname FROM #__users WHERE id=".$camfirmid;
		$db->setQuery( $camfirm_name );
		$camfirmname = $db->loadObjectlist();
		$camfirm_admin= $camfirmname[0]->name.'&nbsp;'.$camfirmname[0]->lastname;
		//print_r($camfirm_admin);
		if($user->user_type=='13'){
		$camadmin = $customer_name;
		} else {
		$camadmin = $camfirm_admin;
		}
		//echo "accept"; print_r($assignuseremail);
		$company_name = "SELECT comp_name FROM #__cam_customer_companyinfo  WHERE cust_id=".$user->id;
		$db->setQuery( $company_name );
		$cname = $db->loadResult();

		$body = str_replace('{Vendor Name}',$fullname,$body) ;
		$body = str_replace('{RFP NUMBER}',$rfpno,$body) ;
		$body = str_replace('{Property Name}',$propertyname,$body);
//		$amount2 = "$".number_format($amount2,2);
		$amount_win1 = "$".number_format($amount,2);
		$body = str_replace('{winning Bid}',$amount_win1,$body);
		//$body = str_replace('{Customer}',$customer_name,$body);
		if($user->user_type=='13'){
		//$body = str_replace('to {CAM Firm}',' ',$body);
		//$body = str_replace('of {CAM Firm}',' ',$body);
		//$body = str_replace('{CAM Firm}',$customer_name,$body);
		$body = str_replace('{Customer}',$customer_name,$body);
		$body = str_replace('{CAM Firm}',$cname,$body);
		} else {
		//$body = str_replace('{CAM Firm}',$camadmin,$body);
		$body = str_replace('{Customer}',$customer_name,$body);
		$body = str_replace('{CAM Firm}',$cname,$body);
		}

		$assignuseremail='awardedjob@myvendorcenter.com';
		/*$body = "Hi ".$username."!<br/>congratulations on being awarded the job #".$rfpno." to you
		<br/><br/>At Your Service,<br/><br/>
		CAMassistant.com";*/
			//exit;
		JUtility::sendMail($mailfrom, $fromname, $assignuseremail,$mailsubject, $body, $mode = 1);

		//Sending email to manager
		$aetman ="SELECT introtext  FROM #__content where id='241' ";
		$db->setQuery( $aetman );
		$aetmanbody = $db->loadResult();
		$aetmanbody = str_replace('{Vendor Name}',$fullname,$aetmanbody) ;
		$aetmanbody = str_replace('{Vendor Company Name}','Out side vendor',$aetmanbody) ;
		$aetmanbody = str_replace('{RFP NUMBER}',$rfpno,$aetmanbody) ;
		$aetmanbody = str_replace('{Property Name}',$propertyname,$aetmanbody);
                $amount_win1 = "$".number_format($amount,2);
		$aetmanbody = str_replace('{winning Bid}',$amount_win1,$aetmanbody);
		if($user->user_type=='13'){
		$aetmanbody = str_replace('{Customer}',$customer_name,$aetmanbody);
		$aetmanbody = str_replace('{CAM Firm}',$cname,$aetmanbody);
		} else {
		$aetmanbody = str_replace('{Customer}',$customer_name,$aetmanbody);
		$aetmanbody = str_replace('{CAM Firm}',$cname,$aetmanbody);
		}
		$manageremail = $user->email;
		JUtility::sendMail($mailfrom, $fromname, $manageremail,$mailsubject, $aetmanbody, $mode = 1);
		$manageremail_support = 'support@myvendorcenter.com';
		JUtility::sendMail($mailfrom, $fromname, $manageremail_support,$mailsubject, $aetmanbody, $mode = 1);
		//Completed


		if($user->user_type == '12'){
		$link = 'index.php?option=com_camassistant&controller=rfpcenter&task=awardrfp&Itemid=123';
		}
		if($user->user_type == '13'){
		$link = 'index.php?option=com_camassistant&controller=rfpcenter&task=awardrfp&Itemid=123';
		}
	$doc =& JFactory::getDocument();
	echo '<script>parent.location="'.$link.'";</script>';
	exit;
	}
	function overview()
	{
		$user	= JFactory::getUser();
		if($user->user_type == 12)
		{
			JRequest::getVar('view','rfpcenter');
	    	parent::display();
		}
		else
		{
			JRequest::setVar('task', 'not_authorized');
			JRequest::setVar('view', 'rfpcenter');
			parent::display();
		}

	}

	  function getcommission(){
	  $c1		=0;
	  $c2		=$_REQUEST['c2'];
	  $c2 = doubleval(str_replace(",","",$c2));
if($c1 == 0 && $c2 !=0) //code to combined calculation
{
	if($c2 < 4400000)
	{
		$formula = (-0.00869*log($c2))+0.15;
		$percent = round($formula,5);
	}
	else if($c2 >= 4400000 && $c2 < 6500000)
	{
		$formula	=  (-0.00000000000000000000004033*pow($c2,3))+((0.0000000000000010088)*pow($c2,2))-(0.0000000083137)*$c2 + 0.037557;
		$percent = round($formula,5);
	}
	else if($c2 >= 6500000)
	{
		$percent = 0.015;
	}
	$comm_amnt = $percent*$c2;
	$comm_amnt = round($comm_amnt,2);
	//$comm_amnt = round($comm_amnt);
}

$comm_amnt = doubleval(str_replace(",","",$comm_amnt));
//$comm_amnt = number_format($comm_amnt,2);

echo $comm_amnt;
exit;
	  }

	function deleterfp(){

	$db = & JFactory::getDBO();
		$id = $_REQUEST['rfpid'];
		if($id){
		$query = "Delete FROM `#__cam_rfpinfo`  WHERE id in (".$id.")";
		$db->setQuery($query);
		$db->Query();
		$query = "Delete FROM `#__cam_rfpsow_linetask`  WHERE rfp_id in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_rfpsow_uploadfiles`  WHERE rfp_id in (".$id.")";
		$db->setQuery($query);
		$db->Query();
		$query = "Delete FROM `#__cam_rfpreq_info`  WHERE rfp_id in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_vendor_proposals`  WHERE rfpno in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_rfpsow_addnotes`  WHERE rfp_id in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_rfpsow_addexception`  WHERE rfp_id in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_rfpsow_uploadfiles`  WHERE rfp_id in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_vendor_availablejobs`  WHERE rfp_id in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_closedzip`  WHERE rfpid in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
        $query = "Delete FROM `#__cam_awardlist`  WHERE rfpid in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
		}
	  echo "success"; exit;

	}
	function getproposals(){
	$rfpid = $_REQUEST['rfpid'];
	$rfpname = $_REQUEST['rfpname'];
	$db = & JFactory::getDBO();
	$getprops = "SELECT U.name, U.email, U.lastname, V.company_phone,P.contact_name, V.company_name, V.phone_ext, P.proposaltype, P.proposal_total_price,P.Alt_bid, P.publish  FROM jos_users as U
LEFT JOIN jos_cam_vendor_company  as V on U.id=V.user_id
LEFT JOIN jos_cam_vendor_proposals as P on U.id=P.proposedvendorid where P.rfpno=".$rfpid." ";
	$db->setQuery( $getprops);
	$listprps = $db->loadObjectList();
	?>
	<table width="100%" border="0" style="margin:0px 0px; border:1px solid #A3A3A3; background:#F7F7F7">
    <tbody>
    <tr>
    <td>
    <ul class="addednum">
    <li><a href="index.php?option=com_camassistant&controller=rfp&task=reviewrfp&rfpid=<?php echo $rfpid;  ?>&var=view&Itemid=87">VIEW</a></li>

	<?php
	$getpublish = "SELECT publish, proposalDueDate, rfp_adminstatus, bidding, rfp_type  FROM #__cam_rfpinfo WHERE id=".$rfpid." ";
	$db->setQuery( $getpublish);
	$publish = $db->loadObject();
	$date1 = $publish->proposalDueDate;
	$date = explode("-", $date1);
	$pdate = $date[2].'-'.$date[0].'-'.$date[1];
	$date2 = date("Y-m-d");
	$diff = abs(strtotime($pdate) - strtotime($date2));
	$days = floor($diff/(60*60*24));


	if($publish->publish=='1' ){
?> <?php if ($days >1) { ?>
	<?php if ($days <=5) { ?>
   <li> <a href="#" onclick="javascript:addendum(<?php echo $rfpid;  ?>);">ADD ADDENDUM</a></li>
    <?php } else { ?>
   <li> <a href="index.php?option=com_camassistant&controller=rfp&task=editrfp&rfpid=<?php echo $rfpid; ?>&Itemid=87">ADD ADDENDUM</a></li>
    <?php } } } ?>
	<li><a class="" href="javascript:contactsupport('<?php echo $rfpname; ?>');">CONTACT SUPPORT</a></li>
<?php 	$getpropstype = "SELECT proposaltype  FROM #__cam_vendor_proposals  WHERE rfpno=".$rfpid." and (proposaltype ='Submit' || proposaltype ='resubmit') ";
	$db->setQuery( $getpropstype);
	$proposaltype = $db->loadObjectList();
	if(count($proposaltype) > 0) {
		if($publish->rfp_type != 'end') { ?>
	<li><a class="cancebidding" href="javascript:endbidding(<?php echo $rfpid; ?>);">
	<span class="hasTip2" title="Info ::END BIDDING does 2 things:
	1. Closes the RFP to vendors AND
	2. Allows you to view the proposal report that contains all submitted bids.">END BIDDING</span></a></li>
 	<?php }
	else { ?>
	<li><a class="cancebidding">
	<span class="hasTip2" title="Info ::END BIDDING does 2 things:
	1. Closes the RFP to vendors AND
	2. Allows you to view the proposal report that contains all submitted bids.">ENDED</span></a></li>
	<?php }
		 }

	else {
		if($publish->rfp_type != 'cancel') { ?>
	<li><a class="cancebidding" href="javascript:cancelbidding(<?php echo $rfpid; ?>);" ><span class="hasTip2" title="Info ::END BIDDING does 2 things:
	1. Closes the RFP to vendors AND
	2. Allows you to view the proposal report that contains all submitted bids.">CANCEL BIDDING</span></a></li>
	<?php }
	else { ?>
	<li><a class="cancebidding"><span class="hasTip2" title="Info ::END BIDDING does 2 things:
	1. Closes the RFP to vendors AND
	2. Allows you to view the proposal report that contains all submitted bids.">CANCELED</span></a></li>
	<?php }
	 }
	?>

    </ul>
    </td>
  </tr>

  <tr>
    <td>
    <table width="100%" cellspacing="0" cellpadding="0" border="0" style="padding:0px 0px; border:">
  <tbody> <tr>
    <td width="42%" height="10" bgcolor="#707070" style="color:#fff; padding-left:15px;"><strong>VENDOR</strong>
    </td><td width="21%" height="10" bgcolor="#707070" style="color:#FFF;">
    <strong>PROPOSAL PROMISED</strong></td>
     <td width="25%" height="20" bgcolor="#707070" style="padding-left:25px; color:#FFF;">
   <strong>PROPOSAL SUBMITTED</strong></td>
     <td width="15%" height="10" bgcolor="#707070" align="center" style="padding-left:10px; color:#FFF;">
  <strong>PRICE</strong></td>
  </tr>

  </tr>
  <?php if(count($listprps) > 0){ ?>
  <?php for($i=0; $i<count($listprps); $i++){ ?>
  <?php if($listprps[$i]->contact_name){ 
  $listprps[$i]->contact_name=$listprps[$i]->contact_name;
	} else { 
  $listprps[$i]->contact_name=$listprps[$i]->company_name;
	} ?>
	<tr class="table_blue_rowdotsextend">
    <td width="40%" style="text-align:left"><strong><?php echo $listprps[$i]->contact_name ; ?></strong>
<p style="padding:0px 0px;"><?php echo $listprps[$i]->name. ' '. $listprps[$i]->lastname.': ' .$listprps[$i]->company_phone;  if($listprps[$i]->phone_ext) { echo "&nbsp;-&nbsp;(" . $listprps[$i]->phone_ext . '&nbsp;)' ; }?></p>
<a href="mailto:<?php echo $listprps[$i]->email; ?>?cc=support@myvendorcenter.com"><?php echo $listprps[$i]->email; ?></a><p style="height:5px"></p></td>

	<td valign="middle" width="17%" align="center"><?php if($listprps[$i]->proposaltype)  { ?><img alt="" src="templates/camassistant_left/images/right-icon_new.png"> <?php } ?></td>

     <td valign="middle" width="22%" style="padding-left:30px;" align="center"><?php if($listprps[$i]->proposaltype == 'submit' || $listprps[$i]->proposaltype == 'Submit' || $listprps[$i]->proposaltype == 'resubmit')  { ?><img alt="" src="templates/camassistant_left/images/right-icon_new.png" /> <?php } else { ?> <img alt="" src="templates/camassistant_left/images/empty-icon.png"><?php }  ?></td>

	 <?php if($publish->bidding != 'seal'){ ?>
    <td valign="middle" width="20%" align="center"><strong><?php if(($listprps[$i]->proposaltype == 'submit' || $listprps[$i]->proposaltype == 'Submit' || $listprps[$i]->proposaltype == 'resubmit') && $listprps[$i]->publish ==1  )  { echo "$". number_format($listprps[$i]->proposal_total_price,2); } else { echo "PENDING"; }?></strong><?php if($listprps[$i]->Alt_bid == 'yes'){
	echo " (alt)";
	} ?></td> <?php } else { ?>

	<td valign="middle" width="20%" align="center"><strong><?php if($listprps[$i]->proposaltype == 'submit' || $listprps[$i]->proposaltype == 'Submit' || $listprps[$i]->proposaltype == 'resubmit' || $listprps[$i]->proposaltype == 'review'  )  { echo "<font color='gray'>SEALED</font><br><a class='breakseal' href='javascript:reopenrfp(".$rfpid.");'><span class='hasTip2' title='Info ::Breaking the seal converts a RFP from Sealed Bidding to open bidding, and allows you to see pricing BEFORE you end the bidding.'>BREAK SEAL?</span></a>"; } else { echo "PENDING"; }?></strong></td> <?php } ?>


  </tr>
  <?php }  } else {?>
  <tr class="table_blue_rowdotsextend"><td colspan="4"><p style="font-size: 13px; margin-bottom: 10px; text-align: center;">No Vendors have committed to providing a proposal for this project</p></td></tr>
  <?php } ?>
  <?php ?>
</tbody></table>

    </td>
  </tr>
<tr valign="middle" height="55">
    <td>
<p style="float:left; padding-bottom:5px;"><a class="review_submit_new" href="javascript:invitevendor();"><img class="review_submit_new" alt="" src="templates/camassistant_left/images/intvite-friend.png" /></a></p>
    <?php /*?><p style="float:right; padding-bottom:5px;"><a class="review_submit" href="javascript:contactsupport('<?php echo $rfpname; ?>');"><img class="review_submit" alt="" src="templates/camassistant_left/images/contact-support.png" /></a></p><?php */?>
    </td>
  </tr>
  <tr valign="middle" height="60">
    <td><p style="padding-top:3px; padding-left:5px; padding-right:5px; color:#333335;"><strong>CURRENT PROJECT STATUS: </strong><span style="color:#487be7;">
	<?php
	if($publish->rfp_adminstatus == ''){
	echo "Currently being reviewed by qualified, pre-screened Vendors";
	} else{
	echo $publish->rfp_adminstatus;
	}
	 ?>
	</span></p></td>
  </tr>
</tbody></table>
	<?php  exit;
	 }

	function sendrequest(){
	$body = JRequest::getVar('supportbody','');
	$subject = JRequest::getVar('subject','');
	$user=JFactory::getUser();
	$fromname = $user->name. ' ' . $user->lastname;
	$mailsubject = 'Need Support for '.$subject;
	//$assignuseremail = 'support@myvendorcenter.com' ;
	$mailfrom = $user->email ;
	$assignuseremail = 'rize.cama@gmail.com' ;
	$res = JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
		if($res){
		$msg="Your email have been sent successfully to support team.";
		$link='index.php?option=com_camassistant&controller=rfpcenter&task=submitedrfp&Itemid=87';
		$this->setRedirect( $link,$msg );
		}
	}

	function cancelrfp(){
           // echo 'anand'; exit;
	$db = & JFactory::getDBO();
	$rfpid = JRequest::getVar('rfpid','');
	$var = JRequest::getVar('var','');
    $date = date("m-d-Y H:i");
	if($var == 'end'){
	$rfptype = 'closed';
	$retype = 'end' ;
	$msg="Your RFP has been ended successfully.";
	}
	else{
	$rfptype = 'Unawarded';
	$retype = 'cancel' ;
	$msg="Your RFP has been cancelled successfully.";
	}
	 
	$query_updatedc = "UPDATE #__cam_rfpinfo SET rfp_type ='".$rfptype."', closedfrom ='".$retype."',publish ='1',biddingcloseddate='".$date."' WHERE id=".$rfpid;
	$db->setQuery( $query_updatedc);
	$update=$db->query();
	if($update){
		$link='index.php?option=com_camassistant&controller=rfpcenter&task=submitedrfp&Itemid=87';
		$this->setRedirect( $link,$msg );
		}
	}

	function reopenrfp(){
	$db = & JFactory::getDBO();
	$rfpid = JRequest::getVar('rfpid','');
	$query_updatedc = "UPDATE #__cam_rfpinfo SET bidding ='open' WHERE id=".$rfpid;
	$db->setQuery( $query_updatedc);
	$update=$db->query();
	if($update){
		$msg = "RFP reopend successfully.";
		$link='index.php?option=com_camassistant&controller=rfpcenter&task=submitedrfp&Itemid=87';
		$this->setRedirect( $link,$msg );
		}
	}

	function getdetails(){
		$db= JFactory::getDBO();
		$details = $db->setQuery("SELECT u.company_phone, v.name, v.lastname, v.email  FROM #__cam_vendor_company as u, #__users as v where u.user_id=".$_REQUEST['id']." and u.user_id=v.id ");
		$details = $db->loadObject();
		$final = $details->name.' '.$details->lastname.'|'.$details->email.'|'.$details->company_phone;
		echo $final; exit;
		}

		function sendinvitation(){
		$db= JFactory::getDBO();
		$model = $this->getModel('rfpcenter');
		$data['rfpid'] = JRequest::getVar('rfpid','');
		$data['companyname'] = JRequest::getVar('companyname','');
		$data['contactname'] = JRequest::getVar('contactname','');
		$data['phone'] = JRequest::getVar('phone','');
		$data['email'] = JRequest::getVar('email','');
		$data['notes'] = JRequest::getVar('notes','');
		$data['date'] = date('Y-m-d H:i');

		$query_rejectedemail ="SELECT introtext  FROM #__content where id='242' ";
		$db->setQuery( $query_rejectedemail );
		$body = $db->loadResult();
		$user=JFactory::getUser();
		$body = str_replace('{companyname}',$data['companyname'],$body) ;
		$body = str_replace('{contactname}',$data['contactname'],$body) ;
		$body = str_replace('{phone}',$data['phone'],$body);
		$body = str_replace('{email}',$data['email'],$body);
		$body = str_replace('{notes}',$data['notes'],$body);
		$body = str_replace('{managername}',$user->name.' '. $user->lastname,$body);

		$mailfrom = $user->email;
		$fromname = $user->name.' '. $user->lastname;
		//$assignuseremail = 'rize.cama@gmail.com';
		$assignuseremail = 'support@myvendorcenter.com';
		$mailsubject = 'Vendor Invitation';
		JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);

	 	if($model->store_invitation($data)) {
		$msg = "Invitation sent successfully.";
		$link='index.php?option=com_camassistant&controller=rfpcenter&task=submitedrfp&Itemid=87';
		$this->setRedirect( $link,$msg );
		}


		}


		function getclosedproposals(){
	$rfpid = $_REQUEST['rfpid'];
	$rfpname = $_REQUEST['rfpname'];
	$db = & JFactory::getDBO();
	$getprops = "SELECT U.name, U.email, U.lastname, V.company_phone,P.contact_name, V.company_name, V.phone_ext, P.proposaltype, P.Alt_bid, P.proposal_total_price  FROM jos_users as U
LEFT JOIN jos_cam_vendor_company  as V on U.id=V.user_id
LEFT JOIN jos_cam_vendor_proposals as P on U.id=P.proposedvendorid where (P.proposaltype='Submit' or  P.proposaltype='resubmit') and P.rfpno=".$rfpid." ";
	$db->setQuery( $getprops);
	$listprps = $db->loadObjectList();

	//To get the unsubmitted proposals
	$getprops_alt = "SELECT U.name, U.email, U.lastname,P.contact_name, V.company_phone, V.company_name, V.phone_ext, P.proposaltype, P.Alt_bid, P.proposal_total_price  FROM jos_users as U
LEFT JOIN jos_cam_vendor_company  as V on U.id=V.user_id
LEFT JOIN jos_cam_vendor_proposals as P on U.id=P.proposedvendorid where (P.proposaltype!='Submit' and P.proposaltype!='resubmit') and P.rfpno=".$rfpid." ";
	$db->setQuery( $getprops_alt);
	$listunprops = $db->loadObjectList();
	//Completed
    $getpublish = "SELECT rfp_adminstatus FROM #__cam_rfpinfo WHERE id=".$rfpid." ";
	$db->setQuery( $getpublish);
	$adminstatus = $db->loadResult();
	?>
	<table width="100%" border="0" style="margin:0px 0px; border:1px solid #A3A3A3; background:#F7F7F7">
    <tbody>
    <tr>
    <td>
    <ul class="addednumclosed">
     <?php    $count=count($listprps); ?>
    <li><a href='javascript:popup_proposal_summary34("<?PHP echo $rfpid; ?>","<?PHP echo $count; ?>");'>DOWNLOAD</a></li>
	<li><a href="javascript:popup_proposal_summary1(<?php echo $rfpid; ?>);">VIEW PROPOSALS</a></li>
	<li><a href="#" onclick="draft(<?php echo $rfpid; ?>);">COPY AS NEW</a></li>
	<li><a href="#" onclick="rebid(<?php echo $rfpid; ?>);" >MODIFY & RESUBMIT</a></li>
	<li><a class="" href="javascript:contactsupport('<?php echo $rfpname; ?>');">CONTACT SUPPORT</a></li>


    </ul>
    </td>
  </tr>

  <tr>
    <td>
    <table width="100%" cellspacing="0" cellpadding="0" border="0" style="padding:0px 0px; border:">
  <tbody> <?php if($count > 0 || count($listunprops) > 0){ ?><tr>
    <td width="42%" height="10" bgcolor="#707070" style="color:#fff; padding-left:15px;"><strong>VENDOR INFORMATION</strong>
    </td>

     <td width="15%" height="10" bgcolor="#707070" align="left" style="padding-left:86px; color:#FFF;">
  <strong>PRICE</strong></td>
  </tr><?php } ?>
  </tr>  <?php for($i=0; $i< $count; $i++){ ?>
   <?php if($listprps[$i]->contact_name){ 
  $listprps[$i]->contact_name=$listprps[$i]->contact_name;
	} else { 
  $listprps[$i]->contact_name=$listprps[$i]->company_name;
	} ?>
	<tr class="table_blue_rowdotsextend">
    <td width="40%" style="text-align:left"><strong><?php echo $listprps[$i]->contact_name ; ?></strong>
<p style="padding:0px 0px;"><?php echo $listprps[$i]->name. ' '. $listprps[$i]->lastname.': ' .$listprps[$i]->company_phone;  if($listprps[$i]->phone_ext) { echo "&nbsp;-&nbsp;(" . $listprps[$i]->phone_ext . ')' ; }?></p>
<a href="mailto:<?php echo $listprps[$i]->email; ?>?cc=support@myvendorcenter.com"><?php echo $listprps[$i]->email; ?></a><p style="height:5px"></p></td>


    <td valign="middle" width="20%" align="center"><strong><?php  echo "$". number_format($listprps[$i]->proposal_total_price,2);
	if($listprps[$i]->Alt_bid == 'yes'){
	echo " (alt)";
	}
	 ?></strong></td>
  </tr>
  <?php } ?>
  <?php for($i=0; $i<count($listunprops); $i++){ ?>
   <?php if($listunprops[$i]->contact_name){ 
  $listunprops[$i]->contact_name=$listunprops[$i]->contact_name;
	} else { 
  $listunprops[$i]->contact_name=$listunprops[$i]->company_name;
	} ?>
	<tr class="table_blue_rowdotsextend">
    <td width="40%" style="text-align:left"><strong><?php echo $listunprops[$i]->contact_name ; ?></strong>
<p style="padding:0px 0px;"><?php echo $listunprops[$i]->name. ' '. $listunprops[$i]->lastname.': ' .$listunprops[$i]->company_phone;  if($listunprops[$i]->phone_ext) { echo "&nbsp;-&nbsp;(" . $listunprops[$i]->phone_ext . ')' ; }?></p>
<a href="mailto:<?php echo $listunprops[$i]->email; ?>?cc=support@myvendorcenter.com"><?php echo $listunprops[$i]->email; ?></a><p style="height:5px"></p></td>
<td valign="middle" width="20%" align="center"><strong><font color="red">NO BID</font></strong></td>
  </tr>
  <?php } ?>
</tbody></table>

    </td>
  </tr>




<tr valign="middle" height="55">
    <td>
	<p style="float:left; padding-bottom:5px;"><a href="#" style=" color: #7AB800;font-size: 12px;font-weight: bold; margin-left:1px;text-decoration: none;" onclick="openpopup(<?php echo $rfpid; ?>);" ><img class="review_submit_new" alt="" src="templates/camassistant_left/images/award-job.gif" /></a></p>
    </td>
  </tr>

</tbody></table>
	<?php  exit;
	 }

		function getawardedproposals(){
	$rfpid = $_REQUEST['rfpid'];
	$rfpname = $_REQUEST['rfpname'];
	$type = $_REQUEST['type'];
	$from = $_REQUEST['from'];
	if($from != 'yes') {
	$condition = '(P.proposaltype="Awarded" || P.proposaltype="Unawarded")';
	} else {
	//$condition = 'P.proposaltype="Awarded"';
	$condition = '(P.proposaltype="Awarded" || P.proposaltype="Unawarded")';
	}
	$db = & JFactory::getDBO();
	$getprops = "SELECT U.name, U.email, U.lastname, V.company_phone,P.contact_name, V.company_name, V.phone_ext,P.Alt_bid, P.proposaltype, P.proposal_total_price  FROM jos_users as U
LEFT JOIN jos_cam_vendor_company  as V on U.id=V.user_id
LEFT JOIN jos_cam_vendor_proposals as P on U.id=P.proposedvendorid where ".$condition." and P.rfpno=".$rfpid." ";
	$db->setQuery( $getprops);
	$listprps = $db->loadObjectList();
         $getpublish = "SELECT rfp_adminstatus FROM #__cam_rfpinfo WHERE id=".$rfpid." ";
	$db->setQuery( $getpublish);
	$adminstatus = $db->loadResult();
	?>
	<table width="100%" border="0" style="margin:0px 0px; border:1px solid #A3A3A3; background:#F7F7F7">
    <tbody>
    <tr>
    <td>
    <ul class="addednumclosed">
       <?php $count2= count($listprps); ?>
	<?php if($from != 'yes') {?>
	<?php /*?><li><a href="javascript:getapplepopup(<?php echo $rfpid; ?>);">RATE VENDOR</a></li><?php */?>
	<?php } ?>
	<li><a href="javascript:popup_proposal_summary2(<?php echo $rfpid; ?>);">VIEW PROPOSALS</a></li>
	<li><a href='javascript:popup_proposal_summary36("<?PHP echo $rfpid; ?>","<?PHP echo $count2; ?>")'>DOWNLOAD PROPOSALS</a></li>
	<li><a href="#" onclick="draft(<?php echo $rfpid; ?>);">COPY AS NEW</a></li>
    </ul>
    </td>
  </tr>

  <tr>
    <td>
    <table width="100%" cellspacing="0" cellpadding="0" border="0" style="padding:0px 0px; border:">
  <tbody> <?php if($count2 > 0){ ?><tr>
    <td width="42%" height="10" bgcolor="#707070" style="color:#fff; padding-left:15px;"><strong>VENDOR INFORMATION</strong></td>
	<td width="20%" height="10" bgcolor="#707070" style="color:#fff; padding-left:27px;"><strong>AWARD DATE</strong></td>
	<td width="20%" height="10" bgcolor="#707070" style="color:#fff; padding-left:20px;"><strong>AWARD STATUS</strong></td>
    <td width="15%" height="10" bgcolor="#707070" align="center" style="color:#FFF;"><strong>PRICE</strong></td>
  	</tr><?php } ?>
	 <?php
	$getdate = "SELECT awardeddate,unawardeddate,apple,apple_publish from #__cam_rfpinfo where id=".$rfpid." ";
	$db->setQuery( $getdate);
	$deta = $db->loadObject();
        $outsidevendor = "SELECT awarded_vendor,amount,award_date from #__cam_outsidevendor where rfpid=".$rfpid." ";
	$db->setQuery( $outsidevendor);
	$outside_vendor = $db->loadObject();
	if($type == 'unaward'){
	$awardeddate = $deta->unawardeddate;
	}
	else{
	$awardeddate = $deta->awardeddate;
	}
	?>
  </tr>  <?php for($i=0; $i<count($listprps); $i++){ ?>
  <?php if($listprps[$i]->contact_name){ 
  $listprps[$i]->contact_name=$listprps[$i]->contact_name;
	} else { 
  $listprps[$i]->contact_name=$listprps[$i]->company_name;
	} ?>
	<tr class="table_blue_rowdotsextend">
    <td width="40%" style="text-align:left"><strong><?php echo $listprps[$i]->contact_name ; ?></strong>
<p style="padding:0px 0px;"><?php echo $listprps[$i]->name. ' '. $listprps[$i]->lastname.': ' .$listprps[$i]->company_phone;  if($listprps[$i]->phone_ext) { echo "&nbsp;-&nbsp;(" . $listprps[$i]->phone_ext . ')' ; }?></p>
<a href="mailto:<?php echo $listprps[$i]->email; ?>?cc=support@myvendorcenter.com"><?php echo $listprps[$i]->email; ?></a><p style="height:5px"></p></td>

    <td valign="middle" width="20%" align="center"><strong>	<?php echo $awardeddate ; ?></strong></td>

   <td valign="middle" width="20%" align="center"><strong><?php if($listprps[$i]->proposaltype == 'Awarded') {
   $award_company = $listprps[$i]->company_name ;
   echo "<font color='green'>AWARDED</font>"; } else { echo "<font color='red'>UNAWARDED</font>"; } ?> </strong></td>
    <td valign="middle" width="20%" align="center"><strong><?php
	if($listprps[$i]->proposaltype == 'Awarded') { echo "<font color='green'>$". number_format($listprps[$i]->proposal_total_price,2).'</font>';  }
	else if($listprps[$i]->proposaltype == 'Unawarded') {  echo "<font color='red'>$". number_format($listprps[$i]->proposal_total_price,2).'</font>'; }
	else{ echo "<font color='red'>NO BID</font>"; }
	?>
	</strong><?php if($listprps[$i]->Alt_bid == 'yes'){
	echo " (alt)";
	} ?></td>


  </tr>
  <?php } ?><?php if($outside_vendor){ ?>
  <tr class="table_blue_rowdotsextend">
    <td width="40%" style="text-align:left">
<p style="padding:0px 0px;"><strong>Outside Vendor</strong><br/><?php echo $outside_vendor->awarded_vendor; ?></p>
</p></td>

    <td valign="middle" width="20%" align="center"><strong><?php echo $outside_vendor->award_date; ?></strong></td>

   <td valign="middle" width="20%" align="center"><strong><font color='green'>AWARDED</font></strong></td>
    <td valign="middle" width="20%" align="center"><strong><font color='green'>$<?php echo number_format($outside_vendor->amount,2); ?></strong></td>

  </tr>
  <?php } ?>
<?php   if($from == 'yes') { ?>
  <tr class="table_blue_rowdotsextendlast"><td valign="middle" colspan="5" align="center"><br /><strong>Your Rating for:</strong> <?php echo $award_company; ?><br />
	<?php if($deta->apple_publish == 0 && !$outside_vendor){ ?><strong><span id="apple<?php echo $deta->apple ; ?>">&nbsp;</span><?php } else if($outside_vendor){ echo "<strong><font color='red'>Awarded for outside vendor</font></strong>";  } else { echo "<strong><font color='red'>REMOVED BY ADMIN</font></strong>"; } ?></strong></td></tr>
	<tr height="20"></tr>
	<?php } ?>
</tbody></table>

    </td>
  </tr>

	<?php if($from != 'yes' && !$outside_vendor) {?>
    <?php /*?><p style="float:right; padding-bottom:5px;"><a class="review_submit_new" href="javascript:contactsupport('<?php echo $rfpname; ?>');"><img class="review_submit_new" alt="" src="templates/camassistant_left/images/contact-support.png" /></a></p>
	<?php } else { ?><?php */?>
	<tr valign="middle" height="55">
    <td>
	<p style="float:left; padding-bottom:5px;"><a class="review_submit_new" href="javascript:getapplepopup('<?php echo $rfpid; ?>');"><img class="review_submit_new" alt="" src="templates/camassistant_left/images/rate-vendor.png" /></a></p>
	 </td>
  </tr>
	<?php } ?>


</tbody></table>
	<?php  exit;
	 }
         function getunawardedproposals(){
	$rfpid = $_REQUEST['rfpid'];
	$rfpname = $_REQUEST['rfpname'];
	$type = $_REQUEST['type'];
	$from = $_REQUEST['from'];
	if($from != 'yes') {
	$condition = '(P.proposaltype="Unawarded" || P.proposaltype="Unawarded")';
	} else {
	$condition = 'P.proposaltype="Unawarded"';
	}
	$db = & JFactory::getDBO();
	$getprops = "SELECT U.name, U.email, U.lastname,P.contact_name, V.company_phone,P.Alt_bid, V.company_name, V.phone_ext, P.proposaltype, P.proposal_total_price  FROM jos_users as U
LEFT JOIN jos_cam_vendor_company  as V on U.id=V.user_id
LEFT JOIN jos_cam_vendor_proposals as P on U.id=P.proposedvendorid where ".$condition." and P.rfpno=".$rfpid." ";
	$db->setQuery( $getprops);
	$listprps = $db->loadObjectList();

             $getpublish = "SELECT rfp_adminstatus FROM #__cam_rfpinfo WHERE id=".$rfpid." ";
	$db->setQuery( $getpublish);
	$adminstatus = $db->loadResult();
	?>
	<table width="100%" border="0" style="margin:0px 0px; border:1px solid #A3A3A3; background:#F7F7F7">
    <tbody>
    <tr>
    <td>
    <ul class="addednumclosed">
        <?php $count3= count($listprps); ?>
	<?php if($from != 'yes') {?>
	<?php /*?><li><a href="javascript:getapplepopup(<?php echo $rfpid; ?>);">RATE VENDOR</a></li><?php */?>
	<?php } ?>
	<li><a href="javascript:popup_proposal_summary1(<?php echo $rfpid; ?>);">VIEW PROPOSALS</a></li>
		<li><a href='javascript:popup_proposal_summary34("<?PHP echo $rfpid; ?>","<?PHP echo $count3; ?>")'>DOWNLOAD PROPOSALS</a></li>
	<li><a href="#" onclick="draft(<?php echo $rfpid; ?>);">COPY AS NEW</a></li>
	<li><a href="#" onclick="rebid(<?php echo $rfpid; ?>);" >MODIFY & RESUBMIT</a></li>
    </ul>
    </td>
  </tr>

  <tr>
    <td>
    <table width="100%" cellspacing="0" cellpadding="0" border="0" style="padding:0px 0px; border:">
  <tbody> <?php if(count($listprps) > 0){ ?><tr>
    <td width="42%" height="10" bgcolor="#707070" style="color:#fff; padding-left:15px;"><strong>VENDOR INFORMATION</strong></td>
	<?php if($from != 'yes') {?>
	<!--<td width="20%" height="10" bgcolor="#707070" style="color:#fff; padding-left:27px;"><strong>AWARD DATE</strong></td>-->
	<td width="20%" height="10" bgcolor="#707070" style="color:#fff; padding-left:32px;"><strong>AWARD STATUS</strong></td>
    <td width="15%" height="10" bgcolor="#707070" align="center" style="color:#FFF;"><strong>PRICE</strong></td>
	<?php } else { ?>
	<td width="20%" height="10" bgcolor="#707070" align="center" style="color:#FFF;"><strong>YOUR RATING</strong></td>
	<?php } ?>
  	</tr><?php } ?>
	 <?php
	$getdate = "SELECT awardeddate,unawardeddate,apple,apple_publish from #__cam_rfpinfo where id=".$rfpid." ";
	$db->setQuery( $getdate);
	$deta = $db->loadObject();
        $outsidevendor = "SELECT awarded_vendor,amount,award_date from #__cam_outsidevendor where rfpid=".$rfpid." ";
	$db->setQuery( $outsidevendor);
	$outside_vendor = $db->loadObject();
	if($type == 'unaward'){
	$awardeddate = $deta->unawardeddate;
	}
	else{
	$awardeddate = $deta->awardeddate;
	}
	?>
  </tr>  <?php for($i=0; $i<count($listprps); $i++){ ?>
    <?php if($listprps[$i]->contact_name){ 
  $listprps[$i]->contact_name=$listprps[$i]->contact_name;
	} else { 
  $listprps[$i]->contact_name=$listprps[$i]->company_name;
	} ?>
	<tr class="table_blue_rowdotsextend">
    <td width="40%" style="text-align:left"><strong><?php echo $listprps[$i]->contact_name ; ?></strong>
<p style="padding:0px 0px;"><?php echo $listprps[$i]->name. ' '. $listprps[$i]->lastname.': ' .$listprps[$i]->company_phone;  if($listprps[$i]->phone_ext) { echo "&nbsp;-&nbsp;(" . $listprps[$i]->phone_ext . ')' ; }?></p>
<a href="mailto:<?php echo $listprps[$i]->email; ?>?cc=support@myvendorcenter.com"><?php echo $listprps[$i]->email; ?></a><p style="height:5px"></p></td>
	<?php if($from != 'yes') {?>
   <!-- <td valign="middle" width="20%" align="center"><strong>	<?php echo $awardeddate ; ?></strong></td> -->

   <td valign="middle" width="20%" align="center"><strong><?php if($listprps[$i]->proposaltype == 'Awarded') { echo "<font color='green'>AWARDED</font>"; } else { echo "<font color='red'>UNAWARDED</font>"; } ?> </strong></td>
    <td valign="middle" width="20%" align="center"><strong><?php  if($listprps[$i]->proposaltype == 'Awarded') { echo "<font color='green'>$". number_format($listprps[$i]->proposal_total_price,2).'</font>';  } else {  echo "<font color='red'>$". number_format($listprps[$i]->proposal_total_price,2).'</font>'; }?></strong><?php if($listprps[$i]->Alt_bid == 'yes'){
	echo " (alt)";
	} ?></td>
	<?php } else { ?>
	<td valign="middle" width="24%" align="center">
	<?php if($deta->apple_publish == 0){ ?><strong><span id="apple<?php echo $deta->apple ; ?>">&nbsp;</span><?php } ?></strong></td>
	<?php } ?>
  </tr>
  <?php } ?><?php if($outside_vendor){ ?>
  <tr class="table_blue_rowdotsextend">
    <td width="40%" style="text-align:left">
<p style="padding:0px 0px;"><strong>Outside Vendor</strong><br/><?php echo $outside_vendor->awarded_vendor; ?></p>
</p></td>

   <td valign="middle" width="20%" align="center"><strong><font color='green'>AWARDED</font></strong></td>
    <td valign="middle" width="20%" align="center"><strong><font color='red'>$<?php echo number_format($outside_vendor->amount,2); ?></strong></td>

  </tr>
  <?php } ?>
</tbody></table>

    </td>
  </tr>

	<?php if($from != 'yes') {?>
    <?php /*?><p style="float:right; padding-bottom:5px;"><a class="review_submit_new" href="javascript:contactsupport('<?php echo $rfpname; ?>');"><img class="review_submit_new" alt="" src="templates/camassistant_left/images/contact-support.png" /></a></p>
	<?php } else { ?>
	<tr valign="middle" height="55">
    <td>
	<p style="float:left; padding-bottom:5px;"><a class="review_submit_new" href="javascript:getapplepopup('<?php echo $rfpid; ?>');"><img class="review_submit_new" alt="" src="templates/camassistant_left/images/rate-vendor.png" /></a></p>
	 </td>
  </tr><?php */?>
	<?php } ?>


</tbody></table>
	<?php  exit;
	 }
	 //save apple rating
	 function saveapples(){
	 $db = & JFactory::getDBO();
	 $rfpid = JRequest::getVar('rfpid','');
	 $apple = JRequest::getVar('applerating','');
	 $query_updatedc = "UPDATE #__cam_rfpinfo SET apple ='".$apple."' WHERE id=".$rfpid;
	 $db->setQuery( $query_updatedc);
	 $update=$db->query();
	 if($update){
		$msg = "Vendor rating updated successfully.";
		$link='index.php?option=com_camassistant&controller=rfpcenter&task=awardrfp&Itemid=123';
		$this->setRedirect( $link,$msg );
		}
	  }

	 function checkapples(){
	 	$db = & JFactory::getDBO();
		$rfpid = JRequest::getVar('rfpid','');
		$getdate = "SELECT apple from #__cam_rfpinfo where id=".$rfpid." ";
		$db->setQuery( $getdate);
		$apples = $db->loadResult();
		if($apples){
		echo "given";
		}
		else{
		echo "Not given";
		}
		exit;
	 }
}
?>
