<?php
/**
 * @version		1.0.0 cam assistant $
 * @package		cam_assistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

defined('_JEXEC') or die('Restricted access');

jimport( 'joomla.application.component.model' );
class camassistantModelVinvitations extends Jmodel
{
	function __construct(){
		parent::__construct();

	}
	



}
class vinvitationsModelVinvitations extends Jmodel
{
function __construct()
	{
		parent::__construct();
 
}
//To send the manager invitation to vendor
function getbody(){
		$db= JFactory::getDBO();
		$user=JFactory::getUser();
		//To get the manager company
		$companyname ="SELECT comp_name  FROM #__cam_customer_companyinfo where cust_id=".$user->id." ";
		$db->setQuery( $companyname );
		$c_name = $db->loadResult();
		//Completed
		$query_rejectedemail ="SELECT introtext  FROM #__content where id='257' ";
		$db->setQuery( $query_rejectedemail );
		$body = $db->loadResult();
		$body = str_replace('[Manager Name]',$user->name.' '.$user->lastname,$body);
		$body = str_replace('[Management Firm Name]',$c_name,$body);
		return $body;
}
//Completed
function getsavedetails($data){
	$db= JFactory::getDBO();
	$user=JFactory::getUser();
	$date = date('Y-m-d H:i');
	$query = "insert into #__cam_newvendorinvitations (`id`, `managerid`, `vendoremailid`, `vendorid`, `date`, `articletype`) VALUES ('','".$user->id."','".$data['vendoremailid']."','','".$date."','')";
	$db->setQuery($query);
	$save_data = $db->query();
	return $save_data ;
	}
	//Function to get the invited vendors list
	function getprevious()
	{
	$db =& JFactory::getDBO();
	$user=JFactory::getUser();
	
		$sort = JRequest::getVar('sort','');
		if($sort == 'asc')
			$sorting = 'order by vendoremailid ASC';
		else if($sort == 'desc' )
			$sorting = 'order by vendoremailid DESC';
		else
			$sorting = 'order by date DESC';
		
	 $query  = "SELECT id, vendoremailid, date FROM  #__cam_newvendorinvitations  where managerid = ". $user->id ." and publish='0' GROUP BY vendoremailid ".$sorting." " ; 
	$db->setQuery($query);
	$invitations = $db->loadObjectList(); 
	
		for( $i=0; $i<count($invitations); $i++ ){
			$querys  = "SELECT id FROM  #__users  where email = '". $invitations[$i]->vendoremailid ."' or ccemail LIKE '%".$invitations[$i]->vendoremailid."%' " ;
				$db->setQuery($querys);
				$exid = $db->loadResult(); 
				if($exid){
				$invitations[$i]->status = 'accepted';
				}
				else{
					$invitations[$i]->status = 'notaccepted';
					/*$query_cc  = "SELECT ccemail FROM  #__users  where user_type='11' " ; 
					$db->setQuery($query_cc);
					$ccmails = $db->loadObjectList(); 
					for( $d=0; $d<count($ccmails); $d++ ){
					$cclist = explode(';',$ccmails[$d]->ccemail);
					for($c=0; $c<=count($cclist); $c++){
						$listcc = $cclist[$c];
							if($listcc){
								if( $listcc ==  $invitations[$i]->vendoremailid )
									$invitations[$i]->status = 'accepted';
							}
						}
					}*/	
				}
		}
		
	return $invitations;
	}
	//COmpleted
}
?>