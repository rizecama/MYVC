<?php
/**
 * @version		1.0.0 cam assistant $
 * @package		cam_assistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport( 'joomla.application.component.model' );

class propertymanagerModelPropertymanager extends Jmodel
{
	/*function __construct(){
		parent::__construct();
	}*/
	//
	function __construct()
	{
		parent::__construct();
		global $mainframe, $context;
		//initialize class property
	  	//	$this->_table_prefix = '#__sbf_user_campaign';
		//DEVNOTE: Get the pagination request variables
		$limit = $mainframe->getUserStateFromRequest( $context.'limit', 'limit', $mainframe->getCfg('list_limit'), 0);
		$limitstart = JRequest::getVar('limitstart', 0, '', 'int');
		if($limit==0 && $limitstart>0 && $limitstart!=$lmit)
		{
			$limitstart=0;
			$limit=0;
		} else {
			$limit=0;
		}
		$this->setState('limit', $limit);
		$this->setState('limitstart', $limitstart);
	}

	//To get the Email msgs about camfirmadmin company to display in the form(PRASAD 31 JAN 2011)
	function getCamfirmadmin_emailsInfo($comp_id)
	{
		$db = JFactory::getDBO();
		$sql = "SELECT * FROM #__cam_camfirmadmin_vendormails  WHERE company_id=".$comp_id;
		$db->setQuery( $sql);
		$details = $db->loadObjectList();

		return $details;
	}
	//
	function getCAMFIRM_Viewall($comp_id)
	{
		$task = JRequest::getVar("task",'');
		//DEVNOTE: Lets load the content if it doesn't already exist
		if (empty($this->_data))
		{
			if($task=='manage_properties'){
			$query = $this->_buildQueryPManagers_All($comp_id);
			$this->_data = $this->_getList($query, $this->getState('limitstart'), $this->getState('limit'));
			//echo '<pre>'; print_r($this->_data);
			} else if($task=='customer_edit_form') {
			$query = $this->_buildQueryPrperties_All($comp_id);
			$this->_data = $this->_getList($query);
			}
		}

		return $this->_data;
	}
	//
	function _buildQueryPManagers_All($comp_id)
	{

		global $mainframe;
		$sortby = JRequest::getVar("sortby",'');
		if($sortby==1)
		$sortname = "ORDER BY u.lastname ASC";
		else if($sortby==2)
		$sortname = "ORDER BY u.name ASC";
		else if($sortby==3)
		$sortname = "ORDER BY u.phone ASC";
		else if($sortby==4)
		$sortname = "ORDER BY u.extension ASC";
		else if($sortby==5)
		$sortname = "ORDER BY u.email ASC";
		else {
			$sort = JRequest::getVar('sort','');
			if($sort == 'asc' || $sort == ''){
				$sortname = 'order by u.name ASC';
			}
			else{
				$sortname = 'order by u.name DESC';
			}
		}
		$user = JFactory::getUser();
		 $db = JFactory::getDBO();
		 
		
	
	
		if($user->user_type == 13 && $user->accounttype == 'master'){
                            
              $sql1 = "SELECT firmid from #__cam_masteraccounts where masterid=".$user->id." ";
			$db->Setquery($sql1);
			$subfirms = $db->loadObjectlist();
			//echo "<pre>"; print_r($subfirms); echo "</pre>";
	if($subfirms)
		{
			for( $a=0; $a<count($subfirms); $a++ )
				{
					$firmid1[] = $subfirms[$a]->firmid;
					$sql = "SELECT id from #__cam_camfirminfo where cust_id=".$subfirms[$a]->firmid." ";
					$db->Setquery($sql);
					$companyid[] = $db->loadResult();
											
				}
				//echo "<pre>"; print_r($firmid1); echo "</pre>";	
        }
			
	if($companyid)
		{
         	for( $c=0; $c<count($companyid); $c++ )
				{
					$sql_cid = "SELECT cust_id from #__cam_customer_companyinfo where comp_id=".$companyid[$c]." ";
					$db->Setquery($sql_cid);
					$managerids = $db->loadObjectList();
						if($managerids) {
							foreach( $managerids as $last_mans){
								$total_mangrs[] = $last_mans->cust_id ;
							}
						}
               }
        }
		
	if($firmid1 && $total_mangrs )
		{
            $total_mangrs = array_merge($total_mangrs,$firmid1); 
        }
	if($firmid1){
            for( $d=0; $d<count($firmid1); $d++ ){
        $query = "SELECT id FROM #__cam_camfirminfo WHERE cust_id=".$firmid1[$d];
	$db->setQuery($query);
	$comp_id = $db->loadResult();
	$userid=array($user->id);
	$query_mans = "SELECT cust_id from #__cam_customer_companyinfo where comp_id = ".$comp_id." ";
	$db->setQuery($query_mans);
        $Managers_list1 = $db->loadObjectList();
                if($Managers_list1) {
                        foreach( $Managers_list1 as $Managers_list2){
                                $Managers_list[] = $Managers_list2->cust_id ;
                        }
                }
            }
        if($Managers_list){
        $total_mangrs = array_merge($Managers_list,$firmid1);
            } else {
         $total_mangrs = $firmid1;        
            }
        }			
        $userid=array($user->id);
        if($total_mangrs){
        $total_mangrs = array_merge($userid,$total_mangrs); 
		}
		else{
		$total_mangrs[] = $user->id; 
		}
		$totalcust_id1_arr = implode($total_mangrs,',');
		$firmsarr = $totalcust_id1_arr;
               
               // echo $firmsarr;
		//$sql_firms = "SELECT u.user_type,u.id,u.lastname,u.name,u.email,u.registerDate,u.lastvisitDate,u.dmanager,u.phone,u.username,u.flag,u.suspend,u.password,u.block as published,c.camfirm_license_no,c.comp_id ,c.comp_name,c.tax_id,c.status,c.cust_id,u.accounttype FROM #__users as u LEFT JOIN #__cam_customer_companyinfo as c ON c.cust_id= u.id WHERE u.id=c.cust_id AND u.user_type!=11 AND u.id IN(".$firmsarr.") group by u.id ORDER BY u.registerDate desc";
              
	  $sql = "SELECT c.comp_id,c.cust_id,u.accounttype,u.user_type,c.comp_name,u.id,u.salutation,u.name,u.email,u.phone,u.extension,u.lastname,u.id,u.dmanager,u.accounttype,u.username,(SELECT count(p.id) FROM #__cam_property p WHERE  p.property_manager_id = u.id AND (p.company_id=".$comp_id." OR p.property_manager_id IN(".$firmsarr."))) AS cnt FROM #__cam_customer_companyinfo c LEFT JOIN  #__users u ON c.cust_id=u.id and u.id !='' WHERE u.block=0 and c.cust_id IN(".$firmsarr.")  ".$sortname." ";
              
   //    echo $sql ="SELECT u.user_type,u.id,u.lastname,u.name,u.email,u.registerDate,u.lastvisitDate,u.dmanager,u.phone,u.username,u.flag,u.suspend,u.password,u.block as published,c.camfirm_license_no,c.comp_id ,c.comp_name,c.tax_id,c.status,c.cust_id,u.accounttype FROM #__users as u LEFT JOIN #__cam_customer_companyinfo as c ON c.cust_id= u.id WHERE u.id=c.cust_id AND u.user_type!=11 AND u.id IN(".$firmsarr.") group by u.id ORDER BY u.registerDate desc";

		}
			else if($user->user_type == 13 && $user->accounttype != 'master'){
		 $sql = "SELECT c.comp_id,c.cust_id,c.comp_name,u.accounttype,u.user_type,u.id,u.salutation,u.name,u.email,u.phone,u.extension,u.lastname,u.id,u.dmanager,u.username,(SELECT count(p.id) FROM #__cam_property p WHERE  p.property_manager_id = u.id AND (p.company_id=".$comp_id." OR p.property_manager_id=".$user->id.")) AS cnt FROM #__cam_customer_companyinfo c LEFT JOIN  #__users u ON c.cust_id=u.id WHERE (c.comp_id=".$comp_id." OR cust_id= ".$user->id.") and u.block=0 and u.id !='' ".$sortname." ";

		}
		else{
		//$sql = "SELECT u.id,u.salutation,u.name,u.email,u.phone,u.extension,u.lastname,u.id,u.dmanager,u.username,m.standardmanagers FROM  #__users as  u, #__vendor_districtmanagers as m where m.dmanager=".$user->id." and m.standardmanagers = u.id and u.block=0 ORDER BY ".$sortname." ASC";
	 $sql = "SELECT distinct(u.id),u.accounttype,u.user_type,u.salutation,u.name,u.email,u.phone,u.extension,u.lastname,u.dmanager,u.username, (SELECT count(p.id) FROM #__cam_property as p, #__users as u WHERE  p.property_manager_id = u.id AND p.property_manager_id=".$user->id." AND p.company_id=".$comp_id.") AS cnt FROM  #__users as  u, #__cam_invitemanagers as m where m.dmanager=".$user->id." and u.email=m.reciever and u.block=0  and u.id !='' ".$sortname." ";
		}
		//echo $sql; 
			return $sql;
	}
	//
	function _buildQueryPrperties_All($comp_id)
	{
		global $mainframe;
		$pmanager_id = JRequest::getVar("pmanager_id",0);
		$sql = "SELECT p.*,u.id as uid,u.salutation,u.name,u.email,u.phone,u.lastname,u.username FROM #__cam_property p LEFT JOIN  #__users u ON p.property_manager_id=u.id WHERE  p.property_manager_id = ".$pmanager_id." AND p.company_id=".$comp_id." ORDER BY p.id ASC";
		return $sql;
	}

	/**
	 * Method to get a pagination object for the Viewall
	 *
	 * @access public
	 * @return integer
	 */
	function getPagination()
	{
		// Lets load the content if it doesn't already exist
		if (empty($this->_pagination))
		{
			jimport('joomla.html.pagination');
			$this->_pagination = new JPagination( $this->getTotal(), $this->getState('limitstart'), $this->getState('limit') );
		}
		return $this->_pagination;
	}

	/**
	 * Method to get the total number of Camfirm admin managers/properties
	 *
	 * @access public
	 * @return integer
	 */
	 function get_thumbnail_dimensions()
	{
		$db = JFactory::getDBO();
		$sql = "SELECT vendor_logo_height,vendor_logo_width FROM #__cam_configuration";
		$db->Setquery($sql);
		$dimensions = $db->loadObjectList();
		return $dimensions;
	}
	// This is the function to Covert Thubnail Image
	function image_resize_to_max($uploadfile,$max_width,$max_height,$uploadDir,$file)
	{
		/******* To Get the size and MIME type of the requested image ****/
		$size		= getimagesize($uploadfile);
		$mime		= $size['mime'];
		/********** To Create the New Image from the Restricted Image ********/
		switch($mime)
		{
			case	'image/gif'		:	$src = imagecreatefromgif($uploadfile);
										break;
			case	'image/png'		:	$src = imagecreatefrompng($uploadfile);
										break;
			default					:	$src = imagecreatefromjpeg($uploadfile);
										break;
		}
		$width		= $size[0];
		$height		= $size[1];

		//for large images
		/*********** Assiging The Maximum Width & Height of Image ****/
		if($width > $max_width || $height > $max_height)
		{
			$newwidth	= $max_width;
			$newheight	= ($height/$width)*$newwidth;
		}
		else
		{
			$newwidth	= $width;
			$newheight	= $height;
		}
		$tmp	= imagecreatetruecolor($max_width,$max_height);
         $bg = imagecolorallocate ( $tmp, 255, 255, 255 );
           imagefill ( $tmp, 0, 0, $bg );
		imagecopyresampled($tmp,$src,0,0,0,0,$max_width,$max_height,$width,$height);
		$filename = $uploadDir.DS.$file;
		switch($mime)
		{
			case	'image/gif'		:	imagegif($tmp,$filename);
										break;
			case	'image/x-png'	:
			case	'image/png'		:	imagepng($tmp,$filename);
										break;
			default					:	imagejpeg($tmp,$filename,100);
										break;
		}
		imagedestroy($src);
		imagedestroy($tmp);
	}//end of function


	function getTotal()
	{
		//DEVNOTE: Lets load the content if it doesn't already exist
		if (empty($this->_total))
		{
			$task = JRequest::getVar("task",'');
			$user = JFactory::getUser();
			$comp_id = $this->getCompanyId($user->id);
			if($task=='manage_properties')
			$query = $this->_buildQueryPManagers_All($comp_id);
			else if($task=='customer_edit_form')
			$query = $this->_buildQueryPrperties_All($comp_id);
			$this->_total = $this->_getListCount($query);
		}
		return $this->_total;
	}


	//To get the property managers of camfirm admin(PRASAD 28 JAN 2011)
	function getCompanyId($user_id)
	{
		$db = JFactory::getDBO();
		$sql = "SELECT id FROM #__cam_camfirminfo WHERE cust_id=".$user_id;
		$db->setQuery( $sql);

		$comp_id = $db->loadResult();
		if($comp_id==''){
		$sql_comp = "SELECT comp_id FROM #__cam_customer_companyinfo WHERE cust_id=".$user_id;
		$db->setQuery( $sql_comp);
		$comp_id = $db->loadResult();
		}
		else{
		$comp_id = $comp_id;
		}
		return $comp_id;
	}
	//To get the property managers of camfirm admin(PRASAD 28 JAN 2011)
	function getPropertyManagers($comp_id)
	{
		$db = JFactory::getDBO();
		$sql = "SELECT c.cust_id,c.comp_name,u.id,u.salutation,u.name,u.email,u.phone,u.extension,u.lastname,u.username,(SELECT count(p.id) FROM #__cam_property p WHERE  p.property_manager_id = u.id
AND p.company_id=".$comp_id.") AS cnt FROM #__cam_customer_companyinfo c LEFT JOIN  #__users u ON c.cust_id=u.id WHERE c.comp_id=".$comp_id." ORDER BY u.id ASC LIMIT 0,5";
		$db->setQuery( $sql);
		$result = $db->loadObjectList();
		return $result;
	}//
	//To get the properties of camfirm admin or company(PRASAD 28 JAN 2011)
	function getProperties($comp_id)
	{
		$db = JFactory::getDBO();
		$sql = "SELECT p.*,u.id as uid,u.salutation,u.name,u.email,u.phone,u.lastname,u.username FROM #__cam_property p LEFT JOIN  #__users u ON p.property_manager_id=u.id WHERE p.company_id=".$comp_id." ORDER BY p.id ASC LIMIT 0,5";
		$db->setQuery( $sql);
		$result = $db->loadObjectList();
		return $result;
	}

	//function to display Property Details to edit/view
	function getPropertyDetails($property_id)
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$query = "SELECT p.*,u.username,u.name,u.lastname,u.email,u.salutation,u.phone FROM jos_cam_property p LEFT JOIN jos_users u ON p.property_manager_id=u.id WHERE p.id=".$property_id;
		$db->setQuery($query);
		$propertyDetails = $db->loadObjectList();
		return $propertyDetails;
	}
	//function to get Tax ids list
	function getProperty_TaxIDs()
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$query = "SELECT tax_id FROM #__cam_property ORDER BY id ASC";
		$db->setQuery($query);
		$ptaxid = $db->loadObjectList();
		return $ptaxid;
	}
	//
	function property_store($data)
	{
		// give me JTable object
		$row =& $this->getTable('property');
		//JTable::addIncludePath(JPATH_ADMINISTRATOR.DS.'components'.DS.'com_camassistant'.DS.'tables');
		//$row =& JTable::getInstance('recipes', 'Table');
		/*echo "<pre>";
		print_r($data);exit;*/
		// Bind the form fields to the  table
		if (!$row->bind($data)) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		// Store the  detail record into the database
		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		return true;
	}

//
function getuserinfo($cust_id)
{
	$db = JFactory::getDBO();
	//$user = JFactory::getUser();
	$checked    = JHTML::_( 'grid.id', $i, $row->id );
	 $sql = "SELECT * FROM #__users WHERE id = ".$cust_id;
	$db->setQuery( $sql);
	$detail = $db->loadObjectList();

	return $detail;
}
//
function getcompanyinfo()
	{
	    $db = JFactory::getDBO();
		$user = JFactory::getUser();
		$checked    = JHTML::_( 'grid.id', $i, $row->id );
		$sql1 = "SELECT * FROM #__cam_customer_companyinfo WHERE cust_id = ".$user->id;
		$db->setQuery( $sql1);
		$detail1 = $db->loadObjectList();

		return $detail1;
	}
	function getstates()
	{
		$db = JFactory::getDBO();
		$db->setQuery("SELECT id as value,state_name as text FROM #__state ORDER BY text ASC");
		$states = $db->loadObjectList();
		return $states;
	}
	//Saving CAMFIRM ADMIN Emails Information for Vendors to send
	function CAMMails_store($data)
	{
	 	// give me JTable object
		$row = & $this->getTable('camadminemailsinfo');
		//echo "<pre>"; print_r($row); exit;
		// Bind the form fields to the  table
		if (!$row->bind($data)) {

			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		// Create the timestamp for the date field
		// Store the  detail record into the database

		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}

//
	function store($data)
	{
	 	 // give me JTable object
		$row = & $this->getTable('propertymanager');

		// Bind the form fields to the  table
		if (!$row->bind($data)) {

			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		// Create the timestamp for the date field
		// Store the  detail record into the database

		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}
	function store_camfirm($data)
	{
		$row = & $this->getTable('camfirm');
		if (!$row->bind($data)) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}


	function verifytaxid($licno,$tax_id) {
	$db = &JFactory::getDBO();
	if($licno!=''&& $licno!='-')
  	 $query = "select F.* FROM #__cam_camfirminfo as C LEFT JOIN #__cam_customer_companyinfo as F on F.cust_id=C.cust_id  where C.camfirm_license_no='$licno' ";
	elseif($tax_id!='')
	 $query = "select F.* FROM #__cam_camfirminfo as C LEFT JOIN #__cam_customer_companyinfo as F on F.cust_id=C.cust_id  where C.tax_id='$tax_id'";
	$db->setQuery($query);
	$licid= $db->loadObjectList();
	//echo '<pre>'; print_r($licid); exit;
	return $licid;
	}
function getcompid($licno,$tax_id)
	{
	$db = &JFactory::getDBO();
	if($licno!=''&& $licno!='-')
   	$query1 = "select id FROM #__cam_camfirminfo where camfirm_license_no='$licno'";
	elseif($tax_id!='')
	$query1 = "select id FROM #__cam_camfirminfo where tax_id='$tax_id'";
	$db->setQuery($query1);
	$compid = $db->loadResult();
	//print_r($compid); exit;
	return $compid;
	}
	function getdelproperty()
	{
		$post = JRequest::getvar('cid');
		//echo '<pre>'; print_r($post); exit;
		$db = & JFactory::getDBO();
		echo $query = "delete from #__cam_property where id =".$post[0];
		$db->setQuery($query);
		$result = $db->query();
		if($result)
		{
			return true;
		}
		else
		{
			return fail;
		}
	}

	function reassign_prop()
	{
		$post = JRequest::getvar('property_id');
		//echo '<pre>'; print_r($_REQUEST);
		$db = & JFactory::getDBO();
		$query = "select * from #__cam_property where id =".$post;
		$db->setQuery($query);
		$result = $db->loadObjectList();
		return $result;
	}

	function getadmins($comp_id)
	{
		$db = & JFactory::getDBO();
		//$query ="select * from #__cam_board_mem ";
		$query = "SELECT c.cust_id,c.comp_name,u.id,u.salutation,u.name,u.email,u.phone,u.extension,u.lastname,u.username FROM #__cam_customer_companyinfo c LEFT JOIN  #__users u ON c.cust_id=u.id WHERE c.comp_id=".$comp_id." ORDER BY u.id ASC ";
		$db->setQuery($query);
		$result = $db->loadObjectList();
		return $result;
	}

	function update_rec()
	{

		$post = JRequest::getVar('admins');
		$id = JRequest::getVar('update_id');
		//echo $id;
		$db = & JFactory::getDBO();
		$query ="update #__cam_property  set property_manager_id = ".$post." where id = ".$id ;
		$db->setQuery($query);
		$result = $db->query();
		return $result;
	}
	//function to add questions
	function getquestions()
	{
		$db =& JFactory::getDBO();
		$ques = "SELECT  id as value, question  as text  FROM #__questions";
		$db->setQuery($ques);
		$questions = $db->loadObjectList();
		//echo "<pre>"; print_r($questions); exit;
		return $questions;
	}
	//completed
	function invitestore($post){

	$row =& $this->getTable('invitemanagers');
		jimport('joomla.user.helper');
		// Bind the form fields to the  table
		if (!$row->bind($post)) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}
		function getmanagersalltopopup($comp_id){
		global $mainframe;
		$db =& JFactory::getDBO();
		$sortby = JRequest::getVar("sortby",'');
		if($sortby==1)
		$sortname = " u.lastname ";
		else if($sortby==2)
		$sortname = " u.name ";
		else if($sortby==3)
		$sortname = " u.phone ";
		else if($sortby==4)
		$sortname = " u.extension ";
		else if($sortby==5)
		$sortname = " u.email ";
		else
		$sortname = " u.lastname ";
		$user = JFactory::getUser();

		$sql = "SELECT c.comp_id,c.cust_id,c.comp_name,u.id,u.salutation,u.name,u.email,u.phone,u.extension,u.lastname,u.id,u.dmanager,u.username,(SELECT count(p.id) FROM #__cam_property p WHERE  p.property_manager_id = u.id AND p.company_id=".$comp_id.") AS cnt FROM #__cam_customer_companyinfo c LEFT JOIN  #__users u ON c.cust_id=u.id WHERE c.comp_id=".$comp_id." and u.block=0 ORDER BY ".$sortname." ASC";
		$db->setQuery($sql);
		$result = $db->loadObjectList();

			return $result;
	}
	//function to get managers under district manager
	function getmanaagers()
	{
		$db =& JFactory::getDBO();
		$user = JFactory::getUser();
		$ques = "SELECT  standardmanagers  FROM #__vendor_districtmanagers where dmanager=".$user->id." ";

		$db->setQuery($ques);
		$manager = $db->loadObjectList();
		//echo "<pre>"; print_r($questions); exit;
		return $manager;
	}
	//completed
	function getpropertieslist(){
	$userid = JRequest::getVar("managerid",'');
	$db =& JFactory::getDBO();
		$query_cname="SELECT property_name FROM #__cam_property  WHERE property_manager_id='".$userid."' and publish='0'";
		$db->setQuery( $query_cname );
		$properties = $db->loadObjectList();
		//echo "<pre>"; print_r($properties); exit;
		return $properties;

	}
	
	function getalldistrictmanagers(){
			$db =& JFactory::getDBO();
			$user = JFactory::getUser();
			if($user->user_type == '13' && $user->accounttype == 'master'){
				$dmanagers = $this->getmastermanagers();
			}
			else if($user->user_type == '13' && $user->accounttype != 'master'){
				$dmanagers = $this->getcamfirmmanagers();
			}
		//echo "<pre>";	print_r($dmanagers); echo "</pre>";
		return $dmanagers;
	}
	
	function getcamfirmmanagers(){
		$userid = JRequest::getVar("pmanager_id",'');
		$db =& JFactory::getDBO();
		$user = JFactory::getUser();
		$totaldms[] = $user->id; 
		$sql = "SELECT dmanager FROM #__cam_invitemanagers where managerid=".$managerid." and dmanager!=0";
		$db->Setquery($sql);
		$dimensions = $db->loadResult();
		if($dimensions && $dimensions != $user->id){
			$totaldms[] = $dimensions;
		}
		$sql_dmanager = "SELECT DISTINCT dmanager FROM #__vendor_districtmanagers where camfirnid =".$user->id."";
		$db->Setquery($sql_dmanager);
		$dmanagers = $db->loadObjectList();
		if($dmanagers){
			foreach( $dmanagers as $dms ){
				if($dimensions != $dms->dmanager && $user->id != $dms->dmanager)
				$totaldms[] = $dms->dmanager ;
			}
		}
		return $totaldms;
	}
	
	function getmastermanagers(){
		$userid = JRequest::getVar("pmanager_id",'');
		$db =& JFactory::getDBO();
		$user = JFactory::getUser();
		//$totaldms[] = $user->id; 
		$sql = "SELECT dmanager FROM #__cam_invitemanagers where managerid=".$managerid." and dmanager!=0";
		$db->Setquery($sql);
		$dimensions = $db->loadResult();
		if($dimensions && $dimensions != $user->id){
			$totaldms[] = $dimensions;
		}
		// To get the manager camfirm id
		$sql_cid = "SELECT comp_id FROM #__cam_customer_companyinfo where cust_id=".$userid." ";
		$db->Setquery($sql_cid);
		$compid = $db->loadResult();
		$sql_cid = "SELECT cust_id FROM #__cam_camfirminfo where id=".$compid." ";
		$db->Setquery($sql_cid);
		$camfirmid = $db->loadResult();
		
		if( $camfirmid )
		$totaldms[] = $camfirmid; 
		
		$sql_dmanager = "SELECT DISTINCT dmanager FROM #__vendor_districtmanagers where camfirnid =".$camfirmid." or camfirnid =".$user->id."";
		$db->Setquery($sql_dmanager);
		$dmanagers = $db->loadObjectList();
		if($dmanagers){
			foreach( $dmanagers as $dms ){
				if($dimensions != $dms->dmanager && $user->id != $dms->dmanager)
				$totaldms[] = $dms->dmanager ;
			}
		}
		//echo "<pre>"; print_r($totaldms); echo "</pre>";
		return $totaldms;
		
	}	
	
	// Function to get all camfirm under master
	function getcamfirms(){
		$db =& JFactory::getDBO();
		$user = JFactory::getUser();
		$sql_firms = "SELECT U.firmid, V.comp_name FROM #__cam_masteraccounts as U, #__cam_camfirminfo as V where U.masterid=".$user->id." and U.firmid=V.cust_id ";
		$db->Setquery($sql_firms);
		$camfirms = $db->loadObjectList();
		return $camfirms;
	}

	function getallinvitations(){
		$db =& JFactory::getDBO();
		$user = JFactory::getUser();
		
		$sort = JRequest::getVar('sort','');
		if($sort == 'asc' || $sort == ''){
			$sorting = 'order by reciever ASC';
		}
		else{
			$sorting = 'order by reciever DESC';
		}
	
		if($user->user_type == '13' && $user->accounttype == 'master') {
			$total_mangrs = $this->getmastermanagers_invites() ;
			$whereas[] = "sender IN (".implode( ' , ' , $total_mangrs).") ";
		}
		else if($user->user_type == '13' && $user->accounttype != 'master'){
			$totalmanagers = $this->gettotalmanagersofcamfirm_invites();
			$whereas[] = "sender IN (".implode( ' , ' , $totalmanagers).") ";
		}
		else if($user->user_type == '12' && $user->dmanager == 'yes'){
			$total_mangrs = $this->gettotalmanagersofdm_invites() ;	
			$whereas[] = "sender IN (".implode( ' , ' , $total_mangrs).") ";
		}
		$sql_invites = "SELECT id, sender, managerid, reciever, senttime FROM #__cam_invitemanagers where " . implode( ' AND ', $whereas ) . " and publish='0' group by reciever ".$sorting." ";
		$db->Setquery($sql_invites);
		$invitations = $db->loadObjectList();
		return $invitations;
	}
	
	function getmastermanagers_invites(){
			$user =& JFactory::getUser();
			$db=&JFactory::getDBO();
			$sql1 = "SELECT firmid from #__cam_masteraccounts where masterid=".$user->id." ";
			$db->Setquery($sql1);
			$subfirms = $db->loadObjectlist();
			
	if($subfirms)
		{
			for( $a=0; $a<count($subfirms); $a++ )
				{
					$firmid1[] = $subfirms[$a]->firmid;
					$sql = "SELECT id from #__cam_camfirminfo where cust_id=".$subfirms[$a]->firmid." ";
					$db->Setquery($sql);
					$companyid[] = $db->loadResult();
											
				}
				
        }
			
	if($companyid)
		{
         	for( $c=0; $c<count($companyid); $c++ )
				{
					$sql_cid = "SELECT cust_id from #__cam_customer_companyinfo where comp_id=".$companyid[$c]." ";
					$db->Setquery($sql_cid);
					$managerids = $db->loadObjectList();
						if($managerids) {
							foreach( $managerids as $last_mans){
								$total_mangrs[] = $last_mans->cust_id ;
							}
						}
               }
        }
		
	if($firmid1 && $total_mangrs )
		{
            $total_mangrs = array_merge($total_mangrs,$firmid1); 
        }
	if($firmid1){
            for( $d=0; $d<count($firmid1); $d++ ){
        $query = "SELECT id FROM #__cam_camfirminfo WHERE cust_id=".$firmid1[$d];
	$db->setQuery($query);
	$comp_id = $db->loadResult();
	$userid=array($user->id);
	$query_mans = "SELECT cust_id from #__cam_customer_companyinfo where comp_id = ".$comp_id." ";
	$db->setQuery($query_mans);
        $Managers_list1 = $db->loadObjectList();
                if($Managers_list1) {
                        foreach( $Managers_list1 as $Managers_list2){
                                $Managers_list[] = $Managers_list2->cust_id ;
                        }
                }
            }
        if($Managers_list){
        $total_mangrs = array_merge($Managers_list,$firmid1);
            } else {
         $total_mangrs = $firmid1;        
            }
        }				
        $userid=array($user->id);
        if($total_mangrs){
        $total_mangrs = array_merge($userid,$total_mangrs); 
		}
		else{
		$total_mangrs[] = $user->id; 
		}
		
		return $total_mangrs;
	}
	
	function gettotalmanagersofcamfirm_invites(){
	$db = JFactory::getDBO();
	$user = JFactory::getUser();
	$query = "SELECT id FROM #__cam_camfirminfo WHERE cust_id=".$user->id;
	$db->setQuery($query);
	$comp_id = $db->loadResult();
	$userid=array($user->id);
	$query_mans = "SELECT cust_id from #__cam_customer_companyinfo where comp_id = ".$comp_id." ";
	$db->setQuery($query_mans);
    $Managers_list = $db->loadObjectList();
	
	foreach( $Managers_list as $cf_mans)
		{
			$total_mangrs[] = $cf_mans->cust_id ;
		}
	if($total_mangrs){
		$totalcust_id1 = array_merge($userid,$total_mangrs); 
	}
	else{
		$totalcust_id1[] = $user->id; 
	}

	return $totalcust_id1; 	
	}
	
	function gettotalmanagersofdm_invites(){
	$db = JFactory::getDBO();
	$user = JFactory::getUser();
	$dmmanagers = "SELECT DISTINCT managerid FROM #__cam_invitemanagers WHERE dmanager=".$user->id;
	$db->setQuery($dmmanagers);
	$dm_managers = $db->loadObjectlist();
		for($i=0; $i<count($dm_managers);$i++){
			$query = "SELECT id from #__users where id='".$dm_managers[$i]->managerid."' and block=0 " ;
			$db->setQuery($query);
			$total_mangrs[]=$db->loadResult();
			}
			/*if($Managers_list){
	foreach( $Managers_list as $cf_mans)
		{
			$total_mangrs[] = $cf_mans->id ;
		}
		}*/
	$userid=array($user->id);		
	if($total_mangrs){
		$totalcust_id1 = array_merge($userid,$total_mangrs); 
	}
	else{
		$totalcust_id1[] = $user->id; 
	}
	 return $totalcust_id1; 		
	}
	
	function getallmanagers($managerid){
		$db = JFactory::getDBO();
		$user = JFactory::getUser();
		if( $user->user_type == '13' && $user->accounttype == 'master' ){
			$total_mgrs = $this->getmastermanagers_delete($managerid,$user->id);
		}
		else if( $user->user_type == '13' && $user->accounttype != 'master' ){
			$total_mgrs = $this->getmastermanagers_delete($managerid,$user->id);
		
		}
		else if( $user->user_type == '12' && $user->dmanager == 'yes' ){
			$total_mgrs = $this->getmastermanagers_delete($managerid,$user->id);
		}
		
		for( $m=0; $m<count($total_mgrs); $m++ ){
			$sql_names = 'select name, lastname from #__users where id='.$total_mgrs[$m]->cust_id.' ';
			$db->setQuery($sql_names);
			$mgname = $db->loadObject();
			$total_mgrs[$m]->fullname = $mgname->name.'&nbsp;'.$mgname->lastname;
		}
		$list_mgrs[] = JHTML::_('select.option', '0', 'Select Manager');
		foreach( $total_mgrs as $obj )
		{
			$list_mgrs[] = JHTML::_('select.option',  $obj->cust_id, $obj->fullname);
		}
		$result = JHTML::_('select.genericlist',$list_mgrs, 'managerid', 'class="managerlist_drop" size="1" ' . $javascript , 'value', 'text','', 'managerid');
		return $result;
	}
	
	function getmastermanagers_delete($deleteid,$loguser){
		$db = JFactory::getDBO();
		$del = JFactory::getUser($deleteid);
		if( $del->user_type == '12' && $del->dmanager !='yes' ){
		$sql_cid = "SELECT cust_id FROM #__cam_customer_companyinfo where comp_id=(select comp_id from #__cam_customer_companyinfo where cust_id=".$deleteid.") and cust_id != ".$deleteid." ";
		$db->Setquery($sql_cid);
		$total_mgrs = $db->loadObjectList();
		$sql_cid = "SELECT cust_id FROM #__cam_camfirminfo where id=(SELECT comp_id FROM #__cam_customer_companyinfo where cust_id=".$deleteid.") ";
		$db->Setquery($sql_cid);
		$total_mgrs[]->cust_id = $db->loadResult();
		}
		else if( $del->user_type == '12' && $del->dmanager =='yes' ){
		
		$sql_cid = "SELECT cust_id FROM #__cam_customer_companyinfo where comp_id=(select comp_id from #__cam_customer_companyinfo where cust_id=".$deleteid.") and cust_id != ".$deleteid." ";
		$db->Setquery($sql_cid);
		$mgrs = $db->loadObjectList();
		for( $t=0; $t<count($mgrs); $t++ ){
				$smanager = JFactory::getUser($mgrs[$t]->cust_id);
				if( $smanager->dmanager == 'yes' )
				$total_mgrs[]->cust_id = $smanager->id ;
		}
		//echo "<pre>"; print_r($total_mgrs); exit;
		$sql_cid = "SELECT cust_id FROM #__cam_camfirminfo where id=(SELECT comp_id FROM #__cam_customer_companyinfo where cust_id=".$deleteid.") ";
		$db->Setquery($sql_cid);
		$total_mgrs[]->cust_id = $db->loadResult();
		}
		else if( $del->user_type == '13' && $del->accounttype !='yes'){
		$sql_cid = "SELECT firmid as cust_id FROM #__cam_masteraccounts where masterid= ".$loguser." and firmid != ".$deleteid." ";
		$db->Setquery($sql_cid);
		$total_mgrs = $db->loadObjectList();
		}
		// To get the camfirm id
		
		return $total_mgrs;
	}
	//Function to reassign the properties
	function reassigningpropertis($newid,$deleteid){
		$db = JFactory::getDBO();
		$newuser = JFactory::getUser($newid);
		if($newid->user_type == '12'){	
		$query_comp = "SELECT comp_id FROM #__cam_customer_companyinfo WHERE cust_id=".$newid;
		$db->setQuery($query_comp);
		$comp_id = $db->loadResult();
		
		$query_firm = "SELECT cust_id FROM #__cam_camfirminfo WHERE id=".$comp_id;
		$db->setQuery($query_firm);
		$firm = $db->loadResult();
		}
		else {
		$firm = $newid ;
		}
		
		$sql="UPDATE #__cam_property SET property_manager_id='".$newid."',camfirmid=".$firm." where property_manager_id=".$deleteid;
		$db->setQuery($sql);
		$res=$db->query();
		
		$sql_docs="UPDATE #__cam_propertydocs SET property_manager_id=".$newid." where property_manager_id=".$deleteid." ";
		$db->Setquery($sql_docs);
		$db->query();
		
		$sql_rfps="UPDATE #__cam_rfpinfo SET cust_id=".$newid." where cust_id=".$deleteid." ";
		$db->Setquery($sql_rfps);
		$db->query();
		return $res;
	}
	//Completed
	function deletemanager($deletedid){
		$db =& JFactory::getDBO();
		$user = JFactory::getUser();	
		$query = "DELETE FROM #__users WHERE id=".$deletedid; 
		$db->setQuery($query);
		$db->query();
		$query_invite = "DELETE FROM #__cam_invitemanagers WHERE managerid=".$deletedid; 
		$db->setQuery($query_invite);
		$db->query();
		$query_company = "DELETE FROM #__cam_customer_companyinfo  WHERE cust_id=".$deletedid; 
		$db->setQuery($query_company);
		if( $db->query() )
		$ret = 'success';
		else
		$ret = 'fail';
		return $ret;
	}
	//Function to re-assign all managers under the district manager to camfirm
	function managers_assign($newid,$deleteid){
		$db =& JFactory::getDBO();
		/*$newuser = JFactory::getUser($newid);
		if($newuser->dmanager == 'yes'){
			
		}*/
		$sql_docs="UPDATE #__cam_invitemanagers SET dmanager=".$newid." where dmanager=".$deleteid;
		$db->Setquery($sql_docs);
		$db->query();
		$sql_docs="UPDATE #__vendor_districtmanagers SET dmanager=".$newid." where dmanager=".$deleteid;
		$db->Setquery($sql_docs);
		$db->query();
		
		$sql_docs="UPDATE #__cam_invitemanagers SET sender=".$newid." where sender=".$deleteid;
		$db->Setquery($sql_docs);
		if( $db->query() )
		$ret = 'success';
		else
		$ret = 'fail';
		return $ret;
	}
	//Function to get count of admins under the master
	function getadminscount(){
		$db =& JFactory::getDBO();
		$user = JFactory::getUser();
		$query_c = "SELECT count(firmid) as list FROM #__cam_masteraccounts WHERE masterid=".$user->id;
		$db->setQuery($query_c);
		$countofas = $db->loadResult();
		return $countofas;
	}
	//Completed
	
	function getallmanagers_company($managerid){
		$db = JFactory::getDBO();
		$user = JFactory::getUser($managerid);
		
		if($user->user_type == '13') 
			$reportsto = 'no';
		else if( $user->user_type == '12' )
			$reportsto = 'admin';
		else{
			$reportsto = '';
		}	
		return $reportsto;
	}
	//sreenu
	function getStatess(){
		$db =& JFactory::getDBO();
//		$query = "SELECT code,state FROM #__cam_vendor_states ";
		$query = "SELECT * FROM #__state";
		$db->setQuery($query);
        $states=$db->loadObjectList();
		return $states;

     }
	 function resize_pimage($files,$path,$filename){
		$resized = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'property_pictures';
		$img = $path;
		$dimensions[0]->vendor_logo_width = 438;
		$img1=$resized;
		$apath=getimagesize($img);
		$height_orig=$apath[1]; 
		$width_orig=$apath[0]; 
		$aspect_ratio = (float) $height_orig / $width_orig;
		$width =$dimensions[0]->vendor_logo_width; 
		$height = round($width * $aspect_ratio);
		$thumb =     $this->image_resize_to_max($img,$width,$height,$img1,$filename);
		$ftmp = $filename;
        $oname = $filename;
        $fname = $path;
		$sizes = getimagesize($fname);
		$width	=	$sizes[0];
        $height	=	$sizes[1];
		$extenssion = strstr($oname, ".");
		$prod_img		= $fname;
		$prod_img_thumb =  $pdf_resized.'/'.$oname;
		move_uploaded_file($ftmp, $prod_img);
		$ret = '1';
		return $ret;
	}	
	 
	 
   function getmanagerpropertyinfo($email){
		$db =& JFactory::getDBO();
		$query_c = "SELECT * FROM #__cam_board_mem WHERE email='".$email."'";
		$db->setQuery($query_c);
		$property_info = $db->loadObject();
		
		if($property_info->accept=='no' || $property_info->accept=='yes' ){
		$sql_property = "SELECT P.property_name FROM #__cam_property as P, #__cam_board_mem as V where P.id = V.property_name and V.property_name=".$property_info->  property_name."";
		$db->setQuery($sql_property);
		$email_property = $db->loadResult();
        $property_info->propertyname = $email_property;
		 
		$sql_manager = "SELECT U.name FROM #__users as U, #__cam_board_mem as V where U.id = V.user_id and V.user_id=".$property_info-> user_id."";
		$db->setQuery($sql_manager);
		$manager_name = $db->loadResult();
		$property_info->managerfirst = $manager_name;
		
		$sql_managerlast = "SELECT U.lastname FROM #__users as U, #__cam_board_mem as V where U.id = V.user_id and V.user_id=".$property_info-> user_id."";
		$db->setQuery($sql_managerlast);
		$manager_last = $db->loadResult();
        $property_info->managerlast = $manager_last;
		
	 $manager_companyname = "SELECT V.comp_name FROM #__cam_customer_companyinfo as V, #__users as U where U.id = V.cust_id and V.cust_id=".$property_info-> user_id."";
		$db->setQuery($manager_companyname);
		$manager_companyname = $db->loadResult();
        $property_info->managercompanyname = $manager_companyname;
		
		 }
		
		return $property_info;
      }

	function property_stores($data)
	{
		
	// give me JTable object
		$row = & $this->getTable('propertyowner');
		// Bind the form fields to the  table
		if (!$row->bind($data)) {

			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		// Create the timestamp for the date field
		// Store the  detail record into the database

		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}
	function property_ownerdetailstored($data)
	{
	// give me JTable object
	//echo '<pre>';print_r($data);exit;
		$row = & $this->getTable('propertydetails');
		// Bind the form fields to the  table
		if (!$row->bind($data)) {

			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		// Create the timestamp for the date field
		// Store the  detail record into the database

		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}
	function property_check($id)
	{
	  $db =& JFactory::getDBO();
	$query_c = "SELECT id FROM #__cam_propertyowner_image WHERE user_id='".$id."'";
		$db->setQuery($query_c);
		$property_info = $db->loadResult();
		return $property_info;
		
	}
	
		
function propertyowner_details($data)
{
     $row = & $this->getTable('propertyownerdetails');
		//echo "<pre>"; print_r($data); exit;
		// Bind the form fields to the  table
		if (!$row->bind($data)) {

			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		// Create the timestamp for the date field
		// Store the  detail record into the database

		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
		
	
}
function property_details($data)
{
  //echo "<pre>"; print_r($data); exit;
     $row = & $this->getTable('propertydetails');
		
		// Bind the form fields to the  table
		if (!$row->bind($data)) {

			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		// Create the timestamp for the date field
		// Store the  detail record into the database

		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
		
	
}
}
?>
