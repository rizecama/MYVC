<?php
/**
 * @version		1.0.0 cam assistant $
 * @package		cam_assistant
 * @copyright	Copyright © 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport( 'joomla.application.component.model' );

class boardmembersModelboardmembers extends Jmodel
{
	function __construct(){
		parent::__construct();
	}

	function store_boardmember($data)
	{
	//echo '<pre>';print_r($data);exit;
	 	// give me JTable object	
		$row =& $this->getTable('addboardmember');
		jimport('joomla.user.helper');
		
		// Bind the form fields to the  table
		if (!$row->bind($data)) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		// Store the  detail record into the database
		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}
	function list_boardmembers()
	{
	 	
		$db=&JFactory::getDBO();
		$user = JFactory::getUser();
		
		$sort = JRequest::getVar('sort','');
		if($sort == 'asc' || $sort == ''){
			$sorting = 'order by C.firstname ASC';
		}
		else{
			$sorting = 'order by C.firstname DESC';
		}
	
	   $query = "SELECT C.id as bid,C.board_position,C.link_status,C.salutation,C.firstname,C.accept,C.lastname,C.phone,C.extension,C.email,C.property_name, P.id, P.propertyowner_id,P.link_value FROM #__cam_board_mem as C LEFT JOIN #__cam_propertyowner_link as P ON P.boardmem_id =C.id WHERE C.user_id = ".$user->id." AND C.link_invite !='2' ";
		$db->setQuery($query);
		$boardmembers = $db->loadObjectList();
		
		for( $i = 0; $i<count($boardmembers);$i++ )
		{
		$link_status = $boardmembers[$i]->link_value;
		$propertyowner_id = $boardmembers[$i]->propertyowner_id;
		
		if($link_status == '1')
		$property_link = 'Yes';
		else
		$property_link = 'No';
		
		$sql_id = "SELECT id,name,lastname from #__users where username='".$boardmembers[$i]->email."' AND user_type='16'";
		$db->Setquery($sql_id);
		$propertyownerid = $db->loadObject();
		$propertyownerid = $propertyownerid->id;
		if( $propertyownerid )
		$account = 'Yes';
		else	
       	$account ='No';
	    
		$boardmembers[$i]->account = $account;
	
		$boardmembers[$i]->linkvalue = $property_link;
		
	     }
	
		return $boardmembers;
		 /*?>modified by anand kumar 25-7-11<?php */
	}
	
	function editboardmember()
	{
	    $db=&JFactory::getDBO();
		$id = JRequest::getVar("id",'');
		$user = JRequest::getVar("acount",'');  
		
		$query = "SELECT * FROM #__cam_board_mem WHERE id = ".$id;
		$db->setQuery($query);
		$data = $db->loadObjectList();
	
		//print_r($data);
		return $data;
		
	}
	
	function getProperties() 
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		// Camfirm Company id
		$user =& JFactory::getUser();
		if($user->user_type == 13 && $user->accounttype != 'master') {
			$totalmanagers = $this->gettotalmanagersofcamfirm();
			$whereas[] = "U.`property_manager_id` IN (".implode( ' , ' , $totalmanagers).") ";
			}
			else if($user->dmanager == 'yes'){
			$total_mangrs = $this->gettotalmanagersofdm() ;	
			$whereas[] = "U.`property_manager_id` IN (".implode( ' , ' , $total_mangrs).") ";
			}
			else if($user->user_type ==13 && $user->accounttype == 'master')
			{
			$total_mangrs = $this->getmastermanagers() ;
			$whereas[] = "U.`property_manager_id` IN (".implode( ' , ' , $total_mangrs).") ";
			}
			else{
			$whereas[] = "U.`property_manager_id` IN (".$user->id.") ";
			}

			
			$query = "SELECT U.id as value, U.property_name as text FROM #__cam_property as U, #__users as V where  U.publish='0' and U.`property_manager_id` = V.`id` "; 
		
			if($whereas) {
				$query .= " AND ".implode( ' AND ', $whereas )."   ".$sorting." order by U.property_name ASC ";
			}
			
			$db->Setquery($query);
			$propertyList = $db->loadObjectList();
			return $propertyList;

	}
	function gettotalmanagersofcamfirm(){
	$db = JFactory::getDBO();
	$user = JFactory::getUser();
	$query = "SELECT id FROM #__cam_camfirminfo WHERE cust_id=".$user->id;
	$db->setQuery($query);
	$comp_id = $db->loadResult();
	$userid=array($user->id);
	$query_mans = "SELECT cust_id from #__cam_customer_companyinfo where comp_id = ".$comp_id." ";
	$db->setQuery($query_mans);
    $Managers_list = $db->loadObjectList();
	
	foreach( $Managers_list as $cf_mans)
		{
			$total_mangrs[] = $cf_mans->cust_id ;
		}
	if($total_mangrs){
		$totalcust_id1 = array_merge($userid,$total_mangrs); 
	}
	else{
		$totalcust_id1[] = $user->id; 
	}

	return $totalcust_id1; 	
	}
	
	function gettotalmanagersofdm(){
	$db = JFactory::getDBO();
	$user = JFactory::getUser();
	$dmmanagers = "SELECT DISTINCT managerid FROM #__cam_invitemanagers WHERE dmanager=".$user->id;
	$db->setQuery($dmmanagers);
	$dm_managers = $db->loadObjectlist();
	
		for($i=0; $i<count($dm_managers);$i++){
			$query = "SELECT id from #__users where id='".$dm_managers[$i]->managerid."' and block=0 " ;
			$db->setQuery($query);
			$total_mangrs[]=$db->loadResult();
			}
			/*if($Managers_list){
	foreach( $Managers_list as $cf_mans)
		{
			$total_mangrs[] = $cf_mans->id ;
		}
		}*/
	$userid=array($user->id);		
	if($total_mangrs){
		$totalcust_id1 = array_merge($userid,$total_mangrs); 
	}
	else{
	
		$totalcust_id1[] = $user->id; 
	}
		
	 return $totalcust_id1; 		
	}
	
	
	function getmastermanagers(){
			$user =& JFactory::getUser();
			$db=&JFactory::getDBO();
			$sql1 = "SELECT firmid from #__cam_masteraccounts where masterid=".$user->id." ";
			$db->Setquery($sql1);
			$subfirms = $db->loadObjectlist();
			
	if($subfirms)
		{
			for( $a=0; $a<count($subfirms); $a++ )
				{
					$firmid1[] = $subfirms[$a]->firmid;
					$sql = "SELECT id from #__cam_camfirminfo where cust_id=".$subfirms[$a]->firmid." ";
					$db->Setquery($sql);
					$companyid[] = $db->loadResult();
											
				}
				
        }
			
	if($companyid)
		{
         	for( $c=0; $c<count($companyid); $c++ )
				{
					$sql_cid = "SELECT cust_id from #__cam_customer_companyinfo where comp_id=".$companyid[$c]." ";
					$db->Setquery($sql_cid);
					$managerids = $db->loadObjectList();
						if($managerids) {
							foreach( $managerids as $last_mans){
								$total_mangrs[] = $last_mans->cust_id ;
							}
						}
               }
        }
	
	if($firmid1 && $total_mangrs )
		{
            $total_mangrs = array_merge($total_mangrs,$firmid1); 
        }
        if($firmid1){
            for( $d=0; $d<count($firmid1); $d++ ){
        $query = "SELECT id FROM #__cam_camfirminfo WHERE cust_id=".$firmid1[$d];
	$db->setQuery($query);
	$comp_id = $db->loadResult();
	$userid=array($user->id);
	$query_mans = "SELECT cust_id from #__cam_customer_companyinfo where comp_id = ".$comp_id." ";
	$db->setQuery($query_mans);
        $Managers_list1 = $db->loadObjectList();
                if($Managers_list1) {
                        foreach( $Managers_list1 as $Managers_list2){
                                $Managers_list[] = $Managers_list2->cust_id ;
                        }
                }
            }
            if($Managers_list){
        $total_mangrs = array_merge($Managers_list,$firmid1);
            } else {
         $total_mangrs = $firmid1;        
            }
        }
	/*if($firmid1){
            $total_mangrs = $firmid1;
        }
         */
        $userid=array($user->id);
        if($total_mangrs){
        $total_mangrs = array_merge($userid,$total_mangrs); 
		}
		else{
		$total_mangrs[] = $user->id; 
		}
		 
		return $total_mangrs;
	}
//completed
	function delete_boardmember($id)
	{
	 	// give me JTable object
		//echo 'find'; exit;
		$db=&JFactory::getDBO();
		$user = JFactory::getUser();
		$query = "DELETE FROM #__cam_board_mem WHERE id = ".$id." "; 
		$db->setQuery($query);
		$db->query();
		return true;
	}
	
	function getIndustry() 
	{
		global $mainframe;
	 	$db=&JFactory::getDBO();
		$query = "SELECT id as value,industry_name as text FROM #__cam_industries ORDER BY industry_name ASC";
		$db->setQuery($query);
		$industryList = $db->loadObjectList();
		return $industryList;
	}
	//function to display industries list in popup
	function getindustires() 
	{
		global $mainframe;
		if(isset($_SESSION['industries']))
		$chk_arry = $_SESSION['industries'];
		$db = JFactory::getDBO();
		$checked    = JHTML::_( 'grid.id', $i, $row->id );
		$sql = "SELECT * FROM #__cam_industries order by industry_name";
		$db->Setquery($sql);
		$objects = $db->loadObjectList();
		foreach( $objects as $key => $obj ) 
		{
			//$checked    = JHTML::_( 'grid.id', $key, $obj->industry_name);
			if(isset($chk_arry) && in_array($obj->industry_name,$chk_arry))
			$checked = "<input checked='checked' type='checkbox' onclick='isChecked(this.checked);' value='".$obj->industry_name."' name='cid[]' id='cb'".$key.">";
			else
			$checked = "<input type='checkbox' onclick='isChecked(this.checked);' value='".$obj->industry_name."' name='cid[]' id='cb'".$key.">";
			$industries[] = $checked.'&nbsp;'. $obj->industry_name;
		}
		//echo "<pre>"; print_r($industries);
	   return $industries;
	}
function getStates(){
		$db =& JFactory::getDBO();
//		$query = "SELECT code,state FROM #__cam_vendor_states ";
		$query = "SELECT * FROM #__state";
		$db->setQuery($query);
        $states=$db->loadObjectList();
		return $states;

}
	function getcompnay($id){
	$db =& JFactory::getDBO();
	$query = "select comp_name from #__cam_customer_companyinfo where cust_id=".$id."";
	$db->SetQuery($query);
	$company = $db->loadResult();
	return $company;
	}

	function property_permissions($pid)
	{
	
		$db =& JFactory::getDBO();
		$query_1 = "SELECT email FROM #__cam_board_mem WHERE id = ".$pid;
		$db->setQuery( $query_1 );
		$email = $db->loadResult();
		if($email)
		{
			$query_2 = "select B.vendor_proposals,B.myvendor_list,B.invite_vendors, B.approval_request,B.approval_awarding from #__users as U ,  #__cam_propertyowner_permissions as B where U.email='".$email."' AND B.propertyowner_id =U.id ";
			$db->setQuery($query_2);
			$permissions = $db->loadObject();
			return $permissions;
		}
	}
	function getpropertyowner_logo($bid)
	{
		 $db =& JFactory::getDBO();
		 $query_1 = "SELECT propertyowner_id FROM #__cam_propertyowner_link WHERE boardmem_id = ".$bid;
		 $db->setQuery( $query_1 );
		 $id = $db->loadResult();
		 if($id)
		   {
			$query_2 = "select propertyowner_image from #__cam_propertyowner_image where user_id='".$id."'";
			$db->setQuery($query_2);
			$logo = $db->loadResult();
			return $logo;
			}
	}
	function property_user($pid)
	{
			$db =& JFactory::getDBO();
			$query_1 = "SELECT email, user_id FROM #__cam_board_mem WHERE id = ".$pid;
			$db->setQuery($query_1);
			$user = $db->loadObject();
			$query_2 = "select U.name, U.lastname, U.email, T.steetaddress as usteetaddress, T.city as ucity, T.state as ustate, T.zipcode as uzipcode, S.steetaddress, S.city, S.zipcode, U.phone, U.extension, U.cellphone ,P.street, P.fax_no, P.altemail, B.board_position,B.salutation,  P.property_name,P.city,P.state,P.zip from #__users as U , #__cam_propertyowner_info as T , #__cam_propertyowner_info as S , #__cam_property as P, #__cam_board_mem as B where U.email= '".$user->email."' AND P.property_manager='".$user->user_id."' AND P.manages=U.id AND B.email=U.email AND S.user_id=U.id AND U.id = T.user_id";
			$db->setQuery($query_2);
			$data1 = $db->loadObject();
	
			return $data1;	 	
	}
	
		
		function getpropertyowner_details($bid,$pid)
         {

			$db =& JFactory::getDBO();
			$getclientid = "SELECT propertyowner_id from #__cam_propertyowner_link where boardmem_id ='".$bid."'";
			$db->setQuery($getclientid);
			$user = $db->loadResult();
			$query = "SELECT U.name,U.lastname,S.state,S.steetaddress,S.zipcode,U.email,S.altemail,S.city,S.altphone_ext,U.phone,U.extension,U.cellphone,S.fax from #__cam_propertyowner_info as S,#__users as U where S.user_id='".$user."' AND U.id='".$user."'";
			$db->setQuery($query);
			$properyownerinfo = $db->loadObject();
			return $properyownerinfo;	
		}
	
	function propertownerunlink_details($bid)
	{
	    $db =& JFactory::getDBO();
		$user =& JFactory::getUser();
	    $query_1 = "SELECT firstname,lastname,streeaddress,state,accept,zipcode,board_position,email,altemail,phone,extension,altphone,fax from #__cam_board_mem where        id ='".$bid."' AND user_id='".$user->id."'";
		$db->setQuery($query_1);
		$managerinfo = $db->loadObject();
		return $managerinfo;	
	}
	
	function getmanagerinfo()
	{

	    $db =& JFactory::getDBO();
		$user =& JFactory::getUser();
	    $query_1 = "SELECT camfirm_license_no, comp_name from #__cam_customer_companyinfo where cust_id ='".$user->id."'";
		$db->setQuery($query_1);
		$managerlinkinfo = $db->loadObject();
		return $managerlinkinfo;	
	}	
	
	 function getclientpermisions($bid)
	    {
	    $db =& JFactory::getDBO();
		$per = "SELECT vendors_p,proposals_p,invite_p,approval_p, awarding_p from #__cam_propertyowner_link where boardmem_id ='".$bid."'";
		$db->setQuery( $per );
		$permission = $db->loadObject();
		return $permission;
	   }
	
	function store_propertyinfo($data)
	{
	//echo '<pre>';print_r($data);exit;
	 	// give me JTable object	
		$row =& $this->getTable('managerpropertydetails');
		jimport('joomla.user.helper');
		
		// Bind the form fields to the  table
		if (!$row->bind($data)) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		// Store the  detail record into the database
		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}
	
	function updatepropertyinfo($data)
	{
	//echo '<pre>';print_r($data);exit;
	 	// give me JTable object	
		$row =& $this->getTable('propertylink');
		jimport('joomla.user.helper');
		
		// Bind the form fields to the  table
		if (!$row->bind($data)) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		// Store the  detail record into the database
		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}
	
	function checklink($bid,$pid){
	    $db =& JFactory::getDBO();
	    $checklink = "SELECT id FROM #__cam_propertyowner_link where boardmem_id ='".$bid."' and property_id='".$pid."'";
		$db->setQuery( $checklink );
		$checklink = $db->loadResult();
		return $checklink;
	
	}
		 
}
?>
