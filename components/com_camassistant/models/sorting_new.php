<?php
/**
 * @version		1.0.0 cam assistant $
 * @package		cam_assistant
 * @copyright	Copyright © 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport( 'joomla.application.component.model' );


class sortingModelsorting extends Jmodel
{
	//assigning variables
	var $_data;
	var $_total = null;
	var $_pagination = null;
	
	function __construct(){
		parent::__construct();
		
		global $mainframe, $context;

		//initialize class property
	    $this->_table_prefix = '#__cam_';	
		 global $mainframe;
		 //echo "<pre>"; print_r($_REQUEST);
	    //DEVNOTE: Get the pagination request variables
		
		$limit = $mainframe->getUserStateFromRequest('global.list.limit', 'limit', $mainframe->getCfg('list_limit'), 'int');
	   $limitstart = JRequest::getVar('limitstart', 0, '', 'int');
      // $limit = $mainframe->getUserStateFromRequest('global.list.limit', 'limit', $default_limit, 'int');

		JRequest::setVar('limit', (int) $limit);
	// In case limit has been changed, adjust it
	$limitstart = ($limit != 0 ? (floor($limitstart / $limit) * $limit) : 0);
 
	$this->setState('limit', $limit);
	$this->setState('limitstart', $limitstart);
	//print_r($total);
	//print_r($limit);	
			
	}
	
		//function to get Managers list in get rfps_by_managers.php -- lalitha
	function get_Managers()
	{
		global $mainframe;
	    $db = JFactory::getDBO();
		$user = JFactory::getUser();
		$MGR_sql = 'SELECT P.id, P.property_manager_id, CONCAT(U.name," " ,U.lastname) "Fullname"
		FROM #__cam_camfirminfo AS C LEFT JOIN #__cam_customer_companyinfo AS CUS ON CUS.comp_id = C.id,
		 #__cam_property AS P LEFT JOIN #__users AS U ON U.id = P.property_manager_id
		WHERE C.cust_id = '.$user->id.'  GROUP BY P.property_manager_id order by U.name ';
		//echo '<pre>';
		//echo $MGR_sql; exit;
		$db->Setquery($MGR_sql);
		$Managers_list = $db->loadObjectList();
		//echo "<pre>"; print_r($Managers_list);
		$javascript		= 'onchange="document.RFPbypropertyForm.submit();" ';
		$Managers[] = JHTML::_('select.option', '0', 'Select Manager');
		$this->_filter_Properties	= $mainframe->getUserStateFromRequest( $context.'filter_Properties', 'filter_Properties', 0,	'string' );	
		foreach( $Managers_list as $obj ) 
		{
			$Managers[] = JHTML::_('select.option',  $obj->property_manager_id, $obj->Fullname);
		}
		//echo "<pre>"; print_r($vendorslist); exit;
		$Managers = JHTML::_('select.genericlist',$Managers, 'filter_Properties', 'class="inputbox" size="1"  style="width: 276px" ' . $javascript , 'value', 'text', $this->_filter_Properties);	
		return $Managers;
	}
	
	
	//function to get Properties list in get rfps_by_property.php -- lalitha
	function get_Properties()
	{
		global $mainframe;
	    $db = JFactory::getDBO();
		$user = JFactory::getUser();
		//query to get Drfat proposals
		
		$prp_sql = "SELECT * FROM #__cam_property order by id ";
		$db->Setquery($prp_sql);
		$Properties_list = $db->loadObjectList();
		$javascript		= 'onchange="document.RFPbypropertyForm.submit();" ';
		$Properties[] = JHTML::_('select.option', '0', 'Select Property');
		$this->_filter_Properties	= $mainframe->getUserStateFromRequest( $context.'filter_Properties', 'filter_Properties', 0,	'string' );	
		foreach( $Properties_list as $obj ) 
		{
			$Properties[] = JHTML::_('select.option',  $obj->id, $obj->property_name);
		}
		//echo "<pre>"; print_r($vendorslist); exit;
		$Properties = JHTML::_('select.genericlist',$Properties, 'filter_Properties', 'class="inputbox" size="1"  style="width: 276px" ' . $javascript , 'value', 'text', $this->_filter_Properties);	
		return $Properties;
	}
	
	//function to get list of rfp status
	function get_RFP_status()
	{
		global $mainframe;
		$javascript		= 'onchange="document.RFPbypropertyForm.submit();" ';
		$RFP_status[] = JHTML::_('select.option', '0', 'Filter By RFP Status');
		$this->_filter_Status	= $mainframe->getUserStateFromRequest( $context.'filter_Status', 'filter_Status', 0,	'string' );	
		$objects[0]->id 	= 'Draft';
		$objects[0]->status = 'Draft';
		$objects[1]->id 	= 'rfp';
		$objects[1]->status = 'Submitted';
		$objects[2]->id 	= 'Closed';
		$objects[2]->status = 'Closed';
		$objects[3]->id 	= 'Awarded';
		$objects[3]->status = 'Awarded';
		$objects[4]->id 	= 'Unawarded';
		$objects[4]->status = 'Unawarded';
		
		foreach( $objects as $obj ) 
		{
			$RFP_status[] = JHTML::_('select.option',  $obj->id, $obj->status);
		}
		//echo "<pre>"; print_r($vendorslist); exit;
		$RFP_status_list = JHTML::_('select.genericlist',$RFP_status, 'filter_Status', 'class="inputbox" size="1"  style="width: 276px" ' . $javascript , 'value', 'text', $this->_filter_Status);	
		return $RFP_status_list;

	}
	
	//function to get list of rfp's by manager
	/*function RFP_list_by_Mgr()
	{
		$user = JFactory::getUser();
		//$where = ' WHERE 1=1 ';
		$where = ' WHERE cust_id =' .$user->id ;
		$filter_Properties = $this->_filter_Properties;
		$filter_Status = $this->_filter_Status;
		if(isset($filter_Properties) && $filter_Properties != '0')
		$where .= '  AND cust_id ="'.$filter_Properties.'"';
		if(isset($filter_Status) && $filter_Status != '0')
		$where .= ' AND rfp_type = "'.$filter_Status.'"';
		$db = JFactory::getDBO();
		$RFP_sql = "SELECT id, projectName, rfp_type, createdDate  FROM #__cam_rfpinfo ".$where." ORDER BY rfp_type ";
		$db->setQuery($RFP_sql);
		$RFP_list_by_Mgr = $db->loadObjectList();
		return $RFP_list_by_Mgr;
	}*/
	//function to get list of rfp's by property
	function get_RFP_list($type_id)
	{
		$user = JFactory::getUser();
		//echo '<pre>';
		//echo $user->id.'<br />';
		//print_r($user); exit;
		//$where = ' WHERE 1=1 ';
		$where = ' WHERE cust_id =' .$user->id ;
		$filter_Properties = $this->_filter_Properties;
		$filter_Status = $this->_filter_Status;
		if(isset($filter_Properties) && $filter_Properties != '0')
		$where .= '  AND '.$type_id.' ="'.$filter_Properties.'"';
		if(isset($filter_Status) && $filter_Status != '0')
		$where .= ' AND rfp_type = "'.$filter_Status.'"';
		$db = JFactory::getDBO();
		//$RFP_sql = "SELECT id, projectName, rfp_type, createdDate  FROM #__cam_rfpinfo ".$where." ORDER BY rfp_type ";
		//echo $RFP_sql; exit;
		$RFP_sql = "SELECT U.id, U.projectName, U.rfp_type, U.createdDate,P.proposeddate,P.proposal_total_price  FROM #__cam_rfpinfo as U LEFT JOIN #__cam_vendor_proposals as P ON P.rfpno=U.id".$where." ORDER BY U.id";
		$db->setQuery($RFP_sql);
		$RFP_list_by_Prp = $db->loadObjectList();
		//echo count($RFP_list_by_Prp); exit;
		return $RFP_list_by_Prp;
	}
	
	//function pagination params from configuration
	function get_Configuration_Params()
	{
		$db = JFactory::getDBO();
		$rfps_by_property_limit_sql ="SELECT rfps_by_property_limit  FROM #__cam_configuration WHERE id=1";
		$db->setQuery($rfps_by_property_limit_sql);
		$rfps_by_property_limit = $db->loadResult();
		return $rfps_by_property_limit;
	}
	
	//function to get query in viewall_proposals
	function _buildQuery($type_id)
	{
		//print_r($_REQUEST);
		// Get the WHERE and ORDER BY clauses for the query
		//$where = $this->_buildContentWhere();
		$user = JFactory::getUser();
		//$where = ' WHERE 1=1 ';
		//$filter_Properties = JRequest::getVar('filter_Properties','');
		//$filter_Status = JRequest::getVar('filter_Status','');
		$where = ' WHERE cust_id =' .$user->id ;
		$filter_Properties = $this->_filter_Properties;
		$filter_Status = $this->_filter_Status;
		
		if(isset($filter_Properties) && $filter_Properties != '0')
		$where .= '  AND '.$type_id.' ="'.$filter_Properties.'"';
		if(isset($filter_Status) && $filter_Status != '0')
		$where .= ' AND rfp_type = "'.$filter_Status.'"';
		$db = JFactory::getDBO();
		//$RFP_sql = "SELECT U.id, U.projectName, U.rfp_type, U.createdDate,P.proposeddate,P.proposal_total_price  FROM #__cam_rfpinfo as U LEFT JOIN #__cam_vendor_proposals as P ON P.rfpno=U.id".$where." ORDER BY U.id";
		if ($_REQUEST['filter_Status']=='Closed') {
			$db = JFactory::getDBO();
		$today = date('m-d-y');
		$rfpquery = "SELECT  rfpid  FROM `#__cam_awardlist`";
		$db->setQuery($rfpquery);
	    $rfpids=$db->loadObjectList();
		for($l=0;$l<=count($rfpids);$l++){
		if($rfpids[$l]->rfpid)
		$rfp[]=$rfpids[$l]->rfpid;
		}
		$RFP_sql = "SELECT U.id, U.projectName, U.rfp_type, U.createdDate,U.proposalDueDate FROM #__cam_rfpinfo as U LEFT JOIN #__cam_awardlist as CA ON CA.rfpid=U.id WHERE  U.rfp_type ='rfp' AND U.proposalDueDate < '$today' AND U.id NOT IN ('".implode(',', $rfp)."') AND U.cust_id='".$user->id."' ORDER BY U.id";
	} else if ($_REQUEST['filter_Status']=='rfp'){
	$today = date('m-d-y');

		 $RFP_sql = "SELECT id, projectName, rfp_type,createdDate, proposalDueDate FROM #__cam_rfpinfo WHERE rfp_type ='rfp' AND proposalDueDate > '$today' AND cust_id='".$user->id."' ORDER BY id"; 
	 } else {
	 $RFP_sql = "SELECT U.id, U.projectName, U.rfp_type, U.createdDate,P.proposeddate,P.proposal_total_price  FROM #__cam_rfpinfo as U LEFT JOIN #__cam_vendor_proposals as P ON P.rfpno=U.id".$where." ORDER BY U.id";
	// $RFP_sql = "SELECT id, projectName, rfp_type, createdDate FROM #__cam_rfpinfo".$where." ORDER BY id"; 
	 }
		return $RFP_sql;
	}
	
	//function to get records in viewall_proposals
	function get_limit_records($type_id)
	{
		$query = $this->_buildQuery($type_id);
		//echo "<pre>"; print_r($_REQUEST);
		//echo $this->getState("limitstart"); echo '---'; echo $this->getState("limit");
		$records = $this->_getList($query,$this->getState("limitstart"),$this->getState("limit"));
		//echo count($records);
		return $records;
	}
	
	//function to get pagination for all types of proposals in viewall_proposals
	function getPagination($type_id)
	{
		// Lets load the content if it doesn’t already exist
		if (empty($this->_pagination))
		{
		jimport('joomla.html.pagination');
		$total = $this->get_RFP_list($type_id);
		$total1 = count($total);
		//$limit=$total1-$this->getState('limitstart');
		//print_r($this->_pagination);
		$this->_pagination = new JPagination($total1, $this->getState('limitstart'), $this->getState('limit'));
		}
		//echo "<pre>"; print_r($this->_pagination);

		return $this->_pagination;
	}
	
}
?>