<?php
/**
 * @version		1.0.0 cam assistant $
 * @package		cam_assistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com



 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport( 'joomla.application.component.model' );

class rfpModelRfp extends Jmodel
{
	function __construct(){
	parent::__construct();

		global $mainframe, $context;
		$limit			= $mainframe->getUserStateFromRequest( $context.'limit', 'limit', $mainframe->getCfg('list_limit'), 0);
		$limitstart = $mainframe->getUserStateFromRequest( $context.'limitstart', 'limitstart', 0 );
         $filter_order		= $mainframe->getUserStateFromRequest( $context.'filter_order',		'filter_order',		'affid',	'cmd' );
		$filter_order_Dir	= $mainframe->getUserStateFromRequest( $context.'filter_order_Dir',	'filter_order_Dir',	'desc',			'word' );

		$this->setState('limit', $limit);
		$this->setState('limitstart', $limitstart);

 }
 	function rfp_requirements_validations($industry_id,$userid,$property_id,$rfp_id,$choose_tasks){
	//echo $rfp_id; exit;
		$db = JFactory::getDBO();
		//$vendorsinfo	=	$this->getVendors($userid,$property_id,$rfp_id);
		$vendorsinfo	=	$this->getinvitedvendors($userid,$rfp_id);
		//echo "<>";
		//to store the eligible vendors in to an array
		if($vendorsinfo){
			foreach($vendorsinfo as $avail){
			$available[] = $avail->id;
			}
		}
		//echo "<pre>"; print_r($available); exit;
		//Completed

		if(count($vendorsinfo)>0)
			{
			  for($i=0;$i<count($vendorsinfo);$i++)
			  {
			  $flag = 0;
			  //echo $flag;
			//echo $vendorsinfo[$i][0]->id; echo '----------';
			   //code to validate specialrequirements
				$sql = "SELECT distinct(req_parentid ) FROM #__cam_rfpreq_info WHERE rfp_id ='".$rfp_id."'";
				$db->Setquery($sql);
				$main = $db->loadResultArray();
				$sql = "SELECT req_subparentid  FROM #__cam_rfpreq_info WHERE req_subparentid !=0 AND rfp_id ='".$rfp_id."'";
				$db->Setquery($sql);
				$sub = $db->loadResultArray();
                 $today  = date('Y-m-d');
				// echo "<pre>"; print_r($main); print_r($sub); exit;
				//$flag = 0;
 $query ="select industry_id from #__cam_vendor_industries Where user_id =".$vendorsinfo[$i]->id;
		$db->setQuery($query);
		$getindustryids = $db->loadResultArray();
		if($getindustryids)
		{
		if(in_array('56',$getindustryids))
		$PLN_needed = 'yes';
		else $PLN_needed = 'no';
		}
		else
		$PLN_needed = 'no';
				for($m = 0; $m<count($main); $m++)
				{
				// echo "<pre>"; print_r($main);  exit;
				  switch($main[$m])
				  {

				  case 1:
						for($h=0;$h<count($sub); $h++){

							 switch($sub[$h])
							  {
					 case 17:
								if($flag==0){
									$sql = "SELECT id  FROM #__cam_vendor_professional_license  WHERE PLN_expdate>= '".$today."' AND PLN_status = 1 AND vendor_id=".$vendorsinfo[$i]->id;
									  $db->Setquery($sql);
									  $PLN = $db->loadResultArray();
									  $PLN_cnt = count($PLN) ;
									  if($PLN_cnt== 0){
									 	$flag = 1;
											}

								}
						case 18:
								  if($flag==0){
							  //print_r($sub[$h]);  exit;
									 $sql = "SELECT id  FROM #__cam_vendor_occupational_license WHERE OLN_expdate>= '".$today."' and OLN_status = 1 AND vendor_id=".$vendorsinfo[$i]->id;
									  $db->Setquery($sql);
									  $OLN = $db->loadResultArray();
									   // echo "<pre>"; print_r($OLN); exit;
									  $OLN_cnt = count($OLN) ;
									   //echo "<pre>"; print_r($OLN_cnt); exit;
									  if($OLN_cnt== 0){
											$flag = 1;
				                     	}
									}


								}
							}
				   case 3:


							for($s=0;$s<count($sub); $s++){
							//echo "<pre>"; print_r($sub[$s]);
							switch($sub[$s])

							  {

						 case 11:
							//exit;
							 if($flag==0)
												{
								  $sql56 = "SELECT req_id  FROM #__cam_rfpreq_info WHERE rfp_id=".$rfp_id;
								  $db->Setquery($sql56);
								  $req_id = $db->loadResult();
							 $sql2 = "SELECT id  FROM #__cam_vendor_workers_companies_insurance WHERE WCI_end_date>= '".$today."' and WCI_status = 1 AND vendor_id=".$vendorsinfo[$i]->id;
								  $db->Setquery($sql2);
								  $WCI = $db->loadResultArray();
								  $WCI_cnt = count($WCI) ;
								  if($WCI_cnt == 0){
								  $flag = 1;
								  		}
								if ($req_id=='19' &&  $flag=='0'){
							 	    $sql26 = "SELECT excemption  FROM #__cam_vendor_workers_companies_insurance WHERE WCI_end_date>= '".$today."' and WCI_status = 1 AND vendor_id=".$vendorsinfo[$i]->id;
									$db->Setquery($sql26);
								   $excemption = $db->loadObjectlist();
								  //$excemption=$excemption1[0]->excemption;
								  //echo "<pre>"; print_r($excemption);
								  // $WCI_cnt1 = count($excemption) ;
								   for($d=0;$d<count($excemption); $d++){
								//echo "<pre>"; print_r($excemption[$d]->excemption);
								          if(($excemption[$d]->excemption!= 0)&&($excemption[$d]->excemption!='')){
									         $flag=1;
									             } else {
									        $flag=0;
									        	}
								     	 	}
										 }//echo $flag; echo $vendor_id; echo '</br>';
								 /* } else {

								  $sql2 = "SELECT id  FROM #__cam_vendor_workers_companies_insurance WHERE WCI_end_date>= '".$today."' and WCI_status = 1 AND vendor_id=".$vendor_id;
								  $db->Setquery($sql2);
								  $WCI = $db->loadResultArray();
								  $WCI_cnt = count($WCI) ;
								  if($WCI_cnt == 0){
								  $flag = 1;
								  		}
									} */
							    }
					       case 12:
							if($flag==0){
								$sql = "SELECT GLI_policy_aggregate FROM #__cam_vendor_liability_insurence  WHERE GLI_end_date>='".$today."'and GLI_status = 1 AND vendor_id=".$vendorsinfo[$i]->id;
								 // $sql = "SELECT sum(GLI_policy_aggregate)  FROM #__cam_vendor_liability_insurence  WHERE GLI_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;
								  $db->Setquery($sql);
								  $amount = $db->loadObjectlist();
							//echo "<pre>"; print_r($amount);
								  // $amount2 = doubleval(str_replace(",","",$amount1));

								 $spl_amount="SELECT price FROM #__cam_rfpreq_info WHERE rfp_id='".$rfp_id."' and req_subparentid='12'";
								   $db->Setquery($spl_amount);
								  $amount1 = $db->loadResult();
								 // $amount2= str_replace(",", "", $amount1);
								 $amount2 = doubleval(str_replace(",","",$amount1));
								 for($L=0;$L<count($amount); $L++){
								// echo "<pre>"; print_r($amount[$L]->GLI_policy_aggregate);
								          if($amount2 > $amount[$L]->GLI_policy_aggregate){
									         $flag=1;
									             } else {
									        $flag=0;
									        }
								      }
									/*if($amount2 > $amount){
									// echo "<pre>"; print_r($flag);  exit;
									$flag=1;
									} else {
									 $flag=0;
									}*/

								}

							}
							}
				  }
                  if($PLN_needed=='yes'){
                        $sql = "SELECT id  FROM #__cam_vendor_professional_license  WHERE PLN_expdate>= '".$today."'AND PLN_status = 1 AND vendor_id=".$vendorsinfo[$i]->id;
											  $db->Setquery($sql);
											  $PLN = $db->loadResultArray();
											  $PLN_cnt = count($PLN) ;
											 // echo "Vendor ID: ".$vendor_id." ".$PLN_cnt."<br>";
											  if($PLN_cnt== 0){
												$flag = 1;
													}

                     }//switch($main[$m])
				 //print_r($flag); echo "<br>";
				 } //exit;//for($m = 0; $m<count($main); $m++)
			//echo "<pre>"; print_r($vendorsinfo[$i][0]);
			  if($flag == 0)
			  {

			  $vendorsinfo[$i]->email;
			  $vendorid = $vendorsinfo[$i]->id;
			 // echo "<pre>"; print_r($vendorsinfo[$i][0]);
				$vendoremail=$vendorsinfo[$i]->email;
				//echo "<pre>"; print_r($vendoremail);
				$vendor_name=$vendorsinfo[$i]->name.' '.$vendorsinfo[$i]->lastname;
				//code to get Mangaername, Camfirmname
				$user=JFactory::getUser();
				 $Manager = JFactory::getUser($userid);
				$Managername = $Manager->name.'&nbsp;'.$Manager->lastname;
				 $camfirmid_sql = "SELECT comp_id FROM #__cam_customer_companyinfo WHERE cust_id=".$userid;
				$db->SetQuery($camfirmid_sql);
				$camfirmid_res = $db->loadResult();
				if($camfirmid_res == '0')
				$Camfirmname = '';
				else
				{
				  $camfirmid_sql = "SELECT cust_id FROM #__cam_camfirminfo  WHERE id=".$camfirmid_res;
				  $db->SetQuery($camfirmid_sql);
				  $camfirmid_res = $db->loadResult();
				  $camfirmuser = JFactory::getUser($camfirmid_res);
				  $Camfirmname = $camfirmuser->name.'&nbsp;'.$camfirmuser->lastname;
				}
				$sub='RFP Invitation from CAMAssistant';
$cname = "SELECT comp_name FROM #__cam_customer_companyinfo WHERE cust_id=".$userid;
				$db->SetQuery($cname);
				$Camfirmname = $db->loadResult();
				if($vendoremail)
				{

							 $vendorid = $vendorsinfo[$i]->id;
							//$vendoremail = $vendor_email[0]->email;

						//echo "<pre>anand"; print_r( $vendoremail);	//$to = $vendoremail;
							//$vendor_name= $vendor_email[$i][0]->name;
						$vendorid= "SELECT U.email,U.name,U.lastname,U.id FROM #__users as U LEFT JOIN #__cam_vendor_proposals as P ON P.proposedvendorid=U.id WHERE P.rfpno=".$rfp_id." AND P.proposedvendorid=". $vendorid;
				$db->setQuery($vendorid);
				$vendor_email = $db->loadObjectList();

					//echo "<pre>"; print_r($vendor_email );
				//$vendor_name= $vendor_email[0]->name.' '.$vendor_email[0]->lastname;
					if(count($vendor_email)>0) // code to send updated rfp mails
					{
							$updaterfp = "SELECT introtext  FROM #__content where id='163'";
							$db->setQuery($updaterfp);
							$update_rfp = $db->loadResult();
							//echo "<pre>update:"; print_r($vendoremail);
							$from_name='CAMassistant';
							$from_email='Support@CAMassistant.com';
							$sub='Addendum to RFP '.sprintf('%06d', $rfp_id);
							$siteURL		= str_replace('www.','',JURI::root());
							$sql = "SELECT id FROM #__cam_vendor_availablejobs  where rfp_id = ".$rfp_id." AND user_id = ".$vendorsinfo[$i]->id;
							$db->Setquery($sql);
							$result = $db->loadResult();
						//print_r($result);
							if(count($result)>0)
							{
								$sql = "SELECT id,Alt_bid,proposedvendorid,rfpno FROM #__cam_vendor_proposals  where rfpno = ".$rfp_id." AND proposedvendorid= ".$vendorsinfo[$i]->id;
								$db->Setquery($sql);
								$prp_cnt = $db->loadObjectList();
								//echo "<pre>"; print_r($prp_cnt);
								for($k=0;$k<count($prp_cnt);$k++)
								{
									$link = $siteURL.'index.php?option=com_camassistant&controller=proposals&Alt_Prp='.$prp_cnt[$k]->Alt_bid.'&task=Proposal_edit&Proposal_id='.$prp_cnt[$k]->id.'&vendor_id='.$prp_cnt[$k]->proposedvendorid.'&rfp_id='.$prp_cnt[$k]->rfpno.'&act=Draft&Itemid=107';
									}
                                                                        $query = "SELECT property_name  FROM #__cam_property WHERE id=".$property_id;
		$db->setQuery($query);
		$propertyName = $db->loadResult();
									$body = $update_rfp;
                                                                        $propertyName = str_replace('_', ' ', $propertyName);
									$body = str_replace('{RFP NUMBER}', sprintf('%06d', $rfp_id), $body);
									$body = str_replace('{vendor Name}', $vendor_name, $body);
									$body = str_replace('{link}', '<a href="'.$link.'">CLICK HERE</a>', $body);
									$body = str_replace('{Property Name}', $propertyName, $body);
                                                                        $body = str_replace('{camName}', 'CAMassitant', $body);
									$body = str_replace('{Managername}', $Managername, $body);
									$body = str_replace('{Camfirmname}', $Camfirmname, $body);
									//$sub='Invitation to RFP '.sprintf('%06d', $rfpid).' from CAMassistant';
									//echo "<pre>update"; print_r($vendoremail);
									$sub='Addendum to RFP '.sprintf('%06d', $rfp_id);
									$from_name='MyVendorCenter';
									$from_email='Support@myvendorcenter.com';
									if($vendoremail != ''){
									$successMail =JUtility::sendMail($from_email, $from_name, $vendoremail, $sub, $body,$mode = 1);
									$supportvendoremail = 'vendoremails@myvendorcenter.com';
									$successMail =JUtility::sendMail($from_email, $from_name, $supportvendoremail, $sub, $body,$mode = 1);
									}
					$sql = "UPDATE #__cam_vendor_proposals SET proposaltype='Draft' where rfpno = ".$rfp_id." AND proposedvendorid= ".$vendorsinfo[$i]->id;
					$db->SetQuery($sql);
					$db->query();
							}
						}
					  else // code to send New invitations

						{
								
                                              $rfpproposals = "SELECT maxProposals  FROM #__cam_rfpinfo where id='".$rfp_id."' ";
							$db->setQuery($rfpproposals);
							$maxprops = $db->loadResult();

							$count_itbs = "SELECT count(id)  FROM #__cam_vendor_proposals where rfpno='".$rfp_id."' ";
							$db->setQuery($count_itbs);
							$total_itbs = $db->loadResult();
                                                        if($total_itbs < $maxprops){
                                                        $rfpinvite = "SELECT introtext  FROM #__content where id='162'";
								$db->setQuery($rfpinvite);
								$inviterfp = $db->loadResult();
								$vendorid = $vendor_email[0]->id;
								$db = &JFactory::getDbo();
								//echo "<pre>top:"; print_r($vendoremail);
								$sql1 = "DELETE FROM #__cam_vendor_availablejobs where rfp_id=".$rfp_id." AND user_id=".$vendorsinfo[$i]->id." AND status='0'";
								$db->SetQuery($sql1);
								$db->query();

///Filtering preferred vendors by sateesh
								$query_prefer = "SELECT  v_id FROM  #__vendor_inviteinfo WHERE (vendortype = 'preferred' or vendortype = 'inhouse') AND status=1 AND userid=".$userid;
								$db->setQuery($query_prefer);
								$preferred_vendors = $db->loadObjectList();
	//							echo "<pre>"; print_r($preferred_vendors);
								if($preferred_vendors){
								foreach($preferred_vendors as $vid){
								$preferred[] = $vid->v_id;
								}
								}
//								echo "<pre>"; print_r($preferred); exit;
								/*if(count($preferred)){
								if(in_array($vendorsinfo[$i][0]->id,$preferred)){
								$publish = 1;
								$vendor_type = 'prefer';
								$vendoremail = $vendoremail;
								}
								else{
								$publish = 0;
								$vendor_type = 'normal';
								$vendoremail = '';
								}
								}
								else{
								$publish = 1;
								$vendor_type = 'prefer';
								$vendoremail = $vendoremail;
								}*/
							//echo "<pre>new:"; print_r($vendoremail);
							//New one
							$result=array_diff($available,$preferred);

if(count($preferred)){

		if(in_array($vendorsinfo[$i]->id,$preferred)){
		$publish = 1;
		$vendor_type = 'prefer';
		$vendoremail = $vendoremail;
		}

		else if($vendorsinfo[$i]->id)
		{
			if(!in_array($vendorsinfo[$i]->id,$preferred))
			{
					if(count($available) > count($result))
					{
						$publish = 0;
						$vendor_type = 'normal';
						$vendoremail = '';
					}
					else
					{
						$publish = 1;
						$vendor_type = 'prefer';
						$vendoremail = $vendoremail;
					}
			}

		}

		else{
		$publish = 0;
		$vendor_type = 'normal';
		$vendoremail = '';
		}
		}

		else{
		$publish = 1;
		$vendor_type = 'prefer';
		$vendoremail = $vendoremail;
		}
		//Completed

								 $sql_rfpmails = "insert into #__cam_rfp_emails values ('','".$rfp_id."','".$vendorsinfo[$i]->id."','".$publish."','".$vendor_type."','".$userid."', '')";
								$db->SetQuery($sql_rfpmails);
								$db->query();
//Completed by sateeesh
								//To check the 	invitation vendor
								$getiv = "SELECT id FROM #__cam_vendor_availablejobs where rfp_id='".$rfp_id."' and user_id='".$vendorsinfo[$i]->id."' ";
								$db->setQuery($getiv);
								$previv = $db->loadResult();
								//Completed
								if($previv == ''){
								$sql = "insert into #__cam_vendor_availablejobs values ('','".$rfp_id."','".$vendorsinfo[$i]->id."','".$property_id."','0','0','0')";
								$db->SetQuery($sql);
								$db->query();
								}
								else {
								$sql_u = "UPDATE #__cam_vendor_availablejobs SET publish='0' where rfp_id = ".$rfp_id." AND user_id= ".$vendorsinfo[$i]->id;
								$db->SetQuery($sql_u);
								$db->query();
								}
								
								$id= $db->insertid();
								$siteURL		= str_replace('www.','',JURI::root());
								$link = $siteURL.'index.php?option=com_camassistant&controller=proposals&Itemid=148&task=vendor_proposal_form&view=proposals&amp;Prp_id='.$property_id.'&id='.$id.'&rfp_id='.$rfp_id.'';
						if($choose_tasks=='3'){
								$vendors = "SELECT introtext FROM #__content where id='155'";
								$db->setQuery($vendors);
								$body = $db->loadResult();
								//$body = $inviterfp;
						} else if(($choose_tasks=='2')||($choose_tasks=='2choose')||($choose_tasks=='Engineer')||($choose_tasks=='Architect')){
								$hirea = "SELECT introtext FROM #__content where id='154'";
								$db->setQuery($hirea);
								$body = $db->loadResult();
						} else {
								$body = $inviterfp;
							}
								//$vendor_name=$vendorsinfo[$i][0]->name.' '.$vendorsinfo[$i][0]->lastname;
								//$body = $inviterfp;
                                                         $query = "SELECT property_name  FROM #__cam_property WHERE id=".$property_id;
		$db->setQuery($query);
		$propertyName = $db->loadResult();
								$propertyName = str_replace('_', ' ', $propertyName);
                $body = str_replace('{RFP NUMBER}', $rfp_id, $body);
								$body = str_replace('{RFP NUMBER}',sprintf('%06d', $rfp_id), $body);

								$body = str_replace('{vendor Name}', $vendor_name, $body);
								$body = str_replace('{link}', '<a href="'.$link.'">CLICK HERE</a>', $body);
								$body = str_replace('{CLICK HERE link}', '<a href="'.$link.'">CLICK HERE</a>', $body);
								$body = str_replace('{Property Name}', $propertyName, $body);
                                                                $body = str_replace('{camName}', 'CAMassitant', $body);
								$body = str_replace('{Managername}', $Managername, $body);
								$body = str_replace('{Camfirmname}', $Camfirmname, $body);
								//echo "<pre>invite";  print_r($vendoremail);
								//end - code to get Mangaername, Camfirmname
								$sub='A NEW Project has been submitted through CAMassistant';
								$from_name='CAMassistant';
								$from_email='Support@CAMassistant.com';
								//echo "<pre>"; print_r($vendoremail); echo "end";
								if($vendoremail != ''){
								$successMail =JUtility::sendMail($from_email, $from_name, $vendoremail, $sub, $body,$mode = 1);

		$to = 'sk4576@gmail.com';
		$successMail =JUtility::sendMail($from_email, $from_name, $to, $sub, $body,$mode = 1);
	    $query_cc ="select ccemail from #__users Where id =".$vendorsinfo[$i]->id;
		$db->setQuery($query_cc);
		$cc = $db->loadResult();
		$cclist = explode(';',$cc);

		for($c=0; $c<count($cclist); $c++){
		$listcc = $cclist[$c];
		if($listcc != ''){
		$res = JUtility::sendMail($from_email, $from_name, $listcc, $sub, $body, $mode=1);
		}
		}

								}
						}}


				}//End if
			   } //exit;// if($flag == 0)
			 } //End for
			} //exit;

	}
  function store3($data){
JTable::addIncludePath(JPATH_COMPONENT.DS.'tables');
$row =& $this->getTable('propertydocs');
$row = JTable::getInstance('propertydocs','Table');
        if (!$row->bind($data)) {
                $this->setError($this->_db->getErrorMsg());
                return false;
        }
        if (!$row->check()) {
                $this->setError($this->_db->getErrorMsg());
                return false;
        }
        if (!$row->store()) {
                $this->setError($row->getErrorMsg());
                return false;
        }
        return true;
}
	function  proposalCentre_active_inactive($id)
	{
		$db = JFactory::getDBO();
		$user = JFactory::getUser($id);
        //$today  = date('m-d-Y');
		$query ="select industry_id from #__cam_vendor_industries Where user_id =".$user->id;
		$db->setQuery($query);
		$getindustryids = $db->loadResultArray();
		if($getindustryids)
		{
		if(in_array('56',$getindustryids))
		$PLN_needed = 'yes';
		else $PLN_needed = 'no';
		}
		else
		$PLN_needed = 'no';
		$alert['PLN_needed'] = $PLN_needed;
		$user_type = $user->get('user_type');
		$alert_sql ="SELECT count(*) from #__cam_vendor_liability_insurence  WHERE GLI_end_date  >= '".$today."' AND GLI_upld_cert!= '' AND GLI_policy_occurence!='' AND GLI_policy_aggregate!='' AND GLI_status!='-1' AND vendor_id=".$user->id; //validation to exists of docs
		$db->Setquery($alert_sql);
		$res = $db->loadResult();
		//echo '<pre>'; print_r($res);
		$alert['GLI_exist']= $res;
		//echo '<pre>'; print_r($alert);
		$alert_sql ="SELECT count(*) from #__cam_vendor_compliance_w9docs  WHERE w9_upld_cert!='' AND w9_status!='-1' AND vendor_id=".$user->id; //validation to exists of docs
		$db->Setquery($alert_sql);
		$res2 = $db->loadResult();
		$alert['W9_exist']= $res2;

		$alert_sql ="SELECT count(*) from #__cam_vendor_liability_insurence  WHERE GLI_status = 1 AND vendor_id=".$user->id;
		//$alert_sql = "SELECT count(*) from #__cam_vendor_liability_insurence WHERE GLI_status = 1 AND vendor_id=".$user->id."  AND id=(SELECT MIN(id) from #__cam_vendor_liability_insurence where vendor_id=".$user->id.")";
		$db->Setquery($alert_sql);
		$res3 = $db->loadResult();
		if($res3 != 0) $res3=0; else $res3=1;
		$alert['GLI_status']= $res3;

		$alert_sql ="SELECT count(*) from #__cam_vendor_compliance_w9docs  WHERE w9_status != 1 AND vendor_id=".$user->id; //validation to status of docs
		$db->Setquery($alert_sql);
		$res4 = $db->loadResult();
		$alert['W9_status']= $res4;
		$today = date('Y-m-d');

		$alert_sql ="SELECT count(*) from #__cam_vendor_professional_license  WHERE PLN_status = 1 AND vendor_id=".$user->id;
		$db->Setquery($alert_sql);
		$res5 = $db->loadResult();
		if($res5 != 0) $res5=0; else $res5=1;
		$alert['PLN_status']= $res5;

		$alert_sql ="SELECT count(*) from #__cam_vendor_professional_license  WHERE PLN_expdate  >= '".$today."' AND PLN_status = 1 AND vendor_id=".$user->id;
		$db->Setquery($alert_sql);
		$res6 = $db->loadResult();
		if($res6 != 0) $res6=0; else $res6=1;
		$alert['PLN_exp']= $res6;

		$alert_sql ="SELECT count(*) from #__cam_vendor_professional_license  WHERE PLN_expdate  >= '".$today."' AND PLN_state!='' AND PLN_type!='' AND PLN_upld_cert!='' AND PLN_status!='-1' AND vendor_id=".$user->id;
		$db->Setquery($alert_sql);
		$res7 = $db->loadResult();
		$alert['PLN_exist']= $res7;
		$alert_sql ="SELECT count(*) from #__cam_vendor_liability_insurence   WHERE GLI_end_date  >= '".$today."' AND GLI_status = 1 AND vendor_id=".$user->id;
		$db->Setquery($alert_sql);
		$res8 = $db->loadResult();
		if($res8 != 0) $res8=0; else $res8=1;
		$alert['GLI_exp']= $res8;
		//echo "<pre>"; print_r($alert);
		return $alert;
	}
			//code to validate RFP special requirements against vendor docs
	function RFP_specialrequirments_validation($rfpid,$vendor_id)
	{
			$flag = 0;
			$db=&JFactory::getDBO();
            $today  = date('Y-m-d');
			//code to validate specialrequirements
			$sql = "SELECT distinct(req_parentid ) FROM #__cam_rfpreq_info WHERE rfp_id ='".$rfpid."'";
			$db->Setquery($sql);
			$main = $db->loadResultArray();
			$sql = "SELECT req_subparentid  FROM #__cam_rfpreq_info WHERE req_subparentid !=0 AND rfp_id ='".$rfpid."'";
			$db->Setquery($sql);
			$sub = $db->loadResultArray();
            $query ="select industry_id from #__cam_vendor_industries Where user_id =".$vendor_id;
		$db->setQuery($query);
		$getindustryids = $db->loadResultArray();
		if($getindustryids)
		{
		if(in_array('56',$getindustryids))
		$PLN_needed = 'yes';
		else $PLN_needed = 'no';
		}
		else
		$PLN_needed = 'no';
       // echo $vendor_id.':'.$PLN_needed;
			// echo "<pre>"; print_r($main); print_r($sub);
			for($m = 0; $m<count($main); $m++)
			{
				if($flag == 0)
				{
				  switch($main[$m])
				  {


				  case 1:
				  			if($flag == 0)
							{
							 for($h=0;$h<count($sub); $h++)
							 {
							  //echo '<pre>'; print_r($sub[$h]); echo '';
								 //switch($sub[$h])
								  //{
								// echo $sub[$h];


									//case 17: //echo 'anand';
									         if($flag == 0 && $sub[$h]=='17')
							                 {
											   $sql = "SELECT id  FROM #__cam_vendor_professional_license  WHERE PLN_expdate>= '".$today."'AND PLN_status = 1 AND vendor_id=".$vendor_id;
											  $db->Setquery($sql);
											  $PLN = $db->loadResultArray();
											  $PLN_cnt = count($PLN) ;
											 // echo "Vendor ID: ".$vendor_id." ".$PLN_cnt."<br>";
											  if($PLN_cnt== 0){
												$flag = 1;
													}
											  }
											//echo $flag;
								   //case 18:
									          if($flag == 0 && $sub[$h]=='18' )
							                 {
												  $sql = "SELECT id  FROM #__cam_vendor_occupational_license WHERE OLN_expdate>= '".$today."' AND OLN_status = 1 AND vendor_id=".$vendor_id;
												  $db->Setquery($sql);
												  $OLN = $db->loadResultArray();
												  $OLN_cnt = count($OLN) ;
												  if($OLN_cnt== 0){
														$flag = 1;
													}
											 }


									//} //switch($sub[$h])
								} //for($h=0;$h<count($sub); $h++)
							}
				   case 3:

						    if($flag == 0)
							{
								for($s=0;$s<count($sub); $s++)
								{
									  switch($sub[$s])
									  {

										 case 11:
												if($flag==0)
												{
								  $sql56 = "SELECT req_id  FROM #__cam_rfpreq_info WHERE rfp_id=".$rfpid;
								  $db->Setquery($sql56);
								  $req_id = $db->loadResult();
							 $sql2 = "SELECT id  FROM #__cam_vendor_workers_companies_insurance WHERE WCI_end_date>= '".$today."' and WCI_status = 1 AND vendor_id=".$vendor_id;
								  $db->Setquery($sql2);
								  $WCI = $db->loadResultArray();
								  $WCI_cnt = count($WCI) ;
								  if($WCI_cnt == 0){
								  $flag = 1;
								  		}
								if ($req_id=='19' &&  $flag=='0'){
							 	    $sql26 = "SELECT excemption  FROM #__cam_vendor_workers_companies_insurance WHERE WCI_end_date>= '".$today."' and WCI_status = 1 AND vendor_id=".$vendor_id;
									$db->Setquery($sql26);
								   $excemption = $db->loadObjectlist();
								  //$excemption=$excemption1[0]->excemption;
								  //echo "<pre>"; print_r($excemption);
								  // $WCI_cnt1 = count($excemption) ;
								   for($d=0;$d<count($excemption); $d++){
								//echo "<pre>"; print_r($excemption[$d]->excemption);
								          if(($excemption[$d]->excemption!= 0)&&($excemption[$d]->excemption!='')){
									         $flag=1;
									             } else {
									        $flag=0;
									        	}
								     	 	}
										 }//echo $flag; echo $vendor_id; echo '</br>';
								 /* } else {

								  $sql2 = "SELECT id  FROM #__cam_vendor_workers_companies_insurance WHERE WCI_end_date>= '".$today."' and WCI_status = 1 AND vendor_id=".$vendor_id;
								  $db->Setquery($sql2);
								  $WCI = $db->loadResultArray();
								  $WCI_cnt = count($WCI) ;
								  if($WCI_cnt == 0){
								  $flag = 1;
								  		}
									} */
							    }
										  case 12:
												if($flag==0)
												{
												  $sql = "SELECT sum(GLI_policy_aggregate)  FROM #__cam_vendor_liability_insurence  WHERE GLI_end_date  >= '".$today."' AND GLI_status = 1 AND vendor_id=".$vendor_id;
													  $db->Setquery($sql);
													  $amount = $db->loadResult();
//echo 'anand1'; print_r($amount);
													  $spl_amount="SELECT price FROM #__cam_rfpreq_info WHERE rfp_id='".$rfpid."' and req_subparentid='12'";
													  $db->Setquery($spl_amount);
													  $amount1 = $db->loadResult();
													  $amount2 = doubleval(str_replace(",","",$amount1));
                                                      if($amount){
														if($amount2 > $amount){
														$flag=1;
														} else {
														 $flag=0;
														}
                                                      } else {
                                                        $flag=1;
                                                      }
												}
									  } //switch($main[$m])
								} //for($s=0;$s<count($sub); $s++)
							}
				 }
                 if($PLN_needed=='yes'){
                        $sql = "SELECT id  FROM #__cam_vendor_professional_license  WHERE PLN_expdate>= '".$today."'AND PLN_status = 1 AND vendor_id=".$vendor_id;
											  $db->Setquery($sql);
											  $PLN = $db->loadResultArray();
											  $PLN_cnt = count($PLN) ;
											 // echo "Vendor ID: ".$vendor_id." ".$PLN_cnt."<br>";
											  if($PLN_cnt== 0){
												$flag = 1;
													}

                     }
				}
			}	//for($m = 0; $m < count($main); $m++)
			//echo $flag;
//exit;
			 return $flag;
	}

	   //code to show deleted ITB in Available jobs
		function get_openjobs($rfpid)
		{
			$db		= JFactory::getDBO();
			$user 	= JFactory::getUser();
			$today  = date('m-d-Y');
			//to get RFP info
			$rfp_details	= "SELECT property_id,cust_id,industry_id,choose_tasks FROM #__cam_rfpinfo where id='".$rfpid."' AND publish=1 AND proposalDueDate >= '".$today."' ";
			$db->Setquery($rfp_details);
			$details1		=  $db->loadObjectList();

			$industry_id	=  $details1[0]->industry_id;
			$userid			=  $details1[0]->cust_id;
			$property_id	=  $details1[0]->property_id;

			//to get eligible vendors list
			$vendorsinfo	=	$this->getVendors($userid,$property_id,$rfpid);
			//echo "<pre>"; print_r($vendorsinfo); exit;
			if(count($vendorsinfo)>0)
			{
				for($i=0; $i<count($vendorsinfo); $i++)
				{

					$sql = "SELECT id FROM #__cam_vendor_availablejobs  where status = 0 AND rfp_id = ".$rfpid." AND user_id = ".$vendorsinfo[$i][0]->id;
					$db->Setquery($sql);
					$res3 = $db->loadResult();
					$flag = $this->RFP_specialrequirments_validation($rfpid,$vendorsinfo[$i][0]->id);
					if($res3 == '' && $flag == 0)
					{
					$sql = "insert into #__cam_vendor_availablejobs values ('','".$rfpid."','".$vendorsinfo[$i][0]->id."','".$property_id."','0','1','0')";
					$db->SetQuery($sql);
					$db->query();
					}
				}
			} //if(count($vendorsinfo)>0)
		}

 	function delete($cid = array())
	{
		$result = false;


		if (count( $cid ))
		{
			$cids = implode( ',', $cid );
			$query = 'DELETE FROM #__cam_vendor_proposals WHERE id IN ( '.$cids.' )';
			$this->_db->setQuery( $query );
			if(!$this->_db->query()) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}
		}

		return true;
	}

	function _buildContentOrderBy2()
	{
		global $mainframe, $context;

		//DEVNOTE:give me ordering from request
		//$filter_order     = $mainframe->getUserStateFromRequest( $context.'filter_order',      'filter_order', 	  'ordering' );
		if($_REQUEST['filter_order'] == '')
		$filter_order = 'U.name';
		else
		$filter_order = $_REQUEST['filter_order'];
		$filter_order_Dir = $mainframe->getUserStateFromRequest( $context.'filter_order_Dir',  'filter_order_Dir', '' );

		//DEVNOTE: all countries are in the same category(no category)
		$orderby 	= ' ORDER BY  '. $filter_order .' '. $filter_order_Dir;
		return $orderby;
	}

	//function to get available bids for an RFP
	function rfp_bids()
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$rfp_id = JRequest::getVar('rfp_id','');
		$user_id = JRequest::getVar('userid','');
		$var = JRequest::getVar('var','');
		$status = JRequest::getVar('rfpstatus','');
		$types = JRequest::getVar('types','');
		$orderby = $this->_buildContentOrderBy2();
		if($var =='submit'){
		$query = "SELECT U.name, U.lastname, U.email, U.ccemail, U.username, U.flag, U.suspend, U.password, q.id as vendor_id, q.company_name,q.company_phone,U.cellphone,q.alt_phone,r.awardeddate, P.* FROM #__cam_vendor_company  as q, #__cam_rfpinfo as r, #__cam_vendor_proposals as P LEFT JOIN #__users as U on U.id = P.proposedvendorid WHERE (P.proposaltype='Submit' OR P.proposaltype='resubmit') AND r.id=".$rfp_id." and P.rfpno =".$rfp_id.' and q.user_id=U.id '.$orderby;
		}
		else if($types == 'pendingrfps'){
		//$query = "SELECT U.name, U.lastname, U.email, U.ccemail, U.username, U.flag, U.suspend, U.password, q.id as vendor_id, q.company_name,q.company_phone,U.cellphone,q.alt_phone,r.awardeddate, P.date as proposeddate, P.vendorid as proposedvendorid, P.id as prpsids FROM #__cam_vendor_company  as q, #__cam_rfpinfo as r, #__rfp_invitations as P LEFT JOIN #__users as U on U.id = P.vendorid WHERE r.id=".$rfp_id." and P.rfpid =".$rfp_id.' and q.user_id=U.id '.$orderby;
		$query = "SELECT U.name, U.lastname, U.email, U.ccemail, U.username, U.flag, U.suspend, U.password, q.id as vendor_id, q.company_name,q.company_phone,U.cellphone,q.alt_phone,r.awardeddate, P.* FROM #__cam_vendor_company  as q, #__cam_rfpinfo as r, #__cam_vendor_proposals as P LEFT JOIN #__users as U on U.id = P.proposedvendorid WHERE r.id=".$rfp_id." and P.rfpno =".$rfp_id.' and q.user_id=U.id '.$orderby;
		}
		else{
		$query = "SELECT U.name, U.lastname, U.email, U.ccemail, U.username, U.flag, U.suspend, U.password, q.id as vendor_id, q.company_name,q.company_phone,U.cellphone,q.alt_phone,r.awardeddate, P.* FROM #__cam_vendor_company  as q, #__cam_rfpinfo as r, #__cam_vendor_proposals as P LEFT JOIN #__users as U on U.id = P.proposedvendorid WHERE r.id=".$rfp_id." and P.rfpno =".$rfp_id.' and q.user_id=U.id '.$orderby;
		//$query = "SELECT U.name, U.lastname, U.email, U.ccemail, U.username, U.flag, U.suspend, U.password, q.id as vendor_id, q.company_name,q.company_phone,U.cellphone,q.alt_phone,r.awardeddate, P.date as proposeddate, P.* FROM #__cam_vendor_company  as q, #__cam_rfpinfo as r, #__rfp_invitations as P LEFT JOIN #__users as U on U.id = P.vendorid WHERE r.id=".$rfp_id." and P.rfpid =".$rfp_id.' and q.user_id=U.id '.$orderby;
		}
		if($var =='submit' && $status == 'awarded'){
		$query = "SELECT U.name, U.lastname, U.email, U.ccemail, U.username, U.password, q.id as vendor_id, q.company_name,q.company_phone,U.cellphone,q.alt_phone,r.awardeddate, P.* FROM #__cam_vendor_company  as q, #__cam_rfpinfo as r, #__cam_vendor_proposals as P LEFT JOIN #__users as U on U.id = P.proposedvendorid WHERE (P.proposaltype='Awarded' OR P.proposaltype='Unawarded') AND r.id=".$rfp_id." and P.rfpno =".$rfp_id.' and q.user_id=U.id '.$orderby;
		}
		$db->setQuery($query);
		$bids_list = $db->loadObjectList();
		//echo "<pre>"; print_r($bids_list); exit;
		return $bids_list;
	}

function store($data)
	{
	/* 	echo "<pre>";
		print_r($data);
		print_r($row);exit;*/
		// give me JTable object
		$row =& $this->getTable();

		jimport('joomla.user.helper');

		// Bind the form fields to the  table
		if (!$row->bind($data)) {

			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		// Store the  detail record into the database
		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}
	//
	function get_tempLineTasks($rfpid)
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$query = "SELECT * FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfpid." ORDER BY task_id ASC";
		$db->setQuery($query);
		$TempLineItems = $db->loadObjectList();
		return $TempLineItems;
	}
	function store_update($data)
	{
		// give me JTable object
		$row =& $this->getTable();
		/*echo "<pre>";
		print_r($data);
		print_r($row);exit;*/
		jimport('joomla.user.helper');

		// Bind the form fields to the  table
		if (!$row->bind($data)) {

			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		// Store the  detail record into the database
		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}
	//
	function tasks_store($data)
	{
	 	// give me JTable object
		$row =& $this->getTable('sowlinetasks');
	/*	echo "789<pre>";
		print_r($data);
		exit;*/
		jimport('joomla.user.helper');

		// Bind the form fields to the  table
		if (!$row->bind($data)) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		// Store the  detail record into the database
		if (!$id=$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
      $id = $this->_db->insertid();
		return $id;
		//return true;
	}
	//Storing line Items to maintain temparary records for the last modification details

	//
	function reqdocs_store($data)
	{
	 	// give me JTable object
		$row =& $this->getTable('sowdocs');
		/*echo "789<pre>";
		print_r($data);
		print_r($row);exit;*/
        jimport('joomla.user.helper');

		// Bind the form fields to the  table
		if (!$row->bind($data)) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		// Store the  detail record into the database
		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}
	//
	function rfpsplreqs_store($data)
	{
	 	// give me JTable object
		$row =& $this->getTable('rfpreqinfo');
		jimport('joomla.user.helper');
	/*	echo "789<pre>";
		print_r($data);
		print_r($row);exit;*/
		// Bind the form fields to the  table
		if (!$row->bind($data)) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		// Store the  detail record into the database
		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}
/*	function getPManagers($property_id)
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$query = "SELECT property_manager_id FROM #__cam_property WHERE id=".$property_id;
		$db->setQuery($query);
		$property_manager_id = $db->loadResult();
		$query2 = "SELECT id,name,email,phone FROM #__users WHERE id=".$property_manager_id;
		$db->setQuery($query2);
		$pmdetails = $db->loadObjectList();
		return $pmdetails;
	}*/

	function getVendor_bidsinfo($arr,$rfp_id)
	{
	//echo "<pre>"; print_r($arr);
		$db=&JFactory::getDBO();
		for($i=0,$j=0; $i<count($arr); $i++)
		{
			$flag = $this->RFP_specialrequirments_validation($rfp_id,$arr[$i][0]->id);
//echo $flag.'<br>';
			if($flag == 0)
			{
				$new_arr[$j]	=	$arr[$i];
				//echo '<pre>'; print_r($arr[$i][0]->id);
			 	 $sql = "SELECT id, proposaltype, publish FROM #__cam_vendor_proposals WHERE Alt_bid != 'yes' AND  proposedvendorid	=	".$arr[$i][0]->id." AND rfpno = ".$rfp_id;
				$db->setQuery($sql);
				$res = $db->loadObjectList();
				if(count($arr) != 0)
				{
					$new_arr[$j][0]->proposal_id	=	$res[0]->id;
					$new_arr[$j][0]->proposaltype	=	$res[0]->proposaltype;
					$new_arr[$j][0]->publish		=	$res[0]->publish;
				}
				$j++;
			}

		}
		//echo "<pre>"; print_r($new_arr);
		return $new_arr;
	}
function getVendor_bidsinfo_in($arr,$rfp_id)
	{
	//echo "<pre>"; print_r($arr);
		$db=&JFactory::getDBO();
		for($i=0,$j=0; $i<count($arr); $i++)
		{
			$flag = $this->RFP_specialrequirments_validation($rfp_id,$arr[$i][0]->id);
			//echo $arr[$i][0]->id;
			//echo $flag; echo '</br>';

			if($flag == 1)
			{
				$new_arr[$j]	=	$arr[$i];
			 	$sql = "SELECT id, proposaltype, publish FROM #__cam_vendor_proposals WHERE Alt_bid != 'yes' AND  proposedvendorid	=	".$arr[$i][0]->id." AND rfpno = ".$rfp_id;
				$db->setQuery($sql);
				$res = $db->loadObjectList();
				if(count($arr) != 0)
				{
					$new_arr[$j][0]->proposal_id	=	$res[0]->id;
					$new_arr[$j][0]->proposaltype	=	$res[0]->proposaltype;
					$new_arr[$j][0]->publish		=	$res[0]->publish;
				}
				$j++;
			}

		} //exit;
		return $new_arr;
	}
	//Function to get Vendors details for particular Industry
	function getVendors($userid,$property_id,$rfp_id)
	{
	   // print_r($userid);  echo '<br>';
		//print_r($property_id);  echo '<br>';

		global $mainframe;
		$db=&JFactory::getDBO();
		$user =& JFactory::getUser();
        $comp_zip = $user->get('comp_zip');
		$countyid = "SELECT divcounty FROM #__cam_property  WHERE  id=".$property_id;
		$db->setQuery($countyid);
		$comid = $db->loadResult();

		$county_sql = "SELECT distinct(user_id) FROM  #__vendor_state_counties  WHERE county_id = ".$comid;
		$db->setQuery($county_sql);
		$vendor_ids = $db->loadObjectList();
		//echo "<pre>"; print_r($vendor_ids);

        $industry_id = "SELECT industry_id,industry_id2 FROM  #__cam_rfpinfo  WHERE id = ".$rfp_id;
		$db->setQuery($industry_id);
		$industrys = $db->loadObject();
		$industryid = $industrys->industry_id;
		$industryid2 = $industrys->industry_id2;


	    $industry_detail = "SELECT industry_id FROM  #__cam_rfpindustries  WHERE rfpid = ".$rfp_id;
		$db->setQuery($industry_detail);
		$industry_ids = $db->loadObjectList();
		//echo "<pre>"; print_r($industry_ids); exit;

		for($l=0; $l<count($industry_ids); $l++) {
		if($l>0){
		$industry_ids[$l]->industry_id = " OR industry_id=".$industry_ids[$l]->industry_id;
		}
		else{
		$industry_ids[$l]->industry_id = "industry_id=".$industry_ids[$l]->industry_id;
		}
		$or_industry = $or_industry.$industry_ids[$l]->industry_id ;
		}

if($industryid && !$or_industry){
        $or_industry= " industry_id=".$industryid;
   } else if($or_industry && !$industryid){
       $or_industry= $or_industry;
   } else {
      $or_industry = $or_industry." OR industry_id=".$industryid;
   }
    if($industryid2 != '0'){
	$or_industry = $or_industry." OR industry_id=".$industryid2;
	}
	
	for($i=0; $i<count($vendor_ids); $i++)
		{
	   $ind_sql = "SELECT user_id FROM  #__cam_vendor_industries  WHERE user_id = ".$vendor_ids[$i]->user_id." AND (".$or_industry.") ";
	//echo "<br><br>";
		$db->setQuery($ind_sql);
		$vendorids[$i] = $db->loadResult();
		}
 //echo '<pre>'; print_r($vendorids);exit;
		$query1 = "SELECT  v_id FROM  #__vendor_inviteinfo WHERE vendortype = 'exclude' AND userid=".$userid;
		$db->setQuery($query1);
		$v_id = $db->loadObjectList();
		//echo "<pre>"; print_r($vendorids); echo '<br>';

		if($v_id){
		foreach($v_id as $vid){
		$exvid[] = $vid->v_id;
		}
		if($vendorids)
		$result_appvendors = array_diff($vendorids, $exvid);

		}
		else{
		$result_appvendors = $vendorids;
		}
		//echo "<pre>"; print_r($result_appvendors); exit;
		$vendorsinfo=array();
		$j=0;
		for($k=0;$k<=count($result_appvendors);$k++){
	//	echo end($result_appvendors);
			$query2 = "SELECT u.id as id, c.id as vid, u.name,u.lastname,u.flag,u.suspend,u.email,c.company_phone,c.company_name,u.cellphone,c.alt_phone,u.username,u.password FROM #__users as u LEFT JOIN #__cam_vendor_company as c ON c.user_id=u.id WHERE u.block=0 and u.id=".$result_appvendors[$k] ;
			$db->setQuery($query2);
			$result = $db->loadObjectList();

			if($result)
			{
			$vendorsinfo[$j]=$result;
			$j++;
			}


	}	//echo "<pre>"; print_r($vendorsinfo);
		//exit;
		return $vendorsinfo;

	}
	function _buildContentOrderBy1()
	{
		global $mainframe, $context;

		//DEVNOTE:give me ordering from request
		//$filter_order     = $mainframe->getUserStateFromRequest( $context.'filter_order',      'filter_order', 	  'ordering' );
		$filter_order		= JRequest::getWord('filter_order');
		if($filter_order == '')
		$filter_order = 'name';
		else
		$filter_order = $filter_order;
		$filter_order_Dir = $mainframe->getUserStateFromRequest( $context.'filter_order_Dir',  'filter_order_Dir', '' );

		//DEVNOTE: all countries are in the same category(no category)
		$orderby 	= ' ORDER BY  '. $filter_order .' '. $filter_order_Dir;

		return $orderby;
	}
function getvendorslist() {

		global $mainframe;
		$db=&JFactory::getDBO();

	//$orderby	= $this->_buildContentOrderBy1();
	  $industryid = JRequest::getVar('industryid');
	  $industry_id = JRequest::getVar('industry_id');
      if($industryid){
         $industry_id=$industryid;
      }
	  $divcounty = JRequest::getVar('divcounty');
	  $special = JRequest::getVar('special');
	  $state = JRequest::getVar('state');
	  $sql = "SELECT id FROM #__state where state_id=".$state;
	  $db->Setquery($sql);
	  $states = $db->loadResult();

	  if( $divcounty && $industry_id){
	   $where='and I.industry_id='.$industry_id.' and SC.county_id='.$divcounty;
	   } else if($divcounty){
	   $where = 'and SC.county_id='.$divcounty;
	  } else if($industry_id){
	  $where='and I.industry_id='.$industry_id.'';
	  } else {
	   $where='';
	  }

	  /*if($industry_id){
	  $where[]='and I.industry_id='.$industry_id.'';
	  }
	  if($divcounty){
	  $where[] = 'SC.county_id='.$divcounty;
	  }
	  if($where){
	  $where=implode(' and ',$where);
	  }*/
	  //if($where){
	  $groupby =' GROUP BY I.user_id';
	 // }

	/*  if($industry_id && $divcounty && $state){
	   $where1 = ' and I.industry_id='.$industry_id.' and SC.county_id='.$divcounty.' GROUP BY I.user_id';
	  } else if($industry_id){
	  $where1 = ' and I.industry_id='.$industry_id.' GROUP BY I.user_id';
	  } else if($divcounty && $state){
	  $where1 = ' and SC.county_id='.$divcounty;
	  } else {
	  $where1 = ' GROUP BY I.user_id';
	  }*/



	  if($special=='pro'){
	 $left = ' LEFT JOIN #__cam_vendor_professional_license as VP ON VP.vendor_id=U.id';
	 $where2 =' and VP.vendor_id=U.id and PLN_status=1';
	  } else if($special=='occ'){
	$left = ' LEFT JOIN #__cam_vendor_occupational_license as VO ON VO.vendor_id=U.id';
	  $where2 =' and VO.vendor_id=U.id and OLN_status=1';
	} else if($special=='work'){
	 $left = ' LEFT JOIN #__cam_vendor_workers_companies_insurance as VW ON VW.vendor_id=U.id';
	  $where2 =' and  VW.vendor_id=U.id and WCI_status=1 ';
	 } else if($special=='general'){
	 $left = ' LEFT JOIN #__cam_vendor_liability_insurence as VL ON VL.vendor_id=U.id';
	  $where2 =' and  VL.vendor_id=U.id and GLI_status=1';
	 }
	// print_r($_REQUEST['limit']);
	 $limit=$_REQUEST['limit'];
	 	 $limitstart=$_REQUEST['limitstart'];
if(!$limit){
$limit			= $mainframe->getUserStateFromRequest( $context.'limit', 'limit', $mainframe->getCfg('list_limit'), 0);
$limitstart = $mainframe->getUserStateFromRequest( $context.'limitstart', 'limitstart', 0 );
}


	 if($limit){
		$limit1= "LIMIT ".$limitstart.",".$limit;
		}
//echo '<pre>'; print_r();
     $query = ' SELECT  V.id,
 V.user_id,V.status,V.company_name,V.company_phone,U.name,U.lastname,U.email,U.username,U.flag,U.suspend,U.registerDate,U.block as published  FROM
	    #__users as U LEFT JOIN #__cam_vendor_company as V ON V.user_id = U.id LEFT JOIN #__cam_vendor_industries as I ON I.user_id=U.id LEFT JOIN #__vendor_state_counties as SC ON SC.user_id=U.id '.$left.' WHERE U.user_type = 11 '.$where2.' '.$where.' '.$groupby.' '.$limit1;

	 $db->setQuery($query);
	$getvendors = $db->loadObjectList();
	return $getvendors;
	}

	function getvendorslist1() {

	global $mainframe;
	$db=&JFactory::getDBO();
	//$orderby	= $this->_buildContentOrderBy1();
	  $industryid = JRequest::getVar('industryid');
	  $industry_id = JRequest::getVar('industry_id');
      if($industryid){
         $industry_id=$industryid;
      }
	  $divcounty = JRequest::getVar('divcounty');
	  $special = JRequest::getVar('special');
	  $state = JRequest::getVar('state');
	  $sql = "SELECT id FROM #__state where state_id=".$state;
	  $db->Setquery($sql);
	  $states = $db->loadResult();

	  if( $divcounty && $industry_id){
	   $where='and I.industry_id='.$industry_id.' and SC.county_id='.$divcounty;
	   } else if($divcounty){
	  $where = 'and SC.county_id='.$divcounty;
	  } else if($industry_id){
	  $where='and I.industry_id='.$industry_id.'';
	  } else {
	   $where='';
	  }
	  /*if($industry_id){
	  $where[]='and I.industry_id='.$industry_id.'';
	  }
	  if($divcounty){
	  $where[] = 'SC.county_id='.$divcounty;
	  }
	  if($where){
	  $where=implode(' and ',$where);
	  }*/
	  //if($where){
	  $groupby =' GROUP BY I.user_id ';
	 // }

	/*  if($industry_id && $divcounty && $state){
	   $where1 = ' and I.industry_id='.$industry_id.' and SC.county_id='.$divcounty.' GROUP BY I.user_id';
	  } else if($industry_id){
	  $where1 = ' and I.industry_id='.$industry_id.' GROUP BY I.user_id';
	  } else if($divcounty && $state){
	  $where1 = ' and SC.county_id='.$divcounty;
	  } else {
	  $where1 = ' GROUP BY I.user_id';
	  }*/



	  if($special=='pro'){
	 $left = ' LEFT JOIN #__cam_vendor_professional_license as VP ON VP.vendor_id=U.id';
	 $where2 =' and VP.vendor_id=U.id and PLN_status=1';
	  } else if($special=='occ'){
	$left = ' LEFT JOIN #__cam_vendor_occupational_license as VO ON VO.vendor_id=U.id';
	  $where2 =' and VO.vendor_id=U.id and OLN_status=1';
	} else if($special=='work'){
	 $left = ' LEFT JOIN #__cam_vendor_workers_companies_insurance as VW ON VW.vendor_id=U.id';
	  $where2 =' and  VW.vendor_id=U.id and WCI_status=1 ';
	 } else if($special=='general'){
	 $left = ' LEFT JOIN #__cam_vendor_liability_insurence as VL ON VL.vendor_id=U.id';
	  $where2 =' and  VL.vendor_id=U.id and GLI_status=1';
	 }

    $query = ' SELECT  V.id,
 V.user_id,V.status,V.company_name,V.company_phone,U.name,U.lastname,U.email,U.username,U.flag,U.suspend,U.registerDate,U.block as published  FROM
	    #__users as U LEFT JOIN #__cam_vendor_company as V ON V.user_id = U.id LEFT JOIN #__cam_vendor_industries as I ON I.user_id=U.id LEFT JOIN #__vendor_state_counties as SC ON SC.user_id=U.id '.$left.' WHERE U.user_type = 11 '.$where2.' '.$where.' '.$groupby ;

	 $db->setQuery($query);
	$getvendors = $db->loadObjectList();
	return $getvendors;
	}
	//29-11-11
	function getstates()
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$sql = "SELECT * FROM #__state";
		$db->Setquery($sql);
		$states = $db->loadObjectList();
	   return $states;
	}
	/*function getPropertyName($property_id)
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$query = "SELECT property_name  FROM #__cam_property WHERE id=".$property_id;
		$db->setQuery($query);
		$propertyName = $db->loadResult();
		return $propertyName;
	}*///

	//function to display Properties list in the Dropdown
	function getProperties()
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$query = "SELECT id as value,property_name as text FROM #__cam_property ORDER BY id ASC";
		$db->setQuery($query);
		$propertyList = $db->loadObjectList();
		return $propertyList;
	}
	//function to get Property name for displaying in mail the content,....etc
	function getPropertyName($property_id)
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$query = "SELECT property_name  FROM #__cam_property WHERE id=".$property_id;
		$db->setQuery($query);
		$propertyName = $db->loadResult();
		return $propertyName;
	}
	//function to get company id for adding a property
	function getCompanyID($userid)
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$query = "SELECT id FROM #__cam_camfirminfo WHERE cust_id=".$userid;
		$db->setQuery($query);
		$comp_id = $db->loadResult();
		return $comp_id;
	}
	//function to get Tax ids list
	/*function getProperty_TaxIDs()
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$query = "SELECT tax_id FROM #__cam_property ORDER BY id ASC";
		$db->setQuery($query);
		$ptaxid = $db->loadObjectList();
		return $ptaxid;
	}*/
	function getTotal1()
	{
		//DEVNOTE: Lets load the content if it doesn't already exist
		if (empty($this->_total1))
		{
			$query = $this->getvendorslist();
			$this->_total1 = count($query);
			print_r($this->_total1);
		}

		return $this->_total1;
	}
	function getPagination1()
	{
		// Lets load the content if it doesn't already exist
		if (empty($this->_pagination1))
		{
			$query1 = $this->getvendorslist1();
			$total1 = count($query1);
			//echo 'anand'; print_r($total1);
			jimport('joomla.html.pagination');
			$this->_pagination1 = new JPagination( $total1, $this->getState('limitstart'), $this->getState('limit') );
		}
//print_r($this->_pagination1);
		return $this->_pagination1;
	}
		function getTotal()
	{
		//DEVNOTE: Lets load the content if it doesn't already exist
		if (empty($this->_total))
		{
			$query = $this->_buildQuery();
			$this->_total = $this->_getListCount($query);
		}

		return $this->_total;
	}




		function getPagination()
	{
		// Lets load the content if it doesn't already exist
		if (empty($this->_pagination))
		{
			jimport('joomla.html.pagination');

			$this->_pagination = new JPagination( $this->getTotal(), $this->getState('limitstart'), $this->getState('limit') );
		}

		return $this->_pagination;
	}

 function _buildQuery()
	{
	     $industry_id = JRequest::getVar('industry_id');
		 $rfp_status  = JRequest::getVar('rfpstatus');
		  if($rfp_status == 'submitclosed') {
		 $rfp_status_link = "(R.rfp_type ='closed' || R.rfp_type ='rfp')";
		 }
		 else{
		 $rfp_status_link = "R.rfp_type ='".$rfp_status."'";
		 }
		 $search	  = JRequest::getVar('search');
		 $rfpapproval = JRequest::getVar('rfpapproval');
		 $db		=& $this->getDBO();
		 $orderby	= $this->_buildContentOrderBy();
		 //print_r($_REQUEST);
		if(($industry_id && $industry_id!='undefined')&&($rfp_status)&&(($rfpapproval=='0')||($rfpapproval))){
		// $where = " WHERE R.industry_id = '".$industry_id. "' AND R.rfp_type ='".$rfp_status."' AND R.publish ='".$rfpapproval."'";
		 $where = " WHERE R.industry_id = '".$industry_id. "' AND ".$rfp_status_link." AND R.publish ='".$rfpapproval."'";
		 } else if(($industry_id && $industry_id!='undefined')&&($rfp_status)){
		 $where = " WHERE R.industry_id ='".$industry_id."' AND ".$rfp_status_link."";
		// $where = " WHERE R.industry_id ='".$industry_id."' AND R.rfp_type ='".$rfp_status."'";
		 } else if(($rfp_status)&&(($rfpapproval=='0')||($rfpapproval))){
		 $where = " WHERE ".$rfp_status_link." AND R.publish ='".$rfpapproval."'";
		 //$where = " WHERE R.rfp_type ='".$rfp_status."' AND R.publish ='".$rfpapproval."'";
		 } else if(($industry_id && $industry_id!='undefined')&&(($rfpapproval=='0')||($rfpapproval))){
		 $where = " WHERE R.industry_id ='".$industry_id."' AND R.publish ='".$rfpapproval."'";
		 }  else if($industry_id && $industry_id!='undefined'){
		 $where = " WHERE R.industry_id ='".$industry_id."'";
		 } else if(($rfpapproval=='0')||$rfpapproval){
		 $where = " WHERE R.publish ='".$rfpapproval."'";
		 } else if($rfp_status){
		 $where = " WHERE ".$rfp_status_link."";
		 //$where = " WHERE R.rfp_type ='".$rfp_status."'";
		 }  else {
		  $where ='';
		 //$where = " WHERE R.rfp_type ='rfp' and R.publish=1";
		  }
		 //   print_r($search);
		 if($search){
	     //$where = ' WHERE LOWER(R.projectName) LIKE '.$db->Quote( '%'.$db->getEscaped( $search, true ).'%', false );
		 $where = ' WHERE (LOWER(R.projectName) LIKE '.$db->Quote( '%'.$db->getEscaped( $search, true ).'%', false ).' OR R.id="'.$search.'")';
	     }

	  $query = "SELECT R.*,str_to_date(R.proposalDueDate, '%m-%d-%Y') as prolDueDate,str_to_date(R.createdDate, '%m-%d-%Y') as created,str_to_date(R.endDate, '%m-%d-%Y') as end,str_to_date(R.startDate, '%m-%d-%Y') as start,U.email,U.username,U.password,U.name,U.lastname,U.phone, P.proposedvendorid FROM #__cam_rfpinfo as R
	LEFT JOIN #__users as U ON R.cust_id=U.id
	LEFT JOIN #__cam_vendor_proposals as P ON R.id = P.rfpno ".$where." AND R.rfp_type!='review' group by R.id ".$orderby;

		return $query;
	}
	function _buildContentOrderBy()
	{
		global $mainframe, $context;

		//DEVNOTE:give me ordering from request $_REQUEST['filter_order']
		//$filter_order     = $mainframe->getUserStateFromRequest( $context.'filter_order',      'filter_order', 	  'ordering' );
		 $filter=$_REQUEST['filter_order'];
		if(!$_REQUEST['filter_order'])
		 $filter_order = "str_to_date(R.proposalDueDate , '%m-%d-%Y') ASC, R.proposalDueTime ASC";
		else if($filter=='R.proposalDueDate'){

           $filter_order = "str_to_date(R.proposalDueDate , '%m-%d-%Y')";
        } 
		else if($filter=='R.biddingcloseddate'){
		$filter_order = "str_to_date(R.biddingcloseddate , '%m-%d-%Y')";
		}
		
		else if($filter=='R.createdDate')
                {

                    $filter_order = "str_to_date($filter , '%m-%d-%Y')" ;
                }
                else {
                 $filter_order = $filter;
                }
		$filter_order_Dir = $mainframe->getUserStateFromRequest( $context.'filter_order_Dir',  'filter_order_Dir', '' );

		//DEVNOTE: all countries are in the same category(no category)
		//$orderby 	= ' ORDER BY  '. $filter_order .' '. $filter_order_Dir;
		//$orderby 	= ' ORDER BY  '. $filter_order .' DESC';
        if($filter=='R.proposalDueDate'){
        $orderby 	= ' ORDER BY  '. $filter_order.' '.$filter_order_Dir.', R.proposalDueTime ' .$filter_order_Dir;
        } else if(!$_REQUEST['filter_order']){
            $orderby 	= ' ORDER BY  '. $filter_order;
        } else {
          $orderby 	= ' ORDER BY  '. $filter_order.' '.$filter_order_Dir;
        }
		return $orderby;
	}

	function userinfo()
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$user=&JFactory::getuser();
	   $query = 'SELECT CONCAT(U.name," " ,U.lastname) "text",U.id as value FROM #__cam_customer_companyinfo  as R
		LEFT JOIN  #__users as U ON U.id=R.cust_id WHERE U.id!=62 GROUP BY U.id ORDER BY U.name ASC';
		$db->setQuery($query);
		$userinfo = $db->loadObjectlist();
			return $userinfo;
	}
	//function to display Special Requirement Categoies
	function getSplRequiremntCats($pid)
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$query = "SELECT req_id as id,req_title FROM #__cam_rfpreq_categories WHERE req_parentid=".$pid." ORDER BY req_id ASC";
		$db->setQuery($query);
		$reqCatList = $db->loadAssocList();
		return $reqCatList;
	}

		//function to display Special Requirement Category
	function getSplRequiremntCat($sid)
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		 $query = "SELECT req_title FROM #__cam_rfpreq_categories WHERE req_id=".$sid." ";
		$db->setQuery($query);
		$reqCatList = $db->loadresult();
		return $reqCatList;
	}
	//Function to get Property Manager details using property id
	function getPManagers($property_id)
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$query = "SELECT property_manager_id FROM #__cam_property WHERE id=".$property_id;
		$db->setQuery($query);
		$property_manager_id = $db->loadResult();
		$query2 = "SELECT id,name,email,phone FROM #__users WHERE id=".$property_manager_id;
		$db->setQuery($query2);
		$pmdetails = $db->loadObjectList();
		return $pmdetails;
	}
	//Function to get Vendors details for particular Industry
	/*function getVendors($industry_id)
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$query = "SELECT user_id FROM #__cam_vendor_industries WHERE industry_id=".$industry_id;
		$db->setQuery($query);
		$vendorids = $db->loadObjectList();
		for($i=0;$i<count($vendorids);$i++)
		{
			$query2 = "SELECT id,name,email,phone FROM #__users WHERE id=".$vendorids[$i]->user_id;
			$db->setQuery($query2);
			$result = $db->loadObjectList();
			$vendorsinfo[$i]=$result;
		}
		return $vendorsinfo;
	}*/

	function getIndustry()
	{
		global $mainframe;
	 	$db=&JFactory::getDBO();
		$query = "SELECT id as value,industry_name as text FROM #__cam_industries where published ='1' ORDER BY industry_name ASC";
		$db->setQuery($query);
		$industryList = $db->loadObjectList();
		return $industryList;
	}
	function getIndustryname($id)
	{
		global $mainframe;
	 	$db=&JFactory::getDBO();
		$query = "SELECT `industry_name` FROM #__cam_industries WHERE id=".$id;
		$db->setQuery($query);
		$industryname = $db->loadResult();
		return $industryname;
	}

	 function getpfiles(){
        $pfiles = array();
		$db =& JFactory::getDBO();
		 $user =& JFactory::getUser();
        $user_id = $user->get('id');
		$query = "SELECT * FROM #__cam_propertydocs where parent=0 and `property_manager_id` =".$user_id." and `property_id` =".$_REQUEST['pid'];
		$db->setQuery($query);
        $pfiles=$db->loadObjectList();
		return $pfiles;
}

	function getrfpinfo($id)
	{
		global $mainframe;
	 	$db=&JFactory::getDBO();
		if(!$id){
		$id=$_REQUEST[cid][0];
		}
		$query = "SELECT * FROM `#__cam_rfpinfo` WHERE id='".$id."'";
		$db->setQuery($query);
		$rfpinfo = $db->loadObject();

		return $rfpinfo;
	}
		function rfplinetasks($id)
	{
		global $mainframe;
	 	$db=&JFactory::getDBO();
		if(!$id){
		$id=$_REQUEST[cid][0];
		}
	    $query = "SELECT * FROM `#__cam_rfpsow_linetask` WHERE rfp_id='".$id."'";
		$db->setQuery($query);
		$rfplinetasks = $db->loadObjectlist();

		return $rfplinetasks;
	}

	function rfpuploadfiles($id)
	{
		global $mainframe;
	 	$db=&JFactory::getDBO();
		if(!$id){
		$id=$_REQUEST[cid][0];
		}
		$query = "SELECT * FROM `#__cam_rfpsow_docs` WHERE rfp_id='".$id."'";
		$db->setQuery($query);
		$rfpuploadfiles = $db->loadObjectlist();
		return $rfpuploadfiles;
	}


		//function to get Splrequirements in Review RFP
	function get_Review_SplRequiremntCats()
	{
		global $mainframe;
		$db=&JFactory::getDBO();
	    $rfp_id = JRequest::getVar('rfpid','');
	    $user = JFactory::getUser();
		$sql = " SELECT b.req_parentid as main_id, a.req_title as main_title FROM jos_cam_rfpreq_categories as a , jos_cam_rfpreq_info as b  WHERE a.req_id = b.req_parentid 	 and b.rfp_id = ".$rfp_id."   group by b.req_parentid order by b.req_parentid ";
		$db->Setquery($sql);
		$main_cat = $db->loadObjectList();
		$SPLRequirements_details['main'] = $main_cat;
		$sql = " SELECT b.req_parentid as main_id, b.req_subparentid as sub_id, a.req_title as sub_title FROM jos_cam_rfpreq_categories as a , jos_cam_rfpreq_info as b  WHERE a.req_id = b.req_subparentid and b.rfp_id = ".$rfp_id." AND  req_subparentid != 0  order by b.req_parentid ";
		$db->Setquery($sql);
		$sub_cat = $db->loadObjectList();
		$SPLRequirements_details['sub'] = $sub_cat;
		$sql = " SELECT b.req_parentid as main_id, b.req_subparentid as sub_id, b.req_id as child_id, a.req_title as child_title FROM jos_cam_rfpreq_categories as a , jos_cam_rfpreq_info as b  WHERE a.req_id = b.req_id and b.rfp_id = ".$rfp_id." AND b.req_parentid != 0 AND req_subparentid != 0  order by b.req_parentid ";
		$db->Setquery($sql);
		$SPLRequirements_details['child'] = $db->loadObjectList();
		// echo "<pre>"; print_r($SPLRequirements_details);  exit;
		return $SPLRequirements_details;
	}

	//function to get Splrequirements in edit RFP
	function get_Edit_SplRequiremntCats()
	{
		global $mainframe;
		$db=&JFactory::getDBO();
		$id= JRequest::getVar('cid');
		//print_r($id[0]);
		$rfp_id = $id[0];
	   // $rfp_id = JRequest::getVar('rfpid','');
	    $user = JFactory::getUser();
	   $sql = " SELECT b.req_parentid as main_id FROM jos_cam_rfpreq_categories as a , jos_cam_rfpreq_info as b  WHERE a.req_id = b.req_parentid 	 and b.rfp_id = ".$rfp_id."   group by b.req_parentid order by b.req_parentid ";
	    $db->Setquery($sql);
	    $main_cat = $db->loadResultArray();
	    $Edit_reqCatList['main'] = $main_cat;
	    $sql = " SELECT b.req_subparentid as sub_id, a.req_title as sub_title FROM jos_cam_rfpreq_categories as a , jos_cam_rfpreq_info as b  WHERE a.req_id = b.req_subparentid and b.rfp_id = ".$rfp_id." AND  req_subparentid != 0  order by b.req_parentid ";
	    $db->Setquery($sql);
	    $sub_cat = $db->loadResultArray();
	    $Edit_reqCatList['sub'] = $sub_cat;
	    $sql = " SELECT  b.req_id as child_id FROM jos_cam_rfpreq_categories as a , jos_cam_rfpreq_info as b  WHERE a.req_id = b.req_id and b.rfp_id = ".$rfp_id." AND b.req_parentid != 0 AND req_subparentid != 0  order by b.req_parentid ";
	    $db->Setquery($sql);
	    $child = $db->loadResultArray();
	    $Edit_reqCatList['child'] = $child;
		// echo "<pre>"; print_r($main_cat);  exit;
		return $Edit_reqCatList;
	}

	//function to display Special Requirement Categoies
	// BY sateesh


	//Completed
function get_Edit_SPLReq_Category()
	 {
	  $db = JFactory::getDBO();
	  $rfp_id = JRequest::getVar('rfp_id','');
	  $sql = " SELECT * FROM jos_cam_rfpreq_categories where req_parentid=0";
	  $db->Setquery($sql);
	  $categories = $db->loadObjectList();
	  return $categories;
	 }




	function rfplist()
	{
		global $mainframe;
	 	$db=&JFactory::getDBO();
		$query = $this->_buildQuery();
   		$this->getState('limitstart');
		$this->getState('limit');

		$rfplist = $this->_getList($query, $this->getState('limitstart'), $this->getState('limit'));
	    return $rfplist;
	}

    function rfpreqinfo($id)
	{
		global $mainframe;
	 	$db=&JFactory::getDBO();
		if(!$id){
		$id=$_REQUEST[cid][0];
		}
		$query = "SELECT * FROM `#__cam_rfpreq_info` WHERE rfp_id='".$id."'";
		$db->setQuery($query);
		$rfpreqinfo = $db->loadObjectList();
		return $rfpreqinfo;
	}

	//function to display industries list in popup
	function getindustires()
	{
		global $mainframe;
		if(isset($_SESSION['industries']))
		$chk_arry = $_SESSION['industries'];
		$db = JFactory::getDBO();
		$checked    = JHTML::_( 'grid.id', $i, $row->id );
		$sql = "SELECT * FROM #__cam_industries order by industry_name";
		$db->Setquery($sql);
		$objects = $db->loadObjectList();
		foreach( $objects as $key => $obj )
		{
			//$checked    = JHTML::_( 'grid.id', $key, $obj->industry_name);
			if(isset($chk_arry) && in_array($obj->industry_name,$chk_arry))
			$checked = "<input checked='checked' type='checkbox' onclick='isChecked(this.checked);' value='".$obj->industry_name."' name='cid[]' id='cb'".$key.">";
			else
			$checked = "<input type='checkbox' onclick='isChecked(this.checked);' value='".$obj->industry_name."' name='cid[]' id='cb'".$key.">";
			$industries[] = $checked.'&nbsp;'. $obj->industry_name;
		}
		//echo "<pre>"; print_r($industries);
	   return $industries;
	}
	//Gettig count of eligible vendor
	function geteliblevendorscount(){
	global $mainframe;
	$db= &JFactory::getDBo();
	$rfpid = JRequest::getVar('rfpid','');
	$sql = "SELECT 	industry_id,cust_id,property_id FROM #__cam_rfpinfo where id=".$rfpid;
	$db->Setquery($sql);
	$objects = $db->loadObjectList();

	$industry_id= $objects[0]->industry_id;
	$userid= $objects[0]->cust_id;
	$property_id= $objects[0]->property_id;

	$vendorsinfo	=	$this->getVendors($userid,$property_id,$rfpid);
	if(count($vendorsinfo)>0)
			{
			  for($i=0;$i<count($vendorsinfo);$i++)
			  {
			  $flag = 0;
			  //echo $flag;
			//echo $vendorsinfo[$i][0]->id; echo '----------';
			   //code to validate specialrequirements
				$sql = "SELECT distinct(req_parentid ) FROM #__cam_rfpreq_info WHERE rfp_id ='".$rfpid."'";
				$db->Setquery($sql);
				$main = $db->loadResultArray();
				$sql = "SELECT req_subparentid  FROM #__cam_rfpreq_info WHERE req_subparentid !=0 AND rfp_id ='".$rfpid."'";
				$db->Setquery($sql);
				$sub = $db->loadResultArray();
				// echo "<pre>"; print_r($main); print_r($sub); exit;
				//$flag = 0;

				for($m = 0; $m<count($main); $m++)
				{
				// echo "<pre>"; print_r($main);  exit;
				  switch($main[$m])
				  {

				  case 1:
						for($h=0;$h<count($sub); $h++){

							 switch($sub[$h])
							  {
						case 17:
								if($flag==0){
									$sql = "SELECT id  FROM #__cam_vendor_professional_license  WHERE PLN_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;
									  $db->Setquery($sql);
									  $PLN = $db->loadResultArray();
									  $PLN_cnt = count($PLN) ;
									  if($PLN_cnt== 0){
									 	$flag = 1;
											}

								}
						case 18:
								  if($flag==0){
							  //print_r($sub[$h]);  exit;
									 $sql = "SELECT id  FROM #__cam_vendor_occupational_license WHERE OLN_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;
									  $db->Setquery($sql);
									  $OLN = $db->loadResultArray();
									   // echo "<pre>"; print_r($OLN); exit;
									  $OLN_cnt = count($OLN) ;
									   //echo "<pre>"; print_r($OLN_cnt); exit;
									  if($OLN_cnt== 0){
											$flag = 1;
				                     	}
									}


								}
							}
				   case 3:


							for($s=0;$s<count($sub); $s++){
							//echo "<pre>"; print_r($sub[$s]);
							switch($sub[$s])

							  {

						 case 11:
							//exit;
							if($flag==0)
												{
								  $sql56 = "SELECT req_id  FROM #__cam_rfpreq_info WHERE rfp_id=".$rfpid;
								  $db->Setquery($sql56);
								  $req_id = $db->loadResult();
							 $sql2 = "SELECT id  FROM #__cam_vendor_workers_companies_insurance WHERE WCI_end_date>= '".$today."' and WCI_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;
								  $db->Setquery($sql2);
								  $WCI = $db->loadResultArray();
								  $WCI_cnt = count($WCI) ;
								  if($WCI_cnt == 0){
								  $flag = 1;
								  		}
								if ($req_id=='19' &&  $flag=='0'){
							 	    $sql26 = "SELECT excemption  FROM #__cam_vendor_workers_companies_insurance WHERE WCI_end_date>= '".$today."' and WCI_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;
									$db->Setquery($sql26);
								   $excemption = $db->loadObjectlist();
								  //$excemption=$excemption1[0]->excemption;
								  //echo "<pre>"; print_r($excemption);
								  // $WCI_cnt1 = count($excemption) ;
								   for($d=0;$d<count($excemption); $d++){
								//echo "<pre>"; print_r($excemption[$d]->excemption);
								          if(($excemption[$d]->excemption!= 0)&&($excemption[$d]->excemption!='')){
									         $flag=1;
									             } else {
									        $flag=0;
									        	}
								     	 	}
										 }//echo $flag; echo $vendor_id; echo '</br>';

							    }
					       case 12:
							if($flag==0){
								$sql = "SELECT GLI_policy_aggregate FROM #__cam_vendor_liability_insurence  WHERE GLI_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;
								 // $sql = "SELECT sum(GLI_policy_aggregate)  FROM #__cam_vendor_liability_insurence  WHERE GLI_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;
								  $db->Setquery($sql);
								  $amount = $db->loadObjectlist();
							//echo "<pre>"; print_r($amount);
								  // $amount2 = doubleval(str_replace(",","",$amount1));

								 $spl_amount="SELECT price FROM #__cam_rfpreq_info WHERE rfp_id='".$rfpid."' and req_subparentid='12'";
								   $db->Setquery($spl_amount);
								  $amount1 = $db->loadResult();
								 // $amount2= str_replace(",", "", $amount1);
								 $amount2 = doubleval(str_replace(",","",$amount1));
								 for($L=0;$L<count($amount); $L++){
								// echo "<pre>"; print_r($amount[$L]->GLI_policy_aggregate);
								          if($amount2 > $amount[$L]->GLI_policy_aggregate){
									         $flag=1;
									             } else {
									        $flag=0;
									        }
								      }
									/*if($amount2 > $amount){
									// echo "<pre>"; print_r($flag);  exit;
									$flag=1;
									} else {
									 $flag=0;
									}*/

								}

							}
							}
				  } //switch($main[$m])
				 //print_r($flag); echo "<br>";
				 }
	 }
	}
	 if($flag == 0)
			  {
			  $vendorid = $vendorsinfo[$i][0]->id;
			  $count = count($vendorid);
			  }
	//$sql_eligible = "SELECT count(id) from #__cam_vendor_availablejobs where rfp_id=".$rfpid."";
	//$db->setQuery($sql_eligible);
	//$count = $db->loadResult();
	return $count;
	}
	//Completed
	//function to get the RFP industries list
	  function getrfpindustries()
	{
		global $mainframe;
	 	$db=&JFactory::getDBO();
		$query = "SELECT DISTINCT(U.industry_id),U.rfpid,V.industry_name FROM `#__cam_rfpindustries` as U, #__cam_industries as V WHERE U.industry_id=V.id and rfpid='".$_REQUEST[cid][0]."'";
		$db->setQuery($query);
		$rfpindus = $db->loadObjectList();
		return $rfpindus;
	}

	//Completed
	//function to get the vendor notes for rfp
	function getvendornotes($rfp,$vendor){
	global $mainframe;
	 	$db=&JFactory::getDBO();
		$query = "SELECT * FROM #__cam_adminnotes  WHERE vendor_id=".$vendor." and rfp_id=".$rfp." order by notes_date desc";
		$db->setQuery($query);
		$vendornotes = $db->loadObjectList();
		return $vendornotes;
	}
         function save_notes(){
		global $mainframe;
                $note_id= JRequest::getVar('note_id','');

		$relatedto = JRequest::getVar('related','');
		$comment = JRequest::getVar('comment','');
		$rfp_id = JRequest::getVar('rfp_id','');
		$ven_id = JRequest::getVar('vendor_id','');
		$prop_id = JRequest::getVar('prop_id','');
		$from = JRequest::getVar('from','');
		$note_date = date("Y-m-d H:i:s");
		$user =& JFactory::getUser();
		$author = $user->name.' '.$user->lastname;
		$db=&JFactory::getDBO();
                if($note_id){
              $sql_update = "UPDATE #__cam_adminnotes SET notes_date='".$note_date."',relatedto='".addslashes($relatedto)."',author='".addslashes($author)."',comment='".htmlentities($_REQUEST['comment'], ENT_QUOTES)."' WHERE id=".$note_id;
              $save_note = $db->setQuery($sql_update);
		$res=$db->query();

                }
                else{
				 $insert_notes = "INSERT INTO #__cam_adminnotes(prop_id,vendor_id,rfp_id,notes_date,relatedto,author,comment) VALUES($prop_id,$ven_id,$rfp_id,'".$note_date."','".addslashes($relatedto)."','".addslashes($author)."','".htmlentities($_REQUEST['comment'], ENT_QUOTES)."')";


		$save_note = $db->setQuery($insert_notes);
		$res=$db->query();
                }

		if($res){
		$url = "index.php?option=com_camassistant&controller=rfp&task=vendor_notes&from=".$from."&vendorid=".$ven_id."&rfpid=".$rfp_id."&prop_id=".$prop_id;
		$msg = "Notes saved successfully";
		$mainframe->Redirect($url,$msg);
		}

	}
      function edit_notes(){

		$id = JRequest::getVar('id');
		$db=&JFactory::getDBO();

                $getnotes = $db->setQuery("SELECT * FROM #__cam_adminnotes WHERE id=".$id);
                $notes = $db->loadObjectList();
                return $notes;

	}
	function getallnotes($rfp){
		$db = JFactory::getDBO();
        $user = JFactory::getUser();
		$getnotes="SELECT id,rfpid,comment,author,date_created as notes_date FROM #__cam_rfpnotes where rfpid='".$rfp."' order by date_created DESC ";
        $db->Setquery($getnotes);
        $noteslist = $db->loadObjectList();
        return $noteslist;
		}

function getallnotes_pro($rfp){
		$db = JFactory::getDBO();
        $user = JFactory::getUser();
        $getnotes="SELECT u.*,c.company_name FROM #__cam_adminnotes as u LEFT JOIN #__cam_vendor_company as c ON c.user_id=u.vendor_id where u.rfp_id='".$rfp."' order by u.notes_date DESC ";        $db->Setquery($getnotes);
        $noteslist_pro = $db->loadObjectList();
        return $noteslist_pro;
}


function alladmins(){
		$db=&JFactory::getDBO();
		$getadmins = $db->setQuery("SELECT CONCAT(name,' ' ,lastname) 'text', id as value FROM #__users WHERE usertype='Administrator' or usertype='Super Administrator'");
		$alladmins = $db->loadObjectList();
		return $alladmins;
	}
function getallprimaryproposals($rfp_id){
		$db = JFactory::getDBO();
        $user = JFactory::getUser();
		$allps= "SELECT U.company_name,U.user_id as id,P.id as pid FROM #__cam_vendor_company as U LEFT JOIN #__cam_vendor_proposals as P ON P.proposedvendorid=U.user_id WHERE P.rfpno=".$rfp_id." and P.Alt_bid='' ";
		$db->Setquery($allps);
        $all_ps = $db->loadObjectList();
        return $all_ps;
}
function getinvitedvendors($userid,$rfp_id){
		$db = JFactory::getDBO();
        $user = JFactory::getUser();
		$invitedv= "SELECT U.name,U.lastname,U.id as id,U.flag,U.suspend,U.email,P.id as pid,V.company_phone,V.company_name,U.cellphone,V.alt_phone FROM #__users as U 
LEFT JOIN #__rfp_invitations as P ON P.vendorid=U.id 
LEFT JOIN #__cam_vendor_company as V ON V.user_id=U.id 
WHERE P.rfpid=".$rfp_id." ";
		$db->Setquery($invitedv);
        $allinvited_vendor = $db->loadObjectList();
		//echo "<pre>"; print_r($allinvited_vendor); exit;
        return $allinvited_vendor;
			
	}
//Function to get attached files to basic request
	function bascifiles($rfp_id)
	{
		$db=&JFactory::getDBO();
		$query_basic = "SELECT * FROM #__cam_basicrequest_files WHERE rfpid=".$rfp_id."  ";
		$db->setQuery($query_basic);
		$basefiles = $db->loadObjectList();
		return $basefiles;
	}	
	//Completed	

	function savebfiles($data){
		JTable::addIncludePath(JPATH_COMPONENT.DS.'tables');
		$row =& $this->getTable('basicfiles');
		$row = JTable::getInstance('basicfiles','Table');
        if (!$row->bind($data)) {
                $this->setError($this->_db->getErrorMsg());
                return false;
        }
        if (!$row->check()) {
                $this->setError($this->_db->getErrorMsg());
                return false;
        }
        if (!$row->store()) {
                $this->setError($row->getErrorMsg());
                return false;
        }
        return true;
	} 
}
?>
