<?php
/**
 * @version		1.0.0 cam assistant $
 * @package		cam_assistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport( 'joomla.application.component.model' );
class assignedboardmembersModelAssignedboardmembers extends Jmodel
{
	var $_data = null;
	var $_total = null;
	var $_pagination = null;
	function __construct(){
		parent::__construct();
		global $mainframe, $context;
	  
		$limit			= $mainframe->getUserStateFromRequest( $context.'limit', 'limit', $mainframe->getCfg('list_limit'), 0);
		$limitstart = $mainframe->getUserStateFromRequest( $context.'limitstart', 'limitstart', 0 );
		$filter_order	= $mainframe->getUserStateFromRequest( $context.'filter_order',	'filter_order',	'affid','cmd' );
		$filter_order_Dir	= $mainframe->getUserStateFromRequest( $context.'filter_order_Dir',	'filter_order_Dir',	'asc','word' );

		$this->setState('limit', $limit);
		$this->setState('limitstart', $limitstart);
	}
	function getData()
	{
		//DEVNOTE: Lets load the content if it doesn't already exist
		if (empty($this->_data))
		{
			$query = $this->_buildQuery();
			$this->_data = $this->_getList($query, $this->getState('limitstart'), $this->getState('limit'));
		}
		return $this->_data;
	}
function getTotal()
	{
		//DEVNOTE: Lets load the content if it doesn't already exist
		if (empty($this->_total))
		{
			$query = $this->_buildQuery();
			$this->_total = $this->_getListCount($query);
		}

		return $this->_total;
	}
	function getPagination()
	{
		// Lets load the content if it doesn't already exist
		if (empty($this->_pagination))
		{
			jimport('joomla.html.pagination');
			$this->_pagination = new JPagination( $this->getTotal(), $this->getState('limitstart'), $this->getState('limit') );
		}

		return $this->_pagination;
	}
  	
	function _buildQuery()
	{
			$orderby	= $this->_buildContentOrderBy();
			$query = "SELECT * FROM #__cam_assignedboardmembers as I, #__cam_property as J, #__cam_board_mem  as K where I.property_id = J.id and I.member_id = K.id".$orderby;  
				return $query;

	}
	function _buildContentOrderBy()
		{
			
			global $mainframe, $context;

		$filter_order     = $mainframe->getUserStateFromRequest( $context.'filter_order',      'filter_order', 	  'property_name' );
		$filter_order_Dir	= $mainframe->getUserStateFromRequest( 'filter_order_Dir',	'filter_order_Dir',	'asc','word' );
		
		$orderby 	= ' ORDER BY '. $filter_order .' '. $filter_order_Dir;
		return $orderby;
		}
	function getPropertynames(){
	$property = array(); 
	$db =& JFactory::getDBO();
	$user =& JFactory::getUser();
    $user_id = $user->get('id');
 	$query = "SELECT property_name,tax_id,id FROM #__cam_property where `property_manager_id` =".$user_id."" ;
	$db->setQuery($query);
    $propertynames=$db->loadObjectList();
	return $propertynames;
	}
	
	function getAddmember(){
	}
	function getBoardmembers(){
	$bmembers = array(); 
	$db =& JFactory::getDBO();
 	$query = "SELECT firstname,id,lastname FROM #__cam_board_mem " ;
	$db->setQuery($query);
    $bmembers=$db->loadObjectList();
	return $bmembers;
	}
	
	function getproperties(){
	echo $propertyid = $_REQUEST['property_id'];
	
	$db =& JFactory::getDBO();
 	$query = "SELECT property_id FROM #__cam_assignedboardmembers " ;
	$db->setQuery($query);
    $properties=$db->loadObjectList();
	//print_r($properties);
	for($i=0;$i<count($properties);$i++)
	{
	$arr[]=$properties[$i]->property_id;
	//$properties[]=$properties[$i]->property_id;
	}
	if (in_array($propertyid,$arr))
  {
	$app =& JFactory::getApplication();  
	$msg = 'This property already assigned to the board member';
	$url = 'index.php?option=com_camassistant&controller=assignedboardmembers&Itemid=79';
	$app->redirect( $url, $msg );
  }
	else
  { 
  }
//	print_r($properties); exit;
	return $properties;

	}
	
	function store($data){

	JTable::addIncludePath(JPATH_COMPONENT.DS.'tables');
$row =& $this->getTable('assignedbmembers');
$row = JTable::getInstance('assignedbmembers','Table');
        if (!$row->bind($data)) {
                $this->setError($this->_db->getErrorMsg());
                return false;
        }
        if (!$row->check()) {
                $this->setError($this->_db->getErrorMsg());
                return false;
        }
        if (!$row->store()) {
                $this->setError( $row->getErrorMsg() );
                return false;
        }
        return true;

	
	}

	

function getRemove(){
$db =& JFactory::getDBO();
$query = "DELETE FROM #__cam_assignedboardmembers   WHERE property_id =".$_REQUEST['propertyid']."";  
$db->setQuery($query);
$result = $db->query();
if($result){
$app =& JFactory::getApplication();  
$msg = 'This property removed successfully';
$url = 'index.php?option=com_camassistant&controller=assignedboardmembers&Itemid=79';
$app->redirect( $url, $msg );
}
else {
echo "Not Deleted";
}
}
function geteditmembers(){

	$edit = array(); 
	$db =& JFactory::getDBO();
	$query = "SELECT property_name,id FROM #__cam_property where id =".$_REQUEST['propertyid']." " ;
	$db->setQuery($query);
    $pname=$db->loadObjectList();

	return $pname;

}
function geteditmembers1(){

	$edit1 = array(); 
	$db =& JFactory::getDBO();
	$query = "SELECT firstname,lastname,id FROM #__cam_board_mem where id =".$_REQUEST['memberid']." " ; 
	$db->setQuery($query);
    $mname=$db->loadObjectList();

	return $mname;

}

}
?>