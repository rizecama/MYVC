<?php
/**
 * @version		1.0.0 cam assistant $
 * @package		cam_assistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport( 'joomla.application.component.model' );


class proposalsModelproposals extends Jmodel
{
	 function __construct(){
		parent::__construct();
	 }

	 function getopenfiles($path)
	 {
$path = JPATH_SITE."/".$path;
$dir=dir($path);
		while($filename=$dir->read())
		{
			if($filename!='.'&&$filename!='..')
			{
			if(strpos($filename,"."))
			$data['files'][]=$filename;
			else
			$data['folders'][]= $filename;
			}
		}
		$dir->close();
		return $data;
	 }

	 function getvendortaxid()
	 {
        $pfiles = array();
		$db =& JFactory::getDBO();
		$user =& JFactory::getUser();
        $user_id = $user->get('id');
		/*$query = "SELECT * FROM #__cam_propertydocs where parent=0 and `property_manager_id` =".$user_id." and `property_id` =".$_REQUEST['pid']; */
		$query = "SELECT tax_id FROM #__cam_vendor_company where `user_id`  =".$user_id;
		$db->setQuery($query);
        $taxid=$db->loadObjectList();

		return $taxid;
	}

	 //code by lalitha on april 07th
	function getvendordocs()
	{
        $pfiles = array();
		$db =& JFactory::getDBO();
		$user =& JFactory::getUser();
      //  $user_id = $user->get('id');
         $user_id = $_REQUEST['vendorid'];
		/*$query = "SELECT * FROM #__cam_propertydocs where parent=0 and `property_manager_id` =".$user_id." and `property_id` =".$_REQUEST['pid']; */
		$query = "SELECT * FROM #__cam_propertydocs where parent =0 AND  `property_manager_id`  =".$user_id;
		$db->setQuery($query);
        $pfiles=$db->loadObjectList();
		return $pfiles;
	}

	 //function to get vendor compliance docs
	 function vendor_compliance_docs($userid)
	 {
	 	$COM = array();
		$db =& JFactory::getDBO();
		//$user =& JFactory::getUser();
		$user = $userid;
		$sql = "SELECT tax_id FROM #__cam_vendor_company   WHERE user_id=".$user;
		$db->setQuery($sql);
		$tax_id = $db->loadResult();

		$sql_names = "SELECT name,lastname FROM #__users WHERE id=".$user;
		$db->setQuery($sql_names);
		$main = $db->loadObject();

		$vendorname = $main->name.'_'.$main->lastname.'_'.$tax_id;
		$path = 'components/com_camassistant/assets/images/vendorcompliances/'.$vendorname.'/';
	 	 //code to get OLN docs
		$sql = "SELECT OLN_upld_cert FROM #__cam_vendor_occupational_license  where OLN_status = 1 AND vendor_id=".$userid;
		$db->Setquery($sql);
		$OLN = $db->loadResultArray();
		for($i=0; $i<count($OLN); $i++)
		{
		$ext = substr($OLN[$i], -3);
		if($i%2 == 0)
		$clr = '21314d';
		else
		$clr = '7AB800';

        $sql = "SELECT OLN_folder_id FROM #__cam_vendor_occupational_license  where OLN_status = 1 AND OLN_upld_cert='".$OLN[$i]."'";
		$db->Setquery($sql);
		$OLN_folder_id = $db->loadResult();
		/*$OLN[$i] = '<a style="color:#'.$clr.'; text-decoration:none;" href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&filename='.$OLN[$i].'">'.$OLN[$i].'</a>';*/
		//$OLN[$i] = $OLN[$i];
		$COM[$i]['doc_type']='OLN';
		//$COM[$i][1] = '<a  style="color:#7AB800; text-decoration:none; cursor:pointer" onclick="addfile(\''.$OLN[$i].'\');">'.$OLN[$i].'</a>';
		$COM[$i]['doc_title'] = $OLN[$i];
		$no =$OLN_folder_id;
		$COM[$i]['doc_path'] = $path.'OLN_'.$no.'/'.$COM[$i]['doc_title'];
		}
		//$OLN = implode(',',$OLN);
		//$COM['OLN'] = $OLN;
		//$COM[0] = $OLN;
		//echo "<pre>"; print_r($COM);
		//code to get PLN docs
		$sql = "SELECT PLN_upld_cert FROM #__cam_vendor_professional_license  where PLN_status = 1 AND vendor_id=".$userid;
		$db->Setquery($sql);
		$PLN = $db->loadResultArray();
		for($i=0,$j=count($COM); $i<count($PLN); $i++,$j++)
		{
		$ext = substr($PLN[$i], -3);
		if($i%2 == 0)
		$clr = '21314d';
		else
		$clr = '7AB800';
		/*$PLN[$i] = '<a style="color:#'.$clr.'; text-decoration:none;" href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&filename='.$PLN[$i].'">'.$PLN[$i].'</a>';*/
		//$PLN[$i] = $PLN[$i];
		$COM[$j]['doc_type']='PLN';
		//$COM[$j][1] = '<a  style="color:#7AB800; text-decoration:none; cursor:pointer" onclick="addfile(\''.$PLN[$i].'\');">'.$PLN[$i].'</a>';
        $sql = "SELECT PLN_folder_id FROM #__cam_vendor_professional_license  where PLN_status = 1 AND PLN_upld_cert='".$PLN[$i]."'";
		$db->Setquery($sql);
		$PLN_folder_id = $db->loadResult();
//echo $PLN_folder_id;
		$COM[$j]['doc_title'] = $PLN[$i];
		$no = $PLN_folder_id;
		$COM[$j]['doc_path'] = $path.'PLN_'.$no.'/'.$COM[$j]['doc_title'];
		}
		//print_r($COM);
		//$PLN = implode(',',$PLN);
		//COM['PLN'] = $PLN;
		//$COM[1] = $PLN;

		//code to get GLI docs
		$sql = "SELECT GLI_upld_cert FROM #__cam_vendor_liability_insurence  where GLI_status = 1 AND vendor_id=".$userid;
		$db->Setquery($sql);
		$GLI = $db->loadResultArray();
		for($i=0,$j=count($COM); $i<count($GLI); $i++,$j++)
		{
		$ext = substr($GLI[$i], -3);
		if($i%2 == 0)
		$clr = '21314d';
		else
		$clr = '7AB800';
		$COM[$j]['doc_type']='GLI';
		//$COM[$j][1] = '<a  style="color:#7AB800; text-decoration:none; cursor:pointer" onclick="addfile(\''.$GLI[$i].'\');">'.$GLI[$i].'</a>';
        $sql = "SELECT GLI_folder_id FROM #__cam_vendor_liability_insurence  where GLI_status = 1 AND GLI_upld_cert='".$GLI[$i]."'";
		$db->Setquery($sql);
		$GLI_folder_id = $db->loadResult();
//echo $GLI_folder_id; exit;
		$COM[$j]['doc_title']= $GLI[$i];
		$no =$GLI_folder_id;
		$COM[$j]['doc_path'] = $path.'GLI_'.$no.'/'.$COM[$j]['doc_title'];
		}
		//$GLI = implode(',',$GLI);
		//$COM['GLI'] = $GLI;
		//$COM[2] = $GLI;
		//print_r($COM);
		$sql = "SELECT vendor_id  FROM #__cam_vendor_compliance_w9docs WHERE w9_status = 1 AND vendor_id=".$userid;
		$db->Setquery($sql);
		$vendor_id = $db->loadResultArray();

		//code to display WCI docs
		$sql = "SELECT WCI_upld_cert FROM #__cam_vendor_workers_companies_insurance  where WCI_status = 1 AND vendor_id=".$userid;
		$db->Setquery($sql);
		$WCI = $db->loadResultArray();
		for($i=0,$j=count($COM); $i<count($WCI); $i++,$j++)
		{
		$ext = substr($WCI[$i], -3);
		/*if($i%2 == 0)
		$clr = '21314d';
		else
		$clr = '7AB800';
		$WCI[$i] = '<a style="color:#'.$clr.'; text-decoration:none;" href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&filename='.$WCI[$i].'">'.$WCI[$i].'</a>';*/
		//$WCI[$i] = $WCI[$i];
		$COM[$j]['doc_type']='WCI';
		//$COM[$j][1] = '<a  style="color:#7AB800; text-decoration:none; cursor:pointer" onclick="addfile(\''.$WCI[$i].'\');">'.$WCI[$i].'</a>';
        $sql = "SELECT WCI_folder_id FROM #__cam_vendor_workers_companies_insurance  where WCI_status = 1 AND WCI_upld_cert='".$WCI[$i]."'";
		$db->Setquery($sql);
		$WCI_folder_id = $db->loadResult();

		$COM[$j]['doc_title'] = $WCI[$i];
		$no = $WCI_folder_id;
		$COM[$j]['doc_path'] = $path.'WCI_'.$no.'/'.$COM[$j]['doc_title'];
		}
		//$WCI = implode(',',$WCI);
		//$COM['WCI'] = $WCI;
		//COM[3] = $WCI;
		//W9 files
		$sql = "SELECT w9_upld_cert FROM #__cam_vendor_compliance_w9docs   where w9_status = 1 AND vendor_id=".$userid;
		$db->Setquery($sql);
		$W9 = $db->loadResult();
		if($W9 != '')
		{
		$ext2 = substr($W9, -3);
		/*$W9 = '<a style="color:#21314d; text-decoration:none;" href="'.JURI::root().'index.php?option=com_camassistant&controller=vendors&task=view_upld_cert&filename='.$W9.'">'.$W9.'</a>';*/
		//$W9 = $W9;
		//$W9 = '<a  style="color:#7AB800; text-decoration:none; cursor:pointer" onclick="addfile(\''.$W9.'\');">'.$W9.'</a>';
		//$COM['W9'] = $W9;
		$j=count($COM);
		$COM[$j]['doc_type']='W9';
		$COM[$j]['doc_title'] = $W9;
		$COM[$j]['doc_path'] = $path.'W9/'.$COM[$j]['doc_title'];
		}
		//echo "<pre>"; print_r($COM);
		return $COM;
	 }
	 //functio to get vendor docs in warranty form
	 function get_warranty_files()
	 {
		$user =& JFactory::getUser();
		$userid = $_REQUEST['vendorid'];
		$pfiles = $this->vendor_compliance_docs($userid);
       // echo '<pre>'; print_r($pfiles);
		/*echo $query = "SELECT O.OLN_upld_cert, P.PLN_upld_cert, G.GWI_upld_cert, W.WCI_upld_cert, W9.w9_upld_cert  FROM #__users AS U
		LEFT JOIN #__cam_vendor_occupational_license AS O ON U.id = O.vendor_id
		LEFT JOIN #__cam_vendor_professional_license AS P ON U.id = P.vendor_id
		LEFT JOIN #__cam_vendor_liability_insurence AS G ON U.id = G.vendor_id
		LEFT JOIN #__cam_vendor_workers_companies_insurance AS W ON U.id = W.vendor_id
		LEFT JOIN #__cam_vendor_compliance_w9docs AS W9 ON U.id = W9.vendor_id
		WHERE U.id = ".$user->id;*/
		return $pfiles;
	   }
function store3($data){
JTable::addIncludePath(JPATH_COMPONENT.DS.'tables');
$row =& $this->getTable('propertydocs');
$row = JTable::getInstance('propertydocs','Table');
        if (!$row->bind($data)) {
                $this->setError($this->_db->getErrorMsg());
                return false;
        }
        if (!$row->check()) {
                $this->setError($this->_db->getErrorMsg());
                return false;
        }
        if (!$row->store()) {
                $this->setError($row->getErrorMsg());
                return false;
        }
        return true;
}
	 function get_rfp_rebid_chk()
	 {
	    $rfp_id	= JRequest::getVar('rfp_id','');
		$m= date("m"); // Month value
		$de= date("d"); //today's date
		$y= date("Y"); // Year value
		$today = date('m-d-Y', mktime(0,0,0,$m,($de+1),$y));
		$is_allow = '';
		$db = JFactory::getDBO();
		$sql = "SELECT proposalDueDate,proposalDueTime FROM #__cam_rfpinfo WHERE proposalDueDate >= '".$today."' AND id=".$rfp_id;
		$db->Setquery($sql);
		$records = $db->loadAssocList();
		$duedate = $this->get_duedate($records[0]['proposalDueTime'],$records[0]['proposalDueDate']);
		$time_left_details = $this->fnCalculateEndDateTime($duedate);
		//echo "<pre>"; print_r($time_left_details);
		if($time_left_details['days'] >= 1)
		$is_allow = 'allowed';
		else
		$is_allow = 'not allowed';
		return $is_allow;
	 }

	 //function to validate vendor in vendor proposal table

	  function get_validate_vendor_bids()
	 {
	    $rfp_id	= JRequest::getVar('rfp_id','');
		$id	= JRequest::getVar('id','');
		$user =& JFactory::getUser();
		$db = JFactory::getDBO();
		$sql = "SELECT status FROM #__cam_vendor_availablejobs WHERE user_id  = '".$user->id."' AND rfp_id=".$rfp_id." AND id=".$id;
		$db->Setquery($sql);
		$status = $db->loadResult();
		if($status == 1)
		$status = 'Had bid';
		return $status;
	 }

	 //for getting industryname in edit vendor compilance page
	function getindustry_ids($userid)
	{
		$db = JFactory::getDBO();
		$query ="select industry_id from #__cam_vendor_industries Where user_id =".$userid;
		$db->setQuery($query);
		$results = $db->loadResultArray();

		return $results;
	}

	 //for getting statename for edit vendor page
	function getstatename($stateid)
	{
		//echo '<pre>'; print_r($stateid);
		$db = JFactory::getDBO();
		//$query ="select state_name from #__state Where state_id ='".$stateid."'";
		$query ="select state_name from #__state Where id ='".$stateid."'";
		$db->setQuery($query);
		$results = $db->loadResult();
		//echo "<pre>"; print_r($results);
		return $results;
	}

	 //function to get vendor compliance alerts
	function get_chk_vendor_GLI_compliance_alert()
	{
	    $db = JFactory::getDBO();
		$user =& JFactory::getUser();
 		$user_type = $user->get('user_type');

		$alert_sql ="SELECT count(*) from #__cam_vendor_liability_insurence  WHERE vendor_id=".$user->id;
		$db->Setquery($alert_sql);
		$res = $db->loadResult();
		$alert['GLI_exist']= $res;

		$alert_sql ="SELECT count(*) from #__cam_vendor_compliance_w9docs  WHERE vendor_id=".$user->id;
		$db->Setquery($alert_sql);
		$res2 = $db->loadResult();
		$alert['W9_exist']= $res2;

		$alert_sql ="SELECT count(*) from #__cam_vendor_liability_insurence  WHERE GLI_status = 1 AND vendor_id=".$user->id;
		$db->Setquery($alert_sql);
		$res3 = $db->loadResult();
		if($res3 != 0) $res3=0; else $res3=1;
		$alert['GLI_status']= $res3;

		$alert_sql ="SELECT count(*) from #__cam_vendor_compliance_w9docs  WHERE w9_status = 0 AND vendor_id=".$user->id;
		$db->Setquery($alert_sql);
		$res4 = $db->loadResult();
		$alert['W9_status']= $res4;
		$today = date('Y-m-d');

		$alert_sql ="SELECT count(*) from #__cam_vendor_professional_license  WHERE PLN_status = 1 AND vendor_id=".$user->id;
		$db->Setquery($alert_sql);
		$res5 = $db->loadResult();
		if($res5 != 0) $res5=0; else $res5=1;
		$alert['PLN_status']= $res5;

		$alert_sql ="SELECT count(*) from #__cam_vendor_professional_license  WHERE PLN_expdate  >= '".$today."' AND vendor_id=".$user->id; //validation to expdate of docs
		$db->Setquery($alert_sql);
		$res6 = $db->loadResult();
		if($res6 != 0) $res6=0; else $res6=1;
		$alert['PLN_exp']= $res6;

		$alert_sql ="SELECT count(*) from #__cam_vendor_professional_license  WHERE vendor_id=".$user->id;
		$db->Setquery($alert_sql);
		$res7 = $db->loadResult();
		$alert['PLN_exist']= $res7;
		/*$alert_sql ="SELECT count(*) from #__cam_vendor_occupational_license   WHERE OLN_expdate <= '".$today."' AND vendor_id=".$user->id; //validation to expdate of docs
		$db->Setquery($alert_sql);
		$res5 = $db->loadResult();
		$alert['OLN_exp']= $res5;
		$alert_sql ="SELECT count(*) from #__cam_vendor_professional_license  WHERE PLN_expdate  <= '".$today."' AND vendor_id=".$user->id; //validation to expdate of docs
		$db->Setquery($alert_sql);
		$res6 = $db->loadResult();
		$alert['PLN_exp']= $res6;
		$alert_sql ="SELECT count(*) from #__cam_vendor_workers_companies_insurance   WHERE WCI_end_date  <= '".$today."' AND vendor_id=".$user->id; //validation to expdate of docs
		$db->Setquery($alert_sql);
		$res7 = $db->loadResult();
		$alert['WCI_exp']= $res7;*/

		$alert_sql ="SELECT count(*) from #__cam_vendor_liability_insurence   WHERE GLI_end_date  >= '".$today."' AND vendor_id=".$user->id; //validation to expdate of docs
		$db->Setquery($alert_sql);
		$res8 = $db->loadResult();
		if($res8 != 0) $res8=0; else $res8=1;
		$alert['GLI_exp']= $res8;

		return $alert;
	}

	 function get_SPLreq_amount()
	 {
		$db = JFactory::getDBO();
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$rfp_id = JRequest::getVar('rfp_id','');
		$sql = "SELECT * FROM #__cam_rfpsow_splreq_price where rfp_id=".$rfp_id." AND vendor_id =".$user->id;
		$db->Setquery($sql);
		$result = $db->loadObjectList();
		return $result;
	 }
	 //function to update status of available jobs
	function get_Update_job_status()
	{
		$db = JFactory::getDBO();
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$id = JRequest::getVar('id','');
		$sql = "UPDATE  #__cam_vendor_availablejobs  SET status = 1 WHERE user_id=".$user->id." AND id = ".$id;
		$db->Setquery($sql);
		$data = $db->query();
		//return $data;
	}


	 //function to submit proposal from vendor centre page
	 function Proposal_submit()
	 {
	 	  $rfp_id = JRequest::getVar('rfp_id','');
		  $Proposal_id = JRequest::getVar('Proposal_id','');
		  $Alt_Prp = JRequest::getVar('Alt_Prp','');
	      $db = JFactory::getDBO();
		  $vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		  $sql = "Update #__cam_vendor_proposals set proposaltype='Submit' where proposedvendorid =".$user->id." AND rfpno=".$rfp_id." AND id =".$Proposal_id." AND Alt_bid= '".$Alt_Prp."'";
		  $db->Setquery($sql);
		  $db->query();
	 }

	 function get_Form_status()
	 {
	 	$db = JFactory::getDBO();
		$post	= JRequest::get('post');
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$rfp_id = JRequest::getVar('rfp_id','');
		$sql2 = "SELECT proposaltype,proposeddate FROM #__cam_vendor_proposals  where rfpno=".$rfp_id." AND proposedvendorid =".$user->id;
		$db->Setquery($sql2);
		$result = $db->loadObjectList();
		return $result;
	 }

	 //function to save as ITB
	function Proposal_save_as_ITB()
	{
		$post	= JRequest::get('post');
		//code to update vendor bidding proposal for RFP
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$vendor_rfp['id'] 				 = '';
		$vendor_rfp['rfpno'] 				 = $post['rfp_id'];
		$vendor_rfp['proposalno'] 		     = '';
		$vendor_rfp['proposedvendorid'] 	 = $user->id;
		$vendor_rfp['proposeddate'] 		 = date('m-d-Y');
		$vendor_rfp['proposaltype'] 		 = $post['submit_type'];
		$vendor_rfp['price_other_items'] 	 = '';
		$vendor_rfp['proposal_total_price']	 = '';
		$vendor_rfp['commission'] 			 = '';
		$vendor_rfp['Alt_bid'] 			 	 = '';
		$row = & $this->getTable('vendor_rfp_proposals_info');
		// Bind the form fields to the  table
		if (!$row->bind($vendor_rfp)) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		//echo "<pre>"; print_r($row); exit;
		// Store the  detail record into the database
		if (!$row->store()) {
		    $this->_db->getErrorMsg();
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		//echo "<pre>"; echo $this->_db->insertid(); exit;
		$db = JFactory::getDBO();
		$Proposal_id = $this->_db->insertid();
		$random_id 	 = str_pad(mt_rand(0, 9999999), 7, '0', STR_PAD_LEFT);
		$upd_sql = 'UPDATE #__cam_vendor_proposals set id='.$random_id.' WHERE id ='.$Proposal_id;
		$db->Setquery($upd_sql);
		$db->query();
		return $random_id;
	}

	 //function to save RFP bidding
	 function Proposal_save_as($data)
	 {
		//code to update tasks prices in cam_rfpsow_docs_lineitems_prices table.
		$db = JFactory::getDBO();
		//echo "<pre>"; print_r($data); exit;
		$vendorid = $data['vendorid'];
		$user	= JFactory::getUser($vendorid);
		/*//echo $data['warranty_path']; exit;
		$sql = "SELECT tax_id FROM #__cam_vendor_company   WHERE user_id=".$user->id;
		$db->setQuery($sql);
		$tax_id = $db->loadResult();
		$vendorname = $user->name.'_'.$user->lastname.'_'.$tax_id;
		echo $src = JPATH_COMPONENT.$data['warranty_path'];
		$filename = $data['warranty_file'];
		echo '<br/>';
		echo $dest = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'vendorcompliances'.DS.$vendorname.DS.'warranty'.DS.$filename;
		jimport('joomla.filesystem.file');
		//JFolder::create($dest);
		rename(JPATH_COMPONENT.$data['warranty_path'], $dest);
		if(JFile::upload($src,$dest)) echo 'copied'; else echo 'failed';
		exit;*/
		$Alt_bid = $data['Alt_bid'];
		$Alt_Prp = $data['Alt_Prp'];
		if($Alt_bid != '')
		$is_Alt =  $Alt_bid;
		else
		$is_Alt =  $Alt_Prp;
		// echo "<pre>";  print_r($data);
		 if($data['warranty_path'] != ''){
	  $sql = " SELECT task_id FROM #__cam_rfpsow_uploadfiles where rfp_id='".$data['rfp_id']."' and vendor_id='".$data['vendorid']."'";
	  $db->Setquery($sql);
	  $taskid = $db->loadResult();

		 $insert_sql = "insert into #__cam_rfpsow_uploadfiles values ('','".$data['rfp_id']."','".$taskid."','".$data['vendorid']."','No','".$data['warranty_path']."','active','')";
			$db->SetQuery($insert_sql);
			$db->query();
		 }
		if($data['rebid'] == 's')
		{
			$data['id'] = '';
			$data['Prp_id'] = '';
			$data['Proposal_id'] = '';
			$sql = "INSERT INTO #__cam_rfpsow_uploadfiles(rfp_id,task_id,vendor_id,spl_req,upload_doc,status,Alt_bid)
    SELECT rfp_id,task_id,vendor_id,spl_req,upload_doc,status,'yes' FROM #__cam_rfpsow_uploadfiles as A  WHERE A.rfp_id=".$data['rfp_id']." AND A.vendor_id=".$user->id;
			$db->Setquery($sql);
			$db->query();
		}
		if($data['Alt_bid'] != 'yes' && $data['act'] != 'Update')
		{
			$Proposal_id = JRequest::getVar('Proposal_id','');
			$Alt_Prp = JRequest::getVar('Alt_Prp','');
			if($Proposal_id !='')
			{
				$del_sql = "DELETE from #__cam_rfpsow_docs_lineitems_prices WHERE rfp_id=".$data['rfp_id']." AND vendor_id=".$user->id." AND Alt_bid='".$Alt_Prp."'";
				$db->Setquery($del_sql);
				$db->query();
				//code to delete proposal bidding of the user
				$del_sql2 = "DELETE FROM #__cam_vendor_proposals  where rfpno=".$data['rfp_id']." AND proposedvendorid 	 =".$user->id." AND Alt_bid='".$Alt_Prp."'";
				$db->Setquery($del_sql2);
				$db->query();
			}
		}
		//exit;
		if($data['rebid'] != 's')
		{
		$del_sql = "DELETE from #__cam_rfpsow_docs_lineitems_prices WHERE item_type='task' AND rfp_id=".$data['rfp_id']." AND vendor_id=".$user->id." AND Alt_bid='".$is_Alt."'";
		$db->Setquery($del_sql);
		$db->query();
		}
		for($t=0; $t<count($data['price_fields']),$t<count($data['price_fields']); $t++) //for line items
		{
			$data_task['rfp_id'] = $data['rfp_id'];
			$data_task['vendor_id'] = $user->id;
			$data_task['item_type'] = 'task';
			$data_task['item_id'] = $data['price_fields'][$t];
			$data_task['item_price'] = $data['task_price'][$t];
			$data_task['status'] = 'active';
			if($Proposal_id != '')
			$data_task['Alt_bid'] 			 	 = $Alt_Prp;
			else if(($data['rebid'] == 's' && $data['Alt_Prp'] == 'yes'))
			$data_task['Alt_bid'] = $data['Alt_Prp'];
			else
			$data_task['Alt_bid'] 			 	 = $is_Alt;
		  	$price_task = & $this->getTable('rfp_task_docs_tasks_price');
			//echo "<pre>"; echo '123';  print_r($data_task);   exit;
		  // Bind the form fields to the  table
			if (!$price_task->bind($data_task)) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}
			//echo "<pre>"; echo '123';  print_r($price_task);   exit;
			// Store the  detail record into the database
			if (!$price_task->store()) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}
		}// end for loop
		if($data['rebid'] != 's')
		{
		$del_sql = "DELETE from #__cam_rfpsow_docs_lineitems_prices WHERE item_type='doc' AND rfp_id=".$data['rfp_id']." AND vendor_id=".$user->id." AND Alt_bid='".$is_Alt."'";
		$db->Setquery($del_sql);
		$db->query();
		}
        //echo "<pre>"; print_r($data); exit;
		for($d=0; $d<count($data['downloads_price']),$d<count($data['downloads_ids']); $d++) //for additional docs
		{
			$data_doc['rfp_id'] = $data['rfp_id'];
			$data_doc['vendor_id'] = $user->id;
			$data_doc['item_type'] = 'doc';
			$data_doc['item_id'] = $data['downloads_ids'][$d];
			$data_doc['item_price'] = $data['downloads_price'][$d];
			$data_doc['status'] = 'active';
			if($Proposal_id != '')
			$data_doc['Alt_bid'] 			 	 = $Alt_Prp;
			else if(($data['rebid'] == 's' && $data['Alt_Prp'] == 'yes'))
			$data_doc['Alt_bid'] = $data['Alt_Prp'];
			else
			$data_doc['Alt_bid'] 			 	 = $is_Alt;
		  	$price_doc = & $this->getTable('rfp_task_docs_tasks_price');
		  // Bind the form fields to the  table
			if (!$price_doc->bind($data_doc)) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}
			// Store the  detail record into the database
			if (!$price_doc->store()) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}
		}// end for loop
		//cod to update status of rfpsow_addnotes,rfpsow_addexception,rfpsow_uploadfiles
		$db = JFactory::getDBO();
		$sql2 = "Update #__cam_rfpsow_addnotes  set status='active' where rfp_id=".$data['rfp_id']." AND vendor_id =".$user->id;
		$db->Setquery($sql2);
		$db->query();

		$db = JFactory::getDBO();
		$sql3 = "Update #__cam_rfpsow_addexception  set status='active' where rfp_id=".$data['rfp_id']." AND vendor_id =".$user->id;
		$db->Setquery($sql3);
		$db->query();

		$db = JFactory::getDBO();
		$sql4 = "Update #__cam_rfpsow_uploadfiles  set status='active' where rfp_id=".$data['rfp_id']." AND vendor_id =".$user->id;
		$db->Setquery($sql4);
		$db->query();

		//code to save insurence,liability amounts
		//echo "<pre>"; print_r($data);
		if($data['rebid'] != 's')
		{
		$spl_req = $data['spl_req']; //echo $data['amount'][$spl_req[0]];  echo $sp l_req[0]; exit;
		$sql5 = "DELETE FROM #__cam_rfpsow_splreq_price where rfp_id=".$data['rfp_id']." AND vendor_id =".$user->id;
		$db->Setquery($sql5);
		$db->query();
		}
		for($i=0; $i<count($data['amount']); $i++)
		{
			$spl_arr['rfp_id'] =$data['rfp_id'];
			$spl_arr['req_id'] = $spl_req[$i];
			$spl_arr['vendor_id'] = $user->id;
			$spl_arr['amount'] =  $data['amount'][$spl_req[$i]];
			$spl_arr['status'] = 'active';
			$row = & $this->getTable('vendor_rfp_proposals_splreq_amount');
			// Bind the form fields to the  table
			if (!$row->bind($spl_arr)) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}
			//echo "<pre>"; print_r($row); exit;
			// Store the  detail record into the database
			if (!$row->store()) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}
		}

		//code to update vendor bidding proposal for RFP

		$data['other_items_price'] = doubleval(str_replace(",","",$data['other_items_price']));
		if($data['total_price'] == '')
		$data['total_price'] = $data['other_items_price'];
		$data['total_price'] = doubleval(str_replace(",","",$data['total_price']));
		$data['commisions'] = doubleval(str_replace(",","",$data['commisions']));
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
         //if($data['warranty_hid_text']){
           //$data['warranty_hid_text']=$data['warranty_hid_text'];
         //}
       // } else {
         //  $data['warranty_hid_text']=$data['warranty_hid_text1'];
       // }
		$vendor_rfp['id'] 				 	 = $data['id'];
        if($data['warranty_hid_text']){
		$vendor_rfp['warranty_file_text']  = $data['warranty_hid_text'];
        }
		$vendor_rfp['warranty_file_area']  = $data['warranty_file_area'];
		$vendor_rfp['warranty_filepath'] 	 = $data['warranty_path'];
		$vendor_rfp['id'] 				 	 = $data['id'];
		$vendor_rfp['rfpno'] 				 = $data['rfp_id'];
		$vendor_rfp['proposalno'] 		     = '';
		$vendor_rfp['proposedvendorid'] 	 = $user->id;
		$vendor_rfp['proposeddate'] 		 = date('m-d-Y');
		$vendor_rfp['proposaltype'] 		 = $data['submit_type'];
		$vendor_rfp['price_other_items'] 	 = $data['other_items_price'];
		$vendor_rfp['proposal_total_price']	 = number_format($data['total_price'],2,'.','');
		$vendor_rfp['commission'] 			 = number_format($data['commisions'],2,'.','');
		if($Proposal_id != '')
		$vendor_rfp['Alt_bid'] 			 	 = $Alt_Prp;
		else if(($data['rebid'] == 's' && $data['Alt_Prp'] == 'yes'))
		$vendor_rfp['Alt_bid'] = $data['Alt_Prp'];
		else
		$vendor_rfp['Alt_bid'] 			 	 = $data['Alt_bid'];
		$row = & $this->getTable('vendor_rfp_proposals_info');

		$vendor_rfp['publish'] 		 = '0';
		$data['publish'] = '0';

		//echo "<pre>"; print_r($vendor_rfp); exit;
		// Bind the form fields to the  table
		if (!$row->bind($vendor_rfp)) {
			 $this->setError($this->_db->getErrorMsg());
			return false;
		}
		//echo "<pre>"; print_r($row); exit;
		// Store the  detail record into the database
		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		if($data['id'] == '')
		{
			/*$db = JFactory::getDBO();
			$sql = "SELECT max(id) FROM #__cam_vendor_proposals ";
			$db->Setquery($sql);
			$Proposal_id = $db->loadResult();*/
			$Proposal_id = $db->insertid();
			$random_id 	 = str_pad(mt_rand(0, 9999999), 7, '0', STR_PAD_LEFT);
			$upd_sql = 'UPDATE #__cam_vendor_proposals set id='.$random_id.' WHERE id ='.$Proposal_id;
			$db->Setquery($upd_sql);
			$db->query();
		}
		return $random_id;

	 }
	   function get_SPLReq_Category()
	 {
	  $db = JFactory::getDBO();
	  $rfp_id = JRequest::getVar('rfp_id','');
	  $sql = " SELECT * FROM jos_cam_rfpreq_categories where req_parentid=0";
	  $db->Setquery($sql);
	  $categories = $db->loadObjectList();
	  return $categories;
	 }

	 //function to get RFP Spl requirements data
	 function get_SPLRequirements($act)
	 {
	 global $mainframe;
		$db=&JFactory::getDBO();
	    $rfp_id = JRequest::getVar('rfp_id','');
	    $vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$sql = " SELECT b.req_parentid as main_id, a.req_title as main_title FROM jos_cam_rfpreq_categories as a , jos_cam_rfpreq_info as b  WHERE a.req_id = b.req_parentid 	 and b.rfp_id = ".$rfp_id."   group by b.req_parentid order by b.req_parentid ";
		$db->Setquery($sql);
		$main_cat = $db->loadObjectList();
		$SPLRequirements_details['main'] = $main_cat;
		$sql = " SELECT DISTINCT b.req_parentid as main_id,b.price, b.req_subparentid as sub_id, a.req_title as sub_title FROM jos_cam_rfpreq_categories as a , jos_cam_rfpreq_info as b  WHERE a.req_id = b.req_subparentid and b.rfp_id = ".$rfp_id." AND  b.req_subparentid != 0  order by b.req_parentid ";
		$db->Setquery($sql);
		$sub_cat = $db->loadObjectList();
		$SPLRequirements_details['sub'] = $sub_cat;
		$sql = " SELECT b.req_parentid as main_id,b.price, b.req_subparentid as sub_id, b.req_id as child_id, a.req_title as child_title FROM jos_cam_rfpreq_categories as a , jos_cam_rfpreq_info as b  WHERE a.req_id = b.req_id and b.rfp_id = ".$rfp_id." AND b.req_parentid != 0 AND req_subparentid != 0  order by b.req_parentid ";
		$db->Setquery($sql);
		$SPLRequirements_details['child'] = $db->loadObjectList();
	 /*  $db = JFactory::getDBO();
	   $rfp_id = JRequest::getVar('rfp_id','');
	   $user = JFactory::getUser();
	 // $sql = " SELECT a.*, b.price FROM jos_cam_rfpreq_categories as a , jos_cam_rfpreq_info as b  WHERE a.req_id = b.req_id and b.rfp_id = ".$rfp_id."  order by b.req_parentid ";
	 // $sql = " SELECT * FROM jos_cam_rfpreq_info WHERE rfp_id = ".$rfp_id;
	  $sql = " SELECT b.req_parentid as main_id, a.req_title as main_title FROM jos_cam_rfpreq_categories as a , jos_cam_rfpreq_info as b  WHERE a.req_id = b.req_parentid 	 and b.rfp_id = ".$rfp_id."   group by b.req_parentid order by b.req_parentid ";
	  $db->Setquery($sql);
	  $main_cat = $db->loadObjectList();
	  $SPLRequirements_details['main'] = $main_cat;
	   $sql = " SELECT b.req_parentid as main_id, b.req_subparentid as sub_id, a.req_title as sub_title FROM jos_cam_rfpreq_categories as a , jos_cam_rfpreq_info as b  WHERE a.req_id = b.req_subparentid and b.rfp_id = ".$rfp_id." AND  req_subparentid != 0  order by b.req_parentid ";
	  $db->Setquery($sql);
	  $sub_cat = $db->loadObjectList();
	  $SPLRequirements_details['sub'] = $sub_cat;
	  $sql = " SELECT b.req_parentid as main_id, b.req_subparentid as sub_id, b.req_id as child_id, a.req_title as child_title FROM jos_cam_rfpreq_categories as a , jos_cam_rfpreq_info as b  WHERE a.req_id = b.req_id and b.rfp_id = ".$rfp_id." AND b.req_parentid != 0 AND req_subparentid != 0  order by b.req_parentid ";
	  $db->Setquery($sql);
	  $child = $db->loadObjectList();*/
	   //echo "<pre>"; print_r($SPLRequirements_details); exit;
	 /* if($act == 'Edit')
	  {
	  //$sql = " SELECT b.req_parentid as main_id, b.req_subparentid as sub_id, b.req_id as child_id, a.req_title as child_title,c.amount FROM jos_cam_rfpreq_categories as a LEFT JOIN jos_cam_rfpreq_info as b ON a.req_id = b.req_id LEFT JOIN #__cam_rfpsow_splreq_price c ON a.req_id = c.req_id WHERE a.req_id = b.req_id and b.rfp_id = ".$rfp_id." AND b.req_parentid != 0 AND req_subparentid != 0 AND c.vendor_id = ".$user->id."  order by b.req_parentid ";
		  for($x=0; $x<count($child); $x++)
		  {
		  $sql = "SELECT amount FROM  #__cam_rfpsow_splreq_price WHERE req_id = ".$child[$x]->sub_id." AND rfp_id = ".$rfp_id." AND vendor_id = ".$user->id ;
		  $db->Setquery($sql);
		  $amount = $db->loadResult();
		  $child[$x]->amount = $amount;
		  }
	  }*/
	   //$SPLRequirements_details['child'] = $child;
	//echo "<pre>"; print_r($SPLRequirements_details); exit;
	  return $SPLRequirements_details;
	 }

	 //function to save task uploadfile
	function save_uploadfile($data)
	{
		// give me JTable object
		$row = & $this->getTable('rfp_task_uploadfiles');
		// Bind the form fields to the  table
		if (!$row->bind($data)) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		//echo "<pre>"; print_r($data); exit;
		// Create the timestamp for the date field
		// Store the  detail record into the database
		if (!$id = $row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
    $id = $this->_db->insertid();
		return $id;
	}

	//function to save task addnotes
	function save_addnotes($data)
	{
		// give me JTable object
		$row = & $this->getTable('rfp_task_addnotes');

		// Bind the form fields to the  table
		if (!$row->bind($data)) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		//echo "<pre>"; print_r($data); exit;
		// Create the timestamp for the date field
		// Store the  detail record into the database
		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}

	//function to save task addnotes
	function save_addexception($data)
	{
		// give me JTable object
		$row = & $this->getTable('rfp_task_addexception');
		// Bind the form fields to the  table
		if (!$row->bind($data)) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		//echo "<pre>"; print_r($data); exit;
		// Create the timestamp for the date field
		// Store the  detail record into the database
		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}

	//function to download doc
	function get_downloadfile()
	{
	    /*$db = JFactory::getDBO();
		$doc_id = JRequest::getVar('doc_id','');
		$rfp_id = JRequest::getVar('rfp_id','');
		$sql = 'SELECT taskuploads FROM #__cam_rfpsow_linetask WHERE rfp_id = '.$rfp_id.' AND task_id ='.$doc_id ;
		$db->Setquery($sql);
		$filename = $db->loadResult();
		$path = JURI::root().'components/com_camassistant/assets/images/rfp/';
		$doc_name = $path.$filename; */
		$path = JRequest::getVar('path','');
		$filename = JRequest::getVar('title','');
		$path = JURI::root().$path;
		$doc_name = $path;
		header("content-type: application/octet-stream");
		header("Content-Disposition: attachment; filename=".$filename);
		readfile($doc_name);
		exit;
		return ;
	}

	//function to get RFP tasks info
	function get_TASKSinfo($act,$Alt_Prp)
	{
	    $db = JFactory::getDBO();
		$rfp_id = JRequest::getVar('rfp_id','');
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$sql = 'SELECT * FROM #__cam_rfpsow_linetask WHERE rfp_id = '.$rfp_id ;
		$db->Setquery($sql);
		$TASK_details = $db->loadObjectList();
		//echo "<pre>"; print_r($TASK_details);
		if($act == 'Edit')
		{
		  //code to get Addnotes data
		 for($t=0; $t<count($TASK_details); $t++) //to get task price
		 {
			$db = JFactory::getDBO();
			$sql = 'SELECT add_notes  FROM #__cam_rfpsow_addnotes  WHERE status = "active" AND spl_req = "No" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$user->id.' AND task_id='.$TASK_details[$t]->task_id.' AND Alt_bid="'.$Alt_Prp.'"' ;
			$db->Setquery($sql);
			$db->query();
			$is_Notes = $db->loadResult();
			$TASK_details[$t]->Notes = $is_Notes;

			$sql = 'SELECT add_exception,check_exception  FROM #__cam_rfpsow_addexception  WHERE status = "active" AND spl_req = "No" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$user->id.' AND task_id='.$TASK_details[$t]->task_id.' AND Alt_bid="'.$Alt_Prp.'"' ;
			$db->Setquery($sql);
			$db->query();
			$is_Exception = $db->loadObjectList();
			$TASK_details[$t]->Exception = $is_Exception[0]->add_exception;
                        $TASK_details[$t]->check_exception = $is_Exception[0]->check_exception;
		  }

		//end of code to get Addnotes data
		  for($p=0; $p<count($TASK_details); $p++) //to get task price
		  {
		  $price_sql = 'SELECT item_price FROM #__cam_rfpsow_docs_lineitems_prices  WHERE item_type="task" AND item_id = '.$TASK_details[$p]->task_id.' AND vendor_id = '.$user->id.' AND Alt_bid="'.$Alt_Prp.'"' ;
		  $db->Setquery($price_sql);
		  $price = $db->loadResult();
		  $TASK_details[$p]->price = $price;
		  }
		  //echo "<pre>"; print_r($TASK_details);
		  for($u=0; $u<count($TASK_details); $u++)//to get task related uploaded files
		  {
		   $upld_sql = 'SELECT upload_doc FROM #__cam_rfpsow_uploadfiles  WHERE spl_req = "No" AND task_id = '.$TASK_details[$u]->task_id.' AND rfp_id ='.$rfp_id.' AND vendor_id='.$user->id.' AND Alt_bid="'.$Alt_Prp.'"'  ;
		  $db->Setquery($upld_sql);
		  $upld_file = $db->loadResultArray();
		  $TASK_details[$u]->uploaded_file = $upld_file;
		  $upld_sql = 'SELECT id FROM #__cam_rfpsow_uploadfiles  WHERE spl_req = "No" AND task_id = '.$TASK_details[$u]->task_id.' AND rfp_id ='.$rfp_id.' AND vendor_id='.$user->id.' AND Alt_bid="'.$Alt_Prp.'"'  ;
		  $db->Setquery($upld_sql);
		  $upld_doc_ids = $db->loadResultArray();
		  $TASK_details[$u]->uploaded_doc_ids = $upld_doc_ids;
		  $upld_title = array();
		   for($i=0; $i<count($upld_file); $i++)
			{
		 		$arr = explode('/',$upld_file[$i]);
 		 		$cnt = count($arr);
		 		$upld_title[$i] = $arr[$cnt-1];
			}
			$TASK_details[$u]->uploadfile_title = $upld_title;
		  }

		}
		//echo $x = $this->get_Addnotes_link($id);
		if($act == 'Add')
		{
			for($x=0; $x<count($TASK_details); $x++)
			{
			$TASK_details[$x]->Addnotes = $this->get_Addnotes_link($TASK_details[$x]->task_id,'No','Add',$Alt_Prp);
			$TASK_details[$x]->Uploadfile = $this->get_Uploadfile_link($TASK_details[$x]->task_id,'No','Add',$Alt_Prp);
			$TASK_details[$x]->AddException = $this->get_Addexception_link($TASK_details[$x]->task_id,'No','Add',$Alt_Prp);
			}
		}
		else
		{
			for($x=0; $x<count($TASK_details); $x++)
			{
			$TASK_details[$x]->Addnotes = $this->get_Addnotes_link($TASK_details[$x]->task_id,'No','Edit',$Alt_Prp);
			$TASK_details[$x]->Uploadfile = $this->get_Uploadfile_link($TASK_details[$x]->task_id,'No','Edit',$Alt_Prp);
			$TASK_details[$x]->AddException = $this->get_Addexception_link($TASK_details[$x]->task_id,'No','Edit',$Alt_Prp);
			}
		}
		// echo "<pre>"; print_r($TASK_details); exit;
		return $TASK_details;
	}


function get_TASKSinfo_basic($act,$Alt_Prp)
	{
	    $db = JFactory::getDBO();
		$rfp_id = JRequest::getVar('rfp_id','');
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$sql = 'SELECT * FROM #__cam_rfpsow_linetask WHERE rfp_id = '.$rfp_id ;
		$db->Setquery($sql);
		$TASK_details = $db->loadObjectList();
		
		if($act == 'Edit')
		{
		  //code to get Addnotes data
		 for($t=0; $t<count($TASK_details); $t++) //to get task price
		 {
			$db = JFactory::getDBO();
			$sql = 'SELECT add_notes  FROM #__cam_rfpsow_addnotes  WHERE status = "active" AND spl_req = "No" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$user->id.' AND Alt_bid="'.$Alt_Prp.'" order by id desc' ;
			$db->Setquery($sql);
			$db->query();
			$is_Notes = $db->loadResult();
			$TASK_details[$t]->Notes = $is_Notes;
			$sql = 'SELECT add_exception,check_exception  FROM #__cam_rfpsow_addexception  WHERE status = "active" AND spl_req = "No" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$user->id.' AND Alt_bid="'.$Alt_Prp.'" order by id desc'   ;
			$db->Setquery($sql);
			$db->query();
			$is_Exception = $db->loadObjectList();
			$TASK_details[$t]->Exception = $is_Exception[0]->add_exception;
                        $TASK_details[$t]->check_exception = $is_Exception[0]->check_exception;
		  }

		//end of code to get Addnotes data
		  for($p=0; $p<count($TASK_details); $p++) //to get task price
		  {
		  $price_sql = 'SELECT item_price FROM #__cam_rfpsow_docs_lineitems_prices  WHERE item_type="task" AND vendor_id = '.$user->id.' AND Alt_bid="'.$Alt_Prp.'"' ;
		  $db->Setquery($price_sql);
		  $price = $db->loadResult();
		  $TASK_details[$p]->price = $price;
		  }
		  //echo "<pre>"; print_r($TASK_details);
		  for($u=0; $u<count($TASK_details); $u++)//to get task related uploaded files
		  {
		   $upld_sql = 'SELECT DISTINCT upload_doc FROM #__cam_rfpsow_uploadfiles  WHERE spl_req = "No" AND rfp_id ='.$rfp_id.' AND vendor_id='.$user->id.' AND Alt_bid="'.$Alt_Prp.'"'  ;
		  $db->Setquery($upld_sql);
		  $upld_file = $db->loadResultArray();
		  $TASK_details[$u]->uploaded_file = $upld_file;
		  $upld_sql = 'SELECT id FROM #__cam_rfpsow_uploadfiles  WHERE spl_req = "No" AND rfp_id ='.$rfp_id.' AND vendor_id='.$user->id.' AND Alt_bid="'.$Alt_Prp.'"'  ;
		  $db->Setquery($upld_sql);
		  $upld_doc_ids = $db->loadResultArray();
		  $TASK_details[$u]->uploaded_doc_ids = $upld_doc_ids;
		  $upld_title = array();
		   for($i=0; $i<count($upld_file); $i++)
			{
		 		$arr = explode('/',$upld_file[$i]);
 		 		$cnt = count($arr);
		 		$upld_title[$i] = $arr[$cnt-1];
			}
			$TASK_details[$u]->uploadfile_title = $upld_title;
		  }

		}
		//echo $x = $this->get_Addnotes_link($id);
		if($act == 'Add')
		{
			for($x=0; $x<count($TASK_details); $x++)
			{
			$TASK_details[$x]->Addnotes = $this->get_Addnotes_link($TASK_details[$x]->task_id,'No','Add',$Alt_Prp);
			$TASK_details[$x]->Uploadfile = $this->get_Uploadfile_link($TASK_details[$x]->task_id,'No','Add',$Alt_Prp);
			$TASK_details[$x]->AddException = $this->get_Addexception_link($TASK_details[$x]->task_id,'No','Add',$Alt_Prp);
			}
		}
		else
		{
			for($x=0; $x<count($TASK_details); $x++)
			{
			$TASK_details[$x]->Addnotes = $this->get_Addnotes_link($TASK_details[$x]->task_id,'No','Edit',$Alt_Prp);
			$TASK_details[$x]->Uploadfile = $this->get_Uploadfile_link($TASK_details[$x]->task_id,'No','Edit',$Alt_Prp);
			$TASK_details[$x]->AddException = $this->get_Addexception_link($TASK_details[$x]->task_id,'No','Edit',$Alt_Prp);
			}
		}
		// echo "<pre>"; print_r($TASK_details); exit;
		return $TASK_details;
	}
	//function to get RFP special requirements tabs Addnotes, Uploadfile, Addexception links
	function get_SPLRequirements_tabs($act,$Alt_Prp)
	{
		$rfp_id = JRequest::getVar('rfp_id','');
		$db = JFactory::getDBO();
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		if($act == 'Add')
		{
			$SPL_REQ_tabs[0]->Addnotes = $this->get_Addnotes_link('0','Yes','Add',$Alt_Prp);
			$SPL_REQ_tabs[1]->Uploadfile = $this->get_Uploadfile_link('0','Yes','Add',$Alt_Prp);
			$SPL_REQ_tabs[2]->AddException = $this->get_Addexception_link('0','Yes','Add',$Alt_Prp);
		}
		else
		{
			$SPL_REQ_tabs[0]->Addnotes = $this->get_Addnotes_link('0','Yes','Edit',$Alt_Prp);
			$SPL_REQ_tabs[1]->Uploadfile = $this->get_Uploadfile_link('0','Yes','Edit',$Alt_Prp);
			$SPL_REQ_tabs[2]->AddException = $this->get_Addexception_link('0','Yes','Edit',$Alt_Prp);
			$upld_sql = 'SELECT upload_doc FROM #__cam_rfpsow_uploadfiles  WHERE status="active" AND spl_req = "Yes" AND task_id = 0 AND rfp_id ='.$rfp_id.' AND vendor_id='.$user->id.' AND Alt_bid="'.$Alt_Prp.'"'  ;
		  $db->Setquery($upld_sql);
		  $upld_file = $db->loadResultArray();
		  $SPL_REQ_tabs[3]->uploaded_file = $upld_file;
		  $upld_sql = 'SELECT id FROM #__cam_rfpsow_uploadfiles  WHERE status="active" AND spl_req = "Yes" AND task_id = 0 AND rfp_id ='.$rfp_id.' AND vendor_id='.$user->id.' AND Alt_bid="'.$Alt_Prp.'"';
		  $db->Setquery($upld_sql);
		  $upld_ids = $db->loadResultArray();
		  $SPL_REQ_tabs[4]->uploaded_doc_ids = $upld_ids;
		  $upld_title = array();
		   for($i=0; $i<count($upld_file); $i++)
			{
		 		$arr = explode('/',$upld_file[$i]);
 		 		$cnt = count($arr);
		 		$upld_title[$i] = $arr[$cnt-1];
			}
			$SPL_REQ_tabs[5]->uploadfile_title = $upld_title;
			 //code to get Addnotes data
			$db = JFactory::getDBO();
			$sql = 'SELECT add_notes  FROM #__cam_rfpsow_addnotes  WHERE status = "active" AND spl_req = "Yes" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$user->id.' AND task_id=0 AND Alt_bid="'.$Alt_Prp.'"' ;
			$db->Setquery($sql);
			$db->query();
			$is_Notes = $db->loadResult();
			$SPL_REQ_tabs[6]->Notes = $is_Notes;
			 //code to get Addexception data
			$db = JFactory::getDBO();
			$sql = 'SELECT add_exception  FROM #__cam_rfpsow_addexception   WHERE status = "active" AND spl_req = "Yes" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$user->id.' AND task_id=0 AND Alt_bid="'.$Alt_Prp.'"' ;
			$db->Setquery($sql);
			$db->query();
			$is_excep = $db->loadResult();
			$SPL_REQ_tabs[7]->Exception = $is_excep;
		//end of code to get Addnotes data
		}
		// echo "<pre>"; print_r($SPL_REQ_tabs);
		return $SPL_REQ_tabs;
	}

	//function to populate select industries link
	function get_Addnotes_link($id,$is_Spl,$act,$Alt_Prp)
	{
	    /*****************code to send to fnd**************************/
		if($act == 'Add')
		$var = 'Alt_bid='.$Alt_Prp;
		else
		$var = 'Alt_Prp='.$Alt_Prp;
	    JHTML::_('behavior.modal');
        $uri	=& JURI::getInstance();
		//echo "<pre>"; print_r($_REQUEST); exit;
		$rfp_id	= JRequest::getVar('rfp_id','');
		$vendor_id	= JRequest::getVar('vendor_id','');
		$rebid	= JRequest::getVar('rebid','');
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$vendor_id = $user->id;
		$base	= $uri->toString( array('scheme', 'host', 'port'));
		$link	= $base;
		if($is_Spl == 'No')
		$url	= 'index.php?option=com_camassistant&controller=proposals&task=Addnotes&rebid='.$rebid.'&'.$var.'&rfp_id='.$rfp_id.'&vendorid='.$vendor_id.'&task_id='.$id.'&Action='.$act;
		else
		$url	= 'index.php?option=com_camassistant&controller=proposals&task=Addnotes&rebid='.$rebid.'&'.$var.'&spl=Yes&rfp_id='.$rfp_id.'&vendorid='.$vendor_id.'&task_id=0&Action='.$act;
		$status = 'width=400,height=350,menubar=yes,resizable=yes';
		//code to get Addnotes data
		 $db = JFactory::getDBO();
		$sql = 'SELECT * FROM #__cam_rfpsow_addnotes  WHERE status = "active" AND spl_req = "'.$is_Spl.'" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$vendor_id.' AND task_id='.$id.' AND Alt_bid="'.$Alt_Prp.'"' ;
		$db->Setquery($sql);
		$db->query();
		$is_Id = $db->loadResultArray();
		//end of code to get Addnotes data
		//echo "<pre>"; print_r($is_Id);
		if(($act == 'Add' && $is_Id[0] == '') || ($act == 'Edit' && $is_Id[0] == ''))
		$text = '<img src="'.Juri::root().'/templates/camassistant_left/images/addnotes.gif" border="0" alt="Add Notes" width="76" height="22" />';
		else
		$text = '<img src="'.Juri::root().'/templates/camassistant_left/images/editnotes.gif" border="0" alt="Edit Notes" width="76" height="22" />';
        $attribs['rel']	= "{handler: 'iframe', size: {x: 630, y: 390}}";
		$attribs['class']	= 'modal';
		$attribs['title']	= JText::_( 'Addnotes' );
		//$attribs['onclick'] = "window.open(this.href,'win2','".$status."'); return false;";
		$output = JHTML::_('link', JRoute::_($url), $text, $attribs);
		return $output;
		/*****************end of code to send to fnd**************************/
	}

		//function to populate select industries link
	function get_Uploadfile_link($id,$is_Spl,$act,$Alt_Prp)
	{
	    /*****************code to send to fnd**************************/
		if($act == 'Add')
		$var = 'Alt_bid='.$Alt_Prp;
		else
		$var = 'Alt_Prp='.$Alt_Prp;
	    JHTML::_('behavior.modal');
        $uri	=& JURI::getInstance();
		$status	= JRequest::getVar('act','');
		$rfp_id	= JRequest::getVar('rfp_id','');
		$vendor_id	= JRequest::getVar('vendorid','');
		$rebid	= JRequest::getVar('rebid','');
		$Proposal_id = JRequest::getVar('Proposal_id','');
		$base	= $uri->toString( array('scheme', 'host', 'port'));
		$link	= $base;
		if($is_Spl == 'No')
		//$url	= 'index.php?option=com_camassistant&controller=proposals&'.$var.'&task=Uploadfile&rebid='.$rebid.'&rfp_id='.$rfp_id.'&Proposal_id='.$Proposal_id.'&vendorid='.$vendor_id.'&task_id='.$id.'&Action='.$act.'&act='.$status;
		$url = 'index2.php?option=com_camassistant&controller=proposals&task=warranty_popup&userid='.$vendor_id.'';
		else
		$url	= 'index.php?option=com_camassistant&controller=proposals&'.$var.'&task=Uploadfile&rebid='.$rebid.'&Proposal_id='.$Proposal_id.'&spl=Yes&rfp_id='.$rfp_id.'&vendorid='.$vendor_id.'&task_id=0&Action='.$act.'&act='.$status;
		$status = 'width=400,height=350,menubar=yes,resizable=yes';
		$text = '<img src="'.Juri::root().'/templates/camassistant_left/images/uploadfile.gif" border="0" alt="upload a file" />';
        $attribs['rel']	= "{handler: 'iframe', size: {x: 600, y: 450}}";
		$attribs['class']	= 'modal';
		$attribs['title']	= JText::_( 'Uploadfile' );
		//$attribs['onclick'] = "window.open(this.href,'win2','".$status."'); return false;";
		$output = JHTML::_('link', JRoute::_($url), $text, $attribs);
		return $output;
		/*****************end of code to send to fnd**************************/
	}

			//function to populate select industries link
	function get_Addexception_link($id,$is_Spl,$act,$Alt_Prp)
	{
	    /*****************code to send to fnd**************************/
		if($act == 'Add')
		$var = 'Alt_bid='.$Alt_Prp;
		else
		$var = 'Alt_Prp='.$Alt_Prp;
	    JHTML::_('behavior.modal');
        $uri	=& JURI::getInstance();
		$rfp_id	= JRequest::getVar('rfp_id','');
		$vendor_id	= JRequest::getVar('vendor_id','');
		$rebid	= JRequest::getVar('rebid','');
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$vendor_id = $user->id;
		$base	= $uri->toString( array('scheme', 'host', 'port'));
		$link	= $base;
		if($is_Spl == 'No')
		$url	= 'index.php?option=com_camassistant&controller=proposals&rebid='.$rebid.'&'.$var.'&task=Addexception&rfp_id='.$rfp_id.'&vendorid='.$vendor_id.'&task_id='.$id.'&Action='.$act;
		else
		$url	= 'index.php?option=com_camassistant&controller=proposals&rebid='.$rebid.'&'.$var.'&task=Addexception&spl=Yes&rfp_id='.$rfp_id.'&vendorid='.$vendor_id.'&task_id=0&Action='.$act;
		$status = 'width=400,height=350,menubar=yes,resizable=yes';
		 $db = JFactory::getDBO();
		$sql = 'SELECT * FROM #__cam_rfpsow_addexception  WHERE status = "active" AND spl_req = "'.$is_Spl.'" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$vendor_id.' AND task_id='.$id.' AND Alt_bid="'.$Alt_Prp.'"' ;
		$db->Setquery($sql);
		$db->query();
		$is_Id = $db->loadResultArray();
		if(($act == 'Add' && $is_Id[0] == '') || ($act == 'Edit' && $is_Id[0] == ''))
		$text = "<img src='".Juri::root()."/templates/camassistant_left/images/addexception.gif' border='0' alt='add exception' />";
		else
		$text = "<img src='".Juri::root()."/templates/camassistant_left/images/editexception.gif' border='0' alt='edit exception' />";
        $attribs["rel"]	= '{handler: \'iframe\', size: {x: 630, y: 390}}';
		$attribs["class"]	= "modal";
		$attribs["title"]	= JText::_( "Addexception" );
		//$attribs['onclick'] = "window.open(this.href,'win2','".$status."'); return false;";
		$output = JHTML::_('link', JRoute::_($url), $text, $attribs);
		return $output;
		/*****************end of code to send to fnd**************************/
	}

	//function to calculate due time left for RFP's
	function fnCalculateEndDateTime($enddate,$ds='Day',$hs='Hrs',$ms='Min')
	{
		$today = time();
		//echo $today = '2011-09-0701:16:00';
		//$today = strtotime($today); echo '------------';
		//echo $enddate = '2011-09-0702:00:00';
		//exit;
		//echo "Hii-->".strtotime($enddate);
		$mk_enddate =  strtotime($enddate);
		$cal_time['time_diff'] = $difference = $mk_enddate-$today;
		$days = floor($difference/(60*60*24));

		$rem = $difference%(60*60*24);

		$hours = floor($rem/(60*60));
		$rem1 = $rem%(60*60);
		$minutes = floor($rem1/60);

		$seconds = $rem1%60;
		if($ds!='d')
		{
		if($days!='' && $ds!='d')
			$d = $days."&nbsp;".$ds.($days == 1 ? '' : 's')." &nbsp;";
		if($days!='' && $ds=='d')
		   $d.=$days."&nbsp;".$ds." &nbsp;";
		if($hours!='')
			$h = $hours."&nbsp;".$hs." &nbsp;";
		if($minutes!='')
			$m = $minutes."&nbsp;".$ms."";
		}
		else if($ds=='d')
		{
		if($days!='' && $ds!='d')
			$d = $days.$ds.($days == 1 ? '' : 's')." &nbsp;";
		if($days!='' && $ds=='d')
		   $d.=$days.$ds." &nbsp;";
		if($hours!='')
			$h = $hours.$hs." &nbsp;";
		if($minutes!='')
			$m = $minutes.$ms."";
		}
	   //echo $days."d ".$hours."h ".$minutes."m ".$seconds."s";
		$cal_time['time_left'] = $d.$h.$m;
		$cal_time['days'] = $days;
		$cal_time['hours'] = $hours;
		$cal_time['minutes'] = $minutes;
		$cal_time['seconds'] = $seconds;
		//echo "<pre>"; print_r($cal_time);
		return $cal_time;

	}//fnCalculateEndDateTime

	function get_duedate($due_time,$due_date)
	{
		$hr_min = substr($due_time, 0, -2);  // returns "7:00"
		$am_pm = substr($due_time, -2);    // returns "AM" OR "PM"
		if($am_pm == 'PM')
		{
		$min = substr($hr_min, -2);
		$hr = substr($hr_min, 0, -3);
		$x = substr($due_time, 0, 2);
		if($x != 12)
		$hr = $hr + 12;
		}
		else if($am_pm == 'AM')
		{
		$min = substr($hr_min, -2);
		$hr = substr($hr_min, 0, -3);
		}
		$D_date = explode('-',$due_date);
		$due_date = $D_date[2].'-'.$D_date[0].'-'.$D_date[1];
		$duedate = $due_date.''.$hr.':'.$min.':00';
		return $duedate;
	}

	//code to get max bids allowed for an RFP
     function get_RFP_Maxbids()
	 {
	    //validation to redirect to vendor bidding form
		$rfp_id = JRequest::getVar('rfp_id','');
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$db = JFactory::getDBO();
		$m= date("m"); // Month value
		$de= date("d"); //today's date
		$y= date("Y"); // Year value
		$today = date('m-d-Y', mktime(0,0,0,$m,($de+1),$y));
		//$today = date('m-d-Y');
		$is_allow = '';
		/*$sql = "SELECT maxProposals FROM #__cam_rfpinfo WHERE proposalDueDate >= '".$today."' AND id=".$rfp_id;
		$db->Setquery($sql);
		$Max_bids = $db->loadResult();*/
		$sql = "SELECT maxProposals,proposalDueDate,proposalDueTime FROM #__cam_rfpinfo WHERE proposalDueDate >= '".$today."' AND id=".$rfp_id;
		$db->Setquery($sql);
		$records = $db->loadAssocList();
		//echo "<pre>"; print_r($records);

		$duedate = $this->get_duedate($records[0]['proposalDueTime'],$records[0]['proposalDueDate']);
		$time_left_details = $this->fnCalculateEndDateTime($duedate);
		//echo "<pre>"; print_r($time_left_details);
		 if($time_left_details['days'] == 0)
		 $time_left_details['days'] = '';
		 else
		 $time_left_details['days'] = $time_left_details['days'].' Day(s) &nbsp;';
		 $records[$d]['time_left'] = $time_left_details['days'].$time_left_details['hours'].'&nbsp;Hr(s)'.'&nbsp;'.$time_left_details['minutes'].'&nbsp;Mins';

		 if(($time_left_details['days'] == '0' ||  $time_left_details['days'] < 0) && ($time_left_details['hours'] == 0 || $time_left_details['hours'] < 0) && ($time_left_details['minutes'] == 0 || $time_left_details['minutes'] < 0))
		 {
		  $is_allow = 'not allowed';
		  }
		$Max_bids = $records[0]['maxProposals'];
		$prp_sql = "SELECT count(distinct(proposedvendorid)) FROM jos_cam_vendor_proposals WHERE rfpno=".$rfp_id." AND proposaltype IN ('ITB','review','Draft','Submit','resubmit') AND Alt_bid != 'yes' ";
		$db->Setquery($prp_sql);
		$Prp_bids = $db->loadResult();
		if($Max_bids > $Prp_bids && $is_allow != 'not allowed')
		$flag = '1';
		else if($Max_bids == $Prp_bids || $is_allow == 'not allowed' )
		$flag = 0;
		return $flag;
	 }

	//function to get RFP, property, customer info
	function get_RFPinfo()
	{
		$rfp_id = JRequest::getVar('rfp_id','');
		$Prp_id = JRequest::getVar('Prp_id','');
	    $db = JFactory::getDBO();
		$sql = 'SELECT I.industry_name, U.id as vendorid, U.name, U.showphone,U.showfax,U.showaddress,U.showcompany,U.showemail,U.lastname, U.email, U.extension, U.phone, C.comp_name, C.comp_city, C.comp_state, C.comp_phno, C.comp_extnno, C.comp_alt_phno, C.comp_alt_extnno, C.comp_website, C.mailaddress, P.street, P.property_name, P.state, P.city, P.zip, P.units, R.id, R.startDate, R.endDate, R.projectName,R.work_perform,R.bidders_info,R.site_visit, R.frequency, R.proposalDueDate, R.proposalDueTime, R.jobtype, R.jobnotes FROM #__cam_rfpinfo as R
		LEFT JOIN  #__cam_customer_companyinfo as C ON R.cust_id = C.cust_id
		LEFT JOIN  #__cam_industries  as I ON R.industry_id = I.id
		LEFT JOIN  #__cam_property as P ON R.property_id = P.id
		LEFT JOIN  #__users as U ON R.cust_id = U.id WHERE R.id = '.$rfp_id;
		$db->Setquery($sql);
		$RFP_details = $db->loadObjectList();
		$state_name = $this->getstatename($RFP_details[0]->comp_state);
		$RFP_details[0]->comp_state = $state_name;
		if ($RFP_details[0]->units < 200) {
		$RFP_details[0]->units_text = '200 or Less';
		} elseif ($RFP_details[0]->units > 200 && $RFP_details[0]->units <= 300) {
		$RFP_details[0]->units_text = '200 to 300';
		}  elseif ($RFP_details[0]->units > 300 && $RFP_details[0]->units <= 400) {
		$RFP_details[0]->units_text = '300 to 400';
		} elseif ($RFP_details[0]->units > 400 && $RFP_details[0]->units <= 500) {
		$RFP_details[0]->units_text = '400 to 500';
		} elseif ($RFP_details[0]->units > 500 && $RFP_details[0]->units <= 600) {
		$RFP_details[0]->units_text = '500 to 600';
		} elseif ($RFP_details[0]->units > 600 && $RFP_details[0]->units <= 700) {
		$RFP_details[0]->units_text = '600 to 700';
		} elseif ($RFP_details[0]->units > 700 && $RFP_details[0]->units <= 800) {
		$RFP_details[0]->units_text = '700 to 800';
		} elseif ($RFP_details[0]->units > 800 && $RFP_details[0]->units <= 900) {
		$RFP_details[0]->units_text = '800 to 900';
		} elseif ($RFP_details[0]->units > 900 && $RFP_details[0]->units <= 1000) {
		$RFP_details[0]->units_text = '900 to 1000';
		} elseif ($RFP_details[0]->units > 1000 ) {
		$RFP_details[0]->units_text = 'Over 1,000';
		}
		return $RFP_details;
	}

	//function to get DOCS info in vendor_proposal_form
	function get_DOCSinfo($Act,$Alt_Prp)
	{
	    $db = JFactory::getDBO();
		$rfp_id = JRequest::getVar('rfp_id','');
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$sql = 'SELECT * FROM #__cam_rfpsow_docs WHERE rfp_id = '.$rfp_id ;
		$db->Setquery($sql);
		$DOCS_details = $db->loadObjectList();
		if($Act == 'Edit')
		{
			for($i=0; $i<count($DOCS_details); $i++)
			{
			 $arr = explode('/',$DOCS_details[$i]->doc_path);
			 $cnt = count($arr);
			 $DOCS_details[$i]->title = $arr[$cnt-1];
			 $sql = 'SELECT item_price FROM #__cam_rfpsow_docs_lineitems_prices WHERE rfp_id = '.$rfp_id.' AND vendor_id ='.$user->id.' AND item_type="doc" AND item_id='.$DOCS_details[$i]->doc_id.' AND Alt_bid="'.$Alt_Prp.'"' ;
			$db->Setquery($sql);
			$price = $db->loadResult();
			$DOCS_details[$i]->price = $price;
			}
		}
		//echo "<pre>"; print_r($DOCS_details);
		for($i=0; $i<count($DOCS_details); $i++)
		{
		 $arr = explode('/',$DOCS_details[$i]->doc_path);
 		 $cnt = count($arr);
		 $DOCS_details[$i]->title = $arr[$cnt-1];
		}
		return $DOCS_details;
	}

	//function to get DOCS info in vendor_proposal_form
	function get_Tasks_DOCSinfo()
	{
	    $db = JFactory::getDBO();
		$rfp_id = JRequest::getVar('rfp_id','');
		$sql = 'SELECT task_id, taskuploads FROM #__cam_rfpsow_linetask  WHERE rfp_id = '.$rfp_id  ;
		$db->Setquery($sql);
		$Tasks_DOCS_details = $db->loadObjectList();
		for($i=0; $i<count($Tasks_DOCS_details); $i++)
		{
		 $arr = explode('/',$Tasks_DOCS_details[$i]->taskuploads);
 		 $cnt = count($arr);
		 $Tasks_DOCS_details[$i]->title = $arr[$cnt-1];
		}
		return $Tasks_DOCS_details;
	}

	//function to display industries list in popup
	function getindustires()
	{
		global $mainframe;
		if(isset($_SESSION['industries']))
		$chk_arry = $_SESSION['industries'];
		$db = JFactory::getDBO();
		$checked    = JHTML::_( 'grid.id', $i, $row->id );
		$sql = "SELECT * FROM #__cam_industries WHERE published=1 order by industry_name ";
		$db->Setquery($sql);
		$objects = $db->loadObjectList();
		foreach( $objects as $key => $obj )
		{
			//$checked    = JHTML::_( 'grid.id', $key, $obj->industry_name);
			if(isset($chk_arry) && in_array($obj->industry_name,$chk_arry))
			$checked = "<input checked='checked' type='checkbox' onclick='isChecked(this.checked);' value='".$obj->industry_name."' name='cid[]' id='cb'".$key.">";
			else
			$checked = "<input type='checkbox' onclick='isChecked(this.checked);' value='".$obj->industry_name."' name='cid[]' id='cb'".$key.">";
			$industries[] = $checked.'&nbsp;'. $obj->industry_name;
		}
		//echo "<pre>"; print_r($industries);
	   return $industries;
	}

	//function to save vendor registration details
	function store($data)
	{
	 	// give me JTable object
		$row = & $this->getTable('vendors');
		// Bind the form fields to the  table
		if (!$row->bind($data)) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		// Create the timestamp for the date field
		// Store the  detail record into the database
		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}



   /***************************Edit related function**********************************/

   	//function to get uploaded DOCS in vendor_proposal_edit_form
	function get_Edit_DOCSinfo($Alt_Prp)
	{
	    $db = JFactory::getDBO();
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$rfp_id = JRequest::getVar('rfp_id','');
		$vendor_id = JRequest::getVar('vendor_id','');
		$sql = 'SELECT * FROM #__cam_rfpsow_uploadfiles  WHERE rfp_id ='.$rfp_id.' AND vendor_id='.$vendor_id.' AND Alt_bid = "'.$Alt_Prp.'"' ;
		$db->Setquery($sql);
		$Edit_DOCS_details = $db->loadObjectList();
		return $Edit_DOCS_details;
	}

	//function to get download docs
	function get_Remove_downloadfile($Alt_Prp)
	{
	    $db = JFactory::getDBO();
		$spl_req = JRequest::getVar('spl_req','');
		$doc_id = JRequest::getVar('doc_id','');
		$rfp_id = JRequest::getVar('rfp_id','');
		$vendor_id = JRequest::getVar('vendor_id','');
		$vendorid = JRequest::getVar('vendorid');


	  	 $sql = 'DELETE FROM #__cam_rfpsow_uploadfiles  WHERE spl_req = "'.$spl_req.'" AND rfp_id = '.$rfp_id.' AND id ='.$doc_id.' AND vendor_id='.$vendor_id.' AND Alt_bid = "'.$Alt_Prp.'"' ;
		$db->Setquery($sql);
		$db->query();
		return ;
	}

	//function to get Proposal Price details in Proposal edit form
	function get_Proposal_price_details($Alt_Prp)
	{
	    $db = JFactory::getDBO();
		$Proposal_id = JRequest::getVar('Proposal_id','');
		$rfp_id = JRequest::getVar('rfp_id','');
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$sql = 'SELECT id,warranty_filepath,warranty_file_text,warranty_file_area,Alt_bid,price_other_items,proposal_total_price,contact_name,commission,(proposal_total_price-price_other_items) as tasks_total_price FROM #__cam_vendor_proposals  WHERE rfpno = '.$rfp_id.' AND proposedvendorid ='.$user->id.' AND id='.$Proposal_id.' AND Alt_bid="'.$Alt_Prp.'"' ;
		$db->Setquery($sql);
		$db->query();
		$Proposal_price_details = $db->loadObjectList();
		return $Proposal_price_details;
	}

	//function to get Add notes data in popup -- Proposal edit form
	function get_task_Addnotes($spl_req,$Alt_Prp)
	{
	    $db = JFactory::getDBO();
		$task_id = JRequest::getVar('task_id','');
		$rfp_id = JRequest::getVar('rfp_id','');
		$vendor_id = JRequest::getVar('vendorid','');
		$sql = 'SELECT * FROM #__cam_rfpsow_addnotes  WHERE status = "active" AND spl_req = "'.$spl_req.'" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$vendor_id.' AND task_id='.$task_id.' AND Alt_bid="'.$Alt_Prp.'"' ;
		$db->Setquery($sql);
		$db->query();
		$task_Addnotes_details = $db->loadObjectList();
		//echo "<pre>"; print_r($task_Addnotes_details); exit;
		return $task_Addnotes_details;
	}

	//function to get Add notes data in popup -- Proposal edit form
	function get_task_Addexception($spl_req,$Alt_Prp)
	{
	    $db = JFactory::getDBO();
		$task_id = JRequest::getVar('task_id','');
		$rfp_id = JRequest::getVar('rfp_id','');
		$vendor_id = JRequest::getVar('vendorid','');
		$sql = 'SELECT * FROM #__cam_rfpsow_addexception   WHERE status = "active" AND spl_req = "'.$spl_req.'" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$vendor_id.' AND task_id='.$task_id.' AND Alt_bid="'.$Alt_Prp.'"' ;
		$db->Setquery($sql);
		$db->query();
		$task_AddException_details = $db->loadObjectList();
		return $task_AddException_details;
	}

	/******************proposal preview related functions*********************************/
	//function to get RFP tasks info
	function get_TASKSinfo_preview($act,$Alt_Prp)
	{
	    $db = JFactory::getDBO();
		$rfp_id = JRequest::getVar('rfp_id','');
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$sql = 'SELECT * FROM #__cam_rfpsow_linetask WHERE rfp_id = '.$rfp_id ;
		$db->Setquery($sql);
		$TASK_details = $db->loadObjectList();
		//echo "<pre>"; print_r($_REQUEST);
		if($act == 'Preview')
		{
		  for($p=0; $p<count($TASK_details); $p++) //to get task price
		  {
		  $price_sql = 'SELECT item_price FROM #__cam_rfpsow_docs_lineitems_prices  WHERE item_type="task" AND item_id = '.$TASK_details[$p]->task_id.' AND vendor_id = '.$user->id.' AND Alt_bid="'.$Alt_Prp.'"' ;
		  $db->Setquery($price_sql);
		  $price = $db->loadResult();
		  $TASK_details[$p]->price = $price;
		  }
		  for($u=0; $u<count($TASK_details); $u++)//to get task related uploaded files
		  {
		   $upld_sql = 'SELECT upload_doc FROM #__cam_rfpsow_uploadfiles  WHERE spl_req = "No" AND task_id = '.$TASK_details[$u]->task_id.' AND rfp_id ='.$rfp_id.' AND vendor_id='.$user->id.' AND Alt_bid="'.$Alt_Prp.'"'  ;
		  $db->Setquery($upld_sql);
		  $upld_file = $db->loadResultArray();
		  $TASK_details[$u]->uploaded_file = $upld_file;
		  $upld_sql = 'SELECT id FROM #__cam_rfpsow_uploadfiles  WHERE spl_req = "No" AND task_id = '.$TASK_details[$u]->task_id.' AND rfp_id ='.$rfp_id.' AND vendor_id='.$user->id.' AND Alt_bid="'.$Alt_Prp.'"'  ;
		  $db->Setquery($upld_sql);
		  $upld_doc_ids = $db->loadResultArray();
		  $TASK_details[$u]->uploaded_doc_ids = $upld_doc_ids;
		  $upld_title = array();
		   for($i=0; $i<count($upld_file); $i++)
			{
		 		$arr = explode('/',$upld_file[$i]);
 		 		$cnt = count($arr);
		 		$upld_title[$i] = $arr[$cnt-1];
			}
			$TASK_details[$u]->uploadfile_title = $upld_title;
			$db = JFactory::getDBO();
			$spl_req = 'No';
			$task_id = $TASK_details[$u]->task_id;
			$vendor_id = JRequest::getVar('vendorid','');
		    $sql = 'SELECT add_notes FROM #__cam_rfpsow_addnotes  WHERE status = "active" AND spl_req = "'.$spl_req.'" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$vendor_id.' AND task_id='.$task_id.' AND Alt_bid="'.$Alt_Prp.'"' ;
			$db->Setquery($sql);
			$db->query();
		  	$TASK_details[$u]->addnotes_desc = $db->loadResultArray();
			$sql = 'SELECT add_exception,check_exception FROM #__cam_rfpsow_addexception  WHERE status = "active" AND spl_req = "'.$spl_req.'" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$vendor_id.' AND task_id='.$task_id.' AND Alt_bid="'.$Alt_Prp.'"' ;
			$db->Setquery($sql);
			$db->query();
                     $result_exception=$db->loadObjectList();
                         $TASK_details[$u]->exception_desc = $result_exception[0]->add_exception;
                         $TASK_details[$u]->check_exception = $result_exception[0]->check_exception;
		  }


		}
		//echo "<pre>"; print_r($TASK_details); exit;
		return $TASK_details;
	}


	function get_TASKSinfo_preview_basic($act,$Alt_Prp)
	{
	    $db = JFactory::getDBO();
		$rfp_id = JRequest::getVar('rfp_id','');
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$sql = 'SELECT * FROM #__cam_rfpsow_linetask WHERE rfp_id = '.$rfp_id ;
		$db->Setquery($sql);
		$TASK_details = $db->loadObjectList();
		//echo "<pre>"; print_r($_REQUEST);
		if($act == 'Preview')
		{
		  for($p=0; $p<count($TASK_details); $p++) //to get task price
		  {
		  $price_sql = 'SELECT item_price FROM #__cam_rfpsow_docs_lineitems_prices  WHERE item_type="task" AND vendor_id = '.$user->id.' AND Alt_bid="'.$Alt_Prp.'"' ;
		  $db->Setquery($price_sql);
		  $price = $db->loadResult();
		  $TASK_details[$p]->price = $price;
		  }
		  for($u=0; $u<count($TASK_details); $u++)//to get task related uploaded files
		  {
		   $upld_sql = 'SELECT DISTINCT upload_doc FROM #__cam_rfpsow_uploadfiles  WHERE spl_req = "No" AND rfp_id ='.$rfp_id.' AND vendor_id='.$user->id.' AND Alt_bid="'.$Alt_Prp.'"'  ;
		  $db->Setquery($upld_sql);
		  $upld_file = $db->loadResultArray();
		  $TASK_details[$u]->uploaded_file = $upld_file;
		  $upld_sql = 'SELECT id FROM #__cam_rfpsow_uploadfiles  WHERE spl_req = "No" AND rfp_id ='.$rfp_id.' AND vendor_id='.$user->id.' AND Alt_bid="'.$Alt_Prp.'"'  ;
		  $db->Setquery($upld_sql);
		  $upld_doc_ids = $db->loadResultArray();
		  $TASK_details[$u]->uploaded_doc_ids = $upld_doc_ids;
		  $upld_title = array();
		   for($i=0; $i<count($upld_file); $i++)
			{
		 		$arr = explode('/',$upld_file[$i]);
 		 		$cnt = count($arr);
		 		$upld_title[$i] = $arr[$cnt-1];
			}
			$TASK_details[$u]->uploadfile_title = $upld_title;
			$db = JFactory::getDBO();
			$spl_req = 'No';
			$task_id = $TASK_details[$u]->task_id;
			$vendor_id = JRequest::getVar('vendorid','');
		    $sql = 'SELECT add_notes FROM #__cam_rfpsow_addnotes  WHERE status = "active" AND spl_req = "'.$spl_req.'" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$vendor_id.' AND Alt_bid="'.$Alt_Prp.'"order by id desc' ;
			$db->Setquery($sql);
			$db->query();
		  	$TASK_details[$u]->addnotes_desc = $db->loadResultArray();
			$sql = 'SELECT add_exception,check_exception FROM #__cam_rfpsow_addexception  WHERE status = "active" AND spl_req = "'.$spl_req.'" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$vendor_id.' AND Alt_bid="'.$Alt_Prp.'" order by id desc' ;
			
			$db->Setquery($sql);
			$db->query();
                     $result_exception=$db->loadObjectList();
                         $TASK_details[$u]->exception_desc = $result_exception[0]->add_exception;
                         $TASK_details[$u]->check_exception = $result_exception[0]->check_exception;
		  }


		}
		//echo "<pre>"; print_r($TASK_details); exit;
		return $TASK_details;
	}
	//function to get RFP special requirements tabs Addnotes, Uploadfile, Addexception links
	function get_SPLRequirements_Preview($act,$Alt_Prp)
	{
		$rfp_id = JRequest::getVar('rfp_id','');
		$db = JFactory::getDBO();
		$vendorid = JRequest::getVar('vendorid');
		 $user	= JFactory::getUser($vendorid);
		$upld_sql = 'SELECT upload_doc FROM #__cam_rfpsow_uploadfiles  WHERE (status="active" OR status="") AND spl_req = "Yes" AND task_id = 0 AND rfp_id ='.$rfp_id.' AND vendor_id='.$user->id.' AND Alt_bid="'.$Alt_Prp .'"' ;
		$db->Setquery($upld_sql);
		$upld_file = $db->loadResultArray();
		$SPL_REQ_tabs[0]->uploaded_file = $upld_file;
		$upld_sql = 'SELECT id FROM #__cam_rfpsow_uploadfiles  WHERE (status="active" OR status="") AND spl_req = "Yes" AND task_id = 0 AND rfp_id ='.$rfp_id.' AND vendor_id='.$user->id.' AND Alt_bid="'.$Alt_Prp.'"'   ;
		$db->Setquery($upld_sql);
		$upld_ids = $db->loadResultArray();
		$SPL_REQ_tabs[1]->uploaded_doc_ids = $upld_ids;
		$upld_title = array();
		for($i=0; $i<count($upld_file); $i++)
		{
		$arr = explode('/',$upld_file[$i]);
		$cnt = count($arr);
		$upld_title[$i] = $arr[$cnt-1];
		}
		$SPL_REQ_tabs[2]->uploadfile_title = $upld_title;

		$db = JFactory::getDBO();
		$spl_req = 'Yes';
		$task_id = 0;
		$vendor_id = JRequest::getVar('vendorid','');
		$sql = 'SELECT add_notes FROM #__cam_rfpsow_addnotes  WHERE (status="active" OR status="") AND spl_req = "'.$spl_req.'" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$vendor_id.' AND task_id='.$task_id.' AND Alt_bid="'.$Alt_Prp.'"' ;
		$db->Setquery($sql);
		$db->query();
		$SPL_REQ_tabs[3]->addnotes_desc = $db->loadResultArray();
		$sql = 'SELECT add_exception FROM #__cam_rfpsow_addexception  WHERE (status="active" OR status="") AND spl_req = "'.$spl_req.'" AND rfp_id = '.$rfp_id.' AND vendor_id ='.$vendor_id.' AND task_id='.$task_id.' AND Alt_bid="'.$Alt_Prp.'"' ;
		$db->Setquery($sql);
		$db->query();
		$SPL_REQ_tabs[4]->exception_desc = $db->loadResultArray();
		//echo "<pre>"; print_r($SPL_REQ_tabs);
		return $SPL_REQ_tabs;
	}

	function getbasicuploadfiles(){
		$db=&JFactory::getDBO();
		$rfp_id = JRequest::getVar('rfp_id','');
		$query_basic = "SELECT * FROM #__cam_basicrequest_files WHERE rfpid=".$rfp_id." and filename!=''  ";
		$db->setQuery($query_basic);
		$basefiles = $db->loadObjectList();
		return $basefiles;
	}

}
?>
