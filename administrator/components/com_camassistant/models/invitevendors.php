<?php
/**
 * @version		1.0.0 cam assistant $
 * @package		cam_assistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport( 'joomla.application.component.model' );

class invitevendorsModelinvitevendors extends Jmodel
{
	/**
	 * helloworld data
	 *
	 * @var array
	 */
	var $_data = null;
	/**
	 * Category total
	 *
	 * @var integer
	 */
	var $_total = null;

	/**
	 * Pagination object
	 *
	 * @var object
	 */
	var $_pagination = null;

  /**
	 * table_prefix - table prefix for all component table
	 * 
	 * @var string
	 */
	var $_table_prefix = null;
	
	/**
	 * Constructor
	 *
	 * @since 1.5
	 */
	function __construct()
	{
		parent::__construct();

		global $mainframe, $context;

		//initialize class property
	  $this->_table_prefix = 'hotelex_';	
	  
		//DEVNOTE: Get the pagination request variables
		$limit			= $mainframe->getUserStateFromRequest( $context.'limit', 'limit', $mainframe->getCfg('list_limit'), 0);
		$limitstart = $mainframe->getUserStateFromRequest( $context.'limitstart', 'limitstart', 0 );
		$filter_order		= $mainframe->getUserStateFromRequest( $context.'filter_order',		'filter_order',		'affid',	'cmd' );
		$filter_order_Dir	= $mainframe->getUserStateFromRequest( $context.'filter_order_Dir',	'filter_order_Dir',	'asc',			'word' );

		$this->setState('limit', $limit);
		$this->setState('limitstart', $limitstart);

	}
	
	
	/**
	 * Method to get a helloworld data
	 *
	 * this method is called from the owner VIEW by VIEW->get('Data');
	 * - get list of all helloworld for the current data page.
	 * - pagination is spec. by variables limitstart,limit.
	 * - ordering of list is build in _buildContentOrderBy  	 	 	  	 
	 * @since 1.5
	 */
	function getData()
	{
		//DEVNOTE: Lets load the content if it doesn't already exist
		if (empty($this->_data))
		{
			 $query = $this->_buildQuery(); 
			$this->_data = $this->_getList($query, $this->getState('limitstart'), $this->getState('limit'));
		}

		return $this->_data;
}

	/**
	 * Method to get the total number of helloworld items
	 *
	 * @access public
	 * @return integer
	 */
	function getTotal()
	{
		//DEVNOTE: Lets load the content if it doesn't already exist
		if (empty($this->_total))
		{
			$query = $this->_buildQuery();
			$this->_total = $this->_getListCount($query);
		}

		return $this->_total;
	}
	
	/**
	 * Method to get a pagination object for the helloworld
	 *
	 * @access public
	 * @return integer
	 */
	function getPagination()
	{
		// Lets load the content if it doesn't already exist
		if (empty($this->_pagination))
		{
			jimport('joomla.html.pagination');
			$this->_pagination = new JPagination( $this->getTotal(), $this->getState('limitstart'), $this->getState('limit') );
		}

		return $this->_pagination;
	}
  	
	function _buildQuery()
	{
			$orderby	= $this->_buildContentOrderBy();
			$vendortype = JRequest::getVar( 'vendortype','' );
			$camid = JRequest::getVar( 'camid','' );
			if($vendortype)
			$where[] = 'U.vendortype="'.$vendortype.'"';
			if($camid)
			$where[] = 'U.userid="'.$camid.'"';
			$where[] = 'U.userid=V.id';
			$wherecon=implode(' and ',$where);
			$query = "SELECT U.*,V.name,V.lastname,V.email,U.invitedate FROM #__vendor_inviteinfo as U, #__users as V where ".$wherecon."  ".$orderby.""; 
			
			return $query;

	}
	function _buildContentOrderBy()
		{
		global $mainframe, $context;
		$filter_order		= JRequest::getWord('filter_order');
		if($filter_order == '')
		$filter_order = 'invitedate';
		else
		$filter_order = $filter_order;
		$filter_order_Dir = $mainframe->getUserStateFromRequest( $context.'filter_order_Dir',  'filter_order_Dir', '' );	
		if($filter_order_Dir == '')
		$filter_order_Dir = 'DESC';
		else
		$filter_order_Dir = $filter_order_Dir ;
		
		if($filter_order == 'date')
		$filter_order = 'invitedate';
		else
		$filter_order = $filter_order ;
		$orderby 	= ' ORDER BY '. $filter_order .' '. $filter_order_Dir;
		
		return $orderby;
		}
		
	 function delete($id = array())
	{
		
	    $db			=& JFactory::getDBO();
		$user		=& JFactory::getUser();
		//$id		= JRequest::getVar( 'id', array(), 'post', 'array' );
		$task		= JRequest::getCmd( 'task' );
		$publish	= 0;

		if (count( $id ))
		{

			$ids = implode( ',', $id );
		 	$query = 'DELETE FROM #__vendor_inviteinfo where vid IN ( '.$ids.' ) ';
			$db->setQuery( $query );
			if(!$db->query()) {
			$db->setError($db->getErrorMsg());
			return false;
			}
		}

	
		return false;
	}
	function store($data){
//	echo "<pre>"; print_r($post); exit;
	$row =& $this->getTable('invitevendors');
	//echo "<pre>"; print_r($row);print_r($post); exit;
		jimport('joomla.user.helper');
		// Bind the form fields to the  table
		if (!$row->bind($data)) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}
		if (!$row->store()) {
			$this->setError($this->_db->getErrorMsg());
			return false;
		}

		return true;
	}
	//function to get the all managers
	function getallmanagers(){
	$db = JFactory::getDBO();
	$all_managers = "SELECT * from #__users  where user_type =13  order by name ASC";
	$db->setQuery($all_managers);
	$managers=$db->loadObjectList();
	return $managers;
	}
	//function to get the random number
	function getfei($email,$userid){
	$db = JFactory::getDBO();
	$before_invites = "SELECT vid from #__vendor_inviteinfo  where userid =".$userid."  and inhousevendors ='".$email."' ";
	$db->setQuery($before_invites);
	$invites=$db->loadResult();
	if($invites){
	$fei = "SELECT fei from #__vendor_inviteinfo  where userid =".$userid." and  inhousevendors ='".$email."' ";
	$db->setQuery($fei);
	$random_code=$db->loadResult();
	}
	else{
	srand ((double) microtime( )*1000000);
	$random_code = rand();
	}
	return $random_code;
	}
	
	//function to get the body measage
	function getbody($fei,$vendortype,$to,$userid,$subject,$articletype){
		$db = JFactory::getDBO();
		$exists = "SELECT id from #__users  where email ='".$to."' ";
		$db->setQuery($exists);
		$exist=$db->loadResult();
		
		if($articletype == 'normal'){
			if($exist && $vendortype=='preferred') {
			$exists = "SELECT introtext  FROM #__content where id='152'"; }
			if($exist && $vendortype=='inhouse')  {
			$exists = "SELECT introtext  FROM #__content where id='151'"; } 
			if(!$exist && $vendortype=='inhouse') {
			$exists = "SELECT introtext  FROM #__content where id='159'"; }
			if(!$exist && $vendortype=='preferred') {
			$exists = "SELECT introtext  FROM #__content where id='160'"; }
			$db->setQuery($exists);
			$text=$db->loadResult();
			//get camfirm details
			$camdetails = "SELECT name,lastname from #__users  where id =".$userid." ";
			$db->setQuery($camdetails);
			$camfirm=$db->loadObject();
			$firmname = $camfirm->name.'&nbsp;'.$camfirm->lastname;
			$activation ='https://www.myvendorcenter.com/live/index.php?option=com_camassistant&controller=vendorsaccept&task=vendorsaccept&vendor_type='.$vendortype.'&view=vendorsaccept&Itemid=153&inv_code='.$fei.'&mailid='.$to.'&camid='.$userid.'&Itemid=153 ';
			$activation = '<a href='.$activation.'>'.$activation.'</a>';
			
			$body = str_replace('{CAM Firm}',$firmname,$text);
			$body = $body.'<br>Activation LINK:<br>'.$activation;
			}
		else{
		$new_msg = "SELECT introtext  FROM #__content where id='211'";
		$db->setQuery($new_msg);
		$high_msg=$db->loadResult();
		//TO get the total cam,firm details
		$camfirm = "SELECT U.name,U.lastname,U.email,V.comp_name,V.mailaddress,V.comp_phno,V.comp_extnno,V.comp_website from #__users as U, #__cam_customer_companyinfo as V  where U.id =".$userid." and V.cust_id=".$userid." ";
		$db->setQuery($camfirm);
		$cam=$db->loadObject();
		$firmname = $cam->name.'&nbsp;'.$cam->lastname;
		$firmname = $firmname."<br>".$cam->comp_name."<br>"; 
		$firmname = $firmname."Director of On-Site Communities<br>Director of Training and Education<br><br>";
		$high_msg = str_replace('{CAMFIRM}',$firmname,$high_msg);
		//Completed
		$activation ='https://www.myvendorcenter.com/live/index.php?option=com_camassistant&controller=vendorsaccept&task=vendorsaccept&vendor_type='.$vendortype.'&view=vendorsaccept&Itemid=153&inv_code='.$fei.'&mailid='.$to.'&camid='.$userid.'&Itemid=153 ';
		$activation = '<a href='.$activation.'>'.$activation.'</a>';
		$high_msg = str_replace('{ACCEPTANCE LINK}',$activation,$high_msg);
		//To get the total camfirm details
		$firmdetails = $cam->name.'&nbsp;'.$cam->lastname;
		$firmdetails = "<br>".$firmdetails.", CMCA, AMS, PCAM<br>";
		$firmdetails = $firmdetails."Director of On-Site Communities<br>Director of Training and Education<br>";
		$firmdetails = $firmdetails.$cam->comp_name."<br>";
		$firmdetails = $firmdetails."An Associa Member Company"."<br>";
		$firmdetails = $firmdetails."Associa--The leader in community association management"."<br>";
		$firmdetails = $firmdetails.$cam->mailaddress."<br>";
		$firmdetails = $firmdetails.$cam->comp_phno."&nbsp;ext.&nbsp;".$cam->comp_extnno."&nbsp;Office<br>";
		$firmdetails = $firmdetails.$cam->email."<br>";
		$firmdetails = $firmdetails.$cam->comp_website."<br>";
		$high_msg = str_replace('{TOTAL DETAILS}',$firmdetails,$high_msg);
		//Completed

		$body = $high_msg;
		}

		return $body;
	}
	//function to check the user exists or not
	function getcheck($to,$userid){
	$db = JFactory::getDBO();
	$exists = "SELECT vid from #__vendor_inviteinfo  where userid =".$userid." and inhousevendors='".$to."' ";
	$db->setQuery($exists);
	$vid=$db->loadResult();
	return $vid;
	}
	//function to get the taxid
	function getchecktax($tax){
	$db = JFactory::getDBO();
	$v_details = "SELECT U.id,U.email from #__users as U, #__cam_vendor_company as V where  U.id=V.user_id and V.tax_id ='".$tax."' ";
	$db->setQuery($v_details);
	$v_details=$db->loadObject();
	return $v_details;
	}
	
	function getbodymsg(){
	$db = JFactory::getDBO();
	$body_msg = "SELECT introtext  FROM #__content where id='152'";
	$db->setQuery($body_msg);
	$msg=$db->loadResult();
	return $msg;
	}
	
	function store_invites($post){
		
		$db = JFactory::getDBO();
		$date = date('Y-m-d');
		$query = "insert into #__cam_newvendorinvitations (`id`, `managerid`, `vendoremailid`, `vendorid`, `date`, `articletype`) VALUES ('','".$post['userid']."','".$post['inhouse']."','','".$date."','".$post['articletype']."')";
		$db->setQuery($query);
		$save_data = $db->query();
		return $save_data ;
	}
	
	/*function _buildContentOrderBy_pre()
		{
		global $mainframe, $context;
		$filter_order		= JRequest::getWord('filter_order');
		if($filter_order == '')
		$filter_order = 'date';
		else
		$filter_order = $filter_order;
		$filter_order_Dir = $mainframe->getUserStateFromRequest( $context.'filter_order_Dir',  'filter_order_Dir', '' );	
		
		if($filter_order_Dir == 'asc')
		$filter_order_Dir = 'ASC';
		else
		$filter_order_Dir = $filter_order_Dir ;
		$orderby 	= ' ORDER BY '. $filter_order .' '. $filter_order_Dir;
		echo $orderby;
		return $orderby;
		}*/
		
	function getnewinvitations(){
		$db = JFactory::getDBO();
			//$orderby	= $this->_buildContentOrderBy_pre();
			$camid = JRequest::getVar( 'camid','' );
			if($camid)
			$where_n[] = 'U.managerid="'.$camid.'"';
			$where_n[] = 'U.managerid=V.id';
			$wherecon_n = implode(' and ',$where_n);
			//else
			//$wherecon_n = " U.managerid = V.id ";
		$previous_invitations = "SELECT U.*,V.name,V.lastname,V.email FROM #__cam_newvendorinvitations as U, #__users as V where ".$wherecon_n." "; 
		$db->setQuery($previous_invitations);
		$previous = $db->loadObjectList();
		return $previous;
	}
}
?>