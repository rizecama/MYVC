<?php error_reporting(E_ALL);
/**
 * @version		1.0.0 camassistant $
 * @package		camassistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport('joomla.application.component.controller');

class rfpController extends JController
{

	function __construct()
	{
		parent::__construct();
	}

	function display()
	{
		parent::display();
	}

	function resendactivation()
	{
		$userid			=	Jrequest::getVar('cust_id', '');
		$vend_id		=	Jrequest::getVar('vend_id', '');
		$rfp_id			=	Jrequest::getVar('rfp_id', '');
		$choose_tasks	=	Jrequest::getVar('choose_tasks', '');
		$property_id	=	Jrequest::getVar('property_id', '');
		$Vendor		= 	JFactory::getUser($vend_id);
		$vendor_name 	= 	$Vendor->name.'&nbsp;'.$Vendor->lastname;
		$vendoremail	=	$Vendor->email;
		//code to get customer, camfirm users details
		$db				=	JFactory::getDBO();
		$Manager		= 	JFactory::getUser($userid);
		$Managername 	= 	$Manager->name.'&nbsp;'.$Manager->lastname;
		$camfirmid_sql	= 	"SELECT comp_id FROM #__cam_customer_companyinfo WHERE cust_id=".$userid;
		$db->SetQuery($camfirmid_sql);
		$camfirmid_res	= $db->loadResult();
		if($camfirmid_res == '0') {
			$Camfirmname = '';
		} else {
				$camfirmid_sql = "SELECT cust_id FROM #__cam_camfirminfo  WHERE id=".$camfirmid_res;
				$db->SetQuery($camfirmid_sql);
				$camfirmid_res = $db->loadResult();
				$camfirmuser = JFactory::getUser($camfirmid_res);
				$Camfirmname = $camfirmuser->name.'&nbsp;'.$camfirmuser->lastname;
		}
		// end of code to get customer, camfirm users details

		//code to get email content from article
		$rfpinvite = "SELECT introtext  FROM #__content where id='162'";
		$db->setQuery($rfpinvite);
		$inviterfp 	= $db->loadResult();
		$vendorid 	= $vend_id;
		$db 		= &JFactory::getDbo();
		//end of code to get email content from article

		//code to check vendor user type  preferred or inhouse or normal
		$query_prefer = "SELECT  v_id FROM  #__vendor_inviteinfo WHERE (vendortype = 'preferred' or vendortype = 'inhouse') AND status=1 AND userid=".$vend_id;
		$db->setQuery($query_prefer);
		$preferred_vendors = $db->loadObjectList();

		if($preferred_vendors){
		foreach($preferred_vendors as $vid){
		$preferred[] = $vid->v_id;
		}//end for foreach
		}//end for if loop

		if(is_array($preferred) && count($preferred)>0){
			if(in_array($vend_id,$preferred)){
			$publish = 1;
			$vendor_type = 'prefer';
			$vendoremail = $vendoremail;
			} else {
			$publish = 0;
			$vendor_type = 'normal';
			$vendoremail = '';
			} // end for if(in_array($vend_id,$preferred))
		}else{
		$publish = 1;
		$vendor_type = 'prefer';
		$vendoremail = $vendoremail;
		} // end for if(count($preferred))

		// end of  code to check vendor user type  preferred or inhouse or normal

		//code to validate pre-invitation has been sent to user or not, if not have to insert into rfp_emails, vendor_availablejob tables , if exist need to update        rfp_emails table
		$sql_vend	=	"SELECT id FROM  #__cam_rfp_emails WHERE rfp_id	=	".$rfp_id."	AND user_id	=	".$vend_id;
		$db->SetQuery($sql_vend);
		$is_id	=	$db->loadResult();
		//echo '<pre>'; print_r($is_id); exit;
		if($is_id){
			$update_sql	=	"UPDATE #__cam_rfp_emails SET invitation_type	=	'resending' WHERE rfp_id	=	".$rfp_id."	AND user_id	=	".$vend_id;
			$db->SetQuery($update_sql);
			$db->query();


		} else {
			$insert_sql = "insert into #__cam_rfp_emails values ('','".$rfp_id."','".$vend_id."','".$publish."','".$vendor_type."','".$userid."','resending')";
			$db->SetQuery($insert_sql);
			$db->query();
		}
			$sql_vend	=	"SELECT id FROM  #__cam_vendor_availablejobs WHERE status	=	'0' AND rfp_id	=	".$rfp_id."	AND user_id	=	".$vend_id;
			$db->SetQuery($sql_vend);
			$job_id	=	$db->loadResult();
			if(!$job_id){
			$insert_sql2 = "insert into #__cam_vendor_availablejobs values ('','".$rfp_id."','".$vend_id."','".$property_id."','0','".$publish."')";
			$db->SetQuery($insert_sql2);
			$db->query();

			$job_id	=	$db->insertid();
		}
		//end of code to validate pre-invitation
		//$siteURL		= JURI::root();
		$siteURL		= str_replace('www.','',JURI::root());
		$link = $siteURL.'index.php?option=com_camassistant&controller=proposals&Itemid=148&task=vendor_proposal_form&view=proposals&amp;Prp_id='.$property_id.'&id='.$job_id.'&rfp_id='.$rfp_id.'';
		if($choose_tasks=='3'){
			$vendors = "SELECT introtext FROM #__content where id='155'";
			$db->setQuery($vendors);
			$body = $db->loadResult();
			//$body = $inviterfp;
		} else if(($choose_tasks=='2')||($choose_tasks=='2choose')||($choose_tasks=='Engineer')||($choose_tasks=='Architect')){
			$hirea = "SELECT introtext FROM #__content where id='154'";
			$db->setQuery($hirea);
			$body = $db->loadResult();
		} else {
			$body = $inviterfp;
		}
		//$vendor_name=$vendorsinfo[$i][0]->name.' '.$vendorsinfo[$i][0]->lastname;
		//$body = $inviterfp;

		$body = str_replace('{RFP NUMBER}', $rfp_id, $body);
		$body = str_replace('{RFP NUMBER}',sprintf('%06d', $rfp_id), $body);
		$body = str_replace('{vendor Name}', $vendor_name, $body);
		$body = str_replace('{link}', '<a href="'.$link.'">CLICK HERE</a>', $body);
		$body = str_replace('{CLICK HERE link}', '<a href="'.$link.'">CLICK HERE</a>', $body);
		$body = str_replace('{camName}', 'CAMassitant', $body);
		$body = str_replace('{Managername}', $Managername, $body);
		$body = str_replace('{Camfirmname}', $Camfirmname, $body);

		//end - code to get Mangaername, Camfirmname
		$sub='RFP Invitation from CAMassistant';
		$from_name='CAMassistant Support';
		$from_email='Support@CAMassistant.com';
		//echo "<pre>"; print_r($vendoremail); echo "end";

		if($vendoremail != ''){
		JUtility::sendMail($from_email, $from_name, $vendoremail, $sub, $body,$mode = 1);
		}

               $query_cc ="select ccemail from #__users Where id =".$vend_id;
		$db->setQuery($query_cc);
		$cc = $db->loadResult();
		$cclist = explode(';',$cc);
		for($c=0; $c<=count($cclist); $c++){
		$listcc = $cclist[$c];
		if($listcc){
		$res = JUtility::sendMail($from_email, $from_name, $listcc, $sub, $body, $mode=1);
		}
		}
              

	$this->setRedirect('index.php?option=com_camassistant&controller=rfp&task=itb_tool&rfp_id='.$rfp_id,'Invitation Sent Successfully');

	}

	function back(){
	$industry_id=JRequest::getVar('industry_id');
	$industryid=JRequest::getVar('industryid');
	if($industry_id){
	$industry_id=$industry_id;
	} else {
	$industry_id=$industryid;
	}
	$rfpstatus=JRequest::getVar('rfpstatus');
	$rfpapproval=JRequest::getVar('rfpapproval');
	$search=JRequest::getVar('search');
    $rfp_id=JRequest::getVar('rfp_id');
	$var = JRequest::getVar('var');
//echo '<pre>'; print_r($_REQUEST); exit;
if($var == 'el' || $var == 'inel' ){
   $this->setRedirect('index.php?option=com_camassistant&controller=rfp&task=edit&cid[]='.$rfp_id.'&industryid='.$industry_id.'&rfpstatus='.$rfpstatus.'&rfpapproval='.$rfpapproval.'&search='.$search);
} else  {
	$this->setRedirect('index.php?option=com_camassistant&controller=rfp&industry_id='.$industry_id.'&rfpstatus='.$rfpstatus.'&rfpapproval='.$rfpapproval.'&search='.$search);
      }
    }
	//function to send mail for rejecter proposals of RFP
	function reject_proposal_mail()
	{
	$reject_body =  JRequest::getVar('reject_body', '', 'post', 'string', JREQUEST_ALLOWRAW);
	$db = JFactory::getDBO();
	$from_email='support@myvendorcenter.com';
	$from_name='MyVendorCenter.com';
	$vendoremail =  JRequest::getVar('recipient');
	$sub = JRequest::getVar('subject');
	$body=nl2br($reject_body);
	$rfp_id=JRequest::getVar('rfp_id');
       $industryid  =  JRequest::getVar('industryid', '');
		$rfpstatus  =  JRequest::getVar('rfpstatus', '');
        $rfpapproval  =  JRequest::getVar('rfpapproval', '');
		$search  =  JRequest::getVar('search', '');
	$proposal_id =  JRequest::getVar('proposal_id');
	$sql = "Update #__cam_vendor_proposals set publish  =  '2' , proposaltype = 'Draft'  where  id  =  ".$proposal_id;
	$db->Setquery($sql);
	$db->query();
	$successMail =JUtility::sendMail($from_email, $from_name, $vendoremail, $sub, $body,$mode = 1);
	echo "<script language='javascript' type='text/javascript'>
	window.parent.document.getElementById( 'sbox-window' ).close();
	alert('Rejected Successfully');
	parent.location.reload();
	</script>";
	exit;
	$this->setRedirect('index.php?option=com_camassistant&controller=rfp&task=rfp_bids&industryid='.$industryid.'&rfpstatus='.$rfpstatus.'&rfpapproval='.$rfpapproval.'&search='.$search.'&rfp_id='.$rfp_id,'Proposal Rejected Successfully');
	}

	function change_bidstatus()
	{
		$db  =  JFactory::getDBO();
		$id  =  JRequest::getVar('id', '');
		$rfp_id  =  JRequest::getVar('rfp_id', '');
		$status  =  JRequest::getVar('status', '');
          $industryid  =  JRequest::getVar('industryid', '');
		$rfpstatus  =  JRequest::getVar('rfpstatus', '');
        $rfpapproval  =  JRequest::getVar('rfpapproval', '');
		$search  =  JRequest::getVar('search', '');
		$sql = "Update #__cam_vendor_proposals set publish  =  ".$status." where  id  =  ".$id;
		$db->Setquery($sql);
		$db->query();
		$this->setRedirect('index.php?option=com_camassistant&controller=rfp&rfp_id='.$rfp_id.'&industryid='.$industryid.'&rfpstatus='.$rfpstatus.'&rfpapproval='.$rfpapproval.'&search='.$search.'&task=rfp_bids','Updated Successfully');
	}

	function keypath(){
		$db = JFactory::getDBO();
		$rfp_id= $_POST['rfpid'];
		global $mainframe;
		$newrfp_id = 'RFP'.$rfp_id;
		$property_id="SELECT property_id FROM #__cam_rfpinfo where id=".$rfp_id;
		$db->Setquery($property_id);
		$property_id = $db->loadResult();
		//echo '<pre>'; print_r($property_id);
		$property_name ="SELECT property_name FROM #__cam_property where id=".$property_id;
		$db->Setquery($property_name);
		$property_name = $db->loadResult();
		$property_name = str_replace(" ", "_", $property_name);
		echo $key = $property_name.DS.'ProposalReports'.DS.$newrfp_id.DS;
		exit;
	}

	//function to remove rfplist
	function deleterfp($id)
	{
		//echo "<pre>"; print_r($_REQUEST); exit;
		global $mainframe;
	 	$db=&JFactory::getDBO();
		$cid = JRequest::getVar( 'cid', array(0), 'post', 'array' );
		$id = JRequest::getVar( 'id','' );
		$rfpstatus = JRequest::getVar( 'rfpstatus','' );
		if($id){
		$query = "Delete FROM `#__cam_rfpinfo`  WHERE id in (".$id.")";
		$db->setQuery($query);
		$db->Query();

		$query = "Delete FROM `#__cam_rfpsow_linetask`  WHERE rfp_id in (".$id.")";
		$db->setQuery($query);
	    $db->Query();

		$query = "Delete FROM `#__cam_rfpsow_uploadfiles`  WHERE rfp_id in (".$id.")";
		$db->setQuery($query);
		$db->Query();

		$query = "Delete FROM `#__cam_rfpreq_info`  WHERE rfp_id in (".$id.")";
		$db->setQuery($query);
	    $db->Query();

		$query = "Delete FROM `#__cam_vendor_proposals`  WHERE rfpno in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_rfpsow_addnotes`  WHERE rfp_id in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_rfpsow_addexception`  WHERE rfp_id in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_rfpsow_uploadfiles`  WHERE rfp_id in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_vendor_availablejobs`  WHERE rfp_id in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_closedzip`  WHERE rfpid in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
            $query = "Delete FROM `#__cam_awardlist`  WHERE rfpid in (".$id.")";
		$db->setQuery($query);
	    $db->Query();
		}
		if (count( $cid ))
		{
		 $cids = implode( ',', $cid );
		$query = "Delete FROM `#__cam_rfpinfo`  WHERE id in (".$cids.")";
		$db->setQuery($query);
		$db->Query();

		$query = "Delete FROM `#__cam_rfpsow_linetask`  WHERE rfp_id in (".$cids.")";
		$db->setQuery($query);
	    $db->Query();

		$query = "Delete FROM `#__cam_rfpsow_uploadfiles`  WHERE rfp_id in (".$cids.")";
		$db->setQuery($query);
		$db->Query();

		$query = "Delete FROM `#__cam_rfpreq_info`  WHERE rfp_id in (".$cids.")";
		$db->setQuery($query);
	    $db->Query();

		$query = "Delete FROM `#__cam_vendor_proposals`  WHERE rfpno in (".$cids.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_rfpsow_addnotes`  WHERE rfp_id in (".$cids.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_rfpsow_addexception`  WHERE rfp_id in (".$cids.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_rfpsow_uploadfiles`  WHERE rfp_id in (".$cids.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_vendor_availablejobs`  WHERE rfp_id in (".$cids.")";
		$db->setQuery($query);
	    $db->Query();
		$query = "Delete FROM `#__cam_closedzip`  WHERE rfpid in (".$cids.")";
		$db->setQuery($query);
	    $db->Query();
            $query = "Delete FROM `#__cam_awardlist`  WHERE rfpid in (".$cids.")";
		$db->setQuery($query);
	    $db->Query();
	  }
	  $msg='Deleted Successfully';
	 $this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&rfpstatus='.$rfpstatus.'',$msg);
	}


	// function to remove rfp bids
	function remove()
	{
		global $mainframe;
		//echo '<pre>'; print_r($_REQUEST);
		$rfp_id = JRequest::getVar( 'rfp_id','' );
		$user_id = JRequest::getVar( 'user_id','' );
		$cid = JRequest::getVar( 'cid', array(0), 'post', 'array' );
		//exit;
		//$cids = implode( ',', $cid );
		// print_r($_REQUEST); exit;
	 	$db = & JFactory::getDBO();
			if (count( $cid ))
		{
			$cids = implode( ',', $cid );
			$get_Altbid = 'SELECT Alt_bid,proposedvendorid FROM #__cam_vendor_proposals WHERE id IN ( '.$cids.' )';
			$db->setQuery($get_Altbid);
			$is_Altbid1 = $db->loadObjectList();
			$is_Altbid=$is_Altbid1[0]->Alt_bid;
			$user_id=$is_Altbid1[0]->proposedvendorid;
			//to delete records from
			$query = 'DELETE FROM #__cam_rfpsow_docs_lineitems_prices WHERE rfp_id ='.$rfp_id.' AND vendor_id='.$user_id.' AND Alt_bid = "'.$is_Altbid.'" ';
			 $db->setQuery( $query );
			if(!$db->query()) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}

			//to delete records from cam_rfpinfo table
			$query = 'DELETE FROM #__cam_vendor_proposals WHERE id IN ( '.$cids.' )';
			 $db->setQuery( $query );
			if(!$db->query()) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}

			//to delete records from cam_rfpsow_addnotes
			 $query = 'DELETE FROM #__cam_rfpsow_addnotes  WHERE rfp_id IN ( '.$rfp_id.' ) AND vendor_id='.$user_id.' AND Alt_bid = "'.$is_Altbid.'" ';
			 $db->setQuery( $query );
			if(!$db->query()) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}

			//to delete records from cam_rfpsow_addnotes
			 $query = 'DELETE FROM #__rfp_invitations  WHERE rfpid IN ( '.$rfp_id.' ) AND vendorid='.$user_id.'  ';
			 $db->setQuery( $query );
			if(!$db->query()) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}
			
			
			//to delete records from cam_rfpsow_addnotes
			$query = 'DELETE FROM #__cam_rfpsow_addexception  WHERE rfp_id IN ( '.$rfp_id.' ) AND vendor_id='.$user_id.' AND Alt_bid = "'.$is_Altbid.'" ';
			$db->setQuery( $query );
			if(!$db->query()) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}
			//to delete rocords from cam_rfpsow_uploadfiles table
			$query = 'DELETE FROM #__cam_rfpsow_uploadfiles  WHERE rfp_id IN ( '.$rfp_id.' ) AND vendor_id='.$user_id.' AND Alt_bid = "'.$is_Altbid.'" ';
			$db->setQuery( $query );
			if(!$db->query()) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}
			if($is_Altbid != 'yes')
		{	$sql = "UPDATE #__cam_vendor_availablejobs SET status='0' where rfp_id='".$rfp_id."' and user_id=".$user_id;
$db->Setquery($sql);
$db->query();
}
			/*//to delete rocords from cam_cam_rfpreq_info table
			$query = 'DELETE FROM #__cam_rfpreq_info  WHERE rfp_id IN ( '.$cids.' )';
			$db->setQuery( $query );
			if(!$db->query()) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}
			//to delete rocords from cam_rfpinfo table
			$query = 'DELETE FROM #__cam_rfpinfo  WHERE id IN ( '.$cids.' )';
			$db->setQuery( $query );
			if(!$db->query()) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}
			//to delete rocords from cam_rfpsow_docs table
			$query = 'DELETE FROM #__cam_rfpsow_docs  WHERE rfp_id IN ( '.$cids.' )';
			$db->setQuery( $query );
			if(!$db->query()) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}
			//to delete rocords from cam_rfpsow_docs table
			$query = 'DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id IN ( '.$cids.' )';
			$db->setQuery( $query );
			if(!$db->query()) {
				$this->setError($this->_db->getErrorMsg());
				return false;
			}*/
			/*if (!is_array( $cid ) || count( $cid ) < 1) {
			JError::raiseError(500, JText::_( 'Select an item to delete' ) );
		}
		$model = $this->getModel('rfp');
		if(!$model->deleterfp($cid)) {
				echo "<script> alert('".$model->getError(true)."'); window.history.go(-1); </script>\n";
			}
		$msg='';*/

		} //return true;
		if($is_Altbid != 'yes')
		{
		$model	=& $this->getModel('rfp');
		$model->get_openjobs($rfp_id);//calling function which updates eligible vendor's available jobs
		}
		$msg='Deleted Successfully';
		$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&rfpstatus=rfp',$msg);

	}

	function add()
	{
		JRequest::setVar('view', 'rfp');
		parent::display();
	}
	function rfp_bids()
	{
	JRequest::setVar('view', 'rfp');
	parent::display();
	}
	function itb_tool()
	{
	JRequest::setVar('view', 'rfp');
	parent::display();
	}
	function eligible_vendors()
	{
	JRequest::setVar('view', 'rfp');
	parent::display();
	}
    function edit()
	{
	   JRequest::setVar('view', 'rfp');
		parent::display();
	}


	/* ---Presonal Hired---- */

	function prohired() {

		$sql12="SELECT pro_hired_propertyassociation  FROM #__emails where id='1'";
					$db->Setquery($sql12);
					$data12 = $db->loadResult();
					$bodytext = str_replace('{CUSTOMER NAME}',$data['name'],$data12);
					$bodytext = str_replace('{PROPERTY}',$data['name'],$bodytext);
					$bodytext = str_replace('{PROPERTY ADDRESS}',$data['name'],$bodytext);
					$bodytext = str_replace('{INDUSTRY}',$data['name'],$bodytext);
					$bodytext = str_replace('{GENERAL PROJECT INFORMATION}',$data['name'],$bodytext);

				$mailfrom = 'support@myvendorcenter.com';
				$fromname = 'MyVendorCenter.com';
				$assignuseremail = $post['email'];
				$mailsubject = 'Approved Registration';
				$body = $bodytext;
				JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body,$mode = 1);

	}



function shareinfo() {

if($_POST[load]=='save'){
$db = JFactory::getDBO();
$user = JFactory::getUSer();
$sql = "UPDATE #__users SET showphone='".$_POST['phone']."',showfax='".$_POST['fax']."',	showaddress='".$_POST['address']."',	showcompany='".$_POST['company']."',showemail='".$_POST['email']."' where id='".$user->id."'";
$db->Setquery($sql);
$db->query();

		}
JRequest::setVar('view', 'rfp');
parent::display();



	}
	/* ---End Presonal Hired----*/


	/* ---Sow Hired----*/
	function sowhired() {


				$sql12="SELECT vendors_meet_myproject FROM #__emails where id='1'";
				$db->Setquery($sql12);
				$data12 = $db->loadResult();
				$bodytext = str_replace('{CUSTOMER NAME}',$data['name'],$data12);
				$bodytext = str_replace('{PROPERTY}',$data['name'],$bodytext);
				$bodytext = str_replace('{PROPERTY ADDRESS}',$data['name'],$bodytext);
				$bodytext = str_replace('{INDUSTRY}',$data['name'],$bodytext);
				$bodytext = str_replace('{GENERAL PROJECT INFORMATION}',$data['name'],$bodytext);
				//code to send mail to user

				$config = JFactory::getConfig();
				$mailuser = JFactory::getUser();
				$mailfrom = $config->getValue('config.mailfrom');
				$fromname = $config->getValue('config.fromname');
				$useremail = $mailuser->email;
				$mailsubject = 'Approved Registration';
				$body = $bodytext;
				JUtility::sendMail($mailfrom, $fromname, $useremail, $mailsubject, $body,$mode = 1);

	}

	/* ---End Of Sow Hired----*/

	/* ---End Of Camassitant  Hired----*/
	function hirecamassitant() {

	JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body,$mode = 1);

	}
	/* ---End Of CamAssitant Hired----*/
	function rejectform(){
	//echo '<pre>'; print_r($_REQUEST);
	JRequest::setVar('view', 'rfp');
	parent::display();
	}
        function Uploadfile(){
	//echo '<pre>'; print_r($_REQUEST);
	JRequest::setVar('view', 'rfp');
	parent::display();
	}
         function upload_select(){
	//echo '<pre>'; print_r($_REQUEST);
	JRequest::setVar('view', 'rfp');
	parent::display();
	}
         function save_uploadfile()
	{

		$files		= JRequest::getVar( 'uploadfile', '', 'files', 'array' );
		$post	= JRequest::get('post');
		$rebid	= JRequest::getVar('rebid','');
                $pid	= JRequest::getVar('pid','');
		 $base_Dir = JPATH_ROOT.DS.'components'.DS.'com_camassistant'.DS.'doc'.DS;
		//$base_Dir = JPATH_ROOT.DS.'components'.DS.'com_camassistant'.DS.'assets'.DS.'images'.DS.'rfp'.DS.'Tasks'.DS;
               // echo $base_Dir; exit;
		$filename = $files['name'];
		$filename = ereg_replace(" ", "_", $filename);
		$filename = str_replace(" ", "_", $filename);
		$filename = str_replace("&", "_", $filename);
		$filename = str_replace("#", "_", $filename);
		$filename = str_replace("%", "_", $filename);
                $db = &JFactory::getDbo();
		$pro="SELECT property_name,tax_id,property_manager_id FROM #__cam_property WHERE id='".$pid."'";
		$db->Setquery($pro);
		$pro_res = $db->loadObjectList();

                
        $pro_res[0]->property_name = ereg_replace(" ", "_", $pro_res[0]->property_name);
		$pro_res[0]->property_name = str_replace(" ", "_", $pro_res[0]->property_name);
		$pro_res[0]->property_name = str_replace("&", "_", $pro_res[0]->property_name);
		$pro_res[0]->property_name = str_replace("#", "_", $pro_res[0]->property_name);
		$pro_res[0]->property_name = str_replace("%", "_", $pro_res[0]->property_name);
		 $p_path= $pro_res[0]->property_name.'_'.$pro_res[0]->tax_id.'/';
		//$filepath = $base_Dir.$filename;
                  $dest=$base_Dir.$p_path;
                if(!is_dir($dest))
                mkdir($dest,0777);
                $filepath = $base_Dir.$p_path.$filename;
		move_uploaded_file($files['tmp_name'], $filepath);
		//code to update table
                $post['property_manager_id'] = $pro_res[0]->property_manager_id;
                    $post['property_id'] = $pid;
	//$post['docPath'] = $_REQUEST['path']."/".$_FILES['file']['name'];
                    $filepath1='components/com_camassistant/doc/'.$p_path.'/'.$filename;
                $post['docPath'] = $filepath1; //modified by lalitha
                $post['docTitle'] = $filename;
                $post['docTitle'] = ereg_replace(' ','_',$post['docTitle']);

                $post['parent'] = '0';
              	$model	=& $this->getModel('rfp');
		//code to update table

                $res = $model->store3($post);
		$user	= JFactory::getUser();
		//$data['task_id'] = $post['task_id'];
		//$data['rfp_id'] = $post['rfp_id'];
		//$data['vendor_id'] = $user->id;
		//$warranty = JRequest::getVar('warranty','');
		$taskid = JRequest::getVar('taskid','');
                $user_id = JRequest::getVar('mid','');
		//if(isset($post['spl']) && $post['spl'] == 'Yes')
		//$data['spl_req'] = 'Yes';
		//else
		//$data['spl_req'] = 'No';
		$data['upload_doc'] = 'components/com_camassistant/assets/images/rfp/Tasks/'.$filename;
		//$data['Alt_bid'] = $is_Alt;
		//$model = $this->getModel('proposals');
		//if($rebid == 's')
		//$data['id'] = '';
		//$file_id = $model->save_uploadfile($data);
		//$taskid = $data['task_id'];
		$filename = $filename;
		//$rfp_id = $data['rfp_id'];
	 	$task_id = $taskid;
		$user_id = $user_id;
		//$sql_req = $data['spl_req'];
		//$act = $post['act'];
		//$rebid= $post['rebid'];
		//$Proposal_id= $post['Proposal_id'];
		echo "<script language='javascript' type='text/javascript'>
		window.parent.document.getElementById( 'sbox-window' ).close();
		var taskid = 'uploadfile".$taskid."';
		var filename = '".$filename."';
		var rfpid = '".rfp_id."';
		var task = '".$task_id."';
		var rfpid = '".$rfp_id."';
		var docid = '".$file_id."';
		var userid = '".$user_id."';
		var warranty = '".$warranty."';
		var taskid = '".$taskid."';
		var splreq = '".$sql_req."';
		var AltPrp = '".$is_Alt."';
		var act = '".$act."';
		var rebid = '".$rebid."';
		var Proposal_id = '".$Proposal_id."';
		//var data = 'components/com_camassistant/assets/images/rfp/Tasks/'+filename;

		//var old = window.parent.document.getElementById(taskid).innerHTML;
		window.parent.document.getElementById('lineuploads'+taskid).value =filename;
                window.parent.document.getElementById('delimg'+taskid).style.display ='';
                window.parent.document.getElementById('uploadfile'+taskid).innerHTML =filename;



		//window.parent.document.getElementById(taskid).innerHTML = path+del_path+old;
		 </script>";
		 exit;
		//parent::display();
	}
	function reject(){

	$reject_body =  JRequest::getVar('reject_body', '', 'post', 'string', JREQUEST_ALLOWRAW);
	//JRequest::getVar('html_code', '', 'post' , 'STRING', JREQUEST_ALLOWRAW);


	//$tags = array("<p><p>","</p></p>","<br><br>","<br /><br />");
        //$rtags = array("","\n","\n","\n");
        //$reject_body1 = str_replace($rtags, $tags, $reject_body);
//echo '<pre>'; print_r($reject_body); exit;
	$db = JFactory::getDBO();
	$vendoremail =  JRequest::getVar('recipient');
	$name =  JRequest::getVar('industry_id');

	$body=nl2br($reject_body);
	//$fullname=$_REQUEST['name'].' '.$_REQUEST['lastname'];
	//$body = str_replace('{Manager Name}',$_REQUEST['fullname'],$introtext);
	//$body =  JRequest::getVar('reject_body', '', 'post', 'string', JREQUEST_ALLOWRAW);

	//print_r($body); exit;
	$sub = JRequest::getVar('subject');
	$from_email='support@myvendorcenter.com';
	$from_name='MyVendorCenter.com';
	$industry_id=JRequest::getVar('industry_id');
	$rfpstatus=JRequest::getVar('rfpstatus');
	$rfpapproval=JRequest::getVar('rfpapproval');
	$search=JRequest::getVar('search');
	$status =  JRequest::getVar('status');
	$rfpid=JRequest::getVar('rfp_id');

	$sql = "UPDATE #__cam_rfpinfo SET publish='".$status."',rfp_type='draft' where id='".$rfpid."'";
	$db->setquery($sql);
	$db->query();
	$sql = "UPDATE #__cam_vendor_proposals SET publish='2', proposaltype = 'Draft' where rfpno='".$rfpid."'";
	$db->setquery($sql);
	$db->query();
	$successMail =JUtility::sendMail($from_email, $from_name, $vendoremail, $sub, $body,$mode = 1);
	echo "<script language='javascript' type='text/javascript'>
	window.parent.document.getElementById( 'sbox-window' ).close();
	alert('RFP Rejected Successfully');
	parent.location.reload();
	</script>";
	exit;
	$this->setRedirect('index.php?option=com_camassistant&controller=rfp&industry_id='.$industry_id.'&rfpstatus='.$rfpstatus.'&rfpapproval='.$rfpapproval.'&search='.$search,'RFP Rejected Successfully');

	}
	//chnage status of tfp
function chnagestatus(){
	//$siteURL		= JURI::root();
	//	echo "<pre>"; print_r($_REQUEST); exit;

	$rfpid =  JRequest::getVar('id');
	$industry_id =  JRequest::getVar('industry_id');
	$rfpstatus =  JRequest::getVar('rfpstatus');
	$rfpapproval =  JRequest::getVar('rfpapproval');
	$status =  JRequest::getVar('status');
	$search =  JRequest::getVar('search');
	$db = JFactory::getDBO();
	$details= "SELECT property_id,cust_id,industry_id,choose_tasks FROM #__cam_rfpinfo where id='".$rfpid."'";
	$db->Setquery($details);
	$details1 =$db->loadObjectList();

	$model	=& $this->getModel('rfp');
	if($status=='2'){

	//echo 'sattus'; exit;

	//$sql = "UPDATE #__cam_rfpinfo SET rfp_type='draft',publish='".$status."' where id='".$rfpid."'";
	} else {
	//Delete from the rfp_emails
	$sql_delete_rfpmails='DELETE FROM `#__cam_rfp_emails` WHERE `rfp_id` = '.$rfpid.'';
	$db->setquery($sql_delete_rfpmails);
	$db->query();
	//Completed
	$today = date('Y-m-d H:i:s');
	$sql = "UPDATE #__cam_rfpinfo SET approve_date='".$today."',note_email = 0,publish='".$status."' where id='".$rfpid."'";
	}
//	print_r($details1); exit;
	$db->Setquery($sql);
	$success =$db->query();
	$industry_id= $details1[0]->industry_id;
	$userid=  $details1[0]->cust_id;
	$property_id=  $details1[0]->property_id;
	$choose_tasks=  $details1[0]->choose_tasks;

	if($status=='1'){
	    // $model	=& $this->getModel('rfp');
			$pmdetails=$model->getPManagers($property_id);
			$pr_name=$model->getPropertyName($property_id);
			$from_name='CAMassistant';
			//$from_email=$user->email;
			$from_email='Support@CAMassistant.com';
			$pmemail=$pmdetails[0]->email;
			$sub='RFP Created Info';
			if($pmemail)
			{
				//$sitename=$mainframe->getCfg('sitename');
			//	$getCfgfromname=$mainframe->getCfg('fromname');
				$body_content='';
				$body='';
				$body_content='<table width="100%" border="0" cellspacing="0" cellpadding="0">
								  <tr>
									<td><h3>Congratulations!</h3></td>
								  </tr>
								  <tr>
									<td>An RFP has been successfully submitted to the CAMASSISTANT Network for the property <strong>"'.ucwords($pr_name).'"</strong> </td>
								  </tr>
								  <tr>
									<td>&nbsp;</td>
								  </tr>
								</table>';
				$body = '<table width="100%" border="0" cellspacing="0" cellpadding="0">
					 <tr>
					   <td width="20%"><span style="font-family: Helvetica,Arial,sans-serif;">Hi '.ucwords($pmdetails[0]->name).'</span></td>
					   <td>&nbsp;</td>
					 </tr>
					  <tr>
					   <td width="20%">&nbsp;</td>
					   <td>&nbsp;</td>
					 </tr>
					 <tr>
					 <td colspan="2">'.$body_content.'</td>
					 </tr>
					  <tr>
					   <td>Regards</td>
					   <td>&nbsp;</td>
					 </tr>';
					/*  <tr>
					   <td>'.ucfirst($user->name).'</td>
					   <td>&nbsp;</td>
					 </tr>*/
					$body .= ' <tr>
					   <td>CAMASSISTANT NETWORK</td>
					   <td>&nbsp;</td>
					 </tr>
				   </table>';
				//$successMail =JUtility::sendMail($from_email, $from_name, $pmemail, $sub, $body,1);
			}

			//exit;
			//Code for sending RFP Emails to Vendors for the related Industry
			//$pr_name=$model->getPropertyName($property_id);

			if($choose_tasks=='Engineer')
			$industry_id=47;
			if($choose_tasks=='Architect')
			$industry_id=23;
			//print_r($rfpid);  exit;
			$model->rfp_requirements_validations($industry_id,$userid,$property_id,$rfpid,$choose_tasks);
			//$vendorsinfo=$model->getVendors($industry_id,$userid,$property_id);
			//echo "<pre>"; print_r($vendorsinfo);

			//anandkumar modifyied by 27-7-11
			/*if(count($vendorsinfo)>0)
			{
			  for($i=0;$i<count($vendorsinfo);$i++)
			  {
			  $flag = 0;
			   //echo $flag;
			   //echo $vendorsinfo[$i][0]->id; echo '----------';
			   //code to validate specialrequirements
				$sql = "SELECT distinct(req_parentid ) FROM #__cam_rfpreq_info WHERE rfp_id ='".$rfpid."'";
				$db->Setquery($sql);
				$main = $db->loadResultArray();
				$sql = "SELECT req_subparentid  FROM #__cam_rfpreq_info WHERE req_subparentid !=0 AND rfp_id ='".$rfpid."'";
				$db->Setquery($sql);
				$sub = $db->loadResultArray();
				// echo "<pre>"; print_r($main); print_r($sub); exit;
				//$flag = 0;

				for($m = 0; $m<count($main); $m++)
				{
				// echo "<pre>"; print_r($main);
				  switch($main[$m])
				  {

				  case 1:
						for($h=0;$h<count($sub); $h++){
						//print_r($vendorsinfo[$i][0]->id); echo "--------"; print_r($sub[$h]);
							 switch($sub[$h])
							  {

									//print_r($flag);	echo "flag";
						case 17:
								if($flag==0){
									$sql = "SELECT id  FROM #__cam_vendor_professional_license  WHERE PLN_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;
									  $db->Setquery($sql);
									  $PLN = $db->loadResultArray();
									  $PLN_cnt = count($PLN) ;
									  if($PLN_cnt== 0){
									 	$flag = 1;
											}

								}
						case 18:
								  if($flag==0){
							  //print_r($sub[$h]);
									 $sql = "SELECT id  FROM #__cam_vendor_occupational_license WHERE OLN_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;
									  $db->Setquery($sql);
									  $OLN = $db->loadResultArray();
									   // echo "<pre>"; print_r($OLN); exit;
									  $OLN_cnt = count($OLN) ;
									   //echo "<pre>"; print_r($OLN_cnt); exit;
									  if($OLN_cnt== 0){
											$flag = 1;
				                     	}
									}
								}
							}
				   case 3:


							for($s=0;$s<count($sub); $s++){
							//echo "<pre>"; print_r($sub[$s]);
							switch($sub[$s])

							  {

						 case 11:
							//exit;
							if($flag==0){
								  $sql2 = "SELECT id  FROM #__cam_vendor_workers_companies_insurance WHERE WCI_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;
								  $db->Setquery($sql2);
								  $WCI = $db->loadResultArray();
								  $WCI_cnt = count($WCI) ;
								  if($WCI_cnt == 0){
								  $flag = 1;
								  }
								//print_r($flag);
							    }
					       case 12:
							if($flag==0){
								$sql = "SELECT GLI_policy_aggregate FROM #__cam_vendor_liability_insurence  WHERE GLI_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;

								  $db->Setquery($sql);
								  $amount = $db->loadObjectlist();
							//echo "<pre>"; print_r($amount);
								  // $amount2 = doubleval(str_replace(",","",$amount1));

								 $spl_amount="SELECT price FROM #__cam_rfpreq_info WHERE rfp_id='".$rfpid."' and req_subparentid='12'";
								   $db->Setquery($spl_amount);
								  $amount1 = $db->loadResult();
								 // $amount2= str_replace(",", "", $amount1);
								 $amount2 = doubleval(str_replace(",","",$amount1));
								 for($L=0;$L<count($amount); $L++){
								// echo "<pre>"; print_r($amount[$L]->GLI_policy_aggregate);
								          if($amount2 > $amount[$L]->GLI_policy_aggregate){
									         $flag=1;
									             } else {
									        $flag=0;
									        }
								      }


								}

							}
							}
				  } //switch($main[$m])
				 //print_r($flag); echo "<br>";
				 } //exit;//for($m = 0; $m<count($main); $m++)
		//	echo "<pre>"; print_r($flag); echo "flag"; print_r($vendorsinfo[$i][0]);
			  if($flag == 0)
			  {

			  //$vendorsinfo[$i][0]->email;
			  $vendorid = $vendorsinfo[$i][0]->id;

				$vendoremail=$vendorsinfo[$i][0]->email;
				//echo "<pre>"; print_r($vendoremail); echo "start";
				$vendor_name=$vendorsinfo[$i][0]->name.' '.$vendorsinfo[$i][0]->lastname;

				//code to get Mangaername, Camfirmname
				$user=JFactory::getUser();
				 $Manager = JFactory::getUser($userid);
				$Managername = $Manager->name.'&nbsp;'.$Manager->lastname;
				 $camfirmid_sql = "SELECT comp_id FROM #__cam_customer_companyinfo WHERE cust_id=".$userid;
				$db->SetQuery($camfirmid_sql);
				$camfirmid_res = $db->loadResult();
				if($camfirmid_res == '0')
				$Camfirmname = '';
				else
				{
				  $camfirmid_sql = "SELECT cust_id FROM #__cam_camfirminfo  WHERE id=".$camfirmid_res;
				  $db->SetQuery($camfirmid_sql);
				  $camfirmid_res = $db->loadResult();
				  $camfirmuser = JFactory::getUser($camfirmid_res);
				  $Camfirmname = $camfirmuser->name.'&nbsp;'.$camfirmuser->lastname;
				}
				$sub='RFP Invitation from CAMAssistant';

				if($vendoremail)
				{

							 $vendorid = $vendorsinfo[$i][0]->id;
							//$vendoremail = $vendor_email[0]->email;

						//echo "<pre>"; print_r( $vendoremail);	echo "middile";//$to = $vendoremail;
							//$vendor_name= $vendor_email[$i][0]->name;
						  $vendorid= "SELECT U.email,U.name,U.lastname,U.id FROM #__users as U LEFT JOIN #__cam_vendor_proposals as P ON P.proposedvendorid=U.id WHERE rfpno=".$rfpid." AND P.proposedvendorid=". $vendorid;
				$db->setQuery($vendorid);
				$vendor_email = $db->loadObjectList();
				//$vendor_name= $vendor_email[0]->name.' '.$vendor_email[0]->lastname;
					if(count($vendor_email)>0) // code to send updated rfp mails
					{
							$updaterfp = "SELECT introtext  FROM #__content where id='163'";
							$db->setQuery($updaterfp);
							$update_rfp = $db->loadResult();
							//echo "<pre>vendorid:"; print_r($vendorsinfo[$i][0]->id);
							$from_name='CAMassistant';
							$from_email='Support@CAMassistant.com';
							$sub='Addendum to RFP '.sprintf('%06d', $rfpid);
							$siteURL		= JURI::root();
							$sql = "SELECT id FROM #__cam_vendor_availablejobs  where rfp_id = ".$rfpid." AND user_id = ".$vendorsinfo[$i][0]->id;
							$db->Setquery($sql);
							$result = $db->loadResult();
						//print_r($result);
							if(count($result)>0)
							{
								$sql = "SELECT id,Alt_bid,proposedvendorid,rfpno FROM #__cam_vendor_proposals  where rfpno = ".$rfpid." AND proposedvendorid= ".$vendorsinfo[$i][0]->id;
								$db->Setquery($sql);
								$prp_cnt = $db->loadObjectList();
								for($k=0;$k<count($prp_cnt);$k++)
								{
									$link = $siteURL.'index.php?option=com_camassistant&controller=proposals&Alt_Prp='.$prp_cnt[$k]->Alt_bid.'&task=Proposal_edit&Proposal_id='.$prp_cnt[$k]->id.'&vendor_id='.$prp_cnt[$k]->proposedvendorid.'&rfp_id='.$prp_cnt[$k]->rfpno.'&act=Draft&Itemid=107';
									}
									$body = $update_rfp;
									$body = str_replace('{RFP NUMBER}', sprintf('%06d', $rfpid), $body);
									$body = str_replace('{vendor Name}', $vendor_name, $body);
									$body = str_replace('{link}', '<a href="'.$link.'">CLICK HERE</a>', $body);
									$body = str_replace('{camName}', 'CAMassitant', $body);
									$body = str_replace('{Managername}', $Managername, $body);
									$body = str_replace('{Camfirmname}', $Camfirmname, $body);
									//$sub='Invitation to RFP '.sprintf('%06d', $rfpid).' from CAMassistant';
									//echo "<pre>update"; print_r($vendoremail);
									$sub='Addendum to RFP '.sprintf('%06d', $rfpid);
									$from_name='CAMassistant';
									$from_email='Support@CAMassistant.com';
									$successMail =JUtility::sendMail($from_email, $from_name, $vendoremail, $sub, $body,$mode = 1);

					$sql = "UPDATE #__cam_vendor_proposals SET proposaltype='Draft' where rfpno = ".$rfpid." AND proposedvendorid= ".$vendorsinfo[$i][0]->id;
					$db->SetQuery($sql);
					$db->query();
							}
						}
					  else // code to send New invitations
						{
								$rfpinvite = "SELECT introtext  FROM #__content where id='162'";
								$db->setQuery($rfpinvite);
								$inviterfp = $db->loadResult();
								$vendorid = $vendor_email[0]->id;
								$db = &JFactory::getDbo();
								//echo "anand"; print_r($vendoremail);
								$sql1 = "DELETE FROM #__cam_vendor_availablejobs where rfp_id=".$rfpid." AND user_id=".$vendorsinfo[$i][0]->id." AND prp_id=".$property_id." AND status='0'";
								$db->SetQuery($sql1);
								$db->query();
///Filtering preferred vendors by sateesh
								$query_prefer = "SELECT  v_id FROM  #__vendor_inviteinfo WHERE (vendortype = 'preferred' or vendortype = 'inhouse') AND status=1 AND userid=".$userid;
								$db->setQuery($query_prefer);
								$preferred_vendors = $db->loadObjectList();
	//							echo "<pre>"; print_r($preferred_vendors);
								if($preferred_vendors){
								foreach($preferred_vendors as $vid){
								$preferred[] = $vid->v_id;
								}
								}

								if(count($preferred)){
								if(in_array($vendorsinfo[$i][0]->id,$preferred)){
								$publish = 1;
								$vendor_type = 'prefer';
								$vendoremail = $vendoremail;
								}
								else{
								$publish = 0;
								$vendor_type = 'normal';
								$vendoremail = '';
								}
								}
								else{
								$publish = 1;
								$vendor_type = 'prefer';
								$vendoremail = $vendoremail;
								}
								$sql_rfpmails = "insert into #__cam_rfp_emails values ('','".$rfpid."','".$vendorsinfo[$i][0]->id."','".$publish."','".$vendor_type."','".$userid."')";
								$db->SetQuery($sql_rfpmails);
								$db->query();
//Completed by sateeesh

								$sql = "insert into #__cam_vendor_availablejobs values ('','".$rfpid."','".$vendorsinfo[$i][0]->id."','".$property_id."','0','".$publish."')";
								$db->SetQuery($sql);
								$db->query();

								$id= $db->insertid();
								$siteURL		= JURI::root();
								$link = $siteURL.'index.php?option=com_camassistant&controller=proposals&Itemid=148&task=vendor_proposal_form&view=proposals&amp;Prp_id='.$property_id.'&id='.$id.'&rfp_id='.$rfpid.'';
						if($choose_tasks=='3'){
								$vendors = "SELECT introtext FROM #__content where id='155'";
								$db->setQuery($vendors);
								$body = $db->loadResult();
								//$body = $inviterfp;
						} else if(($choose_tasks=='2')||($choose_tasks=='2choose')||($choose_tasks=='Engineer')||($choose_tasks=='Architect')){
								$hirea = "SELECT introtext FROM #__content where id='154'";
								$db->setQuery($hirea);
								$body = $db->loadResult();
						} else {
								$body = $inviterfp;
							}
								//$vendor_name=$vendorsinfo[$i][0]->name.' '.$vendorsinfo[$i][0]->lastname;
								//$body = $inviterfp;
								$body = str_replace('{RFP NUMBER}', $rfpid, $body);
								$body = str_replace('{RFP NUMBER}',sprintf('%06d', $rfpid), $body);
								$body = str_replace('{vendor Name}', $vendor_name, $body);
								$body = str_replace('{link}', '<a href="'.$link.'">CLICK HERE</a>', $body);
								$body = str_replace('{CLICK HERE link}', '<a href="'.$link.'">CLICK HERE</a>', $body);
								$body = str_replace('{camName}', 'CAMassitant', $body);
								$body = str_replace('{Managername}', $Managername, $body);
								$body = str_replace('{Camfirmname}', $Camfirmname, $body);
								//echo "<pre>invite";  print_r($vendoremail);
								//end - code to get Mangaername, Camfirmname
								$sub='RFP Invitation from CAMassistant';
								$from_name='CAMassistant';
								$from_email='Support@CAMassistant.com';
								//echo $vendoremail;
								if($vendoremail != ''){
								$successMail =JUtility::sendMail($from_email, $from_name, $vendoremail, $sub, $body,$mode = 1);
								}
						}



				}//End if
			   } //exit;// if($flag == 0)
			 } //exit;//End for
			}
		}*/
	}
	if($status=='1'){
	//To send the mail to invited vendors
	//To get the manager details of this rfp
	$customerdata = "SELECT u.comp_name FROM #__cam_customer_companyinfo as u, #__cam_rfpinfo as v where v.cust_id=u.cust_id and v.id=".$rfpid." ";
	$db->Setquery($customerdata);
	$cust_coname = $db->loadResult();
	
	//Completed
	//To get the invited vendors
	$invitedvendors = "SELECT vendorid FROM #__rfp_invitations where rfpid=".$rfpid." ";
	$db->Setquery($invitedvendors);
	$invited_vendors = $db->loadObjectList();
	$count = count($invited_vendors);
	for($i=0; $i<$count; $i++){
	//To get the article content
	$email_data = "SELECT introtext  FROM #__content where id='248' ";
	$db->Setquery($email_data);
	$data = $db->loadResult();
	//Completed
	$v_company = "SELECT u.company_name, v.email, v.ccemail  FROM #__cam_vendor_company as u, #__users as v where u.user_id=".$invited_vendors[$i]->vendorid." and u.user_id=v.id ";
	$db->Setquery($v_company);
	$vendor_companyname = $db->loadObject();
	$v_companyname = $vendor_companyname->company_name ;
	$vemail = $vendor_companyname->email ;
	$ccemail = $vendor_companyname->ccemail ;
	$pdata = "SELECT u.property_name, v.projectName, v.proposalDueDate, v.proposalDueTime, v.cust_id FROM #__cam_property as u, #__cam_rfpinfo as v where u.id=v.property_id and v.id=".$rfpid." ";
	$db->Setquery($pdata);
	$rfpdetails = $db->loadObject();
	//To get the company name
	$namemanager = "SELECT comp_name FROM #__cam_customer_companyinfo  where cust_id=".$rfpdetails->cust_id." ";
	$db->Setquery($namemanager);
	$managaercname = $db->loadResult();
	//Completed
	
	$rfptime = $rfpdetails->proposalDueDate.' '.$rfpdetails->proposalDueTime ;
	
	$body = str_replace('{VENDOR}',$v_companyname,$data);
	$body = str_replace('[RFP #]',$rfpid,$body);
	$body = str_replace('{PNAME}',str_replace('_',' ',$rfpdetails->property_name),$body);
	$body = str_replace('[communityname]',str_replace('_',' ',$rfpdetails->property_name),$body);
	$body = str_replace('[managername]',$managaercname,$body);
	$body = str_replace('[Reference Name]',$rfpdetails->projectName,$body);
	$body = str_replace('{PROJECTNAME}',$rfptime,$body);
	$body = str_replace('{CAMFIRM}',$cust_coname,$body);
	$mailfrom = 'support@myvendorcenter.com';
	$fromname = $cust_coname;
	$mailsubject = "You've received a Project Invitation";
	JUtility::sendMail($mailfrom, $fromname, $vemail, $mailsubject, $body,$mode = 1);
	//To send the mails to CC emails
	if($ccemail){
		$cclist = explode(';',$ccemail);
		for($cc=0; $cc<=count($cclist); $cc++){
		$listcc = $cclist[$cc];
		if($listcc){
		JUtility::sendMail($mailfrom, $fromname, $listcc, $mailsubject, $body,$mode = 1);
		}
		}
	}
	//Completed
	//Insert ITB record
	$today = date('m-d-Y');
	$p_data = "SELECT id  FROM #__cam_vendor_proposals where rfpno=".$rfpid." and proposedvendorid=".$invited_vendors[$i]->vendorid." ";
	$db->Setquery($p_data);
	$existid = $db->loadResult();
	if(!$existid){
		$insert_sqlITB = "insert into #__cam_vendor_proposals values ('0','','".$rfpid."','','','','','".$invited_vendors[$i]->vendorid."','".$today."','ITB','0.00','',0.00,'','','admin')";
		$db->SetQuery($insert_sqlITB);
		$db->query();
	}
	else{
		
	}
	//Completed
	}
	}
	//Completed
	$industry_id =  JRequest::getVar('industry_id');
	$rfpstatus =  JRequest::getVar('rfpstatus');
	$rfpapproval =  JRequest::getVar('rfpapproval');
	$search =  JRequest::getVar('search');
	$this->setRedirect('index.php?option=com_camassistant&controller=rfp&industry_id='.$industry_id.'&rfpstatus='.$rfpstatus.'&rfpapproval='.$rfpapproval.'&search='.$search,'RFP Updated Successfully');
	//}
	}
	/* ---Delete Line Task----*/
	function deletelinetask() {

	$db = JFactory::getDBO();
	$sql='DELETE FROM `#__cam_rfpsow_linetask` WHERE `task_id` = '.$_POST[queryString].'';
	$db->setquery($sql);
	$db->query();
	}
	/* ---End Of Line task----*/


	function linetaskupload()
	{
	   JRequest::setVar('view', 'rfp');
		parent::display();
		}

	 function pro_hired()
	{



	   JRequest::setVar('view', 'rfp');
		parent::display();
		}
function pro_hired_camassitant()
	{

	   JRequest::setVar('view', 'rfp');
		parent::display();
		}

function sow_hired()
	{

	   JRequest::setVar('view', 'rfp');
		parent::display();
		}
	function vendor_proposal_edit_format_val()
	{
	   $fieldvalue= JRequest::getVar('fieldvalue','');
	   $fieldvalue = doubleval(str_replace(",","",$fieldvalue));
	   $fieldvalue = number_format($fieldvalue,2);
	   echo $fieldvalue;
	   exit;


	}

	function silent_rfp(){
	//echo "<pre>"; print_r($_REQUEST); exit;
	//echo "<pre>"; print_r($_REQUEST); exit;
	//$user=JFactory::getUser();  //For $my
		$basepath=JURI::root();
		$db = &JFactory::getDbo();
		$model	=& $this->getModel('rfp');
		$itemid=JRequest::getVar('Itemid',0);
		$show=JRequest::getVar('show','');
		$post	= JRequest::getVar("task",'');
		//echo "<pre>"; print_r($_REQUEST); exit;
		$proposalDueDate= JRequest::getVar('proposalDueDate');
		$rfp_adminstatus= JRequest::getVar('rfp_adminstatus');
		$jobnotes= JRequest::getVar('jobnotes');
		$data['jobnotes']=$jobnotes;
		
		$data['rfp_adminstatus']=$rfp_adminstatus;
		$proposaldate=explode(' ',$proposalDueDate);
		$data['proposalDueDate']=$proposaldate[0];
		$data['proposalDueTime']=$proposaldate[1];
		/*if($proposaldate[1] == '')
		$proposaldate[1] = '12:00';
		if($proposaldate[2] == '')
		$proposaldate[2] = 'pm' ;
		$data['proposalDueTime']=$proposaldate[1].strtoupper($proposaldate[2]);*/
		$work_perform =  JRequest::getVar('work_perform');

		//print_r(count($work_perform)); exit;
		$site_visit =  JRequest::getVar('site_visit',array());
		$data['work_perform'] = $work_perform;
		if (count($site_visit)>1) {
		$data['site_visit']=implode(',',$site_visit);
		} else {
		$data['site_visit']=$site_visit[0];
		}
		$bidders_info =  JRequest::getVar('bidders_info',array());
		if($site_visit[0]=='Required prior to bidding')
		$data['bidders_info']=$bidders_info[0];
		else if($site_visit[0]=='Recommended')
		$data['bidders_info']=$bidders_info[1];
		else
		$data['bidders_info']=$bidders_info[2];
  $present_date = date('Y-m-d');
        $date1=strtotime($present_date);
        $proposal_date=explode('-',$proposaldate[0]);
        $date2= strtotime($proposal_date[2].'-'.$proposal_date[0].'-'.$proposal_date[1]);
       // print_r($date1);
        // echo $basepath=JURI::root();
       if( $_REQUEST['rfp_type']=='closed' && $date1<$date2){
         // echo 'hi';
          $query23 = "DELETE FROM #__cam_closedzip WHERE rfpid=".$_REQUEST['id'];
		$db->setQuery($query23);
		$db->query();
         $name = "/home/allen/public_html/live/zipdownloads/RFP".$_REQUEST['id'].".zip";
       // readfile("$name");
         chmod("$name",0777);
         unlink("$name");
       }

	   	$id= JRequest::getVar('id');
		$data['cust_id']= JRequest::getVar('cust_id');
		$userid=JRequest::getVar('cust_id');
		//$createdDate=date('m-d-Y');
		//$data['createdDate']=$createdDate;
		$data['update_date']=date('m-d-Y');
		$property_id= JRequest::getVar('property_id');
		//To get the property owner
			$get_pmid="SELECT property_manager_id FROM #__cam_property WHERE id='".$property_id."'";
			$db->Setquery($get_pmid);
			$data['cust_id'] = $db->loadResult();
		//Completed
		$industry_id= JRequest::getVar('industry_id');
		$industry_id2= JRequest::getVar('industry_id2');
		
		$data['property_id']=$property_id;
		$data['industry_id']=$industry_id[0];
		$data['industry_id2']=$industry_id2;
		$projectName= JRequest::getVar('projectName');
		$work_perform_other = '';
		$frequency= JRequest::getVar('frequency');
		$startDate= JRequest::getVar('startDate');
		$endDate= JRequest::getVar('endDate');
		$maxProposals= JRequest::getVar('maxProposals');
		$data['maxProposals']=$maxProposals;
		$rfp_type= JRequest::getVar('rfp_type');
		$publish= JRequest::getVar('publish');
		$choose_tasks2= JRequest::getVar('choose_tasks2');
		$choose_tasks3= JRequest::getVar('choose_tasks3');
		if($choose_tasks2==''){
		$choose_tasks=$choose_tasks3;
		} else {
		$choose_tasks=$choose_tasks2;
		}
		if($publish==''){
		$data['publish']=1;
		} else {
		$data['publish']=$publish;
		}

		/*if($rfp_type=='closed'){
		$rfp_type='rfp';

		}*/

		$terms= JRequest::getVar('terms');

		if($rfp_type==''){
		$data['rfp_type']='draft';
		} else {
		$data['rfp_type']=$rfp_type;
		}

		$data['startDate']=$startDate;
		$data['terms']=$terms;
		//if($rfp_type=='closed'){
		$data['update_rfp']='0';
		//} else {
		//$data['update_rfp']='1';
		//}
		$data['endDate']=$endDate;
		$data['frequency']=$frequency;
		$data['maxProposals']=$maxProposals;
		$data['projectName']=$projectName;
		$data['work_perform_other'] = '';

		//
		$rfp_id = $id;
		$TempLineItems=$model->get_tempLineTasks($rfp_id);
		$data['id']= $id;
		//$link ='index.php?option=com_camassistant&controller=rfp&rfp_type='.$data['rfp_type'].'&task=reviewrfp&rfpid='.$rfpid.'&Itemid='.$itemid;

		$industry = $_REQUEST['industry_id'];
		$sql1 = "SELECT industry_id FROM #__cam_rfpinfo WHERE id=".$id;
		$db->setQuery($sql1);
		$db_res = $db->loadResult();

		  $query = "DELETE FROM #__cam_rfpindustries WHERE rfpid=".$id." AND industry_id=".$db_res;
			$db->setQuery($query);
			$db->query();
		for($in=0; $in<count($industry); $in++){
		if($industry[$in]){
			$insert_sql = "insert into #__cam_rfpindustries values ('','".$id."','".$industry[$in]."')";
			}
			$db->SetQuery($insert_sql);
			$db->query();
		//echo  $industry[$in];
		}

		$line_tasks['rfp_id']=$rfp_id;
		list($month, $day, $year) = split('[/.-]', $data['proposalDueDate']);
		$datesminutes = strtotime($year."-".$month."-".$day);
		$hr_min = substr($data['proposalDueTime'], 0, -2);  // returns "7:00"
		$am_pm = substr($data['proposalDueTime'], -2);    // returns "AM" OR "PM"
		if($am_pm == 'PM')
		{
		$min = substr($hr_min, -2);
		$hr = substr($hr_min, 0, -3);
		$x = substr($due_time, 0, 2);
		if($x != 12)
		$hr = $hr + 12;
		}
		else if($am_pm == 'AM')
		{
		$min = substr($hr_min, -2);
		$hr = substr($hr_min, 0, -3);
		}
		$timeminutes =  $hr*60+$min;
		$totalminutes = $datesminutes + $timeminutes;
		$data['secondstime'] =  $totalminutes;
		/*echo "<pre>";
		print_r($data);*/
	if($model->store_update($data)) {
	echo 'success';
			//$mesg = "<b>RFP submitted successfully<b>";
			//$link = 'index.php?option=com_camassistant&controller=rfpcenter&task=submitedrfp&Itemid=87';
			//$this->setRedirect( $link,$mesg );
		} else {
			$mesg = "Could not added RFP";
		}
		$sql = "UPDATE #__cam_rfpinfo SET terms='".$terms."' WHERE id='".$rfp_id."'";
		$db->Setquery($sql);
		$db->query();
		$post['rfp_indus_data']=$_SESSION['rfp']['industry'];

		//$rfp_id = $rfpid;
			$line_tasks['rfp_id']=$rfp_id;
		$task_desc =  JRequest::getVar('task_desc',array());
		$linetaskname =  JRequest::getVar('linetaskname',array());
		$rfpreference =  JRequest::getVar('rfpreference',array());
		$is_req_taskvendors =  JRequest::getVar('is_req_taskvendors',array());
		$hidden_taskvendors =  JRequest::getVar('hidden_taskvendors',array());
		$linetask_uploads =  JRequest::getVar('linetask_uploads',array());
                 $line_taskno =  JRequest::getVar('line_taskno',array());
	//echo "<pre>"; print_r($is_req_taskvendors); exit;
		//code to delete previous tasks
		 $old_new_taskids = JRequest::getVar('old_taskids','');
		$rfp = JRequest::getVar('rfpid','');
		$db = JFactory::getDBO();
		$sql = "SELECT task_id FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id;
		$db->setQuery($sql);
		$db_taskids = $db->loadResultArray();

		$old_taskids_modified = array_diff($old_new_taskids, array(''));

		for($i=0; $i<count($db_taskids); $i++)
		{
			if(!in_array($db_taskids[$i],$old_taskids_modified))
			{
			//code to delete taskid from  #__cam_rfpsow_linetask
			$query = "DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id." AND task_id=".$db_taskids[$i];
			$db->setQuery($query);
			$db->query();
			//code to delete taskid from  #__cam_rfpsow_docs_lineitems_prices
			$query = "DELETE FROM #__cam_rfpsow_docs_lineitems_prices WHERE rfp_id=".$rfp_id." AND item_id=".$db_taskids[$i]." AND item_type='task' ";
			$db->setQuery($query);
			$db->query();
			}
		}
		// end of code to update task ids by lalitha
		$updateditems=array();
		$k=0;
		//code to delete previous tasks
		//$query = "DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id;
		//$db->setQuery($query);
		//$db->query();
		//print_r($rfp_id); exit;
		//end of code
		//echo "<pre>"; print_r($_REQUEST);
		$basicrequest = JRequest::getVar('basicrequest','');
		if($basicrequest == 'basicrequest'){
			$line_taskno[0] = '10000000';
		}
		if(count($line_taskno)>0)
		{
			for($i=0;$i<count($line_taskno);$i++)
			{

                             $task_desc =  JRequest::getVar('task_desc_'.$line_taskno[$i] ,array());

                             $linetaskname =  JRequest::getVar('linetaskname_'.$line_taskno[$i] ,array());
                              $rfpreference=  JRequest::getVar('rfpreference_'.$line_taskno[$i] ,array());
                            $linetask_uploads =  JRequest::getVar('linetask_uploads_'.$line_taskno[$i], array());
                            $is_req_taskvendors=  JRequest::getVar('is_req_taskvendors_'.$line_taskno[$i] ,array());
                            $hidden_taskvendors=  JRequest::getVar('hidden_taskvendors_'.$line_taskno[$i] ,array());

				$line_tasks['task_id']=$old_new_taskids[$i]; //echo '<br/>';

				$line_tasks['task_desc']=$task_desc[0];
				$line_tasks['linetaskname']=$linetaskname[0];
				$line_tasks['rfpreference']=$rfpreference[0];
				//$line_tasks['is_req_taskvendors']=$is_req_taskvendors[$j];
                                $result = array_filter( $linetask_uploads, 'strlen' );
                               //  echo '<pre>'; print_r($result);
                                if($linetask_uploads!=''){
				$line_tasks['taskuploads']=implode(',', $result);
                                }
				/*if($js_req_taskvendors[$j+1] == ''){
				$line_tasks['is_req_taskvendors'] = 0;
				} else {
				$line_tasks['is_req_taskvendors'] = $js_req_taskvendors[$j+1];
				}*/
				//$k=$j+1;
				if($hidden_taskvendors==1 || $is_req_taskvendors[0]==1)
				$line_tasks['is_req_taskvendors']=1;
				else
				$line_tasks['is_req_taskvendors']=0;


				$line_tasks['rfp_id']=$rfp_id;
				//
				$lastinsid=$db->insertid();
				$tag1=0; $tag2=0; $tag3=0;
				if($i<$cnt)
				{
					$tag1=strcmp($linetaskname,$linetaskname);
					$tag2=strcmp($task_desc,$task_desc);
					$tag3=strcmp($rfpreference,$rfpreference);
					if($tag1!=0 || $tag2!=0 || $tag3!=0)
					$line_tasks['is_modified'] = 1;
					else
					$line_tasks['is_modified'] = 0;
					//$updateditems[]=$lastinsid;
				}
				else
				$line_tasks['is_modified'] = 0;
				/* echo "<pre>";
				print_r($line_tasks);  */
				if($model->tasks_store($line_tasks))
				{
					$mesg = "Tasks stored successfully";
				} else {
					$mesg = "Error saved";
				}
                       // }

			}  // exit;
		}
		$updateditms=implode(',',$updateditems);
		$sql = "UPDATE #__cam_rfpinfo SET modified_lineitems='".$updateditms."' WHERE id='".$rfp_id."'";
		$db->Setquery($sql);
		$db->query();///////

		$req_docprice =  JRequest::getVar('require_docprice',array());
		$attachmnent =  JRequest::getVar('attachmnent',array());
		//print_r($attachmnent);
		$query = "DELETE FROM #__cam_rfpsow_docs WHERE rfp_id=".$rfp_id;
		$db->setQuery($query);
		$db->query();
		//if(count($_FILES['attachmnent'])>0)
		//{
			for($i=0;$i<count($attachmnent);$i++)
			{

					if($attachmnent[$i] == '0'){
					//echo "anand";
					$req_docsow['doc_path']=$attachmnent[$i+1];
					$req_docsow['is_req_docvendors']= $req_docprice[$i+1];
					} else {
					//echo "anand123";
					$req_docsow['doc_path']=$attachmnent[$i];
					$req_docsow['is_req_docvendors']= $req_docprice[$i];
					}
					//} else {
					//$req_docsow['doc_path']=$attachmnent[$i];
					//}
					$req_docsow['rfp_id']=$rfp_id;
                                     if($req_docsow['doc_path']){
					if($model->reqdocs_store($req_docsow)) {
					$mesg = "Documents stored successfully";
					} else {
						$mesg = "Error saved";
					}
				}
			}
		//}
		//For Inserting Spl reqs
		$req_parentid =  JRequest::getVar('req_parentid',array());
		$sub_req_id =  JRequest::getVar('sub_req_id',array());
		 $req_id =  JRequest::getVar('req_id',array());
		$otherValue1 =  JRequest::getVar('otherValue1');
		$otherValue2 =  JRequest::getVar('otherValue2');
		$otherValue3 =  JRequest::getVar('otherValue3');
		$otherValue =  $otherValue1.'/'.$otherValue2.'/'.$otherValue3;
		$liabilityInsuranceAmount =  JRequest::getVar('liabilityInsuranceAmount');
		//code to delete previous special requirements
		$db = JFactory::getDBO();
		$query = "DELETE FROM #__cam_rfpreq_info WHERE rfp_id=".$rfp_id;
		$db->setQuery($query);
		$db->query();
		//For Inserting Special Requirement categories in database for RFP
		if(count($req_parentid)>0)
		{
			for($i=0;$i<count($req_parentid);$i++)
			{
				if(count($sub_req_id[$req_parentid[$i]])>0)
				{
					for($j=0;$j<count($sub_req_id[$req_parentid[$i]]);$j++)
					{

						if(count($req_id[$sub_req_id[$req_parentid[$i]][$j]])>0)
						{
							for($k=0;$k<count($req_id[$sub_req_id[$req_parentid[$i]][$j]]);$k++)
							{
								$splreq_rfp['rfp_id']=$rfp_id;
								$splreq_rfp['req_parentid']=$req_parentid[$i];
								$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
								$splreq_rfp['req_id']=$req_id[$sub_req_id[$req_parentid[$i]][$j]][$k];
								//
								if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
								$splreq_rfp['price']= $otherValue;
								//
								if($sub_req_id[$req_parentid[$i]][$j]=='12')
								$splreq_rfp['price']=$liabilityInsuranceAmount;
								//
								if($model->rfpsplreqs_store($splreq_rfp)) {

								}
							}
						} else {

							$splreq_rfp['rfp_id']=$rfp_id;
							$splreq_rfp['req_parentid']=$req_parentid[$i];
							$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
							$splreq_rfp['req_id']=0;
							//
							if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
							$splreq_rfp['price']= $otherValue;
							//
							if($sub_req_id[$req_parentid[$i]][$j]=='12')
							$splreq_rfp['price']=$liabilityInsuranceAmount;
							//
							if($model->rfpsplreqs_store($splreq_rfp)) {

							}
						}
					}
				} else {
					$splreq_rfp['rfp_id']=$rfp_id;
					$splreq_rfp['req_parentid']=$req_parentid[$i];
					$splreq_rfp['req_subparentid']=0;
					$splreq_rfp['req_id']=0;
					if($model->rfpsplreqs_store($splreq_rfp)) {

					}
				}
				//
			}
		}
			if($choose_tasks=='Engineer')
			$industry_id=47;
			if($choose_tasks=='Architect')
			$industry_id=23;
			//print_r($industry_id); print_r($userid); print_r($property_id);  exit;
			$model->rfp_requirements_validations($industry_id,$userid,$property_id,$rfp_id);
			//$vendorsinfo=$model->getVendors($industry_id,$userid,$property_id);
			//print_r($vendorsinfo);  exit;

			/*//anandkumar modifyied by 27-7-11
			if(count($vendorsinfo)>0)
			{
			  for($i=0;$i<count($vendorsinfo);$i++)
			  {
			  $flag = 0;
			  //echo $flag;
			//echo $vendorsinfo[$i][0]->id; echo '----------';
			   //code to validate specialrequirements
				$sql = "SELECT distinct(req_parentid ) FROM #__cam_rfpreq_info WHERE rfp_id ='".$rfp_id."'";
				$db->Setquery($sql);
				$main = $db->loadResultArray();
				$sql = "SELECT req_subparentid  FROM #__cam_rfpreq_info WHERE req_subparentid !=0 AND rfp_id ='".$rfp_id."'";
				$db->Setquery($sql);
				$sub = $db->loadResultArray();
				// echo "<pre>"; print_r($main); print_r($sub); exit;
				//$flag = 0;

				for($m = 0; $m<count($main); $m++)
				{
				// echo "<pre>"; print_r($main);  exit;
				  switch($main[$m])
				  {

				  case 1:
						for($h=0;$h<count($sub); $h++){

							 switch($sub[$h])
							  {
						case 18:
								  if($flag==0){
							  //print_r($sub[$h]);  exit;
									 $sql = "SELECT id  FROM #__cam_vendor_occupational_license WHERE OLN_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;
									  $db->Setquery($sql);
									  $OLN = $db->loadResultArray();
									   // echo "<pre>"; print_r($OLN); exit;
									  $OLN_cnt = count($OLN) ;
									   //echo "<pre>"; print_r($OLN_cnt); exit;
									  if($OLN_cnt== 0){
											$flag = 1;
				                     	}
									}

								case 17:
								if($flag==0){
									$sql = "SELECT id  FROM #__cam_vendor_professional_license  WHERE PLN_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;
									  $db->Setquery($sql);
									  $PLN = $db->loadResultArray();
									  $PLN_cnt = count($PLN) ;
									  if($PLN_cnt== 0){
									 	$flag = 1;
											}

								}
								}
							}
				   case 3:


							for($s=0;$s<count($sub); $s++){
							//echo "<pre>"; print_r($sub[$s]);
							switch($sub[$s])

							  {

						 case 11:
							//exit;
							if($flag==0){
								  $sql2 = "SELECT id  FROM #__cam_vendor_workers_companies_insurance WHERE WCI_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;
								  $db->Setquery($sql2);
								  $WCI = $db->loadResultArray();
								  $WCI_cnt = count($WCI) ;
								  if($WCI_cnt == 0){
								  $flag = 1;
								  }
								//print_r($flag);
							    }
					       case 12:
							if($flag==0){
								$sql = "SELECT GLI_policy_aggregate FROM #__cam_vendor_liability_insurence  WHERE GLI_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;
								 // $sql = "SELECT sum(GLI_policy_aggregate)  FROM #__cam_vendor_liability_insurence  WHERE GLI_status = 1 AND vendor_id=".$vendorsinfo[$i][0]->id;
								  $db->Setquery($sql);
								  $amount = $db->loadObjectlist();
							//echo "<pre>"; print_r($amount);
								  // $amount2 = doubleval(str_replace(",","",$amount1));

								 $spl_amount="SELECT price FROM #__cam_rfpreq_info WHERE rfp_id='".$rfp_id."' and req_subparentid='12'";
								   $db->Setquery($spl_amount);
								  $amount1 = $db->loadResult();
								 // $amount2= str_replace(",", "", $amount1);
								 $amount2 = doubleval(str_replace(",","",$amount1));
								 for($L=0;$L<count($amount); $L++){
								// echo "<pre>"; print_r($amount[$L]->GLI_policy_aggregate);
								          if($amount2 > $amount[$L]->GLI_policy_aggregate){
									         $flag=1;
									             } else {
									        $flag=0;
									        }
								      }


								}

							}
							}
				  } //switch($main[$m])
				 //print_r($flag); echo "<br>";
				 } //exit;//for($m = 0; $m<count($main); $m++)
			//echo "<pre>"; print_r($vendorsinfo[$i][0]);
			  if($flag == 0)
			  {

			  $vendorsinfo[$i][0]->email;
			  $vendorid = $vendorsinfo[$i][0]->id;
			  //echo "<pre>"; print_r($vendorsinfo[$i][0]); exit;
				$vendoremail=$vendorsinfo[$i][0]->email;
				$vendor_name=$vendorsinfo[$i][0]->name.' '.$vendorsinfo[$i][0]->lastname;
				//code to get Mangaername, Camfirmname
				$user=JFactory::getUser();
				 $Manager = JFactory::getUser($userid);
				$Managername = $Manager->name.'&nbsp;'.$Manager->lastname;
				 $camfirmid_sql = "SELECT comp_id FROM #__cam_customer_companyinfo WHERE cust_id=".$userid;
				$db->SetQuery($camfirmid_sql);
				$camfirmid_res = $db->loadResult();
				if($camfirmid_res == '0')
				$Camfirmname = '';
				else
				{
				  $camfirmid_sql = "SELECT cust_id FROM #__cam_camfirminfo  WHERE id=".$camfirmid_res;
				  $db->SetQuery($camfirmid_sql);
				  $camfirmid_res = $db->loadResult();
				  $camfirmuser = JFactory::getUser($camfirmid_res);
				  $Camfirmname = $camfirmuser->name.'&nbsp;'.$camfirmuser->lastname;
				}
				$sub='RFP Invitation from CAMAssistant';

				if($vendoremail)
				{

							 $vendorid = $vendorsinfo[$i][0]->id;
							//$vendoremail = $vendor_email[0]->email;

						//echo "<pre>"; print_r( $vendorid);	//$to = $vendoremail;
							//$vendor_name= $vendor_email[$i][0]->name;
						 $vendorid= "SELECT U.email,U.name,U.lastname,U.id FROM #__users as U LEFT JOIN #__cam_vendor_proposals as P ON P.proposedvendorid=U.id WHERE rfpno=".$rfp_id." AND P.proposedvendorid=". $vendorid;
				$db->setQuery($vendorid);
				$vendor_email = $db->loadObjectList();
					//echo "<pre>"; print_r($vendor_email ); exit;
				//$vendor_name= $vendor_email[0]->name.' '.$vendor_email[0]->lastname;
					if(count($vendor_email)>0) // code to send updated rfp mails
					{
							$updaterfp = "SELECT introtext  FROM #__content where id='163'";
							$db->setQuery($updaterfp);
							$update_rfp = $db->loadResult();
							//echo "<pre>vendorid:"; print_r($vendorsinfo[$i][0]->id);
							$from_name='CAMassistant';
							$from_email='Support@CAMassistant.com';
							$sub='Addendum to RFP '.sprintf('%06d', $rfp_id);
							$siteURL		= JURI::root();
							$sql = "SELECT id FROM #__cam_vendor_availablejobs  where rfp_id = ".$rfp_id." AND user_id = ".$vendorsinfo[$i][0]->id;
							$db->Setquery($sql);
							$result = $db->loadResult();
						//print_r($result);
							if(count($result)>0)
							{
								$sql = "SELECT id,Alt_bid,proposedvendorid,rfpno FROM #__cam_vendor_proposals  where rfpno = ".$rfp_id." AND proposedvendorid= ".$vendorsinfo[$i][0]->id;
								$db->Setquery($sql);
								$prp_cnt = $db->loadObjectList();
								//echo "<pre>"; print_r($prp_cnt);
								for($k=0;$k<count($prp_cnt);$k++)
								{
									$link = $siteURL.'index.php?option=com_camassistant&controller=proposals&Alt_Prp='.$prp_cnt[$k]->Alt_bid.'&task=Proposal_edit&Proposal_id='.$prp_cnt[$k]->id.'&vendor_id='.$prp_cnt[$k]->proposedvendorid.'&rfp_id='.$prp_cnt[$k]->rfp_id.'&act=Draft&Itemid=107';
									}
									$body = $update_rfp;
									$body = str_replace('{RFP NUMBER}', sprintf('%06d', $rfp_id), $body);
									$body = str_replace('{vendor Name}', $vendor_name, $body);
									$body = str_replace('{link}', '<a href="'.$link.'">CLICK HERE</a>', $body);
									$body = str_replace('{camName}', 'CAMassitant', $body);
									$body = str_replace('{Managername}', $Managername, $body);
									$body = str_replace('{Camfirmname}', $Camfirmname, $body);
									//$sub='Invitation to RFP '.sprintf('%06d', $rfpid).' from CAMassistant';
									//echo "<pre>update"; print_r($vendoremail);
									$sub='Addendum to RFP '.sprintf('%06d', $rfp_id);
									$from_name='CAMassistant';
									$from_email='Support@CAMassistant.com';
									$successMail =JUtility::sendMail($from_email, $from_name, $vendoremail, $sub, $body,$mode = 1);

					$sql = "UPDATE #__cam_vendor_proposals SET proposaltype='Draft' where rfpno = ".$rfp_id." AND proposedvendorid= ".$vendorsinfo[$i][0]->id;
					$db->SetQuery($sql);
					$db->query();
							}
						}
					  else // code to send New invitations
						{
								$rfpinvite = "SELECT introtext  FROM #__content where id='162'";
								$db->setQuery($rfpinvite);
								$inviterfp = $db->loadResult();
								$vendorid = $vendor_email[0]->id;
								$db = &JFactory::getDbo();
								//echo "anand"; print_r($vendoremail);
								$sql1 = "DELETE FROM #__cam_vendor_availablejobs where rfp_id=".$rfp_id." AND user_id=".$vendorsinfo[$i][0]->id." AND prp_id=".$property_id." AND status='0'";
								$db->SetQuery($sql1);
								$db->query();

///Filtering preferred vendors by sateesh
								$query_prefer = "SELECT  v_id FROM  #__vendor_inviteinfo WHERE vendortype = 'preferred' AND status=1 AND userid=".$userid;
								$db->setQuery($query_prefer);
								$preferred_vendors = $db->loadObjectList();
	//							echo "<pre>"; print_r($preferred_vendors);
								if($preferred_vendors){
								foreach($preferred_vendors as $vid){
								$preferred[] = $vid->v_id;
								}
								}
//								echo "<pre>"; print_r($preferred); exit;
								if(count($preferred)){
								if(in_array($vendorsinfo[$i][0]->id,$preferred)){
								$publish = 1;
								$vendor_type = 'prefer';
								$vendoremail = $vendoremail;
								}
								else{
								$publish = 0;
								$vendor_type = 'normal';
								$vendoremail = '';
								}
								}
								else{
								$publish = 1;
								$vendor_type = 'prefer';
								$vendoremail = $vendoremail;
								}
								$sql_rfpmails = "insert into #__cam_rfp_emails values ('','".$rfp_id."','".$vendorsinfo[$i][0]->id."','".$publish."','".$vendor_type."','".$userid."')";
								$db->SetQuery($sql_rfpmails);
								$db->query();
//Completed by sateeesh

								$sql = "insert into #__cam_vendor_availablejobs values ('','".$rfp_id."','".$vendorsinfo[$i][0]->id."','".$property_id."','0','".$publish."')";
								$db->SetQuery($sql);
								$db->query();

								$id= $db->insertid();
								$siteURL		= JURI::root();
								$link = $siteURL.'index.php?option=com_camassistant&controller=proposals&Itemid=148&task=vendor_proposal_form&view=proposals&amp;Prp_id='.$property_id.'&id='.$id.'&rfp_id='.$rfp_id.'';
						if($choose_tasks=='3'){
								$vendors = "SELECT introtext FROM #__content where id='155'";
								$db->setQuery($vendors);
								$body = $db->loadResult();
								//$body = $inviterfp;
						} else if(($choose_tasks=='2')||($choose_tasks=='2choose')||($choose_tasks=='Engineer')||($choose_tasks=='Architect')){
								$hirea = "SELECT introtext FROM #__content where id='154'";
								$db->setQuery($hirea);
								$body = $db->loadResult();
						} else {
								$body = $inviterfp;
							}
								//$vendor_name=$vendorsinfo[$i][0]->name.' '.$vendorsinfo[$i][0]->lastname;
								//$body = $inviterfp;
								$body = str_replace('{RFP NUMBER}', $rfp_id, $body);
								$body = str_replace('{RFP NUMBER}',sprintf('%06d', $rfp_id), $body);
								$body = str_replace('{vendor Name}', $vendor_name, $body);
								$body = str_replace('{link}', '<a href="'.$link.'">CLICK HERE</a>', $body);
								$body = str_replace('{CLICK HERE link}', '<a href="'.$link.'">CLICK HERE</a>', $body);
								$body = str_replace('{camName}', 'CAMassitant', $body);
								$body = str_replace('{Managername}', $Managername, $body);
								$body = str_replace('{Camfirmname}', $Camfirmname, $body);
								//echo "<pre>invite";  print_r($vendoremail);
								//end - code to get Mangaername, Camfirmname
								$sub='RFP Invitation from CAMassistant';
								$from_name='CAMassistant';
								$from_email='Support@CAMassistant.com';
								//echo $vendoremail;
								if($vendoremail != ''){
								$successMail =JUtility::sendMail($from_email, $from_name, $vendoremail, $sub, $body,$mode = 1);
								}
						}


				}//End if
			   } //exit;// if($flag == 0)
			 } //exit;//End for
			}*/
	$industryid =  JRequest::getVar('industryid');
	$rfpstatus =  JRequest::getVar('rfpstatus');
	$rfpapproval =  JRequest::getVar('rfpapproval');
	$search =  JRequest::getVar('search');

	//To re set the vendor closing time
		$vendor_close = $proposalDueDate ;
		$present_date = date('Y-m-d H:i');                 //Today date
		$second = $vendor_close ;
		$explode = explode(' ',$second);
		$explode_date = explode('-',$explode[0]);
		$second_date = $explode_date[2].'-'.$explode_date[0].'-'.$explode_date[1].' '.$explode[1] ;    //RFP due date
		$diff = strtotime($second_date) - strtotime($present_date);
		if($diff > '86400'){
		$change_vendorcloseing='UPDATE `#__cam_rfpinfo` SET close_vendor = "" where id= '.$rfp_id.'';
		$db->setquery($change_vendorcloseing);
		$db->query();
		} else{
		$close_vendor='UPDATE `#__cam_rfpinfo` SET close_vendor = "closed" where id= '.$rfp_id.'';
		$db->setquery($close_vendor);
		$db->query();
		}
		//Completed
		
		$basicrequest = JRequest::getVar('basicrequest','');
		if($basicrequest == 'basicrequest'){
			$linetask_uploads =  JRequest::getVar('linetask_uploads_210',array());
			for( $b=0; $b<count($linetask_uploads); $b++ ){
				$basic['rfpid'] = $rfp_id ;
				$basic['property_id'] = $property_id ;
				$exp_file = explode('/',$linetask_uploads[$b]);
				$basic['filename'] = $exp_file[count($exp_file)-1] ;
				$linetask_uploads[$b] = str_replace('components/com_camassistant/doc/','',$linetask_uploads[$b]);
				$basic['filepath'] = $linetask_uploads[$b] ;
				$basic['upload_date'] = '' ;
				
				$save_basicfiles = $model->savebfiles($basic);
			}
		}
		
		$msg='RFP Addendum  Successfully';
		$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&industry_id='.$industryid.'&rfpstatus='.$rfpstatus.'&rfpapproval='.$rfpapproval.'&search='.$search,$msg );

	}


	function save_approve(){
	//echo '<pre>'; print_r($_REQUEST); exit;
		$basepath=JURI::root();
		$db = &JFactory::getDbo();
		$model	=& $this->getModel('rfp');
		$itemid=JRequest::getVar('Itemid',0);
		$show=JRequest::getVar('show','');
		$post	= JRequest::getVar("task",'');
		//echo "<pre>"; print_r($_REQUEST); exit;
		$jobnotes= JRequest::getVar('jobnotes');
		$data['jobnotes']=$jobnotes;
		$proposalDueDate= JRequest::getVar('proposalDueDate');
		$rfp_adminstatus= JRequest::getVar('rfp_adminstatus');
		$data['rfp_adminstatus']=$rfp_adminstatus;

		$proposaldate=explode(' ',$proposalDueDate);
		$data['proposalDueDate']=$proposaldate[0];
		$data['proposalDueTime']=$proposaldate[1];
		/*if($proposaldate[1] == '')
		$proposaldate[1] = '12:00';
		if($proposaldate[2] == '')
		$proposaldate[2] = 'pm' ;
		$data['proposalDueTime']=$proposaldate[1].strtoupper($proposaldate[2]);*/
                $present_date = date('Y-m-d');
        $date1=strtotime($present_date);
        $proposal_date=explode('-',$proposaldate[0]);
        $date2= strtotime($proposal_date[2].'-'.$proposal_date[0].'-'.$proposal_date[1]);
       // print_r($date1);
        // echo $basepath=JURI::root();
       if( $_REQUEST['rfp_type']=='closed' && $date1<$date2){
         // echo 'hi';
          $query23 = "DELETE FROM #__cam_closedzip WHERE rfpid=".$_REQUEST['id'];
		$db->setQuery($query23);
		$db->query();
         $name = "/home/allen/public_html/live/zipdownloads/RFP".$_REQUEST['id'].".zip";
       // readfile("$name");
         chmod("$name",0777);
         unlink("$name");
       }
		$work_perform =  JRequest::getVar('work_perform');

		//print_r(count($work_perform)); exit;
		$site_visit =  JRequest::getVar('site_visit',array());
		$data['work_perform'] = $work_perform;
		if (count($site_visit)>1) {
		$data['site_visit']=implode(',',$site_visit);
		} else {
		$data['site_visit']=$site_visit[0];
		}
		$bidders_info =  JRequest::getVar('bidders_info',array());
		if($site_visit[0]=='Required prior to bidding')
		$data['bidders_info']=$bidders_info[0];
		else if($site_visit[0]=='Recommended')
		$data['bidders_info']=$bidders_info[1];
		else
		$data['bidders_info']=$bidders_info[2];

		//if($data['rfp_type']=='rfp'){
		//$data['publish']=1;
	   // }else{

       // }$industry_id,$userid,$property_id,$rfpid
	   //echo "<pre>"; print_r($_REQUEST); exit;
	   	$id= JRequest::getVar('id');
		$data['cust_id']= JRequest::getVar('cust_id');
		/*$createdDate=date('m-d-Y');
		$data['createdDate']=$createdDate;*/
		$data['update_date']=date('m-d-Y');
		$property_id= JRequest::getVar('property_id');
		//To get the property owner
			$get_pmid="SELECT property_manager_id FROM #__cam_property WHERE id='".$property_id."'";
			$db->Setquery($get_pmid);
			$data['cust_id'] = $db->loadResult();
		//Completed
		$industry_id= JRequest::getVar('industry_id');
		$industry_id2= JRequest::getVar('industry_id2');
		$userid=JRequest::getVar('cust_id');
		$data['property_id']=$property_id;
		$data['industry_id']=$industry_id[0];
		$data['industry_id2']=$industry_id2;
		$projectName= JRequest::getVar('projectName');
		$work_perform_other = '';
		$frequency= JRequest::getVar('frequency');
		$startDate= JRequest::getVar('startDate');
		$endDate= JRequest::getVar('endDate');
		$maxProposals= JRequest::getVar('maxProposals');
		$data['maxProposals']=$maxProposals;
		$rfp_type= JRequest::getVar('rfp_type');
		$publish= JRequest::getVar('publish');
		//if($publish==''){
		$data['publish']=1;
		//} else {
		//$data['publish']=$publish;
		//}

		$terms= JRequest::getVar('terms');

		if($rfp_type==''){
		$data['rfp_type']='draft';
		} else {
		$data['rfp_type']=$rfp_type;
		}

		$data['startDate']=$startDate;
		$data['terms']=$terms;
		//if($rfp_type=='closed'){
		$data['update_rfp']='0';
		//} else {
		//$data['update_rfp']='1';
		//}
		$data['endDate']=$endDate;
		$data['frequency']=$frequency;
		$data['maxProposals']=$maxProposals;
		$data['projectName']=$projectName;
		$data['work_perform_other'] = '';

		$industry = $_REQUEST['industry_id'];
		$sql1 = "SELECT industry_id FROM #__cam_rfpinfo WHERE id=".$id;
		$db->setQuery($sql1);
		$db_res = $db->loadResult();

		  $query = "DELETE FROM #__cam_rfpindustries WHERE rfpid=".$id." AND industry_id=".$db_res;
			$db->setQuery($query);
			$db->query();
		for($in=0; $in<count($industry); $in++){
		if($industry[$in]){
			$insert_sql = "insert into #__cam_rfpindustries values ('','".$id."','".$industry[$in]."')";
			}
			$db->SetQuery($insert_sql);
			$db->query();
		//echo  $industry[$in];
		}

		$rfp_id = $id;
		$TempLineItems=$model->get_tempLineTasks($rfp_id);
		$data['id']= $id;
		//$link ='index.php?option=com_camassistant&controller=rfp&rfp_type='.$data['rfp_type'].'&task=reviewrfp&rfpid='.$rfpid.'&Itemid='.$itemid;

		$line_tasks['rfp_id']=$rfp_id;
		list($month, $day, $year) = split('[/.-]', $data['proposalDueDate']);
		$datesminutes = strtotime($year."-".$month."-".$day);
		$hr_min = substr($data['proposalDueTime'], 0, -2);  // returns "7:00"
		$am_pm = substr($data['proposalDueTime'], -2);    // returns "AM" OR "PM"
		if($am_pm == 'PM')
		{
		$min = substr($hr_min, -2);
		$hr = substr($hr_min, 0, -3);
		$x = substr($due_time, 0, 2);
		if($x != 12)
		$hr = $hr + 12;
		}
		else if($am_pm == 'AM')
		{
		$min = substr($hr_min, -2);
		$hr = substr($hr_min, 0, -3);
		}
		$timeminutes =  $hr*60+$min;
		$totalminutes = $datesminutes + $timeminutes;
		$data['secondstime'] =  $totalminutes;
		/*echo "<pre>";
		print_r($data);exit;*/
	if($model->store_update($data)) {
	//echo "<pre>"; print_r($data); exit;
	echo 'success';

		} else {
			$mesg = "Could not added RFP";
		}
		$sql = "UPDATE #__cam_rfpinfo SET terms='".$terms."' WHERE id='".$rfp_id."'";
		$db->Setquery($sql);
		$db->query();
		$post['rfp_indus_data']=$_SESSION['rfp']['industry'];

		//$rfp_id = $rfpid;
		$line_tasks['rfp_id']=$rfp_id;
		$task_desc =  JRequest::getVar('task_desc',array());
		$linetaskname =  JRequest::getVar('linetaskname',array());
		$rfpreference =  JRequest::getVar('rfpreference',array());
		$is_req_taskvendors =  JRequest::getVar('is_req_taskvendors',array());
		$hidden_taskvendors =  JRequest::getVar('hidden_taskvendors',array());
		$linetask_uploads =  JRequest::getVar('linetask_uploads',array());
                 $line_taskno =  JRequest::getVar('line_taskno',array());
	//echo "<pre>"; print_r($is_req_taskvendors); exit;
		//code to delete previous tasks
		 $old_new_taskids = JRequest::getVar('old_taskids','');
		$rfp = JRequest::getVar('rfpid','');
		$db = JFactory::getDBO();
		$sql = "SELECT task_id FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id;
		$db->setQuery($sql);
		$db_taskids = $db->loadResultArray();

		$old_taskids_modified = array_diff($old_new_taskids, array(''));

		for($i=0; $i<count($db_taskids); $i++)
		{
			if(!in_array($db_taskids[$i],$old_taskids_modified))
			{
			//code to delete taskid from  #__cam_rfpsow_linetask
			$query = "DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id." AND task_id=".$db_taskids[$i];
			$db->setQuery($query);
			$db->query();
			//code to delete taskid from  #__cam_rfpsow_docs_lineitems_prices
			$query = "DELETE FROM #__cam_rfpsow_docs_lineitems_prices WHERE rfp_id=".$rfp_id." AND item_id=".$db_taskids[$i]." AND item_type='task' ";
			$db->setQuery($query);
			$db->query();
			}
		}
		// end of code to update task ids by lalitha
		$updateditems=array();
		$k=0;
		//code to delete previous tasks
		//$query = "DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id;
		//$db->setQuery($query);
		//$db->query();
		//print_r($rfp_id); exit;
		//end of code
		//echo "<pre>"; print_r($_REQUEST);
		$basicrequest = JRequest::getVar('basicrequest','');
		if($basicrequest == 'basicrequest'){
			$line_taskno[0] = '10000000';
		}
		//echo "<pre>"; print_r($line_taskno); exit;
		if(count($line_taskno)>0)
		{
			for($i=0;$i<count($line_taskno);$i++)
			{

                             $task_desc =  JRequest::getVar('task_desc_'.$line_taskno[$i] ,array());

                             $linetaskname =  JRequest::getVar('linetaskname_'.$line_taskno[$i] ,array());
                              $rfpreference=  JRequest::getVar('rfpreference_'.$line_taskno[$i] ,array());
                            $linetask_uploads =  JRequest::getVar('linetask_uploads_'.$line_taskno[$i], array());
                            $is_req_taskvendors=  JRequest::getVar('is_req_taskvendors_'.$line_taskno[$i] ,array());
                            $hidden_taskvendors=  JRequest::getVar('hidden_taskvendors_'.$line_taskno[$i] ,array());

				$line_tasks['task_id']=$old_new_taskids[$i]; //echo '<br/>';

				$line_tasks['task_desc']=$task_desc[0];
				$line_tasks['linetaskname']=$linetaskname[0];
				$line_tasks['rfpreference']=$rfpreference[0];
				//$line_tasks['is_req_taskvendors']=$is_req_taskvendors[$j];
                                $result = array_filter( $linetask_uploads, 'strlen' );
                               //  echo '<pre>'; print_r($result);
                                if($linetask_uploads!=''){
				$line_tasks['taskuploads']=implode(',', $result);
                                }
				/*if($js_req_taskvendors[$j+1] == ''){
				$line_tasks['is_req_taskvendors'] = 0;
				} else {
				$line_tasks['is_req_taskvendors'] = $js_req_taskvendors[$j+1];
				}*/
				//$k=$j+1;
				if($hidden_taskvendors==1 || $is_req_taskvendors[0]==1)
				$line_tasks['is_req_taskvendors']=1;
				else
				$line_tasks['is_req_taskvendors']=0;


				$line_tasks['rfp_id']=$rfp_id;
				//
				$lastinsid=$db->insertid();
				$tag1=0; $tag2=0; $tag3=0;
				if($i<$cnt)
				{
					$tag1=strcmp($linetaskname,$linetaskname);
					$tag2=strcmp($task_desc,$task_desc);
					$tag3=strcmp($rfpreference,$rfpreference);
					if($tag1!=0 || $tag2!=0 || $tag3!=0)
					$line_tasks['is_modified'] = 1;
					else
					$line_tasks['is_modified'] = 0;
					//$updateditems[]=$lastinsid;
				}
				else
				$line_tasks['is_modified'] = 0;
				/* echo "<pre>";
				print_r($line_tasks);  */
				if($model->tasks_store($line_tasks))
				{
					$mesg = "Tasks stored successfully";
				} else {
					$mesg = "Error saved";
				}
                       // }

			}  // exit;
		}
		$updateditms=implode(',',$updateditems);
		$sql = "UPDATE #__cam_rfpinfo SET modified_lineitems='".$updateditms."' WHERE id='".$rfp_id."'";
		$db->Setquery($sql);
		$db->query();///////

		$req_docprice =  JRequest::getVar('require_docprice',array());
		$attachmnent =  JRequest::getVar('attachmnent',array());
		//print_r($attachmnent);
		$query = "DELETE FROM #__cam_rfpsow_docs WHERE rfp_id=".$rfp_id;
		$db->setQuery($query);
		$db->query();
		//if(count($_FILES['attachmnent'])>0)
		//{
			for($i=0;$i<count($attachmnent);$i++)
			{

					if($attachmnent[$i] == '0'){
					//echo "anand";
					$req_docsow['doc_path']=$attachmnent[$i+1];
					$req_docsow['is_req_docvendors']= $req_docprice[$i+1];
					} else {
					//echo "anand123";
					$req_docsow['doc_path']=$attachmnent[$i];
					$req_docsow['is_req_docvendors']= $req_docprice[$i];
					}
					//} else {
					//$req_docsow['doc_path']=$attachmnent[$i];
					//}
					$req_docsow['rfp_id']=$rfp_id;
                                        if($req_docsow['doc_path']){
					if($model->reqdocs_store($req_docsow)) {
					$mesg = "Documents stored successfully";
					} else {
						$mesg = "Error saved";
					}
				}
			}
		//}
		//For Inserting Spl reqs
		//echo "<pre>"; print_r($_REQUEST);
		 $req_parentid =  JRequest::getVar('req_parentid',array());
		 $sub_req_id =  JRequest::getVar('sub_req_id',array());
		 $req_id =  JRequest::getVar('req_id',array());
		 $otherValue1 =  JRequest::getVar('otherValue1');
		 $otherValue2 =  JRequest::getVar('otherValue2');
		 $otherValue3 =  JRequest::getVar('otherValue3');
		 $otherValue =  $otherValue1.'/'.$otherValue2.'/'.$otherValue3;
		 $liabilityInsuranceAmount =  JRequest::getVar('liabilityInsuranceAmount');
		//code to delete previous special requirements
		$db = JFactory::getDBO();
		$query = "DELETE FROM #__cam_rfpreq_info WHERE rfp_id=".$rfp_id;
		$db->setQuery($query);
		$db->query();
		//For Inserting Special Requirement categories in database for RFP
		if(count($req_parentid)>0)
		{
			for($i=0;$i<count($req_parentid);$i++)
			{
				if(count($sub_req_id[$req_parentid[$i]])>0)
				{
					for($j=0;$j<count($sub_req_id[$req_parentid[$i]]);$j++)
					{

						if(count($req_id[$sub_req_id[$req_parentid[$i]][$j]])>0)
						{
							for($k=0;$k<count($req_id[$sub_req_id[$req_parentid[$i]][$j]]);$k++)
							{
								$splreq_rfp['rfp_id']=$rfp_id;
								$splreq_rfp['req_parentid']=$req_parentid[$i];
								$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
								$splreq_rfp['req_id']=$req_id[$sub_req_id[$req_parentid[$i]][$j]][$k];
								//
								if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
								$splreq_rfp['price']= $otherValue;
								//
								if($sub_req_id[$req_parentid[$i]][$j]=='12')
								$splreq_rfp['price']=$liabilityInsuranceAmount;
								//
								if($model->rfpsplreqs_store($splreq_rfp)) {

								}
							}
						} else {

							$splreq_rfp['rfp_id']=$rfp_id;
							$splreq_rfp['req_parentid']=$req_parentid[$i];
							$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
							$splreq_rfp['req_id']=0;
							//
							if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
							$splreq_rfp['price']= $otherValue;
							//
							if($sub_req_id[$req_parentid[$i]][$j]=='12')
							$splreq_rfp['price']=$liabilityInsuranceAmount;
							//
							if($model->rfpsplreqs_store($splreq_rfp)) {

							}
						}
					}
				} else {
					$splreq_rfp['rfp_id']=$rfp_id;
					$splreq_rfp['req_parentid']=$req_parentid[$i];
					$splreq_rfp['req_subparentid']=0;
					$splreq_rfp['req_id']=0;
					//echo "<pre>"; print_r($splreq_rfp);
					if($model->rfpsplreqs_store($splreq_rfp)) {

					}
				}
				//
			}
		} //exit;
				$pmdetails=$model->getPManagers($property_id);
			$pr_name=$model->getPropertyName($property_id);
			$from_name='CAMassistant';
			//$from_email=$user->email;
			$from_email='Support@CAMassistant.com';
			$pmemail=$pmdetails[0]->email;
			$sub='RFP Created Info';
			if($pmemail)
			{
				//$sitename=$mainframe->getCfg('sitename');
			//	$getCfgfromname=$mainframe->getCfg('fromname');
				$body_content='';
				$body='';
				$body_content='<table width="100%" border="0" cellspacing="0" cellpadding="0">
								  <tr>
									<td><h3>Congratulations!</h3></td>
								  </tr>
								  <tr>
									<td>An RFP has been successfully submitted to the CAMASSISTANT Network for the property <strong>"'.ucwords($pr_name).'"</strong> </td>
								  </tr>
								  <tr>
									<td>&nbsp;</td>
								  </tr>
								</table>';
				$body = '<table width="100%" border="0" cellspacing="0" cellpadding="0">
					 <tr>
					   <td width="20%"><span style="font-family: Helvetica,Arial,sans-serif;">Hi '.ucwords($pmdetails[0]->name).'</span></td>
					   <td>&nbsp;</td>
					 </tr>
					  <tr>
					   <td width="20%">&nbsp;</td>
					   <td>&nbsp;</td>
					 </tr>
					 <tr>
					 <td colspan="2">'.$body_content.'</td>
					 </tr>
					  <tr>
					   <td>Regards</td>
					   <td>&nbsp;</td>
					 </tr>';
					/*  <tr>
					   <td>'.ucfirst($user->name).'</td>
					   <td>&nbsp;</td>
					 </tr>*/
					$body .= ' <tr>
					   <td>CAMASSISTANT NETWORK</td>
					   <td>&nbsp;</td>
					 </tr>
				   </table>';
				//$successMail =JUtility::sendMail($from_email, $from_name, $pmemail, $sub, $body,1);
			}

			//exit;
			//Code for sending RFP Emails to Vendors for the related Industry
			//$pr_name=$model->getPropertyName($property_id);

			if($choose_tasks=='Engineer')
			$industry_id=47;
			if($choose_tasks=='Architect')
			$industry_id=23;
			//print_r($industry_id);
			$model->rfp_requirements_validations($industry_id,$userid,$property_id,$rfp_id);

	$industryid =  JRequest::getVar('industryid');
	$rfpstatus =  JRequest::getVar('rfpstatus');
	$rfpapproval =  JRequest::getVar('rfpapproval');
	$search =  JRequest::getVar('search');

	//To re set the vendor closing time
		$vendor_close = $proposalDueDate ;
		$present_date = date('Y-m-d H:i');                 //Today date
		$second = $vendor_close ;
		$explode = explode(' ',$second);
		$explode_date = explode('-',$explode[0]);
		$second_date = $explode_date[2].'-'.$explode_date[0].'-'.$explode_date[1].' '.$explode[1] ;    //RFP due date
		$diff = strtotime($second_date) - strtotime($present_date);
		if($diff > '86400'){
		$change_vendorcloseing='UPDATE `#__cam_rfpinfo` SET close_vendor = "" where id= '.$rfp_id.'';
		$db->setquery($change_vendorcloseing);
		$db->query();
		} else{
		$close_vendor='UPDATE `#__cam_rfpinfo` SET close_vendor = "closed" where id= '.$rfp_id.'';
		$db->setquery($close_vendor);
		$db->query();
		}
		//Completed
		
		$basicrequest = JRequest::getVar('basicrequest','');
		if($basicrequest == 'basicrequest'){
			$linetask_uploads =  JRequest::getVar('linetask_uploads_210',array());
			for( $b=0; $b<count($linetask_uploads); $b++ ){
				$basic['rfpid'] = $rfp_id ;
				$basic['property_id'] = $property_id ;
				$exp_file = explode('/',$linetask_uploads[$b]);
				$basic['filename'] = $exp_file[count($exp_file)-1] ;
				$linetask_uploads[$b] = str_replace('components/com_camassistant/doc/','',$linetask_uploads[$b]);
				$basic['filepath'] = $linetask_uploads[$b] ;
				$basic['upload_date'] = '' ;
				
				$save_basicfiles = $model->savebfiles($basic);
			}
		}
		

		$msg='RFP Save and Approved  Successfully';
		$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&industry_id='.$industryid.'&rfpstatus='.$rfpstatus.'&rfpapproval='.$rfpapproval.'&search='.$search,$msg );

	}
	function editrfpreject(){
	JRequest::setVar('view', 'rfp');
	parent::display();
	}
	function editreject(){
	//echo '<pre>'; print_r($_REQUEST); exit;
	$db = JFactory::getDBO();
	$vendoremail =  JRequest::getVar('recipient');
	$name =  JRequest::getVar('industry_id');
	$reject_body =  JRequest::getVar('reject_body', '', 'post', 'string', JREQUEST_ALLOWRAW);
	$body=nl2br($reject_body);
	//$tags = array("<p><p>","</p></p>","<br><br>","<br /><br />");
    //$rtags = array("","\n","\n","\n");
    //$reject_body1 = str_replace($rtags, $tags, $reject_body);
	//$body =  JRequest::getVar('reject_body', '', 'post', 'string', JREQUEST_ALLOWRAW);
	//print_r($body); exit;
	//$body= $reject_body1;
	$sub = JRequest::getVar('subject');
	$from_email='support@myvendorcenter.com';
	$from_name='MyVendorCenter.com';
	$industry_id=JRequest::getVar('industry_id');
	$rfpstatus=JRequest::getVar('rfpstatus');
	$rfpapproval=JRequest::getVar('rfpapproval');
	$search=JRequest::getVar('search');
	$status =  JRequest::getVar('status');
	$rfpid=JRequest::getVar('rfp_id');

	$sql = "UPDATE #__cam_rfpinfo SET publish='2' where id='".$rfpid."'";
	$db->setquery($sql);
	$db->query();
	$successMail =JUtility::sendMail($from_email, $from_name, $vendoremail, $sub, $body,$mode = 1);
	echo "<script language='javascript' type='text/javascript'>
	window.parent.document.getElementById( 'sbox-window' ).close();
	alert('RFP Rejected Successfully');
	window.parent.location.href='index.php?option=com_camassistant&controller=rfp';
	</script>";
	//exit;
	//echo "<script language='javascript' type='text/javascript'>
	//window.parent.document.getElementById( 'sbox-window' ).close();
	//parent.location.reload();
	//	window.parent.location();

	 /*?></script>";<?php */
	exit;

	$this->setRedirect('index.php?option=com_camassistant&controller=rfp&industry_id='.$industry_id.'&rfpstatus='.$rfpstatus.'&rfpapproval='.$rfpapproval.'&search='.$search,'RFP Rejected Successfully');

	}
	function update_rfp(){
	
	//$user=JFactory::getUser();  //For $my
		$basepath=JURI::root();
		$db = &JFactory::getDbo();
		$model	=& $this->getModel('rfp');
		$itemid=JRequest::getVar('Itemid',0);
		$show=JRequest::getVar('show','');
		$post	= JRequest::getVar("task",'');
		//echo "<pre>"; print_r($_REQUEST); exit;
		$proposalDueDate= JRequest::getVar('proposalDueDate');
		$rfp_adminstatus= JRequest::getVar('rfp_adminstatus');
		$jobnotes= JRequest::getVar('jobnotes');
		$data['jobnotes']=$jobnotes;
		$data['rfp_adminstatus']=$rfp_adminstatus;
		$proposaldate=explode(' ',$proposalDueDate);
		$data['proposalDueDate']=$proposaldate[0];
		$data['proposalDueTime']=$proposaldate[1];

		/*if($proposaldate[2] == '')
		$proposaldate[2] = 'pm' ;
		$data['proposalDueTime']=$proposaldate[1].strtoupper($proposaldate[2]);*/
		$work_perform =  JRequest::getVar('work_perform');

		//print_r(count($work_perform)); exit;
		$site_visit =  JRequest::getVar('site_visit',array());
		$data['work_perform'] = $work_perform;
		if (count($site_visit)>1) {
		$data['site_visit']=implode(',',$site_visit);
		} else {
		$data['site_visit']=$site_visit[0];
		}
		$bidders_info =  JRequest::getVar('bidders_info',array());
		if($site_visit[0]=='Required prior to bidding')
		$data['bidders_info']=$bidders_info[0];
		else if($site_visit[0]=='Recommended')
		$data['bidders_info']=$bidders_info[1];
		else
		$data['bidders_info']=$bidders_info[2];

		//if($data['rfp_type']=='rfp'){
		//$data['publish']=1;
	   // }else{

       // }
	   //echo "<pre>"; print_r($_REQUEST); exit;
                $present_date = date('Y-m-d');
        $date1=strtotime($present_date);
        $proposal_date=explode('-',$proposaldate[0]);
        $date2= strtotime($proposal_date[2].'-'.$proposal_date[0].'-'.$proposal_date[1]);
       // print_r($date1);
        // echo $basepath=JURI::root();
       if( $_REQUEST['rfp_type']=='closed' && $date1<$date2){
         // echo 'hi';
          $query23 = "DELETE FROM #__cam_closedzip WHERE rfpid=".$_REQUEST['id'];
		$db->setQuery($query23);
		$db->query();
         $name = "/home/allen/public_html/live/zipdownloads/RFP".$_REQUEST['id'].".zip";
       // readfile("$name");
         chmod("$name",0777);
         unlink("$name");
       }
	   	$id= JRequest::getVar('id');
		$data['cust_id']= JRequest::getVar('cust_id');
		/*$createdDate=date('m-d-Y');
		$data['createdDate']=$createdDate;*/
		$data['update_date']=date('m-d-Y');
		$property_id= JRequest::getVar('property_id');
		//To get the property owner
			$get_pmid="SELECT property_manager_id FROM #__cam_property WHERE id='".$property_id."'";
			$db->Setquery($get_pmid);
			$data['cust_id'] = $db->loadResult();
		//Completed
		$industry_id= JRequest::getVar('industry_id');
		$industry_id2= JRequest::getVar('industry_id2');
		$data['property_id']=$property_id;
		$data['industry_id']=$industry_id[0];
		$data['industry_id2']=$industry_id2;
		$projectName= JRequest::getVar('projectName');
		$work_perform_other = '';
		$frequency= JRequest::getVar('frequency');
		$startDate= JRequest::getVar('startDate');
		$endDate= JRequest::getVar('endDate');
		$maxProposals= JRequest::getVar('maxProposals');
		$data['maxProposals']=$maxProposals;
		$rfp_type= JRequest::getVar('rfp_type');
		$publish= JRequest::getVar('publish');
		if($publish==''){
		$data['publish']=1;
		} else {
		$data['publish']=$publish;
		}

		$terms= JRequest::getVar('terms');

		if($rfp_type==''){
		$data['rfp_type']='draft';
		} else {
		$data['rfp_type']=$rfp_type;
		}

		$data['startDate']=$startDate;
		$data['terms']=$terms;
		//if($rfp_type=='closed'){
		$data['update_rfp']='0';
		//} else {
		//$data['update_rfp']='1';
		//}
		$data['endDate']=$endDate;
		$data['frequency']=$frequency;
		$data['maxProposals']=$maxProposals;
		$data['projectName']=$projectName;
		$data['work_perform_other'] = '' ;

		//Industry by sateesh
		$industry = $_REQUEST['industry_id'];
		$sql1 = "SELECT industry_id FROM #__cam_rfpinfo WHERE id=".$id;
		$db->setQuery($sql1);
		$db_res = $db->loadResult();

		  $query = "DELETE FROM #__cam_rfpindustries WHERE rfpid=".$id." AND industry_id=".$db_res;
			$db->setQuery($query);
			$db->query();
		for($in=0; $in<count($industry); $in++){
		if($industry[$in]){
			$insert_sql = "insert into #__cam_rfpindustries values ('','".$id."','".$industry[$in]."')";
			}
			$db->SetQuery($insert_sql);
			$db->query();
		//echo  $industry[$in];
		}
		//exit;//Completed

		$rfp_id = $id;
		$TempLineItems=$model->get_tempLineTasks($rfp_id);
		$data['id']= $id;
		//$link ='index.php?option=com_camassistant&controller=rfp&rfp_type='.$data['rfp_type'].'&task=reviewrfp&rfpid='.$rfpid.'&Itemid='.$itemid;

		$line_tasks['rfp_id']=$rfp_id;
		list($month, $day, $year) = split('[/.-]', $data['proposalDueDate']);
		$datesminutes = strtotime($year."-".$month."-".$day);
		$hr_min = substr($data['proposalDueTime'], 0, -2);  // returns "7:00"
		$am_pm = substr($data['proposalDueTime'], -2);    // returns "AM" OR "PM"
		if($am_pm == 'PM')
		{
		$min = substr($hr_min, -2);
		$hr = substr($hr_min, 0, -3);
		$x = substr($due_time, 0, 2);
		if($x != 12)
		$hr = $hr + 12;
		}
		else if($am_pm == 'AM')
		{
		$min = substr($hr_min, -2);
		$hr = substr($hr_min, 0, -3);
		}
		$timeminutes =  $hr*60+$min;
		$totalminutes = $datesminutes + $timeminutes;
		$data['secondstime'] =  $totalminutes;
		/*echo "<pre>";
		print_r($data);exit;*/
	if($model->store_update($data)) {
	//echo "<pre>"; print_r($data); exit;
	echo 'success';

		} else {
			$mesg = "Could not added RFP";
		}
		$sql = "UPDATE #__cam_rfpinfo SET terms='".$terms."' WHERE id='".$rfp_id."'";
		$db->Setquery($sql);
		$db->query();
		$post['rfp_indus_data']=$_SESSION['rfp']['industry'];

		//$rfp_id = $rfpid;
		$line_tasks['rfp_id']=$rfp_id;
		$task_desc =  JRequest::getVar('task_desc',array());
		$linetaskname =  JRequest::getVar('linetaskname',array());
		$rfpreference =  JRequest::getVar('rfpreference',array());
		$is_req_taskvendors =  JRequest::getVar('is_req_taskvendors',array());
		$hidden_taskvendors =  JRequest::getVar('hidden_taskvendors',array());
		$linetask_uploads =  JRequest::getVar('linetask_uploads',array());
                 $line_taskno =  JRequest::getVar('line_taskno',array());
	//echo "<pre>"; print_r($is_req_taskvendors); exit;
		//code to delete previous tasks
		 $old_new_taskids = JRequest::getVar('old_taskids','');
		$rfp = JRequest::getVar('rfpid','');
		$db = JFactory::getDBO();
		$sql = "SELECT task_id FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id;
		$db->setQuery($sql);
		$db_taskids = $db->loadResultArray();

		$old_taskids_modified = array_diff($old_new_taskids, array(''));

		for($i=0; $i<count($db_taskids); $i++)
		{
			if(!in_array($db_taskids[$i],$old_taskids_modified))
			{
			//code to delete taskid from  #__cam_rfpsow_linetask
			$query = "DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id." AND task_id=".$db_taskids[$i];
			$db->setQuery($query);
			$db->query();
			//code to delete taskid from  #__cam_rfpsow_docs_lineitems_prices
			$query = "DELETE FROM #__cam_rfpsow_docs_lineitems_prices WHERE rfp_id=".$rfp_id." AND item_id=".$db_taskids[$i]." AND item_type='task' ";
			$db->setQuery($query);
			$db->query();
			}
		}
		// end of code to update task ids by lalitha
		$updateditems=array();
		$k=0;
		//code to delete previous tasks
		//$query = "DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id;
		//$db->setQuery($query);
		//$db->query();
		//print_r($rfp_id); exit;
		//end of code
		//echo "<pre>"; print_r($_REQUEST);
		$basicrequest = JRequest::getVar('basicrequest','');
		if($basicrequest == 'basicrequest'){
			$line_taskno[0] = '10000000';
		}
		if(count($line_taskno)>0)
		{
			for($i=0;$i<count($line_taskno);$i++)
			{

                             $task_desc =  JRequest::getVar('task_desc_'.$line_taskno[$i] ,array());

                             $linetaskname =  JRequest::getVar('linetaskname_'.$line_taskno[$i] ,array());
                              $rfpreference=  JRequest::getVar('rfpreference_'.$line_taskno[$i] ,array());
                            $linetask_uploads =  JRequest::getVar('linetask_uploads_'.$line_taskno[$i], array());
                            $is_req_taskvendors=  JRequest::getVar('is_req_taskvendors_'.$line_taskno[$i] ,array());
                            $hidden_taskvendors=  JRequest::getVar('hidden_taskvendors_'.$line_taskno[$i] ,array());

				$line_tasks['task_id']=$old_new_taskids[$i]; //echo '<br/>';

				$line_tasks['task_desc']=$task_desc[0];
				$line_tasks['linetaskname']=$linetaskname[0];
				$line_tasks['rfpreference']=$rfpreference[0];
				//$line_tasks['is_req_taskvendors']=$is_req_taskvendors[$j];
                                $result = array_filter( $linetask_uploads, 'strlen' );
                               //  echo '<pre>'; print_r($result);
                                if($linetask_uploads!=''){
				$line_tasks['taskuploads']=implode(',', $result);
                                }
				/*if($js_req_taskvendors[$j+1] == ''){
				$line_tasks['is_req_taskvendors'] = 0;
				} else {
				$line_tasks['is_req_taskvendors'] = $js_req_taskvendors[$j+1];
				}*/
				//$k=$j+1;
				if($hidden_taskvendors==1 || $is_req_taskvendors[0]==1)
				$line_tasks['is_req_taskvendors']=1;
				else
				$line_tasks['is_req_taskvendors']=0;


				$line_tasks['rfp_id']=$rfp_id;
				//
				$lastinsid=$db->insertid();
				$tag1=0; $tag2=0; $tag3=0;
				if($i<$cnt)
				{
					$tag1=strcmp($linetaskname,$linetaskname);
					$tag2=strcmp($task_desc,$task_desc);
					$tag3=strcmp($rfpreference,$rfpreference);
					if($tag1!=0 || $tag2!=0 || $tag3!=0)
					$line_tasks['is_modified'] = 1;
					else
					$line_tasks['is_modified'] = 0;
					//$updateditems[]=$lastinsid;
				}
				else
				$line_tasks['is_modified'] = 0;
				/* echo "<pre>";
				print_r($line_tasks);  */
				if($model->tasks_store($line_tasks))
				{
					$mesg = "Tasks stored successfully";
				} else {
					$mesg = "Error saved";
				}
                       // }

			}  // exit;
		}
		$updateditms=implode(',',$updateditems);
		$sql = "UPDATE #__cam_rfpinfo SET modified_lineitems='".$updateditms."' WHERE id='".$rfp_id."'";
		$db->Setquery($sql);
		$db->query();///////

		$req_docprice =  JRequest::getVar('require_docprice',array());
		$attachmnent =  JRequest::getVar('attachmnent',array());
		//print_r($attachmnent);
		$query = "DELETE FROM #__cam_rfpsow_docs WHERE rfp_id=".$rfp_id;
		$db->setQuery($query);
		$db->query();
		//if(count($_FILES['attachmnent'])>0)
		//{
			for($i=0;$i<count($attachmnent);$i++)
			{

					if($attachmnent[$i] == '0'){
					//echo "anand";
					$req_docsow['doc_path']=$attachmnent[$i+1];
					$req_docsow['is_req_docvendors']= $req_docprice[$i+1];
					} else {
					//echo "anand123";
					$req_docsow['doc_path']=$attachmnent[$i];
					$req_docsow['is_req_docvendors']= $req_docprice[$i];
					}
					//} else {
					//$req_docsow['doc_path']=$attachmnent[$i];
					//}
					$req_docsow['rfp_id']=$rfp_id;
                                        if($req_docsow['doc_path']){
					if($model->reqdocs_store($req_docsow)) {
					$mesg = "Documents stored successfully";
					} else {
						$mesg = "Error saved";
					}
				}
			}
		//}
		//For Inserting Spl reqs
		//echo "<pre>"; print_r($_REQUEST);
		 $req_parentid =  JRequest::getVar('req_parentid',array());
		 $sub_req_id =  JRequest::getVar('sub_req_id',array());
		 $req_id =  JRequest::getVar('req_id',array());
		 $otherValue1 =  JRequest::getVar('otherValue1');
		 $otherValue2 =  JRequest::getVar('otherValue2');
		 $otherValue3 =  JRequest::getVar('otherValue3');
		 $otherValue =  $otherValue1.'/'.$otherValue2.'/'.$otherValue3;
		 $liabilityInsuranceAmount =  JRequest::getVar('liabilityInsuranceAmount');
		//code to delete previous special requirements
		$db = JFactory::getDBO();
		$query = "DELETE FROM #__cam_rfpreq_info WHERE rfp_id=".$rfp_id;
		$db->setQuery($query);
		$db->query();
		//For Inserting Special Requirement categories in database for RFP
		if(count($req_parentid)>0)
		{
			for($i=0;$i<count($req_parentid);$i++)
			{
				if(count($sub_req_id[$req_parentid[$i]])>0)
				{
					for($j=0;$j<count($sub_req_id[$req_parentid[$i]]);$j++)
					{

						if(count($req_id[$sub_req_id[$req_parentid[$i]][$j]])>0)
						{
							for($k=0;$k<count($req_id[$sub_req_id[$req_parentid[$i]][$j]]);$k++)
							{
								$splreq_rfp['rfp_id']=$rfp_id;
								$splreq_rfp['req_parentid']=$req_parentid[$i];
								$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
								$splreq_rfp['req_id']=$req_id[$sub_req_id[$req_parentid[$i]][$j]][$k];
								//
								if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
								$splreq_rfp['price']= $otherValue;
								//
								if($sub_req_id[$req_parentid[$i]][$j]=='12')
								$splreq_rfp['price']=$liabilityInsuranceAmount;
								//
								if($model->rfpsplreqs_store($splreq_rfp)) {

								}
							}
						} else {

							$splreq_rfp['rfp_id']=$rfp_id;
							$splreq_rfp['req_parentid']=$req_parentid[$i];
							$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
							$splreq_rfp['req_id']=0;
							//
							if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
							$splreq_rfp['price']= $otherValue;
							//
							if($sub_req_id[$req_parentid[$i]][$j]=='12')
							$splreq_rfp['price']=$liabilityInsuranceAmount;
							//
							if($model->rfpsplreqs_store($splreq_rfp)) {

							}
						}
					}
				} else {
					$splreq_rfp['rfp_id']=$rfp_id;
					$splreq_rfp['req_parentid']=$req_parentid[$i];
					$splreq_rfp['req_subparentid']=0;
					$splreq_rfp['req_id']=0;
					//echo "<pre>"; print_r($splreq_rfp);
					if($model->rfpsplreqs_store($splreq_rfp)) {

					}
				}
				//
			}
		} //exit;
	$industryid =  JRequest::getVar('industryid');
	$rfpstatus =  JRequest::getVar('rfpstatus');
	$rfpapproval =  JRequest::getVar('rfpapproval');
	$search =  JRequest::getVar('search');

	//To re set the vendor closing time
		$present_date = date('Y-m-d H:i');                  //Today date
		$second = $proposalDueDate ;
		$explode = explode(' ',$second);
		$explode_date = explode('-',$explode[0]);
		$second_date = $explode_date[2].'-'.$explode_date[0].'-'.$explode_date[1].' '.$explode[1] ;    //RFP due date
		$diff = strtotime($second_date) - strtotime($present_date);
		if($diff > '86400'){
		$change_vendorcloseing='UPDATE `#__cam_rfpinfo` SET close_vendor = "" where id= '.$rfp_id.'';
		$db->setquery($change_vendorcloseing);
		$db->query();
		} else{
		$close_vendor='UPDATE `#__cam_rfpinfo` SET close_vendor = "closed" where id= '.$rfp_id.'';
		$db->setquery($close_vendor);
		$db->query();
		}
		//Completed
		$basicrequest = JRequest::getVar('basicrequest','');
		if($basicrequest == 'basicrequest'){
			$linetask_uploads =  JRequest::getVar('linetask_uploads_210',array());
			for( $b=0; $b<count($linetask_uploads); $b++ ){
				$basic['rfpid'] = $rfp_id ;
				$basic['property_id'] = $property_id ;
				$exp_file = explode('/',$linetask_uploads[$b]);
				$basic['filename'] = $exp_file[count($exp_file)-1] ;
				$linetask_uploads[$b] = str_replace('components/com_camassistant/doc/','',$linetask_uploads[$b]);
				$basic['filepath'] = $linetask_uploads[$b] ;
				$basic['upload_date'] = '' ;
				
				$save_basicfiles = $model->savebfiles($basic);
			}
		}
		

		$msg='RFP Silently Updated Successfully';
		$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&industry_id='.$industryid.'&rfpstatus='.$rfpstatus.'&rfpapproval='.$rfpapproval.'&search='.$search,$msg );
	}
	function draft_save(){
	//echo "<pre>"; print_r($_POST);  exit;
	//$user=JFactory::getUser();  //For $my
		$basepath=JURI::root();
		$db = &JFactory::getDbo();
		$model	=& $this->getModel('rfp');
		$itemid=JRequest::getVar('Itemid',0);
		$show=JRequest::getVar('show','');
		$post	= JRequest::getVar("task",'');
		//echo "<pre>"; print_r($_REQUEST); exit;
		$proposalDueDate= JRequest::getVar('proposalDueDate');
		$jobnotes= JRequest::getVar('jobnotes');
		$data['jobnotes']=$jobnotes;
		$proposaldate=explode(' ',$proposalDueDate);
		$data['proposalDueDate']=$proposaldate[0];
		$data['proposalDueTime']=$proposaldate[1];

		/*if($proposaldate[2] == '')
		$proposaldate[2] = 'pm' ;
		$data['proposalDueTime']=$proposaldate[1].strtoupper($proposaldate[2]);*/
		$work_perform =  JRequest::getVar('work_perform');

		//print_r(count($work_perform)); exit;
		$site_visit =  JRequest::getVar('site_visit',array());
		$data['work_perform'] = $work_perform;
		if (count($site_visit)>1) {
		$data['site_visit']=implode(',',$site_visit);
		} else {
		$data['site_visit']=$site_visit[0];
		}
		$bidders_info =  JRequest::getVar('bidders_info',array());
		if($site_visit[0]=='Required prior to bidding')
		$data['bidders_info']=$bidders_info[0];
		else if($site_visit[0]=='Recommended')
		$data['bidders_info']=$bidders_info[1];
		else
		$data['bidders_info']=$bidders_info[2];

		//if($data['rfp_type']=='rfp'){
		//$data['publish']=1;
	   // }else{

       // }
	   //echo "<pre>"; print_r($_REQUEST); exit;
	   	$id= JRequest::getVar('id');
		$data['cust_id']= JRequest::getVar('cust_id');
		/*$createdDate=date('m-d-Y');
		$data['createdDate']=$createdDate;*/
		$data['update_date']=date('m-d-Y');
		$property_id= JRequest::getVar('property_id');
		//To get the property owner
			$get_pmid="SELECT property_manager_id FROM #__cam_property WHERE id='".$property_id."'";
			$db->Setquery($get_pmid);
			$data['cust_id'] = $db->loadResult();
		//Completed
                        $present_date = date('Y-m-d');
        $date1=strtotime($present_date);
        $proposal_date=explode('-',$proposaldate[0]);
        $date2= strtotime($proposal_date[2].'-'.$proposal_date[0].'-'.$proposal_date[1]);
       // print_r($date1);
        // echo $basepath=JURI::root();
       if( $_REQUEST['rfp_type']=='closed' && $date1<$date2){
         // echo 'hi';
          $query23 = "DELETE FROM #__cam_closedzip WHERE rfpid=".$_REQUEST['id'];
		$db->setQuery($query23);
		$db->query();
         $name = "/home/allen/public_html/live/zipdownloads/RFP".$_REQUEST['id'].".zip";
       // readfile("$name");
         chmod("$name",0777);
         unlink("$name");
       }
		$industry_id= JRequest::getVar('industry_id');
		$data['property_id']=$property_id;
		$data['industry_id']=$industry_id[0];
		$projectName= JRequest::getVar('projectName');
		$work_perform_other = '';
		$frequency= JRequest::getVar('frequency');
		$startDate= JRequest::getVar('startDate');
		$endDate= JRequest::getVar('endDate');
		$maxProposals= JRequest::getVar('maxProposals');
		$data['maxProposals']=$maxProposals;
		$rfp_type= JRequest::getVar('rfp_type');
		$publish= JRequest::getVar('publish');
		if($publish==''){
		$data['publish']=1;
		} else {
		$data['publish']=$publish;
		}

		$terms= JRequest::getVar('terms');

		//if($rfp_type==''){
		$data['rfp_type']='draft';
		//} else {
		//$data['rfp_type']=$rfp_type;
		//}

		$data['startDate']=$startDate;
		$data['terms']=$terms;
		//if($rfp_type=='closed'){
		$data['update_rfp']='0';
		//} else {
		//$data['update_rfp']='1';
		//}
		$data['endDate']=$endDate;
		$data['frequency']=$frequency;
		$data['maxProposals']=$maxProposals;
		$data['projectName']=$projectName;
		$data['work_perform_other'] = '';

		//Industry by sateesh
		$industry = $_REQUEST['industry_id'];
		$sql1 = "SELECT industry_id FROM #__cam_rfpinfo WHERE id=".$id;
		$db->setQuery($sql1);
		$db_res = $db->loadResult();

		  $query = "DELETE FROM #__cam_rfpindustries WHERE rfpid=".$id." AND industry_id=".$db_res;
			$db->setQuery($query);
			$db->query();
		for($in=0; $in<count($industry); $in++){
		if($industry[$in]){
			$insert_sql = "insert into #__cam_rfpindustries values ('','".$id."','".$industry[$in]."')";
			}
			$db->SetQuery($insert_sql);
			$db->query();
		//echo  $industry[$in];
		}
		//Completed

		$rfp_id = $id;
		$TempLineItems=$model->get_tempLineTasks($rfp_id);
		$data['id']= $id;
		//$link ='index.php?option=com_camassistant&controller=rfp&rfp_type='.$data['rfp_type'].'&task=reviewrfp&rfpid='.$rfpid.'&Itemid='.$itemid;

		$line_tasks['rfp_id']=$rfp_id;
		list($month, $day, $year) = split('[/.-]', $data['proposalDueDate']);
		$datesminutes = strtotime($year."-".$month."-".$day);
		$hr_min = substr($data['proposalDueTime'], 0, -2);  // returns "7:00"
		$am_pm = substr($data['proposalDueTime'], -2);    // returns "AM" OR "PM"
		if($am_pm == 'PM')
		{
		$min = substr($hr_min, -2);
		$hr = substr($hr_min, 0, -3);
		$x = substr($due_time, 0, 2);
		if($x != 12)
		$hr = $hr + 12;
		}
		else if($am_pm == 'AM')
		{
		$min = substr($hr_min, -2);
		$hr = substr($hr_min, 0, -3);
		}
		$timeminutes =  $hr*60+$min;
		$totalminutes = $datesminutes + $timeminutes;
		$data['secondstime'] =  $totalminutes;
		/*echo "<pre>";
		print_r($data);exit;*/
	if($model->store_update($data)) {
	//echo "<pre>"; print_r($data); exit;
	echo 'success';

		} else {
			$mesg = "Could not added RFP";
		}
		$sql = "UPDATE #__cam_rfpinfo SET terms='".$terms."' WHERE id='".$rfp_id."'";
		$db->Setquery($sql);
		$db->query();
		$post['rfp_indus_data']=$_SESSION['rfp']['industry'];

		//$rfp_id = $rfpid;
		$line_tasks['rfp_id']=$rfp_id;

		$task_desc =  JRequest::getVar('task_desc',array());
		$linetaskname =  JRequest::getVar('linetaskname',array());
		$rfpreference =  JRequest::getVar('rfpreference',array());
		$linetask_uploads =  JRequest::getVar('linetask_uploads',array());
		//echo "<pre>"; print_r($task_desc);
		$is_req_taskvendors =  JRequest::getVar('is_req_taskvendors',array());
		$hidden_taskvendors =  JRequest::getVar('hidden_taskvendors',array());

		//code to update taskids by lalitha
		$old_new_taskids = JRequest::getVar('old_taskids','');
		$rfp = JRequest::getVar('rfpid','');
		$db = JFactory::getDBO();
		$sql = "SELECT task_id FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id;
		$db->setQuery($sql);
		$db_taskids = $db->loadResultArray();

		$old_taskids_modified = array_diff($old_new_taskids, array(''));
		//echo "<pre>"; echo 'anand';print_r($old_taskids_modified);
		for($i=0; $i<count($db_taskids); $i++)
		{
			if(!in_array($db_taskids[$i],$old_taskids_modified))
			{
			//code to delete taskid from  #__cam_rfpsow_linetask
			 $query = "DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id." AND task_id=".$db_taskids[$i];
			$db->setQuery($query);
			$db->query();
			//code to delete taskid from  #__cam_rfpsow_docs_lineitems_prices
			 $query = "DELETE FROM #__cam_rfpsow_docs_lineitems_prices WHERE rfp_id=".$rfp_id." AND item_id=".$db_taskids[$i]." AND item_type='task' ";
			$db->setQuery($query);
			$db->query();
			}
		}
		// end of code to update task ids by lalitha
		$updateditems=array();
		$k=0;
		$cnt=count($TempLineItems);
		if(count($linetaskname)>0)
		{
			for($i=0;$i<count($task_desc);$i++)
			{
				$line_tasks['task_id']=$old_new_taskids[$i];
				$line_tasks['task_desc']=$task_desc[$i];
				$line_tasks['linetaskname']=$linetaskname[$i];
				$line_tasks['rfpreference']=$rfpreference[$i];
				//$line_tasks['is_req_taskvendors']=$is_req_taskvendors[$i];
				$line_tasks['taskuploads']=$linetask_uploads[$i];

				if($hidden_taskvendors[$i]==1)
				$line_tasks['is_req_taskvendors']=1;
				else
				$line_tasks['is_req_taskvendors']=0;


				$line_tasks['rfp_id']=$rfp_id;
				//
				$lastinsid=$db->insertid();
				$tag1=0; $tag2=0; $tag3=0;
				if($i<$cnt)
				{
					$tag1=strcmp($TempLineItems[$i]->linetaskname,$linetaskname[$i]);
					$tag2=strcmp($TempLineItems[$i]->task_desc,$task_desc[$i]);
					$tag3=strcmp($TempLineItems[$i]->rfpreference,$rfpreference[$i]);
					if($tag1!=0 || $tag2!=0 || $tag3!=0)
					$line_tasks['is_modified'] = 1;
					else
					$line_tasks['is_modified'] = 0;
					//$updateditems[]=$lastinsid;
				}
				else
				$line_tasks['is_modified'] = 0;
				/*echo "<pre>";
				print_r($line_tasks);*/
				if($model->tasks_store($line_tasks))
				{
					$mesg = "Tasks stored successfully";
				} else {
					$mesg = "Error saved";
				}


			}
		} //exit;
		$updateditms=implode(',',$updateditems);
		$sql = "UPDATE #__cam_rfpinfo SET modified_lineitems='".$updateditms."' WHERE id='".$rfp_id."'";
		$db->Setquery($sql);
		$db->query();///////

		$req_docprice =  JRequest::getVar('require_docprice',array());
		$attachmnent =  JRequest::getVar('attachmnent',array());
		//print_r($attachmnent);
		$query = "DELETE FROM #__cam_rfpsow_docs WHERE rfp_id=".$rfp_id;
		$db->setQuery($query);
		$db->query();
		//if(count($_FILES['attachmnent'])>0)
		//{
			for($i=0;$i<count($attachmnent);$i++)
			{

					if($attachmnent[$i] == '0'){
					//echo "anand";
					$req_docsow['doc_path']=$attachmnent[$i+1];
					$req_docsow['is_req_docvendors']= $req_docprice[$i+1];
					} else {
					//echo "anand123";
					$req_docsow['doc_path']=$attachmnent[$i];
					$req_docsow['is_req_docvendors']= $req_docprice[$i];
					}
					//} else {
					//$req_docsow['doc_path']=$attachmnent[$i];
					//}
					$req_docsow['rfp_id']=$rfp_id;
                                if($req_docsow['doc_path']){
					if($model->reqdocs_store($req_docsow)) {
					$mesg = "Documents stored successfully";
					} else {
						$mesg = "Error saved";
					}
				}
			}
		//}
		//For Inserting Spl reqs
		//echo "<pre>"; print_r($_REQUEST);
		 $req_parentid =  JRequest::getVar('req_parentid',array());
		 $sub_req_id =  JRequest::getVar('sub_req_id',array());
		 $req_id =  JRequest::getVar('req_id',array());
		 $otherValue1 =  JRequest::getVar('otherValue1');
		 $otherValue2 =  JRequest::getVar('otherValue2');
		 $otherValue3 =  JRequest::getVar('otherValue3');
		 $otherValue =  $otherValue1.'/'.$otherValue2.'/'.$otherValue3;
		 $liabilityInsuranceAmount =  JRequest::getVar('liabilityInsuranceAmount');
		//code to delete previous special requirements
		$db = JFactory::getDBO();
		$query = "DELETE FROM #__cam_rfpreq_info WHERE rfp_id=".$rfp_id;
		$db->setQuery($query);
		$db->query();
		//For Inserting Special Requirement categories in database for RFP
		if(count($req_parentid)>0)
		{
			for($i=0;$i<count($req_parentid);$i++)
			{
				if(count($sub_req_id[$req_parentid[$i]])>0)
				{
					for($j=0;$j<count($sub_req_id[$req_parentid[$i]]);$j++)
					{

						if(count($req_id[$sub_req_id[$req_parentid[$i]][$j]])>0)
						{
							for($k=0;$k<count($req_id[$sub_req_id[$req_parentid[$i]][$j]]);$k++)
							{
								$splreq_rfp['rfp_id']=$rfp_id;
								$splreq_rfp['req_parentid']=$req_parentid[$i];
								$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
								$splreq_rfp['req_id']=$req_id[$sub_req_id[$req_parentid[$i]][$j]][$k];
								//
								if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
								$splreq_rfp['price']= $otherValue;
								//
								if($sub_req_id[$req_parentid[$i]][$j]=='12')
								$splreq_rfp['price']=$liabilityInsuranceAmount;
								//
								if($model->rfpsplreqs_store($splreq_rfp)) {

								}
							}
						} else {

							$splreq_rfp['rfp_id']=$rfp_id;
							$splreq_rfp['req_parentid']=$req_parentid[$i];
							$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
							$splreq_rfp['req_id']=0;
							//
							if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
							$splreq_rfp['price']= $otherValue;
							//
							if($sub_req_id[$req_parentid[$i]][$j]=='12')
							$splreq_rfp['price']=$liabilityInsuranceAmount;
							//
							if($model->rfpsplreqs_store($splreq_rfp)) {

							}
						}
					}
				} else {
					$splreq_rfp['rfp_id']=$rfp_id;
					$splreq_rfp['req_parentid']=$req_parentid[$i];
					$splreq_rfp['req_subparentid']=0;
					$splreq_rfp['req_id']=0;
					//echo "<pre>"; print_r($splreq_rfp);
					if($model->rfpsplreqs_store($splreq_rfp)) {

					}
				}
				//
			}
		} //exit;
	$industryid =  JRequest::getVar('industryid');
	$rfpstatus =  JRequest::getVar('rfpstatus');
	$rfpapproval =  JRequest::getVar('rfpapproval');
	$search =  JRequest::getVar('search');
	
	$basicrequest = JRequest::getVar('basicrequest','');
		if($basicrequest == 'basicrequest'){
			$linetask_uploads =  JRequest::getVar('linetask_uploads_210',array());
			for( $b=0; $b<count($linetask_uploads); $b++ ){
				$basic['rfpid'] = $rfp_id ;
				$basic['property_id'] = $property_id ;
				$exp_file = explode('/',$linetask_uploads[$b]);
				$basic['filename'] = $exp_file[count($exp_file)-1] ;
				$linetask_uploads[$b] = str_replace('components/com_camassistant/doc/','',$linetask_uploads[$b]);
				$basic['filepath'] = $linetask_uploads[$b] ;
				$basic['upload_date'] = '' ;
				
				$save_basicfiles = $model->savebfiles($basic);
			}
		}
		
		$msg='RFP saved as Draft Successfully';
		$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&industry_id='.$industryid.'&rfpstatus='.$rfpstatus.'&rfpapproval='.$rfpapproval.'&search='.$search,$msg );
	}
	function submit_rfp()
	{
		global $mainframe;
		$user=JFactory::getUser();  //For $my
		$basepath=JURI::root();
		$db = &JFactory::getDbo();
		$model	=& $this->getModel('rfp');
		$itemid=JRequest::getVar('Itemid',0);
		$show=JRequest::getVar('show','');
		$post = JRequest::get('post');

		$proposaldate=explode(' ',$post['proposalDueDate']);
		$jobnotes= JRequest::getVar('jobnotes');
		$data['jobnotes']=$jobnotes;
		$post['proposalDueDate']=$proposaldate[0];
		$data['proposalDueTime']=$proposaldate[1];
		/*if($proposaldate[1] == '')
		$proposaldate[1] = '12:00';
		if($proposaldate[2] == '')
		$proposaldate[2] = 'pm' ;
		$post['proposalDueTime']=$proposaldate[1].strtoupper($proposaldate[2]);*/
		$work_perform =  JRequest::getVar('work_perform');
		$post['work_perform_other'] = '';
		//print_r(count($work_perform)); exit;
		//
		$site_visit =  JRequest::getVar('site_visit',array());
		$bidders_info =  JRequest::getVar('bidders_info',array());
		if($site_visit[0]=='Required prior to bidding')
		$post['bidders_info']=$bidders_info[0];
		else if($site_visit[0]=='Recommended')
		$post['bidders_info']=$bidders_info[1];
		else
		$post['bidders_info']=$bidders_info[2];
		//$post['work_perform']=$work_perform[0];
		//echo "<pre>"; print_r($post); exit;
		$post['work_perform'] = $work_perform;

		$post['site_visit']=$site_visit[0];

		$post['publish']=1;
	 	$cust_id1 = "SELECT property_manager_id  FROM #__cam_property where id=".$post['property_id'];
		$db->setQuery($cust_id1);
		$custid = $db->loadResult();

		$post['cust_id']=$custid;
		//print_r($post['cust_id']); exit;
		$createdDate=date('m-d-Y');
		$post['createdDate']=$createdDate;
		$data['update_date']=date('m-d-Y');
		$property_id=JRequest::getVar('property_id');
		//To get the property owner
			$get_pmid="SELECT property_manager_id FROM #__cam_property WHERE id='".$property_id."'";
			$db->Setquery($get_pmid);
			$data['cust_id'] = $db->loadResult();
		//Completed
		$industry_id=JRequest::getVar('industry_id');
		$choose_tasks=JRequest::getVar('choose_tasks');
		if($post['choose_tasks2'])
		$choose_tasks=$post['choose_tasks2'];
		if($post['choose_tasks3'])
		$choose_tasks=$post['choose_tasks3'];
		$amount=$post['liabilityInsuranceAmount'];
		//echo "<pre>"; print_r($choose_tasks); exit;
		$rfpid= JRequest::getVar('rfpid');
		$post['id']= $rfpid;
		$post['rfp_indus_data']= '';
		$post['update_rfp']='0';
		// echo "<pre>"; print_r($post); exit;
		$from_name=$user->name;
		$from_email=$user->email;
		$rfp_type =  JRequest::getVar('rfp_type');
		//if($rfp_type=='review'){
		$post['rfp_type']= 'draft';
		//} else {
		//$post['rfp_type']= $rfp_type;
		//}
		$post['choose_tasks']= $choose_tasks;
		$indus= JRequest::getVar('industry_id',array(0));
		$post['industry_id']= $indus[0];
		//echo "<pre>"; print_r($post); exit;
		/*if($post['id'] == '')
		$post['id'] = str_pad(mt_rand(0, 999999), 6, '0', STR_PAD_LEFT); */

		if($model->store($post)) {

			$mesg = "<font color='red' size='3'><b>RFP stored successfully<b></font>";
		} else {
			$mesg = "Could not added RFP";
		}
		//added by lalitha
		if(!$rfpid)
		{

			$rfpinfo_id = $db->insertid();
			$random_id 	 = str_pad(mt_rand(1, 999999), 6, '0', STR_PAD_LEFT);
			$upd_sql = 'UPDATE #__cam_rfpinfo set id='.$random_id.' WHERE id ='.$rfpinfo_id;
			$db->Setquery($upd_sql);
			$db->query();


		}
		$rfpinfo_id1 = $db->insertid();
		//print_r($rfpinfo_id1); exit;
		//added by lalitha
		if(!$rfpid)
		$rfp_id = $random_id;
		else
		$rfp_id = $rfpid;

		$industry = $_REQUEST['industry_id'];
		$sql1 = "SELECT industry_id FROM #__cam_rfpinfo WHERE id=".$rfp_id;
		$db->setQuery($sql1);
		$db_res = $db->loadResult();

		  $query = "DELETE FROM #__cam_rfpindustries WHERE rfpid=".$rfp_id." AND industry_id=".$db_res;
			$db->setQuery($query);
			$db->query();
		for($in=0; $in<count($industry); $in++){
		if($industry[$in]){
			$insert_sql = "insert into #__cam_rfpindustries values ('','".$rfp_id."','".$industry[$in]."')";
			}
			$db->SetQuery($insert_sql);
			$db->query();
		//echo  $industry[$in];
		}

		$line_tasks['rfp_id']=$rfp_id;
		$task_desc =  JRequest::getVar('task_desc',array());
		$linetaskname =  JRequest::getVar('linetaskname',array());
		$rfpreference =  JRequest::getVar('rfpreference',array());
		$is_req_taskvendors =  JRequest::getVar('is_req_taskvendors',array());
		$hidden_taskvendors =  JRequest::getVar('hidden_taskvendors',array());
		$linetask_uploads =  JRequest::getVar('linetask_uploads',array());
                 $line_taskno =  JRequest::getVar('line_taskno',array());
	//echo "<pre>"; print_r($is_req_taskvendors); exit;
		//code to delete previous tasks
		 $old_new_taskids = JRequest::getVar('old_taskids','');
		$rfp = JRequest::getVar('rfpid','');
		$db = JFactory::getDBO();
		$sql = "SELECT task_id FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id;
		$db->setQuery($sql);
		$db_taskids = $db->loadResultArray();

		$old_taskids_modified = array_diff($old_new_taskids, array(''));

		for($i=0; $i<count($db_taskids); $i++)
		{
			if(!in_array($db_taskids[$i],$old_taskids_modified))
			{
			//code to delete taskid from  #__cam_rfpsow_linetask
			$query = "DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id." AND task_id=".$db_taskids[$i];
			$db->setQuery($query);
			$db->query();
			//code to delete taskid from  #__cam_rfpsow_docs_lineitems_prices
			$query = "DELETE FROM #__cam_rfpsow_docs_lineitems_prices WHERE rfp_id=".$rfp_id." AND item_id=".$db_taskids[$i]." AND item_type='task' ";
			$db->setQuery($query);
			$db->query();
			}
		}
		// end of code to update task ids by lalitha
		$updateditems=array();
		$k=0;
		//code to delete previous tasks
		//$query = "DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id;
		//$db->setQuery($query);
		//$db->query();
		//print_r($rfp_id); exit;
		//end of code
		//echo "<pre>"; print_r($_REQUEST);
		if(count($line_taskno)>0)
		{
			for($i=0;$i<count($line_taskno);$i++)
			{

                             $task_desc =  JRequest::getVar('task_desc_'.$line_taskno[$i] ,array());

                             $linetaskname =  JRequest::getVar('linetaskname_'.$line_taskno[$i] ,array());
                              $rfpreference=  JRequest::getVar('rfpreference_'.$line_taskno[$i] ,array());
                            $linetask_uploads =  JRequest::getVar('linetask_uploads_'.$line_taskno[$i], array());
                            $is_req_taskvendors=  JRequest::getVar('is_req_taskvendors_'.$line_taskno[$i] ,array());
                            $hidden_taskvendors=  JRequest::getVar('hidden_taskvendors_'.$line_taskno[$i] ,array());

				$line_tasks['task_id']=$old_new_taskids[$i]; //echo '<br/>';

				$line_tasks['task_desc']=$task_desc[0];
				$line_tasks['linetaskname']=$linetaskname[0];
				$line_tasks['rfpreference']=$rfpreference[0];
				//$line_tasks['is_req_taskvendors']=$is_req_taskvendors[$j];
                                $result = array_filter( $linetask_uploads, 'strlen' );
                               //  echo '<pre>'; print_r($result);
                                if($linetask_uploads!=''){
				$line_tasks['taskuploads']=implode(',', $result);
                                }
				/*if($js_req_taskvendors[$j+1] == ''){
				$line_tasks['is_req_taskvendors'] = 0;
				} else {
				$line_tasks['is_req_taskvendors'] = $js_req_taskvendors[$j+1];
				}*/
				//$k=$j+1;
				if($hidden_taskvendors==1 || $is_req_taskvendors[0]==1)
				$line_tasks['is_req_taskvendors']=1;
				else
				$line_tasks['is_req_taskvendors']=0;


				$line_tasks['rfp_id']=$rfp_id;
				//
				$lastinsid=$db->insertid();
				$tag1=0; $tag2=0; $tag3=0;
				if($i<$cnt)
				{
					$tag1=strcmp($linetaskname,$linetaskname);
					$tag2=strcmp($task_desc,$task_desc);
					$tag3=strcmp($rfpreference,$rfpreference);
					if($tag1!=0 || $tag2!=0 || $tag3!=0)
					$line_tasks['is_modified'] = 1;
					else
					$line_tasks['is_modified'] = 0;
					//$updateditems[]=$lastinsid;
				}
				else
				$line_tasks['is_modified'] = 0;
				/* echo "<pre>";
				print_r($line_tasks);  */
				if($model->tasks_store($line_tasks))
				{
					$mesg = "Tasks stored successfully";
				} else {
					$mesg = "Error saved";
				}
                       // }

			}  // exit;
		}
		//print_r($_REQUEST);
		$require_docprice =  JRequest::getVar('require_docprice',array());
		$attachmnent =  JRequest::getVar('attachmnent',array());

		$query = "DELETE FROM #__cam_rfpsow_docs WHERE rfp_id=".$rfp_id;
		$db->setQuery($query);
		$db->query();

			for($i=0;$i<count($attachmnent);$i++)
			{

				if($require_docprice[$i+1] == ''){

				$req_docsow['is_req_docvendors']=0;
				}  else {
				$req_docsow['is_req_docvendors']= $require_docprice[$i+1];
				}


					$req_docsow['doc_path']=$attachmnent[$i];

					$req_docsow['rfp_id']=$rfp_id;
				//echo "<pre>"; print_r($req_docsow);
                                         if($req_docsow['doc_path']){
					if($model->reqdocs_store($req_docsow)) {
					$mesg = "Documents stored successfully";
					} else {
						$mesg = "Error saved";
					}
                                     }

			}
		//For Inserting Spl reqs
		$req_parentid =  JRequest::getVar('req_parentid',array());
		$sub_req_id =  JRequest::getVar('sub_req_id',array());
		$req_id =  JRequest::getVar('req_id',array());
		$otherValue1 =  JRequest::getVar('otherValue1');
		$otherValue2 =  JRequest::getVar('otherValue2');
		$otherValue3 =  JRequest::getVar('otherValue3');
		$otherValue =  $otherValue1.'/'.$otherValue2.'/'.$otherValue3;
		$liabilityInsuranceAmount =  JRequest::getVar('liabilityInsuranceAmount');

		//code to delete previous special requirements
		$db = JFactory::getDBO();
		$query = "DELETE FROM #__cam_rfpreq_info WHERE rfp_id=".$rfp_id;
		$db->setQuery($query);
		$db->query();

		if(count($req_parentid)>0)
		{

			for($i=0;$i<count($req_parentid);$i++)
			{
				if(count($sub_req_id[$req_parentid[$i]])>0)
				{
					for($j=0;$j<count($sub_req_id[$req_parentid[$i]]);$j++)
					{

						if(count($req_id[$sub_req_id[$req_parentid[$i]][$j]])>0)
						{
							for($k=0;$k<count($req_id[$sub_req_id[$req_parentid[$i]][$j]]);$k++)
							{
								$splreq_rfp['rfp_id']=$rfp_id;
								$splreq_rfp['req_parentid']=$req_parentid[$i];
								$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
								$splreq_rfp['req_id']=$req_id[$sub_req_id[$req_parentid[$i]][$j]][$k];
								//
								if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
								$splreq_rfp['price']= $otherValue;
								//
								if($sub_req_id[$req_parentid[$i]][$j]=='12')
								$splreq_rfp['price']=$liabilityInsuranceAmount;
								//
								if($model->rfpsplreqs_store($splreq_rfp)) {

								}
							}
						} else {

							$splreq_rfp['rfp_id']=$rfp_id;
							$splreq_rfp['req_parentid']=$req_parentid[$i];
							$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
							$splreq_rfp['req_id']=0;
							//
							if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
							$splreq_rfp['price']= $otherValue;
							//
							if($sub_req_id[$req_parentid[$i]][$j]=='12')
							$splreq_rfp['price']=$liabilityInsuranceAmount;
							//
							if($model->rfpsplreqs_store($splreq_rfp)) {

							}
						}
						/*if($model->rfpsplreqs_store($splreq_rfp)) {

						}*/
					}
				} else {
					$splreq_rfp['rfp_id']=$rfp_id;
					$splreq_rfp['req_parentid']=$req_parentid[$i];
					$splreq_rfp['req_subparentid']=0;
					$splreq_rfp['req_id']=0;
					if($model->rfpsplreqs_store($splreq_rfp)) {

					}
				}

			}

		}
		$submit_rfp = "SELECT introtext  FROM #__content where id='177'";
		$db->setQuery($submit_rfp);
		$body = $db->loadResult();

		$property_name1 = "SELECT P.property_name  FROM #__cam_property as P LEFT JOIN #__cam_rfpinfo as R ON R.property_id=P.id where R.id=".$rfp_id;
		$db->setQuery($property_name1);
		$property_name = $db->loadResult();

		$email1 = "SELECT email  FROM #__users where id=".$custid;
		$db->setQuery($email1);
		$email = $db->loadResult();

		$body = str_replace('{RFP Number}', $rfp_id, $body);
		$body = str_replace('{Property Name}', $property_name, $body);
		// print_r($property_name);		exit;
		$sub='Your RFP is ready to review';
		$from_name='CAMassistant';
		$from_email='Support@CAMassistant.com';
		$vendoremail= $email;
		//$vendoremail='support@CAMassistant.com';
		$cc='support@CAMassistant.com';
		$successMail =JUtility::sendMail($from_email, $from_name, $vendoremail, $sub, $body,$mode = 1,$cc);
		
		$basicrequest = JRequest::getVar('basicrequest','');
		if($basicrequest == 'basicrequest'){
			$linetask_uploads =  JRequest::getVar('linetask_uploads_210',array());
			for( $b=0; $b<count($linetask_uploads); $b++ ){
				$basic['rfpid'] = $rfp_id ;
				$basic['property_id'] = $property_id ;
				$exp_file = explode('/',$linetask_uploads[$b]);
				$basic['filename'] = $exp_file[count($exp_file)-1] ;
				$linetask_uploads[$b] = str_replace('components/com_camassistant/doc/','',$linetask_uploads[$b]);
				$basic['filepath'] = $linetask_uploads[$b] ;
				$basic['upload_date'] = '' ;
				
				$save_basicfiles = $model->savebfiles($basic);
			}
		}
		
		
		$msg='RFP was created successfully';


		$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp',$msg );

	}
	function saverfpmsg()
	{
		JRequest::setVar('view', 'rfp');
		parent::display();
	}
	//
	function checkImage($fname,$tempname , $folder = 'com_camassistant') {
		//echo "hi iam here";exit;
		/*Uploading Image*/
		ini_set('upload_max_filesize','20');
		  if($fname != '')
		  {
			  $pos = strrpos($fname,'.');
			  $fileExt = substr($fname,($pos+1),4);
			  $fileName = substr($fname,0,($pos));
			  $aryFileExt = array('jpeg','JPEG','JPG','jpg','GIF','gif','PNG','png','pdf','xls','docs','txt','php');
			  if(in_array($fileExt,$aryFileExt) )
			  {
				   $file = $fileName.time().".".$fileExt;
				   $file = str_replace(' ','_',$file);
				   copy($tempname, 'components/com_camassistant/assets/images/rfp/'.$file);
				   return $file;
			  }
			  else
			  {
				$msg="File format was not supported";
				$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&task=rfp',$msg );
			  }
		 }
	 }

	function addproperty()
	{
		JRequest::setVar('view', 'rfp');
		parent::display();
	}

    function saveindustry()
	{
		$db = JFactory::getDBO();
		echo 'Select * FROM #__rsform_properties as a, #__rsform_forms as b,#__rsform_components as c  WHERE c.ComponentTypeId=a.ComponentId and b.FormId=a.ComponentId and  a.PropertyName="NAME"  and b.camindustry="'.$_POST[formid].'"';

$db->setQuery('Select * FROM #__rsform_properties as a, #__rsform_forms as b,#__rsform_components as c  WHERE c.ComponentTypeId=a.ComponentId and b.FormId=a.ComponentId and  a.PropertyName="NAME"  and b.camindustry="'.$_POST[formid].'"');
$db->query();
$cam=$db->loadobjectlist();

    }



    function showindustryform()
	{

	require_once(''.JPATH_ROOT.'/components/com_rsform/controller/adapter.php');
	require_once(''.JPATH_ROOT.'/components/com_rsform/controller/functions.php');
	require_once(''.JPATH_ROOT.'/components/com_rsform/controller/validation.php');

$RSadapter = new RSadapter();
$GLOBALS['RSadapter'] = $RSadapter;

$GLOBALS['ismodule'] = 'local';
$db = JFactory::getDBO();
//require backend language file

require_once(_RSFORM_FRONTEND_ABS_PATH.'/languages/'._RSFORM_FRONTEND_LANGUAGE.'.php');
$db->setQuery("Select `FormId` FROM #__rsform_forms  WHERE  camindustry='".$_GET['formid']."'");
$db->query();
$cam=$db->loadobject();
$formId=$cam->FormId;
echo '<div class="rsform">';
	$output = '';
	$RSadapter = $GLOBALS['RSadapter'];

	if(isset($_SESSION['form'][$formId]['thankYouMessage']) && !empty($_SESSION['form'][$formId]['thankYouMessage']))
	{

		$output .= RSshowThankyouMessage($formId);
	}
	else
	{
		if(!empty($_POST['form']['formId']))
		{


			$invalid = RSprocessForm($formId);

$output .='<script type="text/javascript">';
for($i=2; $i<=$_GET[lcnt]; $i++){
$output .=" parent.removeEventedit('2'); ";
}
$output .=" </script>";

if($_GET[task]=='editrfp'){
for($i=1; $i<='7'; $i++){
$output .='<script type="text/javascript"> parent.removeEvent_edit('.$i.'); </script>';
}
}
$db->setQuery("Select * from #__rsform_submission_values where SubmissionId='".$_SESSION['rfp']['industry']."' AND FieldValue!=''");
$industrys = $db->loadobjectlist();
$os = array("Submit", "formId");
$i=0;
$j=1;
foreach($industrys as $industry){
if (!in_array($industry->FieldName, $os)) {
if($industry->FieldValue && $industry->FieldValue!='PLEASE SELECT' && $industry->FieldValue!='Select')
$linetask.=$industry->FieldName.':'.$industry->FieldValue.' , ';


if($industry->FieldName==$lit&&$industry->FieldValue=='True'){
$linetask=eregi_replace('Linetask','',$linetask);
$linetask=eregi_replace('True','',$linetask);
$linetask=eregi_replace('Select','',$linetask);
$linetask1=RScleanVar($linetask);
$linetask1=str_replace(',','\n',$linetask1);
$linetask1=str_replace('<br>','\n',$linetask1);
$linetask1=str_replace('PLEASE SELECT','',$linetask1);
$linetask=str_replace('submit:','',$linetask1);
if($linetask){
$output .= '<script type="text/javascript">';
$output .= 'parent.addEvent1();';
$output .= 'window.parent.document.getElementById("title_task'.$i.'").value ="'.$industry->FieldValue.'";';
$output .= 'window.parent.document.getElementById("line_taskdesc'.$i.'").value ="'.$linetask.'";	</script>';
$i++;
$j++;
}
unset($linetask);
}
}
}
$linetask1=RScleanVar($linetask);

$linetask1=str_replace(',','\n',$linetask1);
$linetask1=str_replace('<br>','\n',$linetask1);
$linetask1=str_replace('PLEASE SELECT','',$linetask1);
$linetask=str_replace('submit:','',$linetask1);
if($linetask){
$output .= '<script type="text/javascript">';
$output .= 'parent.addEvent1();';
$output .= 'window.parent.document.getElementById("title_task'.$i.'").value ="'.$industry->FieldValue.'";';
$output .= 'window.parent.document.getElementById("line_taskdesc'.$i.'").value ="'.$linetask.'";	</script>';
}

	$output .= '<script type="text/javascript">
window.parent.document.getElementById( "sbox-window" ).close();
		</script>';




			if($invalid)
			{
				//the invalid variable is returned
				$output .= RSshowForm($formId, $_POST['form'], $invalid);
			}
		}
		else
		{


			if(isset($_SESSION['form'][$formId]['thankYouMessage']) && empty($_SESSION['form'][$formId]['thankYouMessage']))
			{
				unset($_SESSION['form'][$formId]['thankYouMessage']);

				//is there a return url?
				$db = JFactory::getDBO();
				$db->setQuery("SELECT ReturnUrl FROM #__rsform_forms WHERE `formId`='".$formId."'");
				$returnUrl = $db->loadResult();
				if(!empty($returnUrl))
				{
					if(!isset($_SESSION['form'][$formId]['submissionId']))$_SESSION['form'][$formId]['submissionId'] = '';
					$returnUrl = RSprocessField($returnUrl,$_SESSION['form'][$formId]['submissionId']);
					unset($_SESSION['form'][$formId]['submissionId']);

					$RSadapter->redirect($returnUrl);
				}

				$output .= _RSFORM_FRONTEND_THANKYOU;
if($_GET['lcnt']){
$output .='<script type="text/javascript"> ';
for($i=2; $i<=$_GET['lcnt']; $i++){
$output .=" parent.removeEventedit('2'); ";
}
$output .=" </script>";
}

$db->setQuery("Select * from #__rsform_submission_values where SubmissionId='".$_SESSION['rfp']['industry']."'");
$industrys = $db->loadobjectlist();
$i=1;
$output .= '<script type="text/javascript">';
foreach($industrys as $industry){
if($i>1){
$output .= 'parent.addEvent1();';
}
if($industry->required_vendor){
$output .= 'window.parent.document.getElementById("price'.$i.'").checked ="checked";';
}




$lineitem_value=explode(',',$industry->FieldValue);
foreach($lineitem_value as $lineitem){
if(!strstr($lineitem,'{')){
$line_desc.= $lineitem.'\n\n';
}
}

if(strstr($line_desc,'Frequency')){
$freq="Frequency: ".$industry->Frequency.'\n\n';
$line_desc=$freq.$line_desc;
$frequency='See below';
}
if($frequency){
$output .= 'window.parent.document.getElementById("frequency'.$i.'").value ="'.$frequency.'";';
}elseif($industry->Frequency){
$output .= 'window.parent.document.getElementById("frequency'.$i.'").value ="'.$industry->Frequency.'";';
}else{
$output .= 'window.parent.document.getElementById("frequency'.$i.'").value ="N/A";';
}

//$line_desc=str_replace(',','\n\n',$industry->FieldValue);
//$line_desc='Fertilization,Shade Trees Flowering Trees Palm Trees Accent Trees,';
$output .= 'window.parent.document.getElementById("title_task'.$i.'").value ="'.$industry->line_title.'";';
$output .= 'window.parent.document.getElementById("line_taskdesc'.$i.'").value ="'.$line_desc.'";';
//$output .=' parent.autogrow();';
unset($line_desc);
unset($frequency);
$i++;
}

$output .= 'window.parent.document.getElementById( "sbox-window" ).close();
		</script>';




			}
			$output .= RSshowForm($formId);
		}
	}



echo $output;
echo '</div>';
	   }



/*function remove()
{
global $mainframe;
$rfpid	= JRequest::getVar( 'cid','','post','array');
$rfpid=implode(',',$rfpid);
$model = $this->getModel('rfp');
$model->deleterfp($rfpid);
$err_msg="RFP Deleted Successfully";
$mainframe->Redirect('index.php?option=com_camassistant&controller=rfp',$err_msg);
}*/


function cancel(){
global $mainframe;
$industryid =  JRequest::getVar('industry_id');
	$rfpstatus =  JRequest::getVar('rfpstatus');
	$rfpapproval =  JRequest::getVar('rfpapproval');
	$search =  JRequest::getVar('search');
		//$msg='RFP Updated  Successfully';
		//$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&industry_id='.$industryid.'&rfpstatus='.$rfpstatus.'&rfpapproval='.$rfpapproval.'&search='.$search,$msg );
$mainframe->Redirect('index.php?option=com_camassistant&controller=rfp&industry_id='.$industryid.'&rfpstatus='.$rfpstatus.'&rfpapproval='.$rfpapproval.'&search='.$search);
}

function controlpanel(){
global $mainframe;
$mainframe->Redirect('index.php?option=com_camassistant');

}



	//
	function submit_property()
	{
		global $mainframe;
		$model = $this->getModel('property');
		$post	= JRequest::get('post');
		$user=JFactory::getUser();  //For $my
		$taxids=$model->getProperty_TaxIDs();
		$tax_ids=array();
		for($i=0;$i<count($taxids);$i++)
		$tax_ids[$i]=$taxids[$i]->tax_id;
		/*echo "<pre>";
		print_r($post); exit;*/
		if(in_array($post['tax_id'],$tax_ids))
		{
			$err_msg="<span style='text-align:justify;font-size:11px;'>This Property is already registered with our system. Please contact your board/Management Company to determine your Property's Administrator on CAMassistant.com. If you have any  additional questions, please email us at properties@CAMassistant.com</span>";
			$mainframe->Redirect('index.php?option=com_camassistant&controller=rfp&task=addproperty&err_msg='.$err_msg );
		}
		/*echo "123456<pre>";
		print_r($rows); exit;*/
		$post['id']='';
		$post['property_manager_id']=$user->id;
		if($user->id)
		{
			if ($model->store($post)) {
				$propertyList=$model->getProperties();
				echo "<font color='red'>Property posted successfully</font>";
				$plist=JHTML::_('select.genericlist', $propertyList, 'property_id', 'size="1" class="inputbox "    onchange="addproperty(this.value);""', 'value', 'text', '');
				?>
				<script type="text/javascript">
				window.parent.document.getElementById("prop_list").innerHTML ='<?php echo $plist; ?>';
				window.parent.document.getElementById( 'sbox-window' ).close();
				</script>

				<?php
				exit(0);
				/*echo '<script language="javascript">window.parent.location.reload();</script>';
				exit(0);*/
			} else {
				echo "<font color='red'>Error Saving Property (ie. Property Name or Tax-Id entry might be duplicated )</font>";exit(0);
			}
		//$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&amp;task=addproperty&msg='.$msg );
		} else {
			echo "<font color='red'>Your session has been expired.Please login again</font>";
			echo '<script language="javascript">window.parent.document.getElementById( "sbox-window" ).close();</script>';
			exit(0);
		}
	}
	//For pop up line tasks check list
	function pop_linetasks()
	{
	 	JRequest::setVar('view', 'rfp');
		parent::display();
	}
	function getcounty(){
			$db =& JFactory::getDBO();
			$property_id=$_POST['queryString'];

			 $countie = "SELECT divcounty FROM #__cam_property WHERE id='".$property_id."'";
			$db->setQuery($countie);
			$counties = $db->loadResult();

			$County = "SELECT County FROM #__cam_counties WHERE id ='".$counties."'";
			$db->setQuery($County);
			$data = $db->loadResult();
			echo $data;

			exit;
		}
	////29-11-11
	function ajaxcounty(){
			$state = $_REQUEST['State'];
			$db=JFactory::getDBO();
			$countie = "SELECT * FROM #__cam_counties WHERE State='".$state."' ORDER BY County ";

			$db->setQuery($countie);
			$db->Query();
			$counties = $db->loadObjectList(); ?>
			<option value="" >Please Select County</option>

			<?php
			foreach($counties as $county)
			{
			echo"<option value=".$county->id.">".$county->County."</option>";

			}
			exit;
		}

		// function to delete the industries from the RFP
		function deleteindustry(){

			$db =& JFactory::getDBO();
			$rfp=$_REQUEST['rfpid'];
			$indusid=$_REQUEST['indusid'];
			$indust = "SELECT industry_id FROM #__cam_rfpinfo WHERE id=".$rfp;
			$db->setQuery($indust);
			$indust1 = $db->loadResult();


			$sql_delete = "DELETE FROM #__cam_rfpindustries where rfpid =".$rfp." and industry_id='".$indusid."'";
			$db->Setquery($sql_delete);

			if($db->query()){
			echo "deleted";
			}
			exit;

		}
		//Completed
		function vendor_notes(){
		//echo "<pre>"; print_r($_REQUEST); exit;
		JRequest::setVar('view', 'rfp');
		parent::display();
		}
	/*function industries_Save()
	{
		//echo "5454554";exit;
		//session_destroy();
		session_start();
		$_SESSION['line_industries']='';
		$ind_ary = JRequest::getVar('cid','','post','array',REQUEST_ALLOWRAW);
		$ind = implode(',',$ind_ary);
		$_SESSION['line_industries'] = $ind;
		echo "<script language='javascript' type='text/javascript'>
		window.parent.location.reload();
		self.close();
		 </script>";
		 $_SESSION['line_industries'] = $ind;
		//$link = 'index.php?option=com_camassistant&controller=vendors&task=vendor_info';
		//$this->setRedirect( $link,$msg );
		exit;
	}*/
	 function addnew(){

       JRequest::setVar('view', 'rfp');
       parent::display();
       }
       function save_notes(){
        JRequest::setVar('view', 'rfp');
	parent::display();

       }
      function editnew(){
       JRequest::setVar('view', 'rfp');
	parent::display();

      }
      function deletenew(){
		global $mainframe;
		$id = JRequest::getVar('id');
		$rfp_id = JRequest::getVar('rfp_id','');
		$ven_id = JRequest::getVar('vendor_id','');
		$prop_id = JRequest::getVar('prop_id','');
		$db=&JFactory::getDBO();
                $getnotes = $db->setQuery("DELETE FROM #__cam_adminnotes WHERE id=".$id);
                $notes = $db->query();
                if($notes){
                $url = "index.php?option=com_camassistant&controller=rfp&task=vendor_notes&vendorid=".$ven_id."&rfpid=".$rfp_id."&prop_id=".$prop_id;
		$msg = "Notes Deleted successfully";
		$mainframe->Redirect($url,$msg);
                }

      }
	  function followdate(){
	   JRequest::setVar('view', 'rfp');
		parent::display();
	  }


	function geturgent(){
	$db=JFactory::getDBO();
	$query_un = "UPDATE #__cam_rfpinfo SET urgency='".$_REQUEST['type']."' where id = ".$_REQUEST['rfpid'];
	$db->setQuery($query_un);
	$res=$db->query();
	if($res){
	echo "success";
	}
	else{
	echo "fail";
	}
	exit;
}

 function getassigned(){
	$db=JFactory::getDBO();
	$query_un = "UPDATE #__cam_rfpinfo SET assigned='".$_REQUEST['adminid']."' where id = ".$_REQUEST['rfpno'];
	$db->setQuery($query_un);
	$res=$db->query();
	if($res){
	echo "success";
	}
	else{
	echo "fail";
	}
	exit;
}

function addcomments(){
	$db=JFactory::getDBO();
	$rfp_id = $_REQUEST['rfpid'] ;
	$author = $_REQUEST['author'] ;
	$related = $_REQUEST['related'] ;

	if($related == '0'){
	$vendor_id = 0 ;
	$prop_id = 'm' ;
	}
	else if($related == 'm'){

	$vendor_id = 'm' ;
	$prop_id = 'm' ;
	}
	else {
	$getpid ="SELECT id  FROM #__cam_vendor_proposals where rfpno='".$rfp_id."' and proposedvendorid='".$related."' ";
	$db->setQuery( $getpid );
	$pid = $db->loadResult();
	$vendor_id = $related ;
	$prop_id = $pid ;
	}
	$note_date = date('Y-m-d H:i:s');
    $insert_notes = "INSERT INTO #__cam_adminnotes(prop_id,vendor_id,rfp_id,notes_date,relatedto,author,comment) VALUES('".$prop_id."','".$vendor_id."',$rfp_id,'".$note_date."','','".addslashes($author)."','".htmlentities($_REQUEST['cmt'], ENT_QUOTES)."')";
	$save_note = $db->setQuery($insert_notes);
	$res=$db->query();
	if($res){
	echo "success";
	}
	else{
	echo "fail";
	}
	exit;
	}

function deleterfpnotes(){
	$db=JFactory::getDBO();
	$query = 'DELETE FROM #__cam_adminnotes WHERE rfp_id ='.$_REQUEST['rfpid'].' AND id='.$_REQUEST['id'].' ';
	$db->setQuery( $query );
	if($db->query()){
	echo "success";
	}
	else{
	echo "fail";
	}
	exit;

	}
function deleteoverrfpnotes(){
	$db=JFactory::getDBO();
	$query = 'DELETE FROM #__cam_rfpnotes WHERE rfpid ='.$_REQUEST['rfpid'].' AND id='.$_REQUEST['id'].' ';
	$db->setQuery( $query );
	if($db->query()){
	echo "success";
	}
	else{
	echo "fail";
	}
	exit;

	}

	function addrfpnotes(){
		JRequest::setVar('view', 'rfp');
		parent::display();

	}
function save_mainnotes(){

		$relatedto = JRequest::getVar('related','');
		//$comment = JRequest::getVar('comment','');
		$comment = htmlentities($_REQUEST['comment'], ENT_QUOTES);
		$rfp_id = JRequest::getVar('rfp_id','');
		$ven_id = JRequest::getVar('vendor_id','');

		$prop_id = JRequest::getVar('prop_id','');
		$var = JRequest::getVar('var','');
		if(!$prop_id){
		$db=&JFactory::getDBO();
		$query_pid = "SELECT id FROM #__cam_vendor_proposals  WHERE proposedvendorid=".$ven_id." and rfpno=".$rfp_id." ";
		$db->setQuery($query_pid);
		$prop_id = $db->loadResult();
			if($prop_id) {
			$prop_id = $prop_id;
			}
			else {
			$prop_id  = 'm';
			}
		}

		$from = JRequest::getVar('from','');
		$note_date = date("Y-m-d H:i:s");
		$user =& JFactory::getUser();
		$author = $user->name.' '.$user->lastname;
		$db=&JFactory::getDBO();
		 $insert_notes = "INSERT INTO #__cam_adminnotes(prop_id,vendor_id,rfp_id,notes_date,relatedto,author,comment) VALUES('".$prop_id."','".$ven_id."',$rfp_id,'".$note_date."','".addslashes($relatedto)."','".addslashes($author)."','".htmlentities($_REQUEST['comment'], ENT_QUOTES)."')";
		$save_note = $db->setQuery($insert_notes);
		if($db->query()){ ?>
		 <script type="text/javascript">
      window.parent.location.reload();
	  </script>
		<?php }

	}

	function savefollowdate(){
	 $luser = JFactory::getUser();
	  $db =& JFactory::getDBO();
	  $date = JRequest::getVar('followupdate','');
	  $c_date = explode('-',$date);
	   $time = JRequest::getVar('followuptime','');
	  $final_date = $c_date[2].'-'.$c_date[0].'-'.$c_date[1].' '.$time ;
	  $follow = $date.' '.$time;
	  $update_follow	=	"UPDATE #__cam_rfpinfo SET followupdate	=	'".$follow."' WHERE id	=	".$_REQUEST['rfpid']."	";
	  $db->SetQuery($update_follow);
 	  $updatequesry = $db->query() ;
	//Completed
	$links = "http://myvendorcenter.com/live/administrator/index.php?option=com_camassistant&controller=rfp&task=rfp_bids&rfp_id=".$_REQUEST['rfpid']."&industryid=&rfpstatus=rfp&rfpapproval=1&search=";
	  $link = "<a href='http://myvendorcenter.com/live/administrator/index.php?option=com_camassistant&controller=rfp&task=rfp_bids&rfp_id=".$_REQUEST['rfpid']."&industryid=&rfpstatus=rfp&rfpapproval=1&search='>Click Here</a>";
	 $event = $this->ICS($final_date,$final_date,"RFP ".$_REQUEST['rfpid']. " followup",  "You have gotten the followup email for the date ".$final_date." for RFP ".$_REQUEST['rfpid']." You can see the ITBs page from this link ".$links."","California");
	  $save = $this->save();
	  $custinfo = "SELECT cust_id FROM #__cam_rfpinfo WHERE id='".$_REQUEST['rfpid']."'";
	  $db->setQuery($custinfo);
	  $cust_id = $db->loadResult();
	  $managerid =  $cust_id ;
	   $property_id = "SELECT property_id FROM #__cam_rfpinfo WHERE id='".$_REQUEST['rfpid']."'";
	  $db->setQuery($property_id);
	  $propertyid = $db->loadResult();
	  //To get the manager names
	  $db =& JFactory::getDBO();
	  $names = "SELECT name, lastname  FROM #__users WHERE  id='".$managerid."'";
	  $db->setQuery($names);
	  $names_m = $db->loadObject();
	  $m_name = $names_m->name.' '. $names_m->lastname;
	  //To get the property name
	  $p_name= "SELECT property_name FROM #__cam_property WHERE id='".$propertyid."' ";
	  $db->Setquery($p_name);
	  $p1name = $db->loadResult();
	  $pname=str_replace("_", " ", $p1name);
	  $message = "SELECT introtext FROM #__content WHERE  id=237";
	  $db->setQuery($message);
	  $body_text = $db->loadResult();
	  $from = "support@myvendorcenter.com";
	  $from_name = 'MyVendorCenter.com';
	  $sateesh = 'rize.cama@gmail.com';
	   $support = $luser->email ;

	  $bodymain = $body_text;

		$body = str_replace('{Click here}',$link,$bodymain);
		$body = str_replace('{RFP}',$_REQUEST['rfpid'],$body);
		$body = str_replace('{Association Name}',$pname,$body);
		$sub = "Followup email for RFP ".$_REQUEST['rfpid'];
	  $attachment = "/home/allen/public_html/live/administrator/components/com_camassistant/assets/ical/RFP ".$_REQUEST['rfpid']. " followup.ics";
	  JUtility::sendMail($from, $from_name, $sateesh, $sub, $body, $mode=1, $cc=null, $bcc=null, $attachment, $replyto=null, $replytoname=null);
	  JUtility::sendMail($from, $from_name, $support, $sub, $body, $mode=1, $cc=null, $bcc=null, $attachment, $replyto=null, $replytoname=null);

	  if($updatequesry){ ?>
	  <script type="text/javascript">
      window.parent.location.reload();
	  //window.parent.document.getElementById( 'sbox-window' ).close();
	  </script>
	  <?php }


	  }

	  function ICS($start,$end,$name,$description,$location) {
        $this->name = $name;
        $this->data = "BEGIN:VCALENDAR\nVERSION:2.0\nMETHOD:PUBLISH\nBEGIN:VEVENT\nDTSTART:".date("Ymd\THis\Z",strtotime($start))."\nDTEND:".date("Ymd\THis\Z",strtotime($end))."\nLOCATION:".$location."\nTRANSP: OPAQUE\nSEQUENCE:0\nUID:\nDTSTAMP:".date("Ymd\THis\Z")."\nSUMMARY:".$name."\nDESCRIPTION:".$description."\nPRIORITY:1\nCLASS:PUBLIC\nBEGIN:VALARM\nTRIGGER:-PT10080M\nACTION:DISPLAY\nDESCRIPTION:Reminder\nEnd:VALARM\nEnd:VEVENT\nEnd:VCALENDAR\n";
    }
    function save() {
        file_put_contents("components/com_camassistant/assets/ical/".$this->name.".ics",$this->data);
    }
function endbiddingrfp(){
	$db =& JFactory::getDBO();
	$date = date("m-d-Y H:i");
	$update_sql	="UPDATE #__cam_rfpinfo SET rfp_type= 'closed', publish='1', biddingcloseddate='".$date."'  WHERE id= ".$_REQUEST['rfpid'];
	$db->SetQuery($update_sql);
	if($db->query()){
	echo "success";
	}
	exit;
	}
function updatejobstatus(){
	$db =& JFactory::getDBO();
	$rfp_adminstatus = JRequest::getVar('rfp_adminstatus','');
	$rfpid = JRequest::getVar('rfpid','');
	$returnurl = JRequest::getVar('returnurl','');
	$sql = "UPDATE #__cam_rfpinfo SET rfp_adminstatus='".$rfp_adminstatus."' WHERE id='".$rfpid."'";
	$db->Setquery($sql);
	$db->query();
	$link = $returnurl;
	$this->setRedirect($link, $msg);
	}
function removefiles() {
	$db = JFactory::getDBO();
	$fileid = JRequest::getVar('fileid','');
	$sql='DELETE FROM `#__cam_basicrequest_files` WHERE `id` = '.$fileid.'';
	$db->setquery($sql);
	
	if( $db->query() ) 
		echo "yes";
	else
		echo "no";
	exit;
	
	}


		
}
?>
