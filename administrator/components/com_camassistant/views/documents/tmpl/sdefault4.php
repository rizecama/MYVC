<?php

/**
 * @version		1.0.0 cam assistant $
 * @package		cam_assistant
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

// Your custom code here
JHTML::_('behavior.modal');
//TO get the company name and lisence number
		$userid = JRequest::getVar( 'smid','');
		$db =& JFactory::getDBO();
		$query = "SELECT camfirm_license_no,comp_name FROM #__cam_customer_companyinfo WHERE cust_id=".$userid;
		$db->setQuery($query);
		$camfirmid = $db->loadObjectList();

		//TO get the user type
		$query_type = "SELECT user_type FROM #__users WHERE id=".$userid;
		$db->setQuery($query_type);
		$usertype = $db->loadResult();
		//Completed


$camuser = JRequest::getVar( 'user','' );
$type = JRequest::getVar( 'type','' );
if($type == 'shared'){
$type = 'shared';
} else{ $type = '';}

JToolBarHelper::title( JText::_( 'Sub Folders' ));
?>
<script type="text/javascript">
function submitform(pressbutton){
var form = document.adminForm;
if(pressbutton == 'lists')
{
window.location='index.php?option=com_camassistant';}

form.submit();
}
</script>
<?php
//BACK button link
$fileplace = explode("-->", $_REQUEST['fileplace']);
$fpath='components/com_camassistant/doc/'.$fileplace[0];
$fpath_back='components/com_camassistant/doc/';

$cnt=count($fileplace);
if($cnt==1)
	$backlink='index.php?option=com_camassistant&controller=documents&task=sdocs&managersid='.$userid.'&Itemid=76';
else {
$db =& JFactory::getDBO();
if($usertype == 13){
if($_REQUEST['smid'] != $userid){
$propertyname = $camfirmid[0]->comp_name.'_'.$camfirmid[0]->camfirm_license_no.'/'.$_REQUEST['smid'];
$propertyname = str_replace(' ','_',$propertyname);
$fpath_back = $fpath_back.$propertyname;
$fpath_back = str_replace('//','/',$fpath_back);
}
else{
$propertyname = $camfirmid[0]->comp_name.'_'.$camfirmid[0]->camfirm_license_no;
$propertyname = str_replace(' ','_',$propertyname);
$fpath_back = $fpath_back.$propertyname;
$fpath_back = str_replace('//','/',$fpath_back);
}
}
if($usertype == 12){
$propertyname = $camfirmid[0]->comp_name.'_'.$camfirmid[0]->camfirm_license_no.'/'.$_REQUEST['smid'];
$propertyname = str_replace(' ','_',$propertyname);
$fpath_back = $fpath_back.$propertyname;
$fpath_back = str_replace('//','/',$fpath_back);
}
	for($i=0;$i<count($fileplace)-1;$i++) {
	
		$fpath_back.='/'.$fileplace[$i];
		$fplace_back = explode("-->", $_REQUEST['fileplace']);
		for($j=0;$j<=$i;$j++)
		$fplace1_back[$j]=$fplace_back[$j];
		$fplace2_back=implode('-->',$fplace1_back);

	}
	$k=count($fileplace)-1;



if($camuser == 'cam'){
$fpath_back = str_replace($smid,'',$fpath_back);
$fpath_back = str_replace('//','/',$fpath_back);
} else{
$fpath_back = str_replace($smid,'',$fpath_back);
$fpath_back = str_replace('//','/',$fpath_back);

}

$backlink='index.php?option=com_camassistant&controller=documents&task=sopenfiles&type=shared&Itemid='.$_REQUEST['Itemid'].'&spid='.$_REQUEST['spid'].'&smid='. $_REQUEST['smid'].'&spath='.$fpath_back.'&propertyname='.$fileplace[$k].'&fileplace='.$fplace2_back.'&user='.$camuser;
}
//Completed
?>
<div align="right"><a href="<?php echo $backlink;?>"><img src="images/back_admin.png" alt="info" /></a></div>
<table cellpadding="0" cellspacing="0" class="adminlist">
  <tr>
  	<th class="title" align="center">Icons</th>
    <th class="title" align="center">Name</th>
    <th class="title" align="center" colspan="2">options</th>
    </tr>

  <?php for ($i=0; $i<count($this->sopenfiles['folders']); $i++){ ?>
  <tr class="table_blue_rowdots2">
  <td align="center" valign="bottom">
<a href="index.php?option=com_camassistant&controller=documents&Itemid=82&controller=documents&task=sopenfiles&spid=<?php echo $_REQUEST['spid']; ?>&smid=<?php echo $_REQUEST['smid']; ?>&spath=<?php echo $_REQUEST['spath']."/".$this->sopenfiles['folders'][$i]; ?>&folder_name=<?php print_r($this->sopenfiles['folders'][$i]); ?>&fileplace=<?php echo $_REQUEST['fileplace']."-->".$this->sopenfiles['folders'][$i];?>&type=<?php echo $type; ?>&Itemid=<?php echo $_REQUEST['Itemid']; ?>&taxid=<?php echo $taxid; ?>&user=<?php echo $camuser;?>"><img src="images/folder_icon.png"  alt="folder" /></a></td>

<td align="center" valign="middle">
<a href="index.php?option=com_camassistant&controller=documents&Itemid=82&controller=documents&task=sopenfiles&spid=<?php echo $_REQUEST['spid']; ?>&smid=<?php echo $_REQUEST['smid']; ?>&spath=<?php echo $_REQUEST['spath']."/".$this->sopenfiles['folders'][$i]; ?>&folder_name=<?php print_r($this->sopenfiles['folders'][$i]); ?>&fileplace=<?php echo $_REQUEST['fileplace']."-->".$this->sopenfiles['folders'][$i];?>&type=<?php echo $type; ?>&Itemid=<?php echo $_REQUEST['Itemid']; ?>&taxid=<?php echo $taxid; ?>&user=<?php echo $camuser;?>"><?php echo str_replace('_',' ',$this->sopenfiles['folders'][$i]); ?></a>
</td>
<td align="center" valign="middle">

<a href="index.php?option=com_camassistant&controller=documents&Itemid=82&controller=documents&task=sopenfiles&spid=<?php echo $_REQUEST['spid']; ?>&smid=<?php echo $_REQUEST['smid']; ?>&spath=<?php echo $_REQUEST['spath']."/".$this->sopenfiles['folders'][$i]; ?>&folder_name=<?php print_r($this->sopenfiles['folders'][$i]); ?>&fileplace=<?php echo $_REQUEST['fileplace']."-->".$this->sopenfiles['folders'][$i];?>&type=<?php echo $type; ?>&Itemid=<?php echo $_REQUEST['Itemid']; ?>&taxid=<?php echo $taxid; ?>&user=<?php echo $camuser;?>">OPEN</a>

</td>
</tr>
<?php } ?>
<?php
//print_r($this->sopenfiles);
for ($i=0; $i<count($this->sopenfiles['files']); $i++){

?>
<?php $filename = $this->sopenfiles['files'][$i];
$ext = substr(strrchr($filename, "."), 1);
 ?>
  <tr class="table_blue_rowdots2">
<td align="center" valign="bottom"><a href="index.php?option=com_camassistant&controller=documents&task=open&doc_title=<?php echo $this->sopenfiles['files'][$i]; ?>&path=<?php echo $_REQUEST['spath']; ?>&Itemid=76 "><img src="images/images_<?php echo $ext; ?>.png" /></a></td>
<td align="center" valign="middle"><a href="index.php?option=com_camassistant&controller=documents&task=open&doc_title=<?php echo $this->sopenfiles['files'][$i]; ?>&path=<?php echo $_REQUEST['spath']; ?>&Itemid=76 "><?php echo str_replace('_',' ',$this->sopenfiles['files'][$i]); ?></a></td>
<td align="center" valign="middle">
<a href="index.php?option=com_camassistant&controller=documents&task=open&doc_title=<?php echo $this->sopenfiles['files'][$i]; ?>&path=<?php echo $_REQUEST['spath']; ?>&Itemid=76 ">OPEN</a>

</td>
</tr>
<?php 
} ?>
<tr>
<div class="table_bottomlinks2" align="right">
<ul>
<li  style=" background:none;"><img src="images/new_folder.png" alt="add a new folder" width="45" height="39" align="absmiddle" /> <a class="modal" id="links1"  title="Add Folder"  href="index.php?option=com_camassistant&controller=documents&task=saddfolder&parentid=1&spid=<?php echo $_REQUEST['spid']; ?>&smid=<?php echo $_REQUEST['smid']; ?>&spath=<?php echo $_REQUEST['spath']; ?>" rel="{handler: 'iframe', size: {x: 400, y: 200}}" >+Add a new Folder  </a></li>

<li><img src="images/upload_folder.png" alt="Upload a file to this folder" width="37" height="36" align="middle" /><a class="modal" id="links1"  title="Add Folder"  href="index.php?option=com_camassistant&controller=documents&task=saddfile&parentid=1&spid=<?php echo $_REQUEST['spid']; ?>&smid=<?php echo $_REQUEST['smid']; ?>&spath=<?php echo $_REQUEST['spath']; ?>" rel="{handler: 'iframe', size: {x: 500, y: 250}}" >Upload a file</a></li> 
</ul>
</div>

</tr>
</table>


